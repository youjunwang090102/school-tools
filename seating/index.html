<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæ•¸ä½æœå‹™ | é¸ä½</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }

        body {
            margin: 0; background: var(--bg); color: var(--text-main);
            font-family: "Inter", "PingFang TC", "Microsoft JhengHei", sans-serif;
            height: 100vh; display: flex; flex-direction: column;
        }

        header {
            background: var(--card); padding: 12px 20px;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); z-index: 100; gap: 15px;
        }

        .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; }

        input, select, button { 
            padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--card); color: var(--text-main); font-size: 14px;
        }
        
        button { 
            cursor: pointer; background: var(--primary); color: white; border: none; 
            font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        button:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow); }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }
        .btn-outline:hover { background: #eff6ff; }
        .btn-pdf { background: #475569; }
        .btn-mail { background: #f59e0b; }

        main { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }

        @media (max-width: 850px) {
            main { flex-direction: column; overflow-y: auto; }
            #sidebar { width: 100% !important; height: auto !important; }
            #capture-area { min-height: 500px; }
        }

        #sidebar { 
            width: 320px; background: var(--card); border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column;
            border: 1px solid var(--border); box-shadow: var(--shadow);
        }

        #capture-area { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            overflow: auto; background: white; border-radius: 12px; padding: 30px;
            border: 1px solid var(--border); position: relative;
        }

        .grid-container { display: flex; flex-direction: column-reverse; gap: 12px; margin-bottom: 30px; }
        .row-wrap { display: flex; gap: 12px; }
        
        .seat {
            width: 75px; height: 60px; border: 1px solid var(--border); border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: #fff;
        }
        .seat:hover { border-color: var(--primary); background: #f0f9ff; }
        .seat.disabled { background: #f1f5f9; border-style: dashed; opacity: 0.6; }
        .seat.occupied { border: 2px solid var(--primary); background: #eff6ff; }
        
        .seat-num { position: absolute; top: 4px; left: 6px; font-size: 10px; color: var(--text-sub); font-weight: 600; }
        .student-name { font-size: 0.95rem; font-weight: 700; color: #0f172a; }

        .seat-tooltip {
            visibility: hidden; position: absolute; bottom: 115%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; padding: 10px 14px; border-radius: 8px; 
            font-size: 12px; white-space: nowrap; z-index: 200; pointer-events: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); opacity: 0;
        }
        .seat.occupied:hover .seat-tooltip { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(-5px); }

        .teacher-desk { 
            width: 240px; height: 45px; border: 2px solid var(--border); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; letter-spacing: 8px; color: var(--text-sub); font-weight: 700;
            background: var(--bg); border-radius: 8px; margin-top: 10px;
        }

        .scroll-area { overflow-y: auto; flex: 1; margin-top: 15px; }
        .manual-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--bg); }
        h3 { font-size: 18px; font-weight: 700; margin: 0; }
    </style>
</head>
<body>

    <header>
        <div class="controls">
            <div class="control-group">
                <label>1. åå–®ç®¡ç†</label>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="excel-input" style="width:150px;">
                    <button class="btn-outline" onclick="downloadTemplate()" title="ä¸‹è¼‰ Excel ç¯„æœ¬">ğŸ“¥ ç¯„æœ¬</button>
                </div>
            </div>
            <div class="control-group">
                <label>2. ä½ˆå±€è¨­å®š</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="cols" value="6" style="width:45px;"> 
                    <input type="number" id="rows" value="6" style="width:45px;">
                    <button onclick="renderGrid()">é‡ç½®</button>
                </div>
            </div>
            <div class="control-group">
                <label>3. é‹ä½œæ¨¡å¼</label>
                <select id="mode-select" onchange="switchMode()">
                    <option value="random">é»æ“Šè¨­ç½®éšœç¤™</option>
                    <option value="draw">ä¾åºä¸Šå°æŠ½ä½</option>
                    <option value="manual">ä»£è™Ÿé¸ä½åå–®</option>
                </select>
            </div>
            <button id="btn-random-all" onclick="randomAll()">ä¸€éµéš¨æ©Ÿåˆ†é…</button>
        </div>
        <div class="controls">
            <button class="btn-mail" onclick="sendEmails()">ğŸ“§ é€šçŸ¥å…¨ç­</button>
            <button class="btn-pdf" onclick="exportPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
        </div>
    </header>

    <main>
        <div id="sidebar">
            <h3 id="sidebar-title">ç®¡ç†é¢æ¿</h3>
            <div id="sidebar-content" class="scroll-area">
                è«‹å…ˆä¸‹è¼‰ç¯„æœ¬ä¸¦å¡«å¯«å¾ŒåŒ¯å…¥ã€‚
            </div>
        </div>

        <div id="capture-area">
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk">è¬›æ¡Œ</div>
        </div>
    </main>

    <script>
        let students = [];
        let assignedMap = new Map();
        let currentDrawIndex = 0;

        // --- ä¸‹è¼‰ç¯„æœ¬åŠŸèƒ½ ---
        function downloadTemplate() {
            const header = ["åº§è™Ÿ", "å§“å", "å­¸è™Ÿ", "æ•™è‚²ä¿¡ç®±", "å¹¹éƒ¨1", "å¹¹éƒ¨2", "å¹¹éƒ¨3", "å¹¹éƒ¨4", "å¹¹éƒ¨5", "å¹¹éƒ¨6", "å¹¹éƒ¨7", "å¹¹éƒ¨8", "å¹¹éƒ¨9", "å¹¹éƒ¨10"];
            const data = [
                [1, "ç¯„ä¾‹å­¸ç”Ÿ", "112001", "student@example.edu.tw", "ç­é•·", "è‹±æ–‡å°è€å¸«", "", "", "", "", "", "", "", ""]
            ];
            const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å­¸ç”Ÿåå–®");
            XLSX.writeFile(wb, "æ•™å®¤åº§ä½è¡¨åå–®æ¨¡æ¿.xlsx");
        }

        // --- æª”æ¡ˆåŒ¯å…¥ ---
        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                students = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                students.sort((a,b) => (a.åº§è™Ÿ || 0) - (b.åº§è™Ÿ || 0));
                alert(`ğŸ‰ æˆåŠŸè¼‰å…¥ ${students.length} ä½åŒå­¸`);
                switchMode();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value);
            const c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; 
            assignedMap.clear();

            for (let i = 1; i <= r; i++) {
                const row = document.createElement('div');
                row.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { handleSeatClick(this); };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            refreshSeats();
        }

        function handleSeatClick(el) {
            if(document.getElementById('mode-select').value === 'random') {
                if(el.classList.contains('occupied')) return;
                el.classList.toggle('disabled');
                el.dataset.active = !el.classList.contains('disabled');
                refreshSeats();
            }
        }

        function refreshSeats() {
            const seats = document.querySelectorAll('.row-wrap .seat');
            let seatCounter = 1;
            seats.forEach(seat => {
                if (seat.dataset.active === "true") {
                    const student = assignedMap.get(seatCounter);
                    
                    // å½™æ•´å¹¹éƒ¨ 1-10
                    let roles = [];
                    if(student) {
                        for(let i=1; i<=10; i++) {
                            if(student[`å¹¹éƒ¨${i}`]) roles.push(student[`å¹¹éƒ¨${i}`]);
                        }
                    }
                    const roleDisplay = roles.length > 0 ? roles.join(' / ') : 'å­¸ç”Ÿ';

                    seat.className = student ? "seat occupied" : "seat";
                    seat.innerHTML = `
                        <span class="seat-num">${seatCounter}</span>
                        <span class="student-name">${student ? student.å§“å : ''}</span>
                        ${student ? `
                            <div class="seat-tooltip">
                                <b style="font-size:14px">${student.å§“å}</b><br>
                                <span style="opacity:0.8">åº§è™Ÿï¼š${student.åº§è™Ÿ} | å­¸è™Ÿï¼š${student.å­¸è™Ÿ || 'ç„¡'}</span><br>
                                <span style="color:#fbbf24">è·ç¨±ï¼š${roleDisplay}</span>
                            </div>
                        ` : ''}
                    `;
                    seatCounter++;
                } else {
                    seat.className = "seat disabled";
                    seat.innerHTML = "";
                }
            });
            if(document.getElementById('mode-select').value === 'manual') updateManualSidebar();
        }

        // --- ä»¥ä¸‹é‚è¼¯ç¶­æŒä¸è®Š ---
        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            currentDrawIndex = 0;
            document.getElementById('btn-random-all').style.display = (mode === 'random') ? 'flex' : 'none';
            if(mode === 'draw') updateDrawSidebar();
            else if(mode === 'manual') updateManualSidebar();
            else document.getElementById('sidebar-content').innerHTML = "<p style='color:var(--text-sub)'>éš¨æ©Ÿæ¨¡å¼ï¼š<br>1. é»æ“Šåº§ä½å¯è¨­ç‚ºéšœç¤™ç‰©<br>2. æŒ‰ä¸‹ä¸€éµéš¨æ©Ÿåˆ†é…</p>";
        }

        function updateDrawSidebar() {
            const content = document.getElementById('sidebar-content');
            if(!students.length) return content.innerHTML = "è«‹å…ˆåŒ¯å…¥åå–®";
            if(currentDrawIndex < students.length) {
                const s = students[currentDrawIndex];
                content.innerHTML = `
                    <div style="background:#f0f9ff; padding:20px; border-radius:12px; text-align:center; border:1px solid #bae6fd;">
                        <p style="font-size:13px; color:var(--text-sub); margin:0;">é‚€è«‹åŒå­¸æŠ½ç±¤</p>
                        <h2 style="color:var(--primary); margin:8px 0;">${s.åº§è™Ÿ}è™Ÿ ${s.å§“å}</h2>
                        <button onclick="randomPickOne()" style="width:100%; padding:12px; font-size:16px;">éš¨æ©Ÿè½åº§</button>
                    </div>
                `;
            } else {
                content.innerHTML = "<h3>âœ¨ æŠ½ç±¤å·²å®Œæˆ</h3>";
            }
        }

        function randomPickOne() {
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            const available = [];
            for(let i=1; i<=totalActive; i++) if(!assignedMap.has(i)) available.push(i);
            if(!available.length) return alert("ç©ºé–“ä¸è¶³ï¼");
            const target = available[Math.floor(Math.random() * available.length)];
            assignedMap.set(target, students[currentDrawIndex++]);
            refreshSeats();
            updateDrawSidebar();
        }

        function updateManualSidebar() {
            const content = document.getElementById('sidebar-content');
            if(!students.length) return;
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            let html = `<h3>åå–®å¿«é€Ÿå°ç…§</h3>`;
            students.forEach(s => {
                const currentSeat = [...assignedMap.entries()].find(([k,v]) => v.åº§è™Ÿ === s.åº§è™Ÿ)?.[0] || "";
                html += `
                    <div class="manual-row">
                        <span><b>${s.åº§è™Ÿ}</b>. ${s.å§“å}</span>
                        <select onchange="manualAssign('${s.åº§è™Ÿ}', this.value)" style="width:90px; font-size:12px;">
                            <option value="">é¸æ“‡åº§ä½</option>
                            ${Array.from({length: totalActive}, (_, i) => i + 1).map(n => `
                                <option value="${n}" ${currentSeat == n ? 'selected' : ''}>åº§ä½ ${n}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });
            content.innerHTML = html;
        }

        function manualAssign(studentNo, seatId) {
            const student = students.find(s => s.åº§è™Ÿ == studentNo);
            for (let [k, v] of assignedMap.entries()) if (v.åº§è™Ÿ == studentNo) assignedMap.delete(k);
            if(seatId) assignedMap.set(parseInt(seatId), student);
            refreshSeats();
        }

        function randomAll() {
            if(!students.length) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            if(students.length > totalActive) return alert("åº§ä½æ•¸ä¸è¶³ï¼");
            assignedMap.clear();
            const shuffled = [...students].sort(() => Math.random() - 0.5);
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            refreshSeats();
        }

        function exportPDF() {
            const element = document.getElementById('capture-area');
            const opt = {
                margin: 10, filename: 'ç­ç´šåº§ä½è¡¨.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, backgroundColor: '#ffffff' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function sendEmails() {
            if(!assignedMap.size) return alert("è«‹å…ˆå®Œæˆåˆ†é…");
            const list = []; const emails = [];
            assignedMap.forEach((s, id) => {
                list.push(`${s.åº§è™Ÿ} ${s.å§“å}ï¼šåº§ä½ ${id}`);
                const mail = s.æ•™è‚²ä¿¡ç®± || s.ä¿¡ç®±;
                if(mail) emails.push(mail);
            });
            window.open(`mailto:${emails.join(',')}?subject=åº§ä½é€šçŸ¥&body=${encodeURIComponent(list.join('\n'))}`);
        }

        renderGrid();
    </script>
</body>
</html>
