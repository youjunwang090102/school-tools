<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>互動座位系統 | 完整行政版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --text: #f8fafc; --border: #334155; --danger: #ef4444;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ToolBar */
        .top-steps { display: flex; gap: 15px; padding: 10px 20px; background: var(--card-bg); border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; }
        .step-group { display: flex; gap: 12px; align-items: center; }
        .step-box { border-right: 1px solid var(--border); padding-right: 12px; }
        .step-title { font-size: 0.7rem; color: var(--accent); font-weight: bold; margin-bottom: 2px; }
        
        button { cursor: pointer; padding: 5px 10px; border-radius: 4px; border: none; font-weight: bold; background: var(--accent); color: #000; }
        select, input { background: #0f172a; color: white; border: 1px solid var(--border); padding: 3px; border-radius: 4px; }

        /* Layout */
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 250px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--border); padding: 15px; display: none; flex-direction: column; gap: 10px; overflow-y: auto; }
        .seat-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }

        /* Seat Grid (左下為1的邏輯：flex-direction: column-reverse) */
        .grid-container { display: flex; flex-direction: column-reverse; gap: 10px; margin-bottom: 40px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat { width: 80px; height: 55px; border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; background: rgba(255,255,255,0.02); }
        .seat:hover { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); }
        .seat.disabled { opacity: 0.2; background: var(--danger); border-color: transparent; }
        .seat-num { position: absolute; top: 2px; left: 4px; font-size: 10px; color: var(--accent); }
        
        /* Tooltip & Popups */
        .tooltip { position: absolute; background: #000; padding: 8px; border-radius: 4px; border: 1px solid var(--accent); z-index: 100; pointer-events: none; font-size: 0.8rem; display: none; }

        /* PDF Styles */
        #pdf-template { display: none; width: 210mm; padding: 12mm; background: white; color: black; }
        .pdf-header { display: flex; justify-content: space-between; font-size: 10px; border-bottom: 1px solid #000; }
        .pdf-body { display: flex; gap: 15px; margin-top: 15px; }
        .pdf-left { flex: 0 0 20%; font-size: 10px; }
        .pdf-right { flex: 0 0 80%; display: flex; flex-direction: column; align-items: center; }
        .pdf-grid { display: flex; flex-direction: column-reverse; gap: 8px; } /* PDF 同步左下起算 */
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid #000; padding: 3px; }
        .desk { width: 200px; border: 2px solid #000; text-align: center; margin-top: 20px; padding: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-steps">
        <div class="step-group">
            <div class="step-box">
                <div class="step-title">名單匯入 (A1:班級 D1:導師)</div>
                <input type="file" id="excel-input" style="width: 140px;">
                <button onclick="downloadSample()">範例下載</button>
            </div>
            <div class="step-box">
                <div class="step-title">配置 (列x欄)</div>
                <input type="number" id="rows" value="6" style="width:35px"> x <input type="number" id="cols" value="6" style="width:35px">
                <button onclick="renderGrid()">重置網格</button>
            </div>
            <div class="step-box">
                <div class="step-title">選位模式</div>
                <select id="mode-select" onchange="switchMode()">
                    <option value="random">一鍵隨機</option>
                    <option value="draw">現場抽籤</option>
                    <option value="manual">代號選位</option>
                </select>
                <button id="action-btn" onclick="executeRandom()">執行</button>
            </div>
        </div>
        <button style="background:var(--danger); color:white" onclick="exportPDF()">匯出 A4 PDF</button>
    </div>

    <div class="main-layout">
        <div id="sidebar"></div>
        <div class="seat-area">
            <div id="grid" class="grid-container"></div>
            <div style="border:1px solid var(--accent); padding:5px 60px; color:var(--accent)">講桌 (前方)</div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <div id="pdf-template">
        <div class="pdf-header"><span id="p-time"></span><span id="p-teacher"></span></div>
        <h2 id="p-title" style="text-align:center"></h2>
        <div class="pdf-body">
            <div class="pdf-left" id="p-lists"></div>
            <div class="pdf-right">
                <div id="p-grid" class="pdf-grid"></div>
                <div class="desk">講 桌</div>
            </div>
        </div>
    </div>

    <script>
        let studentData = [], assignedMap = new Map(), classInfo = { name: "", teacher: "" };
        let currentDrawIndex = 0;

        function downloadSample() {
            const data = [["班級","101","導師","林老師"],["座號","姓名","教育信箱","","職務1","職務2"]];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "範例.xlsx");
        }

        document.getElementById('excel-input').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                const sheet = wb.Sheets[wb.SheetNames[0]];
                classInfo.name = sheet['B1'] ? sheet['B1'].v : "";
                classInfo.teacher = sheet['D1'] ? sheet['D1'].v : "";
                studentData = XLSX.utils.sheet_to_json(sheet, {range: 1});
                alert("匯入成功！");
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value);
            const c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; assignedMap.clear();
            
            for (let i = 0; i < r; i++) {
                const row = document.createElement('div'); row.className = 'row-wrap';
                for (let j = 0; j < c; j++) {
                    const seat = document.createElement('div'); seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = (e) => toggleSeat(seat);
                    seat.onmouseover = (e) => showTooltip(e, seat);
                    seat.onmouseout = () => document.getElementById('tooltip').style.display = 'none';
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            recalculate();
        }

        function toggleSeat(seat) {
            if (seat.dataset.student) return;
            seat.classList.toggle('disabled');
            seat.dataset.active = !seat.classList.contains('disabled');
            recalculate();
        }

        function recalculate() {
            let num = 1;
            // 按照 DOM 順序編號 (因為 flex-direction: column-reverse，視覺上是從左下往右)
            const rows = document.querySelectorAll('.row-wrap');
            rows.forEach(row => {
                row.querySelectorAll('.seat').forEach(seat => {
                    if (seat.dataset.active === "true") {
                        const s = assignedMap.get(num);
                        seat.innerHTML = `<span class="seat-num">${num}</span><b>${s ? s.姓名 : ''}</b>`;
                        seat.dataset.seatNum = num;
                        if(s) seat.dataset.student = JSON.stringify(s);
                        else delete seat.dataset.student;
                        num++;
                    } else { seat.innerHTML = ""; delete seat.dataset.seatNum; }
                });
            });
        }

        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            const side = document.getElementById('sidebar');
            const btn = document.getElementById('action-btn');
            side.style.display = (mode === 'random') ? 'none' : 'flex';
            if(mode === 'random') btn.onclick = executeRandom;
            if(mode === 'draw') { currentDrawIndex = 0; updateDrawUI(); }
            if(mode === 'manual') updateManualUI();
        }

        function executeRandom() {
            const activeCount = document.querySelectorAll('.seat[data-active="true"]').length;
            if(studentData.length > activeCount) return alert("位子不夠！");
            const shuffled = [...studentData].sort(() => Math.random() - 0.5);
            assignedMap.clear();
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            recalculate();
        }

        function updateDrawUI() {
            const side = document.getElementById('sidebar');
            if(currentDrawIndex >= studentData.length) { side.innerHTML = "<h3>抽籤完成</h3>"; return; }
            const s = studentData[currentDrawIndex];
            side.innerHTML = `<h3>現場抽籤</h3><p>正在抽：<b>${s.姓名}</b></p><input type="number" id="draw-seat" placeholder="輸入號碼"><button onclick="drawToSeat()">確認</button>`;
        }

        function drawToSeat() {
            const seatNum = parseInt(document.getElementById('draw-seat').value);
            if(assignedMap.has(seatNum) || !document.querySelector(`[data-seat-num="${seatNum}"]`)) return alert("號碼無效或已有人");
            assignedMap.set(seatNum, studentData[currentDrawIndex]);
            currentDrawIndex++;
            recalculate(); updateDrawUI();
        }

        function updateManualUI() {
            const side = document.getElementById('sidebar');
            side.innerHTML = `<h3>手動代號</h3>` + studentData.map(s => `<div>${s.姓名}: <input style="width:40px" onchange="manualSet(${s.座號}, this.value)" placeholder="號"></div>`).join('');
        }

        function manualSet(stdId, seatNum) {
            const s = studentData.find(x => x.座號 == stdId);
            if(seatNum) assignedMap.set(parseInt(seatNum), s);
            else assignedMap.delete(parseInt(seatNum));
            recalculate();
        }

        function showTooltip(e, seat) {
            if(!seat.dataset.student) return;
            const s = JSON.parse(seat.dataset.student);
            const tip = document.getElementById('tooltip');
            tip.innerHTML = `座號：${s.座號}<br>姓名：${s.姓名}<br>職務：${s.職務1 || ''} ${s.職務2 || ''}<br>信箱：${s.教育信箱 || ''}`;
            tip.style.display = 'block';
            tip.style.left = e.pageX + 10 + 'px';
            tip.style.top = e.pageY + 10 + 'px';
        }

        function exportPDF() {
            const p = document.getElementById('pdf-template');
            document.getElementById('p-time').innerText = `列印時間：${new Date().toLocaleString()}`;
            document.getElementById('p-teacher').innerText = `導師：${classInfo.teacher}`;
            document.getElementById('p-title').innerText = `${classInfo.name} 班級座位表`;

            // 左側名單分類 (簡化示範邏輯)
            let offHtml = "<table><tr><th>職務名單</th></tr>";
            studentData.forEach(s => {
                if(s.職務1) offHtml += `<tr><td>${s.職務1}：${s.姓名}</td></tr>`;
            });
            document.getElementById('p-lists').innerHTML = offHtml + "</table>";

            // 座位網格
            const pGrid = document.getElementById('p-grid'); pGrid.innerHTML = '';
            document.querySelectorAll('.row-wrap').forEach(row => {
                const pRow = document.createElement('div'); pRow.style.display = 'flex'; pRow.style.gap = '5px';
                row.querySelectorAll('.seat').forEach(seat => {
                    const ps = document.createElement('div');
                    ps.style.cssText = "width:50px; height:40px; border:1px solid #000; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:10px;";
                    if(seat.dataset.active === "true") {
                        const s = assignedMap.get(parseInt(seat.dataset.seatNum));
                        ps.innerHTML = `<span>${s ? s.座號 : seat.dataset.seatNum}</span><b>${s ? s.姓名 : ''}</b>`;
                    } else { ps.style.border = "none"; }
                    pRow.appendChild(ps);
                });
                pGrid.appendChild(pRow);
            });

            p.style.display = 'block';
            html2pdf().from(p).set({margin:0, filename:'座位表.pdf', jsPDF:{format:'a4'}}).save().then(()=>p.style.display='none');
        }

        renderGrid();
    </script>
</body>
</html>
