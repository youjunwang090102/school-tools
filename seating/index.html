<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸ä½æ•™å®¤é¸ä½ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #059669; --danger: #dc2626; --accent: #fbbf24; --bg: #f1f5f9; }
        body, html { margin: 0; padding: 0; height: 100vh; font-family: "PingFang TC", sans-serif; background: var(--bg); overflow: hidden; }
        main { display: flex; height: 100vh; padding: 12px; gap: 12px; box-sizing: border-box; }

        /* å·¦å´ 30% æ§åˆ¶å° */
        #left-panel { width: 30%; display: flex; flex-direction: column; gap: 8px; }
        .card { background: white; border-radius: 12px; padding: 12px; border: 1px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* 1. æ¨™é¡Œå€ */
        .sec-header { height: 10%; display: flex; flex-direction: column; justify-content: center; border-left: 6px solid var(--primary); }
        .sec-header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .sec-header p { margin: 2px 0 0 0; font-size: 0.85rem; color: #64748b; font-weight: bold; }

        /* 2. åŒ¯å…¥å€ */
        .sec-import { height: 10%; display: flex; flex-direction: column; justify-content: center; gap: 5px; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-red { background: var(--danger); }
        .status-green { background: var(--success); }

        /* 3. ç³»çµ±è¨­å®š */
        .sec-config { height: 12%; font-size: 0.9rem; }
        .input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        input { border: 1px solid #cbd5e1; border-radius: 4px; padding: 3px 8px; }

        /* 4. æŠ½ç±¤å€ */
        .sec-draw { height: 56%; display: flex; flex-direction: column; }
        .scroll-list { flex: 1; overflow-y: auto; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; margin: 8px 0; }
        .student-item { padding: 8px; border-bottom: 1px solid #edf2f7; display: flex; align-items: center; font-size: 0.9rem; }
        
        /* 5. çµæœå€ */
        .sec-result { height: 12%; display: flex; gap: 10px; }
        .btn-big { flex: 1; font-size: 1.2rem; font-weight: 900; color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* å³å´ 70% åº§ä½è¡¨ */
        #right-panel { width: 70%; background: white; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #cbd5e1; }
        .grid-container { display: flex; flex-direction: column-reverse; gap: 10px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat { 
            width: 80px; height: 65px; border: 2px solid #e2e8f0; border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; 
        }
        .seat.occupied { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: bold; }
        .seat.disabled { background: #f1f5f9; border-style: dashed; }
        
        /* å‹•ç•«ç‰¹æ•ˆ */
        .seat.animating { background: var(--accent) !important; transform: scale(1.05); }
        .seat.winner { animation: flash 0.3s 5; border: 3px solid var(--accent) !important; background: #fffbeb !important; z-index: 10; transform: scale(1.15); }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .desk { width: 300px; height: 40px; border: 3px solid #64748b; margin-top: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; letter-spacing: 10px; background: #f8fafc; }
        button:hover { filter: brightness(0.9); }
    </style>
</head>
<body>

<main>
    <div id="left-panel">
        <div class="card sec-header">
            <h1>æ•¸ä½æ•™å®¤é¸ä½ç³»çµ±</h1>
            <p>v2.1 Designed By ç‹å®¥éˆ</p>
        </div>

        <div class="card sec-import">
            <div style="display:flex; justify-content:space-between;">
                <input type="file" id="fileIn" style="width: 60%;">
                <button onclick="downloadTpl()" style="font-size:12px;">ä¸‹è¼‰ç¯„æœ¬</button>
            </div>
            <div id="import-status" style="font-size:12px; font-weight:bold; color:var(--danger);">
                <span class="status-dot status-red"></span>å°šæœªåŒ¯å…¥åå–®
            </div>
        </div>

        <div class="card sec-config">
            <div class="input-row">
                æ ¼å¼ï¼šç›´ <input type="number" id="gridR" value="6" style="width:40px;"> 
                æ©« <input type="number" id="gridC" value="6" style="width:40px;">
                <button onclick="makeGrid()">é‡è¨­</button>
            </div>
            <div class="input-row">
                èµ·å§‹æŠ½ç±¤åº§è™Ÿï¼š<input type="number" id="startNo" value="1" style="width:50px;">
            </div>
        </div>

        <div class="card sec-draw" id="draw-area">
            <b style="font-size:13px;">å­¸ç”Ÿåå–® (å‹¾é¸è€…å„ªå…ˆå‰å…©æ’)</b>
            <div id="stu-list" class="scroll-list"></div>
            <button onclick="initDrawQueue()" style="width:100%; height:40px; background:var(--primary); color:white; font-weight:bold; border-radius:6px; border:none; cursor:pointer;">é–å®šä¸¦é–‹å§‹æŠ½ç±¤</button>
        </div>

        <div class="card sec-result">
            <button onclick="sendMail()" class="btn-big" style="background:var(--success);">ç™¼é€éƒµä»¶</button>
            <button onclick="savePDF()" class="btn-big" style="background:#475569;">ä¸‹è¼‰ PDF</button>
        </div>
    </div>

    <div id="right-panel">
        <div id="grid" class="grid-container"></div>
        <div class="desk">è¬›æ¡Œ</div>
    </div>
</main>

<script>
    let students = [];
    let assigned = new Map();
    let prioritySet = new Set();
    let drawQueue = [];
    let isDrawing = false;

    function downloadTpl() {
        const ws = XLSX.utils.aoa_to_sheet([["åº§è™Ÿ", "å§“å", "æ•™è‚²ä¿¡ç®±"], [1, "å¼µåŒå­¸", "test@edu.tw"]]);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, "åå–®ç¯„æœ¬.xlsx");
    }

    function makeGrid() {
        const r = document.getElementById('gridR').value, c = document.getElementById('gridC').value;
        const grid = document.getElementById('grid');
        grid.innerHTML = ''; assigned.clear();
        for(let i=0; i<r; i++) {
            const row = document.createElement('div');
            row.className = 'row-wrap';
            for(let j=0; j<c; j++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.dataset.active = "true";
                seat.onclick = function() {
                    if(assigned.size === 0) {
                        this.classList.toggle('disabled');
                        this.dataset.active = this.classList.contains('disabled') ? "false" : "true";
                        updateSeatUI();
                    }
                };
                row.appendChild(seat);
            }
            grid.appendChild(row);
        }
        updateSeatUI();
    }

    function updateSeatUI() {
        const seats = document.querySelectorAll('.seat');
        let count = 1;
        seats.forEach(s => {
            if(s.dataset.active === "true") {
                const stu = assigned.get(count);
                s.innerHTML = stu ? `(${String(stu.åº§è™Ÿ).padStart(2,'0')})<br>${stu.å§“å}` : "";
                s.className = stu ? "seat occupied" : "seat";
                if(stu && stu.isNew) s.classList.add('winner');
                count++;
            } else {
                s.innerHTML = ""; s.className = "seat disabled";
            }
        });
    }

    document.getElementById('fileIn').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
            students = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            students.sort((a,b) => a.åº§è™Ÿ - b.åº§è™Ÿ);
            const status = document.getElementById('import-status');
            status.innerHTML = `<span class="status-dot status-green"></span>æˆåŠŸåŒ¯å…¥ ${students.length} ä½å­¸ç”Ÿ`;
            status.style.color = "var(--success)";
            renderStudentList();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function renderStudentList() {
        document.getElementById('stu-list').innerHTML = students.map((s, i) => `
            <div class="student-item">
                <input type="checkbox" onchange="toggleP(${i}, this)"> ${s.åº§è™Ÿ}. ${s.å§“å}
            </div>
        `).join('');
    }

    function toggleP(idx, el) {
        el.checked ? prioritySet.add(idx) : prioritySet.delete(idx);
    }

    function initDrawQueue() {
        if(!students.length) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
        
        // 1. å„ªå…ˆåå–® (ç¶­æŒåŸæœ¬åº§è™Ÿé †åº)
        const pArr = students.map((s, i) => i).filter(i => prioritySet.has(i));
        
        // 2. ä¸€èˆ¬åå–® (å¯¦ç¾å¾ªç’°èµ·å§‹åº§è™Ÿé‚è¼¯)
        const startNo = parseInt(document.getElementById('startNo').value);
        const others = students.map((s, i) => i).filter(i => !prioritySet.has(i));
        
        // å°‡ä¸€èˆ¬ç”ŸæŒ‰ç…§åº§è™Ÿé‡æ’ï¼Œå¾ startNo é–‹å§‹
        const othersSorted = [...others].sort((a, b) => {
            let valA = students[a].åº§è™Ÿ >= startNo ? students[a].åº§è™Ÿ : students[a].åº§è™Ÿ + 999;
            let valB = students[b].åº§è™Ÿ >= startNo ? students[b].åº§è™Ÿ : students[b].åº§è™Ÿ + 999;
            return valA - valB;
        });

        drawQueue = [...pArr, ...othersSorted];
        nextDrawUI();
    }

    function nextDrawUI() {
        const area = document.getElementById('draw-area');
        if(!drawQueue.length) { area.innerHTML = "<h2 style='text-align:center;'>ğŸ‰ æŠ½ç±¤å®Œæˆ</h2>"; return; }
        const s = students[drawQueue[0]];
        const isP = prioritySet.has(drawQueue[0]);
        area.innerHTML = `
            <div style="text-align:center; padding:10px;">
                <div style="color:${isP?'var(--accent)':'#64748b'}; font-weight:bold;">${isP?'[å„ªå…ˆé¸ä½]':'[ä¸€èˆ¬é¸ä½]'}</div>
                <h1 style="font-size:42px; margin:10px 0;">${s.å§“å}</h1>
                <button onclick="executeDraw(${drawQueue[0]}, ${isP})" id="drawBtn" style="width:100%; height:100px; font-size:24px; background:var(--success); color:white; border:none; border-radius:12px; cursor:pointer;">é»æ“ŠæŠ½ç±¤</button>
            </div>
        `;
    }

    function executeDraw(sIdx, isP) {
        if(isDrawing) return;
        isDrawing = true;
        assigned.forEach(v => v.isNew = false); // æ¸…é™¤èˆŠé–ƒçˆ
        updateSeatUI();

        const seats = document.querySelectorAll('.seat:not(.disabled)');
        const cols = parseInt(document.getElementById('gridC').value);
        let avail = [];
        
        // æ‰¾å‡ºç©ºä½ç·¨è™Ÿ
        for(let i=1; i<=seats.length; i++) {
            if(!assigned.has(i)) {
                if(isP && i <= (cols * 2)) avail.push(i); // å„ªå…ˆä½åƒ…é™å‰å…©æ’
                else if(!isP) avail.push(i);
            }
        }
        
        if(!avail.length && isP) { isDrawing = false; return executeDraw(sIdx, false); }

        let timer = 0;
        const aniInt = setInterval(() => {
            // åªåœ¨ã€Œç©ºä½ã€ä¸Šè·‘å‹•ç•«
            const emptySeats = Array.from(document.querySelectorAll('.seat:not(.disabled):not(.occupied)'));
            const randomIdx = Math.floor(Math.random() * emptySeats.length);
            emptySeats[randomIdx].classList.add('animating');
            setTimeout(() => emptySeats[randomIdx].classList.remove('animating'), 80);
            
            timer += 100;
            if(timer > 1500) {
                clearInterval(aniInt);
                const target = avail[Math.floor(Math.random() * avail.length)];
                students[sIdx].isNew = true;
                assigned.set(target, students[sIdx]);
                drawQueue.shift();
                updateSeatUI();
                isDrawing = false;
                nextDrawUI();
            }
        }, 100);
    }

    function sendMail() {
        const mails = students.map(s => s.æ•™è‚²ä¿¡ç®±).filter(m => m);
        window.location.href = `mailto:?bcc=${mails.join(',')}&subject=åº§ä½çµæœ&body=è«‹æŸ¥æ”¶ã€‚`;
    }

    function savePDF() {
        html2pdf().from(document.getElementById('right-panel')).set({
            margin:5, filename:'åº§ä½è¡¨.pdf', html2canvas:{scale:3}, jsPDF:{orientation:'landscape'}
        }).save();
    }

    makeGrid();
</script>
</body>
</html>
