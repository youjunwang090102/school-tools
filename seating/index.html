<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•åº§ä½ç³»çµ± | 2026 Pro Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --green: #10b981; --gold: #fbbf24; --red: #ef4444;
            --text: #f8fafc; --border: #334155;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* é ‚éƒ¨æ©«å‘æ­¥é©Ÿæ¢ */
        .top-steps {
            display: flex; gap: 15px; padding: 12px 20px;
            background: var(--card-bg); border-bottom: 1px solid var(--border);
            align-items: center; justify-content: space-between;
        }
        .step-group { display: flex; gap: 20px; align-items: center; }
        .step-box { border-right: 1px solid var(--border); padding-right: 20px; }
        .step-box:last-child { border-right: none; }
        .step-title { font-size: 0.75rem; color: var(--accent); margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        
        input, select, button { 
            padding: 5px 8px; font-size: 0.85rem; border-radius: 4px;
            background: #0f172a; border: 1px solid var(--border); color: white;
        }
        button { cursor: pointer; font-weight: 600; transition: 0.2s; background: var(--accent); color: #000; border: none; }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-pdf { background: var(--red); color: white; }

        /* ä¸‹æ–¹ä¸»å€åŸŸ */
        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }
        
        /* å·¦å´æ“ä½œå€ (30%) */
        .control-sidebar { 
            flex: 0 0 30%; background: rgba(255,255,255,0.03); 
            border-radius: 10px; padding: 15px; display: none; 
            flex-direction: column; border: 1px solid var(--border);
        }

        /* å³å´åº§ä½å€ (70% æˆ– 100%) */
        .seat-display { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; position: relative; overflow: auto;
        }

        /* åº§ä½ç¶²æ ¼ */
        .grid-container { display: flex; flex-direction: column-reverse; gap: 10px; margin-bottom: 25px; padding: 20px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat {
            width: 75px; height: 55px; border: 1px solid var(--border); border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: rgba(255,255,255,0.02); transition: 0.3s;
        }
        .seat.disabled { background: rgba(239, 68, 68, 0.15); border-color: transparent; }
        .seat.disabled::after { content: "âœ•"; color: var(--red); opacity: 0.5; font-size: 1.2rem; }
        .seat-num { position: absolute; top: 2px; left: 4px; font-size: 10px; color: var(--accent); opacity: 0.7; }
        .student-name { font-size: 0.95rem; font-weight: bold; color: #fff; }

        /* æ‡¸æµ®é è¦½ (Tooltip) */
        .tooltip {
            visibility: hidden; width: 180px; background: #000; color: #fff;
            padding: 10px; border-radius: 6px; position: absolute; z-index: 100;
            bottom: 115%; font-size: 0.75rem; border: 1px solid var(--accent); pointer-events: none; opacity: 0; transition: 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .seat:hover .tooltip { visibility: visible; opacity: 1; }
        .tooltip b { color: var(--accent); }
        .tooltip ul { padding-left: 15px; margin: 5px 0 0 0; color: var(--green); }

        /* æŠ½ç±¤å¡ç‰‡ */
        .congrats-card {
            background: var(--card-bg); border: 2px solid var(--gold); padding: 25px;
            text-align: center; border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.2);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .manual-list-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .manual-list-table th, .manual-list-table td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; }
        .scroll-area { overflow-y: auto; flex: 1; margin-top: 10px; }

        .teacher-desk { 
            width: 240px; height: 40px; border: 2px solid var(--accent); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; letter-spacing: 10px; color: var(--accent); font-weight: bold;
            border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div class="top-steps">
        <div class="step-group">
            <div class="step-box">
                <div class="step-title">Step 1. åŒ¯å…¥</div>
                <input type="file" id="excel-input" style="width: 120px;">
                <button onclick="generateTemplate()" style="background:none; color:var(--accent); text-decoration: underline; border:none; padding:0;">ç¯„ä¾‹</button>
            </div>
            <div class="step-box">
                <div class="step-title">Step 2. é…ç½®</div>
                å¯¬ <input type="number" id="cols" value="6" style="width: 35px;"> 
                é«˜ <input type="number" id="rows" value="6" style="width: 35px;">
                <button onclick="renderGrid()">é‡è¨­</button>
            </div>
            <div class="step-box">
                <div class="step-title">Step 3. æ¨¡å¼é¸æ“‡</div>
                <select id="mode-select" onchange="switchMode()">
                    <option value="random">ä¸€éµéš¨æ©Ÿåˆ†é…</option>
                    <option value="draw">äº’å‹•ç¾å ´æŠ½ç±¤</option>
                    <option value="manual">æ‰‹å‹•ä»£è™Ÿé¸ä½</option>
                </select>
                <button id="main-action-btn" onclick="executeRandom()">ç«‹å³åˆ†é…</button>
            </div>
        </div>
        <div class="step-box" style="border:none;">
            <div class="step-title" style="color:var(--red);">Step 4. åŒ¯å‡º</div>
            <button class="btn-pdf" onclick="exportPDF()">åŒ¯å‡º PDF åº§ä½è¡¨</button>
            <div class="step-box" style="border:none;">
    <div class="step-title" style="color:var(--red);">Step 4. åŒ¯å‡º</div>
    <button class="btn-pdf" onclick="exportPDF()">åŒ¯å‡º PDF</button>
    <button onclick="generateEmailNotification()" style="background:var(--gold); color:black; margin-left:5px;">é€šçŸ¥å­¸ç”Ÿ</button>
</div>

        </div>
    </div>

    <div class="main-layout">
        <div id="sidebar" class="control-sidebar">
            <div id="sidebar-content"></div>
        </div>

        <div class="seat-display" id="capture-area">
            <div id="congrats-area"></div>
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk">è¬›æ¡Œ</div>
        </div>
    </div>

    <script>
        let fullData = [];
        let assignedMap = new Map(); // SeatNum -> Student Object
        let currentDrawIndex = 0;

        function generateTemplate() {
            const headers = ["åº§è™Ÿ", "å§“å", "å­¸è™Ÿ", "æ•™è‚²ä¿¡ç®±"];
            for (let i = 1; i <= 10; i++) headers.push(`å¹¹éƒ¨åŠå°è€å¸«${i}`);
            const ws = XLSX.utils.json_to_sheet([{"åº§è™Ÿ":1,"å§“å":"ç‹å°æ˜","å­¸è™Ÿ":"11201","æ•™è‚²ä¿¡ç®±":"test@edu.tw","å¹¹éƒ¨åŠå°è€å¸«1":"ç­é•·"}], {header: headers});
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åå–®");
            XLSX.writeFile(wb, "åº§ä½è¡¨åŒ¯å…¥ç¯„ä¾‹.xlsx");
        }

        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
                fullData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                alert(`âœ… æˆåŠŸè¼‰å…¥åå–®ï¼šå…± ${fullData.length} ä½å­¸ç”Ÿ`);
                if(document.getElementById('mode-select').value === 'manual') updateManualTable();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value), c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; assignedMap.clear(); currentDrawIndex = 0;
            document.getElementById('congrats-area').innerHTML = '';
            
            for (let i = 1; i <= r; i++) {
                const row = document.createElement('div'); row.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div'); seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { 
                        if(this.dataset.hasStudent === "true") return;
                        this.classList.toggle('disabled'); 
                        this.dataset.active = !this.classList.contains('disabled');
                        recalculate();
                    };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            recalculate();
        }

        function recalculate() {
            const rows = document.querySelectorAll('.row-wrap');
            let num = 1;
            rows.forEach(row => {
                row.querySelectorAll('.seat').forEach(seat => {
                    if (seat.dataset.active === "true") {
                        const student = assignedMap.get(num);
                        let duties = "";
                        if(student) {
                            seat.dataset.hasStudent = "true";
                            for(let i=1; i<=10; i++) {
                                const d = student[`å¹¹éƒ¨åŠå°è€å¸«${i}`];
                                if(d) duties += `<li>${d}</li>`;
                            }
                        } else { delete seat.dataset.hasStudent; }
                        
                        seat.innerHTML = `<span class="seat-num">${num}</span>
                            <span class="student-name">${student ? student.å§“å : ''}</span>
                            ${student ? `<div class="tooltip"><b>${student.å§“å}</b><br>å­¸è™Ÿ: ${student.å­¸è™Ÿ || 'ç„¡'}<hr>è·å‹™ï¼š<ul>${duties || '<li>ç„¡</li>'}</ul></div>` : ''}`;
                        num++;
                    } else { seat.innerHTML = ""; delete seat.dataset.hasStudent; }
                });
            });
            if(document.getElementById('mode-select').value === 'manual') updateManualTable();
        }

        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            const sidebar = document.getElementById('sidebar');
            const actionBtn = document.getElementById('main-action-btn');
            
            sidebar.style.display = (mode === 'random') ? 'none' : 'flex';
            actionBtn.style.display = (mode === 'random') ? 'block' : 'none';
            document.getElementById('congrats-area').innerHTML = '';

            if(mode === 'draw') {
                currentDrawIndex = 0;
                updateDrawSidebar();
            } else if(mode === 'manual') {
                updateManualTable();
            }
        }

        // --- æ¨¡å¼ 1: ä¸€éµéš¨æ©Ÿ ---
        function executeRandom() {
            const activeCount = document.querySelectorAll('.seat[data-active="true"]').length;
            if(fullData.length === 0) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
            if(fullData.length > activeCount) return alert("åº§ä½ä¸è¶³ï¼");
            
            const shuffled = [...fullData].sort(() => Math.random() - 0.5);
            assignedMap.clear();
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            recalculate();
        }

        // --- æ¨¡å¼ 2: ç¾å ´æŠ½ç±¤ ---
        function updateDrawSidebar() {
            if (fullData.length === 0) return;
            const isFinished = currentDrawIndex >= fullData.length;
            const currentStudent = isFinished ? null : fullData[currentDrawIndex];
            const nextStudent = (currentDrawIndex + 1 < fullData.length) ? fullData[currentDrawIndex + 1] : null;

            document.getElementById('sidebar-content').innerHTML = `
                <h3 style="color:var(--gold)">ğŸ² æŠ½ç±¤éŠæˆ²</h3>
                <div style="background:rgba(56,189,248,0.1); padding:15px; border-radius:8px; border:1px solid var(--accent); margin-bottom:15px;">
                    <div style="font-size:0.7rem; color:var(--accent)">æ­£åœ¨æŠ½ç±¤ï¼š</div>
                    <div style="font-size:1.3rem; font-weight:bold;">${isFinished ? "âœ… å®Œç•¢" : currentStudent.å§“å}</div>
                </div>
                ${nextStudent ? `<div style="font-size:0.8rem; opacity:0.7">ä¸‹ä¸€ä½ï¼š${nextStudent.å§“å} (æº–å‚™)</div>` : ''}
                <button onclick="drawNext()" style="width:100%; margin-top:20px; padding:12px; font-size:1.1rem; background:var(--green); display:${isFinished?'none':'block'}">ğŸ æŠ½å‡ºåº§ä½</button>
            `;
        }

        function drawNext() {
            const activeSeats = Array.from(document.querySelectorAll('.seat[data-active="true"]'));
            const availableNums = activeSeats.map((_, i) => i + 1).filter(n => !assignedMap.has(n));
            const student = fullData[currentDrawIndex];
            
            const picked = availableNums[Math.floor(Math.random() * availableNums.length)];
            assignedMap.set(picked, student);
            
            const nextStudent = (currentDrawIndex + 1 < fullData.length) ? fullData[currentDrawIndex + 1] : null;
            document.getElementById('congrats-area').innerHTML = `
                <div class="congrats-card">
                    <div style="color:var(--gold)">æ­å–œ ${student.å§“å}</div>
                    <div style="font-size:2.5rem; font-weight:bold; color:var(--accent)">${picked} è™Ÿä½ç½®</div>
                    ${nextStudent ? `<div style="margin-top:10px; font-size:0.9rem; border-top:1px solid var(--border); padding-top:10px;">ğŸ“¢ è«‹ ${nextStudent.å§“å} ä¸Šå°</div>` : ''}
                </div>`;
            
            currentDrawIndex++;
            recalculate();
            updateDrawSidebar();
        }

        // --- æ¨¡å¼ 3: æ‰‹å‹•é¸ä½ ---
        function updateManualTable() {
            const activeSeatsCount = document.querySelectorAll('.seat[data-active="true"]').length;
            const usedSeats = Array.from(assignedMap.keys());
            let html = `<h3>ä»£è™Ÿé¸ä½æ¸…å–®</h3><div class="scroll-area"><table class="manual-list-table"><tr><th>åº§è™Ÿ</th><th>å§“å</th><th>åº§ä½ä»£è™Ÿ</th></tr>`;
            
            fullData.forEach((s, idx) => {
                const mySeat = Array.from(assignedMap.entries()).find(([k, v]) => v.å§“å === s.å§“å);
                let options = `<option value="">è«‹é¸æ“‡</option>`;
                for(let i=1; i<=activeSeatsCount; i++) {
                    if(!usedSeats.includes(i) || (mySeat && mySeat[0] === i)) {
                        options += `<option value="${i}" ${mySeat && mySeat[0] === i ? 'selected' : ''}>${i}</option>`;
                    }
                }
                html += `<tr><td>${s.åº§è™Ÿ || idx+1}</td><td>${s.å§“å}</td><td><select onchange="manualAssign('${s.å§“å}', this.value)">${options}</select></td></tr>`;
            });
            document.getElementById('sidebar-content').innerHTML = html + `</table></div>`;
        }

        function manualAssign(name, seatId) {
            for (let [key, val] of assignedMap.entries()) if (val.å§“å === name) assignedMap.delete(key);
            if(seatId) assignedMap.set(parseInt(seatId), fullData.find(s => s.å§“å === name));
            recalculate();
        }

        // --- Step 4: PDF åŒ¯å‡º (è¨è«–é») ---
        function exportPDF() {
            const element = document.getElementById('capture-area');
            const opt = {
                margin: 10,
                filename: 'æ•™å®¤åº§ä½è¡¨.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#ffffff' }, // åŒ¯å‡ºæ™‚è½‰ç‚ºç™½è‰²èƒŒæ™¯è¼ƒçœå¢¨æ°´
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            // é€™è£¡å¯ä»¥åŠ å…¥å‹•æ…‹ä¿®æ”¹æ¨£å¼çš„é‚è¼¯ï¼Œè®“åŒ¯å‡ºçš„ PDF æ˜¯ç™½åº•é»‘å­—
            html2pdf().set(opt).from(element).save();
        }

        renderGrid();
// --- ç¨ç«‹åŠŸèƒ½ï¼šåº§æ¨™è¨ˆç®—èˆ‡éƒµä»¶ç™¼é€ ---
function generateEmailNotification() {
    if (fullData.length === 0 || assignedMap.size === 0) {
        alert("è«‹å…ˆåŒ¯å…¥åå–®ä¸¦å®Œæˆåº§ä½åˆ†é…ï¼");
        return;
    }

    const mode = document.getElementById('mode-select').value;
    const sidebar = document.getElementById('sidebar');
    const sidebarContent = document.getElementById('sidebar-content');
    
    // å¼·åˆ¶é¡¯ç¤ºå´é‚Šæ¬„
    sidebar.style.display = 'flex';
    
    // å–å¾—æ‰€æœ‰æ©«æ’ (rows)
    // ä½ çš„ CSS ä¸­ grid æ˜¯ column-reverseï¼Œä»£è¡¨è¦–è¦ºä¸Šçš„ç¬¬ä¸€æ’æ˜¯åœ¨ DOM çš„æœ€å¾Œä¸€å€‹
    const allRows = Array.from(document.querySelectorAll('.row-wrap'));
    
    let emailListHTML = `
        <h3 style="color:var(--accent); border-bottom:1px solid var(--accent); padding-bottom:10px;">ğŸ“§ ç™¼é€åº§ä½é€šçŸ¥</h3>
        <p style="font-size:0.75rem; color:#94a3b8; margin-bottom:15px;">é»æ“Šã€Œç™¼é€ã€å°‡å•Ÿå‹•éƒµä»¶è»Ÿé«”ï¼Œä¸¦è‡ªå‹•å¡«å¯«åº§æ¨™ã€‚</p>
        <div class="scroll-area" style="max-height: 70vh;">
    `;

    // å»ºç«‹ä¸€å€‹è‡¨æ™‚é™£åˆ—ä¾†å­˜æ”¾åº§æ¨™è³‡è¨Š
    let results = [];

    // é‚è¼¯éæ­·ï¼šæ‰¾å‡ºæ¯å€‹å­¸ç”Ÿçš„ç‰©ç†åº§æ¨™
    allRows.forEach((row, rowIndex) => {
        const rowNum = rowIndex + 1; // ç¬¬å¹¾æ’
        const seatsInRow = row.querySelectorAll('.seat');
        
        seatsInRow.forEach((seat, seatIndex) => {
            const colNum = seatIndex + 1; // ç¬¬å¹¾å€‹
            
            // æª¢æŸ¥é€™æ ¼æœ‰æ²’æœ‰å­¸ç”Ÿ
            if (seat.dataset.hasStudent === "true") {
                const seatLabelNum = seat.querySelector('.seat-num').innerText;
                const student = assignedMap.get(parseInt(seatLabelNum));
                
                if (student) {
                    results.push({
                        name: student.å§“å,
                        email: student.æ•™è‚²ä¿¡ç®± || student.å­¸è™Ÿ + "@edu.tw", // è‹¥æ²’ä¿¡ç®±å‰‡å˜—è©¦çµ„åˆ
                        row: rowNum,
                        col: colNum,
                        id: seatLabelNum
                    });
                }
            }
        });
    });

    // ä¾ç…§å§“åæ’åºï¼Œæ–¹ä¾¿è€å¸«å°åå–®
    results.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hans-TW'));

    results.forEach(item => {
        const subject = encodeURIComponent(`æ•™å®¤åº§ä½å®‰æ’é€šçŸ¥ - ${item.name} åŒå­¸`);
        const body = encodeURIComponent(
            `è¦ªæ„›çš„ ${item.name} åŒå­¸ï¼š\n\n` +
            `ä½ çš„æ•™å®¤åº§ä½å·²ç¶“åˆ†é…å®Œæˆï¼Œè³‡è¨Šå¦‚ä¸‹ï¼š\n` +
            `--------------------------------\n` +
            `åº§ä½ç·¨è™Ÿï¼š${item.id}\n` +
            `ç‰©ç†ä½ç½®ï¼šç¬¬ ${item.row} æ’ï¼Œå·¦èµ·ç¬¬ ${item.col} å€‹ä½ç½®\n` +
            `--------------------------------\n\n` +
            `è«‹ä¾ç…§æ­¤ä½ç½®å…¥åº§ã€‚ç¥å­¸ç¿’æ„‰å¿«ï¼`
        );
        const mailto = `mailto:${item.email}?subject=${subject}&body=${body}`;

        emailListHTML += `
            <div style="padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <div style="font-weight:bold; color:white;">${item.name}</div>
                    <div style="font-size:0.7rem; color:var(--gold);">æ’:${item.row} / ä½:${item.col}</div>
                </div>
                <a href="${mailto}" target="_blank" 
                   style="background:var(--accent); color:black; padding:5px 12px; border-radius:4px; text-decoration:none; font-size:0.8rem; font-weight:bold;">
                   ç™¼é€
                </a>
            </div>
        `;
    });

    sidebarContent.innerHTML = emailListHTML + `</div>`;
}

    </script>
</body>
</html>
