<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ•™å®¤ç®¡ç†ç³»çµ± | é¸ä½å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #475569;
            --border: #cbd5e1;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            margin: 0; background: var(--bg); color: var(--text-main);
            font-family: "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
            height: 100vh; display: flex; flex-direction: column;
        }

        header {
            background: var(--card); padding: 15px 25px;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--border); z-index: 100; gap: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* åŠ å¤§æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† */
        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 13px; font-weight: 700; color: var(--text-sub); }

        input, select, button { 
            padding: 10px 16px; border-radius: 10px; border: 2px solid var(--border);
            background: var(--card); color: var(--text-main); font-size: 15px; font-weight: 500;
        }
        
        button { 
            cursor: pointer; background: var(--primary); color: white; border: none; 
            font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px;
            min-height: 44px; /* ç¬¦åˆäººé«”å·¥å­¸çš„å¤§å° */
        }
        button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        button:active { transform: translateY(0); }

        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-outline:hover { background: #eff6ff; }
        .btn-pdf { background: #334155; }
        .btn-mail { background: var(--warning); }
        .btn-random { background: var(--success); }

        main { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }

        #sidebar { 
            width: 350px; background: var(--card); border-radius: 16px;
            padding: 25px; display: flex; flex-direction: column;
            border: 1px solid var(--border); box-shadow: var(--shadow-lg);
        }

        #capture-area { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            overflow: auto; background: white; border-radius: 16px; padding: 40px;
            border: 1px solid var(--border); position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .grid-container { display: flex; flex-direction: column-reverse; gap: 15px; margin-bottom: 40px; }
        .row-wrap { display: flex; gap: 15px; }
        
        .seat {
            width: 85px; height: 70px; border: 2px solid var(--border); border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .seat:hover { border-color: var(--primary); transform: scale(1.05); z-index: 10; }
        .seat.disabled { background: #e2e8f0; border-style: dashed; opacity: 0.4; }
        .seat.occupied { border-color: var(--primary); background: #f0f9ff; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        
        .seat-num { position: absolute; top: 6px; left: 8px; font-size: 11px; color: var(--text-sub); font-weight: 800; }
        .student-name { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }

        .seat-tooltip {
            visibility: hidden; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: #0f172a; color: #fff; padding: 12px 16px; border-radius: 10px; 
            font-size: 13px; white-space: nowrap; z-index: 200; pointer-events: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); opacity: 0; line-height: 1.5;
        }
        .seat.occupied:hover .seat-tooltip { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(-5px); }

        .teacher-desk { 
            width: 300px; height: 55px; border: 3px solid var(--border); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; letter-spacing: 12px; color: var(--text-sub); font-weight: 800;
            background: #f8fafc; border-radius: 12px; margin-top: 20px;
        }

        .scroll-area { overflow-y: auto; flex: 1; margin-top: 15px; padding-right: 5px; }
        .manual-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--bg); }
        h3 { font-size: 20px; font-weight: 800; margin: 0 0 10px 0; color: var(--primary); }

        /* ç¾åŒ–æ²è»¸ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="controls">
            <div class="control-group">
                <label>ğŸ“‚ åå–®ç®¡ç†</label>
                <div style="display:flex; gap:8px;">
                    <input type="file" id="excel-input" style="width:180px;">
                    <button class="btn-outline" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è¼‰ç¯„æœ¬</button>
                </div>
            </div>
            <div class="control-group">
                <label>ğŸ“ æ•™å®¤ä½ˆå±€</label>
                <div style="display:flex; gap:8px;">
                    <input type="number" id="cols" value="6" style="width:60px;"> 
                    <input type="number" id="rows" value="6" style="width:60px;">
                    <button onclick="renderGrid()" class="btn-outline">é‡ç½®</button>
                </div>
            </div>
            <div class="control-group">
                <label>ğŸ® æ¨¡å¼é¸æ“‡</label>
                <select id="mode-select" onchange="switchMode()" style="width:160px;">
                    <option value="random">é»æ“Šè¨­ç½®éšœç¤™</option>
                    <option value="draw">ä¾åºæŠ½ç±¤æ¨¡å¼</option>
                    <option value="manual">æ‰‹å‹•åå–®æ¨¡å¼</option>
                </select>
            </div>
            <button id="btn-random-all" class="btn-random" onclick="randomAll()">ğŸ² ä¸€éµéš¨æ©Ÿåˆ†é…</button>
        </div>
        <div class="controls">
            <button class="btn-mail" onclick="sendEmails()">ğŸ“§ éƒµä»¶é€šçŸ¥</button>
            <button class="btn-pdf" onclick="exportPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
        </div>
    </header>

    <main>
        <div id="sidebar">
            <h3 id="sidebar-title">ç³»çµ±è¨Šæ¯</h3>
            <div id="sidebar-content" class="scroll-area">
                è«‹å…ˆè¼‰å…¥å­¸ç”Ÿåå–® Excel æª”æ¡ˆã€‚
            </div>
        </div>

        <div id="capture-area">
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk">è¬›æ¡Œ / å‰æ–¹</div>
        </div>
    </main>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ä¿æŒå®Œå…¨ä¸€è‡´ï¼Œåƒ…å„ªåŒ–é¡¯ç¤º ---
        let students = [];
        let assignedMap = new Map();
        let currentDrawIndex = 0;

        function downloadTemplate() {
            const header = ["åº§è™Ÿ", "å§“å", "å­¸è™Ÿ", "æ•™è‚²ä¿¡ç®±", "å¹¹éƒ¨1", "å¹¹éƒ¨2", "å¹¹éƒ¨3", "å¹¹éƒ¨4", "å¹¹éƒ¨5", "å¹¹éƒ¨6", "å¹¹éƒ¨7", "å¹¹éƒ¨8", "å¹¹éƒ¨9", "å¹¹éƒ¨10"];
            const data = [[1, "ç‹å°æ˜", "112001", "student@edu.tw", "ç­é•·", "", "", "", "", "", "", "", "", ""]];
            const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åå–®æ¨¡æ¿");
            XLSX.writeFile(wb, "æ•™å®¤åº§ä½è¡¨æ¨¡æ¿.xlsx");
        }

        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                students = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                students.sort((a,b) => (a.åº§è™Ÿ || 0) - (b.åº§è™Ÿ || 0));
                alert(`âœ… æˆåŠŸè¼‰å…¥ ${students.length} ä½åŒå­¸`);
                switchMode();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value);
            const c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; 
            assignedMap.clear();
            for (let i = 1; i <= r; i++) {
                const row = document.createElement('div');
                row.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { handleSeatClick(this); };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            refreshSeats();
        }

        function handleSeatClick(el) {
            if(document.getElementById('mode-select').value === 'random') {
                if(el.classList.contains('occupied')) return;
                el.classList.toggle('disabled');
                el.dataset.active = !el.classList.contains('disabled');
                refreshSeats();
            }
        }

        function refreshSeats() {
            const seats = document.querySelectorAll('.row-wrap .seat');
            let seatCounter = 1;
            seats.forEach(seat => {
                if (seat.dataset.active === "true") {
                    const student = assignedMap.get(seatCounter);
                    let roles = [];
                    if(student) {
                        for(let i=1; i<=10; i++) { if(student[`å¹¹éƒ¨${i}`]) roles.push(student[`å¹¹éƒ¨${i}`]); }
                    }
                    const roleDisplay = roles.length > 0 ? roles.join(' / ') : 'å­¸ç”Ÿ';
                    seat.className = student ? "seat occupied" : "seat";
                    seat.innerHTML = `
                        <span class="seat-num">${seatCounter}</span>
                        <span class="student-name">${student ? student.å§“å : ''}</span>
                        ${student ? `
                            <div class="seat-tooltip">
                                <b style="font-size:16px; color:#60a5fa">${student.å§“å}</b><br>
                                <span>åº§è™Ÿï¼š${student.åº§è™Ÿ} | å­¸è™Ÿï¼š${student.å­¸è™Ÿ || '-'}</span><br>
                                <span style="color:#fbbf24">è·ç¨±ï¼š${roleDisplay}</span>
                            </div>
                        ` : ''}
                    `;
                    seatCounter++;
                } else {
                    seat.className = "seat disabled";
                    seat.innerHTML = "";
                }
            });
            if(document.getElementById('mode-select').value === 'manual') updateManualSidebar();
        }

        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            currentDrawIndex = 0;
            document.getElementById('btn-random-all').style.display = (mode === 'random') ? 'flex' : 'none';
            if(mode === 'draw') updateDrawSidebar();
            else if(mode === 'manual') updateManualSidebar();
            else document.getElementById('sidebar-content').innerHTML = "<p><b>éš¨æ©Ÿæ¨¡å¼æ“ä½œï¼š</b><br>1. é»æ“Šç•«é¢ä¸­çš„åº§ä½å¯å°‡å…¶è¨­ç‚ºã€Œéšœç¤™ç‰©ã€ï¼ˆç°è‰²ï¼‰ã€‚<br>2. è¨­å®šå®Œå¾Œé»æ“Šä¸Šæ–¹ã€Œä¸€éµéš¨æ©Ÿåˆ†é…ã€ã€‚</p>";
        }

        function updateDrawSidebar() {
            const content = document.getElementById('sidebar-content');
            if(!students.length) return content.innerHTML = "è«‹å…ˆåŒ¯å…¥åå–®";
            if(currentDrawIndex < students.length) {
                const s = students[currentDrawIndex];
                content.innerHTML = `
                    <div style="background:#f0f9ff; padding:25px; border-radius:15px; text-align:center; border:2px solid #bae6fd;">
                        <p style="font-size:14px; color:var(--text-sub); margin:0;">ä¸‹ä¸€ä½æŠ½ç±¤åŒå­¸</p>
                        <h1 style="color:var(--primary); margin:15px 0; font-size:32px;">${s.åº§è™Ÿ} ${s.å§“å}</h1>
                        <button onclick="randomPickOne()" style="width:100%; padding:15px; font-size:18px;">ğŸ² éš¨æ©Ÿè½åº§</button>
                    </div>
                `;
            } else {
                content.innerHTML = "<div style='text-align:center; padding:20px;'><h3>ğŸŠ æŠ½ç±¤å®Œç•¢ï¼</h3><button class='btn-outline' onclick='currentDrawIndex=0; assignedMap.clear(); switchMode();' style='width:100%'>é‡æ–°é–‹å§‹</button></div>";
            }
        }

        function randomPickOne() {
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            const available = [];
            for(let i=1; i<=totalActive; i++) if(!assignedMap.has(i)) available.push(i);
            if(!available.length) return alert("ç©ºé–“ä¸è¶³ï¼");
            const target = available[Math.floor(Math.random() * available.length)];
            assignedMap.set(target, students[currentDrawIndex++]);
            refreshSeats();
            updateDrawSidebar();
        }

        function updateManualSidebar() {
            const content = document.getElementById('sidebar-content');
            if(!students.length) return;
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            let html = `<h3>å¿«é€Ÿå°ç…§è¡¨</h3>`;
            students.forEach(s => {
                const currentSeat = [...assignedMap.entries()].find(([k,v]) => v.åº§è™Ÿ === s.åº§è™Ÿ)?.[0] || "";
                html += `
                    <div class="manual-row">
                        <span><b style="color:var(--primary)">${String(s.åº§è™Ÿ).padStart(2,'0')}</b> ${s.å§“å}</span>
                        <select onchange="manualAssign('${s.åº§è™Ÿ}', this.value)" style="padding:5px; border-radius:6px;">
                            <option value="">æœªåˆ†é…</option>
                            ${Array.from({length: totalActive}, (_, i) => i + 1).map(n => `
                                <option value="${n}" ${currentSeat == n ? 'selected' : ''}>åº§ä½ ${n}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });
            content.innerHTML = html;
        }

        function manualAssign(studentNo, seatId) {
            const student = students.find(s => s.åº§è™Ÿ == studentNo);
            for (let [k, v] of assignedMap.entries()) if (v.åº§è™Ÿ == studentNo) assignedMap.delete(k);
            if(seatId) assignedMap.set(parseInt(seatId), student);
            refreshSeats();
        }

        function randomAll() {
            if(!students.length) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            if(students.length > totalActive) return alert("åº§ä½æ•¸ä¸è¶³ï¼");
            assignedMap.clear();
            const shuffled = [...students].sort(() => Math.random() - 0.5);
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            refreshSeats();
        }

        function exportPDF() {
            const element = document.getElementById('capture-area');
            const opt = {
                margin: 10, filename: 'ç­ç´šåº§ä½è¡¨.pdf',
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3, backgroundColor: '#ffffff' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function sendEmails() {
            if(!assignedMap.size) return alert("è«‹å…ˆå®Œæˆåˆ†é…");
            const list = []; const emails = [];
            assignedMap.forEach((s, id) => {
                list.push(`${s.åº§è™Ÿ} ${s.å§“å}ï¼šåº§ä½ ${id}`);
                const mail = s.æ•™è‚²ä¿¡ç®± || s.ä¿¡ç®±;
                if(mail) emails.push(mail);
            });
            window.open(`mailto:?bcc=${emails.join(',')}&subject=åº§ä½é€šçŸ¥&body=${encodeURIComponent(list.join('\n'))}`);
        }

        renderGrid();
    </script>
</body>
</html>
