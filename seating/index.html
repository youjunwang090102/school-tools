<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>班級座位系統 | 行政專業版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --border: #334155; --danger: #ef4444; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Toolbar */
        .navbar { display: flex; gap: 20px; padding: 15px 25px; background: var(--card); border-bottom: 2px solid var(--accent); align-items: center; }
        .nav-item { display: flex; flex-direction: column; gap: 5px; }
        .nav-item label { font-size: 12px; color: var(--accent); font-weight: bold; }
        
        button { cursor: pointer; padding: 6px 15px; border-radius: 4px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--accent); color: #000; }
        .btn-pdf { background: var(--danger); color: #fff; }
        select, input { background: #0f172a; color: #fff; border: 1px solid var(--border); padding: 5px; border-radius: 4px; }

        /* Main Content */
        .content { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 300px; background: rgba(0,0,0,0.25); border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; display: none; }
        .seat-view { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }

        /* 座位網格：關鍵在於反向 Column */
        .grid-container { display: flex; flex-direction: column-reverse; gap: 12px; }
        .row-wrap { display: flex; gap: 12px; }
        .seat { width: 90px; height: 65px; border: 2px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; background: rgba(255,255,255,0.03); }
        .seat.disabled { background: var(--danger); opacity: 0.2; border-style: dashed; }
        .seat-num { position: absolute; top: 4px; left: 6px; font-size: 11px; color: var(--accent); }
        .student-name { font-size: 1.1rem; font-weight: bold; }

        /* Tooltip */
        #tooltip { position: fixed; background: rgba(0,0,0,0.95); border: 1px solid var(--accent); padding: 10px; border-radius: 6px; font-size: 13px; pointer-events: none; display: none; z-index: 9999; }

        /* PDF 隱藏區域 */
        #pdf-layout { display: none; width: 210mm; padding: 15mm; background: white; color: black; font-family: "Microsoft JhengHei"; }
        .pdf-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 5px; font-size: 12px; }
        .pdf-grid { display: flex; flex-direction: column-reverse; gap: 10px; align-items: center; margin-top: 30px; }
        .pdf-seat { border: 1px solid #000; width: 60px; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-item">
        <label>1. Excel 匯入</label>
        <input type="file" id="upload-excel">
    </div>
    <div class="nav-item">
        <label>2. 教室尺寸</label>
        <div>
            寬 <input type="number" id="cols" value="6" style="width:40px"> 
            高 <input type="number" id="rows" value="6" style="width:40px">
            <button class="btn-main" onclick="initGrid()">生成教室</button>
        </div>
    </div>
    <div class="nav-item">
        <label>3. 選位模式</label>
        <select id="mode-select" onchange="switchMode()">
            <option value="random">一鍵隨機</option>
            <option value="draw">現場抽籤模式</option>
            <option value="manual">代號選位模式</option>
        </select>
    </div>
    <button id="run-btn" class="btn-main" onclick="runAutoRandom()">開始自動分配</button>
    <button class="btn-pdf" onclick="generatePDF()">匯出 A4 PDF</button>
</div>

<div class="content">
    <div id="sidebar"></div>
    <div class="seat-view">
        <div id="main-grid" class="grid-container"></div>
        <div style="margin-top:30px; border:2px solid var(--accent); padding:8px 80px; font-weight:bold; color:var(--accent); letter-spacing:10px;">講 桌 (前方)</div>
    </div>
</div>

<div id="tooltip"></div>

<div id="pdf-layout">
    <div class="pdf-header"><span id="p-class"></span><span id="p-teacher"></span></div>
    <h1 style="text-align:center; margin: 20px 0;" id="p-title">班級座位表</h1>
    <div style="display:flex; gap:20px">
        <div id="p-sidebar" style="flex:0 0 22%; font-size:11px"></div>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
            <div id="p-grid" class="pdf-grid"></div>
            <div style="margin-top:40px; border:2px solid #000; width:200px; text-align:center; padding:10px; font-weight:bold;">講 桌</div>
        </div>
    </div>
</div>

<script>
let studentList = [];
let seatMap = new Map(); // Key: 座位編號, Value: 學生物件
let classInfo = { name: "班級座位表", teacher: "導師" };
let currentDrawIdx = 0;

// 1. 讀取 Excel (抓取 A1, D1 及名單)
document.getElementById('upload-excel').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = (event) => {
        const data = new Uint8Array(event.target.result);
        const wb = XLSX.read(data, {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        
        classInfo.name = ws['B1'] ? ws['B1'].v : "未命名";
        classInfo.teacher = ws['D1'] ? ws['D1'].v : "未填寫";
        
        // 從 Row 2 開始讀取 (A2:座號, B2:姓名, C2:信箱, E-J:職務)
        const raw = XLSX.utils.sheet_to_json(ws, {range: 1});
        studentList = raw.map(s => ({
            座號: s['座號'],
            姓名: s['姓名'],
            信箱: s['教育信箱'],
            職務: [s['職務1'], s['職務2'], s['職務3'], s['職務4'], s['職務5'], s['職務6']].filter(v => v)
        }));
        alert(`匯入成功：${classInfo.name} / ${classInfo.teacher}\n共計 ${studentList.length} 位學生`);
    };
    reader.readAsArrayBuffer(e.target.files[0]);
});

// 2. 初始化網格 (左下角為 1)
function initGrid() {
    const rows = parseInt(document.getElementById('rows').value);
    const cols = parseInt(document.getElementById('cols').value);
    const container = document.getElementById('main-grid');
    container.innerHTML = '';
    seatMap.clear();

    for (let r = 0; r < rows; r++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row-wrap';
        for (let c = 0; c < cols; c++) {
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.dataset.active = "true";
            
            // 點擊切換禁用狀態
            seat.onclick = function() {
                if(this.dataset.assigned === "true") return;
                this.classList.toggle('disabled');
                this.dataset.active = !this.classList.contains('disabled');
                renderSeats();
            };

            // 滑動預覽資訊
            seat.onmousemove = (e) => showTooltip(e, seat);
            seat.onmouseleave = hideTooltip;

            rowDiv.appendChild(seat);
        }
        container.appendChild(rowDiv);
    }
    renderSeats();
}

// 核心渲染邏輯：依據視覺位置編號 (左下至右上)
function renderSeats() {
    let currentId = 1;
    const rows = document.querySelectorAll('.row-wrap'); // 這裡的 rows 是由上而下
    // 但因為 container 是 flex-direction: column-reverse，所以 rows[0] 是最底下那一排
    rows.forEach(row => {
        row.querySelectorAll('.seat').forEach(seat => {
            if (seat.dataset.active === "true") {
                const stu = seatMap.get(currentId);
                seat.innerHTML = `<span class="seat-num">${currentId}</span>
                                 <span class="student-name">${stu ? stu.姓名 : ''}</span>`;
                seat.dataset.sid = currentId;
                if(stu) seat.dataset.info = JSON.stringify(stu);
                else delete seat.dataset.info;
                currentId++;
            } else {
                seat.innerHTML = '';
                delete seat.dataset.sid;
                delete seat.dataset.info;
            }
        });
    });
}

// 3. 模式切換
function switchMode() {
    const mode = document.getElementById('mode-select').value;
    const side = document.getElementById('sidebar');
    const runBtn = document.getElementById('run-btn');
    
    side.style.display = (mode === 'random') ? 'none' : 'block';
    runBtn.style.display = (mode === 'random') ? 'block' : 'none';
    
    if(mode !== 'random') updateSidebar();
}

function updateSidebar() {
    const mode = document.getElementById('mode-select').value;
    const side = document.getElementById('sidebar');
    if(!studentList.length) return side.innerHTML = "請先匯入名單";

    if(mode === 'draw') {
        if(currentDrawIdx >= studentList.length) { side.innerHTML = "<h3>抽籤結束</h3>"; return; }
        const s = studentList[currentDrawIdx];
        side.innerHTML = `<h3>現場抽籤</h3>
            <p>正在為 <b>${s.姓名}</b> 選位</p>
            <input type="number" id="input-draw" placeholder="輸入座位編號">
            <button class="btn-main" onclick="confirmDraw()">確定</button>`;
    } else if(mode === 'manual') {
        side.innerHTML = `<h3>代號選位</h3>` + studentList.map(s => `
            <div style="margin-bottom:8px">${s.姓名}: <input type="number" onchange="manualSet(${s.座號}, this.value)" style="width:50px"></div>
        `).join('');
    }
}

function runAutoRandom() {
    const activeSeats = document.querySelectorAll('.seat[data-active="true"]').length;
    if(studentList.length > activeSeats) return alert("座位不足！");
    
    const shuffled = [...studentList].sort(() => Math.random() - 0.5);
    seatMap.clear();
    shuffled.forEach((s, i) => seatMap.set(i + 1, s));
    renderSeats();
}

function confirmDraw() {
    const num = parseInt(document.getElementById('input-draw').value);
    if(!num || seatMap.has(num) || !document.querySelector(`[data-sid="${num}"]`)) return alert("編號無效或已有人");
    seatMap.set(num, studentList[currentDrawIdx]);
    currentDrawIdx++;
    renderSeats(); updateSidebar();
}

function manualSet(stuNo, seatNo) {
    const stu = studentList.find(x => x.座號 == stuNo);
    if(seatNo) seatMap.set(parseInt(seatNo), stu);
    else seatMap.delete(parseInt(seatNo));
    renderSeats();
}

// 4. 預覽與 PDF
function showTooltip(e, seat) {
    if(!seat.dataset.info) return;
    const stu = JSON.parse(seat.dataset.info);
    const tip = document.getElementById('tooltip');
    tip.innerHTML = `<b>${stu.姓名}</b> (${stu.座號})<br>
                     信箱: ${stu.信箱 || '無'}<br>
                     職務: ${stu.職務.join(', ') || '無'}`;
    tip.style.display = 'block';
    tip.style.left = (e.clientX + 15) + 'px';
    tip.style.top = (e.clientY + 15) + 'px';
}
function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }

function generatePDF() {
    const root = document.getElementById('pdf-layout');
    document.getElementById('p-class').innerText = `班級：${classInfo.name}`;
    document.getElementById('p-teacher').innerText = `導師：${classInfo.teacher}`;
    
    let listHtml = "<b>班級職務表</b><hr>";
    studentList.forEach(s => {
        if(s.職務.length) listHtml += `<div style="margin-bottom:3px">${s.職務[0]}: ${s.姓名}</div>`;
    });
    document.getElementById('p-sidebar').innerHTML = listHtml;

    const pGrid = document.getElementById('p-grid'); pGrid.innerHTML = '';
    document.querySelectorAll('.row-wrap').forEach(row => {
        const pRow = document.createElement('div'); pRow.style.display = 'flex'; pRow.style.gap = '8px';
        row.querySelectorAll('.seat').forEach(seat => {
            const ps = document.createElement('div');
            ps.className = 'pdf-seat';
            if(seat.dataset.active === "true") {
                const sid = parseInt(seat.dataset.sid);
                const s = seatMap.get(sid);
                ps.innerHTML = `<span style="font-size:8px">${s ? s.座號 : sid}</span><b>${s ? s.姓名 : ''}</b>`;
            } else { ps.style.border = "none"; }
            pRow.appendChild(ps);
        });
        pGrid.appendChild(pRow);
    });

    root.style.display = 'block';
    html2pdf().from(root).set({ margin:0, filename: `${classInfo.name}座位表.pdf`, jsPDF:{format:'a4'} }).save().then(() => root.style.display='none');
}

// 啟動
initGrid();
</script>
</body>
</html>
