<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•åº§ä½ç³»çµ± | å…¨ç­é€šçŸ¥ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --green: #10b981; --gold: #fbbf24; --red: #ef4444;
            --text: #f8fafc; --border: #334155;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        .top-steps {
            display: flex; gap: 15px; padding: 12px 20px;
            background: var(--card-bg); border-bottom: 1px solid var(--border);
            align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .step-group { display: flex; gap: 20px; align-items: center; }
        .step-box { border-right: 1px solid var(--border); padding-right: 20px; }
        .step-box:last-child { border-right: none; }
        .step-title { font-size: 0.75rem; color: var(--accent); margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        
        input, select, button { 
            padding: 5px 8px; font-size: 0.85rem; border-radius: 4px;
            background: #0f172a; border: 1px solid var(--border); color: white;
        }
        button { cursor: pointer; font-weight: 600; transition: 0.2s; background: var(--accent); color: #000; border: none; }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-pdf { background: var(--red); color: white; }
        .btn-mail { background: var(--gold); color: #000; }

        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }
        
        .control-sidebar { 
            flex: 0 0 320px; background: rgba(255,255,255,0.03); 
            border-radius: 10px; padding: 15px; display: none; 
            flex-direction: column; border: 1px solid var(--border);
            max-height: 100%;
        }

        .seat-display { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; position: relative; overflow: auto;
        }

        .grid-container { display: flex; flex-direction: column-reverse; gap: 10px; margin-bottom: 25px; padding: 20px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat {
            width: 75px; height: 55px; border: 1px solid var(--border); border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: rgba(255,255,255,0.02); transition: 0.3s;
        }
        .seat.disabled { background: rgba(239, 68, 68, 0.15); border-color: transparent; }
        .seat-num { position: absolute; top: 2px; left: 4px; font-size: 10px; color: var(--accent); opacity: 0.7; }
        .student-name { font-size: 0.95rem; font-weight: bold; color: #fff; }

        .scroll-area { 
            overflow-y: auto; flex: 1; margin-top: 10px; padding-right: 5px;
        }
        .scroll-area::-webkit-scrollbar { width: 5px; }
        .scroll-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .teacher-desk { 
            width: 240px; height: 40px; border: 2px solid var(--accent); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; letter-spacing: 10px; color: var(--accent); font-weight: bold;
            border-radius: 4px;
        }

        .mail-card {
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px;
            border: 1px solid var(--border);
        }
    </style>
</head>
<body>

    <div class="top-steps">
        <div class="step-group">
            <div class="step-box">
                <div class="step-title">Step 1. åŒ¯å…¥</div>
                <input type="file" id="excel-input" style="width: 120px;">
                <button onclick="generateTemplate()" style="background:none; color:var(--accent); text-decoration: underline; border:none; padding:0;">ç¯„ä¾‹</button>
            </div>
            <div class="step-box">
                <div class="step-title">Step 2. é…ç½®</div>
                å¯¬ <input type="number" id="cols" value="6" style="width: 35px;"> 
                é«˜ <input type="number" id="rows" value="6" style="width: 35px;">
                <button onclick="renderGrid()">é‡è¨­</button>
            </div>
            <div class="step-box">
                <div class="step-title">Step 3. æ¨¡å¼</div>
                <select id="mode-select" onchange="switchMode()">
                    <option value="random">ä¸€éµéš¨æ©Ÿåˆ†é…</option>
                    <option value="draw">äº’å‹•ç¾å ´æŠ½ç±¤</option>
                    <option value="manual">æ‰‹å‹•ä»£è™Ÿé¸ä½</option>
                </select>
                <button id="main-action-btn" onclick="executeRandom()">ç«‹å³åˆ†é…</button>
            </div>
        </div>
        <div class="step-box" style="border:none;">
            <div class="step-title" style="color:var(--red);">Step 4. ç”¢å‡ºé€šçŸ¥</div>
            <button class="btn-pdf" onclick="exportPDF()">åƒ…åŒ¯å‡º PDF</button>
            <button class="btn-mail" onclick="generateEmailNotification()">å…¨ç­ä¸€éµé€šçŸ¥</button>
        </div>
    </div>

    <div class="main-layout">
        <div id="sidebar" class="control-sidebar">
            <div id="sidebar-header"></div>
            <div id="sidebar-content" class="scroll-area"></div>
        </div>

        <div class="seat-display" id="capture-area">
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk">è¬›æ¡Œ</div>
        </div>
    </div>

    <script>
        let fullData = [];
        let assignedMap = new Map(); 
        let currentDrawIndex = 0;

        // --- åŸºç¤é‚è¼¯ä¿ç•™ ---
        function generateTemplate() {
            const headers = ["åº§è™Ÿ", "å§“å", "å­¸è™Ÿ", "æ•™è‚²ä¿¡ç®±"];
            const ws = XLSX.utils.json_to_sheet([{"åº§è™Ÿ":1,"å§“å":"ç‹å°æ˜","å­¸è™Ÿ":"11201","æ•™è‚²ä¿¡ç®±":"test@edu.tw"}], {header: headers});
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åå–®");
            XLSX.writeFile(wb, "åº§ä½è¡¨åŒ¯å…¥ç¯„ä¾‹.xlsx");
        }

        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
                fullData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                alert(`âœ… è¼‰å…¥æˆåŠŸ`);
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value), c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; assignedMap.clear();
            for (let i = 1; i <= r; i++) {
                const row = document.createElement('div'); row.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div'); seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { 
                        if(this.dataset.hasStudent === "true") return;
                        this.classList.toggle('disabled'); 
                        this.dataset.active = !this.classList.contains('disabled');
                        recalculate();
                    };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            recalculate();
        }

        function recalculate() {
            const rows = document.querySelectorAll('.row-wrap');
            let num = 1;
            rows.forEach(row => {
                row.querySelectorAll('.seat').forEach(seat => {
                    if (seat.dataset.active === "true") {
                        const student = assignedMap.get(num);
                        seat.dataset.hasStudent = student ? "true" : "false";
                        seat.innerHTML = `<span class="seat-num">${num}</span><span class="student-name">${student ? student.å§“å : ''}</span>`;
                        num++;
                    } else { seat.innerHTML = ""; seat.dataset.hasStudent = "false"; }
                });
            });
            if(document.getElementById('mode-select').value === 'manual') updateManualTable();
        }

        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = (mode === 'random') ? 'none' : 'flex';
            document.getElementById('main-action-btn').style.display = (mode === 'random') ? 'block' : 'none';
            if(mode === 'draw') { currentDrawIndex = 0; updateDrawSidebar(); } 
            else if(mode === 'manual') { updateManualTable(); }
        }

        function executeRandom() {
            if(fullData.length === 0) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
            const shuffled = [...fullData].sort(() => Math.random() - 0.5);
            assignedMap.clear();
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            recalculate();
        }

        function updateManualTable() {
            const activeCount = document.querySelectorAll('.seat[data-active="true"]').length;
            document.getElementById('sidebar-header').innerHTML = `<h3>æ‰‹å‹•èª¿æ•´</h3>`;
            let html = `<table style="width:100%; font-size:0.8rem;">`;
            fullData.forEach(s => {
                const mySeat = Array.from(assignedMap.entries()).find(([k, v]) => v.å§“å === s.å§“å);
                let opt = `<option value="">æœªé¸</option>`;
                for(let i=1; i<=activeCount; i++) opt += `<option value="${i}" ${mySeat && mySeat[0] === i ? 'selected' : ''}>${i}</option>`;
                html += `<tr><td>${s.å§“å}</td><td><select onchange="manualAssign('${s.å§“å}', this.value)">${opt}</select></td></tr>`;
            });
            document.getElementById('sidebar-content').innerHTML = html + `</table>`;
        }

        function manualAssign(name, seatId) {
            for (let [k, v] of assignedMap.entries()) if (v.å§“å === name) assignedMap.delete(k);
            if(seatId) assignedMap.set(parseInt(seatId), fullData.find(s => s.å§“å === name));
            recalculate();
        }

        // --- PDF èˆ‡ å…¨ç­éƒµä»¶é‚è¼¯ ---
        function exportPDF() {
            const element = document.getElementById('capture-area');
            return html2pdf().set({ margin: 10, filename: 'æ•™å®¤åº§ä½è¡¨.pdf', html2canvas: { scale: 2 }, jsPDF: { orientation: 'landscape' }}).from(element).save();
        }

        function generateEmailNotification() {
            if (assignedMap.size === 0) return alert("è«‹å…ˆå®Œæˆåˆ†é…ï¼");
            
            // 1. å…ˆå•Ÿå‹• PDF ä¸‹è¼‰
            alert("ç³»çµ±å°‡å…ˆä¸‹è¼‰ PDF åº§ä½è¡¨ï¼Œè«‹åœ¨é–‹å•Ÿä¿¡ç®±å¾Œå°‡æª”æ¡ˆå¤¾å¸¶ä¸Šå‚³ã€‚");
            exportPDF();

            // 2. æº–å‚™å…¨ç­åå–®å­—ä¸² (ä¾ç·¨è™Ÿ 1~N æ’åº)
            let seatListString = "ã€å…¨ç­åº§ä½åˆ†é…è¡¨ã€‘\n";
            seatListString += "----------------------------\n";
            
            const allRows = Array.from(document.querySelectorAll('.row-wrap'));
            let results = [];

            // ç¶­æŒåŸåˆ¤æ–·é‚è¼¯
            allRows.forEach((row, rowIndex) => {
                row.querySelectorAll('.seat').forEach((seat, colIndex) => {
                    if (seat.dataset.hasStudent === "true") {
                        const num = parseInt(seat.querySelector('.seat-num').innerText);
                        const s = assignedMap.get(num);
                        results.push({ num: num, name: s.å§“å, email: s.æ•™è‚²ä¿¡ç®±, row: rowIndex + 1, col: colIndex + 1 });
                    }
                });
            });

            // æŒ‰ç·¨è™Ÿ 1 è™Ÿé–‹å§‹æ’åº
            results.sort((a, b) => a.num - b.num);
            results.forEach(item => {
                seatListString += `ç·¨è™Ÿ ${item.num}ï¼š${item.name} (ä½ç½®ï¼šç¬¬ ${item.row} æ’ / å·¦èµ·ç¬¬ ${item.col} ä½)\n`;
            });

            // 3. é¡¯ç¤ºå´é‚Šæ¬„ä¾›é»æ“Šç™¼é€ï¼ˆå› ç‚ºä¸€å€‹ mailto åªèƒ½é–‹å•Ÿä¸€å€‹æ”¶ä»¶äººï¼Œå»ºè­°ç™¼çµ¦ç­é•·æˆ–è‡ªå·±ï¼‰
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = 'flex';
            document.getElementById('sidebar-header').innerHTML = `<h3>ğŸ“§ ç™¼é€å…¨ç­æ¸…å–®</h3>`;
            
            const subject = encodeURIComponent(`æœ€æ–°æ•™å®¤åº§ä½è¡¨å…¬å‘Š (å…§å«å…¨ç­æ¸…å–®)`);
            const body = encodeURIComponent(`å„ä½è€å¸«ã€åŒå­¸å¥½ï¼š\n\né™„ä»¶ç‚ºæœ¬æ¬¡åº§ä½è¡¨çš„ PDF æª”æ¡ˆï¼Œä»¥ä¸‹ç‚ºè©³ç´°åå–®æ¸…å–®ï¼š\n\n${seatListString}\n\nè«‹å¤§å®¶ä¾è¦å®šå…¥åº§ã€‚`);
            
            // é€™è£¡åˆ—å‡ºæ‰€æœ‰äººçš„ Emailï¼Œä½ å¯ä»¥é¸æ“‡ç™¼çµ¦ç‰¹å®šçš„äºº
            let html = `<p style="font-size:0.75rem; color:var(--gold)">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•Ÿéƒµä»¶ï¼Œå…§å®¹å·²è‡ªå‹•åŒ…å« 1 è™Ÿåˆ°æœ€å¾Œä¸€è™Ÿçš„åå–®ã€‚</p>`;
            
            // ç¯„ä¾‹ï¼šç™¼çµ¦å…¨ç­ (æœƒæŠŠæ‰€æœ‰ Email ä¸²èµ·ä¾†)
            const allEmails = results.map(r => r.email).filter(e => e).join(',');
            const mailtoAll = `mailto:${allEmails}?subject=${subject}&body=${body}`;

            html += `
                <div class="mail-card">
                    <div style="font-weight:bold; margin-bottom:10px;">æ–¹æ¡ˆ Aï¼šä¸€éµç™¼çµ¦å…¨ç­</div>
                    <a href="${mailtoAll}" target="_blank" style="display:block; text-align:center; background:var(--green); color:#000; padding:10px; border-radius:4px; text-decoration:none; font-weight:bold;">é–‹å•Ÿç¾¤ç™¼éƒµä»¶</a>
                </div>
                <hr style="border-color:var(--border)">
                <div style="font-size:0.75rem; color:var(--accent); margin-bottom:10px;">æ–¹æ¡ˆ Bï¼šå€‹åˆ¥é€šçŸ¥</div>
            `;

            // ä¿ç•™å€‹åˆ¥ç™¼é€çš„æ¸…å–®ï¼Œæ–¹ä¾¿è£œç™¼
            results.forEach(item => {
                const individualBody = encodeURIComponent(`è¦ªæ„›çš„ ${item.name} åŒå­¸ï¼š\n\nä½ çš„åº§ä½ç·¨è™Ÿæ˜¯ ${item.num}ã€‚\n\nå…¨ç­åå–®å¦‚ä¸‹ï¼š\n${seatListString}`);
                const mailtoIndi = `mailto:${item.email}?subject=${subject}&body=${individualBody}`;
                html += `
                    <div style="padding:5px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">
                        <span style="font-size:0.8rem;">${item.num}. ${item.name}</span>
                        <a href="${mailtoIndi}" target="_blank" style="color:var(--gold); text-decoration:none; font-size:0.75rem;">ç™¼é€</a>
                    </div>`;
            });

            document.getElementById('sidebar-content').innerHTML = html;
        }

        renderGrid();
    </script>
</body>
</html>
