<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼åº§ä½ç®¡ç†ç³»çµ± | Seating Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent-blue: #38bdf8;
            --accent-red: #ef4444; --accent-green: #10b981; --accent-gold: #fbbf24;
            --text-main: #f8fafc; --text-dim: #94a3b8; --border: #334155;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text-main);
            font-family: "PingFang TC", sans-serif; display: flex; flex-direction: column; align-items: center;
        }

        .top-nav { width: 100%; padding: 15px 40px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .container { width: 95%; max-width: 1400px; display: flex; gap: 20px; padding: 20px; box-sizing: border-box; }

        /* å·¦å´æ§åˆ¶é¢æ¿ */
        .side-panel { flex: 0 0 400px; display: flex; flex-direction: column; gap: 15px; }
        .glass-panel { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        
        /* å³å´ä¸»ç•«é¢ */
        .main-display { flex: 1; background: rgba(0,0,0,0.2); border-radius: 12px; display: flex; flex-direction: column; align-items: center; padding: 30px; position: relative; }

        h2 { font-size: 1rem; color: var(--accent-blue); margin-top: 0; border-left: 4px solid var(--accent-blue); padding-left: 10px; }
        .controls { display: flex; flex-direction: column; gap: 10px; }
        
        button { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-blue { background: var(--accent-blue); color: #0f172a; }
        .btn-green { background: var(--accent-green); color: #0f172a; }
        .btn-gold { background: var(--accent-gold); color: #0f172a; }

        input, select { background: #0f172a; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; }

        /* å­¸ç”Ÿåˆ—è¡¨èˆ‡é¸è™Ÿå€ */
        .list-area { height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: #0a0f1e; }
        .student-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #1e293b; font-size: 0.9rem; }
        .student-item.assigned { opacity: 0.3; text-decoration: line-through; }

        /* åº§ä½æ¨£å¼ */
        .grid-container { display: flex; flex-direction: column-reverse; gap: 10px; margin-bottom: 30px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat {
            width: 80px; height: 60px; border: 1px solid var(--border); border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: rgba(255,255,255,0.03);
        }
        .seat.disabled { background: rgba(239, 68, 68, 0.1); border-color: var(--accent-red); }
        .seat.disabled::after { content: "âœ•"; color: var(--accent-red); opacity: 0.3; }
        .seat-num { position: absolute; top: 2px; left: 5px; font-size: 10px; color: var(--text-dim); }
        .student-name { font-weight: bold; color: var(--accent-blue); }

        .teacher-desk { width: 250px; height: 40px; border: 2px solid var(--accent-blue); display: flex; align-items: center; justify-content: center; letter-spacing: 10px; color: var(--accent-blue); font-weight: bold; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="top-nav">
        <span>äº’å‹•åº§ä½ç®¡ç†ç³»çµ±</span>
        <div id="system-time"></div>
    </div>

    <div class="container">
        <div class="side-panel">
            <div class="glass-panel">
                <h2>Step 1. åŒ¯å…¥åå–®</h2>
                <div class="controls">
                    <input type="file" id="excel-input" accept=".xlsx, .xls">
                    <button class="btn-blue" onclick="generateTemplate()" style="font-size: 12px;">ä¸‹è¼‰ç¯„ä¾‹æª”</button>
                    <div id="status-text" style="font-size: 12px; color: var(--accent-green);"></div>
                </div>
            </div>

            <div class="glass-panel">
                <h2>Step 2. åº§ä½é…ç½®</h2>
                <div class="controls">
                    <div style="display: flex; gap: 5px;">
                        å¯¬:<input type="number" id="cols" value="6" style="width: 50px;">
                        é«˜:<input type="number" id="rows" value="6" style="width: 50px;">
                    </div>
                    <button class="btn-blue" onclick="renderGrid()">é‡æ–°é…ç½®ç¶²æ ¼</button>
                </div>
            </div>

            <div class="glass-panel">
                <h2>Step 3. é¸ä½æ–¹å¼</h2>
                <div class="controls">
                    <button class="btn-green" onclick="assignRandom()">1. ä¸€éµéš¨æ©Ÿåˆ†é…</button>
                    <button class="btn-gold" onclick="startLuckyDraw()">2. ç¾å ´æŠ½ç±¤æ¨¡å¼</button>
                    <div style="border-top: 1px solid var(--border); margin: 5px 0;"></div>
                    <div style="font-size: 12px; margin-bottom: 5px;">3. æ‰‹å‹•é¸æ“‡ä»£è™Ÿï¼š</div>
                    <div style="display: flex; gap: 5px;">
                        <select id="student-select" style="flex: 1;"></select>
                        <input type="number" id="seat-id-input" placeholder="ä»£è™Ÿ" style="width: 60px;">
                        <button class="btn-blue" onclick="assignManual()">ç¢ºèª</button>
                    </div>
                </div>
            </div>

            <div class="glass-panel" style="flex: 1;">
                <h2>å­¸ç”Ÿåå–®ç‹€æ…‹</h2>
                <div id="student-list-display" class="list-area"></div>
            </div>
        </div>

        <div class="main-display">
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk">è¬›æ¡Œ</div>
        </div>
    </div>

    <script>
        let fullData = [];
        let assignedData = new Map(); // è¨˜éŒ„èª°åå“ª

        // ä¸‹è¼‰ç¯„ä¾‹æª”
        function generateTemplate() {
            const headers = ["åº§è™Ÿ", "å§“å", "å­¸è™Ÿ", "æ•™è‚²ä¿¡ç®±"];
            for (let i = 1; i <= 10; i++) headers.push(`å¹¹éƒ¨åŠå°è€å¸«${i}`);
            const ws = XLSX.utils.json_to_sheet([{"åº§è™Ÿ":1,"å§“å":"ç¯„ä¾‹åŒå­¸"}], {header: headers});
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åå–®");
            XLSX.writeFile(wb, "åå–®ç¯„ä¾‹.xlsx");
        }

        // è®€å– Excel
        document.getElementById('excel-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                fullData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                updateStudentUI();
            };
            reader.readAsArrayBuffer(file);
        });

        function updateStudentUI() {
            const list = document.getElementById('student-list-display');
            const select = document.getElementById('student-select');
            list.innerHTML = '';
            select.innerHTML = '<option value="">é¸æ“‡å­¸ç”Ÿ</option>';
            
            fullData.forEach(s => {
                const isAssigned = Array.from(assignedData.values()).some(val => val.å§“å === s.å§“å);
                list.innerHTML += `<div class="student-item ${isAssigned ? 'assigned' : ''}">
                    <span>${s.å§“å}</span><span>${isAssigned ? 'å·²å…¥åº§' : 'æœªåˆ†é…'}</span>
                </div>`;
                if (!isAssigned) {
                    select.innerHTML += `<option value="${s.å§“å}">${s.å§“å}</option>`;
                }
            });
            document.getElementById('status-text').innerText = `âœ… å…± ${fullData.length} äºº`;
        }

        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value);
            const c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            assignedData.clear();

            for (let i = 1; i <= r; i++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() {
                        if (this.dataset.assigned === "true") return;
                        this.classList.toggle('disabled');
                        this.dataset.active = this.classList.contains('disabled') ? "false" : "true";
                        recalculate();
                    };
                    rowDiv.appendChild(seat);
                }
                grid.appendChild(rowDiv);
            }
            recalculate();
            updateStudentUI();
        }

        function recalculate() {
            const rows = document.querySelectorAll('.row-wrap');
            let num = 1;
            rows.forEach(row => {
                row.querySelectorAll('.seat').forEach(seat => {
                    if (seat.dataset.active === "true") {
                        const student = assignedData.get(num);
                        seat.innerHTML = `<span class="seat-num">${num}</span><span class="student-name">${student ? student.å§“å : ''}</span>`;
                        num++;
                    } else { seat.innerHTML = ""; }
                });
            });
        }

        // --- Step 3 é‚è¼¯ ---

        // 1. éš¨æ©Ÿåˆ†é…
        function assignRandom() {
            if (fullData.length === 0) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
            const activeCount = document.querySelectorAll('.seat[data-active="true"]').length;
            if (fullData.length > activeCount) return alert("åº§ä½ä¸è¶³");

            const shuffled = [...fullData].sort(() => Math.random() - 0.5);
            assignedData.clear();
            shuffled.forEach((s, i) => assignedData.set(i + 1, s));
            recalculate();
            updateStudentUI();
        }

        // 2. ç¾å ´æŠ½ç±¤
        function startLuckyDraw() {
            const unassigned = fullData.filter(s => !Array.from(assignedData.values()).some(v => v.å§“å === s.å§“å));
            if (unassigned.length === 0) return alert("å…¨éƒ¨å­¸ç”Ÿå·²å°±åº§");

            const luckyOne = unassigned[Math.floor(Math.random() * unassigned.length)];
            const targetSeatId = assignedData.size + 1;
            
            alert(`ğŸ‰ æŠ½åˆ°ä½ äº†ï¼šã€ ${luckyOne.å§“å} ã€‘ï¼è«‹å…¥åº§ ${targetSeatId} è™Ÿä½ã€‚`);
            assignedData.set(targetSeatId, luckyOne);
            recalculate();
            updateStudentUI();
        }

        // 3. æ‰‹å‹•ä»£è™Ÿ
        function assignManual() {
            const name = document.getElementById('student-select').value;
            const seatId = parseInt(document.getElementById('seat-id-input').value);
            if (!name || !seatId) return alert("è«‹é¸æ“‡å­¸ç”Ÿä¸¦è¼¸å…¥ä»£è™Ÿ");
            
            const student = fullData.find(s => s.å§“å === name);
            assignedData.set(seatId, student);
            recalculate();
            updateStudentUI();
            document.getElementById('seat-id-input').value = '';
        }

        setInterval(() => {
            document.getElementById('system-time').innerText = new Date().toLocaleString();
        }, 1000);

        renderGrid();
    </script>
</body>
</html>
