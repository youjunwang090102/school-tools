<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ•™å®¤ç®¡ç†ç³»çµ± | Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #059669;
            --warning: #d97706;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #475569;
            --border: #cbd5e1;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            margin: 0; background: var(--bg); color: var(--text-main);
            font-family: "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
            height: 100vh; display: flex; flex-direction: column;
        }

        header {
            background: var(--card); padding: 15px 25px;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--border); z-index: 100; gap: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 13px; font-weight: 700; color: var(--text-sub); }

        input, select, button { 
            padding: 10px 16px; border-radius: 10px; border: 2px solid var(--border);
            background: var(--card); color: var(--text-main); font-size: 15px; font-weight: 500;
        }
        
        button { 
            cursor: pointer; background: var(--primary); color: white; border: none; 
            font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px;
            min-height: 44px;
        }
        button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-pdf { background: #334155; }
        .btn-mail { background: var(--warning); }
        .btn-random { background: var(--success); }

        main { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }

        #sidebar { 
            width: 380px; background: var(--card); border-radius: 16px;
            padding: 20px; display: flex; flex-direction: column;
            border: 1px solid var(--border); box-shadow: var(--shadow-lg);
        }

        #capture-area { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            overflow: auto; background: white; border-radius: 16px; padding: 40px;
            border: 1px solid var(--border); position: relative;
        }

        .grid-container { display: flex; flex-direction: column-reverse; gap: 15px; margin-bottom: 40px; }
        .row-wrap { display: flex; gap: 15px; }
        
        .seat {
            width: 85px; height: 70px; border: 2px solid var(--border); border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: #fff;
        }
        .seat.occupied { border-color: var(--primary); background: #f0f9ff; }
        .seat.disabled { background: #e2e8f0; opacity: 0.4; border-style: dashed; }
        .seat-num { position: absolute; top: 6px; left: 8px; font-size: 11px; color: var(--text-sub); font-weight: 800; }
        .student-name { font-size: 1.1rem; font-weight: 800; }

        .seat-tooltip {
            visibility: hidden; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: #0f172a; color: #fff; padding: 12px 16px; border-radius: 10px; z-index: 200;
        }
        .seat.occupied:hover .seat-tooltip { visibility: visible; opacity: 1; }

        .teacher-desk { 
            width: 300px; height: 55px; border: 3px solid var(--border); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; letter-spacing: 12px; color: var(--text-sub); font-weight: 800;
            background: #f8fafc; border-radius: 12px; margin-top: 20px;
        }

        .scroll-area { overflow-y: auto; flex: 1; margin-top: 10px; }
        .student-list-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .student-list-item input { margin-right: 10px; width: 18px; height: 18px; }
        
        .priority-badge { background: #fee2e2; color: #dc2626; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        h3 { font-size: 18px; margin: 0 0 10px 0; color: var(--primary); display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <header>
        <div class="controls">
            <div class="control-group">
                <label>ğŸ“‚ åå–®ç®¡ç†</label>
                <div style="display:flex; gap:8px;">
                    <input type="file" id="excel-input" style="width:180px;">
                    <button class="btn-outline" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è¼‰ç¯„æœ¬</button>
                </div>
            </div>
            <div class="control-group">
                <label>ğŸ“ æ•™å®¤ä½ˆå±€</label>
                <div style="display:flex; gap:8px;">
                    <input type="number" id="cols" value="6" style="width:60px;"> 
                    <input type="number" id="rows" value="6" style="width:60px;">
                    <button onclick="renderGrid()" class="btn-outline">é‡ç½®</button>
                </div>
            </div>
            <div class="control-group">
                <label>ğŸ® æ¨¡å¼é¸æ“‡</label>
                <select id="mode-select" onchange="switchMode()" style="width:160px;">
                    <option value="random">è¨­ç½®éšœç¤™ç‰©æ¨¡å¼</option>
                    <option value="draw">ä¾åºæŠ½ç±¤æ¨¡å¼</option>
                    <option value="manual">æ‰‹å‹•åå–®æ¨¡å¼</option>
                </select>
            </div>
            <button id="btn-random-all" class="btn-random" onclick="randomAll()">ğŸ² ä¸€éµéš¨æ©Ÿåˆ†é…</button>
        </div>
        <div class="controls">
            <button class="btn-mail" onclick="sendEmails()">ğŸ“§ éƒµä»¶é€šçŸ¥</button>
            <button class="btn-pdf" onclick="exportPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
        </div>
    </header>

    <main>
        <div id="sidebar">
            <h3 id="sidebar-title">ç³»çµ±è¨Šæ¯</h3>
            <div id="sidebar-content" class="scroll-area">
                è«‹å…ˆè¼‰å…¥å­¸ç”Ÿåå–®ã€‚
            </div>
        </div>

        <div id="capture-area">
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk">è¬›æ¡Œ / å‰æ–¹</div>
        </div>
    </main>

    <script>
        let students = [];
        let assignedMap = new Map();
        let priorityList = new Set(); // å„²å­˜å„ªå…ˆåå–®çš„å­¸ç”Ÿåºè™Ÿ(index)
        let hasStartedDrawing = false;
        let drawQueue = []; // æŠ½ç±¤é †åº

        function downloadTemplate() {
            const header = ["åº§è™Ÿ", "å§“å", "å­¸è™Ÿ", "æ•™è‚²ä¿¡ç®±", "å¹¹éƒ¨1", "å¹¹éƒ¨2", "å¹¹éƒ¨3", "å¹¹éƒ¨4", "å¹¹éƒ¨5", "å¹¹éƒ¨6", "å¹¹éƒ¨7", "å¹¹éƒ¨8", "å¹¹éƒ¨9", "å¹¹éƒ¨10"];
            const data = [[1, "ç¯„ä¾‹å­¸ç”Ÿ", "112001", "student@edu.tw", "ç­é•·", "", "", "", "", "", "", "", "", ""]];
            const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åå–®");
            XLSX.writeFile(wb, "æ•™å®¤åº§ä½è¡¨æ¨¡æ¿.xlsx");
        }

        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                students = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                students.sort((a,b) => (a.åº§è™Ÿ || 0) - (b.åº§è™Ÿ || 0));
                alert(`âœ… æˆåŠŸè¼‰å…¥ ${students.length} ä½åŒå­¸`);
                switchMode();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value);
            const c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; assignedMap.clear();
            for (let i = 1; i <= r; i++) {
                const row = document.createElement('div');
                row.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { handleSeatClick(this); };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            refreshSeats();
        }

        function handleSeatClick(el) {
            if(document.getElementById('mode-select').value === 'random' && !assignedMap.size) {
                el.classList.toggle('disabled');
                el.dataset.active = !el.classList.contains('disabled');
                refreshSeats();
            }
        }

        function refreshSeats() {
            const seats = document.querySelectorAll('.row-wrap .seat');
            let seatCounter = 1;
            seats.forEach(seat => {
                if (seat.dataset.active === "true") {
                    const student = assignedMap.get(seatCounter);
                    seat.className = student ? "seat occupied" : "seat";
                    seat.innerHTML = `
                        <span class="seat-num">${seatCounter}</span>
                        <span class="student-name">${student ? student.å§“å : ''}</span>
                        ${student ? `<div class="seat-tooltip"><b>${student.å§“å}</b><br>åº§è™Ÿï¼š${student.åº§è™Ÿ}</div>` : ''}
                    `;
                    seatCounter++;
                } else {
                    seat.className = "seat disabled";
                    seat.innerHTML = "";
                }
            });
        }

        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            hasStartedDrawing = false;
            priorityList.clear();
            if(mode === 'draw') initDrawMode();
            else if(mode === 'manual') updateManualSidebar();
            else document.getElementById('sidebar-content').innerHTML = "<p>é»æ“Šåº§ä½å¯è¨­ç‚ºéšœç¤™ç‰©ã€‚</p>";
            document.getElementById('btn-random-all').style.display = (mode === 'random') ? 'flex' : 'none';
        }

        // --- æ ¸å¿ƒï¼šæŠ½ç±¤æ¨¡å¼é‚è¼¯ ---
        function initDrawMode() {
            const content = document.getElementById('sidebar-content');
            if(!students.length) return content.innerHTML = "è«‹å…ˆåŒ¯å…¥åå–®";
            
            let html = `<h3>å„ªå…ˆå‰å…©æ’ (1~12)</h3>
                        <p style="font-size:12px; color:var(--text-sub);">è«‹å‹¾é¸å„ªå…ˆæŠ½ç±¤çš„åŒå­¸ï¼ˆæœ€å¤š12ä½ï¼‰</p>
                        <div class="scroll-area" style="max-height: 300px; border: 1px solid var(--border); border-radius:8px;">`;
            
            students.forEach((s, idx) => {
                html += `
                    <label class="student-list-item">
                        <input type="checkbox" class="priority-check" value="${idx}" onchange="togglePriority(${idx}, this)">
                        ${s.åº§è™Ÿ}. ${s.å§“å}
                    </label>
                `;
            });
            
            html += `</div><button onclick="startDrawing()" style="width:100%; margin-top:15px; background:var(--primary);">ç¢ºèªåå–®ä¸¦é–‹å§‹æŠ½ç±¤</button>`;
            content.innerHTML = html;
        }

        function togglePriority(idx, el) {
            if(el.checked) {
                if(priorityList.size >= 12) {
                    alert("å„ªå…ˆåå–®æœ€å¤šåªèƒ½å‹¾é¸ 12 ä½åŒå­¸ï¼");
                    el.checked = false;
                    return;
                }
                priorityList.add(idx);
            } else {
                priorityList.delete(idx);
            }
        }

        function startDrawing() {
            hasStartedDrawing = true;
            // å»ºç«‹éšŠåˆ—ï¼šå„ªå…ˆåå–®æ’åœ¨å‰é¢ï¼Œå…¶é¤˜åœ¨å¾Œé¢
            const pArr = Array.from(priorityList);
            const otherArr = students.map((_, i) => i).filter(i => !priorityList.has(i));
            drawQueue = [...pArr, ...otherArr];
            nextDrawStep();
        }

        function nextDrawStep() {
            const content = document.getElementById('sidebar-content');
            if(drawQueue.length === 0) {
                content.innerHTML = "<h3>âœ¨ æŠ½ç±¤å·²å…¨éƒ¨å®Œæˆï¼</h3>";
                return;
            }

            const currentIdx = drawQueue[0];
            const s = students[currentIdx];
            const isPriority = priorityList.has(currentIdx);

            content.innerHTML = `
                <div style="text-align:center; padding:10px;">
                    <p>${isPriority ? '<span class="priority-badge">å„ªå…ˆå‰å…©æ’æ¨¡å¼</span>' : 'ä¸€èˆ¬æŠ½ç±¤æ¨¡å¼'}</p>
                    <p style="font-size:14px; color:var(--text-sub);">è«‹åŒå­¸ä¸Šå°æŒ‰éˆ•</p>
                    <h1 style="font-size:40px; margin:10px 0;">${s.å§“å}</h1>
                    <button onclick="executePick(${currentIdx}, ${isPriority})" style="width:100%; font-size:20px; padding:20px; background:var(--success);">ğŸ° æŠ½ä½å­</button>
                    <p style="margin-top:15px; font-size:12px; color:var(--text-sub);">å‰©é¤˜äººæ•¸: ${drawQueue.length} äºº</p>
                </div>
            `;
        }

        function executePick(studentIdx, isPriority) {
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            const available = [];
            
            // æ‰¾å‡ºå¯ç”¨çš„ä½å­
            for(let i=1; i<=totalActive; i++) {
                if(!assignedMap.has(i)) {
                    // å¦‚æœæ˜¯å„ªå…ˆï¼Œåªèƒ½æŠ½ 1~12
                    if(isPriority) {
                        if(i <= 12) available.push(i);
                    } else {
                        available.push(i);
                    }
                }
            }

            if(available.length === 0) {
                alert(isPriority ? "å‰å…©æ’(1~12)å·²ç„¡ç©ºä½ï¼è«‹æŒ‰ä¸€èˆ¬æµç¨‹æŠ½ç±¤ã€‚" : "å·²ç„¡å¯ç”¨åº§ä½ï¼");
                if(isPriority) {
                    // å¼·åˆ¶è½‰ç‚ºä¸€èˆ¬æ¨¡å¼æŠ½ç±¤
                    executePick(studentIdx, false);
                    return;
                }
                return;
            }

            const target = available[Math.floor(Math.random() * available.length)];
            assignedMap.set(target, students[studentIdx]);
            drawQueue.shift(); // ç§»é™¤éšŠåˆ—ç¬¬ä¸€å€‹äºº
            refreshSeats();
            nextDrawStep();
        }

        // --- å…¶é¤˜åŠŸèƒ½ ---
        function randomAll() {
            if(!students.length) return alert("è«‹åŒ¯å…¥åå–®");
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            if(students.length > totalActive) return alert("åº§ä½ä¸è¶³");
            assignedMap.clear();
            const shuffled = [...students].sort(() => Math.random() - 0.5);
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            refreshSeats();
        }

        function updateManualSidebar() {
            let html = `<h3>æ‰‹å‹•åå–®æ¨¡å¼</h3><div class="scroll-area">`;
            students.forEach(s => {
                html += `<div class="student-list-item">${s.åº§è™Ÿ}. ${s.å§“å}</div>`;
            });
            html += `</div>`;
            document.getElementById('sidebar-content').innerHTML = html;
        }

        function exportPDF() {
            const opt = { margin: 10, filename: 'åº§ä½è¡¨.pdf', html2canvas: { scale: 3 }, jsPDF: { orientation: 'landscape' } };
            html2pdf().set(opt).from(document.getElementById('capture-area')).save();
        }

        function sendEmails() { alert("å·²æº–å‚™å¥½éƒµä»¶æ¸…å–®ã€‚"); }

        renderGrid();
    </script>
</body>
</html>
