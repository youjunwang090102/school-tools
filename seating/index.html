<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>班級座位系統 - 2026 行政列印 Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --green: #10b981; --gold: #fbbf24; --text: #f8fafc; --border: #334155;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .top-steps { display: flex; gap: 15px; padding: 10px 20px; background: var(--card-bg); border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; }
        .step-group { display: flex; gap: 15px; align-items: center; }
        .step-title { font-size: 0.7rem; color: var(--accent); font-weight: bold; margin-bottom: 2px; }
        button { cursor: pointer; padding: 5px 12px; border-radius: 4px; border: none; font-weight: 600; background: var(--accent); color: #000; }
        .btn-pdf { background: #e11d48; color: white; }
        
        /* 主畫面 */
        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }
        .seat-display { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); border-radius: 12px; }
        .grid-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat { width: 70px; height: 50px; border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.02); cursor: pointer; position: relative; }
        .seat.disabled { opacity: 0.2; background: #450a0a; }
        .seat-num { position: absolute; top: 2px; left: 4px; font-size: 9px; color: var(--accent); }

        /* PDF 模板 (隱藏) */
        #pdf-template { display: none; width: 210mm; padding: 10mm; background: white; color: black; box-sizing: border-box; }
        .pdf-header { display: flex; justify-content: space-between; font-size: 10px; border-bottom: 1px solid #000; padding-bottom: 5px; }
        .pdf-title { text-align: center; font-size: 22px; font-weight: bold; margin: 15px 0; }
        .pdf-main { display: flex; gap: 10px; }
        .pdf-left { flex: 0 0 22%; } /* 20% 稍微加一點 buffer */
        .pdf-right { flex: 0 0 78%; display: flex; flex-direction: column; align-items: center; }
        
        table.pdf-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 15px; }
        table.pdf-table th { background: #f0f0f0; border: 1px solid #000; padding: 4px; text-align: center; }
        table.pdf-table td { border: 1px solid #000; padding: 4px; }

        .pdf-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 30px; }
        .pdf-seat { width: 60px; height: 48px; border: 1px solid black; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .desk-bottom { width: 200px; border: 2px solid black; text-align: center; padding: 5px; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="top-steps">
        <div class="step-group">
            <div><div class="step-title">STEP 1. 名單</div><input type="file" id="excel-input" style="width: 140px;"> <button onclick="generateExample()">下載範例</button></div>
            <div><div class="step-title">STEP 2. 配置</div><input type="number" id="cols" value="6" style="width:35px"> x <input type="number" id="rows" value="6" style="width:35px"> <button onclick="renderGrid()">重設</button></div>
            <div><div class="step-title">STEP 3. 分配</div><button onclick="executeRandom()">隨機排序</button></div>
        </div>
        <button class="btn-pdf" onclick="exportPDF()">匯出 A4 直向 PDF</button>
    </div>

    <div class="main-layout">
        <div class="seat-display">
            <div id="grid" class="grid-container"></div>
            <div style="border:1px solid var(--accent); padding:5px 40px; color:var(--accent)">講桌 (前方)</div>
        </div>
    </div>

    <div id="pdf-template">
        <div class="pdf-header"><div id="pdf-time"></div><div id="pdf-teacher"></div></div>
        <div class="pdf-title" id="pdf-main-title">班級座位表</div>
        <div class="pdf-main">
            <div class="pdf-left">
                <table class="pdf-table"><tr><th>班級幹部</th></tr><tbody id="pdf-officers"></tbody></table>
                <table class="pdf-table"><tr><th>小老師</th></tr><tbody id="pdf-teachers"></tbody></table>
                <table class="pdf-table"><tr><th>校級/公職</th></tr><tbody id="pdf-council"></tbody></table>
            </div>
            <div class="pdf-right">
                <div id="pdf-grid-container" class="pdf-grid"></div>
                <div class="desk-bottom">講 桌</div>
            </div>
        </div>
    </div>

    <script>
        let fullData = [];
        let assignedMap = new Map();

        function generateExample() {
            const data = [
                { "座號": 1, "姓名": "王小明", "班級": "101", "導師": "張大千", "職務1": "班長", "職務2": "國文小老師" },
                { "座號": 2, "姓名": "李小華", "班級": "101", "導師": "張大千", "職務1": "風紀股長", "職務2": "" }
            ];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "座位表範例.xlsx");
        }

        document.getElementById('excel-input').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                fullData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                alert(`已載入 ${fullData.length} 位學生`);
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = document.getElementById('rows').value, c = document.getElementById('cols').value;
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; assignedMap.clear();
            for (let i = 0; i < r; i++) {
                const row = document.createElement('div'); row.className = 'row-wrap';
                for (let j = 0; j < c; j++) {
                    const seat = document.createElement('div'); seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { if(!this.innerText) { this.classList.toggle('disabled'); this.dataset.active = !this.classList.contains('disabled'); recalculate(); } };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            recalculate();
        }

        function recalculate() {
            let num = 1;
            document.querySelectorAll('.seat').forEach(seat => {
                if(seat.dataset.active === "true") {
                    const s = assignedMap.get(num);
                    seat.innerHTML = `<span class="seat-num">${num}</span><b>${s ? s.姓名 : ''}</b>`;
                    num++;
                } else { seat.innerHTML = ""; }
            });
        }

        function executeRandom() {
            if(!fullData.length) return alert("請先匯入Excel");
            const activeSeats = document.querySelectorAll('.seat[data-active="true"]').length;
            if(fullData.length > activeSeats) return alert("位置不足");
            const shuffled = [...fullData].sort(() => Math.random() - 0.5);
            assignedMap.clear();
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            recalculate();
        }

        function exportPDF() {
            const first = fullData[0] || {};
            document.getElementById('pdf-time').innerText = `列印時間：${new Date().toLocaleString()}`;
            document.getElementById('pdf-teacher').innerText = `導師：${first.導師 || ''}`;
            document.getElementById('pdf-main-title').innerText = `${first.班級 || ''} 班級座位表`;

            // 分類邏輯
            const orderOff = ["班長", "副班長", "學藝股長", "風紀股長", "內衛生", "外衛生", "服務股長", "資訊股長"];
            const orderTea = ["國文小老師", "英文小老師", "數學小老師"];
            const councilKeys = ["秩序糾察", "交通糾察", "環評", "班聯會"];

            let resOff = [], resTea = [], resCou = [];
            
            fullData.forEach(s => {
                Object.values(s).forEach(val => {
                    if(!val || typeof val !== 'string') return;
                    if(councilKeys.some(k => val.includes(k))) resCou.push(`${val}：${s.姓名}`);
                    else if(val.includes("小老師")) resTea.push({title: val, name: s.姓名});
                    else if(orderOff.includes(val) || (!val.includes("小老師") && !councilKeys.some(k => val.includes(k)) && val.includes("股長"))) {
                        resOff.push({title: val, name: s.姓名});
                    }
                });
            });

            // 排序
            const sortFn = (list, order) => list.sort((a,b) => {
                let idxA = order.indexOf(a.title), idxB = order.indexOf(b.title);
                return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
            });

            const renderTable = (id, list) => {
                document.getElementById(id).innerHTML = list.map(item => `<tr><td>${item.title || item}：${item.name || ''}</td></tr>`).join('');
            };

            renderTable('pdf-officers', sortFn(resOff, orderOff));
            renderTable('pdf-teachers', sortFn(resTea, orderTea));
            document.getElementById('pdf-council').innerHTML = resCou.map(i => `<tr><td>${i}</td></tr>`).join('');

            // 繪製座位
            const container = document.getElementById('pdf-grid-container');
            container.innerHTML = '';
            let num = 1;
            document.querySelectorAll('.row-wrap').forEach(row => {
                const pdfRow = document.createElement('div'); pdfRow.style.display = "flex"; pdfRow.style.gap = "8px";
                row.querySelectorAll('.seat').forEach(seat => {
                    const s = assignedMap.get(num);
                    const pdfSeat = document.createElement('div'); pdfSeat.className = 'pdf-seat';
                    if(seat.dataset.active === "true") {
                        pdfSeat.innerHTML = `<span style="font-size:9px">${s?s.座號:num}</span><b style="font-size:14px">${s?s.姓名:''}</b>`;
                        num++;
                    } else { pdfSeat.style.border = "none"; }
                    pdfRow.appendChild(pdfSeat);
                });
                container.appendChild(pdfRow);
            });

            const element = document.getElementById('pdf-template');
            element.style.display = 'block';
            html2pdf().set({ margin: 0, filename: '座位表.pdf', jsPDF: { format: 'a4', orientation: 'portrait' }, html2canvas: { scale: 3 } }).from(element).save().then(()=>element.style.display='none');
        }
        renderGrid();
    </script>
</body>
</html>
