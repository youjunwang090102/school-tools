<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>班級座位管理系統 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --border: #334155; --danger: #ef4444; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 頂部控制列 */
        .toolbar { display: flex; gap: 15px; padding: 15px 20px; background: var(--card); border-bottom: 2px solid var(--accent); align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; color: var(--accent); font-weight: bold; }
        button { cursor: pointer; background: var(--accent); color: #000; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; }
        select, input { padding: 5px; border-radius: 4px; border: 1px solid var(--border); background: #0f172a; color: white; }

        .main-container { display: flex; flex: 1; overflow: hidden; }
        /* 側邊欄：三種模式的互動區 */
        #sidebar { width: 280px; background: rgba(0,0,0,0.3); border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; display: none; }
        
        /* 座位展示區 */
        .display-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* 座位網格邏輯：Flex 逆向排列 */
        #grid { display: flex; flex-direction: column-reverse; gap: 10px; }
        .row-wrap { display: flex; flex-direction: row; gap: 10px; }
        
        .seat { width: 85px; height: 60px; border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: 0.2s; }
        .seat:hover { border-color: var(--accent); box-shadow: 0 0 10px rgba(56,189,248,0.3); }
        .seat.disabled { background: var(--danger); opacity: 0.3; }
        .seat-num { position: absolute; top: 3px; left: 5px; font-size: 11px; color: var(--accent); }
        .student-name { font-size: 16px; font-weight: bold; }

        /* 資訊預覽框 */
        #info-box { position: absolute; background: rgba(0,0,0,0.9); border: 1px solid var(--accent); padding: 10px; border-radius: 5px; font-size: 12px; pointer-events: none; display: none; z-index: 1000; line-height: 1.5; }

        /* PDF 樣式 */
        #pdf-root { display: none; width: 210mm; padding: 10mm; background: white; color: black; }
        .pdf-grid { display: flex; flex-direction: column-reverse; gap: 10px; align-items: center; }
        .desk-bottom { width: 300px; border: 2px solid black; text-align: center; margin-top: 30px; padding: 10px; font-weight: bold; font-size: 20px; }
    </style>
</head>
<body>

<div class="toolbar">
    <div class="control-group">
        <label>1. 檔案載入</label>
        <input type="file" id="excel-file">
        <button onclick="downloadSample()">下載範例 Excel</button>
    </div>
    <div class="control-group">
        <label>2. 座位規模</label>
        <div>
            寬 <input type="number" id="cols" value="6" style="width:40px"> 
            高 <input type="number" id="rows" value="6" style="width:40px">
            <button onclick="createGrid()">設定網格</button>
        </div>
    </div>
    <div class="control-group">
        <label>3. 分配模式</label>
        <select id="mode-select" onchange="toggleModeUI()">
            <option value="random">一鍵隨機</option>
            <option value="draw">現場抽籤 (側邊欄操作)</option>
            <option value="manual">代號選位 (側邊欄操作)</option>
        </select>
    </div>
    <button id="main-action-btn" onclick="autoRandom()">開始自動分配</button>
    <button style="background: #e11d48; color: white;" onclick="exportPDF()">匯出 PDF 座位表</button>
</div>

<div class="main-container">
    <div id="sidebar"></div>
    <div class="display-area">
        <div id="grid"></div>
        <div style="margin-top: 20px; color: var(--accent); font-weight: bold; border: 1px solid; padding: 5px 60px;">講 桌 (前方)</div>
        <div id="info-box"></div>
    </div>
</div>

<div id="pdf-root">
    <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #000;" id="pdf-meta"></div>
    <h1 id="pdf-title" style="text-align:center;">座位表</h1>
    <div style="display: flex; gap: 20px;">
        <div id="pdf-tables" style="flex: 0 0 20%;"></div>
        <div style="flex: 0 0 80%; display: flex; flex-direction: column; align-items: center;">
            <div id="pdf-grid-box" class="pdf-grid"></div>
            <div class="desk-bottom">講 桌</div>
        </div>
    </div>
</div>

<script>
let students = [], assigned = new Map(), classInfo = { name: "", teacher: "" };
let currentDrawIdx = 0;

function downloadSample() {
    const data = [["班級","101","導師","林老師"],["座號","姓名","教育信箱","","職務1","職務2","職務3","職務4","職務5","職務6"]];
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "名單");
    XLSX.writeFile(wb, "班級名單範例.xlsx");
}

document.getElementById('excel-file').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function(ev) {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
        const sh = wb.Sheets[wb.SheetNames[0]];
        classInfo.name = sh['B1'] ? sh['B1'].v : "未命名班級";
        classInfo.teacher = sh['D1'] ? sh['D1'].v : "未填寫導師";
        students = XLSX.utils.sheet_to_json(sh, {range: 1});
        alert(`成功載入 ${students.length} 位學生資訊`);
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};

function createGrid() {
    const r = document.getElementById('rows').value, c = document.getElementById('cols').value;
    const g = document.getElementById('grid');
    g.innerHTML = ''; assigned.clear();
    for(let i=0; i<r; i++) {
        const row = document.createElement('div'); row.className = 'row-wrap';
        for(let j=0; j<c; j++) {
            const s = document.createElement('div'); s.className = 'seat';
            s.dataset.active = "true";
            s.onclick = function() {
                if(this.dataset.student) return;
                this.classList.toggle('disabled');
                this.dataset.active = !this.classList.contains('disabled');
                refreshGrid();
            };
            s.onmousemove = showInfo; s.onmouseleave = () => document.getElementById('info-box').style.display='none';
            row.appendChild(s);
        }
        g.appendChild(row);
    }
    refreshGrid();
}

function refreshGrid() {
    let seatNumber = 1;
    // 因為 flex-direction: column-reverse，DOM 的第一個 Row 會在最下面
    document.querySelectorAll('.row-wrap').forEach(row => {
        row.querySelectorAll('.seat').forEach(seat => {
            if(seat.dataset.active === "true") {
                const stu = assigned.get(seatNumber);
                seat.innerHTML = `<span class="seat-num">${seatNumber}</span><span class="student-name">${stu ? stu.姓名 : ''}</span>`;
                seat.dataset.seatId = seatNumber;
                if(stu) seat.dataset.student = JSON.stringify(stu);
                else delete seat.dataset.student;
                seatNumber++;
            } else { seat.innerHTML = ""; delete seat.dataset.student; delete seat.dataset.seatId; }
        });
    });
}

function toggleModeUI() {
    const mode = document.getElementById('mode-select').value;
    const side = document.getElementById('sidebar');
    const actBtn = document.getElementById('main-action-btn');
    side.style.display = (mode === 'random') ? 'none' : 'block';
    if(mode === 'random') { actBtn.style.display = 'block'; }
    else { actBtn.style.display = 'none'; updateSidebar(); }
}

function updateSidebar() {
    const mode = document.getElementById('mode-select').value;
    const side = document.getElementById('sidebar');
    if(mode === 'draw') {
        if(currentDrawIdx >= students.length) { side.innerHTML = "<h3>抽籤結束</h3>"; return; }
        const s = students[currentDrawIdx];
        side.innerHTML = `<h3>現場抽籤</h3><p>目前學生：<br><b style='font-size:24px; color:var(--accent)'>${s.姓名}</b></p><p>請輸入要坐的編號：</p>
            <input type="number" id="draw-val" style="width:60px"> <button onclick="confirmDraw()">確認</button>`;
    } else if(mode === 'manual') {
        side.innerHTML = `<h3>代號選位</h3>` + students.map(s => `
            <div style="margin-bottom:5px">${s.姓名}: <input type="number" onchange="manualBind(${s.座號}, this.value)" style="width:50px"></div>
        `).join('');
    }
}

function autoRandom() {
    const seats = document.querySelectorAll('.seat[data-active="true"]').length;
    if(students.length > seats) return alert("位置不足！");
    const shuf = [...students].sort(() => Math.random() - 0.5);
    assigned.clear();
    shuf.forEach((s, i) => assigned.set(i + 1, s));
    refreshGrid();
}

function confirmDraw() {
    const val = parseInt(document.getElementById('draw-val').value);
    if(!val || assigned.has(val) || !document.querySelector(`[data-seat-id="${val}"]`)) return alert("無效或已佔用");
    assigned.set(val, students[currentDrawIdx]);
    currentDrawIdx++;
    refreshGrid(); updateSidebar();
}

function manualBind(sid, snum) {
    const stu = students.find(x => x.座號 == sid);
    if(snum) assigned.set(parseInt(snum), stu);
    else assigned.delete(parseInt(snum));
    refreshGrid();
}

function showInfo(e) {
    if(!this.dataset.student) return;
    const stu = JSON.parse(this.dataset.student);
    const box = document.getElementById('info-box');
    box.style.display = 'block';
    box.style.left = (e.pageX + 15) + 'px';
    box.style.top = (e.pageY + 15) + 'px';
    box.innerHTML = `<b>${stu.姓名}</b> (${stu.座號})<br>職務：${stu.職務1 || ''} ${stu.職務2 || ''}<br>信箱：${stu.教育信箱 || '無'}`;
}

function exportPDF() {
    const root = document.getElementById('pdf-root');
    document.getElementById('pdf-meta').innerHTML = `<span>列印：${new Date().toLocaleDateString()}</span><span>導師：${classInfo.teacher}</span>`;
    document.getElementById('pdf-title').innerText = `${classInfo.name} 座位表`;
    
    // PDF 表格邏輯 (略縮)
    let tHtml = "<table border='1' style='width:100%; font-size:10px; border-collapse:collapse'><tr><th>幹部/職務</th></tr>";
    students.forEach(s => { if(s.職務1) tHtml += `<tr><td>${s.職務1}:${s.姓名}</td></tr>`; });
    document.getElementById('pdf-tables').innerHTML = tHtml + "</table>";

    const box = document.getElementById('pdf-grid-box'); box.innerHTML = '';
    document.querySelectorAll('.row-wrap').forEach(row => {
        const pRow = document.createElement('div'); pRow.style.display = 'flex'; pRow.style.gap = '8px';
        row.querySelectorAll('.seat').forEach(seat => {
            const ps = document.createElement('div');
            ps.style.cssText = "width:55px; height:45px; border:1px solid #000; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:11px";
            if(seat.dataset.active === "true") {
                const sid = seat.dataset.seatId;
                const stu = assigned.get(parseInt(sid));
                ps.innerHTML = `<span style="font-size:8px">${stu ? stu.座號 : sid}</span><b>${stu ? stu.姓名 : ''}</b>`;
            } else { ps.style.border = "none"; }
            pRow.appendChild(ps);
        });
        box.appendChild(pRow);
    });

    root.style.display = 'block';
    html2pdf().from(root).set({ margin: 0, filename: '座位表.pdf', jsPDF: { format: 'a4' } }).save().then(() => root.style.display = 'none');
}

createGrid();
</script>
</body>
</html>
