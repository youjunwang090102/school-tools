<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>äº’å‹•åº§ä½ç³»çµ± | 2026 è¡Œæ”¿åˆ—å° Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --green: #10b981; --gold: #fbbf24; --text: #f8fafc; --border: #334155;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* UI æ’ç‰ˆ */
        .top-steps { display: flex; gap: 15px; padding: 12px 20px; background: var(--card-bg); border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; }
        .step-group { display: flex; gap: 15px; align-items: center; }
        .step-title { font-size: 0.75rem; color: var(--accent); font-weight: bold; margin-bottom: 3px; }
        input, button { padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border); font-size: 0.85rem; }
        button { cursor: pointer; background: var(--accent); color: #000; border: none; font-weight: bold; }
        .btn-pdf { background: #ef4444; color: white; margin-left: 10px; }

        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }
        .seat-display { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.02); border-radius: 15px; border: 1px dashed var(--border); position: relative; }
        
        /* ç¶²é é è¦½åº§ä½ */
        .grid-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat { width: 70px; height: 50px; border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative; }
        .seat.disabled { opacity: 0.2; background: #450a0a; }
        .seat-num { position: absolute; top: 2px; left: 4px; font-size: 10px; color: var(--accent); }
        .student-name { font-weight: bold; font-size: 1rem; }

        /* PDF éš±è—å€åŸŸæ¨£å¼ */
        #pdf-template { display: none; width: 210mm; padding: 12mm; background: white; color: black; box-sizing: border-box; }
        .pdf-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; border-bottom: 1.5px solid black; padding-bottom: 3px; }
        .pdf-title { text-align: center; font-size: 26px; font-weight: bold; margin: 15px 0; letter-spacing: 2px; }
        .pdf-body { display: flex; gap: 15px; }
        .pdf-left { flex: 0 0 20%; }
        .pdf-right { flex: 0 0 80%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        
        table.pdf-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 12px; }
        table.pdf-table th { background: #eee; border: 1px solid black; padding: 4px; text-align: center; }
        table.pdf-table td { border: 1px solid black; padding: 4px; text-align: left; }

        .pdf-grid { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .pdf-seat { width: 65px; height: 50px; border: 1px solid black; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pdf-desk { width: 250px; border: 2px solid black; text-align: center; padding: 8px; font-weight: bold; margin-top: 40px; font-size: 16px; letter-spacing: 15px; }
    </style>
</head>
<body>

    <div class="top-steps">
        <div class="step-group">
            <div class="step-box">
                <div class="step-title">STEP 1. åŒ¯å…¥åå–®</div>
                <input type="file" id="excel-input" style="width: 150px;">
                <button onclick="downloadTemplate()">ä¸‹è¼‰ A1 è¦æ ¼ç¯„ä¾‹</button>
            </div>
            <div class="step-box">
                <div class="step-title">STEP 2. åº§ä½é…ç½®</div>
                å¯¬ <input type="number" id="cols" value="6" style="width: 35px;"> x 
                é«˜ <input type="number" id="rows" value="6" style="width: 35px;">
                <button onclick="renderGrid()">é‡ç½®ç¶²æ ¼</button>
            </div>
            <div class="step-box">
                <div class="step-title">STEP 3. è‡ªå‹•åˆ†é…</div>
                <button onclick="executeRandom()">ä¸€éµéš¨æ©Ÿæ’åº</button>
            </div>
        </div>
        <button class="btn-pdf" onclick="exportPDF()">ğŸ–¨ï¸ åŒ¯å‡º A4 ç›´å‘ PDF</button>
    </div>

    <div class="main-layout">
        <div class="seat-display">
            <div id="grid" class="grid-container"></div>
            <div style="color: var(--accent); font-weight: bold; border: 1px solid var(--accent); padding: 5px 50px; border-radius: 4px;">è¬›æ¡Œ (å‰æ–¹)</div>
        </div>
    </div>

    <div id="pdf-template">
        <div class="pdf-header">
            <div id="pdf-time"></div>
            <div id="pdf-teacher">å°å¸«ï¼š</div>
        </div>
        <div class="pdf-title" id="pdf-main-title">ç­ç´šåº§ä½è¡¨</div>
        <div class="pdf-body">
            <div class="pdf-left">
                <table class="pdf-table"><thead><tr><th>ç­ç´šå¹¹éƒ¨</th></tr></thead><tbody id="pdf-off-list"></tbody></table>
                <table class="pdf-table"><thead><tr><th>å°è€å¸«</th></tr></thead><tbody id="pdf-tea-list"></tbody></table>
                <table class="pdf-table"><thead><tr><th>æ ¡ç´š/å…¬è·</th></tr></thead><tbody id="pdf-cou-list"></tbody></table>
            </div>
            <div class="pdf-right">
                <div id="pdf-grid-box" class="pdf-grid"></div>
                <div class="pdf-desk">è¬›æ¡Œ</div>
            </div>
        </div>
    </div>

    <script>
        let classInfo = { name: "", teacher: "" };
        let studentData = [];
        let assignedMap = new Map();

        // 1. ä¸‹è¼‰ç¬¦åˆ A1 è¦æ ¼çš„ç¯„ä¾‹
        function downloadTemplate() {
            const wsData = [
                ["ç­ç´š", "101", "å°å¸«", "ç‹å¤§æ˜"], // A1, B1, C1, D1
                ["åº§è™Ÿ", "å§“å", "æ•™è‚²ä¿¡ç®±", "", "è·å‹™1", "è·å‹™2", "è·å‹™3", "è·å‹™4", "è·å‹™5", "è·å‹™6"] // A2-J2
            ];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åå–®");
            XLSX.writeFile(wb, "ç­ç´šåå–®ç¯„ä¾‹.xlsx");
        }

        // 2. è®€å– Excel (è™•ç† A1/B1 èˆ‡ A2 èµ·çš„åå–®)
        document.getElementById('excel-input').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // æŠ“å– B1 èˆ‡ D1
                classInfo.name = sheet['B1'] ? sheet['B1'].v : "æœªå‘½å";
                classInfo.teacher = sheet['D1'] ? sheet['D1'].v : "æœªå¡«å¯«";

                // å¾ç¬¬äºŒåˆ—é–‹å§‹è½‰ JSON (åå–®)
                studentData = XLSX.utils.sheet_to_json(sheet, {range: 1});
                alert(`âœ… æˆåŠŸè®€å–ï¼š${classInfo.name}ç­ï¼Œå…± ${studentData.length} ä½å­¸ç”Ÿ`);
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = document.getElementById('rows').value, c = document.getElementById('cols').value;
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; assignedMap.clear();
            for (let i = 0; i < r; i++) {
                const row = document.createElement('div'); row.className = 'row-wrap';
                for (let j = 0; j < c; j++) {
                    const seat = document.createElement('div'); seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { 
                        if(this.innerText.length > 5) return;
                        this.classList.toggle('disabled'); 
                        this.dataset.active = !this.classList.contains('disabled');
                        recalculate();
                    };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            recalculate();
        }

        function recalculate() {
            let num = 1;
            document.querySelectorAll('.seat').forEach(seat => {
                if(seat.dataset.active === "true") {
                    const s = assignedMap.get(num);
                    seat.innerHTML = `<span class="seat-num">${num}</span><span class="student-name">${s ? s.å§“å : ''}</span>`;
                    num++;
                } else { seat.innerHTML = ""; }
            });
        }

        function executeRandom() {
            const activeCount = document.querySelectorAll('.seat[data-active="true"]').length;
            if(studentData.length > activeCount) return alert("åº§ä½æ•¸é‡ä¸è¶³ä»¥å®¹ç´æ‰€æœ‰å­¸ç”Ÿï¼");
            const shuffled = [...studentData].sort(() => Math.random() - 0.5);
            assignedMap.clear();
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            recalculate();
        }

        // 3. PDF é‚è¼¯
        function exportPDF() {
            if(!studentData.length) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
            
            document.getElementById('pdf-time').innerText = `åˆ—å°æ™‚é–“ï¼š${new Date().toLocaleString()}`;
            document.getElementById('pdf-teacher').innerText = `å°å¸«ï¼š${classInfo.teacher}`;
            document.getElementById('pdf-main-title').innerText = `${classInfo.name} ç­ç´šåº§ä½è¡¨`;

            const offOrder = ["ç­é•·", "å‰¯ç­é•·", "å­¸è—è‚¡é•·", "é¢¨ç´€è‚¡é•·", "å…§è¡›ç”Ÿ", "å¤–è¡›ç”Ÿ", "æœå‹™è‚¡é•·", "è³‡è¨Šè‚¡é•·"];
            const teaOrder = ["åœ‹æ–‡å°è€å¸«", "è‹±æ–‡å°è€å¸«", "æ•¸å­¸å°è€å¸«"];
            const couKeywords = ["ç§©åºç³¾å¯Ÿ", "äº¤é€šç³¾å¯Ÿ", "ç’°è©•", "ç­è¯æœƒ"];

            let offArr = [], teaArr = [], couArr = [];

            studentData.forEach(s => {
                // æª¢æŸ¥è·å‹™ 1-6 (EFGHIJ æ¬„ä½)
                for(let i=1; i<=6; i++) {
                    const job = s[`è·å‹™${i}`];
                    if(!job) continue;

                    if(couKeywords.some(k => job.includes(k))) {
                        couArr.push(`${job}ï¼š${s.å§“å}`);
                    } else if(job.includes("å°è€å¸«")) {
                        teaArr.push({title: job, name: s.å§“å});
                    } else {
                        offArr.push({title: job, name: s.å§“å});
                    }
                }
            });

            // æ’åºä¸¦æ¸²æŸ“è¡¨æ ¼
            const sortList = (list, order) => list.sort((a,b) => {
                let ia = order.indexOf(a.title), ib = order.indexOf(b.title);
                return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
            });

            const toTr = (list) => list.map(item => `<tr><td>${item.title || item}${item.name ? 'ï¼š'+item.name : ''}</td></tr>`).join('');
            
            document.getElementById('pdf-off-list').innerHTML = toTr(sortList(offArr, offOrder));
            document.getElementById('pdf-tea-list').innerHTML = toTr(sortList(teaArr, teaOrder));
            document.getElementById('pdf-cou-list').innerHTML = toTr(couArr);

            // åº§ä½ç¶²æ ¼ (80%)
            const gridBox = document.getElementById('pdf-grid-box');
            gridBox.innerHTML = '';
            let num = 1;
            document.querySelectorAll('.row-wrap').forEach(row => {
                const pdfRow = document.createElement('div');
                pdfRow.style.display = "flex"; pdfRow.style.gap = "8px";
                row.querySelectorAll('.seat').forEach(seat => {
                    const s = assignedMap.get(num);
                    const pdfSeat = document.createElement('div');
                    pdfSeat.className = 'pdf-seat';
                    if(seat.dataset.active === "true") {
                        pdfSeat.innerHTML = `<span style="font-size:9px">${s ? s.åº§è™Ÿ : num}</span><b style="font-size:14px">${s ? s.å§“å : ''}</b>`;
                        num++;
                    } else { pdfSeat.style.border = "none"; }
                    pdfRow.appendChild(pdfSeat);
                });
                gridBox.appendChild(pdfRow);
            });

            // åŸ·è¡ŒåŒ¯å‡º
            const element = document.getElementById('pdf-template');
            element.style.display = 'block';
            html2pdf().set({
                margin: 0,
                filename: `${classInfo.name}_åº§ä½è¡¨.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save().then(() => element.style.display = 'none');
        }

        renderGrid();
    </script>
</body>
</html>
