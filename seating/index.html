<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­äº’å‹•åº§ä½ç³»çµ± | å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --green: #10b981; --gold: #fbbf24; --red: #ef4444;
            --text: #f1f5f9; --border: #334155;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* é ‚éƒ¨å°èˆªæ¬„ */
        header {
            background: var(--card-bg); border-bottom: 2px solid var(--accent);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); z-index: 10;
        }
        .step-group { display: flex; gap: 15px; align-items: flex-end; }
        .config-item { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 0.7rem; color: var(--accent); font-weight: bold; text-transform: uppercase; }

        input, select, button { 
            padding: 6px 10px; font-size: 0.85rem; border-radius: 6px;
            background: #0f172a; border: 1px solid var(--border); color: white;
        }
        button { 
            cursor: pointer; font-weight: 600; transition: all 0.2s; 
            background: var(--accent); color: #000; border: none;
        }
        button:hover { transform: translateY(-1px); filter: brightness(1.2); }
        .btn-pdf { background: var(--red); color: white; }
        .btn-mail { background: var(--gold); color: #000; }

        /* ä¸»å€åŸŸä½ˆå±€ */
        main { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }
        
        #sidebar { 
            width: 300px; background: var(--card-bg); border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column;
            border: 1px solid var(--border); box-shadow: 8px 8px 20px rgba(0,0,0,0.2);
        }

        /* åº§ä½å±•ç¤ºå€ */
        #capture-area { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            overflow: auto; background: #111827; border-radius: 12px; padding: 40px 20px;
            border: 1px dashed var(--border);
        }

        .grid-container { display: flex; flex-direction: column-reverse; gap: 15px; margin-bottom: 40px; }
        .row-wrap { display: flex; gap: 15px; }
        
        .seat {
            width: 90px; height: 65px; border: 2px solid var(--border); border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: rgba(255,255,255,0.03);
            transition: all 0.3s;
        }
        .seat:hover { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); }
        .seat.disabled { background: rgba(239, 68, 68, 0.1); border-style: dotted; opacity: 0.4; }
        .seat.occupied { background: linear-gradient(145deg, #2d3748, #1a202c); border-color: var(--green); }
        
        .seat-num { position: absolute; top: 4px; left: 6px; font-size: 11px; color: var(--accent); font-weight: bold; }
        .student-name { font-size: 1.1rem; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* æ‡¸æµ®é è¦½ */
        .seat-tooltip {
            visibility: hidden; position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%);
            background: #fff; color: #333; padding: 8px; border-radius: 4px; font-size: 0.75rem;
            white-space: nowrap; z-index: 100; box-shadow: 0 10px 15px rgba(0,0,0,0.5);
        }
        .seat.occupied:hover .seat-tooltip { visibility: visible; }

        .teacher-desk { 
            width: 350px; height: 50px; border: 3px solid var(--accent); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.4rem; letter-spacing: 20px; color: var(--accent); font-weight: 800;
            background: rgba(56, 189, 248, 0.05); border-radius: 8px;
        }

        .scroll-area { overflow-y: auto; flex: 1; margin-top: 15px; }
        .draw-card { background: #0f172a; border: 2px solid var(--gold); padding: 20px; border-radius: 10px; text-align: center; }
        .next-student { font-size: 2.2rem; color: var(--gold); margin: 15px 0; font-weight: 900; }
    </style>
</head>
<body>

    <header>
        <div class="step-group">
            <div class="config-item">
                <label>1. å­¸ç”Ÿåå–®</label>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="excel-input" style="width:130px;">
                    <button onclick="generateTemplate()" style="background:none; color:var(--accent); text-decoration:underline;">ç¯„ä¾‹</button>
                </div>
            </div>
            <div class="config-item">
                <label>2. æ•™å®¤è¦æ¨¡</label>
                <div>
                    å¯¬ <input type="number" id="cols" value="6" style="width:35px;"> 
                    é«˜ <input type="number" id="rows" value="6" style="width:35px;">
                    <button onclick="renderGrid()">é‡è¨­</button>
                </div>
            </div>
            <div class="config-item">
                <label>3. åˆ†é…æ¨¡å¼</label>
                <select id="mode-select" onchange="switchMode()">
                    <option value="random">éš¨æ©Ÿåˆ†é…</option>
                    <option value="draw">æŒ‰åº§è™ŸæŠ½ç±¤æ¨¡å¼</option>
                    <option value="manual">æ‰‹å‹•ä»£è™Ÿè¼¸å…¥</option>
                </select>
            </div>
            <button id="main-action-btn" onclick="executeRandom()" style="background:var(--green); color:black;">ç«‹å³éš¨æ©Ÿåˆ†é…</button>
        </div>
        <div class="step-group">
            <button class="btn-pdf" onclick="exportPDF()">åŒ¯å‡º A4 PDF</button>
            <button class="btn-mail" onclick="generateEmailNotification()">ç™¼é€é€šçŸ¥</button>
        </div>
    </header>

    <main>
        <div id="sidebar">
            <div id="sidebar-header"><h3>æ“ä½œé¢æ¿</h3></div>
            <div id="sidebar-content" class="scroll-area">
                <p style="color:#64748b; font-size:0.9rem;">è«‹å…ˆåŒ¯å…¥åå–®ä¸¦é¸æ“‡åˆ†é…æ¨¡å¼ã€‚</p>
            </div>
        </div>

        <div id="capture-area">
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk">è¬›æ¡Œ</div>
            </div>
    </main>

    <script>
        let fullData = [];
        let assignedMap = new Map(); 
        let drawQueue = [];
        let currentDrawIndex = 0;

        // --- åŒ¯å…¥ç¯„ä¾‹ ---
        function generateTemplate() {
            const ws = XLSX.utils.json_to_sheet([{"åº§è™Ÿ":1,"å§“å":"å¼µåŒå­¸","å­¸è™Ÿ":"101","æ•™è‚²ä¿¡ç®±":"s101@school.edu.tw"}]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åå–®");
            XLSX.writeFile(wb, "åº§ä½è¡¨ç¯„ä¾‹åå–®.xlsx");
        }

        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
                fullData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                // ç¢ºä¿åº§è™Ÿæ˜¯æ•¸å­—æ’åº
                fullData.sort((a,b) => (a.åº§è™Ÿ || 0) - (b.åº§è™Ÿ || 0));
                alert(`âœ… å·²è¼‰å…¥ ${fullData.length} ä½å­¸ç”Ÿ`);
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        // --- ç¶²æ ¼æ¸²æŸ“ ---
        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value), c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; assignedMap.clear();
            for (let i = 1; i <= r; i++) {
                const row = document.createElement('div'); row.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div'); seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { seatClick(this); };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            recalculate();
        }

        function seatClick(el) {
            const mode = document.getElementById('mode-select').value;
            if(mode === 'draw') {
                if(el.classList.contains('disabled') || el.dataset.hasStudent === "true") return;
                if(currentDrawIndex >= drawQueue.length) return alert("å…¨éƒ¨åŒå­¸å·²å…¥åº§ï¼");
                
                const seatID = parseInt(el.querySelector('.seat-num').innerText);
                assignedMap.set(seatID, drawQueue[currentDrawIndex]);
                currentDrawIndex++;
                recalculate();
                updateDrawSidebar();
            } else if(mode === 'manual') {
                // æ‰‹å‹•æ¨¡å¼é»æ“Šä¸é€²è¡ŒåŠŸèƒ½ï¼Œç”±å´é‚Šæ¬„è¼¸å…¥
            } else {
                if(el.dataset.hasStudent === "true") return;
                el.classList.toggle('disabled'); 
                el.dataset.active = !el.classList.contains('disabled');
                recalculate();
            }
        }

        function recalculate() {
            const rows = document.querySelectorAll('.row-wrap');
            let num = 1;
            rows.forEach(row => {
                row.querySelectorAll('.seat').forEach(seat => {
                    if (seat.dataset.active === "true") {
                        const student = assignedMap.get(num);
                        seat.dataset.hasStudent = student ? "true" : "false";
                        seat.className = student ? "seat occupied" : "seat";
                        
                        // æ‡¸æµ®è³‡è¨Šæ–‡å­—
                        const tooltip = student ? `<div class="seat-tooltip">å­¸è™Ÿ: ${student.å­¸è™Ÿ || 'ç„¡'}<br>ä¿¡ç®±: ${student.æ•™è‚²ä¿¡ç®± || 'ç„¡'}</div>` : "";
                        
                        seat.innerHTML = `
                            <span class="seat-num">${num}</span>
                            <span class="student-name" style="color:#fff !important">${student ? student.å§“å : ''}</span>
                            ${tooltip}
                        `;
                        num++;
                    } else {
                        seat.className = "seat disabled";
                        seat.innerHTML = "";
                    }
                });
            });
            if(document.getElementById('mode-select').value === 'manual') updateManualSidebar();
        }

        // --- æ¨¡å¼åˆ‡æ› ---
        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            const btn = document.getElementById('main-action-btn');
            btn.style.display = (mode === 'random') ? 'block' : 'none';
            
            if(mode === 'draw') {
                if(fullData.length === 0) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
                // ä¾åº§è™Ÿæ’åºæŠ½ç±¤
                drawQueue = [...fullData].sort((a,b) => a.åº§è™Ÿ - b.åº§è™Ÿ);
                currentDrawIndex = 0;
                assignedMap.clear();
                recalculate();
                updateDrawSidebar();
            } else if(mode === 'manual') {
                updateManualSidebar();
            } else {
                document.getElementById('sidebar-content').innerHTML = '<p>éš¨æ©Ÿåˆ†é…æ¨¡å¼ï¼šé»æ“Šåº§ä½å¯è¨­ç‚ºéšœç¤™ç‰©ã€‚</p>';
            }
        }

        function updateDrawSidebar() {
            const content = document.getElementById('sidebar-content');
            if(currentDrawIndex < drawQueue.length) {
                content.innerHTML = `
                    <div class="draw-card">
                        <div style="color:var(--accent)">ä¾åº§è™Ÿåºè«‹ä¸Šå°ï¼š</div>
                        <div class="next-student">${drawQueue[currentDrawIndex].åº§è™Ÿ} è™Ÿ<br>${drawQueue[currentDrawIndex].å§“å}</div>
                        <p style="font-size:0.8rem">è«‹é»æ“Šä¸€å€‹ç©ºçš„åº§ä½å…¥åº§</p>
                    </div>
                    <div style="margin-top:20px">å·²å…¥åº§ï¼š${currentDrawIndex} / ${drawQueue.length}</div>
                `;
            } else {
                content.innerHTML = `<div class="draw-card" style="border-color:var(--green)">ğŸ‰ å…¨éƒ¨å­¸ç”Ÿåˆ†é…å®Œç•¢ï¼</div>`;
            }
        }

        function updateManualSidebar() {
            const content = document.getElementById('sidebar-content');
            let html = `<h4>ä»£è™Ÿæ‰‹å‹•åˆ†é…</h4><p style="font-size:0.7rem">è«‹è¼¸å…¥åº§ä½å°æ‡‰çš„å­¸ç”Ÿåº§è™Ÿï¼š</p>`;
            const seatCount = document.querySelectorAll('.seat:not(.disabled)').length;
            for(let i=1; i<=seatCount; i++) {
                const s = assignedMap.get(i);
                html += `
                    <div style="display:flex; align-items:center; margin-bottom:5px; gap:5px;">
                        <span style="width:50px">åº§ä½ ${i}:</span>
                        <input type="number" value="${s?s.åº§è™Ÿ:''}" onchange="manualAssign(${i}, this.value)" style="width:60px">
                        <span style="font-size:0.75rem">${s?s.å§“å:''}</span>
                    </div>
                `;
            }
            content.innerHTML = html;
        }

        function manualAssign(seatIdx, studentNo) {
            const student = fullData.find(s => s.åº§è™Ÿ == studentNo);
            if(student) assignedMap.set(seatIdx, student);
            else assignedMap.delete(seatIdx);
            recalculate();
        }

        function executeRandom() {
            if(fullData.length === 0) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
            const shuffled = [...fullData].sort(() => Math.random() - 0.5);
            assignedMap.clear();
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            recalculate();
        }

        // --- åŒ¯å‡º PDF ---
        function exportPDF() {
            const element = document.getElementById('capture-area');
            
            // è™•ç†æ™‚é–“æ¨™ç±¤
            let timeTag = document.getElementById('pdf-time-tag');
            if (!timeTag) {
                timeTag = document.createElement('div');
                timeTag.id = 'pdf-time-tag';
                timeTag.style.cssText = "font-size: 12px; color: #000; margin-top: 30px; text-align: center; width: 100%;";
                element.appendChild(timeTag);
            }
            const now = new Date();
            timeTag.innerText = `åˆ—å°æ™‚é–“ï¼š${now.toLocaleString()}`;

            // ä¿®æ­£ï¼šé‡å° PDF ç”Ÿæˆæ™‚ï¼Œå¼·åˆ¶è®“èƒŒæ™¯èˆ‡æ–‡å­—é¡¯è‰²
            const opt = {
                margin: 20,
                filename: 'æ•™å®¤åº§ä½è¡¨.pdf',
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: { 
                    scale: 3, 
                    useCORS: true,
                    backgroundColor: '#ffffff' // PDF èƒŒæ™¯è¨­ç‚ºç™½è‰²ä»¥åˆ©åˆ—å°
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // æš«æ™‚å°‡æ–‡å­—é¡è‰²è½‰ç‚ºé»‘è‰²ä»¥ä¾¿åˆ—å°æ¸…æ¥š
            const names = element.querySelectorAll('.student-name');
            const nums = element.querySelectorAll('.seat-num');
            names.forEach(n => n.style.color = '#000');
            nums.forEach(n => n.style.color = '#333');
            element.style.color = '#000';

            html2pdf().set(opt).from(element).save().then(() => {
                // æ¢å¾©ç¶²é é¡¯ç¤ºé¡è‰²
                names.forEach(n => n.style.color = '#fff');
                nums.forEach(n => n.style.color = 'var(--accent)');
                element.style.color = 'var(--text)';
            });
        }

        function generateEmailNotification() {
            if (assignedMap.size === 0) return alert("å°šæœªåˆ†é…åº§ä½");
            let results = [];
            document.querySelectorAll('.row-wrap').forEach((row, rI) => {
                row.querySelectorAll('.seat').forEach((seat, cI) => {
                    if (seat.dataset.hasStudent === "true") {
                        const sNum = parseInt(seat.querySelector('.seat-num').innerText);
                        const s = assignedMap.get(sNum);
                        results.push({ no: parseInt(s.åº§è™Ÿ), name: s.å§“å, email: s.æ•™è‚²ä¿¡ç®±, pos: `ç¬¬ ${rI+1} æ©«æ’ / ç”±èµ°å»Šèµ·ç®—ç¬¬ ${cI+1} ä½` });
                    }
                });
            });
            results.sort((a,b) => a.no - b.no);
            let listStr = results.map(r => `åº§è™Ÿ ${r.no} ${r.name}ï¼š${r.pos}`).join('\n');
            const mailto = `mailto:${results.map(r=>r.email).join(',')}?subject=åº§ä½å…¬å‘Š&body=${encodeURIComponent(listStr)}`;
            window.open(mailto);
        }

        renderGrid();
    </script>
</body>
</html>
