<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧教室管理系統 | 整合版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #f1f5f9; --card-bg: #ffffff; --accent: #2563eb;
            --dark: #1e293b; --border: #e2e8f0; --text: #334155;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* 頂部導航 */
        header {
            background: var(--dark); color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100;
        }
        .controls { display: flex; gap: 15px; align-items: center; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 10px; color: #94a3b8; margin-bottom: 2px; }

        input, select, button { 
            padding: 5px 10px; border-radius: 4px; border: 1px solid #475569;
            background: #334155; color: white; font-size: 13px;
        }
        button { cursor: pointer; background: var(--accent); border: none; font-weight: bold; }
        button:hover { filter: brightness(1.2); }
        .btn-pdf { background: #64748b; }
        .btn-mail { background: #ca8a04; }

        /* 主區域 */
        main { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }
        
        #sidebar { 
            width: 320px; background: white; border-radius: 8px;
            padding: 15px; display: flex; flex-direction: column;
            border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        /* 座位展示區 - 預設白底黑字供 PDF 匯出 */
        #capture-area { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            overflow: auto; background: white; border-radius: 8px; padding: 40px;
            border: 1px solid var(--border);
        }

        .grid-container { display: flex; flex-direction: column-reverse; gap: 15px; margin-bottom: 40px; }
        .row-wrap { display: flex; gap: 15px; }
        
        .seat {
            width: 80px; height: 60px; border: 1px solid #cbd5e1; border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: #fff; color: #000;
        }
        .seat.disabled { background: #f8fafc; border-style: dashed; color: #cbd5e1; }
        .seat.occupied { border: 2px solid var(--accent); background: #f0f7ff; }
        
        .seat-num { position: absolute; top: 2px; left: 4px; font-size: 9px; color: #94a3b8; }
        .student-name { font-size: 1rem; font-weight: bold; }

        /* 懸浮預覽 */
        .seat-tooltip {
            visibility: hidden; position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95); color: #fff; padding: 8px; border-radius: 4px; 
            font-size: 12px; white-space: nowrap; z-index: 200; pointer-events: none;
        }
        .seat.occupied:hover .seat-tooltip { visibility: visible; }

        .teacher-desk { 
            width: 280px; height: 40px; border: 2px solid #94a3b8; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.1rem; letter-spacing: 10px; color: #64748b; font-weight: bold;
            background: #f8fafc; border-radius: 4px;
        }

        /* 側邊欄列表樣式 */
        .scroll-area { overflow-y: auto; flex: 1; margin-top: 10px; }
        .draw-status { background: #f8fafc; border: 2px solid var(--accent); padding: 15px; border-radius: 8px; text-align: center; }
        .manual-row { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 6px; border-bottom: 1px solid #f1f5f9; font-size: 13px;
        }
        .manual-row select { background: white; color: black; border: 1px solid #ccc; padding: 2px; }
    </style>
</head>
<body>

    <header>
        <div class="controls">
            <div class="control-group">
                <label>1. 上傳名單</label>
                <input type="file" id="excel-input" style="width:140px;">
            </div>
            <div class="control-group">
                <label>2. 教室佈局</label>
                <div>
                    寬 <input type="number" id="cols" value="6" style="width:35px;"> 
                    高 <input type="number" id="rows" value="6" style="width:35px;">
                    <button onclick="renderGrid()">重置</button>
                </div>
            </div>
            <div class="control-group">
                <label>3. 分配模式</label>
                <select id="mode-select" onchange="switchMode()">
                    <option value="random">點擊設置障礙/隨機</option>
                    <option value="draw">依序抽位模式</option>
                    <option value="manual">代號下拉選位</option>
                </select>
            </div>
            <button id="btn-random-all" onclick="randomAll()" style="margin-left:10px;">一鍵全隨機</button>
        </div>
        <div class="controls">
            <button class="btn-mail" onclick="sendEmails()">發送郵件通知</button>
            <button class="btn-pdf" onclick="exportPDF()">匯出 PDF</button>
        </div>
    </header>

    <main>
        <div id="sidebar">
            <h3 id="sidebar-title" style="margin:0 0 10px 0; font-size: 16px;">操作面板</h3>
            <div id="sidebar-content" class="scroll-area">
                請先匯入 Excel (包含：座號、姓名、教育信箱、幹部)。
            </div>
        </div>

        <div id="capture-area">
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk">講桌</div>
        </div>
    </main>

    <script>
        let students = [];
        let assignedMap = new Map(); // Key: 座位代號, Value: 學生物件
        let currentDrawIndex = 0;

        // --- 檔案處理 ---
        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                students = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                students.sort((a,b) => (a.座號 || 0) - (b.座號 || 0));
                alert(`成功載入 ${students.length} 名學生`);
                switchMode();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        // --- 格子渲染 ---
        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value);
            const c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; 
            assignedMap.clear();

            for (let i = 1; i <= r; i++) {
                const row = document.createElement('div');
                row.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { handleSeatClick(this); };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            refreshSeats();
        }

        function handleSeatClick(el) {
            const mode = document.getElementById('mode-select').value;
            if(mode === 'random') {
                if(el.classList.contains('occupied')) return;
                el.classList.toggle('disabled');
                el.dataset.active = !el.classList.contains('disabled');
                refreshSeats();
            }
        }

        function refreshSeats() {
            const seats = document.querySelectorAll('.row-wrap .seat');
            let seatCounter = 1;
            seats.forEach(seat => {
                if (seat.dataset.active === "true") {
                    const student = assignedMap.get(seatCounter);
                    seat.className = student ? "seat occupied" : "seat";
                    seat.innerHTML = `
                        <span class="seat-num">${seatCounter}</span>
                        <span class="student-name">${student ? student.姓名 : ''}</span>
                        ${student ? `
                            <div class="seat-tooltip">
                                <b>${student.姓名}</b> (${student.座號}號)<br>
                                幹部：${student.幹部 || '無'}<br>
                                學號：${student.學號 || '未提供'}
                            </div>
                        ` : ''}
                    `;
                    seatCounter++;
                } else {
                    seat.className = "seat disabled";
                    seat.innerHTML = "";
                }
            });
            if(document.getElementById('mode-select').value === 'manual') updateManualSidebar();
        }

        // --- 模式控制 ---
        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            currentDrawIndex = 0;
            document.getElementById('btn-random-all').style.display = (mode === 'random') ? 'block' : 'none';
            
            if(mode === 'draw') updateDrawSidebar();
            else if(mode === 'manual') updateManualSidebar();
            else document.getElementById('sidebar-content').innerHTML = "點擊座位可開啟/關閉該位置。";
        }

        // --- 功能 1: 依序抽位 ---
        function updateDrawSidebar() {
            const content = document.getElementById('sidebar-content');
            if(students.length === 0) return content.innerHTML = "請先上傳名單";
            
            if(currentDrawIndex < students.length) {
                const s = students[currentDrawIndex];
                content.innerHTML = `
                    <div class="draw-status">
                        <p>目前邀請：</p>
                        <h2 style="color:var(--accent); margin:10px 0;">${s.座號} 號 ${s.姓名}</h2>
                        <button onclick="randomPickOne()" style="width:100%; padding:10px;">隨機選一個空位</button>
                    </div>
                    <p style="font-size:12px; margin-top:10px;">進度：${currentDrawIndex} / ${students.length}</p>
                `;
            } else {
                content.innerHTML = "<h3>✅ 全體學生抽籤完成</h3>";
            }
        }

        function randomPickOne() {
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            const available = [];
            for(let i=1; i<=totalActive; i++) { if(!assignedMap.has(i)) available.push(i); }
            
            if(available.length === 0) return alert("沒有空位了！");
            const target = available[Math.floor(Math.random() * available.length)];
            assignedMap.set(target, students[currentDrawIndex]);
            currentDrawIndex++;
            refreshSeats();
            updateDrawSidebar();
        }

        // --- 功能 2: 代號下拉選位 ---
        function updateManualSidebar() {
            const content = document.getElementById('sidebar-content');
            if(students.length === 0) return;
            
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            let html = `<p style="font-size:12px; color:gray;">請為學生選擇座位代號：</p>`;
            
            students.forEach(s => {
                const currentSeat = [...assignedMap.entries()].find(([k,v]) => v.座號 === s.座號)?.[0] || "";
                html += `
                    <div class="manual-row">
                        <span>${s.座號}. ${s.姓名}</span>
                        <select onchange="manualAssign('${s.座號}', this.value)">
                            <option value="">未選</option>
                            ${Array.from({length: totalActive}, (_, i) => i + 1).map(n => `
                                <option value="${n}" ${currentSeat == n ? 'selected' : ''}>代號 ${n}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });
            content.innerHTML = html;
        }

        function manualAssign(studentNo, seatId) {
            const student = students.find(s => s.座號 == studentNo);
            // 清除該生舊位置
            for (let [k, v] of assignedMap.entries()) { if (v.座號 == studentNo) assignedMap.delete(k); }
            // 分配新位置
            if(seatId) assignedMap.set(parseInt(seatId), student);
            refreshSeats();
        }

        // --- 功能 3: 隨機 ---
        function randomAll() {
            if(!students.length) return alert("請先匯入名單");
            const totalActive = document.querySelectorAll('.seat:not(.disabled)').length;
            if(students.length > totalActive) return alert("位置不夠！");
            
            assignedMap.clear();
            const shuffled = [...students].sort(() => Math.random() - 0.5);
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            refreshSeats();
        }

        // --- 功能 4: PDF 匯出 ---
        function exportPDF() {
            const element = document.getElementById('capture-area');
            const opt = {
                margin: 10,
                filename: '教室座位表.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#ffffff' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // --- 功能 5: 郵件發送 ---
        function sendEmails() {
            if(!assignedMap.size) return alert("尚未分配座位");
            
            const list = [];
            const emails = [];
            assignedMap.forEach((student, seatId) => {
                list.push(`座號 ${student.座號} ${student.姓名}：座位代號 ${seatId}`);
                if(student.教育信箱) emails.push(student.教育信箱);
            });

            const body = encodeURIComponent("各位同學好，座位分配結果如下：\n\n" + list.join('\n'));
            const mailto = `mailto:${emails.join(',')}?subject=${encodeURIComponent('座位分配公告')}&body=${body}`;
            window.open(mailto);
        }

        renderGrid();
    </script>
</body>
</html>
