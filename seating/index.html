<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>互動座位系統 - 2026 行政列印版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --green: #10b981; --gold: #fbbf24; --text: #f8fafc; --border: #334155;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 介面排版 */
        .top-steps { display: flex; gap: 15px; padding: 12px 20px; background: var(--card-bg); border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; }
        .step-group { display: flex; gap: 15px; }
        .step-box { border-right: 1px solid var(--border); padding-right: 15px; }
        .step-title { font-size: 0.7rem; color: var(--accent); margin-bottom: 5px; font-weight: bold; }
        
        button { cursor: pointer; padding: 5px 12px; border-radius: 4px; border: none; font-weight: 600; transition: 0.2s; background: var(--accent); color: #000; }
        button:hover { filter: brightness(1.2); }
        .btn-pdf { background: #e11d48; color: white; }

        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }
        .control-sidebar { flex: 0 0 30%; background: rgba(255,255,255,0.03); border-radius: 10px; padding: 15px; display: none; flex-direction: column; border: 1px solid var(--border); }
        .seat-display { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: auto; background: var(--bg); }

        /* 座位網格 (網頁預覽) */
        .grid-container { display: flex; flex-direction: column-reverse; gap: 8px; margin-bottom: 20px; }
        .row-wrap { display: flex; gap: 8px; }
        .seat { width: 70px; height: 50px; border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: rgba(255,255,255,0.02); cursor: pointer; }
        .seat.disabled { opacity: 0.3; background: #450a0a; }
        .seat-num { position: absolute; top: 2px; left: 4px; font-size: 9px; color: var(--accent); }
        .student-name { font-size: 0.9rem; font-weight: bold; }

        /* PDF 匯出專用樣式 (隱藏於網頁) */
        #pdf-template {
            display: none; width: 210mm; padding: 15mm; background: white; color: black; box-sizing: border-box;
        }
        .pdf-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .pdf-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px; }
        .pdf-content { display: flex; gap: 20px; }
        .pdf-left { flex: 0 0 30%; border-right: 1px solid #ccc; padding-right: 15px; }
        .pdf-right { flex: 0 0 70%; display: flex; flex-direction: column; align-items: center; }
        .pdf-section-title { font-weight: bold; border-left: 4px solid black; padding-left: 8px; margin: 15px 0 5px 0; background: #eee; }
        .pdf-list { font-size: 12px; line-height: 1.6; list-style: none; padding: 0; margin: 0; }
        
        .pdf-grid { display: flex; flex-direction: column-reverse; gap: 10px; }
        .pdf-seat { width: 55px; height: 45px; border: 1px solid black; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; }
        .pdf-seat-num { font-size: 10px; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div class="top-steps">
        <div class="step-group">
            <div class="step-box">
                <div class="step-title">STEP 1. 名單</div>
                <input type="file" id="excel-input" style="width: 130px;">
            </div>
            <div class="step-box">
                <div class="step-title">STEP 2. 配置</div>
                <input type="number" id="cols" value="6" style="width: 35px;"> x <input type="number" id="rows" value="6" style="width: 35px;">
                <button onclick="renderGrid()">重設</button>
            </div>
            <div class="step-box">
                <div class="step-title">STEP 3. 模式</div>
                <select id="mode-select" onchange="switchMode()">
                    <option value="random">一鍵隨機</option>
                    <option value="draw">現場抽籤</option>
                    <option value="manual">代號選位</option>
                </select>
                <button id="main-action-btn" onclick="executeRandom()">執行</button>
            </div>
        </div>
        <div class="step-box" style="border:none;">
            <div class="step-title" style="color:var(--gold)">STEP 4. 輸出</div>
            <button class="btn-pdf" onclick="exportPDF()">匯出 A4 直向 PDF</button>
        </div>
    </div>

    <div class="main-layout">
        <div id="sidebar" class="control-sidebar"><div id="sidebar-content"></div></div>
        <div class="seat-display">
            <div id="congrats-area"></div>
            <div id="grid" class="grid-container"></div>
            <div class="teacher-desk" style="border: 1px solid var(--accent); width: 150px; text-align: center; padding: 5px; font-size: 0.8rem; color: var(--accent);">講桌</div>
        </div>
    </div>

    <div id="pdf-template">
        <div class="pdf-header">
            <div id="pdf-time"></div>
            <div id="pdf-teacher">導師：</div>
        </div>
        <div class="pdf-title" id="pdf-main-title">班級座位表</div>
        <div class="pdf-content">
            <div class="pdf-left">
                <div class="pdf-section-title">班級幹部</div>
                <ul class="pdf-list" id="list-officers"></ul>
                <div class="pdf-section-title">小老師</div>
                <ul class="pdf-list" id="list-teachers"></ul>
                <div class="pdf-section-title">班聯會人員</div>
                <ul class="pdf-list" id="list-council"></ul>
            </div>
            <div class="pdf-right">
                <div style="border: 1px solid black; width: 100px; text-align: center; margin-bottom: 20px;">講桌</div>
                <div id="pdf-grid-container" class="pdf-grid"></div>
            </div>
        </div>
    </div>

    <script>
        let fullData = [];
        let assignedMap = new Map();
        let currentDrawIndex = 0;

        // 讀取 Excel
        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
                fullData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                alert("名單匯入成功！");
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function renderGrid() {
            const r = parseInt(document.getElementById('rows').value), c = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; assignedMap.clear();
            for (let i = 1; i <= r; i++) {
                const row = document.createElement('div'); row.className = 'row-wrap';
                for (let j = 1; j <= c; j++) {
                    const seat = document.createElement('div'); seat.className = 'seat';
                    seat.dataset.active = "true";
                    seat.onclick = function() { 
                        if(this.dataset.hasStudent) return;
                        this.classList.toggle('disabled'); 
                        this.dataset.active = !this.classList.contains('disabled');
                        recalculate();
                    };
                    row.appendChild(seat);
                }
                grid.appendChild(row);
            }
            recalculate();
        }

        function recalculate() {
            const rows = document.querySelectorAll('.row-wrap');
            let num = 1;
            rows.forEach(row => {
                row.querySelectorAll('.seat').forEach(seat => {
                    if (seat.dataset.active === "true") {
                        const s = assignedMap.get(num);
                        seat.innerHTML = `<span class="seat-num">${num}</span><span class="student-name">${s ? s.姓名 : ''}</span>`;
                        if(s) seat.dataset.hasStudent = "true"; else delete seat.dataset.hasStudent;
                        num++;
                    } else { seat.innerHTML = ""; }
                });
            });
        }

        function switchMode() {
            const mode = document.getElementById('mode-select').value;
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = (mode === 'random') ? 'none' : 'flex';
            if(mode === 'draw') { currentDrawIndex = 0; updateDrawUI(); }
            if(mode === 'manual') updateManualUI();
        }

        function executeRandom() {
            const activeCount = document.querySelectorAll('.seat[data-active="true"]').length;
            if(fullData.length > activeCount) return alert("位置不足");
            const shuffled = [...fullData].sort(() => Math.random() - 0.5);
            assignedMap.clear();
            shuffled.forEach((s, i) => assignedMap.set(i + 1, s));
            recalculate();
        }

        // 抽籤邏輯 (略，同前次更新)
        function updateDrawUI() { /* ... */ } 
        function updateManualUI() { /* ... */ }

        // --- PDF 匯出核心邏輯 ---
        function exportPDF() {
            if(fullData.length === 0) return alert("請先匯入名單並完成分配");

            // 1. 填寫標頭資訊
            const firstRow = fullData[0];
            const now = new Date();
            document.getElementById('pdf-time').innerText = `列印時間：${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
            document.getElementById('pdf-teacher').innerText = `導師：${firstRow.導師 || '未標記'}`;
            document.getElementById('pdf-main-title').innerText = `${firstRow.班級 || ''} 班級座位表`;

            // 2. 填寫左側清單
            const officers = ["班長", "副班長", "學藝股長", "風紀股長", "服務股長", "內衛生", "外衛生", "環保股長", "資訊股長", "圖書股長", "輔導股長", "實習股長", "體育股長", "班代"];
            let offHtml = "", teaHtml = "", couHtml = "";
            
            fullData.forEach(s => {
                // 檢查所有幹部欄位
                for(let i=1; i<=10; i++) {
                    const duty = s[`幹部及小老師${i}`];
                    if(!duty) continue;
                    if(officers.includes(duty)) offHtml += `<li>${duty}：${s.姓名}</li>`;
                    else if(duty.includes("小老師")) teaHtml += `<li>${duty}：${s.姓名}</li>`;
                    else if(duty.includes("班聯會")) couHtml += `<li>${duty}：${s.姓名}</li>`;
                }
            });
            document.getElementById('list-officers').innerHTML = offHtml;
            document.getElementById('list-teachers').innerHTML = teaHtml;
            document.getElementById('list-council').innerHTML = couHtml;

            // 3. 繪製右側座位 (純座號+姓名)
            const pdfGrid = document.getElementById('pdf-grid-container');
            pdfGrid.innerHTML = '';
            const rows = document.querySelectorAll('.row-wrap');
            let num = 1;
            rows.forEach(row => {
                const pdfRow = document.createElement('div');
                pdfRow.style.display = "flex"; pdfRow.style.gap = "5px";
                row.querySelectorAll('.seat').forEach(seat => {
                    const s = assignedMap.get(num);
                    const pdfSeat = document.createElement('div');
                    pdfSeat.className = 'pdf-seat';
                    if(seat.dataset.active === "true") {
                        pdfSeat.innerHTML = `<div class="pdf-seat-num">${s ? s.座號 : num}</div><div style="font-weight:bold">${s ? s.姓名 : ''}</div>`;
                        num++;
                    } else {
                        pdfSeat.style.border = "none";
                    }
                    pdfRow.appendChild(pdfSeat);
                });
                pdfGrid.appendChild(pdfRow);
            });

            // 4. 執行匯出
            const element = document.getElementById('pdf-template');
            element.style.display = 'block'; // 暫時顯示以供抓取
            const opt = {
                margin: 0,
                filename: `${firstRow.班級 || ''}座位表.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none';
            });
        }

        renderGrid();
    </script>
</body>
</html>
