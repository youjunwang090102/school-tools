<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>班級座位系統 | PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* 網頁顯示樣式 (深色模式) */
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --border: #334155; --danger: #ef4444; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .navbar { display: flex; gap: 15px; padding: 12px 20px; background: var(--card); border-bottom: 2px solid var(--accent); align-items: center; flex-shrink: 0; }
        .nav-item { display: flex; flex-direction: column; gap: 4px; }
        button { cursor: pointer; padding: 6px 12px; border-radius: 4px; border: none; font-weight: bold; }
        .btn-main { background: var(--accent); color: #000; }
        .btn-pdf { background: var(--danger); color: #fff; }
        input { background: #0f172a; color: #fff; border: 1px solid var(--border); padding: 5px; width: 40px; }

        .content { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 260px; background: rgba(0,0,0,0.3); border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; }
        .seat-view { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* 網格邏輯 (左下角為1) */
        .grid-container { display: flex; flex-direction: column-reverse; gap: 10px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat { width: 80px; height: 55px; border: 2px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .seat.disabled { background: var(--danger); opacity: 0.2; }
        .seat.highlight { background: #22c55e !important; }
        .seat-num { position: absolute; top: 3px; left: 5px; font-size: 10px; color: var(--accent); }

        /* --- PDF 專用樣式 (強制顯色) --- */
        #pdf-root { 
            display: none; width: 180mm; padding: 10mm; background: #ffffff !important; color: #000000 !important;
            position: absolute; top: 0; left: -5000px; /* 移出螢幕外 */
        }
        .pdf-print-area { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .pdf-grid { display: flex; flex-direction: column-reverse; gap: 10px; margin-top: 20px; }
        .pdf-row { display: flex; gap: 10px; }
        .pdf-seat-box { 
            border: 1px solid #000 !important; width: 65px; height: 50px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #fff !important; color: #000 !important;
        }
        .pdf-stu-name { font-size: 14px; font-weight: bold; color: #000 !important; }
        .pdf-stu-no { font-size: 9px; color: #666 !important; }
        .pdf-desk { margin-top: 30px; border: 2px solid #000; width: 200px; text-align: center; padding: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-item"><label>Excel</label><input type="file" id="upload-excel" style="width:180px"></div>
    <div class="nav-item">寬 <input type="number" id="cols" value="6"> 高 <input type="number" id="rows" value="6"></div>
    <button class="btn-main" onclick="initGrid()">重置</button>
    <button class="btn-pdf" onclick="generatePDF()">下載 PDF (修復版)</button>
</div>

<div class="content">
    <div id="sidebar"><h3>請先匯入名單</h3></div>
    <div class="seat-view">
        <div id="main-grid" class="grid-container"></div>
        <div style="margin-top:20px; color:var(--accent); font-weight:bold;">講 桌 (前方)</div>
    </div>
</div>

<div id="pdf-root">
    <div class="pdf-print-area">
        <h2 id="p-title" style="margin-bottom:5px;">班級座位表</h2>
        <p id="p-info" style="margin-bottom:20px;"></p>
        <div id="p-grid" class="pdf-grid"></div>
        <div class="pdf-desk">講 桌</div>
    </div>
</div>

<script>
let studentList = [];
let assignedMap = new Map();
let classInfo = { name: "", teacher: "" };
let drawIndex = 0;

document.getElementById('upload-excel').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        classInfo.name = ws['B1']?.v || "班級";
        classInfo.teacher = ws['D1']?.v || "導師";
        studentList = XLSX.utils.sheet_to_json(ws, {range: 1}).map(s => ({
            座號: s['座號'], 姓名: s['姓名'], 職務: s['職務1'] || ""
        }));
        updateSidebar();
        alert("名單載入成功！");
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};

function initGrid() {
    const r = document.getElementById('rows').value, c = document.getElementById('cols').value;
    const g = document.getElementById('main-grid');
    g.innerHTML = ''; assignedMap.clear(); drawIndex = 0;
    for(let i=0; i<r; i++) {
        const row = document.createElement('div'); row.className = 'row-wrap';
        for(let j=0; j<c; j++) {
            const s = document.createElement('div'); s.className = 'seat';
            s.dataset.active = "true";
            s.onclick = function() {
                if(this.dataset.hasStu) return;
                this.classList.toggle('disabled');
                this.dataset.active = !this.classList.contains('disabled');
                renderDisplay();
            };
            row.appendChild(s);
        }
        g.appendChild(row);
    }
    renderDisplay(); updateSidebar();
}

function renderDisplay() {
    let num = 1;
    document.querySelectorAll('.row-wrap').forEach(row => {
        row.querySelectorAll('.seat').forEach(seat => {
            if(seat.dataset.active === "true") {
                const stu = assignedMap.get(num);
                seat.innerHTML = `<span class="seat-num">${num}</span><span style="font-weight:bold">${stu ? stu.姓名 : ''}</span>`;
                seat.dataset.seatId = num;
                seat.dataset.hasStu = stu ? "true" : "";
                num++;
            } else { seat.innerHTML = ""; delete seat.dataset.seatId; }
        });
    });
}

function updateSidebar() {
    const side = document.getElementById('sidebar');
    if(!studentList.length) return;
    if(drawIndex >= studentList.length) { side.innerHTML = "<h3>抽籤完成</h3>"; return; }
    const s = studentList[drawIndex];
    side.innerHTML = `<div><p>下一位：</p><h1>${s.姓名}</h1><button class="btn-main" style="width:100%" onclick="luckyDraw()">按下抽籤</button></div>`;
}

async function luckyDraw() {
    const empty = Array.from(document.querySelectorAll('.seat[data-active="true"]'))
                       .filter(s => !assignedMap.has(parseInt(s.dataset.seatId)))
                       .map(s => parseInt(s.dataset.seatId));
    if(!empty.length) return alert("沒位子了");

    // 動畫
    for(let i=0; i<10; i++) {
        let tid = empty[Math.floor(Math.random() * empty.length)];
        document.querySelector(`[data-seat-id="${tid}"]`).classList.add('highlight');
        await new Promise(r => setTimeout(r, 50));
        document.querySelector(`[data-seat-id="${tid}"]`).classList.remove('highlight');
    }

    const final = empty[Math.floor(Math.random() * empty.length)];
    assignedMap.set(final, studentList[drawIndex]);
    drawIndex++;
    renderDisplay(); updateSidebar();
}

function generatePDF() {
    const root = document.getElementById('pdf-root');
    const pGrid = document.getElementById('p-grid');
    pGrid.innerHTML = '';
    root.style.display = 'block';

    document.getElementById('p-title').innerText = `${classInfo.name} 座位表`;
    document.getElementById('p-info').innerText = `導師：${classInfo.teacher} | 列印日期：2026/02/09`;

    document.querySelectorAll('.row-wrap').forEach(row => {
        const pRow = document.createElement('div'); pRow.className = 'pdf-row';
        row.querySelectorAll('.seat').forEach(seat => {
            const ps = document.createElement('div'); ps.className = 'pdf-seat-box';
            if(seat.dataset.active === "true") {
                const stu = assignedMap.get(parseInt(seat.dataset.seatId));
                ps.innerHTML = `<span class="pdf-stu-no">${stu ? '座號:'+stu.座號 : seat.dataset.seatId}</span><span class="pdf-stu-name">${stu ? stu.姓名 : ''}</span>`;
            } else {
                ps.style.border = "none";
            }
            pRow.appendChild(ps);
        });
        pGrid.appendChild(pRow);
    });

    const opt = {
        margin: 0,
        filename: '座位表.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 2, backgroundColor: '#ffffff' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().from(root).set(opt).save().then(() => {
        root.style.display = 'none';
    });
}

initGrid();
</script>
</body>
</html>
