<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ•™å®¤é¸ä½æ§åˆ¶å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2563eb; --accent: #f59e0b; --bg: #f8fafc; --border: #e2e8f0; }
        body, html { margin: 0; padding: 0; height: 100vh; font-family: sans-serif; overflow: hidden; }
        
        main { display: flex; height: 100vh; }

        /* å·¦å´ 30% æ§åˆ¶å° */
        #left-panel { 
            width: 30%; border-right: 2px solid var(--border); background: white;
            display: flex; flex-direction: column; padding: 15px; box-sizing: border-box;
        }
        .section-title { height: 8%; font-size: 20px; font-weight: bold; color: var(--primary); display: flex; align-items: center; border-bottom: 2px solid var(--bg); }
        .section-import { height: 10%; display: flex; align-items: center; gap: 5px; }
        .section-grid { height: 12%; display: flex; flex-direction: column; justify-content: center; font-size: 13px; color: #666; }
        .section-draw { height: 60%; display: flex; flex-direction: column; overflow: hidden; }
        .section-result { height: 10%; display: flex; align-items: center; gap: 10px; border-top: 1px solid var(--border); }

        /* å³å´ 70% åº§ä½è¡¨ */
        #right-panel { 
            width: 70%; background: var(--bg); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; position: relative;
        }

        /* å…ƒä»¶æ¨£å¼ */
        button { cursor: pointer; border-radius: 6px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-p { background: var(--primary); color: white; padding: 8px; font-size: 14px; }
        .btn-s { background: #64748b; color: white; padding: 8px; font-size: 12px; }
        .scroll-list { flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; }
        .student-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px dotted #eee; font-size: 14px; }
        .student-item input { margin-right: 10px; width: 18px; height: 18px; }

        /* åº§ä½æ ¼ */
        .grid-container { display: flex; flex-direction: column-reverse; gap: 10px; }
        .row-wrap { display: flex; gap: 10px; }
        .seat { 
            width: 70px; height: 60px; border: 2px solid #cbd5e1; border-radius: 8px; background: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; position: relative;
        }
        .seat.occupied { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: bold; }
        .seat.disabled { background: #e2e8f0; border-style: dashed; opacity: 0.6; }
        .seat.animating { background: var(--accent) !important; color: white; transform: scale(1.1); z-index: 10; }
        .seat-num { position: absolute; top: 2px; left: 4px; font-size: 10px; color: #94a3b8; }
        .desk { width: 300px; height: 40px; border: 3px solid #cbd5e1; margin-top: 30px; display: flex; align-items: center; justify-content: center; color: #64748b; font-weight: bold; letter-spacing: 10px; }
    </style>
</head>
<body>

<main>
    <div id="left-panel">
        <div class="section-title">é¸ä½æ§åˆ¶å°</div>
        
        <div class="section-import">
            <input type="file" id="fileIn" style="width: 70%;">
            <button onclick="downloadTpl()" class="btn-s" style="width: 30%;">ç¯„æœ¬</button>
        </div>

        <div class="section-grid">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                å¯¬: <input type="number" id="gridC" value="6" style="width:40px;"> 
                é«˜: <input type="number" id="gridR" value="6" style="width:40px;">
                <button onclick="makeGrid()" class="btn-s">é‡è¨­</button>
            </div>
            <span>â€» é»æ“Šå³å´åº§ä½å¯è¨­ç½®éšœç¤™</span>
        </div>

        <div class="section-draw" id="draw-area">
            <p style="margin:5px 0; font-size:13px; font-weight:bold;">å­¸ç”Ÿåå–® (å‹¾é¸è€…å„ªå…ˆå‰å…©æ’)</p>
            <div id="stu-list" class="scroll-list">å°šæœªè¼‰å…¥åå–®...</div>
            <div id="draw-controls">
                <button onclick="lockAndStart()" class="btn-p" style="width:100%; height:45px;">ç¢ºèªåå–®ä¸¦é–‹å§‹æŠ½ç±¤</button>
            </div>
        </div>

        <div class="section-result">
            <button onclick="sendMail()" class="btn-p" style="flex:1; background:#059669;">ğŸ“§ ç™¼é€éƒµä»¶</button>
            <button onclick="savePDF()" class="btn-p" style="flex:1; background:#475569;">ğŸ“„ ä¸‹è¼‰PDF</button>
        </div>
    </div>

    <div id="right-panel">
        <div id="grid" class="grid-container"></div>
        <div class="desk">è¬›æ¡Œ</div>
    </div>
</main>

<script>
    let students = [];
    let assigned = new Map();
    let prioritySet = new Set();
    let drawQueue = [];
    let isDrawing = false;

    // ä¸‹è¼‰ç¯„æœ¬
    function downloadTpl() {
        const ws = XLSX.utils.aoa_to_sheet([["åº§è™Ÿ", "å§“å", "å­¸è™Ÿ", "æ•™è‚²ä¿¡ç®±"], [1, "ç‹å°æ˜", "A101", "test@edu.tw"]]);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "åå–®");
        XLSX.writeFile(wb, "åº§ä½åå–®ç¯„æœ¬.xlsx");
    }

    // å»ºç«‹åº§ä½
    function makeGrid() {
        const r = document.getElementById('gridR').value, c = document.getElementById('gridC').value;
        const grid = document.getElementById('grid');
        grid.innerHTML = ''; assigned.clear();
        for(let i=0; i<r; i++) {
            const row = document.createElement('div');
            row.className = 'row-wrap';
            for(let j=0; j<c; j++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.dataset.active = "true";
                seat.onclick = function() {
                    if(assigned.size === 0) {
                        this.classList.toggle('disabled');
                        this.dataset.active = this.classList.contains('disabled') ? "false" : "true";
                        updateSeatUI();
                    }
                };
                row.appendChild(seat);
            }
            grid.appendChild(row);
        }
        updateSeatUI();
    }

    function updateSeatUI() {
        const seats = document.querySelectorAll('.seat');
        let count = 1;
        seats.forEach(s => {
            if(s.dataset.active === "true") {
                const stu = assigned.get(count);
                s.innerHTML = `<span class="seat-num">${count}</span>${stu ? stu.å§“å : ''}`;
                s.className = stu ? "seat occupied" : "seat";
                count++;
            } else {
                s.innerHTML = ""; s.className = "seat disabled";
            }
        });
    }

    // è¼‰å…¥ Excel
    document.getElementById('fileIn').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type:'array'});
            students = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            renderStudentList();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function renderStudentList() {
        const list = document.getElementById('stu-list');
        list.innerHTML = students.map((s, i) => `
            <div class="student-item">
                <input type="checkbox" onchange="toggleP(${i}, this)"> ${s.åº§è™Ÿ}. ${s.å§“å}
            </div>
        `).join('');
    }

    function toggleP(idx, el) {
        if(el.checked) {
            if(prioritySet.size >= 12) { alert("å„ªå…ˆä½æœ€å¤š12å€‹"); el.checked = false; }
            else prioritySet.add(idx);
        } else prioritySet.delete(idx);
    }

    // æŠ½ç±¤é‚è¼¯
    function lockAndStart() {
        const pArr = Array.from(prioritySet);
        const others = students.map((_, i) => i).filter(i => !prioritySet.has(i));
        drawQueue = [...pArr, ...others];
        nextDrawUI();
    }

    function nextDrawUI() {
        const area = document.getElementById('draw-area');
        if(!drawQueue.length) { area.innerHTML = "<h2>ğŸ‰ æŠ½ç±¤å®Œæˆ</h2>"; return; }
        const s = students[drawQueue[0]];
        const isP = prioritySet.has(drawQueue[0]);
        area.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <p style="color:var(--primary)">${isP ? 'ğŸŒŸ å„ªå…ˆå‰å…©æ’ (1~12)' : 'ğŸ‘¤ ä¸€èˆ¬æŠ½ç±¤'}</p>
                <h1 style="font-size:40px; margin:10px 0;">${s.å§“å}</h1>
                <button onclick="executeDraw(${drawQueue[0]}, ${isP})" id="drawBtn" style="width:100%; height:100px; font-size:24px; background:#059669; color:white;">ğŸ° æŒ‰ä¸‹æŠ½ä½å­</button>
            </div>
        `;
    }

    function executeDraw(sIdx, isP) {
        if(isDrawing) return;
        isDrawing = true;
        const btn = document.getElementById('drawBtn');
        btn.disabled = true; btn.innerText = "æ­£åœ¨æŠ½ç±¤...";

        const seats = document.querySelectorAll('.seat:not(.disabled)');
        let avail = [];
        for(let i=1; i<=seats.length; i++) {
            if(!assigned.has(i)) {
                if(isP && i <= 12) avail.push(i);
                else if(!isP) avail.push(i);
            }
        }
        
        if(!avail.length && isP) { isDrawing = false; return executeDraw(sIdx, false); }

        // å‹•ç•«æ•ˆæœ
        let timer = 0;
        const aniInt = setInterval(() => {
            const randomSeat = seats[Math.floor(Math.random() * seats.length)];
            randomSeat.classList.add('animating');
            setTimeout(() => randomSeat.classList.remove('animating'), 100);
            timer += 100;
            if(timer > 1500) {
                clearInterval(aniInt);
                const target = avail[Math.floor(Math.random() * avail.length)];
                assigned.set(target, students[sIdx]);
                drawQueue.shift();
                updateSeatUI();
                isDrawing = false;
                nextDrawUI();
            }
        }, 100);
    }

    // éƒµä»¶èˆ‡ PDF
    function sendMail() {
        const mails = students.map(s => s.æ•™è‚²ä¿¡ç®±).filter(m => m);
        let body = "å®¶é•·/åŒå­¸æ‚¨å¥½ï¼š\né€™æ˜¯æœ€æ–°çš„æ•™å®¤åº§ä½å®‰æ’çµæœï¼Œè©³æƒ…è«‹åƒé–±é™„ä»¶ã€‚";
        const mailto = `mailto:?bcc=${mails.join(',')}&subject=${encodeURIComponent('æ•™å®¤åº§ä½åˆ†é…çµæœ')}&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;
    }

    function savePDF() {
        const opt = { margin: 10, filename: 'åº§ä½è¡¨.pdf', html2canvas: { scale: 2 }, jsPDF: { orientation: 'landscape' } };
        html2pdf().from(document.getElementById('right-panel')).set(opt).save();
    }

    makeGrid();
</script>
</body>
</html>
