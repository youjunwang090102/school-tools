<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§æ•™å®¤åº§ä½ç³»çµ± | å¢å¼·ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #059669; --warning: #d97706; --bg: #f8fafc; --border: #e2e8f0; }
        * { box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        header { background: white; padding: 10px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .row { display: flex; gap: 8px; }
        select, input, button { padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; }
        button { cursor: pointer; background: var(--primary); color: white; border: none; font-weight: bold; }
        .btn-green { background: var(--success); }
        .btn-gold { background: var(--warning); }

        /* ä¸»å…§å®¹å€ */
        main { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 300px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; }
        #capture-area { flex: 1; overflow: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #fff; }

        /* åº§ä½æ¨£å¼ */
        .grid { display: flex; flex-direction: column-reverse; gap: 8px; }
        .row-wrap { display: flex; gap: 8px; }
        .seat { 
            width: 55px; height: 50px; border: 1.5px solid var(--border); border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 12px; position: relative; background: #fff;
        }
        .seat.occupied { border-color: var(--primary); background: #eff6ff; }
        .seat.disabled { background: #f1f5f9; border-style: dashed; color: #cbd5e1; }
        .seat-num { position: absolute; top: 2px; left: 3px; font-size: 9px; color: #94a3b8; }
        .student-name { font-weight: 800; color: #1e293b; }
        .desk { width: 200px; height: 35px; border: 2px solid var(--border); margin-top: 20px; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #64748b; font-weight: bold; }

        /* å„ªå…ˆåå–®åˆ—è¡¨ */
        .list-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 15px; }
        .list-item input { width: 20px; height: 20px; margin-right: 10px; }
        .scroll { overflow-y: auto; flex: 1; margin: 10px 0; border: 1px solid #f1f5f9; }

        /* æ‰‹æ©Ÿç‰ˆé©æ‡‰ */
        @media (max-width: 768px) {
            main { flex-direction: column; }
            #sidebar { width: 100%; height: 350px; border-right: none; border-bottom: 1px solid var(--border); }
            .seat { width: 50px; height: 45px; }
        }
    </style>
</head>
<body>

<header>
    <div class="row">
        <input type="file" id="fileIn" style="flex: 2;">
        <select id="mode" onchange="initMode()" style="flex: 1;">
            <option value="setup">é…ç½®éšœç¤™</option>
            <option value="draw">ä¾åºæŠ½ç±¤</option>
        </select>
    </div>
    <div class="row">
        <button onclick="sendMail()" class="btn-gold" style="flex:1">ğŸ“§ ç™¼é€éƒµä»¶</button>
        <button onclick="copyResult()" class="btn-green" style="flex:1">ğŸ“‹ è¤‡è£½çµæœ</button>
        <button onclick="exportPDF()" style="flex:1">ğŸ“„ PDF</button>
    </div>
</header>

<main>
    <div id="sidebar">
        <h4 id="side-title" style="margin:0">è«‹è¼‰å…¥åå–®</h4>
        <div id="side-body" class="scroll"></div>
        <div id="side-foot"></div>
    </div>
    <div id="capture-area">
        <div id="grid" class="grid"></div>
        <div class="desk">è¬›æ¡Œ / å‰æ–¹</div>
    </div>
</main>

<script>
    let students = [];
    let assigned = new Map();
    let priorityIdx = new Set();
    let queue = [];

    // åˆå§‹åŒ–ç¶²æ ¼
    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for(let r=0; r<6; r++) {
            const row = document.createElement('div');
            row.className = 'row-wrap';
            for(let c=0; c<6; c++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.dataset.active = "true";
                seat.onclick = function() {
                    if(document.getElementById('mode').value === 'setup' && !assigned.size) {
                        this.classList.toggle('disabled');
                        this.dataset.active = this.classList.contains('disabled') ? "false" : "true";
                        refreshGrid();
                    }
                };
                row.appendChild(seat);
            }
            grid.appendChild(row);
        }
        refreshGrid();
    }

    function refreshGrid() {
        const seats = document.querySelectorAll('.seat');
        let count = 1;
        seats.forEach(s => {
            if(s.dataset.active === "true") {
                const stu = assigned.get(count);
                s.innerHTML = `<span class="seat-num">${count}</span><span class="student-name">${stu ? stu.å§“å : ''}</span>`;
                s.className = stu ? "seat occupied" : "seat";
                count++;
            } else {
                s.innerHTML = ""; s.className = "seat disabled";
            }
        });
    }

    // è™•ç†æª”æ¡ˆ
    document.getElementById('fileIn').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type:'array'});
            students = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            alert(`è¼‰å…¥æˆåŠŸï¼š${students.length} äºº`);
            initMode();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function initMode() {
        const mode = document.getElementById('mode').value;
        const body = document.getElementById('side-body');
        const foot = document.getElementById('side-foot');
        assigned.clear(); priorityIdx.clear();
        refreshGrid();

        if(mode === 'draw') {
            document.getElementById('side-title').innerText = "å‹¾é¸å„ªå…ˆå‰å…©æ’(1-12)";
            body.innerHTML = students.map((s, i) => `
                <div class="list-item">
                    <input type="checkbox" onchange="toggleP(${i}, this)"> ${s.å§“å}
                </div>
            `).join('');
            foot.innerHTML = `<button onclick="startDraw()" style="width:100%; padding:12px;">ç¢ºèªä¸¦é–‹å§‹æŠ½ç±¤</button>`;
        } else {
            document.getElementById('side-title').innerText = "é»æ“Šåº§ä½è¨­ç½®éšœç¤™";
            body.innerHTML = "è«‹é»æ“Šå³å´åº§ä½å€æ’é™¤ä¸å¯åçš„ä½å­ã€‚";
            foot.innerHTML = `<button onclick="randomAll()" style="width:100%; padding:12px;" class="btn-green">ğŸ² å…¨ç­éš¨æ©Ÿåˆ†é…</button>`;
        }
    }

    function toggleP(idx, el) {
        if(el.checked) {
            if(priorityIdx.size >= 12) { alert("æœ€å¤š12ä½"); el.checked = false; }
            else priorityIdx.add(idx);
        } else priorityIdx.delete(idx);
    }

    function startDraw() {
        const pArr = Array.from(priorityIdx);
        const others = students.map((_, i) => i).filter(i => !priorityIdx.has(i));
        queue = [...pArr, ...others];
        nextStep();
    }

    function nextStep() {
        const body = document.getElementById('side-body');
        if(!queue.length) { body.innerHTML = "<h3>æŠ½ç±¤å®Œæˆï¼</h3>"; return; }
        const s = students[queue[0]];
        const isP = priorityIdx.has(queue[0]);
        body.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <p>${isP ? 'â­ å„ªå…ˆä½ (1-12)' : 'ğŸ‘¤ ä¸€èˆ¬ä½'}</p>
                <h1 style="font-size:32px;">${s.å§“å}</h1>
                <button onclick="pick(${queue[0]}, ${isP})" style="width:100%; height:80px; font-size:24px;" class="btn-green">ğŸ° æŠ½ä½å­</button>
            </div>
        `;
    }

    function pick(sIdx, isP) {
        const seats = document.querySelectorAll('.seat:not(.disabled)');
        let avail = [];
        for(let i=1; i<=seats.length; i++) {
            if(!assigned.has(i)) {
                if(isP && i <= 12) avail.push(i);
                else if(!isP) avail.push(i);
            }
        }
        if(!avail.length && isP) return pick(sIdx, false); // å„ªå…ˆä½æ»¿äº†æ”¹æŠ½ä¸€èˆ¬
        const target = avail[Math.floor(Math.random() * avail.length)];
        assigned.set(target, students[sIdx]);
        queue.shift();
        refreshGrid();
        nextStep();
    }

    // ç™¼é€éƒµä»¶ (é‡å°æ‚¨çš„æ¬„ä½å„ªåŒ–)
    function sendMail() {
        if(!assigned.size) return alert("è«‹å…ˆåˆ†é…åº§ä½");
        const mails = [];
        let text = "åº§ä½åˆ†é…çµæœï¼š\n";
        assigned.forEach((s, seat) => {
            text += `åº§ä½ ${seat}: ${s.å§“å} (åº§è™Ÿ ${s.åº§è™Ÿ})\n`;
            if(s.æ•™è‚²ä¿¡ç®±) mails.push(s.æ•™è‚²ä¿¡ç®±);
        });

        const mailto = `mailto:?bcc=${mails.join(',')}&subject=åº§ä½çµæœ&body=${encodeURIComponent(text)}`;
        if(mailto.length > 2000) {
            alert("åå–®éé•·ï¼Œå·²è‡ªå‹•ç‚ºæ‚¨è¤‡è£½çµæœï¼Œè«‹æ‰‹å‹•è²¼åˆ°éƒµä»¶ã€‚");
            copyResult();
        } else {
            window.location.href = mailto;
        }
    }

    function copyResult() {
        let text = "ã€åº§ä½åˆ†é…æ¸…å–®ã€‘\n";
        assigned.forEach((s, seat) => text += `åº§ä½ ${seat}ï¼š${s.å§“å}\n`);
        navigator.clipboard.writeText(text).then(() => alert("âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"));
    }

    function randomAll() {
        assigned.clear();
        const shuffled = [...students].sort(() => Math.random() - 0.5);
        shuffled.forEach((s, i) => assigned.set(i+1, s));
        refreshGrid();
    }

    function exportPDF() { html2pdf().from(document.getElementById('capture-area')).save('åº§ä½è¡¨.pdf'); }

    renderGrid();
</script>
</body>
</html>
