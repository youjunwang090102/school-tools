<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­ç´šæ•¸ä½å¹³å°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --p: #4361ee; --s: #2ec4b6; --a: #ff9f1c; --t: #ef233c; --g: #7209b7; 
            --m: #ffd60a; --v: #38b000; --cal: #5856D6; --whi: #AF52DE; 
            --help: #ff758c; --duty: #4cc9f0; --hw: #f72585; --pdf: #3a0ca3;
            --bg: #f0f2f5; --card: #ffffff; --text: #2b2d42;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        /* é ‚éƒ¨åŠŸèƒ½å°èˆªæ¬„ */
        .navbar {
            width: 100%; max-width: 500px; padding: 10px 20px; box-sizing: border-box;
            display: flex; justify-content: flex-end; gap: 10px; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .nav-btn {
            background: white; border: 1px solid #ddd; padding: 6px 12px;
            border-radius: 20px; font-size: 0.8rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-btn.primary { background: var(--p); color: white; border: none; }
        .nav-btn.admin { background: var(--t); color: white; border: none; display: none; }

        .header { width: 100%; padding: 30px 20px 20px; background: white; text-align: center; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .menu-list { width: 100%; max-width: 500px; padding: 10px 20px 20px; box-sizing: border-box; display: flex; flex-direction: column; gap: 14px; }
        
        /* åŸæœ‰çš„å¡ç‰‡èˆ‡é¡è‰²æ¨£å¼ä¿ç•™... (ç¸®æ¸›é¡¯ç¤ºç©ºé–“ä»¥ç¯€çœé•·åº¦) */
        .category-label { margin: 15px 0 5px 10px; font-size: 0.85rem; color: #8d99ae; font-weight: bold; }
        .menu-item { background: var(--card); border-radius: 20px; padding: 18px; display: flex; align-items: center; text-decoration: none; color: inherit; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: 0.2s; border: 1px solid rgba(0,0,0,0.03); cursor: pointer; }
        .icon-box { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 16px; flex-shrink: 0; }
        .info h2 { margin: 0; font-size: 1.05rem; font-weight: 700; }
        .info p { margin: 0; font-size: 0.82rem; color: #6d7280; }

        /* é‚Šæ¡†å®šç¾© (èˆ‡åŸç‰ˆç›¸åŒ) */
        .calendar { border-left: 6px solid var(--cal); } .timer { border-left: 6px solid var(--t); }
        .teacher-help { border-left: 6px solid var(--help); } .duty { border-left: 6px solid var(--duty); }
        .homework { border-left: 6px solid var(--hw); } .pdf-tool { border-left: 6px solid var(--pdf); }
        /* å…¶ä»– class ç•¥é... */

        /* éš±è—çš„ç™»å…¥/ç®¡ç†å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 350px; text-align: center; }
        .modal-content input, .modal-content select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; }
        .modal-content button { width: 100%; padding: 12px; background: var(--p); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="navbar">
        <span id="userInfo" style="font-size: 0.8rem; color: #666; margin-right: auto; padding-left: 10px;"></span>
        <button id="adminMiniBtn" class="nav-btn admin" onclick="openAdminModal()">âš™ï¸ ç®¡ç†</button>
        <button id="loginBtn" class="nav-btn primary" onclick="openModal('authModal')">ç™»å…¥</button>
        <button id="regBtn" class="nav-btn" onclick="openModal('regModal')">è¨»å†Š</button>
        <button id="logoutBtn" class="nav-btn" style="display:none;" onclick="logout()">ç™»å‡º</button>
    </div>

    <div class="header">
        <h1>ç­ç´šæ•¸ä½å¹³å°</h1>
        <p>æ•´åˆç­ç´šæœå‹™ ï½œ é»æ“ŠåŠŸèƒ½å³å¯ä½¿ç”¨</p>
    </div>

    <div class="menu-list">
        <div class="category-label">ğŸ”” æé†’ç³»åˆ—</div>
        <a href="countdown/index.html" class="menu-item timer">
            <div class="icon-box">â³</div>
            <div class="info"><h2>å¤§è€ƒèˆ‡æ—¥ç¨‹å€’æ•¸</h2><p>æŒæ¡çµ±æ¸¬ã€å­¸æ¸¬å€’æ•¸æ™‚é–“ (å…ç™»å…¥)</p></div>
        </a>

        <div class="category-label">ğŸ“š å­¸æ¥­èˆ‡å·¥å…·</div>
        <div class="menu-item homework" onclick="checkAuth('homework.html')">
            <div class="icon-box">âœï¸</div>
            <div class="info"><h2>å„ç§‘ä½œæ¥­æé†’</h2><p>éœ€ç™»å…¥ä½¿ç”¨</p></div>
        </div>
        <div class="menu-item pdf-tool" onclick="checkAuth('pdf_tools.html')">
            <div class="icon-box">ğŸ“</div>
            <div class="info"><h2>å­¸ç¿’æ­·ç¨‹æª”æ¡ˆå£“ç¸®</h2><p>éœ€ç™»å…¥ä½¿ç”¨</p></div>
        </div>

        <div class="category-label">âš™ï¸ ç­å‹™è™•ç†</div>
        <div class="menu-item duty" onclick="checkAuth('cleaning/index.html')">
            <div class="icon-box">ğŸ§¹</div>
            <div class="info"><h2>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ±</h2><p>éœ€ç™»å…¥ä½¿ç”¨</p></div>
        </div>
        </div>

    <div id="authModal" class="modal" onclick="closeModal(event, 'authModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>å¸³è™Ÿç™»å…¥</h3>
            <input type="number" id="stuId" placeholder="åº§è™Ÿ (ä¾‹å¦‚ 05)">
            <input type="password" id="stuPw" placeholder="å¯†ç¢¼">
            <button onclick="doLogin()">ç¢ºèªç™»å…¥</button>
        </div>
    </div>

    <div id="regModal" class="modal" onclick="closeModal(event, 'regModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>å»ºç«‹å¸³è™Ÿ</h3>
            <input type="number" id="regId" placeholder="åº§è™Ÿ">
            <input type="text" id="regName" placeholder="å§“å">
            <input type="password" id="regPw" placeholder="å¯†ç¢¼">
            <select id="regRole">
                <option value="student">å­¸ç”Ÿ</option>
                <option value="teacher">å°å¸« / ç®¡ç†å“¡</option>
            </select>
            <button onclick="doRegister()" style="background:var(--s)">è¨»å†Šå¸³è™Ÿ</button>
        </div>
    </div>

    <div id="adminModal" class="modal" onclick="closeModal(event, 'adminModal')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 450px;">
            <h3>âš™ï¸ è·ä½èˆ‡å¸³è™Ÿç®¡ç†</h3>
            <div id="studentList" style="max-height: 300px; overflow-y: auto; text-align: left;"></div>
            <button onclick="document.getElementById('adminModal').style.display='none'" style="background:#666">é—œé–‰</button>
        </div>
    </div>

    <script>
        // Firebase Config (èˆ‡ä¹‹å‰ç›¸åŒ)
        const firebaseConfig = { apiKey: "...", /* è«‹å¡«å…¥æ‚¨çš„è³‡è¨Š */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let me = null;

        // æª¢æŸ¥æ¬Šé™èˆ‡è·³è½‰
        function checkAuth(url) {
            if (sessionStorage.getItem('user')) {
                location.href = url;
            } else {
                alert("ğŸ”’ æ­¤åŠŸèƒ½éœ€è¦ç™»å…¥å¾Œæ‰èƒ½ä½¿ç”¨ï¼");
                openModal('authModal');
            }
        }

        // å½ˆçª—æ§åˆ¶
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }

        async function doLogin() {
            const id = document.getElementById('stuId').value.padStart(2, '0');
            const pw = document.getElementById('stuPw').value;
            const doc = await db.collection("students").doc(id).get();
            if (doc.exists && doc.data().password === pw) {
                me = { id, ...doc.data() };
                sessionStorage.setItem('user', JSON.stringify(me));
                updateUI();
                document.getElementById('authModal').style.display = 'none';
            } else alert("å¸³å¯†éŒ¯èª¤");
        }

        async function doRegister() {
            const id = document.getElementById('regId').value.padStart(2, '0');
            const name = document.getElementById('regName').value;
            const pw = document.getElementById('regPw').value;
            const role = document.getElementById('regRole').value;
            await db.collection("students").doc(id).set({ name, password: pw, role, subject_role: "ç„¡" });
            alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼");
            document.getElementById('regModal').style.display = 'none';
        }

        function updateUI() {
            const saved = sessionStorage.getItem('user');
            if (saved) {
                me = JSON.parse(saved);
                document.getElementById('userInfo').innerText = `${me.id} ${me.name}`;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('regBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                // å°å¸«æˆ–ç®¡ç†å“¡é¡¯ç¤ºå°æŒ‰éˆ•
                if (me.role === 'teacher' || me.role === 'admin') {
                    document.getElementById('adminMiniBtn').style.display = 'block';
                }
            }
        }

        function logout() { sessionStorage.clear(); location.reload(); }

        // ç®¡ç†å“¡å½ˆçª—å…§å®¹ (å»¶ç”¨ä¹‹å‰çš„æ¸…å–®é‚è¼¯)
        function openAdminModal() {
            openModal('adminModal');
            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
                const box = document.getElementById('studentList');
                box.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    box.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                        <span>${doc.id} ${d.name}</span>
                        <select onchange="updateSubRole('${doc.id}', this.value)" style="width:70px; margin:0 5px;">
                            <option value="ç„¡" ${d.subject_role==='ç„¡'?'selected':''}>è·ä½</option>
                            <option value="åœ‹æ–‡" ${d.subject_role==='åœ‹æ–‡'?'selected':''}>åœ‹æ–‡</option>
                            <option value="è‹±æ–‡" ${d.subject_role==='è‹±æ–‡'?'selected':''}>è‹±æ–‡</option>
                        </select>
                        <button onclick="deleteAccount('${doc.id}')" style="background:red; color:white; border:none; border-radius:5px; padding:2px 5px;">åˆª</button>
                    </div>`;
                });
            });
        }

        async function updateSubRole(sid, role) { await db.collection("students").doc(sid).update({ subject_role: role }); }
        async function deleteAccount(sid) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await db.collection("students").doc(sid).delete(); }

        window.onload = updateUI;
    </script>
</body>
</html>
