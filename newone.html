<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šé›²ç«¯æœå‹™ç¸½å°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .nav-item { background: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.3s; }
        .nav-item:hover { border-color: var(--p); transform: translateY(-5px); }
        .nav-item i { font-size: 2rem; display: block; margin-bottom: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        .admin-zone { background: #fff5f5; border: 1px solid #fed7d7; }
        .stu-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .btn-del { width: auto; background: var(--d); padding: 5px 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <div id="authBox" class="card">
        <h2 style="text-align: center;">ğŸ›ï¸ ç­ç´šé›²ç«¯ç¸½å°</h2>
        <div id="loginView">
            <input type="number" id="stuId" placeholder="åº§è™Ÿ (ä¾‹å¦‚: 05)">
            <input type="password" id="stuPw" placeholder="å¯†ç¢¼">
            <button onclick="doLogin()">ç™»å…¥</button>
            <p style="text-align: center; font-size: 0.8rem; color: #666; cursor: pointer;" onclick="toggleAuth(true)">å°šæœªè¨»å†Šï¼ŸæŒ‰æ­¤è¨»å†Š</p>
        </div>
        <div id="regView" style="display: none;">
            <input type="number" id="regId" placeholder="åº§è™Ÿ">
            <input type="text" id="regName" placeholder="å§“å">
            <input type="password" id="regPw" placeholder="å¯†ç¢¼">
            <select id="regRole">
                <option value="student">ä¸€èˆ¬å­¸ç”Ÿ</option>
                <option value="teacher">è€å¸«/å°å¸«</option>
                <option value="admin">ç®¡ç†å“¡</option>
            </select>
            <button onclick="doRegister()" style="background: var(--s);">å»ºç«‹å¸³è™Ÿ</button>
            <p style="text-align: center; font-size: 0.8rem; color: #666; cursor: pointer;" onclick="toggleAuth(false)">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div id="mainMenu" style="display: none;">
        <div class="card" style="background: linear-gradient(135deg, #4361ee, #4cc9f0); color: white;">
            <h2 id="userName" style="margin:0; color: white;">ä½ å¥½</h2>
            <p id="userDetail" style="margin:5px 0 0 0; opacity: 0.8;"></p>
            <button onclick="logout()" style="background: rgba(255,255,255,0.2); margin-top: 15px; width: auto;">ç™»å‡º</button>
        </div>

        <div class="grid">
            <div class="nav-item" onclick="goTo('cleaning')">ğŸ§¹<span>æ‰“æƒå‹¤å‹™</span></div>
            <div class="nav-item" onclick="goTo('homework')">ğŸ“š<span>ä½œæ¥­æé†’</span></div>
            <div class="nav-item" onclick="goTo('pdf_tools')">ğŸ“‘<span>PDF å£“ç¸®</span></div>
            <div class="nav-item" onclick="goTo('votes')">ğŸ—³ï¸<span>ç­ç´šæŠ•ç¥¨</span></div>
        </div>

        <div id="adminPanel" class="card admin-zone" style="display: none; margin-top: 20px;">
            <h3>âš™ï¸ è¶…ç´šç®¡ç†å¾Œå°</h3>
            <div id="studentManagerList"></div>
        </div>
    </div>
</div>

<script>
    // ğŸ’¡ è¨­å®šå…©å€‹è³‡æ–™åº«é…ç½® (è‹¥åœ¨åŒä¸€å€‹ Projectï¼Œåªéœ€ä¸€å€‹ db)
    const configCleaning = { /* æ‚¨çš„ç¬¬ä¸€å€‹ Project é…ç½® */ };
    const appCleaning = firebase.initializeApp(configCleaning, "cleaning");
    const db = appCleaning.firestore(); // ä¸»è¦å¸³è™Ÿåº«

    let me = null;

    // --- ç™»å…¥é‚è¼¯ ---
    async function doLogin() {
        const id = document.getElementById('stuId').value.padStart(2, '0');
        const pw = document.getElementById('stuPw').value;
        const doc = await db.collection("students").doc(id).get();
        
        if (doc.exists && doc.data().password === pw) {
            me = { id, ...doc.data() };
            showDashboard();
        } else alert("ç™»å…¥å¤±æ•—");
    }

    // --- è¨»å†Šé‚è¼¯ ---
    async function doRegister() {
        const id = document.getElementById('regId').value.padStart(2, '0');
        const name = document.getElementById('regName').value;
        const pw = document.getElementById('regPw').value;
        const role = document.getElementById('regRole').value;
        
        if(!id || !name || !pw) return alert("è«‹å¡«å¯«å®Œæ•´");
        
        await db.collection("students").doc(id).set({
            name, password: pw, role, 
            subject_role: "ç„¡", duty_zone: "æœªåˆ†é…"
        });
        alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥");
        toggleAuth(false);
    }

    function showDashboard() {
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'block';
        document.getElementById('userName').innerText = `ä½ å¥½ï¼Œ${me.name}`;
        document.getElementById('userDetail').innerText = `èº«åˆ†ï¼š${me.role} | è·ä½ï¼š${me.subject_role || 'ç„¡'}`;

        if (me.role === 'admin' || me.role === 'teacher') {
            loadAdminPanel();
        }
    }

    // --- ç®¡ç†å“¡ï¼šå­¸ç”Ÿæ¸…å–®ã€è·ä½è¨­å®šã€ç§»é™¤å¸³è™Ÿ ---
    function loadAdminPanel() {
        document.getElementById('adminPanel').style.display = 'block';
        db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
            const list = document.getElementById('studentManagerList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                    <div class="stu-row">
                        <span><b>${doc.id} ${d.name}</b></span>
                        <select style="width:100px; margin:0 5px;" onchange="setSubRole('${doc.id}', this.value)">
                            <option value="ç„¡" ${d.subject_role==='ç„¡'?'selected':''}>ç„¡è·ä½</option>
                            <option value="åœ‹æ–‡" ${d.subject_role==='åœ‹æ–‡'?'selected':''}>åœ‹æ–‡</option>
                            <option value="è‹±æ–‡" ${d.subject_role==='è‹±æ–‡'?'selected':''}>è‹±æ–‡</option>
                            </select>
                        <button class="btn-del" onclick="removeAccount('${doc.id}')">ç§»é™¤</button>
                    </div>`;
            });
        });
    }

    async function setSubRole(id, role) {
        await db.collection("students").doc(id).update({ subject_role: role });
    }

    async function removeAccount(id) {
        if(confirm(`ç¢ºå®šè¦ç§»é™¤åº§è™Ÿ ${id} çš„å¸³è™Ÿå—ï¼Ÿæ­¤å‹•ä½œä¸å¯é€†ï¼`)) {
            await db.collection("students").doc(id).delete();
        }
    }

    // --- å°èˆª ---
    function goTo(service) {
        // å°‡èº«åˆ†å¸¶å…¥ URLï¼Œè®“å­é é¢çŸ¥é“æ˜¯èª°
        const urlMap = {
            cleaning: "index_cleaning.html",
            homework: "homework.html",
            pdf_tools: "tools.html",
            votes: "votes.html"
        };
        location.href = `${urlMap[service]}?user=${me.id}`;
    }

    function toggleAuth(isReg) {
        document.getElementById('loginView').style.display = isReg ? 'none' : 'block';
        document.getElementById('regView').style.display = isReg ? 'block' : 'none';
    }

    function logout() { location.reload(); }
</script>
</body>
</html>
