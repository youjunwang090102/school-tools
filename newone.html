<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­ç´šæ•¸ä½å¹³å°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --p: #4361ee; --s: #2ec4b6; --a: #ff9f1c; --t: #ef233c; --g: #7209b7; 
            --m: #ffd60a; --v: #38b000; --cal: #5856D6; --whi: #AF52DE; 
            --help: #ff758c; --duty: #4cc9f0; --hw: #f72585; --pdf: #3a0ca3;
            --bg: #f0f2f5; --card: #ffffff; --text: #2b2d42;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        /* é ‚éƒ¨å°èˆªæ¬„ */
        .navbar {
            width: 100%; max-width: 500px; padding: 15px 20px; box-sizing: border-box;
            display: flex; justify-content: flex-end; gap: 10px; align-items: center;
            position: sticky; top: 0; z-index: 100; background: rgba(240, 242, 245, 0.8);
            backdrop-filter: blur(10px);
        }
        .nav-btn {
            background: white; border: 1px solid #ddd; padding: 7px 14px;
            border-radius: 20px; font-size: 0.85rem; cursor: pointer; font-weight: 600;
        }
        .nav-btn.primary { background: var(--p); color: white; border: none; }
        .nav-btn.admin-gear { background: var(--t); color: white; border: none; display: none; }

        .header { width: 100%; padding: 30px 20px 20px; background: white; text-align: center; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; font-size: 1.6rem; }
        .menu-list { width: 100%; max-width: 500px; padding: 10px 20px 40px; box-sizing: border-box; display: flex; flex-direction: column; gap: 14px; }
        .category-label { margin: 15px 0 5px 10px; font-size: 0.85rem; color: #8d99ae; font-weight: bold; letter-spacing: 1px; }

        /* å¡ç‰‡æ¨£å¼ */
        .menu-item { background: var(--card); border-radius: 20px; padding: 18px; display: flex; align-items: center; text-decoration: none; color: inherit; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.03); cursor: pointer; transition: 0.2s; }
        .menu-item:active { transform: scale(0.97); }
        .icon-box { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 16px; flex-shrink: 0; }
        .info { flex-grow: 1; }
        .info h2 { margin: 0; font-size: 1.05rem; font-weight: 700; }
        .info p { margin: 0; font-size: 0.82rem; color: #6d7280; }

        /* é‚Šæ¡†èˆ‡é¡è‰²å®šç¾© */
        .calendar { border-left: 6px solid var(--cal); } .calendar .icon-box { background: #f0f0ff; color: var(--cal); }
        .timer { border-left: 6px solid var(--t); } .timer .icon-box { background: #ffe5e5; color: var(--t); }
        .teacher-help { border-left: 6px solid var(--help); } .teacher-help .icon-box { background: #fff0f2; color: var(--help); }
        .whisper { border-left: 6px solid var(--whi); } .whisper .icon-box { background: #f9f0ff; color: var(--whi); }
        .board { border-left: 6px solid var(--m); } .board .icon-box { background: #fffde7; color: #f59e0b; }
        .duty { border-left: 6px solid var(--duty); } .duty .icon-box { background: #e0f7fa; color: var(--duty); }
        .seat { border-left: 6px solid var(--p); } .seat .icon-box { background: #eef2ff; color: var(--p); }
        .vote { border-left: 6px solid var(--v); } .vote .icon-box { background: #e8f5e9; color: var(--v); }
        .group { border-left: 6px solid var(--g); } .group .icon-box { background: #f3e5f5; color: var(--g); }
        .exam { border-left: 6px solid var(--s); } .exam .icon-box { background: #e6fffa; color: var(--s); }
        .final { border-left: 6px solid var(--a); } .final .icon-box { background: #fffaf0; color: var(--a); }
        .homework { border-left: 6px solid var(--hw); } .homework .icon-box { background: #ffe4f0; color: var(--hw); }
        .pdf-tool { border-left: 6px solid var(--pdf); } .pdf-tool .icon-box { background: #e0d7ff; color: var(--pdf); }

        /* å½ˆçª—æ¨£å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 350px; text-align: center; position: relative; }
        .modal-content input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; }
        .modal-content button { width: 100%; padding: 12px; background: var(--p); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .stu-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="navbar">
        <span id="userNameDisplay" style="font-size: 0.85rem; font-weight: bold; margin-right: auto; padding-left: 10px;"></span>
        <button id="adminBtn" class="nav-btn admin-gear" onclick="openModal('adminModal')">âš™ï¸ ç®¡ç†</button>
        <button id="loginBtn" class="nav-btn primary" onclick="openModal('loginModal')">ç™»å…¥</button>
        <button id="regBtn" class="nav-btn" onclick="openModal('regModal')">è¨»å†Š</button>
        <button id="logoutBtn" class="nav-btn" style="display:none;" onclick="logout()">ç™»å‡º</button>
    </div>

    <div class="header">
        <h1>ç­ç´šæ•¸ä½å¹³å°</h1>
        <p>æ•´åˆç­ç´šæœå‹™ ï½œ é»æ“ŠåŠŸèƒ½å³å¯ä½¿ç”¨</p>
    </div>

    <div class="menu-list">
        <div class="category-label">ğŸ”” æé†’ç³»åˆ—</div>
        <a href="countdown/index.html" class="menu-item timer">
            <div class="icon-box">â³</div>
            <div class="info"><h2>å¤§è€ƒèˆ‡æ—¥ç¨‹å€’æ•¸</h2><p>æŒæ¡çµ±æ¸¬ã€å­¸æ¸¬å€’æ•¸æ™‚é–“ (å…ç™»å…¥)</p></div>
        </a>
        <div class="menu-item calendar" onclick="checkAuth('è¡Œäº‹æ›†/index.html')">
            <div class="icon-box">ğŸ“…</div>
            <div class="info"><h2>ç­ç´šé‡è¦è¡Œäº‹æ›†</h2><p>è€ƒè©¦ã€æ´»å‹•ã€è£œèª²æ—¥ç¨‹ä¸æ¼æ¥</p></div>
        </div>

        <div class="category-label">ğŸ“š å­¸æ¥­èˆ‡å·¥å…·</div>
        <div class="menu-item homework" onclick="checkAuth('homework/index.html')">
            <div class="icon-box">âœï¸</div>
            <div class="info"><h2>å„ç§‘ä½œæ¥­æé†’</h2><p>å°è€å¸«ç™¼ä½ˆä½œæ¥­ï¼ŒåŒæ­¥é€²åº¦</p></div>
        </div>
        <div class="menu-item pdf-tool" onclick="checkAuth('pdf_tools.html')">
            <div class="icon-box">ğŸ“</div>
            <div class="info"><h2>å­¸ç¿’æ­·ç¨‹æª”æ¡ˆå£“ç¸®</h2><p>è‡ªå‹•ç¬¦åˆ 4MB/10MB é™åˆ¶</p></div>
        </div>

        <div class="category-label">ğŸ¤ äº’å‹•ç³»åˆ—</div>
        <div class="menu-item teacher-help" onclick="checkAuth('help/student.html')">
            <div class="icon-box">ğŸŒ±</div>
            <div class="info"><h2>å°å¸«æ‚„æ‚„è©± (å¿ƒè²ç®±)</h2><p>ç§ä¸‹å‘Šè¨´è€å¸«ä½ çš„å›°é›£</p></div>
        </div>
        <div class="menu-item whisper" onclick="checkAuth('åŒ¿å/index.html')">
            <div class="icon-box">ğŸ¤«</div>
            <div class="info"><h2>ç­ç´šåŒ¿åè¨±é¡˜æ± </h2><p>æƒ³èªªä»€éº¼ï¼Ÿæ‚„æ‚„å‘Šè¨´å¤§å®¶</p></div>
        </div>
        <div class="menu-item board" onclick="checkAuth('board/index.html')">
            <div class="icon-box">ğŸ’¬</div>
            <div class="info"><h2>ç­ç´šäº’å‹•ç•™è¨€æ¿</h2><p>ç­ç´šäº‹å‹™å…¬é–‹è¨è«–å€</p></div>
        </div>

        <div class="category-label">âš™ï¸ ç­å‹™è™•ç†</div>
        <div class="menu-item duty" onclick="checkAuth('cleaning/index.html')">
            <div class="icon-box">ğŸ§¹</div>
            <div class="info"><h2>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ±</h2><p>è¡›ç”Ÿæª¢æŸ¥èˆ‡è¨˜é»çæ‡²çµ±è¨ˆ</p></div>
        </div>
        <div class="menu-item seat" onclick="checkAuth('seating/index.html')">
            <div class="icon-box">ğŸª‘</div>
            <div class="info"><h2>æ•¸ä½æ•™å®¤é¸ä½ç³»çµ±</h2><p>æŠ½ç±¤é¸ä½è¶…åˆºæ¿€</p></div>
        </div>
        <div class="menu-item vote" onclick="checkAuth('vote/index.html')">
            <div class="icon-box">ğŸ—³ï¸</div>
            <div class="info"><h2>ç·šä¸ŠæŠ•ç¥¨æ±ºç­–ç³»çµ±</h2><p>é‡è¦äº‹å‹™ä¸€éµè¡¨æ±º</p></div>
        </div>
        <div class="menu-item group" onclick="checkAuth('grouping/index.html')">
            <div class="icon-box">ğŸ²</div>
            <div class="info"><h2>éš¨æ©Ÿåˆ†çµ„å°å¹«æ‰‹</h2><p>å…¬å¹³è‡ªå‹•åˆ†çµ„</p></div>
        </div>

        <div class="category-label">ğŸ“Š æˆç¸¾ç³»åˆ—</div>
        <div class="menu-item exam" onclick="checkAuth('exam_calc/index.html')">
            <div class="icon-box">ğŸ“</div>
            <div class="info"><h2>æ®µè€ƒæˆç¸¾åŠ æ¬Šè¨ˆç®—</h2><p>è¨ˆç®—æ®µè€ƒåŠ æ¬Šå¹³å‡åˆ†æ•¸</p></div>
        </div>
        <div class="menu-item final" onclick="checkAuth('final_calc/index.html')">
            <div class="icon-box">ğŸ“ˆ</div>
            <div class="info"><h2>ç§‘ç›®å­¸æœŸç¸½æˆç¸¾</h2><p>è¨ˆç®—å­¸æœŸåŠ æ¬Šç¸½åˆ†</p></div>
        </div>
    </div>

    <div id="loginModal" class="modal" onclick="closeModal(event, 'loginModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>å¸³è™Ÿç™»å…¥</h3>
            <input type="number" id="stuId" placeholder="åº§è™Ÿ (ä¾‹å¦‚ 05)">
            <input type="password" id="stuPw" placeholder="å¯†ç¢¼">
            <button onclick="doLogin()">ç¢ºèªç™»å…¥</button>
        </div>
    </div>

    <div id="regModal" class="modal" onclick="closeModal(event, 'regModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>å­¸ç”Ÿè¨»å†Š</h3>
            <p style="font-size:0.8rem; color: #666;">è¨»å†Šå¾Œå¦‚éœ€æ¬Šé™è«‹æ´½è€å¸«</p>
            <input type="number" id="regId" placeholder="åº§è™Ÿ">
            <input type="text" id="regName" placeholder="å§“å">
            <input type="password" id="regPw" placeholder="è¨­å®šå¯†ç¢¼">
            <button onclick="doRegister()" style="background:var(--s)">è¨»å†Šå¸³è™Ÿ</button>
        </div>
    </div>

    <div id="adminModal" class="modal" onclick="closeModal(event, 'adminModal')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 450px;">
            <h3>âš™ï¸ ç­ç´šç®¡ç†</h3>
            <div id="adminList" style="max-height: 350px; overflow-y: auto; text-align: left;"></div>
            <button onclick="document.getElementById('adminModal').style.display='none'" style="background:#666">é—œé–‰</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ç™»å…¥ç‹€æ…‹æª¢æŸ¥
        function checkAuth(url) {
            if (sessionStorage.getItem('user')) {
                location.href = url;
            } else {
                alert("ğŸ”’ æ­¤åŠŸèƒ½éœ€ç™»å…¥å¾Œä½¿ç”¨ï¼Œè«‹å…ˆç™»å…¥å¸³è™Ÿã€‚");
                openModal('loginModal');
            }
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }

        async function doLogin() {
            const idInput = document.getElementById('stuId').value;
            const pw = document.getElementById('stuPw').value;
            if(!idInput || !pw) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

            const id = idInput.padStart(2, '0');
            try {
                const doc = await db.collection("students").doc(id).get();
                if (doc.exists && doc.data().password === pw) {
                    const userData = { id, ...doc.data() };
                    sessionStorage.setItem('user', JSON.stringify(userData));
                    updateUI();
                    document.getElementById('loginModal').style.display = 'none';
                    alert("ç™»å…¥æˆåŠŸï¼");
                } else {
                    alert("åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
                }
            } catch (e) { alert("ç™»å…¥å¤±æ•—ï¼š" + e.message); }
        }

        async function doRegister() {
            const idInput = document.getElementById('regId').value;
            const name = document.getElementById('regName').value;
            const pw = document.getElementById('regPw').value;
            if(!idInput || !name || !pw) return alert("è«‹å¡«å¯«å®Œæ•´è¨»å†Šè³‡æ–™");

            const id = idInput.padStart(2, '0');
            try {
                await db.collection("students").doc(id).set({
                    name: name,
                    password: pw,
                    role: "student", // è¨»å†Šé è¨­çš†ç‚ºå­¸ç”Ÿ
                    subject_role: "ç„¡"
                });
                alert("è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨åº§è™Ÿç™»å…¥ã€‚");
                document.getElementById('regModal').style.display = 'none';
            } catch (e) { alert("è¨»å†Šå¤±æ•—ï¼š" + e.message); }
        }

        function updateUI() {
            const userStr = sessionStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                document.getElementById('userNameDisplay').innerText = `ğŸ‘‹ ${user.name}`;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('regBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                if (user.role === 'teacher' || user.role === 'admin') {
                    document.getElementById('adminBtn').style.display = 'block';
                    loadAdminData();
                }
            }
        }

        function loadAdminData() {
            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
                const list = document.getElementById('adminList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `
                        <div class="stu-list-item">
                            <span><b>${doc.id}</b> ${d.name}</span>
                            <div>
                                <select onchange="updateSubRole('${doc.id}', this.value)" style="font-size:0.7rem;">
                                    <option value="ç„¡" ${d.subject_role==='ç„¡'?'selected':''}>è·ä½</option>
                                    <option value="åœ‹æ–‡" ${d.subject_role==='åœ‹æ–‡'?'selected':''}>åœ‹æ–‡</option>
                                    <option value="è‹±æ–‡" ${d.subject_role==='è‹±æ–‡'?'selected':''}>è‹±æ–‡</option>
                                    <option value="æ•¸å­¸" ${d.subject_role==='æ•¸å­¸'?'selected':''}>æ•¸å­¸</option>
                                </select>
                                <button onclick="deleteAccount('${doc.id}')" style="background:red; color:white; border:none; padding:3px 6px; border-radius:5px; font-size:0.7rem;">åˆªé™¤</button>
                            </div>
                        </div>`;
                });
            });
        }

        async function updateSubRole(sid, role) {
            await db.collection("students").doc(sid).update({ subject_role: role });
        }

        async function deleteAccount(sid) {
            if(confirm(`ç¢ºå®šè¦ç§»é™¤åº§è™Ÿ ${sid} çš„å¸³è™Ÿå—ï¼Ÿ`)) await db.collection("students").doc(sid).delete();
        }

        function logout() {
            sessionStorage.clear();
            location.reload();
        }

        window.onload = updateUI;
    </script>
</body>
</html>
