<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæŠ•ç¥¨ç³»çµ±</title>
    <style>
        :root { --primary: #4361ee; --bg: #f0f2f5; --card: #ffffff; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; }
        
        /* é®ç½© */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:2000; text-align:center; padding:20px; box-sizing:border-box; }
        
        .container { width: 100%; max-width: 500px; padding: 20px; display: none; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        h2 { color: var(--primary); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .vote-item { margin-bottom: 20px; }
        .label-group { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; }
        
        /* æŠ•ç¥¨é•·æ¢åœ– */
        .progress-bg { background: #e9ecef; height: 35px; border-radius: 10px; overflow: hidden; cursor: pointer; position: relative; border: 1px solid #ddd; }
        .progress-fill { background: var(--primary); height: 100%; transition: width 0.6s cubic-bezier(0.17, 0.67, 0.83, 0.67); width: 0%; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 35px; color: #333; font-size: 0.9rem; pointer-events: none; }

        /* è€å¸«é¢æ¿ */
        .admin-panel { margin-top: 30px; padding: 15px; background: #2c3e50; color: white; border-radius: 12px; display: none; }
        button { cursor: pointer; border: none; border-radius: 5px; transition: 0.3s; }
        .btn-login { padding: 15px 40px; background: #4285F4; color: white; font-size: 1.1rem; }
        .btn-admin { padding: 8px 15px; background: #e74c3c; color: white; margin-top: 10px; }
        .tab-group { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex:1; padding: 10px; background: #ddd; }
        .tab-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div id="loginOverlay" class="overlay">
    <h2>ğŸ—³ï¸ ç­ç´šè¡¨æ±ºç³»çµ±</h2>
    <p>è«‹å…ˆç™»å…¥ä»¥é€²è¡ŒæŠ•ç¥¨</p>
    <button class="btn-login" onclick="signIn()">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<div id="unboundOverlay" class="overlay" style="display:none; background:#fff5f5;">
    <h2 style="color:#c0392b;">âš ï¸ æ¬Šé™ä¸è¶³</h2>
    <p id="userMail"></p>
    <p>è€å¸«å°šæœªå°‡æ‚¨åŠ å…¥ç­ç´šæ¸…å–®ï¼Œè«‹å‘ŠçŸ¥è€å¸«ã€‚</p>
    <button onclick="signOut()" style="padding:10px; background:#666; color:white;">ç™»å‡º</button>
</div>

<div class="container" id="mainApp">
    <div class="tab-group" id="teacherTabs" style="display:none;">
        <button id="tabA" class="tab-btn" onclick="switchClass('ClassA')">ç”²ç­æŠ•ç¥¨</button>
        <button id="tabB" class="tab-btn" onclick="switchClass('ClassB')">ä¹™ç­æŠ•ç¥¨</button>
    </div>

    <div class="card">
        <h2 id="voteTitle">è¼‰å…¥ä¸­...</h2>
        <div id="optionsList">
            </div>
        <p id="totalInfo" style="text-align:right; color:#888; font-size:0.8rem;"></p>
    </div>

    <div id="adminPanel" class="admin-panel">
        <strong>ğŸ› ï¸ è€å¸«æ§åˆ¶å°</strong><br>
        <button class="btn-admin" onclick="createNewVote()">ç™¼èµ·æ–°æŠ•ç¥¨é …ç›®</button>
        <button class="btn-admin" style="background:#f1c40f; color:#333;" onclick="toggleStudentManager()">ç®¡ç†å­¸ç”Ÿåå–®</button>
        <div id="studentList" style="margin-top:10px; font-size:0.8rem; border-top:1px solid #555; padding-top:10px; display:none;"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>

<script>
    // --- âš ï¸ è«‹è²¼ä¸Šæ‚¨çš„ Firebase Config ---
    const firebaseConfig = {
        apiKey: "æ‚¨çš„apiKey",
        authDomain: "æ‚¨çš„å°ˆæ¡ˆ.firebaseapp.com",
        projectId: "æ‚¨çš„å°ˆæ¡ˆID",
        storageBucket: "æ‚¨çš„å°ˆæ¡ˆ.appspot.com",
        messagingSenderId: "æ‚¨çš„ID",
        appId: "æ‚¨çš„appId"
    };

    const TEACHER_EMAIL = "automail@gmail.com"; 

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    let currentUser = null;
    let currentClass = null;
    let voteListener = null;

    function signIn() { auth.signInWithRedirect(provider); }
    function signOut() { auth.signOut().then(() => location.reload()); }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginOverlay').style.display = 'none';
            // é ç™»éŒ„ä½¿ç”¨è€…è³‡è¨Š
            await db.collection("users").doc(user.email).set({
                name: user.displayName, email: user.email
            }, { merge: true });
            
            checkPermission();
        }
    });

    function checkPermission() {
        db.collection("users").doc(currentUser.email).onSnapshot(doc => {
            const data = doc.data();
            if (currentUser.email === TEACHER_EMAIL) {
                showApp(true);
                if (!currentClass) switchClass('ClassA');
                loadStudentManager();
            } else if (data && data.class) {
                showApp(false);
                switchClass(data.class);
            } else {
                document.getElementById('unboundOverlay').style.display = 'flex';
                document.getElementById('userMail').innerText = currentUser.email;
            }
        });
    }

    function showApp(isAdmin) {
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('unboundOverlay').style.display = 'none';
        if (isAdmin) {
            document.getElementById('teacherTabs').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'block';
        }
    }

    function switchClass(cls) {
        currentClass = cls;
        if (currentUser.email === TEACHER_EMAIL) {
            document.getElementById('tabA').className = cls === 'ClassA' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tabB').className = cls === 'ClassB' ? 'tab-btn active' : 'tab-btn';
        }
        startVoteListener();
    }

    function startVoteListener() {
        if (voteListener) voteListener();
        voteListener = db.collection("votes").doc(currentClass).onSnapshot(doc => {
            const list = document.getElementById('optionsList');
            const title = document.getElementById('voteTitle');
            if (!doc.exists) {
                title.innerText = "ç›®å‰ç„¡é€²è¡Œä¸­è¡¨æ±º";
                list.innerHTML = "";
                return;
            }
            const data = doc.data();
            title.innerText = data.title;
            list.innerHTML = "";
            const total = (data.voters || []).length;
            document.getElementById('totalInfo').innerText = `ç¸½æŠ•ç¥¨æ•¸ï¼š${total} ç¥¨`;

            data.options.forEach(opt => {
                const count = data.counts[opt] || 0;
                const pct = total === 0 ? 0 : Math.round(count/total*100);
                const item = document.createElement('div');
                item.className = 'vote-item';
                item.innerHTML = `
                    <div class="label-group"><span>${opt}</span><span>${count} ç¥¨</span></div>
                    <div class="progress-bg" onclick="vote('${opt}')">
                        <div class="progress-fill" style="width: ${pct}%"></div>
                        <div class="progress-text">${pct}%</div>
                    </div>`;
                list.appendChild(item);
            });
        });
    }

    async function vote(opt) {
        const ref = db.collection("votes").doc(currentClass);
        const doc = await ref.get();
        const data = doc.data();
        if ((data.voters || []).includes(currentUser.email)) return alert("æ‚¨å·²æŠ•éç¥¨é …ç›®ï¼");
        
        const newCounts = {...data.counts};
        newCounts[opt] = (newCounts[opt] || 0) + 1;
        await ref.update({
            counts: newCounts,
            voters: firebase.firestore.FieldValue.arrayUnion(currentUser.email)
        });
    }

    // è€å¸«åŠŸèƒ½
    function createNewVote() {
        const title = prompt("è«‹è¼¸å…¥è¡¨æ±ºé¡Œç›®ï¼š", "ä»Šå¤©åˆé¤åƒä»€éº¼ï¼Ÿ");
        if (!title) return;
        const optStr = prompt("è«‹è¼¸å…¥é¸é …ï¼ˆç”¨é€—è™Ÿéš”é–‹ï¼‰ï¼š", "æ’éª¨é£¯,é›è…¿é£¯,ä¹¾éºµ");
        if (!optStr) return;
        const options = optStr.split(",").map(s => s.trim());
        const counts = {};
        options.forEach(o => counts[o] = 0);
        db.collection("votes").doc(currentClass).set({ title, options, counts, voters: [] });
    }

    function loadStudentManager() {
        db.collection("users").onSnapshot(snap => {
            const container = document.getElementById('studentList');
            container.innerHTML = "<strong>åå–®ç®¡ç† (é»æ“Šåˆ†é…ç­ç´š)ï¼š</strong><br>";
            snap.forEach(doc => {
                const u = doc.data();
                if (u.email === TEACHER_EMAIL) return;
                const div = document.createElement('div');
                div.style = "margin: 5px 0; display:flex; justify-content:space-between;";
                div.innerHTML = `<span>${u.name || u.email} [${u.class || 'æœªåˆ†'}]</span>
                    <span>
                        <button onclick="assignClass('${u.email}','ClassA')">ç”²</button>
                        <button onclick="assignClass('${u.email}','ClassB')">ä¹™</button>
                    </span>`;
                container.appendChild(div);
            });
        });
    }
    function assignClass(email, cls) { db.collection("users").doc(email).update({ class: cls }); }
    function toggleStudentManager() {
        const d = document.getElementById('studentList');
        d.style.display = d.style.display === 'none' ? 'block' : 'none';
    }
</script>
</body>
</html>
