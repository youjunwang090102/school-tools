<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>限時投票系統</title>
    <style>
        :root { --primary: #4361ee; --error: #e74c3c; --bg: #f8f9fa; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; width: 100%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .timer { text-align: center; color: var(--error); font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }
        
        #nameSection { margin-bottom: 20px; text-align: center; }
        input[type="text"], input[type="datetime-local"] { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; }
        
        .vote-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 12px; background: white; cursor: pointer; position: relative; overflow: hidden; font-weight: bold; transition: 0.3s; }
        .vote-btn:disabled { cursor: not-allowed; opacity: 0.6; background: #f9f9f9; }
        .progress { position: absolute; left: 0; top: 0; height: 100%; background: rgba(67, 97, 238, 0.1); transition: width 0.5s; }
        .btn-text { position: relative; z-index: 1; display: flex; justify-content: space-between; }

        .admin-panel { margin-top: 30px; padding: 15px; background: #333; color: white; border-radius: 15px; display: none; }
        .control-btn { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="voteTitle" style="text-align:center;">載入投票中...</h2>
    <div id="countdown" class="timer"></div>

    <div id="nameSection">
        <input type="text" id="userName" placeholder="輸入姓名/座號以投票">
    </div>

    <div id="optionsList"></div>
    <p id="statusMsg" style="text-align:center; font-size:0.9rem;"></p>

    <button onclick="document.getElementById('adminArea').style.display='block'" style="background:none; border:none; color:#ccc; font-size:0.7rem; margin-top:20px; width:100%;">⚙️ 管理端</button>
    
    <div id="adminArea" class="admin-panel">
        <h3>發起新表決</h3>
        <input type="text" id="newTitle" placeholder="題目">
        <input type="text" id="newOptions" placeholder="選項 (用逗號隔開)">
        <label>截止時間：</label>
        <input type="datetime-local" id="endTime">
        <button class="control-btn" onclick="publishVote()">發布投票</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        // ⚠️ 請務必貼上您的正確 Config
        apiKey: "...",
        authDomain: "...",
        projectId: "...",
        storageBucket: "...",
        messagingSenderId: "...",
        appId: "..."
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let timerInterval;

    // 1. 監聽最新的投票
    db.collection("votes").orderBy("createdAt", "desc").limit(1).onSnapshot(snap => {
        if (snap.empty) return;
        const doc = snap.docs[0];
        const data = doc.data();
        const voteId = doc.id;
        
        renderVote(voteId, data);
        startTimer(data.endTime);
    });

    function renderVote(id, data) {
        document.getElementById('voteTitle').innerText = data.title;
        const list = document.getElementById('optionsList');
        list.innerHTML = "";
        
        const total = (data.voters || []).length;
        const isExpired = data.endTime < Date.now();

        data.options.forEach(opt => {
            const count = data.counts[opt] || 0;
            const pct = total === 0 ? 0 : Math.round(count/total*100);
            
            const btn = document.createElement('button');
            btn.className = 'vote-btn';
            btn.disabled = isExpired || localStorage.getItem('voted_' + id);
            btn.onclick = () => castVote(id, opt);
            btn.innerHTML = `
                <div class="progress" style="width: ${pct}%"></div>
                <div class="btn-text"><span>${opt}</span><span>${count} 票 (${pct}%)</span></div>
            `;
            list.appendChild(btn);
        });
    }

    function startTimer(endTime) {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const now = Date.now();
            const diff = endTime - now;
            if (diff <= 0) {
                document.getElementById('countdown').innerText = "❌ 投票已截止";
                clearInterval(timerInterval);
            } else {
                const min = Math.floor(diff / 60000);
                const sec = Math.floor((diff % 60000) / 1000);
                document.getElementById('countdown').innerText = `⏳ 剩餘時間：${min}分${sec}秒`;
            }
        }, 1000);
    }

    async function castVote(id, opt) {
        const name = document.getElementById('userName').value.trim();
        if (!name) return alert("請輸入姓名！");

        const ref = db.collection("votes").doc(id);
        const doc = await ref.get();
        if (doc.data().voters.includes(name)) return alert("此姓名已投過！");

        const newCounts = {...doc.data().counts};
        newCounts[opt]++;
        
        await ref.update({
            counts: newCounts,
            voters: firebase.firestore.FieldValue.arrayUnion(name)
        });
        localStorage.setItem('voted_' + id, 'true');
    }

    async function publishVote() {
        const title = document.getElementById('newTitle').value;
        const opts = document.getElementById('newOptions').value.split(',').map(s=>s.trim());
        const end = new Date(document.getElementById('endTime').value).getTime();
        
        if (!title || !opts || !end) return alert("資料不完整");

        const counts = {};
        opts.forEach(o => counts[o] = 0);

        await db.collection("votes").add({
            title, options: opts, counts, voters: [],
            endTime: end, createdAt: Date.now()
        });
        alert("發布成功！");
    }
</script>
</body>
</html>
