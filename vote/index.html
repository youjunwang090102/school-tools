<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæŠ•ç¥¨å¤§å»³</title>
    <style>
        :root { --primary: #4361ee; --success: #2ec4b6; --expired: #adb5bd; --bg: #f0f2f5; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        .header { text-align: center; margin-bottom: 20px; }
        
        /* æŠ•ç¥¨å¡ç‰‡æ¨£å¼ */
        .vote-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; border-left: 8px solid var(--expired); }
        .active-vote { border-left-color: var(--primary); transform: scale(1.02); box-shadow: 0 8px 20px rgba(67, 97, 238, 0.15); }
        
        .vote-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .timer-tag { font-size: 0.85rem; color: #e74c3c; font-weight: bold; margin-bottom: 15px; }
        
        .opt-row { margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; padding: 10px; position: relative; overflow: hidden; }
        .opt-progress { position: absolute; left: 0; top: 0; height: 100%; background: rgba(67, 97, 238, 0.1); transition: width 0.5s; }
        .opt-text { position: relative; z-index: 1; display: flex; justify-content: space-between; font-size: 0.9rem; }
        
        .vote-input-group { display: flex; gap: 5px; margin-top: 15px; }
        input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        .btn-go { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

        /* è€å¸«æŸ¥çœ‹å€ */
        .admin-view { margin-top: 10px; font-size: 0.8rem; background: #eee; padding: 10px; border-radius: 5px; display: none; color: #444; }
        
        /* ç®¡ç†é¢æ¿ */
        #adminPanel { display: none; background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ—³ï¸ ç­ç´šæŠ•ç¥¨å¤§å»³</h2>
        <p>è«‹é¸æ“‡æŠ•ç¥¨ä¸»é¡Œ</p>
        <button onclick="openAdmin()" style="font-size: 10px; color: #ccc; background: none; border: none;">ç®¡ç†å…¥å£</button>
    </div>

    <div id="adminPanel">
        <h3>ç™¼å¸ƒæ–°æŠ•ç¥¨</h3>
        <input type="text" id="newTitle" placeholder="é¡Œç›®">
        <input type="text" id="newOptions" placeholder="é¸é … (é€—è™Ÿéš”é–‹)">
        <input type="datetime-local" id="endTime">
        <button onclick="publishVote()" class="btn-go" style="width:100%; margin-top:10px;">ç¢ºèªç™¼å¸ƒ</button>
    </div>

    <div id="voteList">æ­£åœ¨è¼‰å…¥æŠ•ç¥¨æ¸…å–®...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d",
        measurementId: "G-R2R6XEDP6C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const ADMIN_PWD = "888"; 

    // 1. ç›£è½æ‰€æœ‰æŠ•ç¥¨ï¼ŒæŒ‰æ™‚é–“æ’åº
    db.collection("votes").orderBy("createdAt", "desc").onSnapshot(snap => {
        const listDiv = document.getElementById('voteList');
        listDiv.innerHTML = "";
        
        snap.forEach((doc, index) => {
            const data = doc.data();
            const id = doc.id;
            const isLatest = index === 0;
            const isExpired = data.endTime < Date.now();
            
            const card = document.createElement('div');
            card.className = `vote-card ${(!isExpired && isLatest) ? 'active-vote' : ''}`;
            
            // è¨ˆç®—ç™¾åˆ†æ¯”
            const total = (data.voters || []).length;
            let optionsHTML = "";
            data.options.forEach(opt => {
                const count = data.counts[opt] || 0;
                const pct = total === 0 ? 0 : Math.round(count/total*100);
                optionsHTML += `
                    <div class="opt-row" onclick="castVote('${id}', '${opt}')">
                        <div class="opt-progress" style="width: ${pct}%"></div>
                        <div class="opt-text"><span>${opt}</span><span>${count} ç¥¨ (${pct}%)</span></div>
                    </div>`;
            });

            // è€å¸«ç§çœ‹åå–®
            let votersList = (data.voters || []).map(v => `${v.name}(${v.choice})`).join(', ');

            card.innerHTML = `
                <div class="vote-title">${isExpired ? '[å·²çµæŸ] ' : ''}${data.title}</div>
                <div class="timer-tag" id="timer-${id}">è¼‰å…¥æ™‚é–“ä¸­...</div>
                <div id="opts-${id}">${optionsHTML}</div>
                
                ${!isExpired ? `
                <div class="vote-input-group">
                    <input type="text" id="name-${id}" placeholder="è¼¸å…¥åå­—å¾Œé»æ“Šä¸Šæ–¹é¸é …">
                </div>` : ''}

                <div class="admin-view" id="details-${id}">
                    <strong>è€å¸«å°ˆç”¨åå–®ï¼š</strong><br>${votersList || 'å°šç„¡äººæŠ•ç¥¨'}
                </div>
                <button onclick="showDetails('${id}')" style="margin-top:10px; font-size:10px; color:gray; background:none; border:none; cursor:pointer;">é¡¯ç¤º/éš±è—æŠ•ç¥¨åå–® (éœ€å¯†ç¢¼)</button>
            `;
            listDiv.appendChild(card);
            updateTimer(id, data.endTime);
        });
    });

    function updateTimer(id, endTime) {
        const el = document.getElementById(`timer-${id}`);
        const itv = setInterval(() => {
            const diff = endTime - Date.now();
            if (diff <= 0) {
                el.innerText = "ğŸ›‘ æŠ•ç¥¨å·²æˆªæ­¢";
                clearInterval(itv);
            } else {
                const m = Math.floor(diff/60000);
                const s = Math.floor((diff%60000)/1000);
                el.innerText = `â³ å‰©é¤˜æ™‚é–“ï¼š${m}åˆ†${s}ç§’`;
            }
        }, 1000);
    }

    async function castVote(voteId, option) {
        const nameInput = document.getElementById(`name-${voteId}`);
        if (!nameInput) return; // å·²æˆªæ­¢
        const name = nameInput.value.trim();
        if (!name) return alert("è«‹è¼¸å…¥åå­—å†é»æ“Šé¸é …ï¼");
        if (localStorage.getItem('voted_'+voteId)) return alert("é€™é …æŠ•ç¥¨ä½ å·²ç¶“æŠ•éå›‰ï¼");

        const ref = db.collection("votes").doc(voteId);
        const doc = await ref.get();
        const data = doc.data();

        if (data.voters.some(v => v.name === name)) return alert("åå­—é‡è¤‡äº†ï¼");

        const newCounts = {...data.counts};
        newCounts[option]++;
        
        await ref.update({
            counts: newCounts,
            voters: firebase.firestore.FieldValue.arrayUnion({ name, choice: option })
        });
        localStorage.setItem('voted_'+voteId, 'true');
        alert("æŠ•ç¥¨æˆåŠŸï¼");
    }

    function openAdmin() {
        if (prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼") === ADMIN_PWD) {
            document.getElementById('adminPanel').style.display = 'block';
        }
    }

    function showDetails(id) {
        const el = document.getElementById(`details-${id}`);
        if (el.style.display === 'block') {
            el.style.display = 'none';
        } else {
            if (prompt("æŸ¥çœ‹è©³ç´°åå–®è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼") === ADMIN_PWD) {
                el.style.display = 'block';
            }
        }
    }

    async function publishVote() {
        const title = document.getElementById('newTitle').value;
        const opts = document.getElementById('newOptions').value.split(',');
        const end = new Date(document.getElementById('endTime').value).getTime();
        const counts = {};
        opts.forEach(o => counts[o.trim()] = 0);

        await db.collection("votes").add({
            title, options: opts.map(o=>o.trim()), counts, voters: [],
            endTime: end, createdAt: Date.now()
        });
        document.getElementById('adminPanel').style.display = 'none';
    }
</script>
</body>
</html>
