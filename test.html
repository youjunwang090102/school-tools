<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina macOS Sequoia | æ¬Šå¨ç´šæŠ•ç¥¨ç³»çµ±</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- macOS Design System (San Francisco Font & Colors) --- */
        :root {
            --window-bg: rgba(255, 255, 255, 0.75);
            --window-border: rgba(255, 255, 255, 0.3);
            --accent: #007AFF;
            --text-main: #1d1d1f;
            --text-dim: #86868b;
            --glass: blur(30px) saturate(180%);
            --shadow: 0 20px 60px rgba(0,0,0,0.2);
            --spring: cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Arial, sans-serif; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; overflow: hidden; color: var(--text-main);
        }

        /* macOS å‹•æ…‹æ¡Œå¸ƒèƒŒæ™¯ */
        .desktop-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(135deg, #FF9A9E 0%, #FAD0C4 20%, #A18CD1 50%, #FBC2EB 80%, #84FAB0 100%);
            background-size: 400% 400%;
            animation: fluidBG 20s ease infinite;
        }
        @keyframes fluidBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- macOS è¦–çª—ç³»çµ± --- */
        .window {
            position: absolute; background: var(--window-bg); backdrop-filter: var(--glass);
            border: 1px solid var(--window-border); border-radius: 12px;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
            overflow: hidden; transition: transform 0.3s var(--spring), opacity 0.3s;
            z-index: 10;
        }
        
        /* æ¨™é¡Œåˆ— */
        .title-bar {
            height: 44px; display: flex; align-items: center; padding: 0 15px;
            cursor: grab; user-select: none; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .title-bar:active { cursor: grabbing; }
        .traffic-lights { display: flex; gap: 8px; margin-right: 20px; }
        .light { width: 12px; height: 12px; border-radius: 50%; }
        .red { background: #FF5F57; } .yellow { background: #FEBC2E; } .green { background: #28C840; }
        .title-text { font-size: 13px; font-weight: 600; color: #444; flex: 1; text-align: center; margin-right: 50px; }

        /* å…§å®¹å€å¡Š */
        .content-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        .sidebar-view { width: 180px; background: rgba(0,0,0,0.03); border-right: 1px solid rgba(0,0,0,0.05); padding: 20px 10px; }
        .main-view { flex: 1; padding: 30px; display: flex; flex-direction: column; position: relative; }

        /* --- UI å…ƒä»¶ --- */
        .apple-input {
            background: #FFF; border: 1px solid #d2d2d7; padding: 10px 12px;
            border-radius: 8px; font-size: 14px; width: 100%; transition: 0.2s;
            margin-bottom: 10px;
        }
        .apple-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 4px rgba(0,122,255,0.1); }

        .apple-btn {
            background: linear-gradient(180deg, #5AC8FA 0%, #007AFF 100%);
            color: white; border: none; padding: 8px 16px; border-radius: 8px;
            font-size: 14px; font-weight: 500; cursor: pointer; transition: 0.2s;
        }
        .apple-btn:hover { filter: brightness(1.1); }
        .apple-btn:active { transform: scale(0.98); }

        /* --- macOS Dock --- */
        .dock-container {
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(20px);
            padding: 8px; border-radius: 20px; display: flex; gap: 12px;
            border: 1px solid rgba(255,255,255,0.2); z-index: 1000;
        }
        .dock-icon {
            width: 50px; height: 50px; background: #FFF; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .dock-icon:hover { transform: translateY(-15px) scale(1.2); }
        .dock-dot { width: 4px; height: 4px; background: #333; border-radius: 50%; margin-top: 2px; }

        /* --- æ•¸æ“šåœ–èˆ‡é€šçŸ¥ --- */
        #chart-container { flex: 1; min-height: 0; margin-top: 20px; position: relative; }
        
        .notification {
            position: fixed; top: 20px; right: 20px; width: 320px;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
            border-radius: 18px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 9999; animation: slideIn 0.5s var(--spring);
        }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* --- å­¸ç”Ÿç«¯å°ˆç”¨ï¼šå½ iOS ä»‹é¢ --- */
        .ios-shell {
            width: 100%; height: 100%; display: none; flex-direction: column;
            background: #F2F2F7;
        }
        .ios-header { padding: 50px 20px 20px; background: #FFF; border-bottom: 1px solid #d2d2d7; }
        .ios-content { flex: 1; overflow-y: auto; padding: 20px; }
        .ios-card { background: #FFF; border-radius: 14px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .hidden { display: none !important; }
        .scroll-v { overflow-y: auto; max-height: 300px; padding-right: 5px; }
        .scroll-v::-webkit-scrollbar { width: 6px; }
        .scroll-v::-webkit-scrollbar-thumb { background: #d2d2d7; border-radius: 10px; }

        /* ä¿®æ­£é‡ç–Šå•é¡Œï¼šçµ±è¨ˆåˆ— */
        .mac-stats-bar {
            display: flex; gap: 30px; margin-top: 20px; padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .stat-box { display: flex; flex-direction: column; }
        .stat-val { font-size: 24px; font-weight: 700; color: var(--accent); }
        .stat-lbl { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }

    </style>
</head>
<body>

<div class="desktop-bg"></div>

<div id="desktop-icons" style="padding: 40px; display: grid; gap: 30px; justify-items: center; width: fit-content;">
    <div class="dock-icon" onclick="openWindow('teacher-win')" style="width: 70px; height: 70px; font-size: 40px;">ğŸ‘¨â€ğŸ«</div>
    <div style="color: white; font-size: 12px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Teacher Center</div>
    
    <div class="dock-icon" onclick="openStudentLogin()" style="width: 70px; height: 70px; font-size: 40px;">ğŸ“±</div>
    <div style="color: white; font-size: 12px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Student Join</div>
</div>

<div id="teacher-win" class="window hidden" style="width: 900px; height: 600px; top: 10%; left: 15%;">
    <div class="title-bar" onmousedown="dragStart(event, 'teacher-win')">
        <div class="traffic-lights">
            <div class="light red" onclick="closeWindow('teacher-win')"></div>
            <div class="light yellow"></div>
            <div class="light green"></div>
        </div>
        <div class="title-text">Lumina Center â€” Finder</div>
    </div>
    <div class="content-area" style="flex-direction: row;">
        <div class="sidebar-view">
            <div style="font-size: 11px; font-weight: 700; color: #888; margin-left: 10px; margin-bottom: 10px;">FAVORITES</div>
            <div id="side-ctrl" class="apple-btn" style="background: rgba(0,122,255,0.1); color: var(--accent); width: 100%; text-align: left; margin-bottom: 5px;" onclick="switchTab('ctrl')">ğŸ”˜ æ§åˆ¶é¢æ¿</div>
            <div id="side-data" class="apple-btn" style="background: transparent; color: #444; width: 100%; text-align: left;" onclick="switchTab('data')">ğŸ“Š å¯¦æ™‚æ•¸æ“š</div>
        </div>

        <div id="tab-ctrl" class="main-view">
            <h2 style="margin: 0 0 20px 0;">æŠ•ç¥¨ä»»å‹™é…ç½®</h2>
            
            <div class="scroll-v" style="flex: 1;">
                <label style="font-size: 12px; font-weight: 600;">æ ¸å¿ƒé¡Œç›® (Topic)</label>
                <input type="text" id="t-input-topic" class="apple-input" placeholder="è¼¸å…¥ä½ æƒ³å•çš„å•é¡Œ..." oninput="syncToMain()">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px;">
                    <label style="font-size: 12px; font-weight: 600;">é¸é …è¨­å®š (Options)</label>
                    <button class="apple-btn" onclick="addOption()" style="padding: 4px 10px; font-size: 12px;">+ æ–°å¢</button>
                </div>
                <div id="t-opt-list"></div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 20px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label style="font-size: 12px;">è¨ˆæ™‚ (åˆ†:ç§’)</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="t-min" class="apple-input" value="1" style="margin:0">
                        <input type="number" id="t-sec" class="apple-input" value="0" style="margin:0">
                    </div>
                </div>
                <button id="btn-start" class="apple-btn" style="height: 42px; padding: 0 40px;" onclick="startSession()">ğŸš€ å•Ÿå‹•æŠ•ç¥¨</button>
                <button id="btn-stop" class="apple-btn hidden" style="height: 42px; background: #FF3B30;" onclick="endSession()">ğŸ›‘ çµ‚æ­¢</button>
            </div>
        </div>

        <div id="tab-data" class="main-view hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="display-topic" style="margin: 0;">ç­‰å¾…æŠ•ç¥¨é–‹å§‹...</h2>
                <div id="display-timer" style="font-family: monospace; font-size: 24px; font-weight: 700;">01:00</div>
            </div>

            <div id="chart-container">
                <canvas id="mainChart"></canvas>
            </div>

            <div class="mac-stats-bar">
                <div class="stat-box">
                    <span class="stat-lbl">Room Code</span>
                    <span class="stat-val" id="room-code-val">----</span>
                </div>
                <div class="stat-box">
                    <span class="stat-lbl">Total Votes</span>
                    <span class="stat-val" id="stat-voted">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-lbl">Participants</span>
                    <span class="stat-val" id="stat-online">0</span>
                </div>
                <div style="flex: 1; text-align: right;">
                    <canvas id="qr-code" style="width: 60px; height: 60px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="student-ios" class="ios-shell">
    <div class="ios-header">
        <h1 id="s-topic" style="margin: 0; font-size: 28px; letter-spacing: -1px;">Lumina</h1>
        <div id="s-status" style="font-size: 13px; color: var(--accent); margin-top: 5px;">é€£ç·šä¸­...</div>
    </div>
    <div class="ios-content">
        <div class="ios-card" style="text-align: center;">
            <div id="s-timer" style="font-size: 48px; font-weight: 800; color: #1d1d1f;">00:00</div>
            <div style="font-size: 12px; color: #888; text-transform: uppercase;">Time Remaining</div>
        </div>
        
        <div id="s-options-grid"></div>

        <div id="s-result-view" class="hidden">
            <h3 style="margin: 30px 0 15px;">æŠ•ç¥¨çµ±è¨ˆçµæœ</h3>
            <div id="s-res-data"></div>
        </div>
    </div>
</div>

<div class="dock-container">
    <div class="dock-icon" title="Teacher Control" onclick="openWindow('teacher-win')">ğŸ</div>
    <div class="dock-icon" title="Browser" style="filter: hue-rotate(180deg);">ğŸŒ</div>
    <div class="dock-icon" title="System Settings">âš™ï¸</div>
    <div style="width: 1px; height: 30px; background: rgba(0,0,0,0.1); margin: 0 5px;"></div>
    <div class="dock-icon" title="Trash">ğŸ—‘ï¸</div>
</div>

<div id="notif-area"></div>

<script>
/**
 * Lumina macOS Sequoia æ——è‰¦åŸå§‹ç¢¼
 * é–‹ç™¼è€…ï¼šç¶²é è¨­è¨ˆæ¬Šå¨ Gemini
 */

let peer, conn, myChart, timerInt;
let state = {
    roomID: '',
    topic: 'æ‚¨å°ä»Šæ—¥èª²ç¨‹çš„æŒæ¡ç¨‹åº¦ï¼Ÿ',
    options: ['å®Œå…¨ç†è§£', 'ç•¥æ‡‚ä¸€äºŒ', 'é‚„åœ¨æ€è€ƒ', 'éœ€è¦å”åŠ©'],
    votes: {},
    voterMap: {},
    isLive: false,
    timeLeft: '01:00',
    showResult: false,
    activeTab: 'ctrl'
};

// --- macOS è¦–çª—ç®¡ç†å¼•æ“ ---
function openWindow(id) {
    const win = document.getElementById(id);
    win.classList.remove('hidden');
    win.style.opacity = '0';
    win.style.transform = 'scale(0.9) translateY(20px)';
    setTimeout(() => {
        win.style.opacity = '1';
        win.style.transform = 'scale(1) translateY(0)';
    }, 10);
}

function closeWindow(id) {
    const win = document.getElementById(id);
    win.style.opacity = '0';
    win.style.transform = 'scale(0.9) translateY(20px)';
    setTimeout(() => win.classList.add('hidden'), 3000);
}

// è¦–çª—æ‹–æ‹½é‚è¼¯
let activeDragWin = null;
let offset = [0,0];
function dragStart(e, id) {
    activeDragWin = document.getElementById(id);
    offset = [ e.clientX - activeDragWin.offsetLeft, e.clientY - activeDragWin.offsetTop ];
    document.addEventListener('mousemove', dragMove);
    document.addEventListener('mouseup', dragEnd);
}
function dragMove(e) {
    if(!activeDragWin) return;
    activeDragWin.style.left = (e.clientX - offset[0]) + 'px';
    activeDragWin.style.top = (e.clientY - offset[1]) + 'px';
}
function dragEnd() { activeDragWin = null; }

// åˆ†é åˆ‡æ›
function switchTab(tab) {
    state.activeTab = tab;
    document.getElementById('tab-ctrl').classList.toggle('hidden', tab !== 'ctrl');
    document.getElementById('tab-data').classList.toggle('hidden', tab !== 'data');
    
    // æ›´æ–°å´é‚Šæ¬„æŒ‰éˆ•æ¨£å¼
    document.getElementById('side-ctrl').style.background = tab === 'ctrl' ? 'rgba(0,122,255,0.1)' : 'transparent';
    document.getElementById('side-ctrl').style.color = tab === 'ctrl' ? 'var(--accent)' : '#444';
    document.getElementById('side-data').style.background = tab === 'data' ? 'rgba(0,122,255,0.1)' : 'transparent';
    document.getElementById('side-data').style.color = tab === 'data' ? 'var(--accent)' : '#444';

    if(tab === 'data') setTimeout(updateChart, 100);
}

// --- æ ¸å¿ƒé€£ç·šå¼•æ“ (PeerJS) ---
function initTeacher() {
    state.roomID = Math.floor(1000 + Math.random() * 8999).toString();
    peer = new Peer('LUMINA-' + state.roomID);

    peer.on('open', () => {
        document.getElementById('room-code-val').innerText = state.roomID;
        QRCode.toCanvas(document.getElementById('qr-code'), window.location.origin + window.location.pathname + '?r=' + state.roomID);
        pushNotification("ç³»çµ±å·²ä¸Šç·š", "æ•™å¸«æŒ‡æ®ä¸­å¿ƒå·²å»ºç«‹ï¼Œæˆ¿è™Ÿ: " + state.roomID);
        renderOptions();
        initChart();
        startHeartbeat();
    });

    peer.on('connection', c => {
        pushNotification("æ–°é€£ç·š", "ä¸€ä½å­¸ç”Ÿå·²é€²å…¥æ•™å®¤çµ‚ç«¯");
        c.on('data', data => {
            if(data.type === 'vote' && state.isLive) {
                if(state.voterMap[c.peer]) state.votes[state.voterMap[c.peer]]--;
                state.voterMap[c.peer] = data.val;
                state.votes[data.val] = (state.votes[data.val] || 0) + 1;
                updateChart();
            }
        });
    });
}

function startHeartbeat() {
    setInterval(() => {
        const payload = { ...state, type: 'sync' };
        Object.values(peer.connections).forEach(conns => {
            conns.forEach(c => { if(c.open) c.send(payload); });
        });
        document.getElementById('stat-online').innerText = Object.keys(peer.connections).length;
    }, 800);
}

// --- UI æ§åˆ¶èˆ‡åœ–è¡¨ ---
function renderOptions() {
    const list = document.getElementById('t-opt-list');
    list.innerHTML = state.options.map((opt, i) => `
        <div style="display:flex; gap:10px; margin-bottom:8px;">
            <input type="text" class="apple-input" value="${opt}" oninput="state.options[${i}]=this.value" style="margin:0">
            <button class="apple-btn" style="background:#f2f2f7; color:#FF3B30;" onclick="state.options.splice(${i},1); renderOptions();">âœ•</button>
        </div>
    `).join('');
}

function addOption() {
    state.options.push("æ–°é¸é … " + (state.options.length + 1));
    renderOptions();
}

function syncToMain() {
    state.topic = document.getElementById('t-input-topic').value;
    document.getElementById('display-topic').innerText = state.topic;
}

function initChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: state.options,
            datasets: [{
                data: [],
                backgroundColor: 'rgba(0, 122, 255, 0.7)',
                borderRadius: 8,
                barThickness: 30
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false }, beginAtZero: true },
                y: { ticks: { font: { size: 14, weight: '600' } } }
            }
        }
    });
}

function updateChart() {
    if(!myChart) return;
    myChart.data.labels = state.options;
    myChart.data.datasets[0].data = state.options.map(o => state.votes[o] || 0);
    myChart.update();
    document.getElementById('stat-voted').innerText = Object.keys(state.voterMap).length;
}

function startSession() {
    state.isLive = true;
    state.showResult = false;
    state.voterMap = {};
    state.options.forEach(o => state.votes[o] = 0);
    
    document.getElementById('btn-start').classList.add('hidden');
    document.getElementById('btn-stop').classList.remove('hidden');
    switchTab('data');

    let total = (parseInt(document.getElementById('t-min').value)*60) + parseInt(document.getElementById('t-sec').value);
    timerInt = setInterval(() => {
        total--;
        let m = Math.floor(total/60).toString().padStart(2,'0');
        let s = (total%60).toString().padStart(2,'0');
        state.timeLeft = `${m}:${s}`;
        document.getElementById('display-timer').innerText = state.timeLeft;
        if(total <= 0) endSession();
    }, 1000);
}

function endSession() {
    state.isLive = false;
    state.showResult = true;
    clearInterval(timerInt);
    document.getElementById('btn-start').classList.remove('hidden');
    document.getElementById('btn-stop').classList.add('hidden');
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
}

// --- å­¸ç”Ÿç«¯ï¼šå½ iOS æ ¸å¿ƒ ---
let s_conn, s_myVote = '';
function openStudentLogin() {
    const rid = prompt("Enter 4-digit Room Code:");
    if(!rid) return;
    document.getElementById('desktop-icons').classList.add('hidden');
    document.getElementById('student-ios').style.display = 'flex';
    
    peer = new Peer();
    peer.on('open', () => {
        s_conn = peer.connect('LUMINA-' + rid);
        s_conn.on('open', () => {
            document.getElementById('s-status').innerText = "Connected to " + rid;
        });
        s_conn.on('data', data => {
            if(data.type === 'sync') syncIOS(data);
        });
    });
}

function syncIOS(data) {
    document.getElementById('s-topic').innerText = data.topic;
    document.getElementById('s-timer').innerText = data.timeLeft;
    
    const grid = document.getElementById('s-options-grid');
    const resView = document.getElementById('s-result-view');

    if(data.showResult) {
        grid.classList.add('hidden');
        resView.classList.remove('hidden');
        const total = Object.keys(data.voterMap).length || 1;
        document.getElementById('s-res-data').innerHTML = data.options.map(o => {
            const v = data.votes[o] || 0;
            const p = Math.round(v/total*100);
            return `
                <div class="ios-card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="font-weight:600;">${o}</span>
                        <span style="color:var(--accent);">${p}%</span>
                    </div>
                    <div style="height:8px; background:#F2F2F7; border-radius:10px; overflow:hidden;">
                        <div style="height:100%; width:${p}%; background:var(--accent); transition:1s;"></div>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        grid.classList.remove('hidden');
        resView.classList.add('hidden');
        grid.innerHTML = data.options.map(o => `
            <div class="ios-card" style="cursor:pointer; border:${s_myVote===o?'2px solid var(--accent)':'2px solid transparent'}" onclick="castVote('${o}', ${data.isLive})">
                <span style="font-size:17px; font-weight:500;">${o}</span>
            </div>
        `).join('');
    }
}

function castVote(v, live) {
    if(!live) return;
    s_myVote = v;
    s_conn.send({ type: 'vote', val: v });
}

function pushNotification(title, msg) {
    const n = document.createElement('div');
    n.className = 'notification';
    n.innerHTML = `<strong>${title}</strong><p style="margin:5px 0 0; font-size:13px; color:#666;">${msg}</p>`;
    document.getElementById('notif-area').appendChild(n);
    setTimeout(() => n.remove(), 5000);
}

// åˆå§‹åŒ–
window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('r')) {
        // è‡ªå‹•å•Ÿå‹•å­¸ç”Ÿé€£ç·šæ¨¡å¼
    }
    initTeacher(); // é åŠ è¼‰è€å¸«ç«¯èƒŒæ™¯é€£ç·š
};
</script>
</body>
</html>
