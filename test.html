<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina Vote OS | æ——è‰¦ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --p: #5856D6; --s: #34C759; --d: #FF3B30; --bg: #0A0A0C; --card: #1C1C1E; --glass: rgba(255,255,255,0.08); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'SF Pro Display', system-ui, sans-serif; }
        body { background: var(--bg); color: #FFF; margin: 0; overflow-x: hidden; }
        .mesh-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 20% 30%, #1e1e2f 0%, #0a0a0c 100%); }
        
        .app { max-width: 1200px; margin: auto; padding: 20px; }
        .glass { background: var(--glass); backdrop-filter: blur(30px); border: 1px solid rgba(255,255,255,0.1); border-radius: 28px; padding: 30px; margin-bottom: 20px; transition: 0.3s; }
        
        /* æŒ‰éˆ•ç³»çµ± */
        .btn { padding: 14px 24px; border-radius: 14px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: var(--p); color: white; box-shadow: 0 4px 15px rgba(88,86,214,0.4); }
        .btn-s { background: var(--s); color: white; }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); }

        /* è€å¸«ç·¨è¼¯å€ */
        .option-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: white; flex: 1; }
        
        /* çµ±è¨ˆåœ–è¡¨ */
        .chart-box { position: relative; height: 400px; width: 100%; margin-top: 20px; }
        .summary-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }

        /* å­¸ç”ŸæŠ•ç¥¨å€ */
        .stu-opt-list { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        .stu-opt-btn { padding: 25px; background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 20px; text-align: left; font-size: 20px; color: white; cursor: pointer; transition: 0.2s; }
        .stu-opt-btn.selected { border-color: var(--p); background: rgba(88,86,214,0.15); box-shadow: 0 0 20px rgba(88,86,214,0.3); }

        .badge { padding: 4px 10px; border-radius: 8px; font-size: 12px; background: rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        #qr-canvas { border-radius: 15px; background: white; padding: 10px; }
    </style>
</head>
<body>

<div class="mesh-bg"></div>

<div class="app">
    <header style="display:flex; justify-content:space-between; align-items:center; padding: 20px 0;">
        <h1 style="margin:0; font-size:24px; letter-spacing:2px;">LUMINA <span style="color:var(--p)">OS</span></h1>
        <div id="top-status" class="badge">SYSTEM READY</div>
    </header>

    <div id="v-start" class="animate__animated animate__fadeIn">
        <div class="glass" style="text-align:center; padding: 80px 20px;">
            <h1 style="font-size: 56px; margin-bottom: 10px;">å¼·å¤§çš„èª²å ‚ç¾å ´ï¼Œå¾é€™è£¡é–‹å§‹</h1>
            <p style="color:#AAA; font-size:20px; margin-bottom:40px;">å°ˆæ¥­ç´šäº’å‹•é€£ç·šæŠ•ç¥¨ç³»çµ±</p>
            <div style="display:flex; gap:20px; justify-content:center;">
                <button class="btn btn-p" onclick="initTeacher()" style="padding:20px 40px; font-size:18px;">ğŸ‘¨â€ğŸ« é–‹å•Ÿæ§åˆ¶ä¸­å¿ƒ</button>
                <button class="btn btn-outline" onclick="showView('v-stu-login')" style="padding:20px 40px; font-size:18px;">ğŸ“± å­¸ç”Ÿç«¯ç™»å…¥</button>
            </div>
        </div>
    </div>

    <div id="v-teacher" class="hidden animate__animated animate__fadeIn">
        <div style="display:grid; grid-template-columns: 1fr 350px; gap: 20px;">
            <div>
                <div class="glass">
                    <h3>1. è¨­å®šæŠ•ç¥¨é¡Œç›®èˆ‡é¸é …</h3>
                    <input type="text" id="t-topic" placeholder="è«‹è¼¸å…¥æŠ•ç¥¨å•é¡Œ..." style="font-size:20px; margin-bottom:20px;">
                    <div id="option-list">
                        </div>
                    <button class="btn btn-outline" onclick="addOptionField()">+ æ–°å¢é¸é …</button>
                </div>

                <div class="glass">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>2. å³æ™‚çµ±è¨ˆæ•¸æ“š</h3>
                        <select id="chart-type" onchange="updateChartType()" style="background:#333; color:white; border:none; padding:5px; border-radius:5px;">
                            <option value="bar">é•·æ¢åœ–</option>
                            <option value="pie">åœ“é¤…åœ–</option>
                        </select>
                    </div>
                    <div class="chart-box">
                        <canvas id="t-chart"></canvas>
                    </div>
                </div>
            </div>

            <div>
                <div class="glass" style="text-align:center;">
                    <h2 id="t-room-id" style="color:var(--p); font-size:40px; margin:0;">----</h2>
                    <canvas id="qr-canvas" style="margin: 20px auto; width: 100%;"></canvas>
                    <p style="color:#888;">æƒæ QR Code å¿«é€ŸåŠ å…¥</p>
                    <div style="display:grid; gap:10px;">
                        <button class="btn btn-s" onclick="broadcastExam()">ğŸš€ é–‹å§‹/æ›´æ–°æŠ•ç¥¨</button>
                        <button class="btn btn-outline" onclick="resetVotes()">ğŸ”„ æ¸…ç©ºé‡æ¸¬</button>
                        <button class="btn" style="background:white; color:black;" onclick="showFinalSummary()">ğŸ“Š é¡¯ç¤ºæœ€å¾Œç¸½çµ</button>
                    </div>
                </div>
                <div class="glass">
                    <h4>ç›®å‰ç‹€æ…‹</h4>
                    <p>é€£ç·šäººæ•¸: <span id="t-count" style="color:var(--s)">0</span></p>
                    <p>å·²æŠ•ç¥¨æ•¸: <span id="t-voted" style="color:var(--p)">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="v-stu-login" class="hidden">
        <div class="glass" style="max-width:400px; margin: 100px auto; text-align:center;">
            <h2>è«‹è¼¸å…¥æˆ¿è™Ÿ</h2>
            <input type="text" id="s-input-id" style="text-align:center; font-size:40px; margin:20px 0;">
            <button class="btn btn-p" style="width:100%" onclick="initStudent()">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div class="glass">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span id="s-status" class="badge">é€£ç·šä¸­...</span>
                <span id="s-id-display" class="badge">ID: --</span>
            </div>
            <h1 id="s-topic-display" style="text-align:center; margin:30px 0;">ç­‰å¾…è€å¸«å•Ÿå‹•...</h1>
            <div id="s-options-area" class="stu-opt-list">
                </div>
            <div id="s-voted-msg" class="hidden animate__animated animate__fadeInUp" style="text-align:center; padding:30px;">
                <div style="font-size:60px; margin-bottom:10px;">ğŸ’</div>
                <h2>æŠ•ç¥¨å·²é€å‡º</h2>
                <p style="color:#888;">æ‚¨å¯ä»¥é»é¸å…¶ä»–é¸é …ä¾†ä¿®æ”¹ç­”æ¡ˆ</p>
            </div>
        </div>
    </div>
</div>

<div id="summary-overlay" class="summary-overlay" onclick="this.style.display='none'">
    <h1 style="color:var(--s); font-size:60px;">æŠ•ç¥¨ç¸½çµ</h1>
    <div id="summary-content" style="font-size:32px; text-align:center; color:white;"></div>
    <p style="margin-top:50px; color:#888;">é»æ“Šä»»æ„è™•é—œé–‰</p>
</div>

<script>
    let peer, conn, role, myChart;
    let options = ["é¸é … A", "é¸é … B"]; // é è¨­é¸é …
    let votes = {}; // æ ¼å¼: { "é¸é …å…§å®¹": ç¥¨æ•¸ }
    let voterMap = new Map(); // æ ¼å¼: { peerID: "é¸é …å…§å®¹" }
    const STUN = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }, { 'urls': 'stun:stun1.l.google.com:19302' }] };

    function showView(id) {
        document.querySelectorAll('.app > div').forEach(d => { if(d.id.startsWith('v-')) d.classList.add('hidden'); });
        document.getElementById(id).classList.remove('hidden');
    }

    // --- è€å¸«ç«¯æ ¸å¿ƒ ---
    function initTeacher() {
        role = 'teacher';
        const roomID = Math.floor(1000 + Math.random() * 8999).toString();
        peer = new Peer('LUMINA-' + roomID, { config: STUN });

        peer.on('open', id => {
            showView('v-teacher');
            document.getElementById('t-room-id').innerText = roomID;
            QRCode.toCanvas(document.getElementById('qr-canvas'), window.location.href.split('?')[0] + '?r=' + roomID);
            renderOptionInputs();
            initChart();
            
            // å»£æ’­å¿ƒè·³èˆ‡ç‹€æ…‹
            setInterval(() => {
                const data = {
                    type: 'sync',
                    topic: document.getElementById('t-topic').value || "è«‹æŠ•ä¸‹ä½ çš„ä¸€ç¥¨",
                    options: options
                };
                Object.values(peer.connections).forEach(conns => conns.forEach(c => {
                    if(c.open) c.send(data);
                }));
                document.getElementById('t-count').innerText = Object.keys(peer.connections).length;
            }, 1000);
        });

        peer.on('connection', c => {
            c.on('data', d => {
                if(d.type === 'vote') {
                    if(voterMap.has(c.peer)) votes[voterMap.get(c.peer)]--;
                    voterMap.set(c.peer, d.val);
                    votes[d.val] = (votes[d.val] || 0) + 1;
                    updateChart();
                }
            });
        });
    }

    function renderOptionInputs() {
        const container = document.getElementById('option-list');
        container.innerHTML = options.map((opt, i) => `
            <div class="option-input-group animate__animated animate__fadeIn">
                <input type="text" value="${opt}" oninput="updateOptionText(${i}, this.value)">
                <button class="btn btn-outline" onclick="removeOption(${i})">âœ•</button>
            </div>
        `).join('');
    }

    function addOptionField() { options.push(`æ–°é¸é … ${options.length + 1}`); renderOptionInputs(); }
    function removeOption(i) { options.splice(i, 1); renderOptionInputs(); }
    function updateOptionText(i, val) { options[i] = val; }

    function broadcastExam() {
        // é‡ç½®æŠ•ç¥¨æ•¸æ“šä»¥ç¬¦åˆæ–°é¸é …
        votes = {};
        options.forEach(o => votes[o] = 0);
        voterMap.clear();
        updateChart();
        alert("å·²åŒæ­¥æœ€æ–°é¸é …çµ¦æ‰€æœ‰å­¸ç”Ÿï¼");
    }

    function initChart() {
        const ctx = document.getElementById('t-chart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: options, datasets: [{ data: [], backgroundColor: '#5856D6', borderRadius: 10 }] },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } } }
            }
        });
    }

    function updateChart() {
        myChart.data.labels = options;
        myChart.data.datasets[0].data = options.map(o => votes[o] || 0);
        myChart.update();
        document.getElementById('t-voted').innerText = voterMap.size;
    }

    function updateChartType() {
        const type = document.getElementById('chart-type').value;
        myChart.destroy();
        const ctx = document.getElementById('t-chart').getContext('2d');
        myChart = new Chart(ctx, {
            type: type,
            data: { labels: options, datasets: [{ data: options.map(o => votes[o] || 0), backgroundColor: ['#5856D6', '#34C759', '#FF9500', '#FF3B30', '#AF52DE'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function showFinalSummary() {
        const overlay = document.getElementById('summary-overlay');
        const content = document.getElementById('summary-content');
        let max = -1, winner = "ç„¡";
        for(let o in votes) { if(votes[o] > max) { max = votes[o]; winner = o; } }
        
        content.innerHTML = `
            <p>æœ€é«˜ç¥¨é¸é …ï¼š<br><span style="font-size:80px; color:var(--p)">${winner}</span></p>
            <p>å…±è¨ˆ ${voterMap.size} äººåƒèˆ‡æŠ•ç¥¨</p>
        `;
        overlay.style.display = 'flex';
    }

    function resetVotes() {
        voterMap.clear();
        options.forEach(o => votes[o] = 0);
        updateChart();
    }

    // --- å­¸ç”Ÿç«¯æ ¸å¿ƒ ---
    let s_conn;
    function initStudent() {
        role = 'student';
        const rid = document.getElementById('s-input-id').value || new URLSearchParams(window.location.search).get('r');
        if(!rid) return;
        
        showView('v-student');
        document.getElementById('s-id-display').innerText = "æˆ¿è™Ÿ: " + rid;
        peer = new Peer({ config: STUN });
        peer.on('open', () => {
            connectToTeacher(rid);
            setInterval(() => { if(!s_conn || !s_conn.open) connectToTeacher(rid); }, 3000);
        });
    }

    function connectToTeacher(rid) {
        s_conn = peer.connect('LUMINA-' + rid, { reliable: true });
        s_conn.on('open', () => {
            document.getElementById('s-status').innerText = "é€£ç·šæˆåŠŸ";
            document.getElementById('s-status').style.color = "var(--s)";
        });
        s_conn.on('data', d => {
            if(d.type === 'sync') {
                document.getElementById('s-topic-display').innerText = d.topic;
                renderStudentOptions(d.options);
            }
        });
    }

    let lastRenderedOptions = "";
    function renderStudentOptions(opts) {
        const str = JSON.stringify(opts);
        if(str === lastRenderedOptions) return; // æ²’è®Šå‹•å°±ä¸é‡æ–°æ¸²æŸ“
        lastRenderedOptions = str;

        const area = document.getElementById('s-options-area');
        area.innerHTML = opts.map(o => `
            <button class="stu-opt-btn animate__animated animate__fadeIn" onclick="submitVote('${o}', this)">
                ${o}
            </button>
        `).join('');
    }

    function submitVote(val, btn) {
        if(s_conn && s_conn.open) {
            s_conn.send({ type: 'vote', val: val });
            document.querySelectorAll('.stu-opt-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            if(window.navigator.vibrate) window.navigator.vibrate(50);
            document.getElementById('s-voted-msg').classList.remove('hidden');
        } else {
            alert("ç¶²è·¯ä¸ç©©å®šï¼Œå˜—è©¦é‡é€£ä¸­...");
        }
    }

    window.onload = () => {
        const r = new URLSearchParams(window.location.search).get('r');
        if(r) { document.getElementById('s-input-id').value = r; showView('v-stu-login'); }
    };
</script>
</body>
</html>
