<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å®‰å…¨åŠ å¯† P2P è€ƒè©¦ç³»çµ±</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; user-select: none; /* é˜²æ­¢é¸å– */ }
        .app { width: 100%; max-width: 700px; background: white; min-height: 100vh; padding: 25px; box-sizing: border-box; margin: auto; }
        .hidden { display: none; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px 0; }
        .btn-p { background: var(--p); color: white; }
        .card { background: #F9F9F9; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #EEE; }
        .q-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid var(--p); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #roomId { font-family: monospace; font-size: 24px; background: #E5E5EA; padding: 5px 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #DDD; padding: 10px; text-align: center; }
    </style>
</head>
<body oncontextmenu="return false;"> <div class="app">
    <div id="modeSelect">
        <h1 style="text-align:center">ğŸ›¡ï¸ å®‰å…¨è€ƒè©¦ç³»çµ±</h1>
        <button class="btn btn-p" onclick="initTeacher()">é€²å…¥è€å¸«æ¨¡å¼</button>
        <button class="btn" style="background:#5856D6; color:white;" onclick="showStudentLogin()">é€²å…¥å­¸ç”Ÿæ¨¡å¼</button>
    </div>

    <div id="teacherArea" class="hidden">
        <h2>ğŸ‘¨â€ğŸ« è€å¸«ç›£æ§ä¸­å¿ƒ</h2>
        <div class="card" style="text-align:center">
            <div>æˆ¿é–“ IDï¼š<span id="roomId">å»ºç«‹ä¸­...</span></div>
            <canvas id="roomQR" style="margin:10px auto;"></canvas>
        </div>

        <div class="card">
            <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="importExcel(this)">
            <p id="qStatus" style="color:blue;"></p>
        </div>

        <button class="btn btn-p" onclick="broadcastExam()">ç™¼é€åŠ å¯†è€ƒå· (ä¸å«ç­”æ¡ˆ)</button>
        
        <h3>ğŸ“Š å³æ™‚æˆç¸¾è¡¨</h3>
        <table id="monitorTable">
            <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>å¾—åˆ†</th><th>ç‹€æ…‹</th></tr></thead>
            <tbody id="monitorBody"></tbody>
        </table>
        <button class="btn" style="background:#34C759; color:white;" onclick="exportFinal()">åŒ¯å‡º Excel æˆç¸¾å–®</button>
    </div>

    <div id="studentArea" class="hidden">
        <div class="card" id="stuHeader" style="text-align:center; font-weight:bold;">ç­‰å¾…è€ƒå·ä¸­...</div>
        <div id="quizContent"></div>
        <button id="stuSubmitBtn" class="btn btn-p hidden" onclick="studentSubmit()">ç¢ºèªç¹³äº¤</button>
    </div>
</div>

<script>
    let peer, conn, myRoomId;
    let connections = {};
    let studentData = {};
    let masterQuiz = []; // è€å¸«ç«¯ä¿å­˜å®Œæ•´é¡Œç›®ï¼ˆå«ç­”æ¡ˆï¼‰

    // --- è€å¸«é‚è¼¯ ---
    function initTeacher() {
        document.getElementById('modeSelect').classList.add('hidden');
        document.getElementById('teacherArea').classList.remove('hidden');
        myRoomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        peer = new Peer(myRoomId);
        
        peer.on('open', id => {
            document.getElementById('roomId').innerText = id;
            QRCode.toCanvas(document.getElementById('roomQR'), window.location.href.split('?')[0] + '?room=' + id);
        });

        peer.on('connection', c => {
            const no = c.metadata.no;
            connections[no] = c;
            studentData[no] = { no: no, progress: "0%", score: 0, answers: {}, scoresPerQ: {}, status: "å·²é€£ç·š" };
            updateMonitor();

            c.on('data', data => {
                if (data.type === 'update') {
                    studentData[no].progress = data.progress;
                    updateMonitor();
                }
                if (data.type === 'submit') {
                    calculateScore(no, data.userAns);
                }
            });
        });
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            masterQuiz = json.map(r => ({
                q: r.é¡Œç›®,
                opts: { A: r.é¸é …A, B: r.é¸é …B, C: r.é¸é …C, D: r.é¸é …D, E: r.é¸é …E },
                ans: String(r.æ­£ç¢ºç­”æ¡ˆ || "").toUpperCase().split('').sort().join(''),
                point: Number(r.é…åˆ† || 0)
            }));
            document.getElementById('qStatus').innerText = `âœ… å·²è®€å– ${masterQuiz.length} é¡Œ`;
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function broadcastExam() {
        // å®‰å…¨è™•ç†ï¼šç™¼é€å‰ç§»é™¤ ans æ¬„ä½
        const safeQuiz = masterQuiz.map(item => {
            const { ans, ...noAnsItem } = item;
            return noAnsItem;
        });
        Object.values(connections).forEach(c => c.send({ type: 'exam', quiz: safeQuiz }));
    }

    function calculateScore(no, userAns) {
        let total = 0;
        let perQ = {};
        masterQuiz.forEach((q, i) => {
            if (userAns[i] === q.ans) {
                total += q.point;
                perQ[i] = q.point;
            } else {
                perQ[i] = 0;
            }
        });
        studentData[no].score = total;
        studentData[no].answers = userAns;
        studentData[no].scoresPerQ = perQ;
        studentData[no].status = "å·²ç¹³äº¤";
        updateMonitor();
    }

    function updateMonitor() {
        const body = document.getElementById('monitorBody');
        body.innerHTML = Object.values(studentData).map(s => `
            <tr><td>${s.no}</td><td>${s.progress}</td><td>${s.score}</td><td>${s.status}</td></tr>
        `).join('');
    }

    // --- å­¸ç”Ÿé‚è¼¯ ---
    function showStudentLogin() {
        const id = (new URLSearchParams(window.location.search)).get('room') || prompt("è«‹è¼¸å…¥ 4 ä½æˆ¿é–“ ID:");
        const no = prompt("è«‹è¼¸å…¥æ‚¨çš„åº§è™Ÿ:");
        if(!id || !no) return;
        document.getElementById('modeSelect').classList.add('hidden');
        document.getElementById('studentArea').classList.remove('hidden');

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id.toUpperCase(), { metadata: { no: no } });
            conn.on('data', data => {
                if (data.type === 'exam') renderExam(data.quiz);
            });
        });
    }

    function renderExam(quiz) {
        document.getElementById('stuHeader').innerText = "æ¸¬é©—ä¸­ - ç­”æ¡ˆå°‡ç”±è€å¸«ç«¯è¨ˆç®—";
        document.getElementById('stuSubmitBtn').classList.remove('hidden');
        let html = '';
        quiz.forEach((q, i) => {
            html += `<div class="q-card"><p><b>${i+1}. ${q.q} (${q.point}åˆ†)</b></p>`;
            Object.entries(q.opts).forEach(([key, val]) => {
                if(val) html += `<label style="display:block;margin:10px 0;"><input type="checkbox" name="q${i}" value="${key}" onchange="updateProgress(${quiz.length})"> ${key}. ${val}</label>`;
            });
            html += `</div>`;
        });
        document.getElementById('quizContent').innerHTML = html;
    }

    function updateProgress(total) {
        const done = Array.from({length: total}).filter((_, i) => document.querySelector(`input[name="q${i}"]:checked`)).length;
        conn.send({ type: 'update', progress: Math.round((done/total)*100)+"%" });
    }

    function studentSubmit() {
        if(!confirm("ç¢ºå®šè¦ç¹³äº¤å—ï¼Ÿç¹³äº¤å¾Œç„¡æ³•æ›´æ”¹ã€‚")) return;
        let userAns = {};
        const qCards = document.querySelectorAll('.q-card');
        qCards.forEach((_, i) => {
            const sel = Array.from(document.querySelectorAll(`input[name="q${i}"]:checked`)).map(el => el.value).sort().join('');
            userAns[i] = sel;
        });
        conn.send({ type: 'submit', userAns: userAns });
        document.getElementById('studentArea').innerHTML = "<h2 style='text-align:center'>è©¦å·å·²æäº¤çµ¦è€å¸«ï¼</h2>";
    }

    function exportFinal() {
        const exportList = Object.values(studentData).map(s => {
            let row = { "åº§è™Ÿ": s.no, "ç¸½å¾—åˆ†": s.score };
            masterQuiz.forEach((_, i) => {
                row[`Q${i+1}ç­”æ¡ˆ`] = s.answers[i] || "";
                row[`Q${i+1}å¾—åˆ†`] = s.scoresPerQ[i] || 0;
            });
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(exportList);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾");
        XLSX.writeFile(wb, "ç­ç´šè€ƒè©¦å®Œæ•´æˆç¸¾å–®.xlsx");
    }
</script>
</body>
</html>
