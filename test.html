<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Ultra | å°ˆæ¥­è€ƒè©•å¹³å°</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #1D1D1F; user-select: none; }
        .app { max-width: 1000px; margin: auto; padding: 20px; }
        .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; box-shadow: 0 4px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        .btn { padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-p { background: var(--p); color: #FFF; }
        .btn-s { background: var(--s); color: #FFF; }
        .btn-d { background: var(--d); color: #FFF; }
        
        /* è€å¸«å„€è¡¨æ¿ */
        .stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .stat-item { background: #FFF; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #DDD; }
        .stat-num { font-size: 24px; font-weight: bold; color: var(--p); }

        /* å­¸ç”Ÿä½œç­”å°è¦½ */
        .q-nav { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; border-bottom: 1px solid #EEE; }
        .q-num-btn { min-width: 40px; height: 40px; border-radius: 8px; border: 1px solid #DDD; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #FFF; }
        .q-num-btn.active { background: var(--p); color: #FFF; border-color: var(--p); }
        .q-num-btn.done { border-color: var(--s); color: var(--s); }

        /* é¡Œç›®ç·¨è¼¯å™¨ */
        .edit-card { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; }
        
        /* é–å®šé®ç½© */
        .lock-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; text-align: center; backdrop-filter: blur(10px); }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #EEE; }
        .progress-bar { height: 8px; background: #E5E5EA; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: var(--p); transition: 0.3s; }
    </style>
</head>
<body>

<div class="app">
    <div id="v-start" class="glass" style="text-align:center; margin-top:100px;">
        <h1>Lumina Ultra</h1>
        <button class="btn btn-p" onclick="showView('v-teacher-setup')">æ•™å¸«ç«¯ (è¨­å®šè€ƒå ´)</button>
        <button class="btn" style="background:#8E8E93; color:white;" onclick="initStudent()">å­¸ç”Ÿç«¯ (é€²å…¥è€ƒè©¦)</button>
    </div>

    <div id="v-teacher-setup" class="hidden">
        <div class="glass">
            <h2>ğŸ  æ­¥é©Ÿ 1: è¨­å®šè€ƒå ´ ID</h2>
            <input type="text" id="customRoomId" placeholder="è¼¸å…¥è‡ªè¨‚æˆ¿é–“ ID (å¦‚: CLASS101)" style="padding:12px; width:200px; border-radius:10px; border:1px solid #DDD;">
            <p style="font-size:12px; color:gray;">å»ºè­°ä½¿ç”¨å¤§å¯«è‹±æ–‡èˆ‡æ•¸å­—</p>
        </div>
        <div class="glass">
            <h2>ğŸ“ æ­¥é©Ÿ 2: è¨­å®šé¡Œç›®</h2>
            <div style="margin-bottom:15px;">
                <button class="btn" onclick="showEditMode('visual')">è¦–è¦ºåŒ–ç·¨è¼¯</button>
                <button class="btn" onclick="showEditMode('excel')">Excel åŒ¯å…¥</button>
            </div>
            
            <div id="visualEditor">
                <div id="qList"></div>
                <button class="btn btn-s" onclick="addQuestion()">+ æ–°å¢ä¸€é¡Œ</button>
            </div>
            
            <div id="excelEditor" class="hidden">
                <input type="file" accept=".xlsx" onchange="importExcel(this)">
                <button class="btn" onclick="downloadSample()">ä¸‹è¼‰ç¯„æœ¬</button>
            </div>
        </div>
        <button class="btn btn-p" style="width:100%; padding:20px;" onclick="initTeacher()">å®Œæˆè¨­å®šä¸¦é–‹å•Ÿè€ƒå ´</button>
    </div>

    <div id="v-teacher-main" class="hidden">
        <div class="glass">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <h2 id="roomDisplay">è€ƒå ´: ----</h2>
                    <canvas id="roomQR"></canvas>
                </div>
                <div style="text-align:right">
                    <button id="allLockBtn" class="btn btn-d" onclick="toggleAllLock()">ğŸ”’ å…¨é«”æš«åœ</button>
                    <button class="btn btn-s" onclick="broadcastExam()">ğŸš€ ç™¼é€è€ƒå·</button>
                </div>
            </div>

            <div class="stat-row">
                <div class="stat-item"><div>åœ¨ç·š(é€£ç·š)</div><div class="stat-num" id="s-online">0</div></div>
                <div class="stat-item"><div>è¼‰å…¥(æ”¶é¡Œ)</div><div class="stat-num" id="s-ready">0</div></div>
                <div class="stat-item"><div>å·²ç¹³(å®Œæˆ)</div><div class="stat-num" id="s-done">0</div></div>
                <div class="stat-item"><div>ç­ç´šå¹³å‡</div><div class="stat-num" id="s-avg">0</div></div>
            </div>
        </div>

        <div class="glass">
            <h3>ğŸ‘¥ å­¸ç”Ÿåå–®èˆ‡å³æ™‚ç‹€æ…‹</h3>
            <table>
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
            <button class="btn btn-s" style="width:100%; margin-top:15px;" onclick="exportExcel()">ğŸ’¾ åŒ¯å‡ºçµç®— Excel</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div id="lockMask" class="lock-mask hidden"><div>ğŸ”’ è€å¸«æš«åœäº†ä½ çš„ä½œç­”<br>è«‹æŠ¬é ­è½è¬›</div></div>
        <div class="glass">
            <div style="display:flex; justify-content:space-between;">
                <b id="stuNoLabel">åº§è™Ÿ: --</b>
                <button class="btn btn-d" style="padding:4px 10px;" onclick="studentLogout()">ä¿å­˜ä¸¦ç™»å‡º</button>
            </div>
            <div class="progress-bar"><div id="stuProgFill" class="progress-fill" style="width: 0%"></div></div>
            <div id="qNav" class="q-nav"></div>
        </div>
        <div id="quizContainer" class="glass">
            <p style="text-align:center; color:gray;">ç­‰å¾…è€å¸«ç™¼é€è€ƒå·...</p>
        </div>
        <button id="finalSubBtn" class="btn btn-p hidden" style="width:100%; padding:15px;" onclick="studentSubmit()">ç¢ºèªç¹³äº¤å…¨å·</button>
    </div>

    <div id="v-result" class="hidden glass" style="text-align:center; margin-top:100px;">
        <h2 style="color:var(--s)">ç¹³äº¤æˆåŠŸ</h2>
        <div id="resScore" style="font-size:80px; font-weight:bold;">0</div>
        <p>åˆ†</p>
        <button class="btn btn-p" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<script>
    let peer, conn, myRoomId, isAllLocked = false;
    let studentData = {}; // è€å¸«å­˜å„²
    let connections = {};
    let masterQuiz = [];
    let currentIdx = 0; // å­¸ç”Ÿä½œç­”ç›®å‰é¡Œè™Ÿ

    // --- è€å¸«è¨­å®šèˆ‡é‚è¼¯ ---
    function addQuestion() {
        const idx = document.querySelectorAll('.edit-card').length;
        const html = `
            <div class="edit-card" id="qc-${idx}">
                <b>ç¬¬ ${idx+1} é¡Œ</b>
                <input type="text" placeholder="é¡Œç›®å…§å®¹" class="in-q" style="width:100%; margin:5px 0;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                    <input type="text" placeholder="é¸é …A" class="in-a"> <input type="text" placeholder="é¸é …B" class="in-b">
                    <input type="text" placeholder="é¸é …C" class="in-c"> <input type="text" placeholder="é¸é …D" class="in-d">
                </div>
                æ­£ç¢ºç­”æ¡ˆ: <input type="text" placeholder="å¦‚: A æˆ– AB" class="in-ans" style="width:60px;">
                é…åˆ†: <input type="number" value="10" class="in-pt" style="width:50px;">
                <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; float:right;">åˆªé™¤</button>
            </div>`;
        document.getElementById('qList').insertAdjacentHTML('beforeend', html);
    }

    function parseVisual() {
        const cards = document.querySelectorAll('.edit-card');
        masterQuiz = Array.from(cards).map(c => ({
            q: c.querySelector('.in-q').value,
            opts: {A: c.querySelector('.in-a').value, B: c.querySelector('.in-b').value, C: c.querySelector('.in-c').value, D: c.querySelector('.in-d').value},
            ans: c.querySelector('.in-ans').value.toUpperCase().split('').sort().join(''),
            point: Number(c.querySelector('.in-pt').value)
        }));
    }

    function initTeacher() {
        if(document.getElementById('excelEditor').classList.contains('hidden')) parseVisual();
        myRoomId = document.getElementById('customRoomId').value.toUpperCase() || Math.random().toString(36).substring(2,6).toUpperCase();
        
        peer = new Peer(myRoomId);
        peer.on('open', id => {
            showView('v-teacher-main');
            document.getElementById('roomDisplay').innerText = "è€ƒå ´ ID: " + id;
            QRCode.toCanvas(document.getElementById('roomQR'), window.location.href.split('?')[0] + '?room=' + id, {width: 150});
        });

        peer.on('connection', c => {
            const no = c.metadata.no;
            const deviceId = c.metadata.deviceId;

            // é˜²å†’ç”¨é‚è¼¯
            if(studentData[no] && studentData[no].deviceId !== deviceId) {
                c.send({type: 'error', msg: 'æ­¤åº§è™Ÿå·²è¢«å…¶ä»–è£ç½®å ç”¨ï¼'});
                setTimeout(() => c.close(), 500);
                return;
            }

            connections[no] = c;
            if(!studentData[no]) {
                studentData[no] = { no: no, deviceId: deviceId, progress: "0%", score: 0, status: "åœ¨ç·š", cheats: 0, isLocked: false, hasExam: false };
            } else {
                studentData[no].status = "åœ¨ç·š";
            }
            
            updateMonitor();
            c.on('data', d => handleData(no, d));
            c.on('close', () => { if(studentData[no]) studentData[no].status = "é›¢ç·š"; updateMonitor(); });
        });
    }

    function handleData(no, d) {
        if(d.type === 'sync') {
            studentData[no].progress = d.progress;
            studentData[no].cheats = d.cheats;
            studentData[no].hasExam = true; // è¡¨ç¤ºå·²è¼‰å…¥è©¦å·
            updateMonitor();
        }
        if(d.type === 'submit') {
            let total = 0;
            masterQuiz.forEach((q, i) => { if(d.ans[i] === q.ans) total += q.point; });
            studentData[no].score = total;
            studentData[no].status = "å·²ç¹³äº¤";
            connections[no].send({type: 'report', score: total});
            updateMonitor();
        }
    }

    function updateMonitor() {
        const list = Object.values(studentData);
        document.getElementById('s-online').innerText = list.filter(s => s.status !== "é›¢ç·š").length;
        document.getElementById('s-ready').innerText = list.filter(s => s.hasExam).length;
        document.getElementById('s-done').innerText = list.filter(s => s.status === "å·²ç¹³äº¤").length;
        
        document.getElementById('monitorBody').innerHTML = list.map(s => `
            <tr>
                <td>${s.no}</td>
                <td>${s.progress}</td>
                <td>${s.status} ${s.cheats > 0 ? '<b style="color:red">!</b>':''}</td>
                <td>
                    <button class="btn ${s.isLocked?'btn-s':'btn-d'}" onclick="toggleSingleLock('${s.no}')">${s.isLocked?'è§£é–':'é–å®š'}</button>
                </td>
            </tr>
        `).join('');
    }

    function toggleAllLock() {
        isAllLocked = !isAllLocked;
        Object.values(connections).forEach(c => c.send({type: 'lock', state: isAllLocked}));
        document.getElementById('allLockBtn').innerText = isAllLocked ? "ğŸ”“ å…¨é«”è§£é–" : "ğŸ”’ å…¨é«”æš«åœ";
    }

    function toggleSingleLock(no) {
        studentData[no].isLocked = !studentData[no].isLocked;
        if(connections[no]) connections[no].send({type: 'lock', state: studentData[no].isLocked});
        updateMonitor();
    }

    function broadcastExam() {
        const safe = masterQuiz.map(({ans, ...r}) => r);
        Object.values(connections).forEach(c => c.send({type: 'exam', quiz: safe}));
    }

    // --- å­¸ç”Ÿç«¯é‚è¼¯ ---
    let myAnswers = {}, stuQuiz = [], stuCheats = 0;
    function initStudent() {
        const id = (new URLSearchParams(window.location.search)).get('room') || prompt("è€ƒå ´ ID:");
        myNo = prompt("åº§è™Ÿ:");
        if(!id || !myNo) return;

        // è£ç½®ç¶å®šè¾¨è­˜
        let dId = localStorage.getItem('lumina_device_id');
        if(!dId) { dId = Math.random().toString(36).substring(7); localStorage.setItem('lumina_device_id', dId); }

        showView('v-student');
        document.getElementById('stuNoLabel').innerText = "åº§è™Ÿ: " + myNo;

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id.toUpperCase(), { metadata: { no: myNo, deviceId: dId } });
            conn.on('data', d => {
                if(d.type === 'exam') { stuQuiz = d.quiz; renderStuExam(); }
                if(d.type === 'lock') document.getElementById('lockMask').classList.toggle('hidden', !d.state);
                if(d.type === 'report') showResult(d.score);
                if(d.type === 'error') { alert(d.msg); location.reload(); }
            });
        });

        document.addEventListener('visibilitychange', () => {
            if(document.visibilityState === 'hidden') { stuCheats++; syncStu(); }
        });
    }

    function renderStuExam() {
        const saved = JSON.parse(localStorage.getItem('ans_'+myNo) || "{}");
        myAnswers = saved;
        
        let navHtml = '';
        stuQuiz.forEach((_, i) => {
            navHtml += `<div class="q-num-btn" id="nb-${i}" onclick="jumpTo(${i})">${i+1}</div>`;
        });
        document.getElementById('qNav').innerHTML = navHtml;
        jumpTo(0);
        syncStu();
    }

    function jumpTo(idx) {
        currentIdx = idx;
        const q = stuQuiz[idx];
        let optsHtml = '';
        Object.entries(q.opts).forEach(([k, v]) => {
            if(!v) return;
            const checked = (myAnswers[idx] || "").includes(k) ? "checked" : "";
            optsHtml += `<label style="display:block; padding:15px; background:#F9F9F9; margin:10px 0; border-radius:10px;">
                <input type="checkbox" name="sq" value="${k}" ${checked} onchange="saveAns()"> ${k}. ${v}
            </label>`;
        });
        document.getElementById('quizContainer').innerHTML = `<h3>ç¬¬ ${idx+1} é¡Œ</h3><p>${q.q}</p>${optsHtml}`;
        
        document.querySelectorAll('.q-num-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nb-'+idx).classList.add('active');
        
        // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œï¼Œé¡¯ç¤ºç¹³äº¤æŒ‰éˆ•
        document.getElementById('finalSubBtn').classList.toggle('hidden', idx !== stuQuiz.length - 1);
    }

    function saveAns() {
        const sel = Array.from(document.querySelectorAll('input[name="sq"]:checked')).map(e => e.value).sort().join('');
        myAnswers[currentIdx] = sel;
        localStorage.setItem('ans_'+myNo, JSON.stringify(myAnswers));
        if(sel) document.getElementById('nb-'+currentIdx).classList.add('done');
        syncStu();
    }

    function syncStu() {
        const doneCount = Object.values(myAnswers).filter(v => v !== "").length;
        const prog = Math.round((doneCount / stuQuiz.length) * 100);
        document.getElementById('stuProgFill').style.width = prog + "%";
        if(conn) conn.send({type: 'sync', progress: prog + "%", cheats: stuCheats});
    }

    function studentSubmit() {
        if(confirm("ç¢ºå®šç¹³äº¤ï¼Ÿ")) conn.send({type: 'submit', ans: myAnswers});
    }

    function studentLogout() {
        alert("ç­”æ¡ˆå·²ä¿å­˜ï¼Œä¸‹æ¬¡ç™»å…¥åº§è™Ÿå¯ç¹¼çºŒã€‚");
        location.reload();
    }

    function showResult(s) {
        showView('v-result');
        document.getElementById('resScore').innerText = s;
        localStorage.removeItem('ans_'+myNo);
    }

    // å·¥å…·
    function showView(id) {
        ['v-start','v-teacher-setup','v-teacher-main','v-student','v-result'].forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function showEditMode(m) {
        document.getElementById('visualEditor').classList.toggle('hidden', m!=='visual');
        document.getElementById('excelEditor').classList.toggle('hidden', m!=='excel');
    }
    function downloadSample() {
        const ws = XLSX.utils.aoa_to_sheet([["é¡Œç›®","é¸é …A","é¸é …B","é¸é …C","é¸é …D","æ­£ç¢ºç­”æ¡ˆ","é…åˆ†"],["1+1=?","1","2","3","4","B",10]]);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "é¡Œåº«");
        XLSX.writeFile(wb, "è€ƒé¡Œç¯„æœ¬.xlsx");
    }
    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = e => {
            const data = XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type:'array'}).Sheets["é¡Œåº«"]);
            masterQuiz = data.map(r => ({ q:r.é¡Œç›®, opts:{A:r.é¸é …A,B:r.é¸é …B,C:r.é¸é …C,D:r.é¸é …D}, ans:String(r.æ­£ç¢ºç­”æ¡ˆ).toUpperCase().split('').sort().join(''), point:r.é…åˆ† }));
            alert("æˆåŠŸåŒ¯å…¥ " + masterQuiz.length + " é¡Œ");
        };
        reader.readAsArrayBuffer(input.files[0]);
    }
</script>
</body>
</html>
