<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina Vote | 強韌連線版</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; }
        body { font-family: -apple-system, sans-serif; background: #F2F2F7; margin: 0; text-align: center; color: #1C1C1E; }
        .container { max-width: 500px; margin: auto; padding: 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 16px; width: 100%; transition: 0.2s; margin: 5px 0; }
        .btn-p { background: var(--p); color: white; }
        .hidden { display: none !important; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .vote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .opt-btn { height: 100px; font-size: 28px; background: #F2F2F7; border: 2px solid transparent; }
        .opt-btn.active { border-color: var(--p); background: #E5F1FF; color: var(--p); }
        .bar { height: 12px; background: #E5E5EA; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .bar-inner { height: 100%; background: var(--p); width: 0%; transition: 0.6s cubic-bezier(0.1, 0.7, 0.1, 1); }
    </style>
</head>
<body>

<div class="container">
    <div id="v-start">
        <h1 style="margin: 50px 0;">Lumina Vote</h1>
        <button class="btn btn-p" onclick="initTeacher()">我是老師 (開啟房號)</button>
        <button class="btn" style="background:#8E8E93; color:white;" onclick="showView('v-stu-login')">我是學生 (掃碼投票)</button>
    </div>

    <div id="v-teacher" class="hidden">
        <div class="card">
            <h2 id="t-id">房號: ----</h2>
            <canvas id="qrcode" style="margin: auto;"></canvas>
        </div>
        <div class="card">
            <input type="text" id="topic" placeholder="在此輸入投票主題..." style="width:100%; border:1px solid #DDD; padding:10px; border-radius:8px;">
            <div id="stats" style="text-align: left; margin-top: 15px;"></div>
            <button class="btn" style="background:#EEE;" onclick="resetVotes()">清空統計</button>
        </div>
    </div>

    <div id="v-stu-login" class="hidden card" style="margin-top: 50px;">
        <h2>輸入房號</h2>
        <input type="text" id="target-id" style="width:100%; padding:15px; font-size:24px; text-align:center; border-radius:12px; border:1px solid #DDD;">
        <button class="btn btn-p" onclick="initStudent()">開始連線</button>
    </div>

    <div id="v-student" class="hidden">
        <div class="card">
            <div style="display:flex; align-items:center; justify-content:center; font-size:12px;">
                <span id="s-dot" class="status-dot" style="background:gray;"></span>
                <span id="s-msg">嘗試連線中...</span>
            </div>
            <h2 id="s-topic" style="margin: 20px 0;">等待老師題目...</h2>
            <div class="vote-grid">
                <button class="btn opt-btn" onclick="submitVote('A')">A</button>
                <button class="btn opt-btn" onclick="submitVote('B')">B</button>
                <button class="btn opt-btn" onclick="submitVote('C')">C</button>
                <button class="btn opt-btn" onclick="submitVote('D')">D</button>
            </div>
        </div>
    </div>
</div>

<script>
    let peer, conn, role, myVote = null;
    let votes = {A:0, B:0, C:0, D:0};
    const voters = new Set();

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // --- 老師端 ---
    function initTeacher() {
        role = 'teacher';
        const tid = "V" + Math.floor(1000 + Math.random()*8999);
        peer = new Peer(tid);
        peer.on('open', id => {
            showView('v-teacher');
            document.getElementById('t-id').innerText = "房號: " + id;
            QRCode.toCanvas(document.getElementById('qrcode'), window.location.href.split('?')[0] + '?r=' + id);
            renderStats();
            // 廣播機制：每秒同步題目與心跳
            setInterval(() => {
                const t = document.getElementById('topic').value || "請選擇你的答案";
                Object.values(peer.connections).forEach(group => group.forEach(c => {
                    if(c.open) c.send({type:'sync', topic: t});
                }));
            }, 1000);
        });
        peer.on('connection', c => {
            c.on('data', d => {
                if(d.type === 'vote' && !voters.has(c.peer)) {
                    votes[d.val]++;
                    voters.add(c.peer);
                    renderStats();
                }
            });
        });
    }

    function renderStats() {
        const total = Object.values(votes).reduce((a,b)=>a+b, 0);
        let html = '';
        ['A','B','C','D'].forEach(o => {
            const p = total ? (votes[o]/total*100).toFixed(0) : 0;
            html += `<div>${o}: ${votes[o]} 票 (${p}%)</div><div class="bar"><div class="bar-inner" style="width:${p}%"></div></div>`;
        });
        document.getElementById('stats').innerHTML = html;
    }

    function resetVotes() { votes = {A:0,B:0,C:0,D:0}; voters.clear(); renderStats(); }

    // --- 學生端 ---
    let retryTimer, lastPing = 0;
    function initStudent() {
        role = 'student';
        const rid = document.getElementById('target-id').value.toUpperCase() || new URLSearchParams(window.location.search).get('r');
        if(!rid) return;
        showView('v-student');
        
        if(peer) peer.destroy();
        peer = new Peer();
        
        peer.on('open', () => tryConnect(rid));
        
        // 斷線自動監測（Android 核心修復）
        setInterval(() => {
            if(role === 'student' && Date.now() - lastPing > 5000) {
                updateStuStatus("斷線重連中...", "red");
                tryConnect(rid);
            }
        }, 3000);
    }

    function tryConnect(rid) {
        if(conn && conn.open) return;
        conn = peer.connect(rid);
        conn.on('open', () => {
            updateStuStatus("已連線", "var(--s)");
            if(myVote) conn.send({type:'vote', val: myVote}); // 重連後自動補投
        });
        conn.on('data', d => {
            if(d.type === 'sync') {
                lastPing = Date.now();
                document.getElementById('s-topic').innerText = d.topic;
                updateStuStatus("已連線", "var(--s)");
            }
        });
        conn.on('error', () => conn.close());
    }

    function updateStuStatus(msg, color) {
        document.getElementById('s-msg').innerText = msg;
        document.getElementById('s-dot').style.background = color;
    }

    function submitVote(val) {
        myVote = val;
        document.querySelectorAll('.opt-btn').forEach(b => {
            b.classList.toggle('active', b.innerText === val);
        });
        if(conn && conn.open) {
            conn.send({type:'vote', val: val});
            updateStuStatus("已成功投票", "var(--p)");
        } else {
            updateStuStatus("等待連線以送出...", "orange");
        }
    }

    window.onload = () => {
        const r = new URLSearchParams(window.location.search).get('r');
        if(r) { document.getElementById('target-id').value = r; showView('v-stu-login'); }
    };
</script>
</body>
</html>
