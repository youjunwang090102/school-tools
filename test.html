<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LuminaOS Sequoia v15.3 | Stable Core</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --apple-blue: #007AFF;
            --win-bg: rgba(255, 255, 255, 0.85);
            --glass: blur(30px) saturate(180%);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; font-family: -apple-system, sans-serif; overflow: hidden; background: #000; }

        /* --- ç©©å®šç‰ˆå•Ÿå‹•å™¨ --- */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .apple-logo { font-size: 60px; color: #fff; margin-bottom: 40px; }
        .progress-container { width: 200px; height: 4px; background: #333; border-radius: 2px; position: relative; }
        #boot-bar { width: 0%; height: 100%; background: #fff; border-radius: 2px; }

        /* --- ç™»å…¥ç•«é¢ --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 99998; display: none;
            background: url('https://raw.githubusercontent.com/apple/sequoia-wallpaper/main/sequoia.jpg') center/cover;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box { backdrop-filter: blur(20px); padding: 50px; border-radius: 40px; text-align: center; color: #fff; }
        .avatar { width: 100px; height: 100px; background: rgba(255,255,255,0.2); border-radius: 50%; margin: 0 auto 20px; font-size: 50px; display: flex; align-items: center; justify-content: center; border: 1px solid #fff; }
        .mode-btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; margin: 10px; transition: 0.2s; }
        .btn-mac { background: rgba(0,0,0,0.5); color: #fff; border: 1px solid rgba(255,255,255,0.3); }
        .btn-ios { background: #fff; color: #000; }
        .mode-btn:hover { transform: scale(1.05); }

        /* --- macOS æ¡Œé¢ç’°å¢ƒ --- */
        #desktop { width: 100%; height: 100%; background: url('https://images.apple.com/v/macos/sequoia/a/images/overview/hero/hero_wallpaper__eq8u3n8y7u6u_large.jpg') center/cover; display: none; }
        
        .menu-bar { height: 32px; background: rgba(255,255,255,0.2); backdrop-filter: blur(15px); position: fixed; top: 0; width: 100%; display: flex; align-items: center; padding: 0 15px; color: #fff; font-size: 13px; font-weight: 600; z-index: 1000; }
        .menu-left { display: flex; gap: 15px; }

        /* è¦–çª—ç³»çµ± */
        .window {
            position: absolute; width: 850px; height: 550px; background: var(--win-bg); backdrop-filter: var(--glass);
            border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(255,255,255,0.4);
        }
        .win-header { height: 45px; display: flex; align-items: center; padding: 0 15px; cursor: move; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .controls { display: flex; gap: 8px; width: 70px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 0.5px solid rgba(0,0,0,0.1); cursor: pointer; position: relative; }
        .close { background: #FF5F57; } .min { background: #FEBC2E; } .max { background: #28C840; }

        /* ç¶ è‰²æŒ‰éˆ•ï¼šæ‡¸åœ Tiling */
        .tiling-menu {
            position: absolute; top: 25px; left: 0; background: #222; padding: 10px; border-radius: 8px; 
            display: none; grid-template-columns: 1fr 1fr; gap: 8px; z-index: 1001;
        }
        .max:hover .tiling-menu { display: grid; }
        .tile-box { width: 40px; height: 30px; border: 1px solid #555; border-radius: 4px; }
        .tile-box:hover { background: var(--apple-blue); }

        /* è¦–çª—å…§å®¹ */
        .win-container { flex: 1; display: flex; }
        .sidebar { width: 180px; background: rgba(0,0,0,0.03); padding: 20px 10px; border-right: 1px solid rgba(0,0,0,0.05); }
        .side-btn { padding: 10px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; font-size: 14px; }
        .side-btn.active { background: #fff; color: var(--apple-blue); font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .content { flex: 1; padding: 30px; background: #fff; overflow-y: auto; }

        /* --- iPhone ä»‹é¢ --- */
        #iphone { position: fixed; inset: 0; background: #F2F2F7; display: none; flex-direction: column; z-index: 10000; }
        .ios-head { padding: 60px 20px 30px; background: #fff; }
        .ios-body { flex: 1; padding: 20px; }
        .option-card { background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 12px; border: 2px solid transparent; font-size: 18px; font-weight: 600; transition: 0.2s; cursor: pointer; display: flex; justify-content: space-between; }
        .option-card.active { border-color: var(--apple-blue); background: rgba(0,122,255,0.05); }
        .submit-btn { width: 100%; padding: 18px; border-radius: 15px; background: var(--apple-blue); color: #fff; border: none; font-size: 18px; font-weight: 700; margin-top: 20px; }

        .dock { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.3); backdrop-filter: blur(20px); border-radius: 20px; padding: 10px; display: flex; gap: 15px; border: 1px solid rgba(255,255,255,0.2); }
        .dock-app { width: 50px; height: 50px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; }
        
        .hidden { display: none !important; }
        input.apple-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin: 10px 0; outline: none; }
    </style>
</head>
<body>

<div id="boot-screen">
    <div class="apple-logo">ï£¿</div>
    <div class="progress-container"><div id="boot-bar"></div></div>
</div>

<div id="login-screen">
    <div class="login-box">
        <div class="avatar">ğŸ‘¤</div>
        <h2>æ­¡è¿ä½¿ç”¨ Sequoia</h2>
        <div style="margin-top:20px;">
            <button class="mode-btn btn-mac" onclick="App.start('teacher')">æˆ‘æ˜¯è€å¸«</button>
            <button class="mode-btn btn-ios" onclick="App.start('student')">æˆ‘æ˜¯å­¸ç”Ÿ</button>
        </div>
    </div>
</div>

<div id="desktop">
    <div class="menu-bar">
        <div class="menu-left"><span>ï£¿</span><strong>System</strong><span>File</span><span>View</span></div>
    </div>

    <div id="main-win" class="window" style="top:100px; left:150px;">
        <div class="win-header" onmousedown="UI.drag(event, 'main-win')">
            <div class="controls">
                <div class="dot close" onclick="UI.toggle('main-win')"></div>
                <div class="dot min"></div>
                <div class="dot max">
                    <div class="tiling-menu">
                        <div class="tile-box" onclick="UI.tile('left')"></div>
                        <div class="tile-box" onclick="UI.tile('right')"></div>
                    </div>
                </div>
            </div>
            <div style="flex:1; text-align:center; font-size:13px; font-weight:700;">ä»»å‹™ç™¼å¸ƒä¸­å¿ƒ</div>
        </div>
        <div class="win-container">
            <div class="sidebar">
                <div class="side-btn active" onclick="UI.tab('tab-setup')">ä»»å‹™è¨­å®š</div>
                <div class="side-btn" onclick="UI.tab('tab-live')">å¯¦æ™‚æ•¸æ“š</div>
                <div style="margin-top:30px; font-size:12px; color:#888;">æˆ¿è™Ÿï¼š<b id="display-id">----</b></div>
            </div>
            <div class="content">
                <div id="tab-setup">
                    <h3>ç™¼å¸ƒæ–°ä»»å‹™</h3>
                    <input type="text" id="inp-topic" class="apple-input" placeholder="è«‹è¼¸å…¥é¡Œç›®...">
                    <div id="opt-container"></div>
                    <button onclick="App.addOpt()" style="color:var(--apple-blue); background:none; border:none; cursor:pointer; font-weight:600;">+ æ–°å¢é¸é …</button>
                    <button onclick="App.launch()" style="width:100%; padding:15px; background:var(--apple-blue); color:#fff; border:none; border-radius:10px; margin-top:30px; font-weight:700;">å•Ÿå‹•ä»»å‹™</button>
                </div>
                <div id="tab-live" class="hidden">
                    <h2 id="live-topic">ç­‰å¾…ä¸­...</h2>
                    <div style="height:300px; margin-top:20px;"><canvas id="myChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div class="dock">
        <div class="dock-app" onclick="UI.toggle('main-win')">ğŸ“Š</div>
        <div class="dock-app">âš™ï¸</div>
    </div>
</div>

<div id="iphone">
    <div class="ios-head">
        <h1 id="ios-topic">ç­‰å¾…è€å¸«é–‹å§‹...</h1>
        <p id="ios-stat" style="color:#007AFF; font-weight:600; margin-top:5px;">æ­£åœ¨é€£æ¥...</p>
    </div>
    <div class="ios-body">
        <div id="ios-opts"></div>
        <button id="ios-submit" class="submit-btn hidden" onclick="App.sendVote()">é€å‡ºæŠ•ç¥¨çµæœ</button>
    </div>
</div>

<script>
const UI = {
    drag(e, id) {
        const el = document.getElementById(id);
        let ox = e.clientX - el.offsetLeft, oy = e.clientY - el.offsetTop;
        const move = (ev) => { el.style.left = (ev.clientX - ox) + 'px'; el.style.top = (ev.clientY - oy) + 'px'; };
        const stop = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', stop);
    },
    toggle(id) { document.getElementById(id).classList.toggle('hidden'); },
    tab(id) {
        ['tab-setup', 'tab-live'].forEach(t => document.getElementById(t).classList.toggle('hidden', t !== id));
        document.querySelectorAll('.side-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(id === 'tab-setup' ? 'è¨­å®š' : 'æ•¸æ“š')));
    },
    tile(side) {
        const win = document.getElementById('main-win');
        win.style.transition = '0.4s cubic-bezier(0.2, 1, 0.2, 1)';
        win.style.top = '32px'; win.style.height = 'calc(100% - 100px)';
        win.style.width = '50%'; win.style.left = (side === 'left' ? '0' : '50%');
        setTimeout(() => win.style.transition = 'none', 500);
    }
};

const App = {
    state: { room: '', topic: '', opts: ['éå¸¸æ»¿æ„', 'é‚„éœ€æ”¹é€²'], votes: {}, selected: '', peer: null, chart: null },
    
    start(role) {
        document.getElementById('login-screen').style.display = 'none';
        if(role === 'teacher') {
            document.getElementById('desktop').style.display = 'block';
            this.initTeacher();
        } else {
            document.getElementById('iphone').style.display = 'flex';
            this.initStudent();
        }
    },

    initTeacher() {
        this.state.room = Math.floor(1000 + Math.random() * 8999).toString();
        document.getElementById('display-id').innerText = this.state.room;
        this.state.peer = new Peer('LUMINA-' + this.state.room);
        this.renderOpts();
        this.state.peer.on('connection', conn => {
            conn.on('data', data => {
                if(data.type === 'vote') { this.state.votes[conn.peer] = data.val; this.updateChart(); }
            });
        });
        setInterval(() => {
            Object.values(this.state.peer.connections).forEach(conns => {
                conns.forEach(c => { if(c.open) c.send({ type: 'sync', ...this.state }); });
            });
        }, 1000);
    },

    initStudent() {
        const r = new URLSearchParams(window.location.search).get('r') || prompt("è¼¸å…¥æˆ¿è™Ÿï¼š");
        this.state.peer = new Peer();
        this.state.peer.on('open', () => {
            const conn = this.state.peer.connect('LUMINA-' + r);
            conn.on('open', () => document.getElementById('ios-stat').innerText = "é€£ç·šæˆåŠŸï¼");
            conn.on('data', data => {
                if(data.type === 'sync') this.renderIOS(data);
            });
            this.state.conn = conn;
        });
    },

    addOpt() { this.state.opts.push('æ–°é¸é …'); this.renderOpts(); },
    renderOpts() {
        const cont = document.getElementById('opt-container');
        cont.innerHTML = this.state.opts.map((o, i) => `
            <input type="text" class="apple-input" value="${o}" oninput="App.state.opts[${i}]=this.value">
        `).join('');
    },

    launch() {
        this.state.topic = document.getElementById('inp-topic').value || 'æœªå‘½åä»»å‹™';
        this.state.votes = {};
        UI.tab('tab-live');
        document.getElementById('live-topic').innerText = this.state.topic;
        this.initChart();
    },

    initChart() {
        const ctx = document.getElementById('myChart').getContext('2d');
        if(this.state.chart) this.state.chart.destroy();
        this.state.chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: this.state.opts, datasets: [{ data: [], backgroundColor: '#007AFF', borderRadius: 10 }] },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
        });
    },

    updateChart() {
        if(!this.state.chart) return;
        this.state.chart.data.datasets[0].data = this.state.opts.map(o => Object.values(this.state.votes).filter(v => v === o).length);
        this.state.chart.update();
    },

    renderIOS(data) {
        document.getElementById('ios-topic').innerText = data.topic || 'ç­‰å¾…ä»»å‹™ä¸­';
        const cont = document.getElementById('ios-opts');
        cont.innerHTML = data.opts.map(o => `
            <div class="option-card ${this.state.selected === o ? 'active' : ''}" onclick="App.state.selected='${o}'; App.renderIOS(${JSON.stringify(data)})">
                ${o} <span>${this.state.selected === o ? 'âœ“' : ''}</span>
            </div>
        `).join('');
        document.getElementById('ios-submit').classList.toggle('hidden', !data.topic);
    },

    sendVote() {
        if(!this.state.selected) return;
        this.state.conn.send({ type: 'vote', val: this.state.selected });
        document.getElementById('ios-submit').innerText = "âœ… å·²é€å‡ºçµæœ";
        document.getElementById('ios-submit').style.background = "#28C840";
    }
};

window.onload = () => {
    const bar = document.getElementById('boot-bar');
    let p = 0;
    const intv = setInterval(() => {
        p += Math.random() * 15;
        bar.style.width = Math.min(p, 100) + '%';
        if(p >= 100) {
            clearInterval(intv);
            setTimeout(() => {
                document.getElementById('boot-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            }, 500);
        }
    }, 150);
};
</script>
</body>
</html>
