<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina | ç­ç´šå°ˆæ¥­æ¸¬é©—ç³»çµ±</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #0071e3;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --bg: #f5f5f7;
            --card: rgba(255, 255, 255, 0.8);
        }
        body { font-family: "SF Pro Display", -apple-system, sans-serif; background: var(--bg); margin: 0; color: #1d1d1f; user-select: none; transition: 0.3s; }
        .app-container { max-width: 800px; margin: auto; padding: 20px; box-sizing: border-box; min-height: 100vh; }
        .glass-card { background: var(--card); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.3); margin-bottom: 20px; }
        .hidden { display: none; }
        
        /* æŒ‰éˆ•è¨­è¨ˆ */
        .btn { padding: 12px 24px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: var(--primary); color: white; width: 100%; }
        .btn-p:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* è€ƒé¡Œå¡ç‰‡ */
        .q-card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; border-left: 6px solid var(--primary); }
        .option-item { display: block; padding: 12px; margin: 8px 0; border: 1px solid #e5e5e5; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .option-item:hover { background: #f0f7ff; border-color: var(--primary); }
        
        /* çµ±è¨ˆæ•¸å­— */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box { background: white; padding: 15px; border-radius: 15px; text-align: center; }
        .stat-val { font-size: 24px; font-weight: bold; color: var(--primary); }

        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 10px; overflow: hidden; }
        th { background: #e5e5ea; padding: 12px; font-size: 14px; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; background: white; }
        .warning-text { color: var(--danger); font-weight: bold; font-size: 12px; }

        #roomQR { border-radius: 12px; background: white; padding: 10px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="app-container">
    <div id="view-start" class="glass-card" style="text-align: center; margin-top: 100px;">
        <h1 style="font-size: 40px; margin-bottom: 10px;">Lumina</h1>
        <p style="color: #86868b; margin-bottom: 30px;">å°ˆæ¥­ã€å®‰å…¨ã€å³æ™‚çš„æ•™å­¸æ¸¬é©—å¹³å°</p>
        <button class="btn btn-p" onclick="initTeacher()">æ•™å¸«ä¸»æ§ç«¯</button>
        <div style="margin: 15px;">æˆ–</div>
        <button class="btn btn-outline" style="width:100%" onclick="initStudent()">å­¸ç”Ÿä½œç­”ç«¯</button>
    </div>

    <div id="view-teacher" class="hidden">
        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>ğŸ‘¨â€ğŸ« æ•™å¸«ç›£æ§ä¸­å¿ƒ</h2>
                <div id="roomIdDisplay" style="font-family: monospace; font-size: 20px; font-weight: bold; background: #eee; padding: 5px 12px; border-radius: 8px;">æˆ¿é–“å»ºç«‹ä¸­...</div>
            </div>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-top: 20px;">
                <canvas id="roomQR"></canvas>
                <div style="flex: 1;">
                    <button class="btn btn-outline" style="width:100%" onclick="downloadSample()">ğŸ“¥ ä¸‹è¼‰ Excel ç¯„ä¾‹</button>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="importExcel(this)" style="margin-top:10px;">
                    <div id="qCount" style="margin-top:10px; color:var(--success); font-weight:bold;"></div>
                </div>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><div>é€£ç·šäººæ•¸</div><div class="stat-val" id="count-connect">0</div></div>
            <div class="stat-box"><div>å¹³å‡åˆ†æ•¸</div><div class="stat-val" id="count-avg">0</div></div>
        </div>

        <button class="btn btn-p" style="margin-bottom:10px;" onclick="broadcastExam()">ğŸš€ ç™¼é€åŠ å¯†è€ƒå·çµ¦å­¸ç”Ÿ</button>

        <div class="glass-card" style="padding: 15px;">
            <h3>ğŸ“Š å­¸ç”Ÿå¯¦æ™‚ç‹€æ…‹</h3>
            <table id="monitorTable">
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>å¾—åˆ†</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
        </div>
        <button class="btn btn-s" style="width:100%; background:var(--success);" onclick="exportExcel()">ğŸ’¾ åŒ¯å‡ºå®Œæ•´ Excel æˆç¸¾å–®</button>
    </div>

    <div id="view-student" class="hidden">
        <div id="stu-header" class="glass-card" style="text-align: center;">
            <h2 id="stu-title">ç­‰å¾…è€å¸«ç™¼å·...</h2>
            <div id="stu-info"></div>
        </div>
        <div id="quiz-area"></div>
        <button id="submit-btn" class="btn btn-p hidden" onclick="studentSubmit()">ç¢ºèªç¹³äº¤è©¦å·</button>
    </div>

    <div id="view-result" class="hidden glass-card" style="text-align:center; margin-top: 100px;">
        <h2 style="color: var(--success);">ç¹³äº¤æˆåŠŸï¼</h2>
        <div style="font-size: 64px; font-weight: bold; margin: 30px 0;" id="final-score">0</div>
        <p>ä½ çš„ç­”æ¡ˆå·²åŠ å¯†å‚³é€åˆ°è€å¸«ç«¯ã€‚</p>
    </div>
</div>

<script>
    let peer, conn, myRoomId;
    let connections = {};
    let studentData = {};
    let masterQuiz = [];
    let blurCount = 0; // å­¸ç”Ÿåˆ‡æ›è¦–çª—è¨ˆæ•¸

    // --- æ•™å¸«é‚è¼¯ ---
    function initTeacher() {
        showView('view-teacher');
        myRoomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        peer = new Peer(myRoomId);
        peer.on('open', id => {
            document.getElementById('roomIdDisplay').innerText = id;
            QRCode.toCanvas(document.getElementById('roomQR'), window.location.href.split('?')[0] + '?room=' + id, { width: 120 });
        });

        peer.on('connection', c => {
            const no = c.metadata.no;
            connections[no] = c;
            studentData[no] = { no: no, progress: "0%", score: 0, ans: {}, qScore: {}, status: "é€£ç·šä¸­", cheats: 0 };
            updateMonitor();

            c.on('data', data => {
                if (data.type === 'update') {
                    studentData[no].progress = data.progress;
                    studentData[no].cheats = data.cheats;
                    updateMonitor();
                }
                if (data.type === 'submit') {
                    const res = calculateScore(no, data.userAns);
                    c.send({ type: 'report', score: res.total });
                }
            });
        });
    }

    function calculateScore(no, userAns) {
        let total = 0;
        let perQ = {};
        masterQuiz.forEach((q, i) => {
            if (userAns[i] === q.ans) {
                total += q.point;
                perQ[i] = q.point;
            } else { perQ[i] = 0; }
        });
        studentData[no].score = total;
        studentData[no].ans = userAns;
        studentData[no].qScore = perQ;
        studentData[no].status = "âœ… å·²ç¹³äº¤";
        updateMonitor();
        return { total: total };
    }

    function updateMonitor() {
        const body = document.getElementById('monitorBody');
        const list = Object.values(studentData);
        document.getElementById('count-connect').innerText = list.length;
        
        let sum = 0;
        body.innerHTML = list.map(s => {
            sum += s.score;
            const cheatWarn = s.cheats > 0 ? `<div class="warning-text">é›¢é  ${s.cheats} æ¬¡</div>` : "";
            return `<tr><td>${s.no}</td><td>${s.progress}${cheatWarn}</td><td>${s.score}</td><td>${s.status}</td></tr>`;
        }).join('');
        document.getElementById('count-avg').innerText = list.length ? (sum / list.length).toFixed(1) : 0;
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            masterQuiz = json.map(r => ({
                q: r.é¡Œç›®,
                opts: { A: r.é¸é …A, B: r.é¸é …B, C: r.é¸é …C, D: r.é¸é …D, E: r.é¸é …E },
                ans: String(r.æ­£ç¢ºç­”æ¡ˆ || "").toUpperCase().split('').sort().join(''),
                point: Number(r.é…åˆ† || 0)
            }));
            document.getElementById('qCount').innerText = `å·²æˆåŠŸåŒ¯å…¥ ${masterQuiz.length} é¡Œ`;
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function broadcastExam() {
        if (!masterQuiz.length) return alert("å°šæœªåŒ¯å…¥è€ƒå·ï¼");
        const safeQuiz = masterQuiz.map(({ ans, ...rest }) => rest);
        Object.values(connections).forEach(c => c.send({ type: 'exam', quiz: safeQuiz }));
        alert("è€ƒå·ç™¼é€æˆåŠŸï¼å­¸ç”Ÿç«¯å°‡è‡ªå‹•é¡¯ç¤ºã€‚");
    }

    function downloadSample() {
        const data = [["é¡Œç›®", "é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D", "é¸é …E", "æ­£ç¢ºç­”æ¡ˆ", "é…åˆ†"], ["1+1=?", "1", "2", "3", "", "", "B", "10"], ["å“ªäº›æ˜¯ç€è¦½å™¨?", "Chrome", "Excel", "Edge", "Word", "", "AC", "20"]];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "è€ƒé¡Œç¯„ä¾‹");
        XLSX.writeFile(wb, "Lumina_è€ƒé¡Œç¯„ä¾‹æª”.xlsx");
    }

    function exportExcel() {
        const exportData = Object.values(studentData).map(s => {
            let row = { "åº§è™Ÿ": s.no, "ç¸½å¾—åˆ†": s.score, "åˆ‡æ›è¦–çª—æ¬¡æ•¸": s.cheats };
            masterQuiz.forEach((_, i) => {
                row[`Q${i+1}ç­”æ¡ˆ`] = s.ans[i] || "";
                row[`Q${i+1}å¾—åˆ†`] = s.qScore[i] || 0;
            });
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾å–®");
        XLSX.writeFile(wb, `ç­ç´šè€ƒè©¦æˆç¸¾_${new Date().toLocaleDateString()}.xlsx`);
    }

    // --- å­¸ç”Ÿé‚è¼¯ ---
    function initStudent() {
        const id = (new URLSearchParams(window.location.search)).get('room') || prompt("è«‹è¼¸å…¥ 4 ä½æˆ¿é–“ ID:");
        const no = prompt("è«‹è¼¸å…¥æ‚¨çš„åº§è™Ÿ:");
        if (!id || !no) return;
        showView('view-student');
        document.getElementById('stu-info').innerText = `åº§è™Ÿ: ${no} | é€£ç·šä¸­...`;

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id.toUpperCase(), { metadata: { no: no } });
            conn.on('open', () => document.getElementById('stu-info').innerText = `åº§è™Ÿ: ${no} | æˆ¿é–“ ${id} é€£ç·šæˆåŠŸ`);
            conn.on('data', data => {
                if (data.type === 'exam') renderStudentExam(data.quiz);
                if (data.type === 'report') showResult(data.score);
            });
        });

        // ç›£æ¸¬é›¢é ä½œå¼Š
        window.onblur = () => {
            blurCount++;
            if(conn) sendProgress(currentQuizLength);
        };
    }

    let currentQuizLength = 0;
    function renderStudentExam(quiz) {
        currentQuizLength = quiz.length;
        document.getElementById('stu-title').innerText = "æ¸¬é©—é€²è¡Œä¸­";
        document.getElementById('submit-btn').classList.remove('hidden');
        let html = '';
        quiz.forEach((q, i) => {
            html += `<div class="q-card"><p style="font-size:18px; font-weight:600;">${i+1}. ${q.q} (${q.point}åˆ†)</p>`;
            Object.entries(q.opts).forEach(([key, val]) => {
                if (val) html += `<label class="option-item"><input type="checkbox" name="q${i}" value="${key}" onchange="sendProgress(${quiz.length})"> ${key}. ${val}</label>`;
            });
            html += `</div>`;
        });
        document.getElementById('quiz-area').innerHTML = html;
    }

    function sendProgress(total) {
        const done = Array.from({length: total}).filter((_, i) => document.querySelector(`input[name="q${i}"]:checked`)).length;
        conn.send({ type: 'update', progress: Math.round((done/total)*100)+"%", cheats: blurCount });
    }

    function studentSubmit() {
        if(!confirm("ç¢ºå®šè¦äº¤å·å—ï¼Ÿ")) return;
        let ans = {};
        for(let i=0; i<currentQuizLength; i++) {
            ans[i] = Array.from(document.querySelectorAll(`input[name="q${i}"]:checked`)).map(el => el.value).sort().join('');
        }
        conn.send({ type: 'submit', userAns: ans });
    }

    function showResult(score) {
        showView('view-result');
        document.getElementById('final-score').innerText = score;
    }

    function showView(id) {
        ['view-start', 'view-teacher', 'view-student', 'view-result'].forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>

</body>
</html>
