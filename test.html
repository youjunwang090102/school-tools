<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LuminaOS Sequoia Pro | æ¬Šå¨é–‹ç™¼è€…æ——è‰¦ç‰ˆ</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        /* --- ç³»çµ±ç´šè®Šæ•¸èˆ‡å¾©åˆ» macOS é¡è‰² --- */
        :root {
            --sys-blue: #007AFF;
            --sys-red: #FF5F57;
            --sys-yellow: #FEBC2E;
            --sys-green: #28C840;
            --bg-active: rgba(255, 255, 255, 0.7);
            --bg-blur: blur(40px) saturate(200%);
            --shadow: 0 30px 60px rgba(0,0,0,0.3);
            --border: 1px solid rgba(255,255,255,0.2);
            --dock-bg: rgba(255, 255, 255, 0.25);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto;
            background: #000; overflow: hidden; user-select: none;
        }

        /* å‹•æ…‹æ¡Œå¸ƒ - æ¨¡ä»¿ Sequoia ç¶“å…¸æ¸²æŸ“ */
        #desktop {
            width: 100vw; height: 100vh;
            background: radial-gradient(circle at 0% 0%, #3e1e5e 0%, #1a0b2e 50%, #000 100%);
            position: relative; overflow: hidden;
        }

        /* --- è¦–çª—ç®¡ç†æ¶æ§‹ --- */
        .window {
            position: absolute; min-width: 400px; min-height: 300px;
            background: var(--bg-active); backdrop-filter: var(--bg-blur);
            border-radius: 12px; box-shadow: var(--shadow);
            border: var(--border); display: flex; flex-direction: column;
            opacity: 0; transform: scale(0.95);
            transition: opacity 0.3s, transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 100;
        }
        .window.active { opacity: 1; transform: scale(1); }
        .window.minimized { transform: scale(0) translateY(1000px); opacity: 0; pointer-events: none; }

        /* æ¨™é¡Œåˆ—èˆ‡æ‰‹ç¹ªæŒ‰éˆ• */
        .title-bar {
            height: 40px; display: flex; align-items: center; padding: 0 16px;
            border-bottom: 1px solid rgba(0,0,0,0.05); cursor: default;
        }
        .controls { display: flex; gap: 8px; width: 60px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 0.5px solid rgba(0,0,0,0.1); position: relative; cursor: pointer; }
        .dot::after { content: ''; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; opacity: 0; font-size: 8px; color: rgba(0,0,0,0.5); font-weight: 800; }
        .dot:hover::after { opacity: 1; }
        .dot-close { background: var(--sys-red); } .dot-close::after { content: 'Ã—'; }
        .dot-min { background: var(--sys-yellow); } .dot-min::after { content: 'âˆ’'; }
        .dot-max { background: var(--sys-green); } .dot-max::after { content: '+'; }
        
        .win-title { flex: 1; text-align: center; font-size: 13px; font-weight: 600; color: #333; }

        /* è¦–çª—ç¸®æ”¾æŠŠæ‰‹ */
        .resizer { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; }

        /* --- æ‡‰ç”¨ç¨‹å¼å…§å®¹å€ --- */
        .win-body { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        
        /* å´é‚Šå°è¦½åˆ— */
        .win-sidebar { width: 200px; background: rgba(0,0,0,0.03); border-right: 1px solid rgba(0,0,0,0.05); padding: 20px 12px; }
        .nav-item { 
            padding: 8px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 2px;
            display: flex; align-items: center; gap: 10px; cursor: pointer; color: #444;
        }
        .nav-item.active { background: rgba(0,0,0,0.08); color: #000; font-weight: 600; }
        .nav-icon { width: 18px; height: 18px; border-radius: 4px; background: var(--sys-blue); }

        /* ä¸»å·¥ä½œå€ */
        .win-main { flex: 1; padding: 25px; display: flex; flex-direction: column; overflow-y: auto; background: #fff; }

        /* --- æ‰‹ç¹ª CSS åœ–ç¤ºèˆ‡ UI çµ„ä»¶ --- */
        .icon-gear { width: 20px; height: 20px; border: 4px dotted #666; border-radius: 50%; }
        .icon-chart { width: 20px; height: 20px; display: flex; align-items: flex-end; gap: 2px; }
        .icon-chart div { width: 4px; background: #666; border-radius: 1px; }

        .apple-input {
            width: 100%; border: 1.5px solid #E5E5E5; padding: 10px 14px; border-radius: 8px;
            font-size: 14px; margin-bottom: 12px; background: #FAFAFA; transition: 0.2s;
        }
        .apple-input:focus { border-color: var(--sys-blue); outline: none; background: #fff; box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }

        .apple-btn {
            background: var(--sys-blue); color: #fff; border: none; padding: 8px 20px;
            border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;
        }
        .apple-btn-outline { background: #E9E9EB; color: #000; }

        /* --- Dock å°èˆªåˆ— --- */
        .dock-wrapper {
            position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%);
            background: var(--dock-bg); backdrop-filter: blur(25px);
            padding: 8px; border-radius: 20px; display: flex; align-items: flex-end;
            gap: 12px; border: var(--border); z-index: 1000;
        }
        .dock-item {
            width: 50px; height: 50px; border-radius: 12px; position: relative;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), margin 0.2s;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .dock-item:hover { transform: scale(1.4) translateY(-15px); margin: 0 10px; }
        .dock-item-img { width: 100%; height: 100%; border-radius: 12px; background: linear-gradient(180deg, #fff, #ddd); box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .dock-dot { width: 4px; height: 4px; background: rgba(255,255,255,0.6); border-radius: 50%; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); opacity: 0; }
        .dock-dot.active { opacity: 1; }

        /* --- æ‰‹æ©Ÿæ¨¡å¼ï¼šiOS æŒ‡ä»¤ä¸­å¿ƒ --- */
        #mobile-ios {
            position: fixed; inset: 0; background: #F2F2F7; display: none; flex-direction: column; z-index: 9000;
        }
        .ios-status-bar { height: 44px; display: flex; justify-content: space-between; padding: 0 20px; align-items: center; font-size: 14px; font-weight: 600; }
        .ios-card { background: #fff; border-radius: 16px; margin: 10px 20px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .ios-option { padding: 18px; border-radius: 12px; background: #fff; margin-bottom: 12px; border: 1px solid #E5E5E5; display: flex; justify-content: space-between; }
        .ios-option.selected { border: 2.5px solid var(--sys-blue); background: rgba(0,122,255,0.05); }

        /* åŠŸèƒ½æ€§é¡åˆ¥ */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .chart-wrap { flex: 1; position: relative; min-height: 250px; }

    </style>
</head>
<body>

<div id="desktop">
    <div id="win-master" class="window active" style="width: 900px; height: 600px; top: 100px; left: 150px;">
        <div class="title-bar" onmousedown="handleDragStart(event, 'win-master')">
            <div class="controls">
                <div class="dot dot-close" onclick="closeWindow('win-master')"></div>
                <div class="dot dot-min" onclick="minimizeWindow('win-master')"></div>
                <div class="dot dot-max"></div>
            </div>
            <div class="win-title">Lumina Master Center</div>
        </div>
        <div class="win-body flex" style="flex-direction: row;">
            <div class="win-sidebar">
                <div class="nav-item active" onclick="switchView('config')">
                    <div class="nav-icon" style="background: #5856D6;"></div> é…ç½®ä»»å‹™
                </div>
                <div class="nav-item" onclick="switchView('analytics')">
                    <div class="nav-icon" style="background: #FF2D55;"></div> å³æ™‚åˆ†æ
                </div>
                <div class="nav-item" onclick="switchView('broadcast')">
                    <div class="nav-icon" style="background: #34C759;"></div> é€£ç·šç‹€æ…‹
                </div>
            </div>
            <div class="win-main" id="master-content">
                <div id="v-config">
                    <h1 style="font-size: 24px; margin-bottom: 20px;">ä»»å‹™é…ç½®</h1>
                    <label style="font-size: 12px; color: #888; font-weight: 700;">æŠ•ç¥¨é¡Œç›®</label>
                    <input type="text" id="t-topic" class="apple-input" placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥èª²ç¨‹å¸æ”¶ç‡" oninput="state.topic = this.value">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                        <label style="font-size: 12px; color: #888; font-weight: 700;">é¸é …ç®¡ç†</label>
                        <button class="apple-btn-outline apple-btn" style="padding: 4px 10px;" onclick="addOption()">+ æ–°å¢</button>
                    </div>
                    <div id="t-option-list" style="margin-top: 10px; max-height: 200px; overflow-y: auto; padding-right: 10px;"></div>
                    
                    <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="font-size: 12px; color: #888;">è¨­å®šæ™‚é–“ (ç§’)</label>
                            <input type="number" id="t-duration" class="apple-input" value="60">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button id="btn-start" class="apple-btn" style="width: 100%; height: 42px;" onclick="startVoting()">ğŸš€ ç™¼å¸ƒæŒ‡ä»¤</button>
                            <button id="btn-stop" class="apple-btn hidden" style="width: 100%; height: 42px; background: var(--sys-red);" onclick="stopVoting()">åœæ­¢æŠ•ç¥¨</button>
                        </div>
                    </div>
                </div>

                <div id="v-analytics" class="hidden">
                    <h1 id="main-topic-title" style="font-size: 24px;">æ•¸æ“šåˆ†æ</h1>
                    <div class="chart-wrap">
                        <canvas id="masterChart"></canvas>
                    </div>
                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                        <div style="background: #F2F2F7; padding: 15px; border-radius: 12px; flex: 1;">
                            <div style="font-size: 11px; color: #888;">æˆ¿è™Ÿä»£ç¢¼</div>
                            <div id="room-id-val" style="font-size: 24px; font-weight: 800; color: var(--sys-blue);">----</div>
                        </div>
                        <div style="background: #F2F2F7; padding: 15px; border-radius: 12px; flex: 1;">
                            <div style="font-size: 11px; color: #888;">å·²åƒèˆ‡äººæ•¸</div>
                            <div id="vote-count-val" style="font-size: 24px; font-weight: 800;">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="resizer" onmousedown="handleResizeStart(event, 'win-master')"></div>
    </div>

    <div id="win-student-login" class="window" style="width: 350px; height: 450px; top: 150px; left: 600px;">
        <div class="title-bar" onmousedown="handleDragStart(event, 'win-student-login')">
            <div class="controls"><div class="dot dot-close" onclick="closeWindow('win-student-login')"></div></div>
            <div class="win-title">Join Mission</div>
        </div>
        <div class="win-main" style="text-align: center; justify-content: center;">
            <canvas id="t-qr" style="width: 150px; height: 150px; margin: 0 auto 20px; border-radius: 10px;"></canvas>
            <p style="font-size: 13px; color: #666;">æƒæ QR Code æˆ–è¼¸å…¥æˆ¿è™Ÿ</p>
            <input type="text" id="s-room-input" class="apple-input" placeholder="Room ID" style="text-align: center; font-size: 24px;">
            <button class="apple-btn" style="width: 100%;" onclick="initStudent()">é€²å…¥çµ‚ç«¯</button>
        </div>
    </div>

    <div class="dock-wrapper">
        <div class="dock-item" onclick="toggleWindow('win-master')">
            <div class="dock-item-img" style="background: linear-gradient(135deg, #007AFF, #00C7FF);">ğŸ </div>
            <div class="dock-dot active"></div>
        </div>
        <div class="dock-item" onclick="toggleWindow('win-student-login')">
            <div class="dock-item-img" style="background: linear-gradient(135deg, #34C759, #00D2FF);">ğŸ“¡</div>
            <div class="dock-dot"></div>
        </div>
        <div class="dock-item">
            <div class="dock-item-img" style="background: linear-gradient(135deg, #FF9500, #FFCC00);">âš™ï¸</div>
        </div>
    </div>
</div>

<div id="mobile-ios">
    <div class="ios-status-bar">
        <span>9:41</span>
        <div style="display: flex; gap: 5px;">ğŸ“¶ ğŸ”‹</div>
    </div>
    <div style="padding: 20px 20px 10px;">
        <h1 id="m-topic" style="font-size: 34px; margin: 0;">Lumina ä»»å‹™</h1>
        <p id="m-status" style="color: #888; margin-top: 5px;">æº–å‚™é€£ç·š...</p>
    </div>
    <div class="ios-card" style="text-align: center;">
        <div id="m-timer" style="font-size: 56px; font-weight: 800;">00:60</div>
        <p style="font-size: 12px; color: #888; text-transform: uppercase;">å‰©é¤˜æ™‚é–“</p>
    </div>
    <div id="m-options" style="flex: 1; overflow-y: auto; padding-top: 10px;"></div>
    <div id="m-results" class="hidden" style="padding-bottom: 40px;">
        <div class="ios-card">
            <h3 style="margin-top: 0;">ä»»å‹™çµ±è¨ˆ</h3>
            <div id="m-res-list"></div>
        </div>
    </div>
</div>

<script>
/**
 * LuminaOS Sequoia Pro å¼•æ“
 * æ‰€æœ‰æ“ä½œæ¨¡ä»¿ç³»çµ±åŸç”Ÿè¡Œç‚º
 */

let state = {
    roomID: '',
    topic: 'ç›®å‰çš„å­¸ç¿’é€²åº¦ç‚ºä½•ï¼Ÿ',
    options: ['å®Œå…¨ç†è§£', 'éœ€è¦è¤‡ç¿’', 'å®Œå…¨è·Ÿä¸ä¸Š'],
    votes: {},
    voterMap: {},
    isLive: false,
    timeLeft: '00:60',
    showResult: false,
    onlineCount: 0
};

let peer, conn, myChart, timerInt;

// --- è¦–çª—ç®¡ç†ç³»çµ± (Window Server) ---
let zIndexCounter = 1000;
function focusWindow(id) {
    const el = document.getElementById(id);
    zIndexCounter++;
    el.style.zIndex = zIndexCounter;
}

function handleDragStart(e, id) {
    focusWindow(id);
    const el = document.getElementById(id);
    let startX = e.clientX - el.offsetLeft;
    let startY = e.clientY - el.offsetTop;

    function move(e) {
        el.style.left = (e.clientX - startX) + 'px';
        el.style.top = (e.clientY - startY) + 'px';
    }
    function end() {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', end);
    }
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', end);
}

function handleResizeStart(e, id) {
    const el = document.getElementById(id);
    let startW = el.offsetWidth;
    let startH = el.offsetHeight;
    let startX = e.clientX;
    let startY = e.clientY;

    function move(e) {
        el.style.width = (startW + (e.clientX - startX)) + 'px';
        el.style.height = (startH + (e.clientY - startY)) + 'px';
        if(myChart) myChart.resize();
    }
    function end() {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', end);
    }
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', end);
}

function toggleWindow(id) {
    const win = document.getElementById(id);
    if(win.classList.contains('hidden')) {
        win.classList.remove('hidden');
        setTimeout(() => win.classList.add('active'), 10);
    } else {
        win.classList.toggle('minimized');
    }
    focusWindow(id);
}

// --- è€å¸«ç«¯é‚è¼¯ ---
function initMaster() {
    state.roomID = Math.floor(1000 + Math.random() * 8999).toString();
    peer = new Peer('LUMINA-' + state.roomID);

    peer.on('open', () => {
        document.getElementById('room-id-val').innerText = state.roomID;
        QRCode.toCanvas(document.getElementById('t-qr'), window.location.origin + window.location.pathname + '?r=' + state.roomID);
        renderOptions();
        initChart();
        startBroadcast();
    });

    peer.on('connection', c => {
        c.on('data', d => {
            if(d.type === 'vote' && state.isLive) {
                if(state.voterMap[c.peer]) state.votes[state.voterMap[c.peer]]--;
                state.voterMap[c.peer] = d.val;
                state.votes[d.val] = (state.votes[d.val] || 0) + 1;
                updateChart();
            }
        });
    });
}

function renderOptions() {
    const list = document.getElementById('t-option-list');
    list.innerHTML = state.options.map((opt, i) => `
        <div style="display:flex; gap:8px; margin-bottom:8px;">
            <input type="text" class="apple-input" value="${opt}" oninput="state.options[${i}]=this.value" style="margin:0">
            <button class="apple-btn-outline apple-btn" style="color:var(--sys-red)" onclick="state.options.splice(${i},1); renderOptions();">âœ•</button>
        </div>
    `).join('');
}

function addOption() {
    state.options.push("æ–°é¸é … " + (state.options.length + 1));
    renderOptions();
}

function switchView(view) {
    document.getElementById('v-config').classList.toggle('hidden', view !== 'config');
    document.getElementById('v-analytics').classList.toggle('hidden', view !== 'analytics');
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.innerText.includes(view === 'config' ? 'é…ç½®' : 'åˆ†æ'));
    });
    
    if(view === 'analytics') {
        document.getElementById('main-topic-title').innerText = state.topic;
        setTimeout(updateChart, 50);
    }
}

function initChart() {
    const ctx = document.getElementById('masterChart').getContext('2d');
    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: state.options,
            datasets: [{ data: [], backgroundColor: '#007AFF', borderRadius: 8 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true }, y: { ticks: { font: { weight: 'bold' } } } }
        }
    });
}

function updateChart() {
    if(!myChart) return;
    myChart.data.labels = state.options;
    myChart.data.datasets[0].data = state.options.map(o => state.votes[o] || 0);
    myChart.update();
    document.getElementById('vote-count-val').innerText = Object.keys(state.voterMap).length;
}

function startVoting() {
    state.isLive = true; state.showResult = false;
    state.voterMap = {}; state.options.forEach(o => state.votes[o] = 0);
    switchView('analytics');
    
    document.getElementById('btn-start').classList.add('hidden');
    document.getElementById('btn-stop').classList.remove('hidden');

    let total = parseInt(document.getElementById('t-duration').value);
    timerInt = setInterval(() => {
        total--;
        let s = total.toString().padStart(2, '0');
        state.timeLeft = `00:${s}`;
        if(total <= 0) stopVoting();
    }, 1000);
}

function stopVoting() {
    state.isLive = false; state.showResult = true;
    clearInterval(timerInt);
    document.getElementById('btn-start').classList.remove('hidden');
    document.getElementById('btn-stop').classList.add('hidden');
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
}

function startBroadcast() {
    setInterval(() => {
        const payload = { ...state, type: 'sync' };
        Object.values(peer.connections).forEach(conns => conns.forEach(c => { if(c.open) c.send(payload); }));
    }, 800);
}

// --- è£ç½®åµæ¸¬èˆ‡å­¸ç”Ÿç«¯ ---
function initStudent() {
    const rid = document.getElementById('s-room-input').value;
    if(!rid) return;
    
    document.getElementById('desktop').classList.add('hidden');
    document.getElementById('mobile-ios').style.display = 'flex';
    
    peer = new Peer();
    peer.on('open', () => {
        const s_conn = peer.connect('LUMINA-' + rid);
        s_conn.on('open', () => {
            document.getElementById('m-status').innerText = "å·²é€£ç·šè‡³æˆ¿è™Ÿï¼š" + rid;
        });
        s_conn.on('data', d => {
            if(d.type === 'sync') syncIOS(d, s_conn);
        });
    });
}

let myVote = "";
function syncIOS(data, conn) {
    document.getElementById('m-topic').innerText = data.topic;
    document.getElementById('m-timer').innerText = data.timeLeft;
    
    const optArea = document.getElementById('m-options');
    const resArea = document.getElementById('m-results');

    if(data.showResult) {
        optArea.classList.add('hidden');
        resArea.classList.remove('hidden');
        const total = Object.keys(data.voterMap).length || 1;
        document.getElementById('m-res-list').innerHTML = data.options.map(o => {
            const v = data.votes[o] || 0;
            const p = Math.round(v/total*100);
            return `
                <div style="margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-weight:600;">
                        <span>${o}</span><span>${v} ç¥¨ (${p}%)</span>
                    </div>
                    <div style="height:10px; background:#E5E5EA; border-radius:10px; overflow:hidden;">
                        <div style="height:100%; width:${p}%; background:var(--sys-blue); transition:1s;"></div>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        optArea.classList.remove('hidden');
        resArea.classList.add('hidden');
        optArea.innerHTML = data.options.map(o => `
            <div class="ios-option ${myVote === o ? 'selected' : ''}" onclick="handleIOSVote('${o}', ${data.isLive}, '${conn.peer}')">
                <span style="font-size:17px; font-weight:500;">${o}</span>
                ${myVote === o ? '<span style="color:var(--sys-blue)">âœ“</span>' : ''}
            </div>
        `).join('');
    }
}

function handleIOSVote(val, live, peerID) {
    if(!live) return;
    myVote = val;
    const teacherConn = Object.values(peer.connections)[0][0]; // å–å¾—ç•¶å‰å”¯ä¸€çš„é€£ç·š
    teacherConn.send({ type: 'vote', val: val });
}

// å•Ÿå‹•æª¢æ¸¬
window.onload = () => {
    // ç°¡å–®è£ç½®æª¢æ¸¬
    if(/Android|iPhone|iPad/i.test(navigator.userAgent)) {
        document.getElementById('desktop').classList.add('hidden');
        document.getElementById('mobile-ios').style.display = 'flex';
        const r = new URLSearchParams(window.location.search).get('r');
        if(r) {
            document.getElementById('s-room-input').value = r;
            initStudent();
        }
    }
    initMaster();
};
</script>
</body>
</html>
