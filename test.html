<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina Pro | å°ˆæ¥­ç©©å®šç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; user-select: none; }
        .app { max-width: 800px; margin: auto; padding: 15px; }
        .glass { background: #FFF; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .hidden { display: none !important; }
        .btn { padding: 12px 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-p { background: var(--p); color: #FFF; width: 100%; }
        .btn-s { background: var(--s); color: #FFF; }
        .btn-d { background: var(--d); color: #FFF; }
        
        /* é–å®šé®ç½© - æœ€é«˜æ¬Šé™ */
        #lockMask { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 999999; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        
        .q-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
        .q-num-btn { min-width: 45px; height: 45px; border-radius: 10px; border: 1px solid #DDD; display: flex; align-items: center; justify-content: center; background: #FFF; flex-shrink: 0; }
        .q-num-btn.active { background: var(--p); color: #FFF; }
        .q-num-btn.done { border: 2px solid var(--p); color: var(--p); }

        input[type="text"], input[type="number"] { padding: 12px; border-radius: 10px; border: 1px solid #DDD; font-size: 16px; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th, td { padding: 10px 5px; text-align: center; border-bottom: 1px solid #EEE; }
    </style>
</head>
<body>

<div id="lockMask" class="hidden">
    <h1 style="font-size: 60px;">ğŸ”’</h1>
    <h2>è€å¸«å·²æš«åœæ‚¨çš„ä½œç­”</h2>
    <p>è«‹æŠ¬é ­è½è¬›ï¼Œå‹¿æ“ä½œæ‰‹æ©Ÿ</p>
</div>

<div class="app">
    <div id="v-start" class="glass" style="text-align:center; margin-top:50px;">
        <h1 style="font-size: 32px; color: var(--p);">Lumina Pro</h1>
        <p>å°ˆæ¥­æ•™å­¸ P2P è€ƒè©•ç³»çµ±</p>
        <button class="btn btn-p" onclick="showView('v-teacher-setup')" style="margin-bottom: 15px;">æ•™å¸«ç«¯å…¥å£ (è¨­å®šé¡Œç›®)</button>
        <button class="btn" onclick="goToStudentLogin()" style="width:100%; background:#8E8E93; color:white;">å­¸ç”Ÿç«¯å…¥å£ (é–‹å§‹ä½œç­”)</button>
    </div>

    <div id="v-student-login" class="hidden glass">
        <h2>âœï¸ å­¸ç”Ÿç™»å…¥</h2>
        <input type="text" id="stuRoomId" placeholder="è¼¸å…¥è€å¸«æä¾›çš„æˆ¿è™Ÿ" style="width:100%;">
        <input type="text" id="stuNo" placeholder="è¼¸å…¥ä½ çš„åº§è™Ÿ" style="width:100%;">
        <button class="btn btn-p" onclick="initStudent()">é€²å…¥è€ƒå ´</button>
        <button class="btn" onclick="showView('v-start')" style="width:100%; margin-top:10px; background:none; color:gray;">è¿”å›</button>
    </div>

    <div id="v-teacher-setup" class="hidden glass">
        <h2>ğŸ‘¨â€ğŸ« è¨­å®šè€ƒå ´</h2>
        <input type="text" id="customRoomId" placeholder="è‡ªè¨‚æˆ¿è™Ÿ (å¦‚: MATH101)" style="width:100%;">
        <div id="qList"></div>
        <button class="btn btn-s" onclick="addQuestion()" style="width:100%;">+ æ–°å¢é¡Œç›®</button>
        <button class="btn btn-p" onclick="initTeacher()" style="width:100%; margin-top:20px; padding:18px;">å•Ÿå‹•ä¸¦é–‹å•Ÿè€ƒå ´</button>
    </div>

    <div id="v-teacher-main" class="hidden">
        <div class="glass" style="text-align:center;">
            <h2 id="roomDisplay">ID: ----</h2>
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
                <button class="btn btn-s" onclick="broadcastExam()">ğŸš€ æ´¾é€è€ƒå·</button>
                <button id="allLockBtn" class="btn btn-d" onclick="toggleAllLock()">ğŸ”’ å…¨é«”é–å®š</button>
            </div>
            <canvas id="roomQR" style="margin: auto;"></canvas>
        </div>
        <div class="glass">
            <h3>ğŸ“Š å­¸ç”Ÿå¯¦æ™‚é€²åº¦</h3>
            <table>
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>é›¢é </th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
            <button class="btn btn-s" onclick="exportExcel()" style="width:100%; margin-top:15px;">ğŸ’¾ åŒ¯å‡º Excel æˆç¸¾å–®</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div class="glass">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b id="stuInfoDisplay">åº§è™Ÿ: --</b>
                <button class="btn btn-d" onclick="location.reload()" style="padding:4px 10px; font-size:12px;">ç™»å‡º</button>
            </div>
            <div id="qNav" class="q-nav" style="margin-top:15px;"></div>
        </div>
        <div id="quizContainer" class="glass" style="min-height:200px;">
            <p style="text-align:center; color:gray; padding:50px 0;">ç­‰å¾…è©¦å·æ´¾é€...</p>
        </div>
        <button id="subBtn" class="btn btn-p hidden" onclick="studentSubmit()" style="padding:15px; font-size:18px;">ç¹³äº¤è€ƒå·</button>
    </div>

    <div id="v-result" class="hidden glass" style="text-align:center; margin-top:100px;">
        <h2 style="color:var(--s)">ç¹³äº¤æˆåŠŸ</h2>
        <div id="resScore" style="font-size:70px; font-weight:bold;">0</div>
        <p>åˆ†</p>
        <button class="btn btn-p" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<script>
    let peer, conn, myRoomId, myNo;
    let masterQuiz = [], studentData = {}, connections = {};
    let isAllLocked = false, isExamSent = false;

    function showView(id) {
        ['v-start','v-student-login','v-teacher-setup','v-teacher-main','v-student','v-result'].forEach(v => {
            document.getElementById(v).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }

    function goToStudentLogin() {
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('room')) document.getElementById('stuRoomId').value = urlParams.get('room');
        showView('v-student-login');
    }

    // --- æ•™å¸«é‚è¼¯ ---
    function addQuestion() {
        const idx = document.querySelectorAll('.edit-card').length;
        const html = `<div class="edit-card glass" style="padding:10px; margin-bottom:10px; border:1px solid #EEE;">
            <b>Q${idx+1}</b> <input type="text" placeholder="é¡Œç›®" class="in-q" style="width:70%;">
            <input type="text" placeholder="ç­”æ¡ˆ" class="in-ans" style="width:40px;">
            <input type="number" value="10" class="in-pt" style="width:40px;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
                <input type="text" placeholder="A" class="in-a"> <input type="text" placeholder="B" class="in-b">
                <input type="text" placeholder="C" class="in-c"> <input type="text" placeholder="D" class="in-d">
            </div>
        </div>`;
        document.getElementById('qList').insertAdjacentHTML('beforeend', html);
    }

    function initTeacher() {
        const cards = document.querySelectorAll('.edit-card');
        if(cards.length === 0) return alert("è«‹å…ˆæ–°å¢é¡Œç›®ï¼");
        masterQuiz = Array.from(cards).map(c => ({
            q: c.querySelector('.in-q').value,
            opts: {A: c.querySelector('.in-a').value, B: c.querySelector('.in-b').value, C: c.querySelector('.in-c').value, D: c.querySelector('.in-d').value},
            ans: c.querySelector('.in-ans').value.toUpperCase().trim(),
            point: Number(c.querySelector('.in-pt').value)
        }));

        myRoomId = document.getElementById('customRoomId').value.toUpperCase().trim() || "ROOM" + Math.floor(Math.random()*999);
        peer = new Peer(myRoomId);
        peer.on('open', id => {
            showView('v-teacher-main');
            document.getElementById('roomDisplay').innerText = "æˆ¿è™Ÿ: " + id;
            QRCode.toCanvas(document.getElementById('roomQR'), window.location.href.split('?')[0] + '?room=' + id);
        });

        peer.on('connection', c => {
            const no = c.metadata.no;
            connections[no] = c;
            if(!studentData[no]) studentData[no] = { no: no, progress: "0%", score: 0, status: "åœ¨ç·š", cheats: 0, isLocked: false, hasExam: false, ans: {} };
            studentData[no].status = "åœ¨ç·š";
            
            // é—œéµï¼šAndroid é‡é€£è‡ªå‹•è£œç™¼ç‹€æ…‹
            setTimeout(() => {
                if(isAllLocked || studentData[no].isLocked) c.send({type: 'lock', state: true});
                if(isExamSent) c.send({type: 'exam', quiz: masterQuiz.map(({ans, ...r})=>r)});
            }, 1000);

            c.on('data', d => {
                if(d.type === 'sync') { studentData[no].progress = d.progress; studentData[no].cheats = d.cheats; studentData[no].ans = d.ans; updateMonitor(); }
                if(d.type === 'submit') {
                    let total = 0;
                    masterQuiz.forEach((q, i) => { if(d.ans[i] === q.ans) total += q.point; });
                    studentData[no].score = total;
                    studentData[no].status = "âœ… å·²ç¹³";
                    c.send({type: 'report', score: total});
                    updateMonitor();
                }
            });
            c.on('close', () => { studentData[no].status = "é›¢ç·š"; updateMonitor(); });
        });
    }

    function broadcastExam() {
        isExamSent = true;
        const safe = masterQuiz.map(({ans, ...r}) => r);
        Object.values(connections).forEach(c => { if(c.open) c.send({type: 'exam', quiz: safe}); });
        alert("è€ƒå·å·²æˆåŠŸæ´¾é€çµ¦æ‰€æœ‰é€£ç·šå­¸ç”Ÿï¼");
    }

    function toggleAllLock() {
        isAllLocked = !isAllLocked;
        Object.values(connections).forEach(c => { if(c.open) c.send({type: 'lock', state: isAllLocked}); });
        document.getElementById('allLockBtn').innerText = isAllLocked ? "ğŸ”“ è§£é™¤å…¨é«”" : "ğŸ”’ å…¨é«”é–å®š";
        updateMonitor();
    }

    function toggleSingleLock(no) {
        studentData[no].isLocked = !studentData[no].isLocked;
        if(connections[no]) connections[no].send({type: 'lock', state: studentData[no].isLocked});
        updateMonitor();
    }

    function updateMonitor() {
        document.getElementById('monitorBody').innerHTML = Object.values(studentData).map(s => `
            <tr>
                <td>${s.no}</td><td>${s.progress}</td><td style="color:${s.cheats>0?'red':''}">${s.cheats}</td>
                <td><span style="color:${s.status==='åœ¨ç·š'?'green':'gray'}">${s.status}</span></td>
                <td><button class="btn" style="padding:4px 8px; background:${s.isLocked?'#34C759':'#FF3B30'}; color:white" onclick="toggleSingleLock('${s.no}')">${s.isLocked?'è§£':'é–'}</button></td>
            </tr>`).join('');
    }

    function exportExcel() {
        const data = Object.values(studentData).map(s => {
            let row = {"åº§è™Ÿ": s.no, "å¾—åˆ†": s.score, "é›¢é æ¬¡æ•¸": s.cheats};
            masterQuiz.forEach((_, i) => row[`Q${i+1}`] = s.ans[i] || "");
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾");
        XLSX.writeFile(wb, "æˆç¸¾å–®.xlsx");
    }

    // --- å­¸ç”Ÿé‚è¼¯ ---
    let myAnswers = {}, stuQuiz = [], stuCheats = 0;
    function initStudent() {
        const id = document.getElementById('stuRoomId').value.toUpperCase().trim();
        myNo = document.getElementById('stuNo').value.trim();
        if(!id || !myNo) return alert("è«‹å¡«å¯«å®Œæ•´ï¼");
        
        showView('v-student');
        document.getElementById('stuInfoDisplay').innerText = "åº§è™Ÿ: " + myNo;

        peer = new Peer();
        peer.on('open', () => {
            const c = peer.connect(id, { metadata: { no: myNo } });
            c.on('data', d => {
                if(d.type === 'exam') { stuQuiz = d.quiz; renderStuExam(); }
                if(d.type === 'lock') document.getElementById('lockMask').classList.toggle('hidden', !d.state);
                if(d.type === 'report') { showView('v-result'); document.getElementById('resScore').innerText = d.score; localStorage.removeItem('ans_'+myNo); }
            });
            window.activeConn = c;
        });

        document.addEventListener('visibilitychange', () => { if(document.visibilityState === 'hidden') { stuCheats++; syncStu(); } });
    }

    function renderStuExam() {
        myAnswers = JSON.parse(localStorage.getItem('ans_'+myNo) || "{}");
        let html = '';
        stuQuiz.forEach((_, i) => html += `<div class="q-num-btn ${myAnswers[i]?'done':''}" id="nb-${i}" onclick="jumpTo(${i})">${i+1}</div>`);
        document.getElementById('qNav').innerHTML = html;
        jumpTo(0);
    }

    function jumpTo(idx) {
        const q = stuQuiz[idx];
        let opts = '';
        Object.entries(q.opts).forEach(([k, v]) => {
            if(!v) return;
            const checked = (myAnswers[idx] || "").includes(k) ? "checked" : "";
            opts += `<label style="display:block; padding:15px; background:#F2F2F7; margin-bottom:10px; border-radius:12px;">
                <input type="checkbox" name="opt" value="${k}" ${checked} onchange="saveAns(${idx})"> ${k}. ${v}
            </label>`;
        });
        document.getElementById('quizContainer').innerHTML = `<h3>ç¬¬ ${idx+1} é¡Œ</h3><p>${q.q}</p>${opts}`;
        document.querySelectorAll('.q-num-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nb-'+idx).classList.add('active');
        document.getElementById('subBtn').classList.toggle('hidden', idx !== stuQuiz.length-1);
    }

    function saveAns(idx) {
        const sel = Array.from(document.querySelectorAll('input[name="opt"]:checked')).map(e => e.value).sort().join('');
        myAnswers[idx] = sel;
        localStorage.setItem('ans_'+myNo, JSON.stringify(myAnswers));
        document.getElementById('nb-'+idx).classList.add('done');
        syncStu();
    }

    function syncStu() {
        const done = Object.values(myAnswers).filter(v => v !== "").length;
        const prog = Math.round((done / stuQuiz.length) * 100) + "%";
        if(window.activeConn && window.activeConn.open) {
            window.activeConn.send({type: 'sync', progress: prog, cheats: stuCheats, ans: myAnswers});
        }
    }

    function studentSubmit() { if(confirm("ç¢ºå®šç¹³äº¤å…¨å·ï¼Ÿ")) window.activeConn.send({type: 'submit', ans: myAnswers}); }
</script>
</body>
</html>
