<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LuminaOS Sequoia Pro | Elite Developer Edition</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        /* --- macOS Sequoia Core Design Tokens --- */
        :root {
            --sf-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            --active-blur: blur(50px) saturate(210%);
            --win-bg: rgba(255, 255, 255, 0.72);
            --win-border: rgba(255, 255, 255, 0.4);
            --sys-accent: #007AFF;
            --dock-bg: rgba(255, 255, 255, 0.25);
            --shadow-win: 0 40px 100px rgba(0,0,0,0.35), 0 0 0 1px rgba(0,0,0,0.05);
            --shadow-dock: 0 10px 30px rgba(0,0,0,0.2);
            --transition-spring: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -webkit-user-drag: none; }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; font-family: var(--sf-font); overflow: hidden; background: #000; }

        /* --- Desktop Fluid Background (Dynamic Sequoia) --- */
        .desktop-engine {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(125deg, #1e3c72 0%, #2a5298 20%, #7028e4 50%, #e5b2ca 80%, #ff9a9e 100%);
            background-size: 400% 400%; animation: sequoiaFlow 30s ease infinite;
        }
        @keyframes sequoiaFlow { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }

        /* --- Window Server Management (The Core) --- */
        .window-manager { position: relative; width: 100%; height: 100%; padding-top: 30px; }
        
        .win-frame {
            position: absolute; min-width: 450px; min-height: 350px;
            background: var(--win-bg); backdrop-filter: var(--active-blur);
            border-radius: 12px; border: 1px solid var(--win-border);
            box-shadow: var(--shadow-win); display: flex; flex-direction: column;
            visibility: hidden; transform: scale(0.8) translateY(50px); opacity: 0;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.4s;
            overflow: hidden;
        }
        .win-frame.visible { visibility: visible; transform: scale(1) translateY(0); opacity: 1; }
        .win-frame.maximized { inset: 10px !important; width: calc(100vw - 20px) !important; height: calc(100vh - 100px) !important; transition: all 0.3s ease; }
        .win-frame.minimized { transform: scale(0.1) translateY(800px) skewX(20deg); opacity: 0; pointer-events: none; }
        
        /* Title Bar & Control Dots */
        .win-header { height: 42px; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid rgba(0,0,0,0.06); cursor: default; }
        .traffic-lights { display: flex; gap: 8px; width: 52px; }
        .t-dot { width: 12px; height: 12px; border-radius: 50%; border: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 800; cursor: pointer; }
        .t-dot:hover::before { opacity: 1; }
        .t-dot::before { opacity: 0; transition: 0.2s; }
        .close { background: #FF5F57; } .close::before { content: 'Ã—'; }
        .min { background: #FEBC2E; } .min::before { content: 'âˆ’'; }
        .max { background: #28C840; } .max::before { content: '+'; }
        .win-title { flex: 1; text-align: center; font-size: 13px; font-weight: 600; color: #444; }

        /* --- System Navigation --- */
        .win-container { display: flex; flex: 1; overflow: hidden; }
        .win-sidebar { width: 180px; background: rgba(0,0,0,0.04); border-right: 1px solid rgba(0,0,0,0.05); padding: 15px 8px; }
        .win-content { flex: 1; background: #FFF; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .side-btn { 
            padding: 8px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 2px;
            cursor: pointer; transition: 0.2s; color: #444; display: flex; align-items: center; gap: 8px;
        }
        .side-btn:hover { background: rgba(0,0,0,0.05); }
        .side-btn.active { background: rgba(0,122,255,0.12); color: var(--sys-accent); font-weight: 600; }
        .icon-box { width: 18px; height: 18px; border-radius: 4px; }

        /* --- Resizing & Snapping --- */
        .resizer-r { position: absolute; right: 0; top: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resizer-b { position: absolute; bottom: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resizer-rb { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; z-index: 10; }

        /* --- macOS Dock --- */
        .dock-bar {
            position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%);
            background: var(--dock-bg); backdrop-filter: blur(25px);
            padding: 8px; border-radius: 20px; display: flex; align-items: flex-end;
            gap: 12px; border: 1px solid rgba(255,255,255,0.2); box-shadow: var(--shadow-dock);
            z-index: 9999;
        }
        .dock-app {
            width: 50px; height: 50px; border-radius: 12px; cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), margin 0.2s;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .dock-app:hover { transform: scale(1.4) translateY(-15px); margin: 0 12px; }
        .dock-app-icon { width: 100%; height: 100%; border-radius: 12px; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 26px; display: flex; align-items: center; justify-content: center; }
        .app-dot { width: 4px; height: 4px; background: #fff; border-radius: 50%; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); opacity: 0; }
        .app-dot.running { opacity: 1; }

        /* --- Functional UI Components --- */
        .apple-input { width: 100%; border: 1.5px solid #e5e5e5; padding: 12px 14px; border-radius: 10px; font-size: 14px; transition: 0.2s; background: #fafafa; }
        .apple-input:focus { border-color: var(--sys-accent); outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(0,122,255,0.1); }
        .apple-btn { background: var(--sys-accent); color: #fff; border: none; padding: 10px 24px; border-radius: 10px; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .apple-btn:hover { filter: brightness(1.1); }
        .apple-btn:active { transform: scale(0.96); }

        /* --- Result Charts --- */
        .chart-container { flex: 1; min-height: 280px; margin-top: 20px; position: relative; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .stat-card { background: #F2F2F7; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-val { font-size: 24px; font-weight: 800; color: var(--sys-accent); }
        .stat-lbl { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 4px; }

        /* --- iOS 18 Mobile Experience --- */
        #mobile-shell { position: fixed; inset: 0; background: #F2F2F7; display: none; flex-direction: column; z-index: 10000; }
        .ios-header { padding: 60px 25px 20px; background: #fff; border-bottom: 0.5px solid #d1d1d6; }
        .ios-content { flex: 1; padding: 20px; overflow-y: auto; }
        .ios-option-card { background: #fff; padding: 20px; border-radius: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: 0.2s; }
        .ios-option-card.selected { border-color: var(--sys-accent); background: rgba(0,122,255,0.05); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="desktop-engine"></div>

<div class="window-manager" id="wm">
    <div id="win-teacher" class="win-frame" style="width: 1000px; height: 650px; top: 10%; left: 10%;">
        <div class="win-header" onmousedown="Core.dragStart(event, 'win-teacher')">
            <div class="traffic-lights">
                <div class="t-dot close" onclick="Core.closeWin('win-teacher')"></div>
                <div class="t-dot min" onclick="Core.minWin('win-teacher')"></div>
                <div class="t-dot max" onclick="Core.maxWin('win-teacher')"></div>
            </div>
            <div class="win-title">Control Center â€” Sequoia Core</div>
        </div>
        <div class="win-container">
            <aside class="win-sidebar">
                <div class="side-btn active" onclick="Core.switchTab('config')"><div class="icon-box" style="background:#007AFF"></div> ä»»å‹™éƒ¨ç½²</div>
                <div class="side-btn" onclick="Core.switchTab('analytics')"><div class="icon-box" style="background:#FF2D55"></div> å¯¦æ™‚åˆ†æ</div>
                <div class="side-btn" onclick="Core.switchTab('connections')"><div class="icon-box" style="background:#34C759"></div> é€£ç·šç®¡ç†</div>
                <div style="margin-top:20px; padding:10px; font-size:10px; color:#999; border-top:1px solid rgba(0,0,0,0.05)">SYS_VERSION: 15.0.1</div>
            </aside>
            <main class="win-content" id="master-view">
                <div id="view-config">
                    <h1 style="font-size: 28px; letter-spacing: -0.5px; margin-bottom: 10px;">ç™¼å¸ƒäº’å‹•ä»»å‹™</h1>
                    <p style="color: #666; font-size: 14px; margin-bottom: 30px;">è¨­å®šé¡Œç›®èˆ‡é¸é …ï¼ŒåŒæ­¥è‡³æ‰€æœ‰æ¥å…¥çµ‚ç«¯ã€‚</p>
                    
                    <label style="font-size: 12px; font-weight: 700; color: #888;">æŠ•ç¥¨é¡Œç›® (TOPIC)</label>
                    <input type="text" id="in-topic" class="apple-input" placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥æŠ€è¡“æ¶æ§‹çš„ç†è§£é›£åº¦ï¼Ÿ" style="margin-top:8px;">
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:25px;">
                        <label style="font-size: 12px; font-weight: 700; color: #888;">å€™é¸é … (OPTIONS)</label>
                        <button class="apple-btn" style="padding:4px 12px; font-size:12px;" onclick="Core.addOption()">+ æ–°å¢</button>
                    </div>
                    <div id="opt-list" style="margin-top:12px; max-height: 220px; overflow-y:auto;"></div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:30px; padding-top:20px; border-top:1px solid #f2f2f7;">
                        <div>
                            <label style="font-size: 12px; color: #888;">è¨ˆæ™‚ (ç§’)</label>
                            <input type="number" id="in-timer" class="apple-input" value="60" style="margin-top:8px;">
                        </div>
                        <div style="display:flex; align-items:flex-end;">
                            <button id="btn-deploy" class="apple-btn" style="width:100%; height:46px; font-size:16px;" onclick="Core.launchVoting()">ğŸš€ éƒ¨ç½²ä¸¦å•Ÿå‹•</button>
                            <button id="btn-stop" class="apple-btn hidden" style="width:100%; height:46px; background:#FF3B30;" onclick="Core.stopVoting()">ğŸ›‘ çµ‚æ­¢ä»»å‹™</button>
                        </div>
                    </div>
                </div>

                <div id="view-analytics" class="hidden">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h1 id="disp-topic" style="font-size: 24px; margin:0;">ç­‰å¾…æ•¸æ“šå‚³å…¥...</h1>
                        <div id="disp-clock" style="font-family:monospace; font-size:32px; font-weight:800; color:var(--sys-accent);">00:00</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-val" id="st-room">----</div><div class="stat-lbl">æˆ¿è™Ÿä»£ç¢¼</div></div>
                        <div class="stat-card"><div class="stat-val" id="st-votes">0</div><div class="stat-lbl">å·²æŠ•ç¥¨æ•¸</div></div>
                        <div class="stat-card"><div class="stat-val" id="st-online">0</div><div class="stat-lbl">åœ¨ç·šè¨­å‚™</div></div>
                    </div>
                </div>
            </main>
        </div>
        <div class="resizer-rb" onmousedown="Core.resizeStart(event, 'win-teacher')"></div>
    </div>

    <div id="win-join" class="win-frame" style="width: 400px; height: 500px; top: 15%; left: 60%;">
        <div class="win-header" onmousedown="Core.dragStart(event, 'win-join')">
            <div class="traffic-lights"><div class="t-dot close" onclick="Core.closeWin('win-join')"></div></div>
            <div class="win-title">Join Terminal</div>
        </div>
        <div class="win-content" style="align-items:center; justify-content:center; text-align:center;">
            <canvas id="qr-canvas" style="width:200px; height:200px; margin-bottom:20px;"></canvas>
            <h3 style="margin:0;">æƒæå¿«é€Ÿæ¥å…¥</h3>
            <p style="font-size:13px; color:#888;">æˆ–æ‰‹å‹•è¼¸å…¥ ID:</p>
            <div id="manual-id" style="font-size:32px; font-weight:800; color:var(--sys-accent); letter-spacing:4px;">----</div>
        </div>
    </div>
</div>

<div class="dock-bar">
    <div class="dock-app" onclick="Core.openWin('win-teacher')">
        <div class="dock-app-icon" style="background: linear-gradient(180deg, #5AC8FA, #007AFF); color:#fff;">ğŸ“Š</div>
        <div class="app-dot running" id="dot-teacher"></div>
    </div>
    <div class="dock-app" onclick="Core.openWin('win-join')">
        <div class="dock-app-icon" style="background: linear-gradient(180deg, #FF9500, #FF5E3A); color:#fff;">ğŸ“±</div>
        <div class="app-dot" id="dot-join"></div>
    </div>
    <div style="width:1px; height:30px; background:rgba(255,255,255,0.2); margin:0 5px;"></div>
    <div class="dock-app">
        <div class="dock-app-icon" style="background: #E5E5EA;">âš™ï¸</div>
    </div>
</div>

<div id="mobile-shell">
    <header class="ios-header">
        <h1 id="ios-topic" style="margin:0; font-size:32px; letter-spacing:-1px;">Lumina ä»»å‹™</h1>
        <div id="ios-status" style="font-size:13px; color:var(--sys-accent); margin-top:5px; font-weight:600;">æ­£åœ¨æ¥å…¥æŒ‡æ®ä¸­å¿ƒ...</div>
    </header>
    <div class="ios-content">
        <div style="background:#fff; border-radius:18px; padding:25px; text-align:center; margin-bottom:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
            <div id="ios-timer" style="font-size:64px; font-weight:800; letter-spacing:-2px;">00:00</div>
            <div style="font-size:12px; color:#888; font-weight:700; text-transform:uppercase;">Time Remaining</div>
        </div>
        <div id="ios-opts"></div>
        <div id="ios-res" class="hidden">
            <h2 style="margin:30px 0 15px;">å¯¦æ™‚çµ±è¨ˆçµæœ</h2>
            <div id="ios-res-list"></div>
        </div>
    </div>
</div>

<script>
/**
 * LuminaOS Sequoia Engine v15.0 - Professional System Architecture
 * Developed by World-Class Architect
 */

const Core = (() => {
    let state = {
        roomID: '',
        topic: 'æ‚¨å°ç›®å‰æ¶æ§‹çš„å¯¦æ–½ä¿¡å¿ƒï¼Ÿ',
        options: ['æ¥µå…·ä¿¡å¿ƒ', 'åŸºæœ¬ç†è§£', 'éœ€è¦å„ªåŒ–', 'å®Œå…¨ä¸æ‡‚'],
        votes: {},
        voterMap: {},
        isLive: false,
        timeLeft: '00:00',
        showResult: false,
        online: 0,
        activeTab: 'config'
    };

    let peer, myChart, timerInt;
    let zStack = 1000;

    // --- Window Server Logic ---
    const openWin = (id) => {
        const win = document.getElementById(id);
        win.classList.remove('minimized');
        win.classList.add('visible');
        focusWin(id);
        document.getElementById('dot-' + id.split('-')[1]).classList.add('running');
    };

    const closeWin = (id) => {
        const win = document.getElementById(id);
        win.classList.remove('visible');
        document.getElementById('dot-' + id.split('-')[1]).classList.remove('running');
    };

    const minWin = (id) => {
        document.getElementById(id).classList.add('minimized');
    };

    const maxWin = (id) => {
        document.getElementById(id).classList.toggle('maximized');
        if(myChart) setTimeout(() => myChart.resize(), 400);
    };

    const focusWin = (id) => {
        zStack++;
        document.getElementById(id).style.zIndex = zStack;
    };

    const dragStart = (e, id) => {
        focusWin(id);
        const win = document.getElementById(id);
        if(win.classList.contains('maximized')) return;
        let startX = e.clientX - win.offsetLeft;
        let startY = e.clientY - win.offsetTop;
        
        const move = (ev) => {
            win.style.left = (ev.clientX - startX) + 'px';
            win.style.top = (ev.clientY - startY) + 'px';
        };
        const end = () => {
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', end);
        };
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
    };

    const resizeStart = (e, id) => {
        const win = document.getElementById(id);
        let startW = win.offsetWidth;
        let startH = win.offsetHeight;
        let startX = e.clientX;
        let startY = e.clientY;

        const move = (ev) => {
            win.style.width = (startW + (ev.clientX - startX)) + 'px';
            win.style.height = (startH + (ev.clientY - startY)) + 'px';
            if(myChart) myChart.resize();
        };
        const end = () => {
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', end);
        };
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
    };

    // --- App Logic ---
    const initMaster = () => {
        state.roomID = Math.floor(1000 + Math.random() * 8999).toString();
        peer = new Peer('LUMINA-' + state.roomID);

        peer.on('open', () => {
            document.getElementById('st-room').innerText = state.roomID;
            document.getElementById('manual-id').innerText = state.roomID;
            const joinUrl = window.location.origin + window.location.pathname + '?r=' + state.roomID;
            QRCode.toCanvas(document.getElementById('qr-canvas'), joinUrl);
            renderOptions();
            initChart();
            broadcastLoop();
            openWin('win-teacher');
        });

        peer.on('connection', conn => {
            conn.on('data', data => {
                if(data.type === 'vote' && state.isLive) {
                    if(state.voterMap[conn.peer]) state.votes[state.voterMap[conn.peer]]--;
                    state.voterMap[conn.peer] = data.val;
                    state.votes[data.val] = (state.votes[data.val] || 0) + 1;
                    updateUI();
                }
            });
        });
    };

    const addOption = () => {
        state.options.push("New Option " + (state.options.length + 1));
        renderOptions();
    };

    const renderOptions = () => {
        const container = document.getElementById('opt-list');
        container.innerHTML = state.options.map((opt, i) => `
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" class="apple-input" value="${opt}" oninput="Core.updateOpt(${i}, this.value)" style="margin:0">
                <button class="apple-btn" style="background:#f2f2f7; color:#FF3B30;" onclick="Core.removeOpt(${i})">âœ•</button>
            </div>
        `).join('');
    };

    const updateOpt = (i, val) => state.options[i] = val;
    const removeOpt = (i) => { state.options.splice(i, 1); renderOptions(); };

    const switchTab = (tab) => {
        state.activeTab = tab;
        document.getElementById('view-config').classList.toggle('hidden', tab !== 'config');
        document.getElementById('view-analytics').classList.toggle('hidden', tab !== 'analytics');
        document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(tab === 'analytics') setTimeout(() => myChart.resize(), 50);
    };

    const launchVoting = () => {
        state.topic = document.getElementById('in-topic').value || state.topic;
        state.isLive = true;
        state.showResult = false;
        state.voterMap = {};
        state.options.forEach(o => state.votes[o] = 0);
        
        document.getElementById('btn-deploy').classList.add('hidden');
        document.getElementById('btn-stop').classList.remove('hidden');
        document.getElementById('disp-topic').innerText = state.topic;
        switchTab('analytics');

        let duration = parseInt(document.getElementById('in-timer').value);
        timerInt = setInterval(() => {
            duration--;
            let m = Math.floor(duration/60).toString().padStart(2,'0');
            let s = (duration%60).toString().padStart(2,'0');
            state.timeLeft = `${m}:${s}`;
            document.getElementById('disp-clock').innerText = state.timeLeft;
            if(duration <= 0) stopVoting();
        }, 1000);
    };

    const stopVoting = () => {
        state.isLive = false;
        state.showResult = true;
        clearInterval(timerInt);
        document.getElementById('btn-deploy').classList.remove('hidden');
        document.getElementById('btn-stop').classList.add('hidden');
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    };

    const initChart = () => {
        const ctx = document.getElementById('mainChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: state.options,
                datasets: [{ data: [], backgroundColor: '#007AFF', borderRadius: 8, barThickness: 40 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { grid:{display:false}, beginAtZero: true }, y: { grid:{display:false}, ticks:{ font:{size:14, weight:'600'} } } }
            }
        });
    };

    const updateUI = () => {
        if(myChart) {
            myChart.data.labels = state.options;
            myChart.data.datasets[0].data = state.options.map(o => state.votes[o] || 0);
            myChart.update();
        }
        document.getElementById('st-votes').innerText = Object.keys(state.voterMap).length;
        document.getElementById('st-online').innerText = Object.keys(peer.connections).length;
    };

    const broadcastLoop = () => {
        setInterval(() => {
            const data = { ...state, type: 'sync' };
            Object.values(peer.connections).forEach(conns => conns.forEach(c => { if(c.open) c.send(data); }));
            updateUI();
        }, 800);
    };

    // --- Student Logic ---
    let myVote = '';
    const initStudent = (rid) => {
        document.querySelector('.window-manager').style.display = 'none';
        document.querySelector('.dock-bar').style.display = 'none';
        document.getElementById('mobile-shell').style.display = 'flex';
        
        const sPeer = new Peer();
        sPeer.on('open', () => {
            const conn = sPeer.connect('LUMINA-' + rid);
            conn.on('open', () => {
                document.getElementById('ios-status').innerText = "å·²é€£ç·šè‡³æˆ¿è™Ÿï¼š" + rid;
            });
            conn.on('data', data => {
                if(data.type === 'sync') syncIOS(data, conn);
            });
        });
    };

    const syncIOS = (data, conn) => {
        document.getElementById('ios-topic').innerText = data.topic;
        document.getElementById('ios-timer').innerText = data.timeLeft;
        const optCont = document.getElementById('ios-opts');
        const resCont = document.getElementById('ios-res');

        if(data.showResult) {
            optCont.classList.add('hidden');
            resCont.classList.remove('hidden');
            const total = Object.keys(data.voterMap).length || 1;
            document.getElementById('ios-res-list').innerHTML = data.options.map(o => {
                const p = Math.round((data.votes[o]||0)/total*100);
                return `
                    <div style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:700;">
                            <span>${o}</span><span>${p}%</span>
                        </div>
                        <div style="height:12px; background:#E5E5EA; border-radius:10px; overflow:hidden;">
                            <div style="height:100%; width:${p}%; background:var(--sys-accent); transition:1s cubic-bezier(0.2,1,0.2,1);"></div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            optCont.classList.remove('hidden');
            resCont.classList.add('hidden');
            optCont.innerHTML = data.options.map(o => `
                <div class="ios-option-card ${myVote===o?'selected':''}" onclick="Core.castVote('${o}', ${data.isLive})">
                    <span style="font-size:18px; font-weight:600;">${o}</span>
                    ${myVote===o?'<span style="color:var(--sys-accent); font-weight:800;">âœ“</span>':''}
                </div>
            `).join('');
        }
    };

    const castVote = (val, live) => {
        if(!live) return;
        myVote = val;
        // ç™¼é€çµ¦è€å¸«ç«¯
        const teacherConn = Object.values(peer.connections)[0][0];
        teacherConn.send({ type: 'vote', val: val });
    };

    return { 
        openWin, closeWin, minWin, maxWin, dragStart, resizeStart,
        initMaster, addOption, updateOpt, removeOpt, switchTab, 
        launchVoting, stopVoting, initStudent, castVote
    };
})();

window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const r = urlParams.get('r');
    if(r) {
        Core.initStudent(r);
    } else {
        Core.initMaster();
    }
};
</script>
</body>
</html>
