<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Pro | å°ˆæ¥­è€ƒè©•ç³»çµ±</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; --bg: #F5F5F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #1D1D1F; user-select: none; }
        .app { max-width: 900px; margin: auto; padding: 20px; }
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #FFF; }
        .hidden { display: none; }
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-p { background: var(--p); color: #FFF; }
        .btn-s { background: var(--s); color: #FFF; }
        .btn-d { background: var(--d); color: #FFF; }
        
        /* è€å¸«å„€è¡¨æ¿ */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #FFF; padding: 15px; border-radius: 15px; text-align: center; }
        .stat-val { font-size: 28px; font-weight: bold; color: var(--p); }

        /* è€ƒé¡Œå¡ */
        .q-card { background: #FFF; padding: 20px; border-radius: 15px; margin-bottom: 15px; position: relative; }
        .lock-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; backdrop-filter: blur(5px); }
        
        table { width: 100%; border-collapse: collapse; background: #FFF; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid #EEE; text-align: center; }
        
        textarea { width: 100%; height: 100px; border-radius: 10px; border: 1px solid #DDD; padding: 10px; font-size: 14px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="app">
    <div id="v-start" class="glass" style="text-align:center; margin-top:100px;">
        <h1>Lumina Pro</h1>
        <button class="btn btn-p" onclick="initTeacher()">æ•™å¸«ä¸»æ§</button>
        <button class="btn" style="background:#8E8E93; color:white;" onclick="initStudent()">å­¸ç”Ÿä½œç­”</button>
    </div>

    <div id="v-teacher" class="hidden">
        <div class="glass">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>ğŸ‘¨â€ğŸ« æ•™å¸«å„€è¡¨æ¿</h2>
                <div id="roomTag" style="background:#000; color:#FFF; padding:5px 15px; border-radius:8px;">ID: ----</div>
            </div>
            
            <div class="stat-grid">
                <div class="stat-card"><div>é€£ç·š</div><div class="stat-val" id="s-conn">0</div></div>
                <div class="stat-card"><div>å·²ç¹³</div><div class="stat-val" id="s-sub">0</div></div>
                <div class="stat-card"><div>å¹³å‡</div><div class="stat-val" id="s-avg">0</div></div>
                <div class="stat-card"><div>åŠæ ¼%</div><div class="stat-val" id="s-pass">0</div></div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-p" onclick="toggleExamConfig()">âš™ï¸ è¨­å®šé¡Œç›®</button>
                <button id="lockBtn" class="btn btn-d" onclick="toggleLock()">ğŸ”’ é–å®šå­¸ç”Ÿè¢å¹•</button>
                <button class="btn btn-s" onclick="broadcastExam()">ğŸš€ ç™¼é€è€ƒå·</button>
            </div>
        </div>

        <div id="examConfig" class="glass hidden">
            <h3>é¡Œç›®è¨­å®š</h3>
            <div style="margin-bottom:10px;">
                <button class="btn" onclick="document.getElementById('inputMode').classList.remove('hidden'); document.getElementById('excelMode').classList.add('hidden');">ç·šä¸Šè¼¸å…¥</button>
                <button class="btn" onclick="document.getElementById('excelMode').classList.remove('hidden'); document.getElementById('inputMode').classList.add('hidden');">Excel åŒ¯å…¥</button>
            </div>
            <div id="inputMode">
                <textarea id="manualInput" placeholder="é¡Œç›®,A,B,C,D,E,æ­£ç¢ºç­”æ¡ˆ(å¦‚AB),é…åˆ† (æ¯è¡Œä¸€é¡Œ)"></textarea>
                <button class="btn btn-p" style="margin-top:5px;" onclick="parseManual()">ç¢ºèªè½‰æ›</button>
            </div>
            <div id="excelMode" class="hidden">
                <button class="btn btn-p" onclick="downloadSample()">ä¸‹è¼‰ç¯„ä¾‹</button>
                <input type="file" accept=".xlsx" onchange="importExcel(this)">
            </div>
            <div id="qCountText" style="margin-top:10px; color:var(--p); font-weight:bold;"></div>
        </div>

        <div class="glass">
            <h3>ğŸ“Š å¯¦æ™‚é€²åº¦</h3>
            <table>
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>å¾—åˆ†</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
            <button class="btn btn-s" style="width:100%; margin-top:15px;" onclick="exportFinal()">ğŸ’¾ åŒ¯å‡º Excel æˆç¸¾å–®</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div id="examLock" class="lock-mask hidden">ğŸ”’ è€å¸«å·²æš«åœä½œç­”ï¼Œè«‹è½è€å¸«è¬›è§£</div>
        <div class="glass" style="text-align:center;">
            <h2 id="stuTitle">ç­‰å¾…ç™¼å·...</h2>
            <div id="stuMeta"></div>
        </div>
        <div id="quizArea"></div>
        <button id="subBtn" class="btn btn-p hidden" style="width:100%;" onclick="studentSubmit()">ç¢ºèªç¹³äº¤</button>
    </div>

    <div id="v-result" class="hidden glass" style="text-align:center; margin-top:100px;">
        <h1 style="color:var(--s);">æ¸¬é©—çµæŸ</h1>
        <div style="font-size:80px; font-weight:bold;" id="resScore">0</div>
        <p>åˆ†</p>
        <button class="btn btn-p" onclick="location.reload()">è¿”å›</button>
    </div>
</div>

<script>
    let peer, conn, myRoomId, isLocked = false;
    let connections = {};
    let studentData = {};
    let masterQuiz = [];
    let myNo = "";

    // --- æ•™å¸«ç«¯ ---
    function initTeacher() {
        showView('v-teacher');
        myRoomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        peer = new Peer(myRoomId);
        peer.on('open', id => { 
            document.getElementById('roomTag').innerText = "ID: " + id;
            // å¯ä»¥åœ¨æ­¤è™•åŠ ä¸ŠäºŒç¶­ç¢¼ç”Ÿæˆ
        });
        peer.on('connection', c => {
            const no = c.metadata.no;
            connections[no] = c;
            if(!studentData[no]) studentData[no] = { no: no, progress: "0%", score: 0, ans: {}, qScore: {}, status: "é€£ç·šä¸­", cheats: 0 };
            updateMonitor();
            c.on('data', data => handleStudentData(no, data));
        });
    }

    function handleStudentData(no, data) {
        if (data.type === 'sync') {
            studentData[no].progress = data.progress;
            studentData[no].cheats = data.cheats;
            updateMonitor();
        }
        if (data.type === 'submit') {
            let total = 0, perQ = {};
            masterQuiz.forEach((q, i) => {
                if (data.userAns[i] === q.ans) { total += q.point; perQ[i] = q.point; }
                else perQ[i] = 0;
            });
            studentData[no].score = Math.round(total);
            studentData[no].ans = data.userAns;
            studentData[no].qScore = perQ;
            studentData[no].status = "âœ… å·²ç¹³";
            connections[no].send({ type: 'report', score: Math.round(total) });
            updateMonitor();
        }
    }

    function updateMonitor() {
        const list = Object.values(studentData);
        document.getElementById('s-conn').innerText = list.length;
        const subList = list.filter(s => s.status === "âœ… å·²ç¹³");
        document.getElementById('s-sub').innerText = subList.length;
        
        let sum = 0, pass = 0;
        document.getElementById('monitorBody').innerHTML = list.map(s => {
            sum += s.score;
            if(s.score >= 60) pass++;
            const cTxt = s.cheats > 0 ? `<div style="color:red; font-size:10px;">é›¢é  ${s.cheats}</div>` : "";
            return `<tr><td>${s.no}</td><td>${s.progress}${cTxt}</td><td>${s.score}</td><td>${s.status}</td></tr>`;
        }).join('');
        
        document.getElementById('s-avg').innerText = subList.length ? (sum / subList.length).toFixed(1) : 0;
        document.getElementById('s-pass').innerText = subList.length ? Math.round((pass/subList.length)*100) : 0;
    }

    function broadcastExam() {
        if(!masterQuiz.length) return alert("è«‹å…ˆè¨­å®šé¡Œç›®");
        const safeQuiz = masterQuiz.map(({ans, ...rest}) => rest);
        Object.values(connections).forEach(c => c.send({ type: 'exam', quiz: safeQuiz }));
    }

    function toggleLock() {
        isLocked = !isLocked;
        document.getElementById('lockBtn').innerText = isLocked ? "ğŸ”“ è§£é™¤é–å®š" : "ğŸ”’ é–å®šå­¸ç”Ÿè¢å¹•";
        document.getElementById('lockBtn').className = isLocked ? "btn btn-s" : "btn btn-d";
        Object.values(connections).forEach(c => c.send({ type: 'lock', state: isLocked }));
    }

    // --- é¡Œç›®è¨­å®šé‚è¼¯ ---
    function parseManual() {
        const text = document.getElementById('manualInput').value.trim();
        masterQuiz = text.split('\n').map(line => {
            const p = line.split(',');
            return { q: p[0], opts: {A:p[1],B:p[2],C:p[3],D:p[4],E:p[5]}, ans: String(p[6]).toUpperCase().split('').sort().join(''), point: Number(p[7]) };
        });
        document.getElementById('qCountText').innerText = `å·²è®€å– ${masterQuiz.length} é¡Œ`;
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            masterQuiz = data.map(r => ({
                q: r.é¡Œç›®, opts: {A:r.é¸é …A,B:r.é¸é …B,C:r.é¸é …C,D:r.é¸é …D,E:r.é¸é …E},
                ans: String(r.æ­£ç¢ºç­”æ¡ˆ || "").toUpperCase().split('').sort().join(''), point: Number(r.é…åˆ†)
            }));
            document.getElementById('qCountText').innerText = `Excel åŒ¯å…¥æˆåŠŸ: ${masterQuiz.length} é¡Œ`;
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    // --- å­¸ç”Ÿç«¯ ---
    let cheats = 0, currentQuiz = [];
    function initStudent() {
        const id = (new URLSearchParams(window.location.search)).get('room') || prompt("æˆ¿é–“ ID:");
        myNo = prompt("åº§è™Ÿ:");
        if(!id || !myNo) return;
        showView('v-student');
        
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id.toUpperCase(), { metadata: { no: myNo } });
            conn.on('data', data => {
                if(data.type === 'exam') renderExam(data.quiz);
                if(data.type === 'lock') document.getElementById('examLock').classList.toggle('hidden', !data.state);
                if(data.type === 'report') {
                    localStorage.removeItem('lumina_ans_'+myNo);
                    showView('v-result');
                    document.getElementById('resScore').innerText = data.score;
                }
            });
        });

        document.addEventListener('visibilitychange', () => {
            if(document.visibilityState === 'hidden') {
                cheats++;
                syncProgress();
            }
        });
    }

    function renderExam(quiz) {
        currentQuiz = quiz;
        document.getElementById('stuTitle').innerText = "æ¸¬é©—ä¸­";
        document.getElementById('subBtn').classList.remove('hidden');
        
        // è®€å–èˆŠè³‡æ–™
        const saved = JSON.parse(localStorage.getItem('lumina_ans_'+myNo) || "{}");
        
        let html = '';
        quiz.forEach((q, i) => {
            html += `<div class="q-card"><b>${i+1}. ${q.q} (${q.point}åˆ†)</b><br>`;
            Object.entries(q.opts).forEach(([k, v]) => {
                if(!v) return;
                const checked = (saved[i] || "").includes(k) ? "checked" : "";
                html += `<label style="display:block;margin:8px 0;"><input type="checkbox" name="q${i}" value="${k}" ${checked} onchange="saveAndSync()"> ${k}. ${v}</label>`;
            });
            html += `</div>`;
        });
        document.getElementById('quizArea').innerHTML = html;
        syncProgress();
    }

    function saveAndSync() {
        let ans = {};
        currentQuiz.forEach((_, i) => {
            ans[i] = Array.from(document.querySelectorAll(`input[name="q${i}"]:checked`)).map(el => el.value).sort().join('');
        });
        localStorage.setItem('lumina_ans_'+myNo, JSON.stringify(ans));
        syncProgress();
    }

    function syncProgress() {
        const saved = JSON.parse(localStorage.getItem('lumina_ans_'+myNo) || "{}");
        const done = Object.values(saved).filter(v => v !== "").length;
        if(conn) conn.send({ type: 'sync', progress: Math.round((done/currentQuiz.length)*100)+"%", cheats: cheats });
    }

    function studentSubmit() {
        if(!confirm("ç¢ºå®šäº¤å·ï¼Ÿ")) return;
        const ans = JSON.parse(localStorage.getItem('lumina_ans_'+myNo));
        conn.send({ type: 'submit', userAns: ans });
    }

    // é€šç”¨
    function showView(id) {
        ['v-start','v-teacher','v-student','v-result'].forEach(x => document.getElementById(x).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function toggleExamConfig() { document.getElementById('examConfig').classList.toggle('hidden'); }
    function downloadSample() {
        const data = [["é¡Œç›®","é¸é …A","é¸é …B","é¸é …C","é¸é …D","é¸é …E","æ­£ç¢ºç­”æ¡ˆ","é…åˆ†"],["ç¯„ä¾‹:1+1=?","1","2","3","","","B",10]];
        XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.aoa_to_sheet(data), "è€ƒé¡Œ")), "Luminaç¯„ä¾‹.xlsx");
    }
    function exportFinal() {
        const list = Object.values(studentData).map(s => {
            let row = { "åº§è™Ÿ": s.no, "å¾—åˆ†": s.score, "é›¢é ": s.cheats };
            masterQuiz.forEach((_, i) => row[`Q${i+1}ç­”`] = s.ans[i] || "");
            return row;
        });
        XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(list), "æˆç¸¾")), "æˆç¸¾å–®.xlsx");
    }
</script>
</body>
</html>
