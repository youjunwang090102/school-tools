<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ¿åå¿ƒè²ç®± - ç­ç´šå¹³å°</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --t: #ef233c; --bg: #f0f2f5; --card: #ffffff; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        
        /* ç™»å…¥ä»‹é¢ */
        #loginSection { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-card { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 380px; text-align: center; }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #eee; border-radius: 12px; font-size: 16px; box-sizing: border-box; background: #f9f9f9; }

        /* å°è¦½åˆ— - æ¯›ç»ç’ƒæ•ˆæœ */
        .nav { 
            display: none; background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 5px; justify-content: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; 
        }
        .nav-btn { border: none; background: none; font-weight: bold; padding: 15px 20px; color: #888; cursor: pointer; font-size: 0.95rem; transition: 0.3s; border-radius: 12px; margin: 0 5px; }
        .nav-btn.active { color: var(--p); background: rgba(67, 97, 238, 0.1); }

        .container { padding: 20px; max-width: 1000px; margin: auto; display: none; }
        
        /* éŸ¿æ‡‰å¼ä½ˆå±€ï¼šé›»è…¦è®Šé›™æ¬„ */
        .msg-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 15px; 
            margin-top: 15px;
        }

        @media (min-width: 768px) {
            .msg-grid { grid-template-columns: 1fr 1fr; }
        }

        .card { 
            background: var(--card); padding: 20px; border-radius: 18px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 20px rgba(0,0,0,0.08); }

        /* å­¸ç”Ÿé¸å–æ¸…å–® */
        .student-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 10px; background: #f0f2f5; padding: 15px; border-radius: 15px; margin: 15px 0;
            max-height: 250px; overflow-y: auto;
        }
        .stu-chip { font-size: 0.8rem; background: white; padding: 8px; border-radius: 10px; text-align: center; cursor: pointer; border: 1px solid #ddd; transition: 0.2s; }
        .stu-chip.selected { background: var(--p); color: white; border-color: var(--p); box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3); }

        textarea { width: 100%; height: 150px; border: 1px solid #eee; border-radius: 15px; padding: 15px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; resize: none; margin-bottom: 10px; }
        button.main-btn { width: 100%; padding: 16px; background: var(--p); color: white; border: none; border-radius: 15px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.3s; }
        
        .msg-info { font-size: 0.75rem; color: #aaa; margin-bottom: 8px; }
        .reply-area { margin-top: 15px; padding: 12px; background: #f0fffb; border-radius: 12px; color: #008f7a; font-size: 0.9rem; border-left: 4px solid var(--s); white-space: pre-wrap; }
        .admin-tag { background: #fff0f0; color: var(--t); font-size: 0.75rem; padding: 5px 10px; border-radius: 8px; margin-bottom: 10px; display: inline-block; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="login-card">
            <h1 style="color:var(--p); margin-bottom:10px;">ğŸ¤« åŒ¿åä¿¡ç®±</h1>
            <p style="color:#888; margin-bottom:20px;">æƒ³èªªçš„è©±ï¼Œåœ¨é€™è£¡å‚³é”</p>
            <input type="number" id="loginId" placeholder="åº§è™Ÿ (ä¾‹å¦‚ 05)">
            <input type="password" id="loginPw" placeholder="ç™»å…¥å¯†ç¢¼">
            <button class="main-btn" onclick="doLogin()">ç™»å…¥æœå‹™</button>
        </div>
    </div>

    <div id="navBar" class="nav">
        <button id="btn-send" class="nav-btn" onclick="showPage('send')">æ’°å¯«</button>
        <button id="btn-sentBox" class="nav-btn" onclick="showPage('sentBox')">å·²å¯„å‡º</button>
        <button id="btn-receive" class="nav-btn" onclick="showPage('receive')">æ”¶ä»¶åŒ£</button>
        <button id="btn-admin" class="nav-btn" style="display:none;" onclick="showPage('admin')">ç®¡ç†</button>
        <button class="nav-btn" onclick="location.reload()" style="color:#ccc">ç™»å‡º</button>
    </div>

    <div id="sendPage" class="container" style="max-width: 600px;">
        <h2>ğŸ“ å‚³é€å¿ƒè²</h2>
        <div id="stuGrid" class="student-grid"></div>
        <textarea id="msgBody" placeholder="å¯«ä¸‹æƒ³å°åŒå­¸èªªçš„è©±..."></textarea>
        <button class="main-btn" onclick="sendToStudents()">ç¢ºèªç™¼é€</button>
    </div>

    <div id="sentBoxPage" class="container">
        <h2>ğŸ“¤ æˆ‘å¯„å‡ºçš„ä¿¡ä»¶</h2>
        <div id="sentList" class="msg-grid"></div>
    </div>

    <div id="receivePage" class="container">
        <h2>ğŸ“¥ æ”¶åˆ°çš„ä¿¡ä»¶</h2>
        <div id="receiveList" class="msg-grid"></div>
    </div>

    <div id="adminPage" class="container">
        <h2>ğŸ” å…¨ç­ç´€éŒ„</h2>
        <div id="adminList" class="msg-grid"></div>
    </div>

    <script>
        // --- Firebase é…ç½® ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let me = null;
        let selectedIds = [];

        // --- æ ¸å¿ƒé‚è¼¯ ---
        async function doLogin() {
            const rawId = document.getElementById('loginId').value;
            if(!rawId) return alert("è«‹è¼¸å…¥åº§è™Ÿ");
            const id = rawId.padStart(2, '0');
            const pw = document.getElementById('loginPw').value;
            try {
                const doc = await db.collection("students").doc(id).get();
                if (doc.exists && doc.data().password === pw) {
                    me = { id, ...doc.data() };
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('navBar').style.display = 'flex';
                    if (me.role === 'teacher' || me.role === 'admin') document.getElementById('btn-admin').style.display = 'block';
                    showPage('send');
                    loadStudentList();
                    startListenMessages();
                } else { alert("åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
            } catch (e) { alert("ç³»çµ±éŒ¯èª¤: " + e.message); }
        }

        function showPage(p) {
            document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(p + 'Page').style.display = 'block';
            document.getElementById('btn-' + p).classList.add('active');
        }

        async function loadStudentList() {
            const snap = await db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).get();
            const grid = document.getElementById('stuGrid');
            grid.innerHTML = "";
            snap.forEach(doc => {
                if(doc.id === me.id) return;
                const chip = document.createElement('div');
                chip.className = 'stu-chip';
                chip.innerText = `${doc.id} ${doc.data().name}`;
                chip.onclick = () => {
                    chip.classList.toggle('selected');
                    const sid = doc.id;
                    if(selectedIds.includes(sid)) selectedIds = selectedIds.filter(i => i !== sid);
                    else selectedIds.push(sid);
                };
                grid.appendChild(chip);
            });
        }

        async function sendToStudents() {
            const content = document.getElementById('msgBody').value;
            if (selectedIds.length === 0 || !content) return alert("è«‹é¸æ“‡å°è±¡ä¸¦å¡«å¯«å…§å®¹");
            if(confirm(`å°‡åŒ¿åå‚³é€çµ¦ ${selectedIds.length} ä½åŒå­¸ï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                const batch = db.batch();
                selectedIds.forEach(tId => {
                    const ref = db.collection("secret_messages").doc();
                    batch.set(ref, {
                        sender_id: me.id, sender_name: me.name, receiver_id: tId,
                        content: content, reply: "", time: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                await batch.commit();
                alert("ç™¼é€æˆåŠŸï¼");
                document.getElementById('msgBody').value = "";
                selectedIds = [];
                document.querySelectorAll('.stu-chip').forEach(c => c.classList.remove('selected'));
                showPage('sentBox');
            }
        }

        function startListenMessages() {
            // æ”¶ä»¶åŒ£
            db.collection("secret_messages").where("receiver_id", "==", me.id).onSnapshot(snap => {
                renderList(snap, 'receiveList', 'receive');
            });
            // å¯„ä»¶å‚™ä»½
            db.collection("secret_messages").where("sender_id", "==", me.id).onSnapshot(snap => {
                renderList(snap, 'sentList', 'sent');
            });
            // ç®¡ç†ç«¯
            if (me.role === 'teacher' || me.role === 'admin') {
                db.collection("secret_messages").onSnapshot(snap => {
                    renderList(snap, 'adminList', 'admin');
                });
            }
        }

        function renderList(snap, elementId, type) {
            const box = document.getElementById(elementId);
            if (!box) return;
            box.innerHTML = snap.empty ? "<p style='color:#ccc;text-align:center;padding:20px;grid-column:1/-1;'>å°šç„¡ä¿¡ä»¶è³‡æ–™</p>" : "";
            
            let docs = [];
            snap.forEach(doc => {
                const data = doc.data();
                const timestamp = data.time ? data.time.toMillis() : Date.now();
                docs.push({ docId: doc.id, ...data, sortTime: timestamp });
            });
            docs.sort((a, b) => b.sortTime - a.sortTime);

            docs.forEach(d => {
                const timeDisplay = d.time ? d.time.toDate().toLocaleString() : "å‚³é€ä¸­...";
                const card = document.createElement('div');
                card.className = 'card';
                
                let header = "";
                if(type === 'admin') header = `<div class="admin-tag">FROM: ${d.sender_id} â” TO: ${d.receiver_id}</div>`;
                if(type === 'sent') header = `<div class="msg-info" style="color:var(--p);font-weight:bold;">To: ${d.receiver_id} åŒå­¸</div>`;

                card.innerHTML = `
                    ${header}
                    <div class="msg-info">ğŸ“… ${timeDisplay}</div>
                    <div style="font-weight:bold; color:#333; white-space: pre-wrap;">${d.content}</div>
                    ${d.reply ? `<div class="reply-area"><b>å›è¦†ï¼š</b><br>${d.reply}</div>` : ""}
                    ${type === 'receive' && !d.reply ? `<button onclick="replyMsg('${d.docId}')" style="margin-top:12px; cursor:pointer;">å›è¦†å°æ–¹</button>` : ""}
                `;
                box.appendChild(card);
            });
        }

        async function replyMsg(docId) {
            const r = prompt("è«‹è¼¸å…¥å›è¦†å…§å®¹ï¼š");
            if(r) { 
                await db.collection("secret_messages").doc(docId).update({ reply: r });
            }
        }
    </script>
</body>
</html>
