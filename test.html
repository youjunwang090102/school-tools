<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç„¡å¾Œç«¯å¿«é–ƒè€ƒè©¦ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        .hidden { display: none; }
        .q-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        #timer { font-size: 24px; color: red; font-weight: bold; text-align: center; }
        #qrCanvas { display: block; margin: 20px auto; }
        button { width: 100%; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card" id="mainApp">
    <div id="teacherView">
        <h2>ğŸ“ è€å¸«å‡ºé¡Œç³»çµ±</h2>
        <textarea id="quizInput" style="width:100%; height:100px;" placeholder="é¡Œç›®æ ¼å¼ï¼šé¡Œç›®,A,B,C,D,æ­£ç¢ºç­”æ¡ˆ(A-D)&#10;1+1ç­‰æ–¼?,1,2,3,4,B"></textarea>
        <input type="number" id="limitTime" placeholder="é™æ™‚ (åˆ†é˜)" value="10">
        <button onclick="generateExamQR()">1. ç”Ÿæˆè€ƒè©¦äºŒç¶­ç¢¼</button>
        <canvas id="examQR"></canvas>
        <hr>
        <button style="background: #34c759;" onclick="startScanning()">2. æƒæå­¸ç”Ÿç­”æ¡ˆæ¢ (å›æ”¶æˆç¸¾)</button>
        <video id="video" style="width: 100%; display:none;"></video>
        <button onclick="exportExcel()">3. åŒ¯å‡º Excel æˆç¸¾å–®</button>
    </div>

    <div id="studentView" class="hidden">
        <h2 id="stuTitle">ä½œç­”ä¸­...</h2>
        <div id="timer">å‰©é¤˜æ™‚é–“ --:--</div>
        <div id="quizContent"></div>
        <button onclick="submitExam()">ç«‹åˆ»ç¹³äº¤</button>
    </div>

    <div id="resultView" class="hidden">
        <h2>è€ƒè©¦çµæŸ</h2>
        <p>è«‹å°‡ä¸‹æ–¹ QR Code å‡ºç¤ºçµ¦è€å¸«æƒæ</p>
        <canvas id="qrCanvas"></canvas>
    </div>
</div>

<script>
    let examData = [];
    let studentResults = [];
    let timeLeft = 0;
    let timerInterval;

    // --- è€å¸«é‚è¼¯ ---
    function generateExamQR() {
        const input = document.getElementById('quizInput').value;
        const time = document.getElementById('limitTime').value;
        const data = btoa(unescape(encodeURIComponent(JSON.stringify({ quiz: input, time: time }))));
        const url = window.location.href.split('?')[0] + '?exam=' + data;
        
        QRCode.toCanvas(document.getElementById('examQR'), url, { width: 250 });
        alert("äºŒç¶­ç¢¼å·²ç”Ÿæˆï¼Œè«‹æŠ•æ”¾åˆ°è¢å¹•è®“å­¸ç”Ÿæƒæï¼");
    }

    function startScanning() {
        alert("æ­¤éƒ¨åˆ†éœ€é…åˆæ‰‹æ©Ÿç›¸æ©Ÿæƒæï¼Œæˆ–ç”±å­¸ç”Ÿè¤‡è£½çµæœä»£ç¢¼è²¼çµ¦è€å¸«ã€‚");
        // å¯¦å‹™ä¸Šè€å¸«ç«¯å¯ç”¨æ‰‹æ©Ÿç›´æ¥é»æ“Šæ­¤ HTML é€²è¡Œæƒæ
        const code = prompt("è«‹è¼¸å…¥å­¸ç”Ÿç­”æ¡ˆæ¢ä»£ç¢¼ (æˆ–æƒæå¾Œçš„å…§å®¹)ï¼š");
        if(code) {
            const result = JSON.parse(decodeURIComponent(atob(code)));
            studentResults.push(result);
            alert(`å·²è¨˜éŒ„åº§è™Ÿ ${result.no} çš„æˆç¸¾ï¼š${result.score} åˆ†`);
        }
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(studentResults);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾å–®");
        XLSX.writeFile(wb, "ç­ç´šæˆç¸¾å–®.xlsx");
    }

    // --- å­¸ç”Ÿé‚è¼¯ ---
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('exam')) {
            document.getElementById('teacherView').classList.add('hidden');
            document.getElementById('studentView').classList.remove('hidden');
            loadExam(urlParams.get('exam'));
        }
    };

    function loadExam(encodedData) {
        const data = JSON.parse(decodeURIComponent(atob(encodedData)));
        const questions = data.quiz.split('\n');
        timeLeft = data.time * 60;
        
        let html = '';
        questions.forEach((q, index) => {
            const parts = q.split(',');
            if(parts.length < 6) return;
            examData.push({ q: parts[0], options: parts.slice(1,5), ans: parts[5].trim() });
            html += `<div class="q-item">
                <p>${index+1}. ${parts[0]}</p>
                <label><input type="radio" name="q${index}" value="A"> ${parts[1]}</label><br>
                <label><input type="radio" name="q${index}" value="B"> ${parts[2]}</label><br>
                <label><input type="radio" name="q${index}" value="C"> ${parts[3]}</label><br>
                <label><input type="radio" name="q${index}" value="D"> ${parts[4]}</label>
            </div>`;
        });
        document.getElementById('quizContent').innerHTML = html;
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            let min = Math.floor(timeLeft / 60);
            let sec = timeLeft % 60;
            document.getElementById('timer').innerText = `å‰©é¤˜æ™‚é–“ ${min}:${sec < 10 ? '0'+sec : sec}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitExam();
            }
            timeLeft--;
        }, 1000);
    }

    function submitExam() {
        clearInterval(timerInterval);
        const stuNo = prompt("è«‹è¼¸å…¥åº§è™Ÿï¼š");
        let score = 0;
        examData.forEach((item, index) => {
            const selected = document.querySelector(`input[name="q${index}"]:checked`);
            if (selected && selected.value === item.ans) score += (100 / examData.length);
        });

        const resultData = btoa(encodeURIComponent(JSON.stringify({ no: stuNo, score: Math.round(score), time: new Date().toLocaleTimeString() })));
        
        document.getElementById('studentView').classList.add('hidden');
        document.getElementById('resultView').classList.remove('hidden');
        
        QRCode.toCanvas(document.getElementById('qrCanvas'), resultData, { width: 300 });
    }
</script>
</body>
</html>
