<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina OS Commander | æ——è‰¦äº’å‹•ç³»çµ±</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { 
            --p: #5856D6; --s: #34C759; --d: #FF3B30; --w: #FF9500;
            --bg: #0A0A0C; --card: #1C1C1E; --glass: rgba(255,255,255,0.08); 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'SF Pro Display', 'PingFang TC', system-ui, sans-serif; }
        body { background: var(--bg); color: #FFF; margin: 0; overflow-x: hidden; }

        /* èƒŒæ™¯ç‰¹æ•ˆ */
        .mesh-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 10% 10%, #1a1a2e 0%, #0a0a0c 100%); }
        .mesh-bg::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); opacity: 0.1; }

        .app { min-height: 100vh; display: flex; flex-direction: column; }
        .glass { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 15px; }
        .btn-p { background: var(--p); color: white; box-shadow: 0 5px 15px rgba(88,86,214,0.3); }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .btn:active { transform: translateY(0); }

        /* RWD ä½ˆå±€ */
        .container { max-width: 1200px; margin: auto; width: 100%; padding: 15px; }
        .grid-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        
        @media (max-width: 992px) {
            .grid-layout { grid-template-columns: 1fr; }
            .desktop-only { display: none !important; }
        }

        /* å€’æ•¸è¨ˆæ™‚ */
        .timer-unit { font-size: 48px; font-weight: 900; font-family: 'Courier New', Courier, monospace; color: var(--s); text-shadow: 0 0 20px rgba(52,199,89,0.5); }
        .timer-warning { color: var(--d) !important; animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 20% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, 1px); } }

        /* å­¸ç”ŸæŠ•ç¥¨å€ */
        .stu-opt-area { display: grid; gap: 15px; margin-top: 20px; }
        .stu-btn { padding: 25px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 20px; text-align: left; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .stu-btn.selected { border-color: var(--p); background: rgba(88,86,214,0.2); box-shadow: 0 0 20px rgba(88,86,214,0.4); }
        .stu-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        input[type="text"], input[type="number"] { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: white; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: var(--p); background: rgba(0,0,0,0.6); }

        .hidden { display: none !important; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.1); }
        .badge-online { background: rgba(52,199,89,0.2); color: var(--s); }
        
        /* çµæ¡ˆé®ç½© */
        .full-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
    </style>
</head>
<body>

<div class="mesh-bg"></div>

<div class="app">
    <header style="padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05);">
        <div style="font-size: 22px; font-weight: 900; letter-spacing: 2px;">LUMINA <span style="color:var(--p)">COMMANDER</span></div>
        <div id="sys-status" class="badge">STANDBY</div>
    </header>

    <div class="container">
        <div id="v-start" class="animate__animated animate__fadeIn">
            <div class="glass" style="text-align: center; padding: 60px 20px; margin-top: 50px;">
                <h1 style="font-size: 50px; margin-bottom: 10px;">è®“æ•¸æ“šèªªè©±</h1>
                <p style="color: #888; font-size: 18px; margin-bottom: 40px;">å°ˆæ¥­ã€ç©©å®šã€æ°¸çºŒçš„èª²å ‚æŠ•ç¥¨æ–¹æ¡ˆ</p>
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-p" onclick="checkRecovery()" style="padding: 20px 40px;">ğŸ‘¨â€ğŸ« æˆ‘æ˜¯è€å¸« (é€²å…¥å„€è¡¨æ¿)</button>
                    <button class="btn btn-outline" onclick="showView('v-stu-login')" style="padding: 20px 40px;">ğŸ“± æˆ‘æ˜¯å­¸ç”Ÿ (åŠ å…¥æŠ•ç¥¨)</button>
                </div>
            </div>
        </div>

        <div id="v-teacher" class="hidden animate__animated animate__fadeIn">
            <div class="grid-layout">
                <div class="left-col">
                    <div class="glass">
                        <h3>ğŸ“‹ 1. è¨­å®šå•é¡Œèˆ‡é¸é …</h3>
                        <input type="text" id="t-topic" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æŠ•ç¥¨é¡Œç›®..." style="width:100%; font-size:18px; margin-bottom:15px;">
                        <div id="t-opt-list"></div>
                        <button class="btn btn-outline" onclick="addOptionField()" style="margin-top:10px;">+ æ–°å¢é¸é …</button>
                    </div>

                    <div class="glass">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>ğŸ“Š 2. å³æ™‚æ•¸æ“šç›£æ§</h3>
                            <div id="t-timer" class="timer-unit">01:00</div>
                        </div>
                        <div style="height: 350px; position: relative; margin-top: 20px;">
                            <canvas id="t-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="right-col">
                    <div class="glass" style="text-align: center;">
                        <h2 id="t-room-id" style="font-size: 50px; color: var(--p); margin: 0;">----</h2>
                        <canvas id="qr-canvas" style="width: 100%; border-radius: 12px; margin: 15px 0;"></canvas>
                        <p style="color: #888; font-size: 14px;">è«‹å­¸ç”Ÿæƒç¢¼æˆ–é€£å…¥æˆ¿è™Ÿ</p>
                        
                        <div style="display: grid; gap: 10px; margin-top: 20px;">
                            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
                                é™æ™‚ï¼š<input type="number" id="t-min" value="1" style="width: 50px;"> åˆ† 
                                <input type="number" id="t-sec" value="0" style="width: 50px;"> ç§’
                            </div>
                            <button class="btn btn-s" onclick="publishVote()">ğŸš€ é–‹å§‹æŠ•ç¥¨ (åŒæ­¥é¸é …)</button>
                            <button class="btn btn-d" onclick="confirmReset()">ğŸ”„ æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
                            <button class="btn btn-outline" onclick="exportToCSV()">ğŸ’¾ ä¸‹è¼‰ CSV å ±è¡¨</button>
                        </div>
                    </div>
                    
                    <div class="glass">
                        <h4>ç¾æ³åˆ†æ</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>é€£ç·šäººæ•¸</span><span id="stat-online" style="color:var(--s)">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>æŠ•ç¥¨ç‡</span><span id="stat-ratio" style="color:var(--p)">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="v-stu-login" class="hidden animate__animated animate__fadeIn">
            <div class="glass" style="max-width: 400px; margin: 80px auto; text-align: center;">
                <h2>åŠ å…¥æŠ•ç¥¨æˆ¿</h2>
                <input type="text" id="s-room-input" maxlength="4" placeholder="è«‹è¼¸å…¥æˆ¿è™Ÿ" style="width:100%; text-align:center; font-size:40px; margin: 20px 0;">
                <button class="btn btn-p" style="width: 100%; padding: 15px;" onclick="initStudent()">å»ºç«‹å®‰å…¨é€£ç·š</button>
            </div>
        </div>

        <div id="v-student" class="hidden animate__animated animate__fadeIn">
            <div class="glass" style="text-align: center; border-bottom: 4px solid var(--p);">
                <div id="s-timer-display" style="font-size: 24px; font-weight: bold; color: var(--s);">ç­‰å¾…è€å¸«ç™¼å¸ƒ...</div>
                <h1 id="s-topic-display" style="margin: 15px 0;">--</h1>
            </div>
            <div id="s-opt-container" class="stu-opt-area">
                </div>
            <div id="s-lock-msg" class="hidden" style="text-align:center; margin-top:20px; color:var(--d);">
                ğŸ”’ æŠ•ç¥¨å·²æˆªæ­¢ï¼Œæ•¸æ“šå·²ç”±ç³»çµ±é–å®š
            </div>
        </div>
    </div>
</div>

<div id="final-screen" class="full-overlay hidden animate__animated animate__fadeIn">
    <h2 style="color: var(--s); font-size: 30px;">æŠ•ç¥¨ä»»å‹™å®Œæˆ</h2>
    <div id="winner-card" class="glass" style="min-width: 320px; padding: 40px; border: 2px solid var(--p);">
        <p>æœ€é«˜å¾—ç¥¨</p>
        <h1 id="winner-name" style="font-size: 60px; color: var(--p); margin: 10px 0;">--</h1>
        <p id="winner-votes" style="font-size: 20px; color: #888;">0 ç¥¨</p>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-outline" onclick="document.getElementById('final-screen').classList.add('hidden')">è¿”å›å„€è¡¨æ¿</button>
        <button class="btn btn-p" onclick="exportToCSV()">ä¸‹è¼‰æ•¸æ“šæª”æ¡ˆ</button>
    </div>
</div>

<script>
    let peer, conn, role, myChart, timerInt;
    let options = ["åŒæ„", "ä¸åŒæ„", "æ²’æ„è¦‹"];
    let votes = {};
    let voterMap = new Map();
    let isLocked = false;
    let roomID = "";

    const PEER_CONFIG = { 
        'config': { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }, { 'urls': 'stun:stun1.l.google.com:19302' }] } 
    };

    function showView(id) {
        document.querySelectorAll('.app > div').forEach(d => { if(d.id.startsWith('v-')) d.classList.add('hidden'); });
        document.getElementById(id).classList.remove('hidden');
    }

    // --- æ•¸æ“šæŒä¹…åŒ–æ ¸å¿ƒ ---
    function saveState() {
        if (role !== 'teacher') return;
        const state = {
            roomID, options, votes, 
            voterMap: Array.from(voterMap.entries()),
            topic: document.getElementById('t-topic').value
        };
        localStorage.setItem('Lumina_Commander_Backup', JSON.stringify(state));
    }

    function checkRecovery() {
        const saved = localStorage.getItem('Lumina_Commander_Backup');
        if (saved) {
            if (confirm("ç™¼ç¾ä¸Šæ¬¡æœªå®Œæˆçš„æŠ•ç¥¨è¨˜éŒ„ï¼Œæ˜¯å¦æ¢å¾©ï¼Ÿ")) {
                const state = JSON.parse(saved);
                roomID = state.roomID;
                options = state.options;
                votes = state.votes;
                voterMap = new Map(state.voterMap);
                initTeacher(roomID, state.topic);
                return;
            }
        }
        initTeacher();
    }

    // --- è€å¸«ç«¯æ ¸å¿ƒ ---
    function initTeacher(forceID = null, savedTopic = "") {
        role = 'teacher';
        roomID = forceID || Math.floor(1000 + Math.random() * 8999).toString();
        peer = new Peer('LUMINA-' + roomID, PEER_CONFIG);

        peer.on('open', id => {
            showView('v-teacher');
            document.getElementById('t-room-id').innerText = roomID;
            document.getElementById('sys-status').innerText = "ONLINE | " + roomID;
            document.getElementById('sys-status').classList.add('badge-online');
            if(savedTopic) document.getElementById('t-topic').value = savedTopic;
            
            QRCode.toCanvas(document.getElementById('qr-canvas'), window.location.href.split('?')[0] + '?r=' + roomID);
            renderTeacherOptions();
            initChart();
            updateChart(); // æ¢å¾©æ•¸æ“šå¾Œçš„ç¹ªåœ–

            // ç‹€æ…‹å»£æ’­å¿ƒè·³
            setInterval(() => {
                const msg = {
                    type: 'sync',
                    topic: document.getElementById('t-topic').value || "äº’å‹•æŠ•ç¥¨",
                    options: options,
                    isLocked: isLocked,
                    timeLeft: document.getElementById('t-timer').innerText
                };
                Object.values(peer.connections).forEach(conns => conns.forEach(c => { if(c.open) c.send(msg); }));
                document.getElementById('stat-online').innerText = Object.keys(peer.connections).length;
                saveState();
            }, 1000);
        });

        peer.on('connection', c => {
            c.on('data', d => {
                if(d.type === 'vote' && !isLocked) {
                    if(voterMap.has(c.peer)) votes[voterMap.get(c.peer)]--;
                    voterMap.set(c.peer, d.val);
                    votes[d.val] = (votes[d.val] || 0) + 1;
                    updateChart();
                }
            });
        });
    }

    function renderTeacherOptions() {
        const container = document.getElementById('t-opt-list');
        container.innerHTML = options.map((opt, i) => `
            <div class="animate__animated animate__fadeIn" style="display:flex; gap:10px; margin-bottom:8px;">
                <input type="text" value="${opt}" oninput="options[${i}]=this.value" style="flex:1">
                <button class="btn btn-outline" onclick="options.splice(${i},1); renderTeacherOptions()">âœ•</button>
            </div>
        `).join('');
    }
    function addOptionField() { options.push("æ–°é¸é … " + (options.length+1)); renderTeacherOptions(); }

    function initChart() {
        const ctx = document.getElementById('t-chart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: options, datasets: [{ data: [], backgroundColor: '#5856D6', borderRadius: 8 }] },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } } }
            }
        });
    }

    function updateChart() {
        myChart.data.labels = options;
        myChart.data.datasets[0].data = options.map(o => votes[o] || 0);
        myChart.update();
        const total = voterMap.size;
        const online = Object.keys(peer.connections).length;
        document.getElementById('stat-ratio').innerText = online > 0 ? Math.round(total/online*100) + "%" : "0%";
    }

    function publishVote() {
        isLocked = false;
        voterMap.clear();
        options.forEach(o => votes[o] = 0);
        updateChart();

        let totalSec = (parseInt(document.getElementById('t-min').value) * 60) + parseInt(document.getElementById('t-sec').value);
        if(timerInt) clearInterval(timerInt);
        
        timerInt = setInterval(() => {
            totalSec--;
            let m = Math.floor(totalSec/60).toString().padStart(2,'0');
            let s = (totalSec%60).toString().padStart(2,'0');
            const timerEl = document.getElementById('t-timer');
            timerEl.innerText = `${m}:${s}`;
            
            if(totalSec <= 10) timerEl.classList.add('timer-warning');
            else timerEl.classList.remove('timer-warning');

            if(totalSec <= 0) {
                clearInterval(timerInt);
                endVoting();
            }
        }, 1000);
    }

    function endVoting() {
        isLocked = true;
        let max = -1, winner = "ç„¡";
        for(let o in votes) { if(votes[o] > max) { max = votes[o]; winner = o; } }
        document.getElementById('winner-name').innerText = winner;
        document.getElementById('winner-votes').innerText = (votes[winner] || 0) + " ç¥¨";
        document.getElementById('final-screen').classList.remove('hidden');
    }

    function confirmReset() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡åˆªé™¤å‚™ä»½ã€‚")) {
            localStorage.removeItem('Lumina_Commander_Backup');
            location.reload();
        }
    }

    // --- å ±è¡¨å°å‡º ---
    function exportToCSV() {
        let csv = "\uFEFFé¡Œç›®," + document.getElementById('t-topic').value + "\né¸é …,ç¥¨æ•¸,ç™¾åˆ†æ¯”\n";
        const total = voterMap.size;
        options.forEach(o => {
            const p = total > 0 ? Math.round(votes[o]/total*100) : 0;
            csv += `${o},${votes[o] || 0},${p}%\n`;
        });
        csv += `\nç¸½æŠ•ç¥¨äººæ•¸,${total}`;
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `æŠ•ç¥¨å ±è¡¨_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }

    // --- å­¸ç”Ÿç«¯æ ¸å¿ƒ ---
    let s_conn, s_lastSel = "";
    function initStudent() {
        const rid = document.getElementById('s-room-input').value || new URLSearchParams(window.location.search).get('r');
        if(!rid) return alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");
        
        showView('v-student');
        peer = new Peer(PEER_CONFIG);
        peer.on('open', () => {
            connectToHost(rid);
            setInterval(() => { if(!s_conn || !s_conn.open) connectToHost(rid); }, 3000);
        });
    }

    function connectToHost(rid) {
        s_conn = peer.connect('LUMINA-' + rid, { reliable: true });
        s_conn.on('data', d => {
            if(d.type === 'sync') {
                document.getElementById('s-topic-display').innerText = d.topic;
                document.getElementById('s-timer-display').innerText = d.isLocked ? "æŠ•ç¥¨çµæŸ" : "å‰©é¤˜æ™‚é–“ " + d.timeLeft;
                renderStudentOptions(d.options, d.isLocked);
            }
        });
    }

    function renderStudentOptions(opts, locked) {
        const area = document.getElementById('s-opt-container');
        area.innerHTML = opts.map(o => `
            <button class="stu-btn ${s_lastSel===o?'selected':''} animate__animated animate__fadeInUp" 
                ${locked?'disabled':''} onclick="castVote('${o}')">
                ${o}
            </button>
        `).join('');
        document.getElementById('s-lock-msg').classList.toggle('hidden', !locked);
    }

    function castVote(val) {
        s_lastSel = val;
        s_conn.send({ type: 'vote', val: val });
        if(window.navigator.vibrate) window.navigator.vibrate(50);
    }

    // åˆå§‹åŒ–æª¢æ¸¬ URL æˆ¿è™Ÿ
    window.onload = () => {
        const r = new URLSearchParams(window.location.search).get('r');
        if(r) { document.getElementById('s-room-input').value = r; showView('v-stu-login'); }
    };
</script>
</body>
</html>
