<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina Pro | Android å¼·åŒ–ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; user-select: none; }
        .app { max-width: 800px; margin: auto; padding: 15px; }
        .glass { background: #FFF; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .hidden { display: none !important; }
        .btn { padding: 12px 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-p { background: var(--p); color: #FFF; width: 100%; }
        .btn-s { background: var(--s); color: #FFF; }
        .btn-d { background: var(--d); color: #FFF; }
        
        #lockMask { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 999999; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .q-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
        .q-num-btn { min-width: 45px; height: 45px; border-radius: 10px; border: 1px solid #DDD; display: flex; align-items: center; justify-content: center; background: #FFF; flex-shrink: 0; }
        .q-num-btn.active { background: var(--p); color: #FFF; }
        .q-num-btn.done { border: 2px solid var(--p); color: var(--p); }
        input[type="text"], input[type="number"] { padding: 12px; border-radius: 10px; border: 1px solid #DDD; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px 5px; border-bottom: 1px solid #EEE; text-align: center; }
    </style>
</head>
<body>

<div id="lockMask" class="hidden">
    <h1 style="font-size: 60px;">ğŸ”’</h1>
    <h2>ä½œç­”æš«åœä¸­</h2>
    <p>è«‹æŠ¬é ­è½è€å¸«è¬›è§£</p>
</div>

<div class="app">
    <div id="v-start" class="glass" style="text-align:center; margin-top:50px;">
        <h1 style="color:var(--p);">Lumina Pro</h1>
        <button class="btn btn-p" onclick="showView('v-teacher-setup')" style="margin-bottom:10px;">æ•™å¸«ç«¯</button>
        <button class="btn" onclick="showView('v-student-login')" style="width:100%; background:#8E8E93; color:white;">å­¸ç”Ÿç«¯</button>
    </div>

    <div id="v-student-login" class="hidden glass">
        <h2>âœï¸ å­¸ç”Ÿç™»å…¥</h2>
        <input type="text" id="stuRoomId" placeholder="æˆ¿è™Ÿ (ID)" style="width:100%;">
        <input type="text" id="stuNo" placeholder="åº§è™Ÿ" style="width:100%;">
        <button class="btn btn-p" onclick="initStudent()">é€²å…¥è€ƒå ´</button>
    </div>

    <div id="v-teacher-setup" class="hidden glass">
        <h2>ğŸ‘¨â€ğŸ« è¨­å®šé¡Œç›®</h2>
        <input type="text" id="customRoomId" placeholder="è‡ªè¨‚æˆ¿è™Ÿ" style="width:100%;">
        <div id="qList"></div>
        <button class="btn btn-s" onclick="addQuestion()" style="width:100%;">+ æ–°å¢é¡Œç›®</button>
        <button class="btn btn-p" onclick="initTeacher()" style="margin-top:20px;">å•Ÿå‹•è€ƒå ´</button>
    </div>

    <div id="v-teacher-main" class="hidden">
        <div class="glass" style="text-align:center;">
            <h2 id="roomDisplay">ID: ----</h2>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="btn btn-s" onclick="triggerBroadcast()">ğŸš€ æ´¾é€è€ƒå·</button>
                <button id="allLockBtn" class="btn btn-d" onclick="toggleAllLock()">ğŸ”’ å…¨é«”é–å®š</button>
            </div>
            <canvas id="roomQR" style="margin-top:10px;"></canvas>
        </div>
        <div class="glass">
            <table id="monitorTable">
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>é›¢é </th><th>ç‹€æ…‹</th><th>æ§ç®¡</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
            <button class="btn btn-s" onclick="exportExcel()" style="width:100%; margin-top:15px;">ğŸ’¾ åŒ¯å‡º Excel</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div class="glass">
            <b id="stuInfoDisplay">åº§è™Ÿ: --</b>
            <div id="qNav" class="q-nav" style="margin-top:10px;"></div>
        </div>
        <div id="quizContainer" class="glass" style="min-height:200px;">
            <div id="waitMsg" style="text-align:center; padding-top:50px;">
                <p>é€£ç·šæˆåŠŸï¼Œç­‰å¾…è€å¸«æ´¾é¡Œ...</p>
                <button class="btn btn-s" onclick="requestExam()">æ‰‹å‹•åŒæ­¥é¡Œç›®</button>
            </div>
        </div>
        <button id="subBtn" class="btn btn-p hidden" onclick="studentSubmit()" style="padding:15px;">ç¹³äº¤è€ƒå·</button>
    </div>
</div>

<script>
    let peer, conn, myRoomId, myNo;
    let masterQuiz = [], studentData = {}, connections = {};
    let isAllLocked = false, isExamSent = false;

    function showView(id) {
        ['v-start','v-student-login','v-teacher-setup','v-teacher-main','v-student'].forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // --- æ•™å¸«é‚è¼¯ ---
    function addQuestion() {
        const idx = document.querySelectorAll('.edit-card').length;
        document.getElementById('qList').insertAdjacentHTML('beforeend', `
            <div class="edit-card glass" style="padding:10px; margin-bottom:10px; border:1px solid #EEE;">
                <b>Q${idx+1}</b> <input type="text" placeholder="é¡Œç›®" class="in-q" style="width:70%;">
                <input type="text" placeholder="ç­”" class="in-ans" style="width:40px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    <input type="text" placeholder="A" class="in-a"> <input type="text" placeholder="B" class="in-b">
                </div>
            </div>`);
    }

    function initTeacher() {
        const cards = document.querySelectorAll('.edit-card');
        masterQuiz = Array.from(cards).map(c => ({
            q: c.querySelector('.in-q').value,
            opts: {A: c.querySelector('.in-a').value, B: c.querySelector('.in-b').value},
            ans: c.querySelector('.in-ans').value.toUpperCase().trim(),
            point: 10
        }));
        myRoomId = document.getElementById('customRoomId').value.toUpperCase() || "ROOM" + Math.floor(Math.random()*999);
        peer = new Peer(myRoomId);
        peer.on('open', id => {
            showView('v-teacher-main');
            document.getElementById('roomDisplay').innerText = "æˆ¿è™Ÿ: " + id;
            QRCode.toCanvas(document.getElementById('roomQR'), window.location.href.split('?')[0] + '?room=' + id);
        });
        peer.on('connection', c => {
            const no = c.metadata.no;
            connections[no] = c;
            if(!studentData[no]) studentData[no] = { no: no, progress: "0%", cheats: 0, isLocked: false, ans: {} };
            studentData[no].status = "åœ¨ç·š";
            
            c.on('data', d => {
                if(d.type === 'req_exam') sendExamToStudent(no);
                if(d.type === 'sync') { studentData[no].progress = d.progress; studentData[no].cheats = d.cheats; studentData[no].ans = d.ans; updateMonitor(); }
                if(d.type === 'submit') { calculateScore(no, d.ans); }
            });
            c.on('close', () => { studentData[no].status = "é›¢ç·š"; updateMonitor(); });
            
            // è‡ªå‹•åµæ¸¬é‡é€£ä¸¦è£œç™¼é–å®šç‹€æ…‹
            if(isAllLocked || studentData[no].isLocked) c.send({type: 'lock', state: true});
        });
    }

    function triggerBroadcast() {
        isExamSent = true;
        Object.keys(connections).forEach(no => sendExamToStudent(no));
        alert("å·²æ´¾é€");
    }

    function sendExamToStudent(no) {
        if(connections[no] && connections[no].open) {
            connections[no].send({type: 'exam', quiz: masterQuiz.map(({ans, ...r})=>r)});
        }
    }

    function toggleAllLock() {
        isAllLocked = !isAllLocked;
        Object.values(connections).forEach(c => c.send({type: 'lock', state: isAllLocked}));
        document.getElementById('allLockBtn').innerText = isAllLocked ? "ğŸ”“ è§£é™¤å…¨é«”" : "ğŸ”’ å…¨é«”é–å®š";
    }

    function toggleSingleLock(no) {
        studentData[no].isLocked = !studentData[no].isLocked;
        if(connections[no]) connections[no].send({type: 'lock', state: studentData[no].isLocked});
        updateMonitor();
    }

    function updateMonitor() {
        document.getElementById('monitorBody').innerHTML = Object.values(studentData).map(s => `
            <tr>
                <td>${s.no}</td><td>${s.progress}</td><td>${s.cheats}</td>
                <td style="color:${s.status==='åœ¨ç·š'?'green':'red'}">${s.status}</td>
                <td><button class="btn" style="padding:4px 8px; background:${s.isLocked?'#34C759':'#FF3B30'}; color:white" onclick="toggleSingleLock('${s.no}')">${s.isLocked?'è§£':'é–'}</button></td>
            </tr>`).join('');
    }

    // --- å­¸ç”Ÿé‚è¼¯ ---
    function initStudent() {
        const id = document.getElementById('stuRoomId').value.toUpperCase().trim();
        myNo = document.getElementById('stuNo').value.trim();
        showView('v-student');
        document.getElementById('stuInfoDisplay').innerText = "åº§è™Ÿ: " + myNo;

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id, { metadata: { no: myNo } });
            conn.on('open', () => {
                requestExam(); // é€£ç·šæˆåŠŸå¾Œä¸»å‹•è¦é¡Œç›®
                setInterval(() => { if(conn.open) conn.send({type:'ping'}); }, 3000); // å¿ƒè·³åŒ…é é˜² Android å‡çµ
            });
            conn.on('data', d => {
                if(d.type === 'exam') { stuQuiz = d.quiz; renderStuExam(); }
                if(d.type === 'lock') document.getElementById('lockMask').classList.toggle('hidden', !d.state);
                if(d.type === 'report') { alert("å¾—åˆ†: " + d.score); location.reload(); }
            });
        });

        document.addEventListener('visibilitychange', () => { if(document.visibilityState === 'hidden') { stuCheats++; syncStu(); } });
    }

    function requestExam() { if(conn && conn.open) conn.send({type: 'req_exam'}); }

    function renderStuExam() {
        myAnswers = JSON.parse(localStorage.getItem('ans_'+myNo) || "{}");
        let html = '';
        stuQuiz.forEach((_, i) => html += `<div class="q-num-btn ${myAnswers[i]?'done':''}" id="nb-${i}" onclick="jumpTo(${i})">${i+1}</div>`);
        document.getElementById('qNav').innerHTML = html;
        jumpTo(0);
    }

    function jumpTo(idx) {
        const q = stuQuiz[idx];
        let opts = '';
        Object.entries(q.opts).forEach(([k, v]) => {
            if(!v) return;
            opts += `<label style="display:block; padding:15px; background:#F2F2F7; margin-bottom:10px; border-radius:12px;">
                <input type="checkbox" value="${k}" ${(myAnswers[idx]||"").includes(k)?'checked':''} onchange="saveAns(${idx})"> ${k}. ${v}
            </label>`;
        });
        document.getElementById('quizContainer').innerHTML = `<h3>ç¬¬ ${idx+1} é¡Œ</h3><p>${q.q}</p>${opts}`;
        document.getElementById('subBtn').classList.toggle('hidden', idx !== stuQuiz.length-1);
    }

    function saveAns(idx) {
        const sel = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(e => e.value).sort().join('');
        myAnswers[idx] = sel;
        localStorage.setItem('ans_'+myNo, JSON.stringify(myAnswers));
        document.getElementById('nb-'+idx).classList.add('done');
        syncStu();
    }

    function syncStu() {
        const done = Object.values(myAnswers).filter(v => v !== "").length;
        const prog = Math.round((done / stuQuiz.length) * 100) + "%";
        if(conn && conn.open) conn.send({type: 'sync', progress: prog, cheats: stuCheats, ans: myAnswers});
    }

    function studentSubmit() { if(confirm("ç¢ºå®šç¹³äº¤ï¼Ÿ")) conn.send({type: 'submit', ans: myAnswers}); }
</script>
</body>
</html>
