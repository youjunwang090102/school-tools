<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Ultra | Android ç©©å®šä¿®æ­£ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #1D1D1F; user-select: none; }
        .app { max-width: 1000px; margin: auto; padding: 20px; }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; box-shadow: 0 4px 30px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #FFF; }
        .hidden { display: none !important; }
        .btn { padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; margin: 3px; }
        .btn-p { background: var(--p); color: #FFF; }
        .btn-s { background: var(--s); color: #FFF; }
        .btn-d { background: var(--d); color: #FFF; }
        
        .stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .stat-item { background: #FFF; padding: 12px; border-radius: 15px; text-align: center; border: 1px solid #DDD; }
        .stat-num { font-size: 22px; font-weight: bold; color: var(--p); }

        .q-nav { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; border-bottom: 1px solid #EEE; }
        .q-num-btn { min-width: 40px; height: 40px; border-radius: 8px; border: 1px solid #DDD; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #FFF; flex-shrink: 0; }
        .q-num-btn.active { background: var(--p); color: #FFF; border-color: var(--p); }
        .q-num-btn.done { background: #E1F5FE; border-color: var(--p); color: var(--p); }

        .lock-mask { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 10000; color: white; display: flex; align-items: center; justify-content: center; font-size: 22px; text-align: center; backdrop-filter: blur(10px); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #EEE; font-size: 14px; }
        .warn { color: var(--d); font-weight: bold; }
        .progress-bar { height: 8px; background: #E5E5EA; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: var(--p); transition: 0.3s; }
    </style>
</head>
<body>

<div class="app">
    <div id="v-start" class="glass" style="text-align:center; margin-top:100px;">
        <h1 style="font-size: 32px;">Lumina Pro Ultra</h1>
        <p style="color: #666;">æ•™å¸«ä¸»æ§èˆ‡å­¸ç”Ÿæ¸¬é©—å¹³å°</p>
        <button class="btn btn-p" onclick="showView('v-teacher-setup')">æ•™å¸«ç«¯å…¥å£</button>
        <button class="btn" style="background:#8E8E93; color:white;" onclick="initStudent()">å­¸ç”Ÿç«¯å…¥å£</button>
    </div>

    <div id="v-teacher-setup" class="hidden">
        <div class="glass">
            <h2>ğŸ  1. è¨­å®šè€ƒå ´ ID</h2>
            <input type="text" id="customRoomId" placeholder="è¼¸å…¥ ID (å¦‚: TEST888)" style="padding:12px; width:220px; border-radius:10px; border:1px solid #DDD; font-size: 18px;">
        </div>
        <div class="glass">
            <h2>ğŸ“ 2. è€ƒé¡Œç·¨è¼¯ (è¦–è¦ºåŒ–)</h2>
            <div id="qList"></div>
            <button class="btn btn-s" onclick="addQuestion()">+ æ–°å¢é¡Œç›®</button>
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                <p>æˆ–ä½¿ç”¨ Excel åŒ¯å…¥ï¼š</p>
                <input type="file" accept=".xlsx" onchange="importExcel(this)">
            </div>
        </div>
        <button class="btn btn-p" style="width:100%; padding:18px; font-size: 18px;" onclick="initTeacher()">å»ºç«‹è€ƒå ´ä¸¦å•Ÿå‹•</button>
    </div>

    <div id="v-teacher-main" class="hidden">
        <div class="glass">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="roomDisplay">è€ƒå ´: ----</h2>
                <div>
                    <button id="allLockBtn" class="btn btn-d" onclick="toggleAllLock()">ğŸ”’ å…¨é«”é–å®š</button>
                    <button class="btn btn-s" onclick="broadcastExam()">ğŸš€ æ‰‹å‹•æ´¾é€/æ›´æ–°</button>
                </div>
            </div>
            <div style="text-align:center;"><canvas id="roomQR"></canvas></div>
            <div class="stat-row">
                <div class="stat-item"><div>é€£ç·š</div><div class="stat-num" id="s-online">0</div></div>
                <div class="stat-item"><div>å·²æ”¶é¡Œ</div><div class="stat-num" id="s-ready">0</div></div>
                <div class="stat-item"><div>å·²ç¹³å·</div><div class="stat-num" id="s-done">0</div></div>
                <div class="stat-item"><div>å¹³å‡</div><div class="stat-num" id="s-avg">0</div></div>
            </div>
        </div>
        <div class="glass">
            <h3>ğŸ“Š å­¸ç”Ÿå¯¦æ™‚é€²åº¦ (åŒ…å«é›¢é æ¬¡æ•¸)</h3>
            <table>
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>é›¢é </th><th>ç‹€æ…‹</th><th>æ§ç®¡</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
            <button class="btn btn-s" style="width:100%; margin-top:20px;" onclick="exportFinalExcel()">ğŸ’¾ åŒ¯å‡ºå®Œæ•´æˆç¸¾å–® (Excel)</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div id="lockMask" class="lock-mask hidden"><div>ğŸ”’ è€å¸«æš«åœäº†ä½œç­”<br><span style="font-size:14px;">è«‹è½è€å¸«è¬›è§£</span></div></div>
        <div class="glass">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b id="stuNoLabel">åº§è™Ÿ: --</b>
                <button class="btn btn-d" style="padding:5px 10px; font-size:12px;" onclick="studentLogout()">ä¿å­˜ä¸¦ç™»å‡º</button>
            </div>
            <div class="progress-bar"><div id="stuProgFill" class="progress-fill" style="width: 0%"></div></div>
            <div id="qNav" class="q-nav"></div>
        </div>
        <div id="quizContainer" class="glass" style="min-height: 200px;">
            <p id="waitMsg" style="text-align:center; color:gray; padding-top: 60px;">ç­‰å¾…è©¦å·æ´¾é€ä¸­...</p>
        </div>
        <button id="finalSubBtn" class="btn btn-p hidden" style="width:100%; padding:15px;" onclick="studentSubmit()">ç¢ºèªç¹³äº¤å…¨å·</button>
    </div>

    <div id="v-result" class="hidden glass" style="text-align:center; margin-top:100px;">
        <h2 style="color:var(--s)">ç¹³äº¤æˆåŠŸ</h2>
        <div id="resScore" style="font-size:80px; font-weight:bold;">0</div>
        <p>ä½ çš„å¾—åˆ†</p>
        <button class="btn btn-p" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<script>
    let peer, conn, myRoomId, isAllLocked = false, isExamBroadcasted = false;
    let studentData = {}; 
    let connections = {};
    let masterQuiz = [];
    let currentIdx = 0; 

    function showView(id) {
        ['v-start','v-teacher-setup','v-teacher-main','v-student','v-result'].forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // --- è€å¸«ç«¯é‚è¼¯ ---
    function addQuestion() {
        const idx = document.querySelectorAll('.edit-card').length;
        const html = `<div class="edit-card" style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:10px;">
            <b>ç¬¬ ${idx+1} é¡Œ</b>
            <input type="text" placeholder="é¡Œç›®å…§å®¹" class="in-q" style="width:100%; margin:5px 0;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                <input type="text" placeholder="Aé¸é …" class="in-a"> <input type="text" placeholder="Bé¸é …" class="in-b">
                <input type="text" placeholder="Cé¸é …" class="in-c"> <input type="text" placeholder="Dé¸é …" class="in-d">
            </div>
            æ­£ç¢ºç­”æ¡ˆ: <input type="text" placeholder="A" class="in-ans" style="width:50px;"> é…åˆ†: <input type="number" value="10" class="in-pt" style="width:50px;">
        </div>`;
        document.getElementById('qList').insertAdjacentHTML('beforeend', html);
    }

    function initTeacher() {
        if(masterQuiz.length === 0) {
            const cards = document.querySelectorAll('.edit-card');
            if(cards.length === 0) return alert("è«‹è‡³å°‘æ–°å¢ä¸€é¡Œé¡Œç›®ï¼");
            masterQuiz = Array.from(cards).map(c => ({
                q: c.querySelector('.in-q').value,
                opts: {A: c.querySelector('.in-a').value, B: c.querySelector('.in-b').value, C: c.querySelector('.in-c').value, D: c.querySelector('.in-d').value},
                ans: c.querySelector('.in-ans').value.toUpperCase().trim(),
                point: Number(c.querySelector('.in-pt').value)
            }));
        }

        myRoomId = document.getElementById('customRoomId').value.toUpperCase().trim() || "ROOM" + Math.floor(Math.random()*999);
        peer = new Peer(myRoomId);
        
        peer.on('open', id => {
            showView('v-teacher-main');
            document.getElementById('roomDisplay').innerText = "ID: " + id;
            QRCode.toCanvas(document.getElementById('roomQR'), window.location.href.split('?')[0] + '?room=' + id);
        });

        peer.on('connection', c => {
            const no = c.metadata.no;
            connections[no] = c;
            
            if(!studentData[no]) {
                studentData[no] = { no: no, progress: "0%", score: 0, status: "åœ¨ç·š", cheats: 0, isLocked: false, hasExam: false, ans: {} };
            } else {
                studentData[no].status = "åœ¨ç·š";
            }

            // ã€æ ¸å¿ƒï¼šè‡ªå‹•è£œç™¼ã€‘å¦‚æœè€ƒå·å·²æ´¾é€ï¼Œå°æ–°é€£ç·šè€…è‡ªå‹•è£œç™¼
            if(isExamBroadcasted) {
                setTimeout(() => {
                    c.send({type: 'exam', quiz: masterQuiz.map(({ans, ...r}) => r), locked: isAllLocked || studentData[no].isLocked});
                }, 1000);
            }

            updateMonitor();
            c.on('data', d => {
                if(d.type === 'received') { studentData[no].hasExam = true; updateMonitor(); }
                if(d.type === 'sync') { 
                    studentData[no].progress = d.progress; 
                    studentData[no].cheats = d.cheats; 
                    studentData[no].ans = d.ans;
                    updateMonitor(); 
                }
                if(d.type === 'submit') { calculateScore(no, d.ans); }
            });
            c.on('close', () => { if(studentData[no]) studentData[no].status = "é›¢ç·š"; updateMonitor(); });
        });
    }

    function broadcastExam() {
        if(masterQuiz.length === 0) return alert("è€ƒé¡Œåº«ç‚ºç©º");
        isExamBroadcasted = true;
        const safe = masterQuiz.map(({ans, ...r}) => r);
        Object.values(connections).forEach(c => {
            if(c.open) c.send({type: 'exam', quiz: safe, locked: isAllLocked});
        });
        alert("è€ƒå·æ´¾é€ä¸­ï¼Œæ–°åŠ å…¥çš„å­¸ç”Ÿä¹Ÿå°‡è‡ªå‹•æ”¶åˆ°ã€‚");
    }

    function calculateScore(no, ans) {
        let total = 0;
        masterQuiz.forEach((q, i) => { if(ans[i] === q.ans) total += q.point; });
        studentData[no].score = total;
        studentData[no].status = "å·²ç¹³å·";
        studentData[no].ans = ans;
        if(connections[no]) connections[no].send({type: 'report', score: total});
        updateMonitor();
    }

    function updateMonitor() {
        const list = Object.values(studentData);
        document.getElementById('s-online').innerText = list.filter(s => s.status !== "é›¢ç·š").length;
        document.getElementById('s-ready').innerText = list.filter(s => s.hasExam).length;
        document.getElementById('s-done').innerText = list.filter(s => s.status === "å·²ç¹³å·").length;
        
        let totalS = 0, doneC = 0;
        document.getElementById('monitorBody').innerHTML = list.map(s => {
            if(s.status === "å·²ç¹³å·") { totalS += s.score; doneC++; }
            return `<tr>
                <td>${s.no}</td><td>${s.progress}</td>
                <td class="${s.cheats>0?'warn':''}">${s.cheats} æ¬¡</td>
                <td style="color:${s.hasExam?'green':'gray'}">${s.status}${s.hasExam?' (æ”¶é¡Œ)':' (å¾…é¡Œ)'}</td>
                <td><button class="btn btn-d" style="padding:4px 8px;" onclick="toggleSingleLock('${s.no}')">é–</button></td>
            </tr>`;
        }).join('');
        document.getElementById('s-avg').innerText = doneC > 0 ? (totalS / doneC).toFixed(1) : 0;
    }

    function toggleAllLock() {
        isAllLocked = !isAllLocked;
        Object.values(connections).forEach(c => c.send({type: 'lock', state: isAllLocked}));
        document.getElementById('allLockBtn').innerText = isAllLocked ? "ğŸ”“ è§£é™¤å…¨é–" : "ğŸ”’ å…¨é«”é–å®š";
    }

    function toggleSingleLock(no) {
        studentData[no].isLocked = !studentData[no].isLocked;
        if(connections[no]) connections[no].send({type: 'lock', state: studentData[no].isLocked});
    }

    // --- å­¸ç”Ÿç«¯é‚è¼¯ ---
    let myAnswers = {}, stuQuiz = [], stuCheats = 0;
    function initStudent() {
        const id = (new URLSearchParams(window.location.search)).get('room') || prompt("è«‹è¼¸å…¥æˆ¿é–“ ID:");
        myNo = prompt("è«‹è¼¸å…¥åº§è™Ÿ:");
        if(!id || !myNo) return;
        showView('v-student');
        document.getElementById('stuNoLabel').innerText = "åº§è™Ÿ: " + myNo;

        peer = new Peer();
        peer.on('open', () => {
            const c = peer.connect(id.toUpperCase().trim(), { metadata: { no: myNo } });
            c.on('data', d => {
                if(d.type === 'exam') {
                    stuQuiz = d.quiz;
                    c.send({type: 'received'});
                    renderStuExam();
                    document.getElementById('lockMask').classList.toggle('hidden', !d.locked);
                }
                if(d.type === 'lock') document.getElementById('lockMask').classList.toggle('hidden', !d.state);
                if(d.type === 'report') { showResult(d.score); }
            });
            window.myConn = c;
        });

        // Android ç©©å®šé›¢é ç›£æ¸¬
        document.addEventListener('visibilitychange', () => {
            if(document.visibilityState === 'hidden') {
                stuCheats++;
                syncStu();
            }
        });
    }

    function renderStuExam() {
        const saved = JSON.parse(localStorage.getItem('ans_'+myNo) || "{}");
        myAnswers = saved;
        let navHtml = '';
        stuQuiz.forEach((_, i) => {
            const isDone = myAnswers[i] ? 'done' : '';
            navHtml += `<div class="q-num-btn ${isDone}" id="nb-${i}" onclick="jumpTo(${i})">${i+1}</div>`;
        });
        document.getElementById('qNav').innerHTML = navHtml;
        jumpTo(0);
        syncStu();
    }

    function jumpTo(idx) {
        currentIdx = idx;
        const q = stuQuiz[idx];
        let optsHtml = '';
        Object.entries(q.opts).forEach(([k, v]) => {
            if(!v) return;
            const checked = (myAnswers[idx] || "").includes(k) ? "checked" : "";
            optsHtml += `<label style="display:block; padding:15px; background:#f5f5f7; margin:10px 0; border-radius:12px;">
                <input type="checkbox" name="sq" value="${k}" ${checked} onchange="saveAns()"> ${k}. ${v}
            </label>`;
        });
        document.getElementById('quizContainer').innerHTML = `<h3>ç¬¬ ${idx+1} é¡Œ</h3><p>${q.q}</p>${optsHtml}`;
        document.querySelectorAll('.q-num-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nb-'+idx).classList.add('active');
        document.getElementById('finalSubBtn').classList.toggle('hidden', idx !== stuQuiz.length - 1);
    }

    function saveAns() {
        const sel = Array.from(document.querySelectorAll('input[name="sq"]:checked')).map(e => e.value).sort().join('');
        myAnswers[currentIdx] = sel;
        localStorage.setItem('ans_'+myNo, JSON.stringify(myAnswers));
        if(sel) document.getElementById('nb-'+currentIdx).classList.add('done');
        syncStu();
    }

    function syncStu() {
        const doneCount = Object.values(myAnswers).filter(v => v !== "").length;
        const prog = Math.round((doneCount / stuQuiz.length) * 100);
        document.getElementById('stuProgFill').style.width = prog + "%";
        if(window.myConn && window.myConn.open) {
            window.myConn.send({type: 'sync', progress: prog + "%", cheats: stuCheats, ans: myAnswers});
        }
    }

    function studentSubmit() {
        if(confirm("ç¢ºå®šç¹³äº¤ï¼Ÿ")) {
            window.myConn.send({type: 'submit', ans: myAnswers});
        }
    }

    function studentLogout() {
        alert("ç­”æ¡ˆå·²ä¿å­˜åœ¨æ­¤è£ç½®ã€‚");
        location.reload();
    }

    function showResult(s) {
        showView('v-result');
        document.getElementById('resScore').innerText = s;
        localStorage.removeItem('ans_'+myNo);
    }

    // åŒ¯å‡ºåŠŸèƒ½ä¿®æ­£
    function exportFinalExcel() {
        const list = Object.values(studentData).map(s => {
            let row = { "åº§è™Ÿ": s.no, "ç¸½åˆ†": s.score, "é›¢é æ¬¡æ•¸": s.cheats, "ç‹€æ…‹": s.status };
            masterQuiz.forEach((_, i) => {
                row[`ç¬¬${i+1}é¡Œå›ç­”`] = s.ans ? s.ans[i] : "";
            });
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(list);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾å–®");
        XLSX.writeFile(wb, `æˆç¸¾å–®_${myRoomId}.xlsx`);
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = e => {
            const data = XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type:'array'}).Sheets[XLSX.read(e.target.result, {type:'array'}).SheetNames[0]]);
            masterQuiz = data.map(r => ({
                q: r.é¡Œç›®, opts: {A:r.é¸é …A, B:r.é¸é …B, C:r.é¸é …C, D:r.é¸é …D},
                ans: String(r.æ­£ç¢ºç­”æ¡ˆ).toUpperCase().trim(), point: Number(r.é…åˆ† || 10)
            }));
            alert("åŒ¯å…¥æˆåŠŸ: " + masterQuiz.length + " é¡Œ");
        };
        reader.readAsArrayBuffer(input.files[0]);
    }
</script>
</body>
</html>
