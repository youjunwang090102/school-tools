<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina Pro Ultra | å°ˆæ¥­ç´šç©©å®šç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1D1D1F; user-select: none; -webkit-tap-highlight-color: transparent; }
        .app { max-width: 800px; margin: auto; padding: 15px; box-sizing: border-box; }
        .glass { background: #FFF; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .hidden { display: none !important; }
        .btn { padding: 12px 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-p { background: var(--p); color: #FFF; }
        .btn-d { background: var(--d); color: #FFF; }
        .btn-s { background: var(--s); color: #FFF; }
        
        /* é–å®šé®ç½© */
        .lock-mask { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 99999; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .lock-icon { font-size: 60px; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* å°è¦½åˆ— */
        .q-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .q-num-btn { min-width: 45px; height: 45px; border-radius: 10px; border: 1px solid #DDD; display: flex; align-items: center; justify-content: center; background: #FFF; flex-shrink: 0; font-weight: bold; }
        .q-num-btn.active { background: var(--p); color: #FFF; border-color: var(--p); }
        .q-num-btn.done { border: 2px solid var(--p); color: var(--p); }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px 5px; text-align: center; border-bottom: 1px solid #EEE; }
        .status-tag { padding: 3px 6px; border-radius: 6px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

<div id="lockMask" class="lock-mask hidden">
    <div class="lock-icon">ğŸ”’</div>
    <div style="font-size: 20px;">è€å¸«å·²æš«åœæ‚¨çš„ä½œç­”</div>
    <div style="font-size: 14px; margin-top: 10px; color: #AAA;">è«‹æŠ¬é ­è½è¬›ï¼Œå‹¿æ“ä½œæ‰‹æ©Ÿ</div>
</div>

<div class="app">
    <div id="v-teacher-setup" class="glass">
        <h2>ğŸ‘¨â€ğŸ« è¨­å®šè€ƒå ´</h2>
        <input type="text" id="customRoomId" placeholder="è‡ªè¨‚æˆ¿è™Ÿ (å¦‚: CHINESE)" style="width:100%; padding:12px; box-sizing:border-box; border-radius:10px; border:1px solid #DDD; margin-bottom:15px;">
        <div id="qList"></div>
        <button class="btn btn-s" onclick="addQuestion()" style="width:100%;">+ æ–°å¢ä¸€é¡Œ</button>
        <button class="btn btn-p" onclick="initTeacher()" style="width:100%; margin-top:20px; padding:18px;">å•Ÿå‹•è€ƒå ´ä¸¦ç›£æ§</button>
    </div>

    <div id="v-teacher-main" class="hidden">
        <div class="glass" style="text-align:center;">
            <h2 id="roomDisplay">ID: ----</h2>
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
                <button class="btn btn-p" onclick="broadcastExam()">ğŸš€ æ´¾é€è€ƒå·</button>
                <button id="allLockBtn" class="btn btn-d" onclick="toggleAllLock()">ğŸ”’ å…¨é«”é–å®š</button>
            </div>
            <canvas id="roomQR" style="margin: auto;"></canvas>
        </div>
        <div class="glass">
            <h3>ğŸ“Š å­¸ç”Ÿåå–® (åŒæ­¥ç›£æ§)</h3>
            <table>
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>é›¢é </th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
            <button class="btn btn-s" onclick="exportExcel()" style="width:100%; margin-top:15px;">ğŸ’¾ åŒ¯å‡ºæˆç¸¾ (Excel)</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div class="glass">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b id="stuInfo">åº§è™Ÿ: --</b>
                <button class="btn btn-d" onclick="location.reload()" style="padding:4px 10px;">ç™»å‡º</button>
            </div>
            <div id="qNav" class="q-nav" style="margin-top:15px;"></div>
        </div>
        <div id="quizContainer" class="glass" style="min-height:200px;">
            <p style="text-align:center; color:gray; padding:50px 0;">ç­‰å¾…è©¦å·æ´¾é€...</p>
        </div>
        <button id="subBtn" class="btn btn-p hidden" onclick="studentSubmit()" style="width:100%; padding:15px; font-size:18px;">æœ€å¾Œä¸€é¡Œï¼Œç¢ºèªç¹³äº¤</button>
    </div>

    <div id="v-result" class="hidden glass" style="text-align:center; margin-top:100px;">
        <h2 style="color:var(--s)">ç¹³äº¤æˆåŠŸ</h2>
        <div id="resScore" style="font-size:70px; font-weight:bold;">0</div>
        <p>ä½ çš„å¾—åˆ†</p>
        <button class="btn btn-p" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<script>
    let peer, conn, myRoomId;
    let masterQuiz = [];
    let studentData = {}; // å­˜å„²å­¸ç”Ÿç‹€æ…‹ (åŒ…å«é–å®šç‹€æ…‹)
    let connections = {};
    let isAllLocked = false;
    let isExamSent = false;

    // --- æ ¸å¿ƒå·¥å…· ---
    function showView(id) {
        ['v-teacher-setup','v-teacher-main','v-student','v-result'].forEach(v => {
            document.getElementById(v).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }

    // --- æ•™å¸«ç«¯ ---
    function addQuestion() {
        const idx = document.querySelectorAll('.edit-card').length;
        const html = `<div class="edit-card glass" style="padding:10px; border:1px solid #EEE;">
            <b>Q${idx+1}</b> <input type="text" placeholder="é¡Œç›®" class="in-q" style="width:70%;">
            <input type="text" placeholder="ç­”æ¡ˆ" class="in-ans" style="width:40px;">
            <input type="number" value="10" class="in-pt" style="width:40px;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
                <input type="text" placeholder="A" class="in-a"> <input type="text" placeholder="B" class="in-b">
                <input type="text" placeholder="C" class="in-c"> <input type="text" placeholder="D" class="in-d">
            </div>
        </div>`;
        document.getElementById('qList').insertAdjacentHTML('beforeend', html);
    }

    function initTeacher() {
        const cards = document.querySelectorAll('.edit-card');
        masterQuiz = Array.from(cards).map(c => ({
            q: c.querySelector('.in-q').value,
            opts: {A: c.querySelector('.in-a').value, B: c.querySelector('.in-b').value, C: c.querySelector('.in-c').value, D: c.querySelector('.in-d').value},
            ans: c.querySelector('.in-ans').value.toUpperCase().trim(),
            point: Number(c.querySelector('.in-pt').value)
        }));

        myRoomId = document.getElementById('customRoomId').value.toUpperCase().trim() || "ROOM" + Math.floor(Math.random()*999);
        peer = new Peer(myRoomId);
        
        peer.on('open', id => {
            showView('v-teacher-main');
            document.getElementById('roomDisplay').innerText = "æˆ¿è™Ÿ: " + id;
            QRCode.toCanvas(document.getElementById('roomQR'), window.location.href.split('?')[0] + '?room=' + id);
        });

        peer.on('connection', c => {
            const no = c.metadata.no;
            connections[no] = c;
            
            // åˆå§‹åŒ–æˆ–é‚„åŸå­¸ç”Ÿç‹€æ…‹
            if(!studentData[no]) {
                studentData[no] = { no: no, progress: "0%", score: 0, status: "åœ¨ç·š", cheats: 0, isLocked: false, hasExam: false, ans: {} };
            }
            studentData[no].status = "åœ¨ç·š";

            // é‡è¦ï¼šAndroid é‡é€£å¾Œç«‹åˆ»è£œç™¼æ‰€æœ‰ç‹€æ…‹
            setTimeout(() => {
                // 1. å¦‚æœå…¨é«”é–å®šæˆ–å€‹äººé–å®šï¼Œç™¼é€é–å®šæŒ‡ä»¤
                if(isAllLocked || studentData[no].isLocked) {
                    c.send({type: 'lock', state: true});
                }
                // 2. å¦‚æœå·²ç¶“æ´¾é¡Œï¼Œè£œç™¼è©¦å·
                if(isExamSent) {
                    c.send({type: 'exam', quiz: masterQuiz.map(({ans, ...r}) => r)});
                }
            }, 800);

            c.on('data', d => {
                if(d.type === 'received') { studentData[no].hasExam = true; updateMonitor(); }
                if(d.type === 'sync') { 
                    studentData[no].progress = d.progress; 
                    studentData[no].cheats = d.cheats; 
                    studentData[no].ans = d.ans;
                    updateMonitor(); 
                }
                if(d.type === 'submit') { 
                    let total = 0;
                    masterQuiz.forEach((q, i) => { if(d.ans[i] === q.ans) total += q.point; });
                    studentData[no].score = total;
                    studentData[no].status = "âœ… å·²ç¹³";
                    c.send({type: 'report', score: total});
                    updateMonitor();
                }
            });
            c.on('close', () => { studentData[no].status = "é›¢ç·š"; updateMonitor(); });
        });
    }

    function broadcastExam() {
        isExamSent = true;
        const safe = masterQuiz.map(({ans, ...r}) => r);
        Object.values(connections).forEach(c => c.send({type: 'exam', quiz: safe}));
        alert("è€ƒå·å·²æ´¾é€");
    }

    function toggleAllLock() {
        isAllLocked = !isAllLocked;
        Object.values(connections).forEach(c => c.send({type: 'lock', state: isAllLocked}));
        document.getElementById('allLockBtn').innerText = isAllLocked ? "ğŸ”“ è§£é™¤å…¨é«”" : "ğŸ”’ å…¨é«”é–å®š";
        updateMonitor();
    }

    function toggleSingleLock(no) {
        studentData[no].isLocked = !studentData[no].isLocked;
        if(connections[no]) connections[no].send({type: 'lock', state: studentData[no].isLocked});
        updateMonitor();
    }

    function updateMonitor() {
        document.getElementById('monitorBody').innerHTML = Object.values(studentData).map(s => `
            <tr>
                <td>${s.no}</td>
                <td>${s.progress}</td>
                <td style="color:${s.cheats>0?'red':'black'}">${s.cheats}</td>
                <td><span class="status-tag" style="background:${s.status==='åœ¨ç·š'?'#E3F2FD':'#EEEEEE'}">${s.status}</span></td>
                <td><button class="btn" style="padding:4px 8px; background:${s.isLocked?'#34C759':'#FF3B30'}; color:white" onclick="toggleSingleLock('${s.no}')">${s.isLocked?'è§£':'é–'}</button></td>
            </tr>
        `).join('');
    }

    function exportExcel() {
        const data = Object.values(studentData).map(s => {
            let row = {"åº§è™Ÿ": s.no, "å¾—åˆ†": s.score, "é›¢é æ¬¡æ•¸": s.cheats};
            masterQuiz.forEach((_, i) => row[`Q${i+1}`] = s.ans[i] || "");
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾");
        XLSX.writeFile(wb, "æˆç¸¾å–®.xlsx");
    }

    // --- å­¸ç”Ÿç«¯ ---
    let myAnswers = {}, stuQuiz = [], stuCheats = 0;
    function initStudent() {
        const id = (new URLSearchParams(window.location.search)).get('room') || prompt("æˆ¿è™Ÿ:");
        const no = prompt("åº§è™Ÿ:");
        if(!id || !no) return;
        showView('v-student');
        document.getElementById('stuInfo').innerText = "åº§è™Ÿ: " + no;

        peer = new Peer();
        peer.on('open', () => {
            const c = peer.connect(id.toUpperCase(), { metadata: { no: no } });
            c.on('data', d => {
                if(d.type === 'exam') {
                    stuQuiz = d.quiz;
                    renderStuExam(no);
                    c.send({type: 'received'});
                }
                if(d.type === 'lock') {
                    document.getElementById('lockMask').classList.toggle('hidden', !d.state);
                }
                if(d.type === 'report') {
                    showView('v-result');
                    document.getElementById('resScore').innerText = d.score;
                    localStorage.removeItem('ans_'+no);
                }
            });
            window.activeConn = c;
        });

        // Android visibility ç©©å®šç›£è½
        document.addEventListener('visibilitychange', () => {
            if(document.visibilityState === 'hidden') {
                stuCheats++;
                syncStu(no);
            }
        });
    }

    function renderStuExam(no) {
        myAnswers = JSON.parse(localStorage.getItem('ans_'+no) || "{}");
        let html = '';
        stuQuiz.forEach((_, i) => {
            html += `<div class="q-num-btn ${myAnswers[i]?'done':''}" id="nb-${i}" onclick="jumpTo(${i}, '${no}')">${i+1}</div>`;
        });
        document.getElementById('qNav').innerHTML = html;
        jumpTo(0, no);
    }

    function jumpTo(idx, no) {
        const q = stuQuiz[idx];
        let opts = '';
        Object.entries(q.opts).forEach(([k, v]) => {
            if(!v) return;
            const checked = (myAnswers[idx] || "").includes(k) ? "checked" : "";
            opts += `<label style="display:block; padding:15px; background:#F2F2F7; margin-bottom:10px; border-radius:12px;">
                <input type="checkbox" name="opt" value="${k}" ${checked} onchange="saveAns(${idx}, '${no}')"> ${k}. ${v}
            </label>`;
        });
        document.getElementById('quizContainer').innerHTML = `<h3>ç¬¬ ${idx+1} é¡Œ</h3><p>${q.q}</p>${opts}`;
        document.querySelectorAll('.q-num-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nb-'+idx).classList.add('active');
        document.getElementById('subBtn').classList.toggle('hidden', idx !== stuQuiz.length-1);
    }

    function saveAns(idx, no) {
        const sel = Array.from(document.querySelectorAll('input[name="opt"]:checked')).map(e => e.value).sort().join('');
        myAnswers[idx] = sel;
        localStorage.setItem('ans_'+no, JSON.stringify(myAnswers));
        document.getElementById('nb-'+idx).classList.add('done');
        syncStu(no);
    }

    function syncStu(no) {
        const done = Object.values(myAnswers).filter(v => v !== "").length;
        const prog = Math.round((done / stuQuiz.length) * 100) + "%";
        if(window.activeConn && window.activeConn.open) {
            window.activeConn.send({type: 'sync', progress: prog, cheats: stuCheats, ans: myAnswers});
        }
    }

    function studentSubmit() {
        if(confirm("ç¢ºå®šç¹³äº¤å…¨å·ï¼Ÿ")) {
            window.activeConn.send({type: 'submit', ans: myAnswers});
        }
    }
</script>
</body>
</html>
