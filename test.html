<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina OS Elite | å°ˆæ¥­äº’å‹•æŒ‡æ®å®˜</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --p: #5856D6; --s: #34C759; --d: #FF3B30; --bg: #0A0A0C; --glass: rgba(255,255,255,0.08); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'SF Pro Display', system-ui, sans-serif; }
        body { background: var(--bg); color: #FFF; margin: 0; overflow: hidden; }

        /* èƒŒæ™¯æµå…‰ */
        .mesh-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 10% 20%, #1a1a2e 0%, #0a0a0c 100%); }
        
        .app { height: 100vh; display: flex; flex-direction: column; overflow-y: auto; }
        .glass { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 25px; transition: 0.3s; }

        /* é›»è…¦ç‰ˆ vs æ‰‹æ©Ÿç‰ˆ RWD æ ¸å¿ƒ */
        @media (min-width: 768px) {
            .desktop-row { display: grid; grid-template-columns: 1fr 380px; gap: 20px; padding: 20px; }
            .mobile-only { display: none !important; }
        }
        @media (max-width: 767px) {
            .desktop-row { display: block; padding: 10px; }
            .desktop-only { display: none !important; }
            .glass { border-radius: 16px; padding: 15px; margin-bottom: 10px; }
        }

        /* å€’æ•¸è¨ˆæ™‚å™¨æ¨£å¼ */
        #timer-display { font-size: 48px; font-weight: 800; font-family: monospace; color: var(--s); text-shadow: 0 0 15px var(--s); }
        .timer-warning { color: var(--d) !important; text-shadow: 0 0 15px var(--d) !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* é¸é …èˆ‡æŒ‰éˆ• */
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: var(--p); color: white; }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; }
        
        .option-card { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"], input[type="number"] { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: white; }

        /* å­¸ç”Ÿç«¯æŠ•ç¥¨å¤§æŒ‰éˆ• */
        .stu-vote-btn { width: 100%; padding: 20px; margin-bottom: 12px; border-radius: 18px; border: 2px solid transparent; background: rgba(255,255,255,0.05); color: white; font-size: 18px; text-align: left; transition: 0.3s; }
        .stu-vote-btn.active { border-color: var(--p); background: rgba(88,86,214,0.2); }
        .stu-vote-btn:disabled { opacity: 0.5; filter: grayscale(1); }

        .locked-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); border-radius: 18px; display: flex; align-items: center; justify-content: center; z-index: 10; font-weight: bold; }
        
        .hidden { display: none !important; }
        #qr-canvas { width: 100% !important; height: auto !important; border-radius: 15px; }
    </style>
</head>
<body>

<div class="mesh-bg"></div>

<div class="app">
    <header style="padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05);">
        <div style="font-size: 20px; font-weight: 900; letter-spacing: 2px;">LUMINA <span style="color:var(--p)">OS</span></div>
        <div id="connection-badge" class="btn" style="font-size: 12px; background: rgba(255,255,255,0.1); padding: 5px 12px;">SYSTEM IDLE</div>
    </header>

    <div id="v-start" class="animate__animated animate__fadeIn" style="flex: 1; display: flex; align-items: center; justify-content: center;">
        <div class="glass" style="text-align: center; max-width: 500px;">
            <h1 style="font-size: 42px; margin: 0;">å°ˆæ¥­èª²å ‚äº’å‹•</h1>
            <p style="color: #888; margin: 20px 0 40px;">è«‹é¸æ“‡æ‚¨çš„èº«ä»½ä»¥å•Ÿå‹•ç³»çµ±</p>
            <div style="display: grid; gap: 15px;">
                <button class="btn btn-p" onclick="initTeacher()" style="padding: 20px;">ğŸ‘¨â€ğŸ« é–‹å•Ÿè€å¸«æ§åˆ¶å° (é›»è…¦ç‰ˆ)</button>
                <button class="btn btn-outline" onclick="showView('v-stu-login')" style="padding: 20px;">ğŸ“± å­¸ç”ŸåŠ å…¥æŠ•ç¥¨ (æ‰‹æ©Ÿç‰ˆ)</button>
            </div>
        </div>
    </div>

    <div id="v-teacher" class="hidden animate__animated animate__fadeIn">
        <div class="desktop-row">
            <div>
                <div class="glass" style="margin-bottom: 20px;">
                    <h3>1. æŠ•ç¥¨é¡Œç›®èˆ‡æˆªæ­¢è¨­å®š</h3>
                    <input type="text" id="t-topic" placeholder="è«‹åœ¨æ­¤è¼¸å…¥å•é¡Œ..." style="width: 100%; font-size: 20px; margin-bottom: 15px;">
                    <div id="t-options-container"></div>
                    <button class="btn btn-outline" onclick="addOption()" style="margin-top: 10px;">+ æ–°å¢é¸é …</button>
                    
                    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">
                    
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div>
                            <span>è¨­å®šé™æ™‚ï¼š</span>
                            <input type="number" id="t-min" value="1" style="width: 60px; text-align: center;"> åˆ† 
                            <input type="number" id="t-sec" value="0" style="width: 60px; text-align: center;"> ç§’
                        </div>
                        <button class="btn btn-p" onclick="startVotingSession()">ğŸš€ ç™¼å¸ƒä¸¦é–‹å§‹è¨ˆæ™‚</button>
                    </div>
                </div>

                <div class="glass">
                    <div style="display: flex; justify-content: space-between;">
                        <h3>2. å³æ™‚æ•¸æ“šçµ±è¨ˆ</h3>
                        <div id="timer-display">01:00</div>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="t-chart"></canvas>
                    </div>
                </div>
            </div>

            <div>
                <div class="glass" style="text-align: center;">
                    <h2 id="t-room-id" style="font-size: 48px; color: var(--p); margin: 0;">----</h2>
                    <p style="color: #888;">å­¸ç”Ÿæƒç¢¼é€²å…¥</p>
                    <canvas id="qr-canvas"></canvas>
                    <div style="display: grid; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-outline" onclick="resetVotes()">æ¸…ç©ºç¥¨æ•¸</button>
                        <button class="btn" style="background: white; color: black;" onclick="forceEnd()">æ‰‹å‹•æå‰çµæŸ</button>
                    </div>
                </div>
                <div class="glass" style="margin-top: 20px;">
                    <h4>é€£ç·šç‹€æ…‹</h4>
                    <p>åœ¨ç·šäººæ•¸ï¼š<span id="t-online">0</span></p>
                    <p>å·²æŠ•äººæ•¸ï¼š<span id="t-voted">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="v-stu-login" class="hidden">
        <div class="glass" style="max-width: 350px; margin: 80px auto; text-align: center;">
            <h2>è¼¸å…¥æˆ¿è™Ÿ</h2>
            <input type="text" id="s-input-id" style="width: 100%; font-size: 40px; text-align: center; letter-spacing: 5px;">
            <button class="btn btn-p" style="width: 100%; margin-top: 20px; padding: 15px;" onclick="initStudent()">é€²å…¥æŠ•ç¥¨ç³»çµ±</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div style="padding: 15px;">
            <div class="glass" style="margin-bottom: 15px; text-align: center; position: relative;">
                <div id="s-timer" style="font-size: 24px; font-weight: bold; color: var(--s);">å€’æ•¸è¨ˆæ™‚ä¸­...</div>
                <div id="s-status-tag" style="font-size: 12px; color: #888;">ç­‰å¾…è€å¸«ç™¼èµ·æŠ•ç¥¨</div>
            </div>
            
            <div class="glass">
                <h1 id="s-topic-display" style="font-size: 22px; margin-top: 0;">é¡Œç›®è¼‰å…¥ä¸­...</h1>
                <div id="s-options-area" style="position: relative;">
                    </div>
            </div>
        </div>
    </div>
</div>

<div id="final-report" class="hidden animate__animated animate__zoomIn" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; padding: 40px; overflow-y: auto;">
    <div style="text-align: center; max-width: 800px; margin: auto;">
        <h1 style="font-size: 60px; color: var(--s);">æŠ•ç¥¨çµæŸ</h1>
        <div id="winner-box" class="glass" style="padding: 40px; margin: 40px 0; border: 2px solid var(--p);">
            <p style="font-size: 24px;">ç²å¾—æœ€é«˜ç¥¨é¸é …</p>
            <h2 id="winner-name" style="font-size: 80px; margin: 10px 0; color: var(--p);">é¸é …åç¨±</h2>
            <p id="winner-stats" style="font-size: 24px; color: #888;">-- ç¥¨</p>
        </div>
        <button class="btn btn-outline" onclick="document.getElementById('final-report').classList.add('hidden')">è¿”å›å„€è¡¨æ¿</button>
    </div>
</div>

<script>
    let peer, conn, role, myChart, timerInt;
    let options = ["é¸é … A", "é¸é … B", "é¸é … C"];
    let votes = {};
    let voterMap = new Map();
    let isLocked = false;
    const STUN = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };

    function showView(id) {
        document.querySelectorAll('.app > div').forEach(d => { if(d.id.startsWith('v-')) d.classList.add('hidden'); });
        document.getElementById(id).classList.remove('hidden');
    }

    // --- è€å¸«ç«¯é‚è¼¯ ---
    function initTeacher() {
        role = 'teacher';
        const rid = Math.floor(1000 + Math.random() * 8999).toString();
        peer = new Peer('LUMINA-' + rid, { config: STUN });

        peer.on('open', id => {
            showView('v-teacher');
            document.getElementById('t-room-id').innerText = rid;
            document.getElementById('connection-badge').innerText = "ONLINE | ROOM: " + rid;
            QRCode.toCanvas(document.getElementById('qr-canvas'), window.location.href.split('?')[0] + '?r=' + rid);
            renderTeacherOptions();
            initChart();
            
            setInterval(() => {
                document.getElementById('t-online').innerText = Object.keys(peer.connections).length;
                broadcastStatus();
            }, 1000);
        });

        peer.on('connection', c => {
            c.on('data', d => {
                if(d.type === 'vote' && !isLocked) {
                    if(voterMap.has(c.peer)) votes[voterMap.get(c.peer)]--;
                    voterMap.set(c.peer, d.val);
                    votes[d.val] = (votes[d.val] || 0) + 1;
                    updateChart();
                }
            });
        });
    }

    function renderTeacherOptions() {
        const container = document.getElementById('t-options-container');
        container.innerHTML = options.map((opt, i) => `
            <div class="option-card">
                <input type="text" value="${opt}" oninput="options[${i}]=this.value" style="flex:1">
                <button class="btn btn-outline" onclick="options.splice(${i},1); renderTeacherOptions()">âœ•</button>
            </div>
        `).join('');
    }

    function addOption() { options.push("æ–°é¸é … " + (options.length+1)); renderTeacherOptions(); }

    function initChart() {
        const ctx = document.getElementById('t-chart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: options, datasets: [{ data: [], backgroundColor: '#5856D6', borderRadius: 8 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function updateChart() {
        myChart.data.labels = options;
        myChart.data.datasets[0].data = options.map(o => votes[o] || 0);
        myChart.update();
        document.getElementById('t-voted').innerText = voterMap.size;
    }

    // --- å€’æ•¸è¨ˆæ™‚ç³»çµ± ---
    function startVotingSession() {
        isLocked = false;
        voterMap.clear();
        options.forEach(o => votes[o] = 0);
        updateChart();

        let duration = (parseInt(document.getElementById('t-min').value) * 60) + parseInt(document.getElementById('t-sec').value);
        if(timerInt) clearInterval(timerInt);
        
        timerInt = setInterval(() => {
            duration--;
            updateTimerUI(duration);
            if(duration <= 0) {
                clearInterval(timerInt);
                forceEnd();
            }
        }, 1000);
        alert("æŠ•ç¥¨å·²ç™¼å¸ƒï¼");
    }

    function updateTimerUI(sec) {
        let m = Math.floor(sec/60).toString().padStart(2, '0');
        let s = (sec%60).toString().padStart(2, '0');
        const display = document.getElementById('timer-display');
        display.innerText = `${m}:${s}`;
        if(sec <= 10) display.classList.add('timer-warning');
        else display.classList.remove('timer-warning');
    }

    function forceEnd() {
        isLocked = true;
        clearInterval(timerInt);
        document.getElementById('timer-display').innerText = "00:00";
        showFinalReport();
    }

    function showFinalReport() {
        let max = -1, winner = "ç„¡äººæŠ•ç¥¨";
        for(let o in votes) { if(votes[o] > max) { max = votes[o]; winner = o; } }
        document.getElementById('winner-name').innerText = winner;
        document.getElementById('winner-stats').innerText = (votes[winner] || 0) + " ç¥¨";
        document.getElementById('final-report').classList.remove('hidden');
    }

    function broadcastStatus() {
        const msg = {
            type: 'sync',
            topic: document.getElementById('t-topic').value || "å³æ™‚æŠ•ç¥¨ä¸­",
            options: options,
            isLocked: isLocked,
            timeLeft: document.getElementById('timer-display').innerText
        };
        Object.values(peer.connections).forEach(conns => conns.forEach(c => { if(c.open) c.send(msg); }));
    }

    // --- å­¸ç”Ÿç«¯ (æ‰‹æ©Ÿå„ªåŒ–) ---
    let s_conn, lastSelected = "";
    function initStudent() {
        role = 'student';
        const rid = document.getElementById('s-input-id').value || new URLSearchParams(window.location.search).get('r');
        if(!rid) return;
        showView('v-student');
        peer = new Peer({ config: STUN });
        peer.on('open', () => {
            connectToTeacher(rid);
            setInterval(() => { if(!s_conn || !s_conn.open) connectToTeacher(rid); }, 3000);
        });
    }

    function connectToTeacher(rid) {
        s_conn = peer.connect('LUMINA-' + rid, { reliable: true });
        s_conn.on('data', d => {
            if(d.type === 'sync') {
                document.getElementById('s-topic-display').innerText = d.topic;
                document.getElementById('s-timer').innerText = "å‰©é¤˜æ™‚é–“ " + d.timeLeft;
                renderStudentUI(d.options, d.isLocked);
                if(d.timeLeft === "00:00") document.getElementById('s-timer').classList.add('timer-warning');
            }
        });
    }

    function renderStudentUI(opts, locked) {
        const area = document.getElementById('s-options-area');
        let html = opts.map(o => `
            <button class="stu-vote-btn ${lastSelected===o?'active':''}" 
                    ${locked?'disabled':''} onclick="submitVote('${o}')">
                ${o}
            </button>
        `).join('');
        if(locked) html += `<div class="locked-overlay">ğŸ”’ æŠ•ç¥¨å·²æˆªæ­¢</div>`;
        area.innerHTML = html;
        document.getElementById('s-status-tag').innerText = locked ? "æŠ•ç¥¨å·²é–å®š" : "é€£ç·šæ­£å¸¸ | å¯éš¨æ™‚ä¿®æ”¹";
    }

    function submitVote(val) {
        lastSelected = val;
        s_conn.send({ type: 'vote', val: val });
        if(window.navigator.vibrate) window.navigator.vibrate(50);
    }

    window.onload = () => {
        const r = new URLSearchParams(window.location.search).get('r');
        if(r) { document.getElementById('s-input-id').value = r; showView('v-stu-login'); }
    };
</script>
</body>
</html>
