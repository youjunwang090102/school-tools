<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´š P2P å¿«é–ƒè€ƒè©¦ç³»çµ±</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --p: #007AFF; --bg: #f5f5f7; }
        body { font-family: system-ui; background: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 600px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .status { padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; }
        .online { background: #e1f5fe; color: #01579b; }
        #timer { font-size: 32px; color: #ff3b30; text-align: center; margin: 10px 0; }
        .hidden { display: none; }
        .student-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; }
        button { width: 100%; padding: 12px; background: var(--p); color: white; border: none; border-radius: 12px; cursor: pointer; margin-top: 10px; }
        .q-card { background: #fafafa; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="card">
    <div id="modeSelect">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        <button onclick="initTeacher()">æˆ‘æ˜¯è€å¸« (ç™¼é€è€ƒå·)</button>
        <button style="background:#5856d6" onclick="showStudentLogin()">æˆ‘æ˜¯å­¸ç”Ÿ (é–‹å§‹ä½œç­”)</button>
    </div>

    <div id="teacherArea" class="hidden">
        <h2>ğŸ‘¨â€ğŸ« è€å¸«æ§åˆ¶å°</h2>
        <div class="status online">æˆ¿é–“ ID: <span id="roomId">å»ºç«‹ä¸­...</span></div>
        <textarea id="quizInput" style="width:100%; height:80px;" placeholder="é¡Œç›®,A,B,C,D,Ans (æ¯è¡Œä¸€é¡Œ)"></textarea>
        <button onclick="broadcastExam()">1. ç™¼é€è€ƒå·çµ¦æ‰€æœ‰å­¸ç”Ÿ</button>
        <button style="background:#ff9500" onclick="forceSubmit()">2. å¼·åˆ¶æ”¶å·</button>
        
        <h3>ğŸ“Š å­¸ç”Ÿé€²åº¦ (<span id="stuCount">0</span>)</h3>
        <div id="monitor"></div>
        <button style="background:#34c759" onclick="exportData()">3. åŒ¯å‡ºæˆç¸¾ (Excel)</button>
    </div>

    <div id="studentArea" class="hidden">
        <h2 id="stuHeader">ç­‰å¾…è€å¸«ç™¼å·...</h2>
        <div id="timer">--:--</div>
        <div id="quizContent"></div>
        <button id="manualSubmit" class="hidden" onclick="studentSubmit()">æ‰‹å‹•ç¹³äº¤</button>
    </div>
</div>

<script>
    let peer, conn;
    let connections = {}; // è€å¸«å­˜å„²æ‰€æœ‰å­¸ç”Ÿçš„é€£ç·š
    let studentData = {}; // è€å¸«å­˜å„²æˆç¸¾
    let myExam = [];

    // --- è€å¸«ç«¯é‚è¼¯ ---
    function initTeacher() {
        document.getElementById('modeSelect').classList.add('hidden');
        document.getElementById('teacherArea').classList.remove('hidden');
        
        peer = new Peer(); // éš¨æ©Ÿç”¢ç”Ÿ ID
        peer.on('open', id => { document.getElementById('roomId').innerText = id; });
        
        peer.on('connection', c => {
            const stuNo = c.metadata.no;
            connections[stuNo] = c;
            studentData[stuNo] = { no: stuNo, score: 0, status: "å·²é€£ç·š", progress: "0%" };
            updateMonitor();

            c.on('data', data => {
                if (data.type === 'update') {
                    studentData[stuNo].progress = data.progress;
                    updateMonitor();
                }
                if (data.type === 'submit') {
                    studentData[stuNo].score = data.score;
                    studentData[stuNo].status = "å·²ç¹³äº¤";
                    updateMonitor();
                }
            });
        });
    }

    function broadcastExam() {
        const input = document.getElementById('quizInput').value;
        Object.values(connections).forEach(c => {
            c.send({ type: 'exam', quiz: input });
        });
        alert("è€ƒå·å·²ç™¼é€åˆ°æ‰€æœ‰é€£ç·šçš„æ‰‹æ©Ÿï¼");
    }

    function forceSubmit() {
        Object.values(connections).forEach(c => c.send({ type: 'force' }));
    }

    function updateMonitor() {
        const div = document.getElementById('monitor');
        const list = Object.values(studentData);
        document.getElementById('stuCount').innerText = list.length;
        div.innerHTML = list.map(s => `
            <div class="student-row">
                <span>åº§è™Ÿ ${s.no}</span>
                <span>é€²åº¦: ${s.progress}</span>
                <span>ç‹€æ…‹: ${s.status}</span>
                <b>${s.score}åˆ†</b>
            </div>
        `).join('');
    }

    // --- å­¸ç”Ÿç«¯é‚è¼¯ ---
    function showStudentLogin() {
        const id = prompt("è«‹è¼¸å…¥è€å¸«çš„æˆ¿é–“ ID:");
        const no = prompt("è«‹è¼¸å…¥æ‚¨çš„åº§è™Ÿ:");
        if (!id || !no) return;

        document.getElementById('modeSelect').classList.add('hidden');
        document.getElementById('studentArea').classList.remove('hidden');

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id, { metadata: { no: no } });
            conn.on('data', data => {
                if (data.type === 'exam') startStudentExam(data.quiz);
                if (data.type === 'force') studentSubmit();
            });
        });
    }

    function startStudentExam(quizText) {
        document.getElementById('stuHeader').innerText = "æ¸¬é©—é€²è¡Œä¸­";
        document.getElementById('manualSubmit').classList.remove('hidden');
        const lines = quizText.trim().split('\n');
        myExam = lines.map(line => {
            const p = line.split(',');
            return { q: p[0], options: p.slice(1,5), ans: p[5].trim() };
        });

        let html = '';
        myExam.forEach((q, i) => {
            html += `<div class="q-card"><p>${i+1}. ${q.q}</p>`;
            q.options.forEach((opt, j) => {
                const val = String.fromCharCode(65 + j);
                html += `<label><input type="radio" name="q${i}" value="${val}" onchange="sendProgress()"> ${opt}</label><br>`;
            });
            html += `</div>`;
        });
        document.getElementById('quizContent').innerHTML = html;
    }

    function sendProgress() {
        const answered = document.querySelectorAll('input:checked').length;
        const prog = Math.round((answered / myExam.length) * 100) + "%";
        conn.send({ type: 'update', progress: prog });
    }

    function studentSubmit() {
        let score = 0;
        myExam.forEach((q, i) => {
            const sel = document.querySelector(`input[name="q${i}"]:checked`);
            if (sel && sel.value === q.ans) score += (100 / myExam.length);
        });
        conn.send({ type: 'submit', score: Math.round(score) });
        document.getElementById('studentArea').innerHTML = "<h2>ç¹³äº¤æˆåŠŸï¼</h2>";
    }

    function exportData() {
        const ws = XLSX.utils.json_to_sheet(Object.values(studentData));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾");
        XLSX.writeFile(wb, "è€ƒè©¦çµæœ.xlsx");
    }
</script>
</body>
</html>
