<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Pro | å°ˆæ¥­è€ƒè©•ç³»çµ±</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; --bg: #F5F5F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #1D1D1F; user-select: none; }
        .app { max-width: 900px; margin: auto; padding: 20px; }
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #FFF; }
        .hidden { display: none !important; }
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; margin: 5px; }
        .btn-p { background: var(--p); color: #FFF; }
        .btn-s { background: var(--s); color: #FFF; }
        .btn-d { background: var(--d); color: #FFF; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #FFF; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-val { font-size: 28px; font-weight: bold; color: var(--p); }

        .q-card { background: #FFF; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--p); }
        .lock-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; backdrop-filter: blur(8px); flex-direction: column; }
        
        table { width: 100%; border-collapse: collapse; background: #FFF; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid #EEE; text-align: center; }
        textarea { width: 100%; height: 100px; border-radius: 10px; border: 1px solid #DDD; padding: 10px; box-sizing: border-box; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="app">
    <div id="v-start" class="glass" style="text-align:center; margin-top:100px;">
        <h1 style="font-size:48px; margin-bottom:10px;">Lumina Pro</h1>
        <p style="color:#666;">å°ˆæ¥­ P2P å³æ™‚è€ƒè©•å·¥å…·</p>
        <button class="btn btn-p" onclick="initTeacher()">æ•™å¸«ä¸»æ§ç«¯</button>
        <button class="btn" style="background:#8E8E93; color:white;" onclick="initStudent()">å­¸ç”Ÿä½œç­”ç«¯</button>
    </div>

    <div id="v-teacher" class="hidden">
        <div class="glass">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ğŸ‘¨â€ğŸ« æ•™å¸«æ§åˆ¶å°</h2>
                <div id="roomTag" style="background:#000; color:#FFF; padding:8px 20px; border-radius:10px; font-family:monospace; font-size:20px;">ID: ----</div>
            </div>
            
            <div class="stat-grid">
                <div class="stat-card"><div>é€£ç·š</div><div class="stat-val" id="s-conn">0</div></div>
                <div class="stat-card"><div>å·²ç¹³</div><div class="stat-val" id="s-sub">0</div></div>
                <div class="stat-card"><div>å¹³å‡</div><div class="stat-val" id="s-avg">0</div></div>
                <div class="stat-card"><div>åŠæ ¼%</div><div class="stat-val" id="s-pass">0</div></div>
            </div>

            <div style="display:flex; flex-wrap:wrap; justify-content: center;">
                <button class="btn btn-p" onclick="toggleExamConfig()">ğŸ“ è¨­å®š/åŒ¯å…¥é¡Œç›®</button>
                <button id="lockBtn" class="btn btn-d" onclick="toggleLock()">ğŸ”’ é–å®šå­¸ç”Ÿç«¯</button>
                <button class="btn btn-s" onclick="broadcastExam()">ğŸš€ ç™¼é€è€ƒå·ä¸¦é–‹å§‹</button>
            </div>
        </div>

        <div id="examConfig" class="glass hidden">
            <h3>é¡Œç›®ç·¨è¼¯å™¨</h3>
            <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <button class="btn" onclick="showInputMode('manual')">æ‰‹å‹•ç·šä¸Šè¼¸å…¥</button>
                <button class="btn" onclick="showInputMode('excel')">Excel æª”æ¡ˆåŒ¯å…¥</button>
            </div>
            <div id="inputMode">
                <p style="font-size:12px; color:#666;">æ ¼å¼ï¼šé¡Œç›®,A,B,C,D,E,æ­£ç¢ºç­”æ¡ˆ(å¦‚AB),é…åˆ†</p>
                <textarea id="manualInput" placeholder="ç¯„ä¾‹ï¼š1+1ç­‰æ–¼?,1,2,3,4,5,B,50"></textarea>
                <button class="btn btn-p" style="margin-top:10px;" onclick="parseManual()">ç¢ºèªè½‰æ›é¡Œç›®</button>
            </div>
            <div id="excelMode" class="hidden">
                <button class="btn btn-outline" style="border:1px solid #ccc;" onclick="downloadSample()">ğŸ“¥ ä¸‹è¼‰ Excel ç¯„æœ¬</button>
                <input type="file" id="fileInput" accept=".xlsx" onchange="importExcel(this)" style="margin-top:10px;">
            </div>
            <div id="qCountText" style="margin-top:10px; color:var(--p); font-weight:bold;"></div>
        </div>

        <div class="glass">
            <h3>ğŸ“Š ç­ç´šå³æ™‚é€²åº¦</h3>
            <table>
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>ç¸½åˆ†</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
            <button class="btn btn-s" style="width:100%; margin-top:15px;" onclick="exportFinal()">ğŸ’¾ ä¸‹è¼‰çµç®—æˆç¸¾å–® (Excel)</button>
        </div>
    </div>

    <div id="v-student" class="hidden">
        <div id="examLock" class="lock-mask hidden">
            <div style="font-size:60px; margin-bottom:20px;">ğŸ”’</div>
            <div>è€å¸«å·²æš«åœä½œç­”ï¼Œè«‹è½è¬›</div>
        </div>
        <div class="glass" style="text-align:center;">
            <h2 id="stuTitle">ç­‰å¾…è€å¸«ç™¼é€è€ƒå·...</h2>
            <div id="stuMeta" style="color:#666; font-size:14px;">å°šæœªé€£ç·š</div>
        </div>
        <div id="quizArea"></div>
        <button id="subBtn" class="btn btn-p hidden" style="width:100%; padding:20px; font-size:20px;" onclick="studentSubmit()">ç¢ºèªç¹³äº¤è€ƒå·</button>
    </div>

    <div id="v-result" class="hidden glass" style="text-align:center; margin-top:100px;">
        <h1 style="color:var(--s); font-size:40px;">å·²æˆåŠŸç¹³äº¤</h1>
        <div style="font-size:100px; font-weight:bold; margin:20px 0;" id="resScore">0</div>
        <p style="font-size:20px; color:#666;">ä½ çš„å¾—åˆ†</p>
        <button class="btn btn-p" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
    </div>
</div>

<script>
    let peer, conn, myRoomId, isLocked = false;
    let connections = {};
    let studentData = {};
    let masterQuiz = [];
    let myNo = "";

    // --- æ•™å¸«ç«¯é‚è¼¯ ---
    function initTeacher() {
        showView('v-teacher');
        myRoomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        peer = new Peer(myRoomId);
        peer.on('open', id => { 
            document.getElementById('roomTag').innerText = "ID: " + id;
        });
        peer.on('connection', c => {
            const no = c.metadata.no;
            connections[no] = c;
            if(!studentData[no]) studentData[no] = { no: no, progress: "0%", score: 0, ans: {}, qScore: {}, status: "å·²é€£ç·š", cheats: 0 };
            updateMonitor();
            
            // å­¸ç”Ÿé€£ç·šæ™‚ï¼Œç«‹åˆ»åŒæ­¥ç›®å‰çš„é–å®šç‹€æ…‹
            setTimeout(() => { c.send({ type: 'lock', state: isLocked }); }, 1000);

            c.on('data', data => handleStudentData(no, data));
            c.on('close', () => { studentData[no].status = "æ–·ç·š"; updateMonitor(); });
        });
    }

    function handleStudentData(no, data) {
        if (data.type === 'sync') {
            studentData[no].progress = data.progress;
            studentData[no].cheats = data.cheats;
            updateMonitor();
        }
        if (data.type === 'submit') {
            let total = 0, perQ = {};
            masterQuiz.forEach((q, i) => {
                if (data.userAns[i] === q.ans) { total += q.point; perQ[i] = q.point; }
                else perQ[i] = 0;
            });
            studentData[no].score = Math.round(total);
            studentData[no].ans = data.userAns;
            studentData[no].qScore = perQ;
            studentData[no].status = "âœ… å·²ç¹³";
            if(connections[no]) connections[no].send({ type: 'report', score: Math.round(total) });
            updateMonitor();
        }
    }

    function updateMonitor() {
        const list = Object.values(studentData);
        document.getElementById('s-conn').innerText = list.length;
        const subList = list.filter(s => s.status === "âœ… å·²ç¹³");
        document.getElementById('s-sub').innerText = subList.length;
        
        let sum = 0, pass = 0;
        document.getElementById('monitorBody').innerHTML = list.map(s => {
            sum += s.score;
            if(s.score >= 60) pass++;
            const cTxt = s.cheats > 0 ? `<div style="color:red; font-size:11px; font-weight:bold;">é›¢é è­¦å‘Š ${s.cheats} æ¬¡</div>` : "";
            return `<tr><td>${s.no}</td><td>${s.progress}${cTxt}</td><td>${s.score}</td><td>${s.status}</td></tr>`;
        }).join('');
        
        document.getElementById('s-avg').innerText = subList.length ? (sum / subList.length).toFixed(1) : 0;
        document.getElementById('s-pass').innerText = subList.length ? Math.round((pass/subList.length)*100) + "%" : "0%";
    }

    function broadcastExam() {
        if(!masterQuiz.length) return alert("è«‹å…ˆåœ¨ã€è¨­å®šé¡Œç›®ã€ä¸­åŒ¯å…¥æˆ–è¼¸å…¥è€ƒé¡Œï¼");
        // ç™¼é€å‰å…ˆè§£é™¤é–å®šï¼Œç¢ºä¿å­¸ç”Ÿèƒ½å¯«
        if(isLocked) toggleLock(); 
        const safeQuiz = masterQuiz.map(({ans, ...rest}) => rest);
        Object.values(connections).forEach(c => c.send({ type: 'exam', quiz: safeQuiz }));
        alert("è€ƒå·ç™¼é€æˆåŠŸï¼å­¸ç”Ÿç«¯æ‡‰å·²é¡¯ç¤ºé¡Œç›®ã€‚");
    }

    function toggleLock() {
        isLocked = !isLocked;
        document.getElementById('lockBtn').innerText = isLocked ? "ğŸ”“ è§£é™¤é–å®š" : "ğŸ”’ é–å®šå­¸ç”Ÿç«¯";
        document.getElementById('lockBtn').className = isLocked ? "btn btn-s" : "btn btn-d";
        Object.values(connections).forEach(c => c.send({ type: 'lock', state: isLocked }));
    }

    function showInputMode(m) {
        document.getElementById('inputMode').classList.toggle('hidden', m !== 'manual');
        document.getElementById('excelMode').classList.toggle('hidden', m !== 'excel');
    }

    function parseManual() {
        const text = document.getElementById('manualInput').value.trim();
        if(!text) return alert("è«‹è¼¸å…¥å…§å®¹");
        masterQuiz = text.split('\n').map(line => {
            const p = line.split(',');
            return { 
                q: p[0], 
                opts: {A:p[1], B:p[2], C:p[3], D:p[4], E:p[5]}, 
                ans: String(p[6]||"").toUpperCase().split('').sort().join(''), 
                point: Number(p[7]||0) 
            };
        });
        document.getElementById('qCountText').innerText = `âœ… æˆåŠŸè¼‰å…¥ ${masterQuiz.length} é¡Œ`;
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            masterQuiz = data.map(r => ({
                q: r.é¡Œç›®, 
                opts: {A:r.é¸é …A, B:r.é¸é …B, C:r.é¸é …C, D:r.é¸é …D, E:r.é¸é …E},
                ans: String(r.æ­£ç¢ºç­”æ¡ˆ || "").toUpperCase().split('').sort().join(''), 
                point: Number(r.é…åˆ† || 0)
            }));
            document.getElementById('qCountText').innerText = `âœ… Excel åŒ¯å…¥æˆåŠŸ: ${masterQuiz.length} é¡Œ`;
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    // --- å­¸ç”Ÿç«¯é‚è¼¯ ---
    let cheats = 0, currentQuiz = [];
    function initStudent() {
        const id = (new URLSearchParams(window.location.search)).get('room') || prompt("è«‹è¼¸å…¥è€å¸«çš„ 4 ä½æˆ¿é–“ ID:");
        myNo = prompt("è«‹è¼¸å…¥æ‚¨çš„åº§è™Ÿ:");
        if(!id || !myNo) return;
        showView('v-student');
        document.getElementById('stuMeta').innerText = `åº§è™Ÿ: ${myNo} | æ­£åœ¨é€£ç·šè‡³æˆ¿é–“ ${id}...`;
        
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id.toUpperCase(), { metadata: { no: myNo } });
            conn.on('open', () => { document.getElementById('stuMeta').innerText = `åº§è™Ÿ: ${myNo} | é€£ç·šæˆåŠŸ`; });
            conn.on('data', data => {
                if(data.type === 'exam') renderExam(data.quiz);
                if(data.type === 'lock') document.getElementById('examLock').classList.toggle('hidden', !data.state);
                if(data.type === 'report') {
                    localStorage.removeItem('lumina_ans_'+myNo);
                    showView('v-result');
                    document.getElementById('resScore').innerText = data.score;
                }
            });
        });

        document.addEventListener('visibilitychange', () => {
            if(document.visibilityState === 'hidden') {
                cheats++;
                syncProgress();
            }
        });
    }

    function renderExam(quiz) {
        currentQuiz = quiz;
        document.getElementById('stuTitle').innerText = "æ¸¬é©—é€²è¡Œä¸­";
        document.getElementById('subBtn').classList.remove('hidden');
        const saved = JSON.parse(localStorage.getItem('lumina_ans_'+myNo) || "{}");
        
        let html = '';
        quiz.forEach((q, i) => {
            html += `<div class="q-card"><b>${i+1}. ${q.q} (${q.point}åˆ†)</b><br>`;
            Object.entries(q.opts).forEach(([k, v]) => {
                if(!v || v === "undefined") return;
                const checked = (saved[i] || "").includes(k) ? "checked" : "";
                html += `<label style="display:block;margin:12px 0;padding:10px;background:#f9f9f9;border-radius:8px;"><input type="checkbox" name="q${i}" value="${k}" ${checked} onchange="saveAndSync()"> ${k}. ${v}</label>`;
            });
            html += `</div>`;
        });
        document.getElementById('quizArea').innerHTML = html;
        syncProgress();
    }

    function saveAndSync() {
        let ans = {};
        currentQuiz.forEach((_, i) => {
            ans[i] = Array.from(document.querySelectorAll(`input[name="q${i}"]:checked`)).map(el => el.value).sort().join('');
        });
        localStorage.setItem('lumina_ans_'+myNo, JSON.stringify(ans));
        syncProgress();
    }

    function syncProgress() {
        const saved = JSON.parse(localStorage.getItem('lumina_ans_'+myNo) || "{}");
        const done = Object.values(saved).filter(v => v !== "").length;
        if(conn && conn.open) {
            conn.send({ type: 'sync', progress: Math.round((done/currentQuiz.length)*100)+"%", cheats: cheats });
        }
    }

    function studentSubmit() {
        if(!confirm("ç¢ºå®šè¦äº¤å·å—ï¼Ÿç¹³äº¤å¾Œå°‡ç„¡æ³•ä¿®æ”¹ã€‚")) return;
        const ans = JSON.parse(localStorage.getItem('lumina_ans_'+myNo) || "{}");
        conn.send({ type: 'submit', userAns: ans });
    }

    // --- é€šç”¨å·¥å…· ---
    function showView(id) {
        ['v-start','v-teacher','v-student','v-result'].forEach(x => document.getElementById(x).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function toggleExamConfig() { document.getElementById('examConfig').classList.toggle('hidden'); }
    function downloadSample() {
        const data = [["é¡Œç›®","é¸é …A","é¸é …B","é¸é …C","é¸é …D","é¸é …E","æ­£ç¢ºç­”æ¡ˆ","é…åˆ†"],["ç¯„ä¾‹ï¼šå°ç£æœ€é«˜çš„å±±ï¼Ÿ","ç‰å±±","é›ªå±±","å¤§éœ¸å°–å±±","","","A",100]];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "è€ƒé¡Œç¯„æœ¬");
        XLSX.writeFile(wb, "Lumina_Excelç¯„æœ¬.xlsx");
    }
    function exportFinal() {
        const list = Object.values(studentData).map(s => {
            let row = { "åº§è™Ÿ": s.no, "å¾—åˆ†": s.score, "é›¢é æ¬¡æ•¸": s.cheats, "ç‹€æ…‹": s.status };
            masterQuiz.forEach((_, i) => row[`Q${i+1}å›ç­”`] = s.ans[i] || "");
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(list);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾çµç®—");
        XLSX.writeFile(wb, `æˆç¸¾å–®_${new Date().getTime()}.xlsx`);
    }
</script>
</body>
</html>
