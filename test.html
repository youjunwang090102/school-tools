<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ˆæ¥­ç´š P2P é›²ç«¯è€ƒè©¦ç³»çµ±</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #007AFF; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 700px; background: white; min-height: 100vh; padding: 25px; box-sizing: border-box; }
        .hidden { display: none; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px 0; transition: 0.2s; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: #34C759; color: white; }
        .btn-o { background: #FF9500; color: white; }
        .card { background: #F9F9F9; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #EEE; }
        #timer { font-size: 32px; font-weight: bold; color: #FF3B30; text-align: center; }
        .id-badge { font-family: monospace; font-size: 24px; background: #E5E5EA; padding: 5px 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #DDD; padding: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="app">
    <div id="modeSelect">
        <h1 style="text-align:center">ğŸ“ å°ˆæ¥­è€ƒè©¦ç³»çµ±</h1>
        <button class="btn btn-p" onclick="initTeacher()">é€²å…¥è€å¸«å‡ºé¡Œæ¨¡å¼</button>
        <button class="btn btn-s" onclick="showStudentLogin()">é€²å…¥å­¸ç”Ÿä½œç­”æ¨¡å¼</button>
    </div>

    <div id="teacherArea" class="hidden">
        <h2>ğŸ‘¨â€ğŸ« è€å¸«æ§åˆ¶å°</h2>
        <div class="card" style="text-align:center">
            <div>æˆ¿é–“ IDï¼š<span class="id-badge" id="roomId">å»ºç«‹ä¸­...</span></div>
            <canvas id="roomQR" style="margin:10px auto;"></canvas>
            <p style="font-size:12px; color:gray;">è«‹å­¸ç”ŸæƒæäºŒç¶­ç¢¼é€£ç·š</p>
        </div>

        <div class="card">
            <h3>1. åŒ¯å…¥è€ƒé¡Œ (Excel)</h3>
            <button class="btn" style="background:#8E8E93" onclick="downloadSample()">ä¸‹è¼‰ Excel ç¯„ä¾‹æª”</button>
            <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="importExcel(this)">
            <p id="qStatus" style="color:blue; font-size:13px;"></p>
        </div>

        <button class="btn btn-p" onclick="broadcastExam()">2. ç™¼é€è€ƒå·</button>
        <button class="btn btn-o" onclick="forceSubmit()">3. å…¨é«”å¼·åˆ¶æ”¶å·</button>

        <h3>ğŸ“Š å­¸ç”Ÿå¯¦æ™‚é€²åº¦ (<span id="stuCount">0</span>)</h3>
        <div style="overflow-x:auto">
            <table id="monitorTable">
                <thead><tr><th>åº§è™Ÿ</th><th>é€²åº¦</th><th>å¾—åˆ†</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="monitorBody"></tbody>
            </table>
        </div>
        <button class="btn btn-s" onclick="exportFinal()">4. åŒ¯å‡ºå®Œæ•´ Excel æˆç¸¾å–®</button>
    </div>

    <div id="studentArea" class="hidden">
        <div id="stuStatus" class="card" style="text-align:center">ç­‰å¾…è€å¸«ç™¼å·...</div>
        <div id="timer">--:--</div>
        <div id="quizContent"></div>
        <button id="stuSubmitBtn" class="btn btn-p hidden" onclick="studentSubmit()">ç¹³äº¤è©¦å·</button>
    </div>
</div>

<script>
    let peer, conn, myRoomId;
    let connections = {};
    let studentData = {};
    let currentQuiz = [];

    // --- 1. è€å¸«åŠŸèƒ½ ---
    function initTeacher() {
        document.getElementById('modeSelect').classList.add('hidden');
        document.getElementById('teacherArea').classList.remove('hidden');
        
        // ç”Ÿæˆç°¡çŸ­ 4 ä½ ID
        myRoomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        peer = new Peer(myRoomId);
        
        peer.on('open', id => {
            document.getElementById('roomId').innerText = id;
            // ç”ŸæˆäºŒç¶­ç¢¼
            const joinUrl = window.location.href.split('?')[0] + '?room=' + id;
            QRCode.toCanvas(document.getElementById('roomQR'), joinUrl, { width: 180 });
        });

        peer.on('connection', c => {
            const stuNo = c.metadata.no;
            connections[stuNo] = c;
            studentData[stuNo] = { no: stuNo, progress: "0%", score: 0, answers: {}, scoresPerQ: {}, status: "å·²é€£ç·š" };
            updateMonitor();

            c.on('data', data => {
                if (data.type === 'update') {
                    studentData[stuNo].progress = data.progress;
                    updateMonitor();
                }
                if (data.type === 'submit') {
                    studentData[stuNo].score = data.score;
                    studentData[stuNo].answers = data.answers;
                    studentData[stuNo].scoresPerQ = data.scoresPerQ;
                    studentData[stuNo].status = "å·²ç¹³äº¤";
                    updateMonitor();
                }
            });
        });
    }

    function downloadSample() {
        const data = [["é¡Œç›®", "é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D", "é¸é …E", "æ­£ç¢ºç­”æ¡ˆ", "é…åˆ†"], ["1+1=?", "1", "2", "3", "", "", "B", "50"], ["å“ªäº›æ˜¯æ°´æœ?", "è˜‹æœ", "çŸ³é ­", "é¦™è•‰", "é£›æ©Ÿ", "", "AC", "50"]];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç¯„ä¾‹");
        XLSX.writeFile(wb, "è€ƒè©¦ç¯„ä¾‹æª”.xlsx");
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(firstSheet);
            currentQuiz = json.map(r => ({
                q: r.é¡Œç›®,
                opts: { A: r.é¸é …A, B: r.é¸é …B, C: r.é¸é …C, D: r.é¸é …D, E: r.é¸é …E },
                ans: String(r.æ­£ç¢ºç­”æ¡ˆ).toUpperCase().split('').sort().join(''), // æ ¼å¼åŒ–ç‚ºæ’åºå¾Œçš„å­—æ¯ï¼Œå¦‚ AC
                point: Number(r.é…åˆ†)
            }));
            document.getElementById('qStatus').innerText = `âœ… å·²è®€å– ${currentQuiz.length} é¡Œ`;
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function broadcastExam() {
        if(currentQuiz.length === 0) return alert("è«‹å…ˆåŒ¯å…¥è€ƒé¡Œï¼");
        Object.values(connections).forEach(c => c.send({ type: 'exam', quiz: currentQuiz }));
        alert("è€ƒå·å·²ç™¼é€ï¼");
    }

    function forceSubmit() {
        Object.values(connections).forEach(c => c.send({ type: 'force' }));
    }

    function updateMonitor() {
        const body = document.getElementById('monitorBody');
        body.innerHTML = Object.values(studentData).map(s => `
            <tr><td>${s.no}</td><td>${s.progress}</td><td>${s.score}</td><td>${s.status}</td></tr>
        `).join('');
        document.getElementById('stuCount').innerText = Object.keys(studentData).length;
    }

    function exportFinal() {
        // é‡æ•´æ•¸æ“šä»¥ä¾¿åŒ¯å‡º Excel
        const exportList = Object.values(studentData).map(s => {
            let row = { "åº§è™Ÿ": s.no, "ç¸½åˆ†": s.score };
            currentQuiz.forEach((q, i) => {
                row[`ç¬¬${i+1}é¡Œç­”æ¡ˆ`] = s.answers[i] || "";
                row[`ç¬¬${i+1}é¡Œå¾—åˆ†`] = s.scoresPerQ[i] || 0;
            });
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(exportList);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç­ç´šæˆç¸¾å–®");
        XLSX.writeFile(wb, "è€ƒè©¦çµæœåŒ¯å‡º.xlsx");
    }

    // --- 2. å­¸ç”ŸåŠŸèƒ½ ---
    function showStudentLogin() {
        const urlParams = new URLSearchParams(window.location.search);
        const autoRoom = urlParams.get('room');
        const id = autoRoom || prompt("è«‹è¼¸å…¥è€å¸«æä¾›çš„ 4 ä½ ID:");
        const no = prompt("è«‹è¼¸å…¥æ‚¨çš„åº§è™Ÿ:");
        if(!id || !no) return;

        document.getElementById('modeSelect').classList.add('hidden');
        document.getElementById('studentArea').classList.remove('hidden');

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id.toUpperCase(), { metadata: { no: no } });
            conn.on('data', data => {
                if (data.type === 'exam') startExam(data.quiz);
                if (data.type === 'force') studentSubmit();
            });
        });
    }

    function startExam(quiz) {
        currentQuiz = quiz;
        document.getElementById('stuStatus').innerText = "æ¸¬é©—é€²è¡Œä¸­";
        document.getElementById('stuSubmitBtn').classList.remove('hidden');
        let html = '';
        quiz.forEach((q, i) => {
            html += `<div class="card"><p><b>${i+1}. ${q.q} (${q.point}åˆ†)</b></p>`;
            Object.entries(q.opts).forEach(([key, val]) => {
                if(val && val !== "") {
                    html += `<label style="display:block;margin:8px 0;"><input type="checkbox" name="q${i}" value="${key}" onchange="sendProgress()"> ${key}. ${val}</label>`;
                }
            });
            html += `</div>`;
        });
        document.getElementById('quizContent').innerHTML = html;
        // ç°¡æ˜“å€’æ•¸è¨­å®š... (ç•¥)
    }

    function sendProgress() {
        const answered = currentQuiz.filter((_, i) => document.querySelector(`input[name="q${i}"]:checked`)).length;
        conn.send({ type: 'update', progress: Math.round((answered/currentQuiz.length)*100)+"%" });
    }

    function studentSubmit() {
        let totalScore = 0;
        let answers = {};
        let scoresPerQ = {};

        currentQuiz.forEach((q, i) => {
            const selected = Array.from(document.querySelectorAll(`input[name="q${i}"]:checked`)).map(el => el.value).sort().join('');
            answers[i] = selected;
            if(selected === q.ans) {
                totalScore += q.point;
                scoresPerQ[i] = q.point;
            } else {
                scoresPerQ[i] = 0;
            }
        });

        conn.send({ type: 'submit', score: totalScore, answers: answers, scoresPerQ: scoresPerQ });
        document.getElementById('studentArea').innerHTML = "<h2 style='text-align:center'>è©¦å·å·²ç¹³äº¤ï¼</h2>";
    }
</script>
</body>
</html>
