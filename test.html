<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina Vote Elite</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --p: #5856D6; --s: #34C759; --d: #FF3B30; --bg: #0A0A0C; --card: #1C1C1E; --txt: #FFFFFF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'SF Pro Display', -apple-system, sans-serif; background: var(--bg); color: var(--txt); margin: 0; overflow-x: hidden; }
        
        /* ç»ç’ƒæ“¬æ…‹èƒŒæ™¯ */
        .mesh-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 50% 50%, #1e1e2f 0%, #0a0a0c 100%); }
        .mesh-bg::after { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 20% 30%, rgba(88, 86, 214, 0.15) 0%, transparent 40%), radial-gradient(circle at 80% 70%, rgba(52, 199, 89, 0.1) 0%, transparent 40%); animation: drift 20s infinite linear; }
        @keyframes drift { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .app { max-width: 1000px; margin: auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 30px; margin-bottom: 20px; }
        
        .btn { padding: 16px 24px; border-radius: 16px; border: none; cursor: pointer; font-weight: 700; font-size: 16px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: var(--p); color: white; box-shadow: 0 8px 20px rgba(88, 86, 214, 0.3); }
        .btn-p:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(88, 86, 214, 0.5); }
        .btn-outline { background: transparent; border: 2px solid rgba(255, 255, 255, 0.2); color: white; }

        input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; color: white; font-size: 18px; width: 100%; margin-bottom: 15px; }
        
        /* è€å¸«ç«¯åœ–è¡¨ */
        #chartContainer { position: relative; height: 350px; width: 100%; margin: 20px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; text-align: center; }
        .stat-val { font-size: 28px; font-weight: 800; color: var(--p); }

        /* å­¸ç”Ÿç«¯æŠ•ç¥¨éˆ• */
        .vote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .vote-btn { height: 120px; font-size: 32px; background: rgba(255,255,255,0.05); border: 2px solid transparent; color: white; border-radius: 20px; transition: 0.2s; }
        .vote-btn:active { transform: scale(0.95); background: var(--p); }
        .vote-btn.selected { border-color: var(--p); background: rgba(88, 86, 214, 0.2); box-shadow: 0 0 20px rgba(88,86,214,0.4); }

        .status-tag { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.1); }
        .status-online { background: rgba(52, 199, 89, 0.2); color: var(--s); }

        .hidden { display: none !important; }
        #qrcode canvas { border-radius: 12px; border: 8px solid white; }
    </style>
</head>
<body>

<div class="mesh-bg"></div>

<div class="app">
    <header style="display: flex; justify-content: space-between; align-items: center; padding: 20px 0;">
        <h2 style="margin: 0; letter-spacing: 1px;">LUMINA <span style="color:var(--p)">ELITE</span></h2>
        <div id="connectionStatus" class="status-tag">é›¢ç·š</div>
    </header>

    <div id="v-start" class="animate__animated animate__fadeIn">
        <div class="glass" style="text-align: center; padding: 60px 20px;">
            <h1 style="font-size: 48px; margin-bottom: 10px;">è®“èª²å ‚å‹•èµ·ä¾†</h1>
            <p style="color: #8E8E93; margin-bottom: 40px;">æ¥µè‡´ç©©å®šã€å°ˆæ¥­è¦–è¦ºã€å³æ™‚äº’å‹•æŠ•ç¥¨ç³»çµ±</p>
            <div style="display: flex; flex-direction: column; gap: 15px; max-width: 300px; margin: auto;">
                <button class="btn btn-p" onclick="initTeacher()">ğŸ‘¨â€ğŸ« é–‹å•Ÿæ•™å­¸ä¸­å¿ƒ</button>
                <button class="btn btn-outline" onclick="showView('v-stu-login')">ğŸ“± å­¸ç”Ÿæƒç¢¼åŠ å…¥</button>
            </div>
        </div>
    </div>

    <div id="v-teacher" class="hidden animate__animated animate__fadeIn">
        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
            <div class="glass">
                <input type="text" id="topicInput" placeholder="è¼¸å…¥ä»Šå¤©çš„æŠ•ç¥¨ä¸»é¡Œ..." oninput="syncTopic()">
                <div id="chartContainer">
                    <canvas id="mainChart"></canvas>
                </div>
                <div class="stats-grid" id="teacherStats">
                    </div>
            </div>
            <div class="glass" style="text-align: center;">
                <h3 id="roomCode" style="font-size: 32px; color: var(--p); margin-top: 0;">----</h3>
                <div id="qrcode" style="margin-bottom: 20px;"></div>
                <p style="color: #8E8E93;">è«‹å­¸ç”Ÿæƒææˆ–è¼¸å…¥æˆ¿è™ŸåŠ å…¥</p>
                <div style="display: grid; gap: 10px;">
                    <button class="btn btn-outline" onclick="resetAll()">ğŸ”„ é‡ç½®æ‰€æœ‰æŠ•ç¥¨</button>
                    <button class="btn btn-p" onclick="toggleResult()">ğŸ“¢ çµæŸä¸¦é¡¯ç¤ºç¸½çµ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="v-stu-login" class="hidden animate__animated animate__fadeIn">
        <div class="glass" style="max-width: 400px; margin: 100px auto auto auto; text-align: center;">
            <h2>åŠ å…¥æŠ•ç¥¨</h2>
            <input type="text" id="joinID" placeholder="è«‹è¼¸å…¥ 4 ä½æˆ¿è™Ÿ" style="text-align: center; font-size: 32px; letter-spacing: 4px;">
            <button class="btn btn-p" style="width: 100%;" onclick="initStudent()">å»ºç«‹é€£ç·š</button>
        </div>
    </div>

    <div id="v-student" class="hidden animate__animated animate__fadeIn">
        <div class="glass">
            <h1 id="s-topic" style="text-align: center; font-size: 28px;">ç­‰å¾…è€å¸«é–‹å§‹...</h1>
            <div id="v-options" class="vote-grid">
                <button class="btn vote-btn" onclick="submitVote('A')">A</button>
                <button class="btn vote-btn" onclick="submitVote('B')">B</button>
                <button class="btn vote-btn" onclick="submitVote('C')">C</button>
                <button class="btn vote-btn" onclick="submitVote('D')">D</button>
            </div>
            <div id="v-success" class="hidden animate__animated animate__bounceIn" style="text-align: center; padding: 40px 0;">
                <div style="font-size: 64px;">âœ…</div>
                <h3>æŠ•ç¥¨æˆåŠŸï¼</h3>
                <p style="color: #8E8E93;">æ‚¨å¯ä»¥éš¨æ™‚æ›´æ”¹é¸é …</p>
                <button class="btn btn-outline" onclick="showOptions()">ä¿®æ”¹ç­”æ¡ˆ</button>
            </div>
        </div>
    </div>
</div>

<script>
    let peer, conn, role, myChart;
    let votes = { A: 0, B: 0, C: 0, D: 0 };
    let voterMap = new Map(); // ä½¿ç”¨ Map å­˜å„² ID èˆ‡ é¸é …ï¼Œé˜²æ­¢é‡è¤‡è¨ˆç®—
    const STUN_CONFIG = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }, { 'urls': 'stun:stun1.l.google.com:19302' }] };

    function showView(id) {
        document.querySelectorAll('.app > div').forEach(d => { if(d.id.startsWith('v-')) d.classList.add('hidden'); });
        document.getElementById(id).classList.remove('hidden');
    }

    // --- æ•™å¸«é‚è¼¯ ---
    function initTeacher() {
        role = 'teacher';
        const roomID = Math.floor(1000 + Math.random() * 8999).toString();
        peer = new Peer('LUMINA-' + roomID, { config: STUN_CONFIG });

        peer.on('open', id => {
            showView('v-teacher');
            const shortID = id.split('-')[1];
            document.getElementById('roomCode').innerText = "æˆ¿è™Ÿï¼š" + shortID;
            document.getElementById('connectionStatus').innerText = "å»£æ’­ä¸­";
            document.getElementById('connectionStatus').classList.add('status-online');
            QRCode.toCanvas(document.getElementById('qrcode'), window.location.href.split('?')[0] + '?r=' + shortID);
            initChart();
            
            // æ ¸å¿ƒåŒæ­¥ï¼šæ¯ç§’å»£æ’­
            setInterval(() => {
                const topic = document.getElementById('topicInput').value || "å³æ™‚äº’å‹•æŠ•ç¥¨";
                Object.values(peer.connections).forEach(conns => conns.forEach(c => {
                    if(c.open) c.send({ type: 'sync', topic: topic, votes: votes });
                }));
            }, 1000);
        });

        peer.on('connection', c => {
            c.on('data', d => {
                if(d.type === 'vote') {
                    if(voterMap.has(c.peer)) votes[voterMap.get(c.peer)]--; // æ‰£é™¤èˆŠç¥¨
                    voterMap.set(c.peer, d.val);
                    votes[d.val]++;
                    updateChart();
                }
            });
        });
    }

    function initChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['A', 'B', 'C', 'D'],
                datasets: [{
                    label: 'ç¥¨æ•¸',
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#5856D6', '#34C759', '#FF9500', '#FF3B30'],
                    borderRadius: 12,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#8E8E93', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { ticks: { color: '#FFF', font: { size: 16, weight: 'bold' } }, grid: { display: false } }
                }
            }
        });
    }

    function updateChart() {
        myChart.data.datasets[0].data = [votes.A, votes.B, votes.C, votes.D];
        myChart.update();
        const total = Array.from(voterMap.keys()).length;
        document.getElementById('teacherStats').innerHTML = `
            <div class="stat-card animate__animated animate__fadeIn">ç¸½æŠ•ç¥¨æ•¸<br><span class="stat-val">${total}</span></div>
            <div class="stat-card animate__animated animate__fadeIn">é ˜å…ˆé¸é …<br><span class="stat-val">${getLeader()}</span></div>
        `;
    }

    function getLeader() {
        let max = -1, leader = '--';
        for(let key in votes) { if(votes[key] > max && votes[key] > 0) { max = votes[key]; leader = key; } }
        return leader;
    }

    function resetAll() {
        votes = { A: 0, B: 0, C: 0, D: 0 };
        voterMap.clear();
        updateChart();
    }

    // --- å­¸ç”Ÿé‚è¼¯ ---
    let lastActive = Date.now();
    function initStudent() {
        role = 'student';
        const rid = document.getElementById('joinID').value || new URLSearchParams(window.location.search).get('r');
        if(!rid) return alert('è«‹è¼¸å…¥æˆ¿è™Ÿ');
        
        showView('v-student');
        peer = new Peer({ config: STUN_CONFIG });
        
        peer.on('open', () => {
            connectToTeacher(rid);
            // Android æ–·ç·šä¿æ´»
            setInterval(() => {
                if(Date.now() - lastActive > 5000) connectToTeacher(rid);
            }, 3000);
        });
    }

    function connectToTeacher(rid) {
        if(conn && conn.open) return;
        conn = peer.connect('LUMINA-' + rid, { reliable: true });
        conn.on('open', () => {
            document.getElementById('connectionStatus').innerText = "å·²é€£ç·š";
            document.getElementById('connectionStatus').className = "status-tag status-online";
        });
        conn.on('data', d => {
            if(d.type === 'sync') {
                lastActive = Date.now();
                document.getElementById('s-topic').innerText = d.topic;
            }
        });
    }

    function submitVote(val) {
        if(!conn || !conn.open) return alert('é€£ç·šä¸ç©©å®šï¼Œè«‹ç¨å€™...');
        conn.send({ type: 'vote', val: val });
        
        // Android éœ‡å‹•åé¥‹
        if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(50);
        
        document.getElementById('v-options').classList.add('hidden');
        document.getElementById('v-success').classList.remove('hidden');
        document.getElementById('v-success').querySelector('h3').innerText = "å·²æŠ•çµ¦ " + val;
    }

    function showOptions() {
        document.getElementById('v-options').classList.remove('hidden');
        document.getElementById('v-success').classList.add('hidden');
    }

    // åˆå§‹åŒ–æª¢æŸ¥ URL
    window.onload = () => {
        const r = new URLSearchParams(window.location.search).get('r');
        if(r) { document.getElementById('joinID').value = r; showView('v-stu-login'); }
    }
</script>
</body>
</html>
