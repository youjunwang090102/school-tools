<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>學期成績預估系統</title>
    <style>
        :root { --p: #1a73e8; --bg: #f1f3f4; --red: #d93025; --orange: #f9ab00; --green: #1e8e3e; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 10px; font-size: 14px; }
        .container { width: 100%; max-width: 500px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: auto; }
        
        /* 基本資料區 */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .info-grid select, .info-grid input { padding: 8px; border: 1px solid #dadce0; border-radius: 6px; font-size: 13px; background: white; }
        .full-width { grid-column: span 2; }

        /* 表格區 */
        .row-header { display: flex; background: #f8f9fa; font-weight: bold; padding: 5px 0; border-bottom: 2px solid #eee; text-align: center; font-size: 10px; color: #5f6368; }
        .row { display: flex; padding: 4px 0; border-bottom: 1px solid #f1f1f1; align-items: center; }
        .col-name { flex: 2; min-width: 0; }
        .col-score { flex: 1; }
        .col-w { width: 35px; }
        .col-del { width: 25px; text-align: center; color: #ccc; cursor: pointer; font-size: 16px; }
        
        input.cell { width: 85%; padding: 6px 0; text-align: center; border: 1px solid #eee; border-radius: 4px; font-size: 13px; outline-color: var(--p); }
        .name-input { text-align: left !important; padding-left: 5px !important; width: 92% !important; }

        .btn-group { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-add { background: #e8f0fe; color: var(--p); border: 1px dashed var(--p); }
        .btn-exp { background: var(--p); color: white; }

        /* 報表彈窗 */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:1000; overflow-y: auto; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .report-header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 13px; }
        .report-table th, .report-table td { border: 1px solid #333; padding: 8px 4px; text-align: center; }
        
        .footer-note { font-size: 11px; color: #666; margin-top: 20px; line-height: 1.6; border-top: 1px dashed #ccc; padding-top: 10px; }
        .status-pass { color: var(--green); }
        .status-re { color: var(--orange); }
        .status-fail { color: var(--red); font-weight: bold; }
        @media print { .no-print { display: none; } .modal { display: block; } }
    </style>
</head>
<body>

<div class="container no-print">
    <div style="text-align: center; margin-bottom: 15px;">
        <h2 style="margin:0; color:var(--p)">學期總成績預估系統</h2>
    </div>

    <div class="info-grid">
        <select id="school" class="full-width" onchange="updateClassOptions()">
            <option value="">-- 請選擇學校 --</option>
            <option value="國立台南大學附屬高級中學">國立台南大學附屬高級中學</option>
            <option value="其他學校">其他學校</option>
        </select>
        <select id="year">
            <option value="114">114 學年度</option>
            <option value="115">115 學年度</option>
            <option value="116">116 學年度</option>
        </select>
        <select id="term">
            <option value="上學期">上學期</option>
            <option value="下學期">下學期</option>
        </select>
        <select id="class" onchange="loadPresetSubjects()">
            <option value="">-- 選擇班級 --</option>
        </select>
        <select id="no">
            <script>for(let i=1;i<=50;i++) document.write(`<option value="${i}">${i} 號</option>`);</script>
        </select>
        <input type="text" id="name" placeholder="學生姓名" class="full-width">
    </div>

    <div class="row-header">
        <div class="col-name">科目</div>
        <div class="col-score">一段</div>
        <div class="col-score">二段</div>
        <div class="col-score">期末</div>
        <div class="col-score">平時</div>
        <div class="col-w">學分</div>
        <div class="col-del"></div>
    </div>

    <div id="list-container"></div>

    <div class="btn-group">
        <button class="btn btn-add" onclick="addRow()">+ 手動新增科目</button>
        <button class="btn btn-exp" onclick="generateReport()">生成結算報表</button>
    </div>
</div>

<div id="report-modal" class="modal">
    <div class="report-header">
        <div style="float: right; font-size: 10px;" id="print-time"></div>
        <h2 id="rpt-school" style="margin:0"></h2>
        <div id="rpt-info" style="margin-top:5px"></div>
    </div>

    <table class="report-table">
        <thead>
            <tr><th>科目</th><th>學分</th><th>總分</th><th>判定結果</th></tr>
        </thead>
        <tbody id="rpt-body"></tbody>
    </table>

    <div style="display: flex; justify-content: space-between; font-size: 14px;">
        <div>應修學分：<span id="rpt-total-w"></span></div>
        <div>實得學分：<span id="rpt-get-w" class="status-pass"></span></div>
        <div style="font-weight: bold;">平均：<span id="rpt-avg"></span></div>
    </div>

    <div class="footer-note">
        ※ 本報表為學生自行操作列印，非學校正式成績單。<br>
        ※ 涉及上下學期學分平均制，結果僅供參考。實際學分取得依註冊組公告為準。<br>
        <strong>網站開發設計者：王宥鈞</strong>
    </div>

    <div class="no-print" style="margin-top: 30px;">
        <button class="btn btn-exp" style="width:100%" onclick="window.print()">列印 / 存為 PDF</button>
        <button class="btn btn-add" style="width:100%; margin-top:10px;" onclick="document.getElementById('report-modal').style.display='none'">返回修改</button>
    </div>
</div>

<script>
    const nansSubjects = [
        {n:"國文", w:3}, {n:"英文", w:3}, {n:"數學", w:3},
        {n:"會計學", w:3}, {n:"會計實務", w:3}, {n:"經濟學", w:4},
        {n:"數位科技概論", w:2}, {n:"商業概論", w:2}, {n:"程式語言", w:3}
    ];

    function updateClassOptions() {
        const school = document.getElementById('school').value;
        const classSelect = document.getElementById('class');
        classSelect.innerHTML = '<option value="">-- 選擇班級 --</option>';
        
        if (school === "國立台南大學附屬高級中學") {
            const opts = ["203資訊", "204資訊"];
            opts.forEach(o => classSelect.add(new Option(o, o)));
        } else {
            classSelect.add(new Option("一般班級", "一般班級"));
        }
    }

    function loadPresetSubjects() {
        const school = document.getElementById('school').value;
        const container = document.getElementById('list-container');
        container.innerHTML = '';
        
        if (school === "國立台南大學附屬高級中學") {
            nansSubjects.forEach(s => addRow(s.n, s.w));
        } else {
            for(let i=0; i<5; i++) addRow();
        }
    }

    function addRow(n='', w='') {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
            <div class="col-name"><input type="text" class="cell name-input" value="${n}" placeholder="科目名稱"></div>
            <div class="col-score"><input type="number" class="cell s1" placeholder="0"></div>
            <div class="col-score"><input type="number" class="cell s2" placeholder="0"></div>
            <div class="col-score"><input type="number" class="cell s3" placeholder="0"></div>
            <div class="col-score"><input type="number" class="cell s4" placeholder="0"></div>
            <div class="col-w"><input type="number" class="cell w" value="${w}" placeholder="0"></div>
            <div class="col-del" onclick="this.parentElement.remove()">×</div>
        `;
        document.getElementById('list-container').appendChild(div);
    }

    function generateReport() {
        const now = new Date();
        document.getElementById('print-time').innerText = "列印時間：" + now.toLocaleString();
        document.getElementById('rpt-school').innerText = document.getElementById('school').value;
        document.getElementById('rpt-info').innerText = `${document.getElementById('year').value}學年度 ${document.getElementById('term').value} | 班級：${document.getElementById('class').value} | 座號：${document.getElementById('no').value} | 姓名：${document.getElementById('name').value}`;

        let html = '', totalW = 0, getW = 0, weightedSum = 0;

        document.querySelectorAll('#list-container .row').forEach(row => {
            const n = row.querySelector('.name-input').value || "未命名科目";
            const s1 = parseFloat(row.querySelector('.s1').value) || 0;
            const s2 = parseFloat(row.querySelector('.s2').value) || 0;
            const s3 = parseFloat(row.querySelector('.s3').value) || 0;
            const s4 = parseFloat(row.querySelector('.s4').value) || 0;
            const w = parseFloat(row.querySelector('.w').value) || 0;

            const final = Math.round(s1*0.2 + s2*0.2 + s3*0.2 + s4*0.4);
            let status = '', statusClass = '';

            if (final >= 60) { status = 'Pass'; statusClass = 'status-pass'; getW += w; }
            else if (final >= 40) { status = '請參加補考'; statusClass = 'status-re'; }
            else { status = '死當'; statusClass = 'status-fail'; }

            totalW += w;
            weightedSum += (final * w);

            html += `<tr><td>${n}</td><td>${w}</td><td>${final}</td><td class="${statusClass}">${status}</td></tr>`;
        });

        document.getElementById('rpt-body').innerHTML = html;
        document.getElementById('rpt-total-w').innerText = totalW;
        document.getElementById('rpt-get-w').innerText = getW;
        document.getElementById('rpt-avg').innerText = totalW > 0 ? (weightedSum / totalW).toFixed(2) : "0.00";
        document.getElementById('report-modal').style.display = 'flex';
    }

    window.onload = () => { addRow(); };
</script>
</body>
</html>
