<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P å¼·åŠ›é€£ç·šç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #e0e0e0; text-align: center; padding: 10px; }
        .box { background: #1e1e1e; padding: 15px; border-radius: 12px; max-width: 500px; margin: 0 auto 20px; border: 1px solid #333; }
        video { width: 100%; max-width: 800px; border-radius: 8px; background: #000; }
        input { padding: 10px; border-radius: 4px; border: 1px solid #444; background: #2b2b2b; color: white; width: 80%; margin-bottom: 10px; }
        button { padding: 12px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; margin: 5px; width: 45%; }
        .btn-host { background: #cf6679; color: black; }
        .btn-join { background: #03dac6; color: black; }
        #log { font-size: 12px; color: #888; text-align: left; height: 100px; overflow-y: auto; background: #000; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <h3>ğŸ“¡ P2P ç›´æ’­ (ç›¸å®¹æ€§å¼·åŒ–ç‰ˆ)</h3>

    <div class="box">
        <div>ä½ çš„ ID: <strong id="my-id">å–å¾—ä¸­...</strong></div>
        <div id="log">ç³»çµ±æ—¥èªŒåŒ¯ç¸½...<br></div>
        <hr style="border:0; border-top:1px solid #333; margin: 15px 0;">
        
        <button class="btn-host" id="start-host">1. åˆ†äº«è¢å¹•</button>
        <div style="margin-top: 10px;">
            <input type="text" id="target-id" placeholder="è²¼ä¸Šå°æ–¹çš„ ID">
            <button class="btn-join" id="start-join" style="width: 90%;">2. é€£ç·šè§€çœ‹ / æ¥æ”¶ç•«é¢</button>
        </div>
    </div>

    <video id="main-video" autoplay playsinline controls></video>

<script>
    const logElem = document.getElementById('log');
    function addLog(msg) {
        logElem.innerHTML += `> ${msg}<br>`;
        logElem.scrollTop = logElem.scrollHeight;
    }

    // é…ç½®å¤šçµ„ STUN ä¼ºæœå™¨
    const peer = new Peer({
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' },
                { url: 'stun:stun2.l.google.com:19302' }
            ]
        }
    });

    const videoElem = document.getElementById('main-video');
    let localStream = null;

    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
        addLog("ä¼ºæœå™¨é€£ç·šæˆåŠŸï¼ŒID å·²å°±ç·’");
    });

    // ä¸»è¬›äººé‚è¼¯
    document.getElementById('start-host').addEventListener('click', async () => {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            videoElem.srcObject = localStream;
            addLog("è¢å¹•æ“·å–æˆåŠŸï¼Œç­‰å¾…é€£ç·š...");

            // ç›£è½é€£ç·š
            peer.on('call', call => {
                addLog("åµæ¸¬åˆ°è§€çœ¾å‘¼å«ï¼Œæ­£åœ¨å‚³é€ä¸²æµ...");
                call.answer(localStream);
                call.on('stream', () => addLog("ä¸²æµå‚³è¼¸ä¸­"));
            });
        } catch (err) {
            addLog("å¤±æ•—: " + err.message);
        }
    });

    // è§€çœ¾é‚è¼¯
    document.getElementById('start-join').addEventListener('click', () => {
        const hostId = document.getElementById('target-id').value;
        if (!hostId) return alert("è«‹è¼¸å…¥ ID");

        addLog("å˜—è©¦é€£ç·šè‡³: " + hostId);
        
        // æ³¨æ„ï¼šWebRTC å¿…é ˆè¦æœ‰ Stream ç‰©ä»¶æ‰èƒ½å»ºç«‹ Call
        // æˆ‘å€‘å»ºç«‹ä¸€å€‹ç©ºçš„éŸ³è»Œä¾†æ¬ºé¨™ç€è¦½å™¨å•Ÿå‹•é€£ç·šéç¨‹
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 1;
        const dummyStream = canvas.captureStream();

        const call = peer.call(hostId, dummyStream);

        call.on('stream', remoteStream => {
            addLog("æˆåŠŸæ¥æ”¶åˆ°å½±åƒä¸²æµï¼");
            videoElem.srcObject = remoteStream;
            // å˜—è©¦è‡ªå‹•æ’­æ”¾
            videoElem.play().catch(e => addLog("è«‹æ‰‹å‹•é»æ“Šæ’­æ”¾å½±ç‰‡"));
        });

        setTimeout(() => {
            if (!videoElem.srcObject) {
                addLog("è­¦å‘Šï¼šé€£ç·šæ™‚é–“éé•·ï¼Œå¯èƒ½æ˜¯é˜²ç«ç‰†é˜»æ“‹ (NAT Traversal Failed)");
            }
        }, 10000);
    });

    peer.on('error', err => addLog("éŒ¯èª¤é¡å‹: " + err.type));
</script>
</body>
</html>
