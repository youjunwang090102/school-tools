<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>P2P è·¨è£ç½®è¢å¹•åˆ†äº«</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #e0e0e0; text-align: center; padding: 20px; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 12px; max-width: 600px; margin: 0 auto 20px; border: 1px solid #333; }
        video { width: 100%; max-width: 800px; border-radius: 8px; background: #000; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        input { padding: 10px; border-radius: 4px; border: 1px solid #444; background: #2b2b2b; color: white; width: 200px; }
        button { padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-host { background: #cf6679; color: black; }
        .btn-join { background: #03dac6; color: black; }
        #status { color: #bb86fc; margin: 10px 0; }
    </style>
</head>
<body>

    <h2>ğŸ“¡ è·¨è£ç½® P2P ç›´æ’­æ¸¬è©¦</h2>

    <div class="box">
        <p>ä½ çš„ ID: <strong id="my-id">é€£ç·šä¸­...</strong></p>
        <div id="status">ç³»çµ±å°±ç·’</div>
        <hr style="border:0; border-top:1px solid #333; margin: 20px 0;">
        
        <button class="btn-host" id="start-host">1. æˆ‘è¦ç•¶ä¸»è¬›äºº (åˆ†äº«è¢å¹•)</button>
        
        <br><br>
        
        <input type="text" id="target-id" placeholder="è²¼ä¸Šä¸»è¬›äººçš„ ID">
        <button class="btn-join" id="start-join">2. æˆ‘è¦ç•¶è§€çœ¾ (è¼¸å…¥IDé€£ç·š)</button>
    </div>

    <video id="main-video" autoplay playsinline controls></video>

<script>
    // åŠ å…¥ STUN ä¼ºæœå™¨è¨­å®šï¼Œå¹«åŠ©ç©¿é€é˜²ç«ç‰†èˆ‡ NAT
    const peerConfig = {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' }
            ]
        }
    };

    const peer = new Peer(peerConfig);
    const videoElem = document.getElementById('main-video');
    const statusElem = document.getElementById('status');
    let localStream = null;

    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
    });

    // --- ä¸»è¬›äººé‚è¼¯ ---
    document.getElementById('start-host').addEventListener('click', async () => {
        try {
            // å–å¾—è¢å¹•ä¸²æµ
            localStream = await navigator.mediaDevices.getDisplayMedia({ 
                video: { cursor: "always" }, 
                audio: true 
            });
            videoElem.srcObject = localStream;
            statusElem.innerText = "ç›´æ’­ä¸­ï¼Œç­‰å¾…è§€çœ¾é€£ç·š...";

            // ç›£è½æ˜¯å¦æœ‰è§€çœ¾é€£å…¥
            peer.on('call', call => {
                console.log("åµæ¸¬åˆ°è§€çœ¾é€£å…¥:", call.peer);
                // æ¥é€šä¸¦å°‡è‡ªå·±çš„ç•«é¢å‚³çµ¦è§€çœ¾
                call.answer(localStream); 
                statusElem.innerText = "å·²æœ‰è§€çœ¾é€£å…¥è§€çœ‹ï¼";
            });

        } catch (err) {
            statusElem.innerText = "éŒ¯èª¤: " + err.message;
        }
    });

    // --- è§€çœ¾é‚è¼¯ ---
    document.getElementById('start-join').addEventListener('click', () => {
        const hostId = document.getElementById('target-id').value;
        if (!hostId) return alert("è«‹è¼¸å…¥ä¸»è¬›äºº ID");

        statusElem.innerText = "æ­£åœ¨é€£ç·šä¸»è¬›äºº...";
        
        /* é‡é»ï¼šç‚ºäº†è§¸ç™¼ WebRTC æ¡æ‰‹ï¼Œè§€çœ¾ç«¯å¿…é ˆç™¼èµ· callã€‚
           å³ä½¿è§€çœ¾ä¸åˆ†äº«ç•«é¢ï¼ŒPeerJS å»ºè­°å‚³é€ä¸€å€‹ MediaStream æˆ–è™•ç†æ‡‰ç­”ã€‚
        */
        const call = peer.call(hostId, new MediaStream()); 

        call.on('stream', remoteStream => {
            console.log("æ”¶åˆ°ä¸»è¬›äººç•«é¢ï¼");
            videoElem.srcObject = remoteStream;
            statusElem.innerText = "å·²æˆåŠŸæ¥æ”¶ç•«é¢";
        });

        call.on('error', err => {
            statusElem.innerText = "é€£ç·šå¤±æ•—: " + err;
        });
    });

    peer.on('error', err => {
        console.error("PeerJS Error:", err);
        statusElem.innerText = "éŒ¯èª¤: " + err.type;
    });
</script>
</body>
</html>
