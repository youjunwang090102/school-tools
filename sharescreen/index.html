<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”’ éŸ¿æ‡‰å¼ P2P é›²ç«¯æ•™å®¤</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; --bg: #121212; --panel: #1e1e1e; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; height: 100vh; flex-direction: column; }
        
        /* å½±ç‰‡å€åŸŸï¼šç¢ºä¿æ¯”ä¾‹æ­£ç¢º */
        #video-section { flex: 1; background: #000; display: flex; flex-direction: column; position: relative; min-height: 250px; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; } /* é—œéµä¿®å¾©ï¼šcontain */

        /* æ§åˆ¶åˆ— */
        .top-bar { background: #2c3e50; padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; font-size: 13px; }
        input { background: #333; border: 1px solid #555; color: white; padding: 6px; border-radius: 4px; }

        /* ä¸‹æ–¹/å´é‚Šé¢æ¿ */
        #interactive-panel { width: 350px; background: var(--panel); border-left: 1px solid #333; display: flex; flex-direction: column; }
        
        /* æ¨™ç±¤åˆ‡æ›å™¨ */
        .tab-bar { display: flex; background: #252525; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; color: #888; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); background: #2a2a2a; }

        .content-area { flex: 1; overflow-y: auto; display: none; padding: 15px; }
        .content-area.active { display: block; }

        /* æˆå“¡èˆ‡èŠå¤©æ¨£å¼ */
        .member-item { display: flex; justify-content: space-between; background: #333; padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .msg { margin-bottom: 10px; border-bottom: 1px solid #2a2a2a; padding-bottom: 5px; word-break: break-all; }

        /* æ‰‹æ©Ÿç‰ˆé©é…æ¨£å¼ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #interactive-panel { width: 100%; flex: 1; border-left: none; }
            #video-section { height: 35vh; flex: none; }
        }

        button { padding: 8px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-green { background: var(--success); color: white; }
        .btn-blue { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div id="video-section">
    <div class="top-bar">
        <span>ä½ çš„ ID: <b id="my-id" style="color:var(--success)">...</b></span>
        <button class="btn-green" id="btn-host">å•Ÿå‹•åˆ†äº«</button>
        <div style="flex:1"></div>
        <input type="text" id="target-id" placeholder="è¼¸å…¥ä¸»è¬› ID">
        <button class="btn-blue" id="btn-join">ç”³è«‹åŠ å…¥</button>
    </div>
    <video id="v-player" autoplay playsinline controls muted></video>
</div>

<div id="interactive-panel">
    <div class="tab-bar">
        <button class="tab-btn active" onclick="showTab('chat')">å³æ™‚èŠå¤©</button>
        <button class="tab-btn" onclick="showTab('members')">åœ¨ç·šæˆå“¡</button>
    </div>

    <div id="chat-content" class="content-area active">
        <div id="msgs-box"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="chat-in" placeholder="è¼¸å…¥è¨Šæ¯...">
            <button class="btn-blue" id="btn-send">å‚³é€</button>
        </div>
    </div>

    <div id="members-content" class="content-area">
        <div id="member-list"></div>
    </div>
</div>

<script>
    const peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
    let localStream = null;
    let connections = {};
    let isHost = false;

    peer.on('open', id => { document.getElementById('my-id').innerText = id; });

    // ä¸»è¬›äººè™•ç†é€£ç·š
    peer.on('connection', conn => {
        if(!isHost) {
            conn.on('open', () => conn.send({type:'sys', msg:'ä¸»è¬›äººå°šæœªæº–å‚™å¥½'}));
            return;
        }
        if(confirm(`å­¸ç”Ÿ ${conn.peer.slice(0,5)} ç”³è«‹åŠ å…¥ï¼Ÿ`)) {
            connections[conn.peer] = conn;
            setupConn(conn);
            peer.call(conn.peer, localStream);
            updateMemberList();
        }
    });

    // æ¥æ”¶è¦–è¨Š
    peer.on('call', call => {
        call.answer();
        call.on('stream', stream => { document.getElementById('v-player').srcObject = stream; });
    });

    // åŠŸèƒ½æŒ‰éˆ•
    document.getElementById('btn-host').onclick = async () => {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            document.getElementById('v-player').srcObject = localStream;
            isHost = true;
            addLog("ç³»çµ±", "âœ… åˆ†äº«å·²é–‹å§‹ã€‚");
        } catch(e) { alert("å•Ÿå‹•å¤±æ•—"); }
    };

    document.getElementById('btn-join').onclick = () => {
        const tid = document.getElementById('target-id').value;
        if(tid) {
            const conn = peer.connect(tid);
            connections[tid] = conn;
            setupConn(conn);
        }
    };

    function setupConn(conn) {
        conn.on('data', data => {
            if(data.type === 'chat') addLog("å°æ–¹", data.msg);
            else if(data.type === 'sys') addLog("ç³»çµ±", data.msg);
            else if(data.type === 'kick') location.reload();
        });
        conn.on('close', () => { delete connections[conn.peer]; updateMemberList(); });
    }

    function addLog(user, msg) {
        const box = document.getElementById('msgs-box');
        const d = document.createElement('div');
        d.className = 'msg';
        d.innerHTML = `<small style="color:#888">${user}:</small> <div>${msg}</div>`;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    }

    // æ¨™ç±¤åˆ‡æ›é‚è¼¯
    window.showTab = function(type) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(`${type}-content`).classList.add('active');
    };

    function updateMemberList() {
        const list = document.getElementById('member-list');
        list.innerHTML = "";
        Object.keys(connections).forEach(id => {
            const item = document.createElement('div');
            item.className = 'member-item';
            item.innerHTML = `<span>${id.slice(0,8)}</span> <button onclick="kick('${id}')" style="background:var(--danger); font-size:10px">è¸¢é™¤</button>`;
            list.appendChild(item);
        });
    }

    window.kick = (id) => {
        if(connections[id]) {
            connections[id].send({type:'kick'});
            connections[id].close();
        }
    };

    const sendMsg = () => {
        const input = document.getElementById('chat-in');
        const val = input.value;
        if(!val) return;
        Object.values(connections).forEach(c => c.open && c.send({type:'chat', msg:val}));
        addLog("æˆ‘", val);
        input.value = "";
    };

    document.getElementById('btn-send').onclick = sendMsg;
    document.getElementById('chat-in').onkeydown = e => { if(e.key==='Enter') sendMsg(); };
</script>
</body>
</html>
