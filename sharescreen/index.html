<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P 教室修復版</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #121212; color: white; font-family: sans-serif; display: flex; height: 100vh; }
        #video-container { flex: 1; display: flex; flex-direction: column; background: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #chat-panel { width: 300px; background: #1e1e1e; display: flex; flex-direction: column; border-left: 1px solid #333; }
        .top-bar { background: #252525; padding: 10px; display: flex; gap: 10px; align-items: center; font-size: 14px; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; }
        .input-area { padding: 10px; background: #252525; display: flex; gap: 5px; }
        input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; }
        button { padding: 8px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; background: #6200ee; color: white; }
        .msg { margin-bottom: 8px; border-bottom: 1px solid #2a2a2a; padding-bottom: 5px; }
        .id-text { color: #03dac6; font-family: monospace; }
    </style>
</head>
<body>

<div id="video-container">
    <div class="top-bar">
        <div>ID: <span class="id-text" id="my-id">讀取中...</span></div>
        <button id="btn-host" style="background:#cf6679">主講人：啟動分享</button>
        <button id="btn-copy" style="display:none; background:#444">複製連結</button>
        <div style="flex:1"></div>
        <input type="text" id="target-id" placeholder="學生填入 ID" style="max-width:100px">
        <button id="btn-join" style="background:#03dac6; color:black">學生加入</button>
    </div>
    <video id="v-player" autoplay playsinline controls muted></video>
</div>

<div id="chat-panel">
    <div style="padding:10px; background:#333; font-size:12px">即時討論</div>
    <div id="chat-msgs"></div>
    <div class="input-area">
        <input type="text" id="chat-in" placeholder="輸入訊息...">
        <button id="btn-send">傳送</button>
    </div>
</div>

<script>
    const peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
    let currentConn = null;
    let myStream = null;

    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
        if(window.location.hash) document.getElementById('target-id').value = window.location.hash.substring(1);
    });

    // --- 主講人流程 ---
    document.getElementById('btn-host').onclick = async () => {
        try {
            myStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            document.getElementById('v-player').srcObject = myStream;
            document.getElementById('btn-copy').style.display = 'block';
            addLog("系統", "螢幕分享已就緒。");

            // 監聽學生「連線請求」
            peer.on('connection', conn => {
                currentConn = conn;
                setupChat(conn);
                addLog("系統", "學生已連線，正在推送畫面...");
                // 重點：主講人主動撥打視訊給該學生
                peer.call(conn.peer, myStream);
            });
        } catch (e) { alert("無法分享: " + e); }
    };

    // --- 學生流程 ---
    document.getElementById('btn-join').onclick = () => {
        const tid = document.getElementById('target-id').value;
        if(!tid) return;
        
        addLog("系統", "連線主講人中...");
        
        // 1. 建立訊息連線
        const conn = peer.connect(tid);
        currentConn = conn;
        setupChat(conn);

        // 2. 準備接收視訊（監聽主講人撥回來的電話）
        peer.on('call', call => {
            call.answer(); // 接聽
            call.on('stream', stream => {
                document.getElementById('v-player').srcObject = stream;
                addLog("系統", "成功同步主講人畫面！");
            });
        });
    };

    // --- 共用功能 ---
    function setupChat(conn) {
        conn.off('data'); // 先關掉舊的監聽，解決「跳三次」訊息的問題
        conn.on('data', data => addLog("對方", data));
        conn.on('open', () => addLog("系統", "通訊頻道已開啟"));
    }

    function addLog(user, text) {
        const box = document.getElementById('chat-msgs');
        const d = document.createElement('div');
        d.className = 'msg';
        d.innerHTML = `<b style="color:${user==='我'?'#03dac6':'#ffab40'}">${user}:</b> ${text}`;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    }

    const sendMsg = () => {
        const i = document.getElementById('chat-in');
        if(!i.value || !currentConn) return;
        currentConn.send(i.value);
        addLog("我", i.value);
        i.value = "";
    };

    document.getElementById('btn-send').onclick = sendMsg;
    document.getElementById('chat-in').onkeypress = (e) => { if(e.key==='Enter') sendMsg(); };
    document.getElementById('btn-copy').onclick = () => {
        const url = window.location.origin + window.location.pathname + "#" + peer.id;
        navigator.clipboard.writeText(url);
        alert("連結已複製");
    };
</script>
</body>
</html>
