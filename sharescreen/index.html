<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>P2P ä¸€å°å¤šè¢å¹•åˆ†äº«</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; text-align: center; }
        .container { max-width: 900px; margin: auto; padding: 20px; }
        video { width: 100%; border: 2px solid #444; border-radius: 12px; background: #000; margin-top: 20px; }
        .panel { background: #2a2a2a; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-host { background: #28a745; color: white; }
        .btn-join { background: #007bff; color: white; }
        #viewer-count { color: #aaa; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¡ å»£æ’­æ¨¡å¼ï¼šè¢å¹•åˆ†äº«</h2>
    
    <div class="panel">
        <p>ä½ çš„ ID: <strong id="my-id">é€£ç·šä¸­...</strong></p>
        <div id="host-controls">
            <button class="btn btn-host" id="start-broadcast">é–‹å§‹ç›´æ’­è¢å¹•</button>
            <p id="viewer-count">ç•¶å‰è§€çœ¾: 0</p>
        </div>
        <hr style="border: 0.5px solid #444; margin: 20px 0;">
        <div id="viewer-controls">
            <input type="text" id="target-id" placeholder="è¼¸å…¥ä¸»è¬›äºº ID" style="padding: 9px; border-radius: 5px;">
            <button class="btn btn-join" id="join-broadcast">é€²å…¥è§€çœ‹</button>
        </div>
    </div>

    <video id="display-video" autoplay playsinline controls></video>
</div>

<script>
    const peer = new Peer();
    const myIdDisplay = document.getElementById('my-id');
    const videoElem = document.getElementById('display-video');
    const viewerCountElem = document.getElementById('viewer-count');
    
    let localStream = null;
    let connectedPeers = {}; // è¨˜éŒ„æ‰€æœ‰é€£é€²ä¾†çš„è§€çœ¾

    peer.on('open', id => myIdDisplay.innerText = id);

    // --- ä¸»è¬›äººé‚è¼¯ ---
    document.getElementById('start-broadcast').addEventListener('click', async () => {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            videoElem.srcObject = localStream;
            
            // ç•¶ä¸»è¬›äººå·²ç¶“åœ¨ç›´æ’­æ™‚ï¼Œè‹¥æœ‰æ–°çš„è§€çœ¾ã€Œå‘¼å«ã€é€²ä¾†ï¼Œè‡ªå‹•æ¥è½ä¸¦å‚³é€ç•«é¢
            peer.on('call', call => {
                call.answer(localStream);
                handleNewConnection(call);
            });

            alert("ç›´æ’­å·²å•Ÿå‹•ï¼ç¾åœ¨è«‹è§€çœ¾è¼¸å…¥ä½ çš„ ID å³å¯çœ‹åˆ°ç•«é¢ã€‚");
        } catch (err) {
            console.error("å•Ÿå‹•å¤±æ•—", err);
        }
    });

    function handleNewConnection(call) {
        connectedPeers[call.peer] = call;
        updateViewerCount();
        call.on('close', () => {
            delete connectedPeers[call.peer];
            updateViewerCount();
        });
    }

    function updateViewerCount() {
        viewerCountElem.innerText = `ç•¶å‰è§€çœ¾: ${Object.keys(connectedPeers).length}`;
    }

    // --- è§€çœ¾é‚è¼¯ ---
    document.getElementById('join-broadcast').addEventListener('click', () => {
        const hostId = document.getElementById('target-id').value;
        if (!hostId) return alert("è«‹è¼¸å…¥ä¸»è¬›äºº ID");

        // æ’¥æ‰“çµ¦ä¸»è¬›äººï¼ˆè§€çœ¾ä¸éœ€å‚³é€è‡ªå·±çš„ä¸²æµï¼Œæ‰€ä»¥å‚³ null æˆ–ç©ºæµï¼‰
        const call = peer.call(hostId, null);
        
        call.on('stream', remoteStream => {
            videoElem.srcObject = remoteStream;
            console.log("æˆåŠŸæ¥æ”¶ç•«é¢");
        });

        call.on('error', err => {
            console.error("é€£ç·šéŒ¯èª¤", err);
            alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ ID æ˜¯å¦æ­£ç¢º");
        });
    });

</script>
</body>
</html>
