<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P äº’å‹•é›²ç«¯æ•™å®¤</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #6200ee; --bg: #121212; --panel: #1e1e1e; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* å·¦å´å½±ç‰‡å€ */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        
        /* ä¸Šæ–¹æ§åˆ¶åˆ— */
        .top-bar { background: rgba(0,0,0,0.8); padding: 15px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #333; }
        .id-badge { background: #333; padding: 5px 10px; border-radius: 4px; font-family: monospace; color: #03dac6; }
        
        /* å³å´èŠå¤©é¢æ¿ */
        #side-panel { width: 320px; background: var(--panel); border-left: 1px solid #333; display: flex; flex-direction: column; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; border-bottom: 1px solid #333; }
        .chat-input-area { padding: 15px; display: flex; gap: 5px; }
        
        /* é€šç”¨å…ƒä»¶ */
        input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #444; background: #2b2b2b; color: white; }
        button { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; background: var(--primary); color: white; }
        button:hover { opacity: 0.9; }
        .btn-host { background: #cf6679; }
        .btn-join { background: #03dac6; color: #000; }
        .msg { margin-bottom: 10px; word-break: break-all; }
        .msg-sys { color: #888; font-size: 12px; }
    </style>
</head>
<body>

<div id="main-container">
    <div class="top-bar">
        <div>æˆ‘çš„ ID: <span class="id-badge" id="my-id">é€£ç·šä¸­...</span></div>
        
        <button class="btn-host" id="btn-start-host">å•Ÿå‹•åˆ†äº«</button>
        <button id="btn-copy-link" style="display:none; background:#444;">è¤‡è£½é‚€è«‹é€£çµ</button>
        
        <div style="border-left: 1px solid #444; height: 25px; margin: 0 10px;"></div>
        
        <input type="text" id="input-host-id" placeholder="è¼¸å…¥ä¸»è¬›äºº ID" style="width: 150px;">
        <button class="btn-join" id="btn-manual-join">æ‰‹å‹•åŠ å…¥</button>
    </div>
    
    <video id="display-video" autoplay playsinline controls></video>
</div>

<div id="side-panel">
    <div style="padding: 15px; font-weight: bold; border-bottom: 1px solid #333;">ğŸ’¬ å³æ™‚è¨è«–å€</div>
    <div id="chat-window">
        <div class="msg msg-sys">ç³»çµ±ï¼šå·²é€²å…¥æ•™å®¤ç’°å¢ƒã€‚</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="èªªé»ä»€éº¼...">
        <button id="btn-send">å‚³é€</button>
    </div>
</div>

<script>
    const peer = new Peer({ config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]}});
    let activeConn = null;
    let localStream = null;

    // åˆå§‹åŒ–ï¼šé¡¯ç¤º ID ä¸¦æª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰é‚€è«‹ç¢¼
    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
        if(window.location.hash) {
            const inviteId = window.location.hash.substring(1);
            document.getElementById('input-host-id').value = inviteId;
            addLog("ç³»çµ±", "åµæ¸¬åˆ°é€£çµé‚€è«‹ï¼Œæ­£åœ¨è‡ªå‹•é€£ç·š...");
            startJoining(inviteId);
        }
    });

    // --- ã€ä¸»è¬›äººã€‘é‚è¼¯ ---
    document.getElementById('btn-start-host').addEventListener('click', async () => {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            document.getElementById('display-video').srcObject = localStream;
            document.getElementById('btn-copy-link').style.display = 'inline-block';
            addLog("ç³»çµ±", "è¢å¹•ç›´æ’­ä¸­ï¼Œå­¸ç”Ÿç¾åœ¨å¯ä»¥åŠ å…¥äº†ã€‚");

            // ç›£è½å­¸ç”Ÿé€£ç·š
            peer.on('connection', conn => {
                activeConn = conn;
                setupChat(conn);
                addLog("ç³»çµ±", "ä¸€åå­¸ç”Ÿå·²é€£å…¥èŠå¤©å®¤");
            });

            // ç›£è½å­¸ç”Ÿè¦–è¨Šè«‹æ±‚
            peer.on('call', call => {
                call.answer(localStream);
            });
        } catch (err) {
            alert("å•Ÿå‹•å¤±æ•—: " + err.message);
        }
    });

    // --- ã€å­¸ç”Ÿã€‘é‚è¼¯ ---
    document.getElementById('btn-manual-join').addEventListener('click', () => {
        const targetId = document.getElementById('input-host-id').value;
        if(!targetId) return alert("è«‹è¼¸å…¥ä¸»è¬›äºº ID");
        startJoining(targetId);
    });

    function startJoining(targetId) {
        addLog("ç³»çµ±", "å˜—è©¦èˆ‡ä¸»è¬›äººå»ºç«‹é€£ç·š...");
        
        // 1. å»ºç«‹èŠå¤©é€£ç·š
        const conn = peer.connect(targetId);
        activeConn = conn;
        setupChat(conn);

        // 2. è«‹æ±‚å½±åƒä¸²æµ
        const call = peer.call(targetId, new MediaStream()); // å­¸ç”Ÿä¸å‚³å½±åƒï¼Œåªæ¥æ”¶
        call.on('stream', stream => {
            document.getElementById('display-video').srcObject = stream;
            addLog("ç³»çµ±", "å½±åƒåŒæ­¥æˆåŠŸï¼");
        });
        
        call.on('error', () => alert("å½±åƒé€£ç·šå¤±æ•—"));
    }

    // --- é€šè¨Šå…±ç”¨åŠŸèƒ½ ---
    function setupChat(conn) {
        conn.on('data', data => addLog("å°æ–¹", data));
        conn.on('close', () => addLog("ç³»çµ±", "é€£ç·šå·²ä¸­æ–·"));
    }

    function sendMessage() {
        const input = document.getElementById('chat-input');
        if(!input.value || !activeConn) return;
        activeConn.send(input.value);
        addLog("æˆ‘", input.value);
        input.value = "";
    }

    function addLog(user, text) {
        const win = document.getElementById('chat-window');
        const div = document.createElement('div');
        div.className = "msg";
        div.innerHTML = `<span style="color:${user==='æˆ‘'?'#03dac6':'#ffab40'}"><b>${user}:</b></span> ${text}`;
        if(user === "ç³»çµ±") div.className = "msg msg-sys";
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    // äº‹ä»¶ç›£è½
    document.getElementById('btn-send').addEventListener('click', sendMessage);
    document.getElementById('chat-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });
    document.getElementById('btn-copy-link').addEventListener('click', () => {
        const url = window.location.origin + window.location.pathname + "#" + peer.id;
        navigator.clipboard.writeText(url);
        alert("é‚€è«‹é€£çµå·²è¤‡è£½ï¼");
    });
</script>
</body>
</html>
