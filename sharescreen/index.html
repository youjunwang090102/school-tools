<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”’ ç©©å®šé€£ç·š P2P æ•™å®¤</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: -apple-system, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #main { flex: 1; display: flex; flex-direction: column; }
        .top-bar { background: #2c3e50; padding: 12px; display: flex; gap: 10px; align-items: center; border-bottom: 2px solid #34495e; }
        #video-player { flex: 1; background: #000; object-fit: contain; }
        #side-panel { width: 320px; background: #252525; border-left: 1px solid #444; display: flex; flex-direction: column; }
        .list-box { flex: 0.4; border-bottom: 1px solid #444; overflow-y: auto; padding: 10px; }
        .chat-box { flex: 0.6; display: flex; flex-direction: column; }
        #msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; background: #1e1e1e; }
        .input-area { padding: 10px; display: flex; gap: 5px; background: #252525; }
        input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; outline: none; }
        button { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-host { background: #2ecc71; color: white; }
        .btn-join { background: #3498db; color: white; }
        .member-item { display: flex; justify-content: space-between; padding: 5px; background: #333; margin-bottom: 5px; border-radius: 3px; font-size: 12px; }
        .kick-btn { background: #e74c3c; padding: 2px 6px; font-size: 10px; border-radius: 3px; }
    </style>
</head>
<body>

<div id="main">
    <div class="top-bar">
        <span>ä½ çš„ ID: <b id="my-id" style="color:#2ecc71">...</b></span>
        <button class="btn-host" id="btn-host">1. å•Ÿå‹•æ•™å®¤(ä¸»è¬›äºº)</button>
        <div style="flex:1"></div>
        <input type="text" id="target-id" placeholder="è²¼ä¸Šä¸»è¬›äºº ID">
        <button class="btn-join" id="btn-join">2. ç”³è«‹åŠ å…¥(å­¸ç”Ÿ)</button>
    </div>
    <video id="video-player" autoplay playsinline controls muted></video>
</div>

<div id="side-panel">
    <div class="list-box">
        <div style="font-size:12px; color:#888; margin-bottom:8px;">ğŸ‘¥ åœ¨ç·šæˆå“¡</div>
        <div id="member-list"></div>
    </div>
    <div class="chat-box">
        <div id="msgs"></div>
        <div class="input-area">
            <input type="text" id="chat-in" placeholder="è¼¸å…¥è¨Šæ¯ (English OK)...">
            <button id="btn-send" style="background:#3498db; color:white">å‚³é€</button>
        </div>
    </div>
</div>

<script>
    const peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
    let localStream = null;
    let connections = {}; 
    let isHostActive = false;

    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
        if(window.location.hash) document.getElementById('target-id').value = window.location.hash.substring(1);
    });

    // --- ä¸»è¬›äººç›£è½ ---
    peer.on('connection', conn => {
        if(!isHostActive) {
            addLog("ç³»çµ±", `æ‹’çµ•äº†ä¾†è‡ª ${conn.peer} çš„è«‹æ±‚ (åŸå› ï¼šä¸»è¬›äººå°šæœªå•Ÿå‹•åˆ†äº«)`);
            conn.on('open', () => conn.send({ type: 'error', msg: 'ä¸»è¬›äººå°šæœªé»æ“Šå•Ÿå‹•æ•™å®¤æŒ‰éˆ•' }));
            return;
        }

        const allow = confirm(`å­¸ç”Ÿ ${conn.peer} æƒ³è¦åŠ å…¥ï¼Œæ˜¯å¦æ ¸å‡†ï¼Ÿ`);
        if(allow) {
            connections[conn.peer] = conn;
            setupConn(conn);
            updateList();
            // ä¸»è¬›äººæ ¸å‡†å¾Œï¼Œä¸»å‹•æ’¥æ‰“è¦–è¨Š
            peer.call(conn.peer, localStream);
            addLog("ç³»çµ±", `å·²æ ¸å‡†å­¸ç”Ÿ ${conn.peer}`);
        } else {
            conn.on('open', () => conn.send({ type: 'error', msg: 'ä¸»è¬›äººæ‹’çµ•äº†æ‚¨çš„ç”³è«‹' }));
        }
    });

    peer.on('call', call => {
        call.answer();
        call.on('stream', stream => {
            document.getElementById('video-player').srcObject = stream;
            addLog("ç³»çµ±", "ç•«é¢åŒæ­¥æˆåŠŸï¼");
        });
    });

    // --- åŠŸèƒ½æ“ä½œ ---
    document.getElementById('btn-host').onclick = async () => {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            document.getElementById('video-player').srcObject = localStream;
            isHostActive = true;
            addLog("ç³»çµ±", "âœ… æ•™å®¤å·²å•Ÿå‹•ï¼Œé–‹å§‹æ¥æ”¶å­¸ç”Ÿç”³è«‹");
        } catch (e) { alert("è«‹åˆ†äº«è¢å¹•æ–¹èƒ½é–‹å•Ÿæ•™å®¤"); }
    };

    document.getElementById('btn-join').onclick = () => {
        const tid = document.getElementById('target-id').value;
        if(!tid) return alert("è«‹è¼¸å…¥ ID");
        addLog("ç³»çµ±", "ğŸš€ æ­£åœ¨ç™¼é€ç”³è«‹...");
        const conn = peer.connect(tid);
        setupConn(conn);
    };

    function setupConn(conn) {
        conn.on('data', data => {
            if(data.type === 'error') addLog("éŒ¯èª¤", data.msg);
            else if(data.type === 'chat') addLog(conn.peer === peer.id ? "æˆ‘" : "å°æ–¹", data.msg);
            else if(data.type === 'kick') { alert("æ‚¨å·²è¢«ç§»å‡ºæ•™å®¤"); location.reload(); }
        });
        conn.on('close', () => {
            delete connections[conn.peer];
            updateList();
            addLog("ç³»çµ±", "é€£ç·šå·²ä¸­æ–·");
        });
    }

    function updateList() {
        const container = document.getElementById('member-list');
        container.innerHTML = "";
        Object.keys(connections).forEach(id => {
            const div = document.createElement('div');
            div.className = 'member-item';
            div.innerHTML = `<span>${id.slice(0,6)}...</span> <button class="kick-btn" onclick="kick('${id}')">é€€å‡º</button>`;
            container.appendChild(div);
        });
    }

    window.kick = (id) => {
        if(connections[id]) {
            connections[id].send({ type: 'kick' });
            setTimeout(() => connections[id].close(), 500);
        }
    };

    function addLog(user, msg) {
        const box = document.getElementById('msgs');
        const div = document.createElement('div');
        div.style.padding = "5px 0";
        div.innerHTML = `<small style="color:#888">${user}:</small> <span style="font-size:14px">${msg}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    const sendMsg = () => {
        const input = document.getElementById('chat-in');
        const val = input.value.trim();
        if(!val) return;
        // ç™¼é€çµ¦æ‰€æœ‰é€£ç·šè€…
        Object.values(connections).forEach(c => c.open && c.send({ type: 'chat', msg: val }));
        addLog("æˆ‘", val);
        input.value = "";
    };

    document.getElementById('btn-send').onclick = sendMsg;
    document.getElementById('chat-in').onkeydown = e => { if(e.key==='Enter') sendMsg(); };

</script>
</body>
</html>
