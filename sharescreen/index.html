<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”’ å®‰å…¨ P2P æ•™å®¤</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --safe-green: #2ecc71; --danger-red: #e74c3c; --bg: #1a1a1a; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; }
        #main-view { flex: 1; display: flex; flex-direction: column; background: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .secure-bar { background: #2c3e50; padding: 12px; display: flex; align-items: center; gap: 10px; font-size: 14px; border-bottom: 2px solid #34495e; }
        #chat-panel { width: 320px; background: #252525; display: flex; flex-direction: column; border-left: 1px solid #444; }
        #msgs { flex: 1; overflow-y: auto; padding: 15px; font-size: 13px; }
        .input-box { padding: 15px; display: flex; gap: 5px; background: #1a1a1a; }
        input { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #333; color: #fff; }
        button { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-host { background: var(--safe-green); color: white; }
        .btn-join { background: #3498db; color: white; }
        .btn-send { background: #9b59b6; color: white; }
        .badge-secure { background: rgba(46, 204, 113, 0.2); color: var(--safe-green); padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 1px solid var(--safe-green); }
        .msg { margin-bottom: 10px; line-height: 1.5; }
    </style>
</head>
<body>

<div id="main-view">
    <div class="secure-bar">
        <span class="badge-secure">ğŸ›¡ï¸ ç«¯åˆ°ç«¯åŠ å¯†å·²å•Ÿå‹•</span>
        <div style="flex:1"></div>
        <span id="my-id-display">æ­£åœ¨å»ºç«‹å®‰å…¨é‡‘é‘°...</span>
        <button class="btn-host" id="start-host">å»ºç«‹å®‰å…¨æ•™å®¤</button>
        <button id="copy-btn" style="display:none; background:#555">è¤‡è£½å®‰å…¨é€£çµ</button>
        <input type="text" id="target-id" placeholder="è²¼ä¸Šæ•™å®¤é‡‘é‘°" style="width:120px">
        <button class="btn-join" id="start-join">åŠ å…¥</button>
    </div>
    <video id="v-player" autoplay playsinline controls muted></video>
</div>

<div id="chat-panel">
    <div style="padding:15px; font-weight:bold; background:#333;">å³æ™‚å®‰å…¨å°è©±</div>
    <div id="msgs"></div>
    <div class="input-box">
        <input type="text" id="m-in" placeholder="è¼¸å…¥è¨Šæ¯...">
        <button class="btn-send" id="btn-send">å‚³é€</button>
    </div>
</div>

<script>
    // ä½¿ç”¨ Google çš„ STUN ä¼ºæœå™¨ç¢ºä¿è·¨ç¶²é€£ç·š
    const peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
    let localStream = null;
    let connPool = [];

    peer.on('open', id => {
        document.getElementById('my-id-display').innerText = `é‡‘é‘°: ${id}`;
        if(window.location.hash) document.getElementById('target-id').value = window.location.hash.substring(1);
    });

    // --- ä¸»è¬›äººå®‰å…¨æ€§é‚è¼¯ ---
    document.getElementById('start-host').onclick = async () => {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            document.getElementById('v-player').srcObject = localStream;
            document.getElementById('copy-btn').style.display = 'block';
            addLog("ç³»çµ±", "ğŸ”’ å®‰å…¨æ•™å®¤å·²å»ºç«‹ã€‚å¤–éƒ¨äººå“¡é€£å…¥é ˆç¶“éæ‚¨çš„åŒæ„ã€‚");

            // ç›£è½é€£ç·šè«‹æ±‚
            peer.on('connection', conn => {
                // å®‰å…¨æ©Ÿåˆ¶ï¼šå½ˆå‡ºå¯©æ ¸è¦–çª—
                const allow = confirm(`[å®‰å…¨æ€§è­¦å‘Š]\nç™¼ç¾æ–°çš„é€£ç·šè«‹æ±‚ (ID: ${conn.peer})\næ˜¯å¦å…è¨±å°æ–¹åŠ å…¥ä¸¦è§€çœ‹æ‚¨çš„è¢å¹•ï¼Ÿ`);
                
                if(allow) {
                    setupChat(conn);
                    peer.call(conn.peer, localStream);
                    addLog("ç³»çµ±", `âœ… å·²æˆæ¬Šçµ¦å­¸ç”Ÿ: ${conn.peer}`);
                } else {
                    conn.send("SYSTEM_REJECT");
                    setTimeout(() => conn.close(), 500);
                }
            });
        } catch (e) { alert("è«‹å…è¨±è¢å¹•åˆ†äº«æ¬Šé™ä»¥å»ºç«‹æ•™å®¤ã€‚"); }
    };

    // --- å­¸ç”Ÿé€£ç·šé‚è¼¯ ---
    document.getElementById('start-join').onclick = () => {
        const tid = document.getElementById('target-id').value;
        if(!tid) return;
        addLog("ç³»çµ±", "ğŸš€ æ­£åœ¨å‘ä¸»è¬›äººç”³è«‹é€²å…¥æ¬Šé™...");
        
        const conn = peer.connect(tid);
        setupChat(conn);

        peer.on('call', call => {
            call.answer();
            call.on('stream', stream => {
                document.getElementById('v-player').srcObject = stream;
                addLog("ç³»çµ±", "ğŸ‰ ä¸»è¬›äººå·²æ ¸å‡†ï¼åŠ å¯†é€šé“å·²å»ºç«‹ã€‚");
            });
        });
    };

    function setupChat(conn) {
        conn.off('data'); 
        conn.on('data', data => {
            if(data === "SYSTEM_REJECT") {
                addLog("ç³»çµ±", "âŒ ä¸»è¬›äººæ‹’çµ•äº†æ‚¨çš„é€£ç·šè«‹æ±‚ã€‚");
                return;
            }
            addLog("å°æ–¹", data);
        });
        if(!connPool.includes(conn)) connPool.push(conn);
    }

    function addLog(user, text) {
        const box = document.getElementById('msgs');
        const d = document.createElement('div');
        d.className = 'msg';
        d.innerHTML = `<b style="color:${user==='æˆ‘'?'#2ecc71':'#3498db'}">${user}:</b> ${text}`;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    }

    const send = () => {
        const i = document.getElementById('m-in');
        if(!i.value) return;
        connPool.forEach(c => c.open && c.send(i.value));
        addLog("æˆ‘", i.value);
        i.value = "";
    };

    document.getElementById('btn-send').onclick = send;
    document.getElementById('m-in').onkeypress = (e) => e.key==='Enter' && send();
    document.getElementById('copy-btn').onclick = () => {
        const url = `${window.location.origin}${window.location.pathname}#${peer.id}`;
        navigator.clipboard.writeText(url);
        alert("ğŸ”’ å®‰å…¨é‚€è«‹é€£çµå·²è¤‡è£½ï¼");
    };
</script>
</body>
</html>
