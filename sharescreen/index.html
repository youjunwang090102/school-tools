<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P 教學平台 v2</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; display: flex; height: 100vh; }
        #video-area { flex: 1; position: relative; display: flex; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: contain; background: #111; }
        #side-panel { width: 300px; background: #1a1a1a; display: flex; flex-direction: column; border-left: 1px solid #333; }
        .controls { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; z-index: 10; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; }
        .chat-input-area { padding: 15px; background: #222; display: flex; gap: 5px; }
        input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; }
        button { padding: 8px 12px; border-radius: 4px; border: none; background: #6200ee; color: white; cursor: pointer; }
        .msg { margin-bottom: 10px; line-height: 1.4; }
        .msg-system { color: #888; font-style: italic; }
        .msg-me { color: #03dac6; }
        .msg-other { color: #ffab40; }
    </style>
</head>
<body>

<div id="video-area">
    <div class="controls">
        <div>我的 ID: <span id="my-id">連線中...</span></div>
        <button id="btn-host" style="background: #cf6679; margin-top:5px;">開始直播螢幕</button>
        <button id="btn-copy" style="display:none;">複製教室連結</button>
    </div>
    <video id="remote-video" autoplay playsinline controls></video>
</div>

<div id="side-panel">
    <div id="chat-window">
        <div class="msg msg-system">系統：歡迎進入教室。</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="輸入訊息...">
        <button id="btn-send">傳送</button>
    </div>
</div>

<script>
    const peer = new Peer({ config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]}});
    let currentConn = null; // 用於聊天的連線
    let localStream = null;

    // 1. 初始化
    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
        // 如果網址有 Hash (#)，代表是學生點連結進來的
        if(window.location.hash) {
            const hostId = window.location.hash.substring(1);
            startJoining(hostId);
        }
    });

    // 2. 主講人邏輯：點擊直播
    document.getElementById('btn-host').addEventListener('click', async () => {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            document.getElementById('remote-video').srcObject = localStream;
            document.getElementById('btn-copy').style.display = 'inline-block';
            addLog("系統", "螢幕分享已啟動，等待學生加入...");

            // 監聽聊天的連線 (Data)
            peer.on('connection', conn => {
                currentConn = conn;
                setupChatListeners(conn);
            });

            // 監聽視訊的撥打 (Call)
            peer.on('call', call => {
                call.answer(localStream); // 把螢幕畫面丟給學生
            });
        } catch (e) { alert("無法分享螢幕: " + e); }
    });

    // 3. 學生邏輯：加入教室
    function startJoining(hostId) {
        addLog("系統", "正在連線至主講人...");
        
        // 建立聊天連線
        const conn = peer.connect(hostId);
        currentConn = conn;
        setupChatListeners(conn);

        // 建立視訊連線
        const call = peer.call(hostId, new MediaStream());
        call.on('stream', stream => {
            document.getElementById('remote-video').srcObject = stream;
            addLog("系統", "已接收到主講人畫面");
        });
    }

    // 4. 聊天通訊基礎
    function setupChatListeners(conn) {
        conn.on('open', () => addLog("系統", "聊天頻道已建立"));
        conn.on('data', data => addLog("對方", data));
    }

    document.getElementById('btn-send').addEventListener('click', sendMessage);
    document.getElementById('chat-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });

    function sendMessage() {
        const msg = document.getElementById('chat-input').value;
        if(!msg || !currentConn) return;
        currentConn.send(msg);
        addLog("我", msg);
        document.getElementById('chat-input').value = "";
    }

    function addLog(user, text) {
        const win = document.getElementById('chat-window');
        const div = document.createElement('div');
        div.className = `msg ${user === '系統' ? 'msg-system' : (user === '我' ? 'msg-me' : 'msg-other')}`;
        div.innerHTML = `<b>${user}:</b> ${text}`;
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    document.getElementById('btn-copy').addEventListener('click', () => {
        const url = window.location.origin + window.location.pathname + "#" + peer.id;
        navigator.clipboard.writeText(url);
        alert("邀請連結已複製，請傳送給學生！");
    });
</script>
</body>
</html>
