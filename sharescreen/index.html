<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”’ å°ˆæ¥­ç®¡ç†å“¡ P2P æ•™å®¤</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --danger: #ff4757; --success: #2ed573; --bg: #1e272e; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; height: 100vh; }
        #main { flex: 1; display: flex; flex-direction: column; background: #000; }
        .top-bar { background: #2f3542; padding: 12px; display: flex; gap: 10px; align-items: center; border-bottom: 2px solid #57606f; }
        #video-player { flex: 1; width: 100%; background: #000; object-fit: contain; }
        
        #right-panel { width: 320px; background: #2f3542; border-left: 1px solid #57606f; display: flex; flex-direction: column; }
        .panel-sec { flex: 1; display: flex; flex-direction: column; min-height: 200px; border-bottom: 1px solid #57606f; }
        #member-list { padding: 10px; overflow-y: auto; flex: 1; }
        #chat-window { padding: 10px; overflow-y: auto; flex: 1; background: #1e272e; }
        
        .member-item { display: flex; justify-content: space-between; align-items: center; background: #3e4451; padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; font-size: 13px; }
        .kick-btn { background: var(--danger); border: none; color: white; padding: 2px 8px; border-radius: 3px; cursor: pointer; }
        
        .input-area { padding: 10px; display: flex; gap: 5px; }
        input, button { padding: 8px; border-radius: 4px; border: none; }
        input { flex: 1; background: #57606f; color: white; }
        .btn-host { background: var(--success); color: white; font-weight: bold; cursor: pointer; }
        .btn-join { background: #1e90ff; color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="main">
    <div class="top-bar">
        <span>ä½ çš„ ID: <b id="my-id" style="color:#70a1ff">...</b></span>
        <button class="btn-host" id="btn-host">å•Ÿå‹•æ•™å®¤</button>
        <div style="flex:1"></div>
        <input type="text" id="target-id" placeholder="è¼¸å…¥ä¸»è¬›äºº ID">
        <button class="btn-join" id="btn-join">ç”³è«‹åŠ å…¥</button>
    </div>
    <video id="video-player" autoplay playsinline controls muted></video>
</div>

<div id="right-panel">
    <div class="panel-sec">
        <div style="padding:10px; background:#57606f; font-size:12px">ğŸ‘¥ åœ¨ç·šæˆå“¡</div>
        <div id="member-list"></div>
    </div>
    <div class="panel-sec">
        <div style="padding:10px; background:#57606f; font-size:12px">ğŸ’¬ èŠå¤©è¨Šæ¯</div>
        <div id="chat-window"></div>
        <div class="input-area">
            <input type="text" id="chat-in" placeholder="è¼¸å…¥è¨Šæ¯ (æ”¯æ´è‹±æ–‡)...">
            <button id="btn-send" style="background:#1e90ff; color:white">é€å‡º</button>
        </div>
    </div>
</div>

<script>
    const peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
    let localStream = null;
    let connections = {}; // å­˜æ”¾æ‰€æœ‰å­¸ç”Ÿé€£ç·š { peerId: dataConnection }
    let isHost = false;

    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
        if(window.location.hash) document.getElementById('target-id').value = window.location.hash.substring(1);
    });

    // çµ±ä¸€ç›£è½é€£ç·š (é¿å…é‡è¤‡è¨»å†Š)
    peer.on('connection', conn => {
        if(!isHost) {
            conn.on('open', () => {
                conn.send({ type: 'error', msg: 'ä¸»è¬›äººå°šæœªé–‹å•Ÿæ•™å®¤' });
                setTimeout(() => conn.close(), 1000);
            });
            return;
        }

        const allow = confirm(`å­¸ç”Ÿ ${conn.peer} ç”³è«‹åŠ å…¥ï¼Œæ˜¯å¦å…è¨±ï¼Ÿ`);
        if(allow) {
            connections[conn.peer] = conn;
            updateMemberList();
            setupChat(conn);
            peer.call(conn.peer, localStream);
            conn.on('open', () => conn.send({ type: 'sys', msg: 'ä¸»è¬›äººå·²æ‰¹å‡†æ‚¨çš„é€£ç·š' }));
        } else {
            conn.on('open', () => {
                conn.send({ type: 'error', msg: 'ä¸»è¬›äººæ‹’çµ•äº†æ‚¨çš„ç”³è«‹' });
                setTimeout(() => conn.close(), 1000);
            });
        }
    });

    peer.on('call', call => {
        call.answer();
        call.on('stream', stream => {
            document.getElementById('video-player').srcObject = stream;
            addLog("ç³»çµ±", "å·²æˆåŠŸæ¥æ”¶ä¸»è¬›äººç•«é¢");
        });
    });

    // --- æŒ‰éˆ•åŠŸèƒ½ ---
    document.getElementById('btn-host').onclick = async () => {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            document.getElementById('video-player').srcObject = localStream;
            isHost = true;
            addLog("ç³»çµ±", "æ•™å®¤å·²å•Ÿå‹•ï¼Œç¾åœ¨å¯ä»¥æ¥å—ç”³è«‹ã€‚");
        } catch (e) { alert("è«‹åˆ†äº«è¢å¹•ä»¥é–‹å•Ÿæ•™å®¤"); }
    };

    document.getElementById('btn-join').onclick = () => {
        const tid = document.getElementById('target-id').value;
        if(!tid || connections[tid]) return;
        
        addLog("ç³»çµ±", "æ­£åœ¨é€å‡ºç”³è«‹...");
        const conn = peer.connect(tid);
        setupChat(conn);
        connections[tid] = conn;
    };

    function setupChat(conn) {
        conn.on('data', data => {
            if(data.type === 'sys') addLog("ç³»çµ±", data.msg);
            else if(data.type === 'error') {
                addLog("éŒ¯èª¤", data.msg);
                delete connections[conn.peer];
            } else if(data.type === 'chat') addLog("å°æ–¹", data.msg);
            else if(data.type === 'kick') {
                alert("æ‚¨å·²è¢«ä¸»è¬›äººç§»å‡ºæ•™å®¤");
                location.reload();
            }
        });
        conn.on('close', () => {
            delete connections[conn.peer];
            updateMemberList();
            addLog("ç³»çµ±", `æˆå“¡ ${conn.peer} å·²é›¢é–‹`);
        });
    }

    function updateMemberList() {
        const list = document.getElementById('member-list');
        list.innerHTML = "";
        Object.keys(connections).forEach(pid => {
            const item = document.createElement('div');
            item.className = 'member-item';
            item.innerHTML = `<span>${pid.substring(0,8)}...</span> <button class="kick-btn" onclick="kickPeer('${pid}')">é€€å‡º</button>`;
            list.appendChild(item);
        });
    }

    window.kickPeer = (pid) => {
        if(connections[pid]) {
            connections[pid].send({ type: 'kick' });
            setTimeout(() => connections[pid].close(), 500);
            delete connections[pid];
            updateMemberList();
        }
    };

    function addLog(user, msg) {
        const win = document.getElementById('chat-window');
        const d = document.createElement('div');
        d.style.marginBottom = "8px";
        d.innerHTML = `<small>${user}:</small> <span style="word-break:break-all">${msg}</span>`;
        win.appendChild(d);
        win.scrollTop = win.scrollHeight;
    }

    function doSend() {
        const i = document.getElementById('chat-in');
        if(!i.value) return;
        Object.values(connections).forEach(c => c.open && c.send({ type: 'chat', msg: i.value }));
        addLog("æˆ‘", i.value);
        i.value = "";
    }

    document.getElementById('btn-send').onclick = doSend;
    document.getElementById('chat-in').onkeydown = (e) => { 
        if(e.key === 'Enter') { doSend(); e.preventDefault(); }
    };
</script>
</body>
</html>
