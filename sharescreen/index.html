<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>P2P 專業雲端教室</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #6200ee; --bg: #121212; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); color: white; display: flex; height: 100vh; margin: 0; }
        .main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; }
        .side-bar { width: 300px; background: #1e1e1e; border-left: 1px solid #333; display: flex; flex-direction: column; }
        video { width: 100%; border-radius: 12px; background: #000; flex-grow: 1; object-fit: contain; }
        .controls { background: #252525; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; }
        .chat-input { padding: 10px; border-top: 1px solid #333; display: flex; }
        input { background: #333; border: none; color: white; padding: 8px; border-radius: 4px; flex: 1; }
        button { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .msg { margin-bottom: 8px; }
        .msg-me { color: #03dac6; }
    </style>
</head>
<body>

<div class="main-area">
    <div class="controls">
        <span>教室 ID: <strong id="my-id">...</strong></span>
        <button onclick="copyInviteLink()">複製邀請連結</button>
        <button id="start-host" style="background:#cf6679">啟動教學模式</button>
    </div>
    <video id="main-video" autoplay playsinline controls></video>
</div>

<div class="side-bar">
    <div id="chat-msgs">
        <div class="msg">系統：教室已建立。</div>
    </div>
    <div class="chat-input">
        <input type="text" id="chat-msg" placeholder="輸入訊息...">
        <button id="send-btn">傳送</button>
    </div>
</div>

<script>
    const peer = new Peer({ config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]}});
    let activeConnections = [];
    let localStream = null;

    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
        // 檢查網址是否有 hash，有的話自動填入 (這就是自動邀請功能)
        if(window.location.hash) {
            const hostId = window.location.hash.substring(1);
            addMsg("系統", "偵測到邀請碼，準備連線...");
            joinClass(hostId);
        }
    });

    function addMsg(user, text) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b class="${user==='我'?'msg-me':''}">${user}:</b> ${text}`;
        const container = document.getElementById('chat-msgs');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function copyInviteLink() {
        const id = document.getElementById('my-id').innerText;
        const link = window.location.origin + window.location.pathname + "#" + id;
        navigator.clipboard.writeText(link);
        alert("邀請連結已複製！發送給學生即可。");
    }

    // 主講人啟動
    document.getElementById('start-host').addEventListener('click', async () => {
        localStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
        document.getElementById('main-video').srcObject = localStream;
        
        peer.on('connection', conn => { // 監聽文字連線
            setupChat(conn);
        });
        
        peer.on('call', call => { // 監聽視訊連線
            call.answer(localStream);
        });
    });

    // 學生加入
    function joinClass(hostId) {
        const conn = peer.connect(hostId);
        setupChat(conn);
        const call = peer.call(hostId, new MediaStream());
        call.on('stream', stream => {
            document.getElementById('main-video').srcObject = stream;
        });
    }

    function setupChat(conn) {
        activeConnections.push(conn);
        conn.on('data', data => addMsg("學生", data));
        conn.on('open', () => addMsg("系統", "與對方建立即時連線"));
    }

    document.getElementById('send-btn').addEventListener('click', () => {
        const val = document.getElementById('chat-msg').value;
        activeConnections.forEach(conn => conn.send(val));
        addMsg("我", val);
        document.getElementById('chat-msg').value = "";
    });
</script>
</body>
</html>
