<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæ™ºæ…§è¡Œäº‹æ›†</title>
    <style>
        :root {
            --bg-è€ƒè©¦: #fee2e2; --text-è€ƒè©¦: #dc2626;
            --bg-æé†’: #dbeafe; --text-æé†’: #2563eb;
            --bg-é›†æœƒ: #dcfce7; --text-é›†æœƒ: #16a34a;
            --bg-è£œèª²: #ffedd5; --text-è£œèª²: #ea580c;
            --bg-ç¤¾åœ˜: #fef9c3; --text-ç¤¾åœ˜: #ca8a04;
            --primary: #4361ee;
        }
        body { font-family: sans-serif; background: #f8fafc; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* æœˆæ›†æ¨£å¼ */
        .calendar-card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .weekday { text-align: center; font-size: 12px; color: #94a3b8; padding: 5px 0; }
        
        .day-cell { 
            min-height: 70px; border: 1px solid #f1f5f9; padding: 4px; 
            display: flex; flex-direction: column; gap: 2px; cursor: pointer;
        }
        .day-num { font-size: 12px; font-weight: bold; color: #64748b; }
        .today { background: #f0f4ff; border: 2px solid var(--primary); }

        /* è¡Œç¨‹è‰²å¡Šæ¨™ç±¤ */
        .event-tag {
            font-size: 10px; padding: 2px 4px; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            line-height: 1.2; font-weight: 500;
        }
        .tag-è€ƒè©¦ { background: var(--bg-è€ƒè©¦); color: var(--text-è€ƒè©¦); }
        .tag-æé†’ { background: var(--bg-æé†’); color: var(--text-æé†’); }
        .tag-é›†æœƒ { background: var(--bg-é›†æœƒ); color: var(--text-é›†æœƒ); }
        .tag-è£œèª² { background: var(--bg-è£œèª²); color: var(--text-è£œèª²); }
        .tag-ç¤¾åœ˜ { background: var(--bg-ç¤¾åœ˜); color: var(--text-ç¤¾åœ˜); }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; padding: 20px; }
        .modal-content { background: white; border-radius: 15px; padding: 20px; max-width: 400px; margin: auto; }
        .v-input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; }
        .btn { padding: 10px; border-radius: 8px; border: none; cursor: pointer; width: 100%; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; margin-top: 10px; }
        .btn-delete { background: #fee2e2; color: #dc2626; margin-top: 5px; }
        
        .admin-controls { display: none; margin-top: 10px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 8px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <button onclick="changeMonth(-1)">â—€</button>
        <h2 id="monthTitle"></h2>
        <button onclick="changeMonth(1)">â–¶</button>
    </div>

    <div class="calendar-card">
        <div class="grid" id="calendarGrid"></div>
        <button id="adminLoginBtn" onclick="loginAdmin()" style="width:100%; background:none; border:none; color:#cbd5e1; margin-top:15px; font-size:12px;">ç®¡ç†å“¡ç™»å…¥</button>
    </div>
</div>

<div id="eventModal" class="modal">
    <div class="modal-content">
        <h3 id="modalDateTitle"></h3>
        <div id="existingEvents"></div>
        
        <div class="admin-controls" id="adminForm">
            <hr>
            <input type="hidden" id="editId">
            <input type="text" id="evTitle" class="v-input" placeholder="äº‹é …åç¨±">
            <select id="evType" class="v-input">
                <option value="è€ƒè©¦">ğŸ”´ è€ƒè©¦</option>
                <option value="æé†’">ğŸ”µ æé†’</option>
                <option value="é›†æœƒ">ğŸŸ¢ é›†æœƒ</option>
                <option value="è£œèª²">ğŸŸ  è£œèª²/è¼”å°</option>
                <option value="ç¤¾åœ˜">ğŸŸ¡ ç¤¾åœ˜</option>
            </select>
            <button class="btn btn-primary" onclick="saveEvent()">ç¢ºèªå„²å­˜</button>
        </div>
        <button class="btn" onclick="closeModal()" style="background:#eee; margin-top:10px;">é—œé–‰</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentView = new Date();
    let allEvents = [];
    let isAdmin = false;

    // ç›£è½è³‡æ–™
    db.collection("calendar_events").onSnapshot(snap => {
        allEvents = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        render();
    });

    function render() {
        const grid = document.getElementById('calendarGrid');
        const title = document.getElementById('monthTitle');
        grid.innerHTML = "";
        
        const year = currentView.getFullYear();
        const month = currentView.getMonth();
        title.innerText = `${year}å¹´ ${month + 1}æœˆ`;

        // æ˜ŸæœŸæ¨™é ­
        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => grid.innerHTML += `<div class="weekday">${d}</div>`);

        const firstDay = new Date(year, month, 1).getDay();
        const totalDays = new Date(year, month + 1, 0).getDate();

        // å¡«å……ç©ºæ ¼
        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

        // å¡«å……æ—¥æœŸ
        for(let d=1; d<=totalDays; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isToday = new Date().toISOString().split('T')[0] === dateStr;
            const dayEvents = allEvents.filter(e => e.date === dateStr);

            let eventHtml = dayEvents.map(e => `<div class="event-tag tag-${e.type || 'æé†’'}">${e.title}</div>`).join('');
            
            grid.innerHTML += `
                <div class="day-cell ${isToday?'today':''}" onclick="openDay('${dateStr}')">
                    <span class="day-num">${d}</span>
                    ${eventHtml}
                </div>`;
        }
    }

    function openDay(date) {
        document.getElementById('modalDateTitle').innerText = date;
        document.getElementById('editId').value = ""; // æ¸…ç©ºç·¨è¼¯ ID
        document.getElementById('evTitle').value = "";
        
        const dayEvents = allEvents.filter(e => e.date === date);
        const listDiv = document.getElementById('existingEvents');
        
        listDiv.innerHTML = dayEvents.map(e => `
            <div class="item-row">
                <span>[${e.type}] ${e.title}</span>
                ${isAdmin ? `<div>
                    <button onclick="editEvent('${e.id}')" style="color:blue; border:none; background:none; cursor:pointer;">ç·¨</button>
                    <button onclick="deleteEvent('${e.id}')" style="color:red; border:none; background:none; cursor:pointer;">åˆª</button>
                </div>` : ''}
            </div>
        `).join('') || 'æœ¬æ—¥ç„¡è¡Œç¨‹';

        if(isAdmin) document.getElementById('adminForm').style.display = 'block';
        document.getElementById('eventModal').style.display = 'block';
    }

    function loginAdmin() {
        const pass = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
        if(pass === "Admin88888") {
            isAdmin = true;
            document.getElementById('adminLoginBtn').innerText = "âœ… ç®¡ç†å“¡æ¨¡å¼å·²é–‹å•Ÿ";
            render();
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤");
        }
    }

    async function saveEvent() {
        const title = document.getElementById('evTitle').value;
        const type = document.getElementById('evType').value;
        const date = document.getElementById('modalDateTitle').innerText;
        const editId = document.getElementById('editId').value;

        if(!title) return alert("è«‹è¼¸å…¥å…§å®¹");

        if(editId) {
            await db.collection("calendar_events").doc(editId).update({ title, type });
        } else {
            await db.collection("calendar_events").add({ title, type, date, createdAt: Date.now() });
        }
        closeModal();
    }

    async function editEvent(id) {
        const ev = allEvents.find(e => e.id === id);
        document.getElementById('evTitle').value = ev.title;
        document.getElementById('evType').value = ev.type || 'æé†’';
        document.getElementById('editId').value = id;
    }

    async function deleteEvent(id) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) {
            await db.collection("calendar_events").doc(id).delete();
            closeModal();
        }
    }

    function closeModal() { document.getElementById('eventModal').style.display = 'none'; }
    function changeMonth(n) { currentView.setMonth(currentView.getMonth() + n); render(); }

    render();
</script>
</body>
</html>
