<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Calendar Pro</title>
    <style>
        :root {
            --ios-blue: #007AFF; --ios-red: #FF3B30; --ios-green: #34C759;
            --ios-orange: #FF9500; --ios-yellow: #FFCC00; --ios-gray: #8E8E93;
            --bg: #F2F2F7;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #000; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 500px; margin: 0 auto; }

        /* iOS Widget é¢¨æ ¼ */
        .widget-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .ios-widget { background: white; border-radius: 20px; padding: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); min-height: 100px; }
        .ios-widget h3 { margin: 0 0 8px 0; font-size: 12px; color: var(--ios-gray); letter-spacing: -0.2px; text-transform: uppercase; font-weight: 600; }
        .widget-item { font-size: 13px; font-weight: 500; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
        .dot-s { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }

        /* æœˆæ›†ä¸»é«” */
        .calendar-card { background: white; border-radius: 24px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .cal-header h2 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        .nav-btns button { background: #E9E9EB; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; color: var(--ios-blue); font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #F2F2F7; border-radius: 12px; overflow: hidden; border: 1px solid #F2F2F7; }
        .weekday { background: white; text-align: center; font-size: 11px; font-weight: 600; color: var(--ios-gray); padding: 8px 0; }
        
        .day-cell { 
            background: white; min-height: 65px; position: relative; padding: 4px;
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
        }
        .day-num { font-size: 14px; font-weight: 500; margin-bottom: 2px; }
        .today .day-num { background: var(--ios-red); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* è—¥ä¸¸å‹è‰²å¡Šæ¨™ç±¤ */
        .event-pill {
            width: 95%; font-size: 9px; padding: 1px 3px; border-radius: 4px; margin-top: 1px;
            color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; line-height: 1.2;
        }
        .bg-è€ƒè©¦ { background-color: var(--ios-red); }
        .bg-æé†’ { background-color: var(--ios-blue); }
        .bg-é›†æœƒ { background-color: var(--ios-green); }
        .bg-è£œèª² { background-color: var(--ios-orange); }
        .bg-ç¤¾åœ˜ { background-color: var(--ios-yellow); color: #000; }

        /* iOS å½ˆçª—èˆ‡æ¯›ç»ç’ƒ */
        .ios-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 999; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .ios-modal-content { background: rgba(255,255,255,0.92); border-radius: 24px; width: 88%; max-width: 360px; margin: 15vh auto; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .ios-input { width: 100%; border: none; background: #E9E9EB; padding: 14px; border-radius: 12px; margin: 8px 0; box-sizing: border-box; font-size: 16px; }
        .ios-btn { width: 100%; padding: 14px; border: none; border-radius: 14px; font-size: 17px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-blue { background: var(--ios-blue); color: white; }
        .btn-cancel { background: transparent; color: var(--ios-blue); }
        
        .admin-action { font-size: 13px; font-weight: bold; margin-left: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="secretTitle" onclick="triggerAdmin()" style="font-size: 32px; font-weight: 800; letter-spacing: -1.5px; margin: 10px 0 20px 5px; user-select: none;">è¡Œäº‹æ›†</h1>

    <div class="widget-row">
        <div class="ios-widget">
            <h3>æœ¬é€±å¾…è¾¦</h3>
            <div id="widget-week"></div>
        </div>
        <div class="ios-widget">
            <h3>10æ—¥é å‘Š</h3>
            <div id="widget-10days"></div>
        </div>
    </div>

    <div class="calendar-card">
        <div class="cal-header">
            <h2 id="monthTitle">2026å¹´ 2æœˆ</h2>
            <div class="nav-btns">
                <button onclick="changeMonth(-1)">ã</button>
                <button onclick="changeMonth(1)">ã€‰</button>
            </div>
        </div>
        <div class="grid" id="calendarGrid"></div>
    </div>
</div>

<div id="iosModal" class="ios-modal">
    <div class="ios-modal-content">
        <h3 id="modalDate" style="margin:0 0 15px 0; font-size: 20px; font-weight: 700;">æ—¥æœŸ</h3>
        <div id="dayList" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
        
        <div id="adminForm" style="display:none; margin-top:15px; border-top: 0.5px solid #D1D1D6; padding-top:15px;">
            <input type="hidden" id="editId">
            <input type="text" id="evTitle" class="ios-input" placeholder="è¦åšä»€éº¼äº‹ï¼Ÿ">
            <select id="evType" class="ios-input">
                <option value="è€ƒè©¦">ğŸ”´ è€ƒè©¦</option>
                <option value="æé†’">ğŸ”µ æé†’</option>
                <option value="é›†æœƒ">ğŸŸ¢ é›†æœƒ</option>
                <option value="è£œèª²">ğŸŸ  è£œèª²/è¼”å°</option>
                <option value="ç¤¾åœ˜">ğŸŸ¡ ç¤¾åœ˜</option>
            </select>
            <button class="ios-btn btn-blue" id="saveBtn" onclick="saveEvent()">åŠ å…¥è¡Œç¨‹</button>
        </div>
        <button class="ios-btn btn-cancel" onclick="closeModal()">é—œé–‰</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentView = new Date();
    let allEvents = [];
    let isAdmin = false;
    let clickCount = 0;

    // éš±è—å…¥å£é‚è¼¯ï¼šé€£é»æ¨™é¡Œ 5 ä¸‹
    function triggerAdmin() {
        clickCount++;
        if (clickCount === 5) {
            const pass = prompt("è«‹è¼¸å…¥æ¬Šé™å¯†ç¢¼");
            if(pass === "Admin88888") {
                isAdmin = true;
                alert("ç®¡ç†æ¨¡å¼å·²å•Ÿå‹•");
                render();
            }
            clickCount = 0;
        }
        // 3ç§’å¾Œé‡ç½®è¨ˆæ•¸ï¼Œé˜²æ­¢èª¤è§¸ç´¯ç©
        setTimeout(() => clickCount = 0, 3000);
    }

    db.collection("calendar_events").onSnapshot(snap => {
        allEvents = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        render();
    });

    function render() {
        const now = new Date();
        now.setHours(0,0,0,0);
        
        // Widgets é‚è¼¯
        const sat = new Date(now);
        sat.setDate(now.getDate() + (6 - now.getDay()));
        sat.setHours(23,59,59,999);
        const tenD = new Date(now);
        tenD.setDate(now.getDate() + 10);

        const buildList = (start, end) => {
            return allEvents.filter(e => {
                const d = new Date(e.date);
                return d >= start && d <= end;
            }).sort((a,b) => a.date.localeCompare(b.date)).map(e => `
                <div class="widget-item">
                    <div class="dot-s bg-${e.type}"></div>
                    <span style="font-size:10px; color:var(--ios-gray);">${e.date.substring(5).replace('-','/')}</span>
                    <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${e.title}</span>
                </div>`).join('') || '<span style="color:#C7C7CC; font-size:11px;">ç„¡äº‹é …</span>';
        };

        document.getElementById('widget-week').innerHTML = buildList(now, sat);
        document.getElementById('widget-10days').innerHTML = buildList(now, tenD);

        // Calendar é‚è¼¯
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        const yr = currentView.getFullYear();
        const mo = currentView.getMonth();
        document.getElementById('monthTitle').innerText = `${yr}å¹´ ${mo + 1}æœˆ`;

        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => grid.innerHTML += `<div class="weekday">${d}</div>`);
        const first = new Date(yr, mo, 1).getDay();
        const last = new Date(yr, mo + 1, 0).getDate();

        for(let i=0; i<first; i++) grid.innerHTML += `<div class="day-cell" style="background:#F9F9FB;"></div>`;
        for(let d=1; d<=last; d++) {
            const dateStr = `${yr}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const todayStr = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD
            const isToday = todayStr === dateStr;
            const dayEvents = allEvents.filter(e => e.date === dateStr);

            grid.innerHTML += `
                <div class="day-cell ${isToday?'today':''}" onclick="openDay('${dateStr}')">
                    <span class="day-num">${d}</span>
                    ${dayEvents.map(e => `<div class="event-pill bg-${e.type}">${e.title}</div>`).join('')}
                </div>`;
        }
    }

    function openDay(date) {
        document.getElementById('modalDate').innerText = date;
        document.getElementById('editId').value = "";
        document.getElementById('evTitle').value = "";
        document.getElementById('saveBtn').innerText = "åŠ å…¥è¡Œç¨‹";
        
        const dayEvents = allEvents.filter(e => e.date === date);
        document.getElementById('dayList').innerHTML = dayEvents.map(e => `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <span style="font-size:16px;"><b>â€¢</b> ${e.title}</span>
                ${isAdmin ? `<div>
                    <span class="admin-action" style="color:var(--ios-blue)" onclick="editE('${e.id}')">ç·¨è¼¯</span>
                    <span class="admin-action" style="color:var(--ios-red)" onclick="delE('${e.id}')">åˆªé™¤</span>
                </div>` : ''}
            </div>`).join('') || '<p style="color:var(--ios-gray)">æœ¬æ—¥å°šç„¡æ’å®šäº‹é …</p>';
        
        document.getElementById('adminForm').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('iosModal').style.display = 'block';
    }

    async function saveEvent() {
        const title = document.getElementById('evTitle').value;
        const type = document.getElementById('evType').value;
        const date = document.getElementById('modalDate').innerText;
        const id = document.getElementById('editId').value;
        if(!title) return;
        id ? await db.collection("calendar_events").doc(id).update({title, type}) :
             await db.collection("calendar_events").add({title, type, date, createdAt: Date.now()});
        closeModal();
    }

    function editE(id) {
        const e = allEvents.find(x => x.id === id);
        document.getElementById('evTitle').value = e.title;
        document.getElementById('evType').value = e.type;
        document.getElementById('editId').value = id;
        document.getElementById('saveBtn').innerText = "æ›´æ–°è¡Œç¨‹";
    }

    async function delE(id) {
        if(confirm("ç¢ºå®šè¦ç§»é™¤å—ï¼Ÿ")) {
            await db.collection("calendar_events").doc(id).delete();
            closeModal();
        }
    }

    function closeModal() { document.getElementById('iosModal').style.display = 'none'; }
    function changeMonth(n) { currentView.setMonth(currentView.getMonth() + n); render(); }

    render();
</script>
</body>
</html>
