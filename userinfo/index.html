<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå¹³å° - æ ¸å¿ƒç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; color: #333; }
        .page { display: none; padding: 20px; max-width: 900px; margin: auto; animation: fadeIn 0.4s ease; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e0e0e0; border-radius: 12px; box-sizing: border-box; }
        .btn { border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        .nav-header { background: white; padding: 15px 25px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); display: none; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .stu-item { border-bottom: 1px solid #f0f0f0; padding: 15px 10px; }
        .stu-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .details { display: none; padding: 20px; background: #f9f9f9; border-radius: 15px; margin-top: 10px; border: 1px solid #eee; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-pending { background: #fff1f0; color: var(--d); }
        .badge-active { background: #e6fffa; color: var(--s); }
        .role-tag { display: inline-block; background: #eef2ff; color: var(--p); padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; margin: 2px; }
    </style>
</head>
<body>

    <div id="nav" class="nav-header">
        <b id="userLabel">ä½¿ç”¨è€…</b>
        <button class="btn" style="width:auto; margin:0; padding: 8px 15px;" onclick="location.reload()">ç™»å‡º</button>
    </div>

    <div id="page-auth" class="page active-page">
        <div class="card" id="login-box" style="max-width: 400px; margin: 50px auto;">
            <h2 style="text-align:center;">ğŸ”‘ ç­ç´šå¹³å°ç™»å…¥</h2>
            <input type="number" id="l-id" placeholder="åº§è™Ÿ (ä¾‹å¦‚ 05)">
            <input type="password" id="l-pw" placeholder="ç™»å…¥å¯†ç¢¼">
            <button class="btn btn-p" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
            <button class="btn" style="background:none; color:var(--p)" onclick="toggleAuth(false)">æ–°åŒå­¸è¨»å†Š</button>
        </div>

        <div class="card" id="reg-box" style="display:none; max-width: 400px; margin: 50px auto;">
            <h2 style="text-align:center;">ğŸ“ ç”³è«‹å…¥ç­</h2>
            <input type="text" id="r-class" placeholder="ç­ç´š">
            <input type="number" id="r-id" placeholder="åº§è™Ÿ">
            <input type="text" id="r-name" placeholder="å§“å">
            <select id="r-gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <input type="password" id="r-pw" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn btn-s" onclick="doRegister()">é€å‡ºç”³è«‹</button>
            <button class="btn" style="background:none; color:var(--p)" onclick="toggleAuth(true)">è¿”å›ç™»å…¥</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <div class="card">
            <h3>ğŸ‘¤ å€‹äººè³‡æ–™</h3>
            <input type="text" id="p-basic" disabled>
            <div id="p-roles-container" style="padding: 10px 0;"></div>
            <hr>
            <label>æ€§åˆ¥</label>
            <select id="p-gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <label>ä¿®æ”¹å¯†ç¢¼ (ä¸æ”¹è«‹ç•™ç©º)</label>
            <input type="password" id="p-newpw">
            <button class="btn btn-p" onclick="updateProfile()">å„²å­˜ä¿®æ”¹</button>
        </div>
    </div>

    <div id="page-admin" class="page">
        <div class="card" style="border-left: 5px solid var(--d);">
            <h3>â³ å¾…æ‰¹å‡†åå–® (<span id="count-pending">0</span>)</h3>
            <div id="list-pending"></div>
        </div>
        <div class="card">
            <h3>ğŸ‘¥ å…¨ç­åå–® (<span id="count-all">0</span>)</h3>
            <div id="list-all"></div>
        </div>
    </div>

    <script>
        // --- Firebase é…ç½® ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let me = null;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-' + pageId).classList.add('active-page');
            document.getElementById('nav').style.display = (pageId === 'auth') ? 'none' : 'flex';
        }

        function toggleAuth(showLogin) {
            document.getElementById('login-box').style.display = showLogin ? 'block' : 'none';
            document.getElementById('reg-box').style.display = showLogin ? 'none' : 'block';
        }

        // --- æ ¸å¿ƒï¼šç™»å…¥æª¢æŸ¥ (é€£å‹• status = active) ---
        async function doLogin() {
            const id = document.getElementById('l-id').value.padStart(2, '0');
            const pw = document.getElementById('l-pw').value;
            
            const doc = await db.collection("students").doc(id).get();
            if (doc.exists && doc.data().password === pw) {
                const data = doc.data();
                const isStaff = (data.role === 'teacher' || data.role === 'admin');
                
                // æª¢æŸ¥æ˜¯å¦ç‚º active ç‹€æ…‹
                if (!isStaff && data.status !== "active") {
                    return alert("æ‚¨çš„å¸³è™Ÿå°šæœªè¢«æ‰¹å‡† (status éœ€ç‚º active)ï¼Œè«‹è¯ç¹«å°å¸«ã€‚");
                }

                me = { id, ...data };
                document.getElementById('userLabel').innerText = `${me.name} (${id})`;

                if (isStaff) { startAdminListener(); showPage('admin'); }
                else { 
                    const roles = await fetchRoles(id);
                    me.roles = roles;
                    fillProfile(); 
                    showPage('profile'); 
                }
            } else { alert("åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
        }

        async function doRegister() {
            const id = document.getElementById('r-id').value.padStart(2, '0');
            const data = {
                class: document.getElementById('r-class').value,
                name: document.getElementById('r-name').value,
                gender: document.getElementById('r-gender').value,
                password: document.getElementById('r-pw').value,
                status: "pending", // åˆå§‹ç‹€æ…‹
                role: "student"
            };
            await db.collection("students").doc(id).set(data);
            alert("è¨»å†Šç”³è«‹å·²é€å‡ºï¼Œè«‹ç­‰å¾… status æ”¹ç‚º active å¾Œå†è¡Œç™»å…¥ã€‚");
            location.reload();
        }

        async function fetchRoles(id) {
            const doc = await db.collection("subject_roles").doc(id).get();
            if (doc.exists) return doc.data().roles || [];
            return ["ä¸€èˆ¬å­¸ç”Ÿ"];
        }

        function fillProfile() {
            document.getElementById('p-basic').value = `${me.class} / ${me.id}è™Ÿ / ${me.name}`;
            document.getElementById('p-roles-container').innerHTML = me.roles.map(r => `<span class="role-tag">${r}</span>`).join('');
            document.getElementById('p-gender').value = me.gender;
        }

        async function updateProfile() {
            const newPw = document.getElementById('p-newpw').value;
            const updates = { gender: document.getElementById('p-gender').value };
            if (newPw) updates.password = newPw;
            await db.collection("students").doc(me.id).update(updates);
            alert("æ›´æ–°æˆåŠŸ");
        }

        // --- ç®¡ç†å¾Œå°ï¼šé€£å‹• subject_roles èˆ‡ç‹€æ…‹ä¿®å¾© ---
        async function startAdminListener() {
            // é æŠ“è·å‹™å°ç…§è¡¨
            const roleSnap = await db.collection("subject_roles").get();
            const roleMap = {};
            roleSnap.forEach(doc => roleMap[doc.id] = doc.data().roles || []);

            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
                const pList = document.getElementById('list-pending');
                const aList = document.getElementById('list-all');
                pList.innerHTML = ""; aList.innerHTML = "";
                let pCount = 0; let aCount = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    const id = doc.id;
                    const roles = roleMap[id] || ["ä¸€èˆ¬å­¸ç”Ÿ"];
                    
                    // è‡ªå‹•ä¿®å¾©ï¼šå¦‚æœ status éºå¤±æˆ–é pending å‰‡è‡ªå‹•æ ¡æ­£ç‚º active
                    if (!d.status) {
                        db.collection("students").doc(id).update({ status: "active" });
                    }

                    const isPending = d.status === "pending";
                    const item = document.createElement('div');
                    item.className = 'stu-item';
                    item.innerHTML = `
                        <div class="stu-header" onclick="document.getElementById('det-${id}').style.display='block'">
                            <span><b>${id} ${d.name}</b> ${roles.map(r => `<small class="role-tag">${r}</small>`).join('')}</span>
                            <span class="badge ${isPending?'badge-pending':'badge-active'}">${isPending?'å¾…æ‰¹å‡†':'Active'}</span>
                        </div>
                        <div id="det-${id}" class="details" style="display:none">
                            <p>ç­ç´šï¼š${d.class} | æ€§åˆ¥ï¼š${d.gender}</p>
                            <label>ä¿®æ”¹è·å‹™ (é€—è™Ÿéš”é–‹)</label>
                            <input type="text" id="edit-role-${id}" value="${roles.join(', ')}">
                            <button class="btn btn-s" style="width:auto; margin-bottom:10px" onclick="updateAdminRole('${id}')">åŒæ­¥è·ä½</button>
                            <div style="display:flex; gap:10px; border-top:1px solid #ddd; padding-top:10px;">
                                ${isPending ? `<button class="btn btn-s" onclick="adminAction('${id}','active')">æ‰¹å‡†å…¥ç­ (Active)</button>` : ''}
                                <button class="btn btn-d" onclick="adminAction('${id}','delete')">åˆªé™¤</button>
                                <button class="btn" style="background:#888; color:white" onclick="document.getElementById('det-${id}').style.display='none'">æ”¶åˆ</button>
                            </div>
                        </div>
                    `;
                    if(isPending) { pList.appendChild(item); pCount++; }
                    else { aList.appendChild(item); aCount++; }
                });
                document.getElementById('count-pending').innerText = pCount;
                document.getElementById('count-all').innerText = aCount;
            });
        }

        async function updateAdminRole(id) {
            const val = document.getElementById(`edit-role-${id}`).value;
            const roles = val.split(',').map(r => r.trim()).filter(r => r !== "");
            await db.collection("subject_roles").doc(id).set({ roles: roles }, { merge: true });
            alert("è·ä½å·²åŒæ­¥åˆ°è³‡æ–™åº«");
            location.reload(); // é‡æ–°æ•´ç†ä»¥åæ˜ è·å‹™è®Šæ›´
        }

        async function adminAction(id, type) {
            if (type === 'active') await db.collection("students").doc(id).update({ status: 'active' });
            if (type === 'delete') if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await db.collection("students").doc(id).delete();
        }
    </script>
</body>
</html>
