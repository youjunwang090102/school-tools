<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå¹³å° - æ ¸å¿ƒç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --w: #ff9f1c; --bg: #f4f7fe; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        .page { display: none; padding: 20px; max-width: 900px; margin: auto; animation: fadeIn 0.4s ease; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }
        h2, h3 { color: var(--p); margin-top: 0; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e0e0e0; border-radius: 12px; box-sizing: border-box; font-size: 1rem; transition: 0.3s; }
        input:focus { border-color: var(--p); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
        input:disabled { background: #f8f9fa; color: #999; cursor: not-allowed; border: 1px dashed #ccc; }
        
        .btn { border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; font-size: 1rem; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        .btn-p:hover, .btn-s:hover { filter: brightness(1.1); transform: translateY(-1px); }

        .nav-header { background: white; padding: 15px 25px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); display: none; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        
        /* ç®¡ç†åˆ—è¡¨æ¨£å¼ */
        .stu-item { border-bottom: 1px solid #f0f0f0; padding: 15px 10px; transition: 0.2s; }
        .stu-item:hover { background: #fafbff; }
        .stu-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .details { display: none; padding: 20px; background: #f9f9f9; border-radius: 15px; margin-top: 10px; border: 1px solid #eee; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-pending { background: #fff1f0; color: var(--d); }
        .badge-approved { background: #e6fffa; color: var(--s); }
        
        .role-tag { display: inline-block; background: #eef2ff; color: var(--p); padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; margin: 2px; }
        .meta { font-size: 0.75rem; color: #aaa; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="nav" class="nav-header">
        <b id="userLabel">Loading...</b>
        <button class="btn" style="width:auto; margin:0; padding: 8px 15px;" onclick="location.reload()">å®‰å…¨ç™»å‡º</button>
    </div>

    <div id="page-auth" class="page active-page">
        <div class="card" id="login-box" style="max-width: 400px; margin: 50px auto;">
            <h2 style="text-align:center;">ğŸ”‘ ç­ç´šå¹³å°ç™»å…¥</h2>
            <input type="number" id="l-id" placeholder="åº§è™Ÿ (ä¾‹å¦‚ 01)">
            <input type="password" id="l-pw" placeholder="ç™»å…¥å¯†ç¢¼">
            <button class="btn btn-p" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
            <button class="btn" style="background:none; color:var(--p)" onclick="toggleAuth(false)">æ–°åŒå­¸è¨»å†Šç”³è«‹</button>
        </div>

        <div class="card" id="reg-box" style="display:none; max-width: 400px; margin: 50px auto;">
            <h2 style="text-align:center;">ğŸ“ è¨»å†Šç”³è«‹</h2>
            <input type="text" id="r-class" placeholder="ç­ç´š (ä¾‹å¦‚ 301)">
            <input type="number" id="r-id" placeholder="åº§è™Ÿ">
            <input type="text" id="r-name" placeholder="çœŸå¯¦å§“å">
            <select id="r-gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <input type="password" id="r-pw" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn btn-s" onclick="doRegister()">é€å‡ºå¯©æ ¸</button>
            <button class="btn" style="background:none; color:var(--p)" onclick="toggleAuth(true)">è¿”å›ç™»å…¥</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <div class="card">
            <h3>ğŸ‘¤ å€‹äººè³‡æ–™ (å”¯è®€)</h3>
            <label style="font-size:0.8rem; color:#888;">åŸºæœ¬è³‡è¨Š</label>
            <input type="text" id="p-basic" disabled>
            <label style="font-size:0.8rem; color:#888;">ç›®å‰è·å‹™ (ç”±è€å¸«æŒ‡æ´¾)</label>
            <div id="p-roles-container" style="padding: 10px 0;"></div>
            
            <h3 style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">âš™ï¸ å¸³æˆ¶ä¿®æ”¹</h3>
            <label>æ€§åˆ¥</label>
            <select id="p-gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <label>è®Šæ›´å¯†ç¢¼ (å¦‚ä¸ä¿®æ”¹è«‹ç•™ç©º)</label>
            <input type="password" id="p-newpw" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
            <button class="btn btn-p" onclick="updateProfile()">ç¢ºèªå„²å­˜ä¿®æ”¹</button>
            <div class="meta">æœ€å¾Œç™»å…¥æ™‚é–“ï¼š<span id="p-lastLogin">---</span></div>
        </div>
    </div>

    <div id="page-admin" class="page">
        <div class="card" style="border-left: 5px solid var(--d);">
            <h3>â³ å¾…æ‰¹å‡†åå–® (<span id="count-pending">0</span>)</h3>
            <div id="list-pending"></div>
        </div>
        
        <div class="card">
            <h3>ğŸ‘¥ å…¨ç­å­¸ç”Ÿç®¡ç† (<span id="count-all">0</span>)</h3>
            <div id="list-all"></div>
        </div>
    </div>

    <script>
        // --- Firebase é…ç½® ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let me = null;

        // --- ä»‹é¢å·¥å…· ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-' + pageId).classList.add('active-page');
            document.getElementById('nav').style.display = (pageId === 'auth') ? 'none' : 'flex';
        }

        function toggleAuth(showLogin) {
            document.getElementById('login-box').style.display = showLogin ? 'block' : 'none';
            document.getElementById('reg-box').style.display = showLogin ? 'none' : 'block';
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šåŒæ­¥è·å‹™ ---
        async function getSyncedRoles(id) {
            try {
                const doc = await db.collection("subject_roles").doc(id).get();
                if (doc.exists) {
                    const data = doc.data();
                    // æ”¯æ´å¤šè·ä½ï¼šå¯ä»¥æ˜¯é™£åˆ— roles:[] æˆ–æ˜¯å­—ä¸² role:""
                    if (Array.isArray(data.roles)) return data.roles;
                    if (data.role) return [data.role];
                    if (data.title) return [data.title];
                }
            } catch (e) { console.error("è·å‹™åŒæ­¥éŒ¯èª¤", e); }
            return ["ä¸€èˆ¬å­¸ç”Ÿ"];
        }

        // --- ç™»å…¥ ---
        async function doLogin() {
            const id = document.getElementById('l-id').value.padStart(2, '0');
            const pw = document.getElementById('l-pw').value;
            
            try {
                const doc = await db.collection("students").doc(id).get();
                if (doc.exists && doc.data().password === pw) {
                    const data = doc.data();
                    const roles = await getSyncedRoles(id);
                    
                    // æ¬Šé™åˆ¤æ–·
                    const isStaff = (data.role === 'teacher' || data.role === 'admin');
                    if (!isStaff && data.status !== "approved") {
                        return alert("æ‚¨çš„å¸³è™Ÿå°šæœªé€šéå¯©æ ¸ï¼Œè«‹ç­‰å€™å°å¸«æ‰¹å‡†ã€‚");
                    }

                    me = { id, ...data, roles };
                    document.getElementById('userLabel').innerText = `${me.name} (${id})`;
                    
                    // ç´€éŒ„æœ€å¾Œç™»å…¥
                    await db.collection("students").doc(id).update({ 
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp() 
                    });

                    if (isStaff) {
                        startAdminListener();
                        showPage('admin');
                    } else {
                        fillProfile();
                        showPage('profile');
                    }
                } else { alert("åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
            } catch (e) { alert("ç³»çµ±éŒ¯èª¤: " + e.message); }
        }

        // --- è¨»å†Š ---
        async function doRegister() {
            const id = document.getElementById('r-id').value.padStart(2, '0');
            const data = {
                class: document.getElementById('r-class').value,
                name: document.getElementById('r-name').value,
                gender: document.getElementById('r-gender').value,
                password: document.getElementById('r-pw').value,
                status: "pending",
                role: "student",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            if(!id || !data.name || !data.password) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            await db.collection("students").doc(id).set(data);
            alert("ç”³è«‹å·²é€å‡ºï¼è«‹é€šçŸ¥å°å¸«å¯©æ ¸ã€‚");
            location.reload();
        }

        // --- å­¸ç”Ÿæ›´æ–°å€‹è³‡ ---
        function fillProfile() {
            document.getElementById('p-basic').value = `${me.class} / ${me.id}è™Ÿ / ${me.name}`;
            document.getElementById('p-gender').value = me.gender;
            const container = document.getElementById('p-roles-container');
            container.innerHTML = me.roles.map(r => `<span class="role-tag">${r}</span>`).join('');
            document.getElementById('p-lastLogin').innerText = me.lastLogin ? me.lastLogin.toDate().toLocaleString() : "ç¬¬ä¸€æ¬¡ç™»å…¥";
        }

        async function updateProfile() {
            const newPw = document.getElementById('p-newpw').value;
            const updates = { 
                gender: document.getElementById('p-gender').value,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };
            if (newPw) updates.password = newPw;
            await db.collection("students").doc(me.id).update(updates);
            alert("æ›´æ–°æˆåŠŸï¼");
        }

        // --- ç®¡ç†å“¡å¯¦æ™‚ç›£è½ ---
        function startAdminListener() {
            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(async (snap) => {
                const pList = document.getElementById('list-pending');
                const aList = document.getElementById('list-all');
                pList.innerHTML = ""; aList.innerHTML = "";
                let pCount = 0; let aCount = 0;

                for (const doc of snap.docs) {
                    const d = doc.data();
                    const id = doc.id;
                    const roles = await getSyncedRoles(id);
                    const isP = d.status === 'pending';

                    const item = document.createElement('div');
                    item.className = 'stu-item';
                    item.innerHTML = `
                        <div class="stu-header" onclick="document.getElementById('det-${id}').style.display = document.getElementById('det-${id}').style.display==='block'?'none':'block'">
                            <span><b>${id} ${d.name}</b> ${roles.map(r => `<small class="role-tag">${r}</small>`).join('')}</span>
                            <span class="badge ${isP?'badge-pending':'badge-approved'}">${isP?'å¯©æ ¸ä¸­':'å·²å‡†è¨±'}</span>
                        </div>
                        <div id="det-${id}" class="details">
                            <p>ç­ç´šï¼š${d.class} | æ€§åˆ¥ï¼š${d.gender}</p>
                            
                            <label style="font-size:0.8rem;">ä¿®æ”¹è·ä½ (å¤šå€‹è«‹ç”¨é€—è™Ÿéš”é–‹)</label>
                            <input type="text" id="edit-role-${id}" value="${roles.join(', ')}">
                            <button class="btn btn-s" style="width:auto; padding:5px 15px; margin-bottom:10px;" onclick="updateRole('${id}')">æ›´æ–°è·ä½</button>
                            
                            <div style="display:flex; gap:10px; margin-top:10px; border-top:1px solid #ddd; padding-top:10px;">
                                ${isP ? `<button class="btn btn-s" style="padding:8px;" onclick="adminAction('${id}','approve')">å‡†è¨±å…¥ç­</button>` : ''}
                                <button class="btn" style="padding:8px; background:#666; color:white;" onclick="adminAction('${id}','reset')">é‚„åŸå¯†ç¢¼</button>
                                <button class="btn btn-d" style="padding:8px;" onclick="adminAction('${id}','delete')">åˆªé™¤ç´€éŒ„</button>
                            </div>
                        </div>
                    `;
                    if(isP) { pList.appendChild(item); pCount++; }
                    else { aList.appendChild(item); aCount++; }
                }
                document.getElementById('count-pending').innerText = pCount;
                document.getElementById('count-all').innerText = aCount;
            });
        }

        // --- ä¿®æ”¹è·å‹™åŒæ­¥åˆ° subject_roles ---
        async function updateRole(id) {
            const roleStr = document.getElementById(`edit-role-${id}`).value;
            // å°‡é€—è™Ÿå­—ä¸²è½‰ç‚ºé™£åˆ—ï¼Œä¸¦å»é™¤å¤šé¤˜ç©ºæ ¼
            const roleArr = roleStr.split(',').map(r => r.trim()).filter(r => r !== "");
            
            try {
                await db.collection("subject_roles").doc(id).set({
                    roles: roleArr,
                    updatedBy: me.name,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("è·ä½æ›´æ–°æˆåŠŸï¼å·²åŒæ­¥è‡³è³‡æ–™åº«ã€‚");
            } catch (e) { alert("æ›´æ–°è·ä½å¤±æ•—ï¼š" + e.message); }
        }

        async function adminAction(id, type) {
            if (type === 'approve') await db.collection("students").doc(id).update({ status: 'approved' });
            if (type === 'delete') if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await db.collection("students").doc(id).delete();
            if (type === 'reset') {
                const name = (await db.collection("students").doc(id).get()).data().name;
                await db.collection("students").doc(id).update({ password: id + name });
                alert("å¯†ç¢¼å·²é‚„åŸç‚ºåº§è™Ÿ+å§“å");
            }
        }
    </script>
</body>
</html>
