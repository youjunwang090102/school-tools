<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå¹³å° - æ¬Šé™ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f0f2f5; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; }
        
        /* ä»‹é¢åˆ‡æ› */
        .page { display: none; padding: 20px; max-width: 800px; margin: auto; animation: fadeIn 0.3s; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* é€šç”¨å…ƒä»¶ */
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; }
        .btn { border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        
        /* ç®¡ç†å“¡æ¸…å–® */
        .stu-item { border-bottom: 1px solid #eee; padding: 15px 10px; }
        .stu-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .details { display: none; padding: 15px; background: #f9f9f9; border-radius: 12px; margin-top: 10px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-pending { background: #fee2e2; color: var(--d); }
        .badge-approved { background: #e6fffa; color: var(--s); }
        
        .nav-header { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: none; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="nav" class="nav-header">
        <b id="userLabel">èº«åˆ†è¼‰å…¥ä¸­...</b>
        <button class="btn" style="width:auto; margin:0;" onclick="logout()">å®‰å…¨ç™»å‡º</button>
    </div>

    <div id="page-auth" class="page active-page">
        <div class="card" id="login-box">
            <h2 style="text-align:center;">ğŸ”‘ å­¸ç”Ÿ/å°å¸«ç™»å…¥</h2>
            <input type="number" id="l-id" placeholder="åº§è™Ÿ (ä¾‹å¦‚ 05)">
            <input type="password" id="l-pw" placeholder="å¯†ç¢¼">
            <button class="btn btn-p" onclick="doLogin()">ç™»å…¥</button>
            <button class="btn" style="background:none; color:var(--p)" onclick="toggleAuth(false)">æ–°åŒå­¸ï¼Ÿé»æ­¤è¨»å†Š</button>
        </div>

        <div class="card" id="reg-box" style="display:none;">
            <h2 style="text-align:center;">ğŸ“ ç”³è«‹å…¥ç­</h2>
            <input type="text" id="r-class" placeholder="ç­ç´š (ä¾‹å¦‚ 101)">
            <input type="number" id="r-id" placeholder="åº§è™Ÿ">
            <input type="text" id="r-name" placeholder="çœŸå¯¦å§“å">
            <select id="r-gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <input type="password" id="r-pw" placeholder="è¨­å®šç™»å…¥å¯†ç¢¼">
            <button class="btn btn-s" onclick="doRegister()">é€å‡ºå¯©æ ¸</button>
            <button class="btn" style="background:none; color:var(--p)" onclick="toggleAuth(true)">è¿”å›ç™»å…¥</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <div class="card">
            <h3>ğŸ‘¤ å€‹äººæª”æ¡ˆ (å”¯è®€)</h3>
            <label style="font-size:0.8rem;">ç­ç´š/åº§è™Ÿ/å§“å</label>
            <input type="text" id="p-basic" disabled>
            <label style="font-size:0.8rem;">è·å‹™ (ç”±ç³»çµ±æŒ‡æ´¾)</label>
            <input type="text" id="p-title" disabled>
            
            <h3 style="margin-top:25px; border-top:1px solid #eee; pt:20px; padding-top:20px;">âš™ï¸ å¸³æˆ¶è¨­å®š (å¯ä¿®æ”¹)</h3>
            <label>æ€§åˆ¥</label>
            <select id="p-gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <label>æ–°å¯†ç¢¼ (ä¸ä¿®æ”¹è«‹ç•™ç©º)</label>
            <input type="password" id="p-newpw" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
            <button class="btn btn-p" onclick="updateProfile()">å„²å­˜ä¸¦æ›´æ–°</button>
        </div>
    </div>

    <div id="page-admin" class="page">
        <div class="card" style="border-left: 5px solid var(--d);">
            <h3>â³ å¾…æ‰¹å‡†åå–® (<span id="count-pending">0</span>)</h3>
            <div id="list-pending"></div>
        </div>
        
        <div class="card">
            <h3>ğŸ‘¥ å…¨ç­è³‡æ–™ç¸½è¦½ (<span id="count-all">0</span>)</h3>
            <div id="list-all"></div>
        </div>
    </div>

    <script>
        // --- Firebase åˆå§‹åŒ– ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let me = null;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-' + pageId).classList.add('active-page');
            document.getElementById('nav').style.display = (pageId === 'auth') ? 'none' : 'flex';
        }

        function toggleAuth(showLogin) {
            document.getElementById('login-box').style.display = showLogin ? 'block' : 'none';
            document.getElementById('reg-box').style.display = showLogin ? 'none' : 'block';
        }

        // --- ç™»å…¥é‚è¼¯ï¼šæ¬Šé™åˆ†æ”¯åœ¨æ­¤ ---
        async function doLogin() {
            const id = document.getElementById('l-id').value.padStart(2, '0');
            const pw = document.getElementById('l-pw').value;
            
            try {
                const doc = await db.collection("students").doc(id).get();
                if (doc.exists && doc.data().password === pw) {
                    const data = doc.data();
                    
                    // 1. æª¢æŸ¥æ˜¯å¦æ‰¹å‡† (è€å¸«/ç®¡ç†å“¡ä¸å—é™)
                    if (data.status !== "approved" && data.role !== "teacher" && data.role !== "admin") {
                        return alert("æ‚¨çš„å¸³è™Ÿç”³è«‹æ­£åœ¨å¯©æ ¸ä¸­ï¼Œè«‹ç¨å€™ã€‚");
                    }

                    me = { id, ...data };
                    document.getElementById('userLabel').innerText = `${me.name} (${id}) - ${me.role === 'teacher' ? 'å°å¸«' : 'å­¸ç”Ÿ'}`;

                    // 2. æ ¹æ“š role å°å‘ä¸åŒé é¢
                    if (me.role === 'teacher' || me.role === 'admin') {
                        startAdminListener();
                        showPage('admin');
                    } else {
                        fillProfile();
                        showPage('profile');
                    }
                } else {
                    alert("åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
                }
            } catch (e) { alert("ç™»å…¥å¤±æ•—: " + e.message); }
        }

        async function doRegister() {
            const id = document.getElementById('r-id').value.padStart(2, '0');
            const data = {
                class: document.getElementById('r-class').value,
                name: document.getElementById('r-name').value,
                gender: document.getElementById('r-gender').value,
                password: document.getElementById('r-pw').value,
                status: "pending",
                role: "student", // è¨»å†Šé è¨­ç‚ºå­¸ç”Ÿ
                title: "ä¸€èˆ¬å­¸ç”Ÿ",
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };
            if(!id || !data.name || !data.password) return alert("è³‡è¨Šå¡«å¯«ä¸å…¨");
            await db.collection("students").doc(id).set(data);
            alert("ç”³è«‹å·²é€å‡ºï¼è«‹ç­‰å¾…å°å¸«æ‰¹å‡†ã€‚");
            location.reload();
        }

        function fillProfile() {
            document.getElementById('p-basic').value = `${me.class} - ${me.id}è™Ÿ - ${me.name}`;
            document.getElementById('p-title').value = me.title || "ä¸€èˆ¬å­¸ç”Ÿ";
            document.getElementById('p-gender').value = me.gender;
        }

        async function updateProfile() {
            const newPw = document.getElementById('p-newpw').value;
            const updates = { 
                gender: document.getElementById('p-gender').value,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };
            if (newPw) updates.password = newPw;
            await db.collection("students").doc(me.id).update(updates);
            alert("è³‡æ–™å·²æ›´æ–°ï¼");
        }

        // --- ç®¡ç†å“¡å¯¦æ™‚ç›£è½ ---
        function startAdminListener() {
            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
                const pList = document.getElementById('list-pending');
                const aList = document.getElementById('list-all');
                pList.innerHTML = ""; aList.innerHTML = "";
                let pCount = 0; let aCount = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    const id = doc.id;
                    const isP = d.status === 'pending';
                    const item = document.createElement('div');
                    item.className = 'stu-item';
                    item.innerHTML = `
                        <div class="stu-header" onclick="document.getElementById('det-${id}').style.display = document.getElementById('det-${id}').style.display==='block'?'none':'block'">
                            <span><b>${id} ${d.name}</b></span>
                            <span class="badge ${isP?'badge-pending':'badge-approved'}">${isP?'å¾…å¯©æ ¸':'å·²å‡†è¨±'}</span>
                        </div>
                        <div id="det-${id}" class="details">
                            <p>ç­ç´šï¼š${d.class} | è·å‹™ï¼š${d.title || 'ä¸€èˆ¬å­¸ç”Ÿ'} | æ€§åˆ¥ï¼š${d.gender}</p>
                            <p style="font-size:0.7rem; color:#aaa;">èº«åˆ†æ¬Šé™ï¼š${d.role}</p>
                            <div style="display:flex; gap:5px; margin-top:10px;">
                                ${isP ? `<button class="btn btn-s" style="padding:5px;" onclick="adminAction('${id}','approve')">å‡†è¨±å…¥ç­</button>` : ''}
                                <button class="btn btn-d" style="padding:5px; background:none; color:var(--d); border:1px solid var(--d);" onclick="adminAction('${id}','delete')">æ‹’çµ•/åˆªé™¤</button>
                                <button class="btn" style="padding:5px; background:#666; color:white;" onclick="adminAction('${id}','reset')">é‚„åŸå¯†ç¢¼</button>
                            </div>
                        </div>
                    `;
                    if(isP) { pList.appendChild(item); pCount++; }
                    else { aList.appendChild(item); aCount++; }
                });
                document.getElementById('count-pending').innerText = pCount;
                document.getElementById('count-all').innerText = aCount;
            });
        }

        async function adminAction(id, type) {
            if (type === 'approve') await db.collection("students").doc(id).update({ status: 'approved' });
            if (type === 'delete') if(confirm(`ç¢ºå®šåˆªé™¤/æ‹’çµ• ${id} å—ï¼Ÿ`)) await db.collection("students").doc(id).delete();
            if (type === 'reset') {
                const name = (await db.collection("students").doc(id).get()).data().name;
                await db.collection("students").doc(id).update({ password: id + name });
                alert("å·²é‡è¨­å¯†ç¢¼ç‚ºï¼š" + id + name);
            }
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>
