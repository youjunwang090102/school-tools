<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹¤å‹™æ—¥å¸¸ç®¡ç†</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; background: white; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); padding: 20px; box-sizing: border-box; }
        
        .view { display: none; opacity: 0; transition: opacity 0.3s; }
        .view.active { display: block; opacity: 1; }
        
        input, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .pw-box { position: relative; width: 100%; }
        .pw-toggle { position: absolute; right: 5px; top: 9px; width: 40px; height: 40px; background: none; border: none; color: #718096; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        
        .stu-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .score-badge { background: var(--d); color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; }
        .role-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #4a5568; margin-left: 5px; }
        
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center; }
        .modal-body { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; text-align: center; }
        .log-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.85rem; border-left: 4px solid var(--p); }
    </style>
</head>
<body>

<div class="container">
    <div id="loginView" class="view active">
        <h2 style="text-align:center; color:var(--p);">ğŸ§¹ ç­ç´šå‹¤å‹™ç™»å…¥</h2>
        <input type="number" id="loginId" placeholder="åº§è™Ÿ (ä¾‹å¦‚: 1, 99)">
        <div class="pw-box">
            <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
            <button type="button" class="pw-toggle" onclick="togglePw('loginPw')">ğŸ‘ï¸</button>
        </div>
        <button onclick="doLogin()">é€²å…¥ç³»çµ±</button>
        <button onclick="location.href='register.html'" style="background:#edf2f7; color:#718096;">å‰å¾€è¨»å†Šå¸³è™Ÿ</button>
    </div>

    <div id="resetView" class="view" style="text-align: center;">
        <h2 style="color:var(--d)">âš ï¸ éœ€é‡è¨­å¯†ç¢¼</h2>
        <div class="pw-box"><input type="password" id="resetPw" placeholder="æ–°å¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('resetPw')">ğŸ‘ï¸</button></div>
        <div class="pw-box"><input type="password" id="resetPw2" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('resetPw2')">ğŸ‘ï¸</button></div>
        <button onclick="doForcePasswordChange()">ç¢ºèªä¿®æ”¹ä¸¦ç™»å…¥</button>
    </div>

    <div id="dashboardView" class="view">
        <div style="background: linear-gradient(135deg, #4361ee, #4cc9f0); color:white; padding:25px; border-radius:20px; text-align:center; position:relative;">
            <button id="adminBtn" onclick="location.href='admin.html'" style="display:none; position:absolute; top:10px; right:10px; width:auto; padding:5px 10px; font-size:0.8rem; background:rgba(255,255,255,0.2);">âš™ï¸ é€²å…¥å¾Œå°</button>
            <h2 id="welcomeTitle" style="margin-top: 0;"></h2>
            <div id="myJob" style="font-size:1.8rem; font-weight:900; margin:10px 0;"></div>
            <div id="myScore" style="font-size:1.1rem;">ç›®å‰ç¼ºå¤±ï¼š0</div>
        </div>

        <div id="stuWarning" style="background:#fff5f5; border:1px solid #feb2b2; color:#c53030; padding:15px; border-radius:15px; margin:15px 0; text-align:center; display:none;">âš ï¸ <span id="warnText"></span></div>
        
        <div style="margin-top: 15px;"><h3>ğŸ“… è¨˜é»æ­·ç¨‹</h3><div id="myLogs"></div></div>
        
        <div id="managerSection" style="display:none; margin-top:20px; border-top:2px dashed #eee; padding-top:15px;">
            <h3 style="color:#4a5568;">ğŸ“‹ æ—¥å¸¸è¨˜é»é¢æ¿</h3>
            <div id="stuGrid"></div>
        </div>
        
        <button onclick="doLogout()" style="background:#718096; margin-top:20px;">ç™»å‡ºç³»çµ±</button>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <h3 id="targetName" style="margin:0; color:#2d3748;"></h3>
        <div id="modalScore" style="font-size:3rem; color:var(--d); font-weight:900; margin:10px 0;">0</div>
        <button onclick="addPoint()" style="background:var(--d); font-size:1.2rem; padding:15px;">â• å¢åŠ ç¼ºå¤±è¨˜é» (+1)</button>
        <button id="serviceBtn" onclick="doService()" style="background:#48bb78; display:none; margin-top:10px;">ğŸ§¹ æ‰¹å‡†æ„›ç­æœå‹™ (éŠ·é»)</button>
        <button onclick="closeModal()" style="background:#eee; color:#333; margin-top:15px;">é—œé–‰</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0", authDomain: "vote-6668.firebaseapp.com", projectId: "vote-6668", storageBucket: "vote-6668.firebasestorage.app", messagingSenderId: "389284021944", appId: "1:389284021944:web:3c5311697cbfc7c010564d" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function escapeHTML(str) { return String(str||'').replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag)); }
    function togglePw(fid) { const x=document.getElementById(fid); x.type=(x.type==="password")?"text":"password"; }

    let me = null, selectedId = null, alertThreshold = 3, unsubS = null;

    window.onload = async () => {
        const saved = localStorage.getItem('classAppMe');
        if(saved) { me = JSON.parse(saved); document.getElementById('loginView').classList.remove('active'); document.getElementById('dashboardView').classList.add('active'); startApp(); }
    };

    async function doLogin() {
        let rawId = document.getElementById('loginId').value;
        if(!rawId) return;
        let id = rawId.length === 1 ? "0" + rawId : rawId;
        const pw = document.getElementById('loginPw').value;
        const hashedInputPw = await hashPassword(pw);
        
        try {
            let doc = await db.collection("students").doc(id).get();
            if(!doc.exists && rawId.length > 2) { doc = await db.collection("students").doc(rawId).get(); if(doc.exists) id = rawId; }

            if(doc.exists && doc.data().password === hashedInputPw) {
                const data = doc.data();
                if(data.status === 'pending') return alert("â³ æ‚¨çš„å¸³è™Ÿæ­£åœ¨ç­‰å¾…å°å¸«å¯©æ ¸ã€‚");
                if(data.forceReset === true) {
                    localStorage.setItem('tempResetId', id);
                    document.getElementById('loginView').classList.remove('active'); document.getElementById('resetView').classList.add('active');
                    return;
                }
                me = { id, ...data };
                localStorage.setItem('classAppMe', JSON.stringify(me));
                location.reload();
            } else alert("ç™»å…¥å¤±æ•—ï¼šåº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
        } catch(e) { alert("éŒ¯èª¤ï¼š" + e.message); }
    }

    async function doForcePasswordChange() {
        const p1 = document.getElementById('resetPw').value, p2 = document.getElementById('resetPw2').value;
        if(!p1 || p1 !== p2) return alert("å¯†ç¢¼éŒ¯èª¤æˆ–ä¸ä¸€è‡´");
        const id = localStorage.getItem('tempResetId');
        await db.collection("students").doc(id).update({ password: await hashPassword(p1), forceReset: false });
        alert("å¯†ç¢¼æ›´æ–°æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥"); localStorage.removeItem('tempResetId'); location.reload();
    }

    function doLogout() { localStorage.removeItem('classAppMe'); location.reload(); }

    async function startApp() {
        try { const doc = await db.collection("settings").doc("config").get(); if(doc.exists) alertThreshold = doc.data().threshold || 3; } catch(e){}

        db.collection("students").doc(me.id).onSnapshot(doc => {
            if(!doc.exists) return doLogout();
            const d = doc.data(); me.role = d.role;
            document.getElementById('welcomeTitle').innerText = `${doc.id} ${escapeHTML(d.name)}`;
            document.getElementById('myJob').innerText = escapeHTML(d.duty_zone);
            document.getElementById('myScore').innerText = `ç›®å‰ç¼ºå¤±ï¼š${d.score||0}`;
            
            if(['admin', 'teacher'].includes(me.role)) document.getElementById('adminBtn').style.display = 'block';
        });

        db.collection("point_logs").where("studentId", "==", me.id).orderBy("time", "desc").onSnapshot(snap => {
            const box = document.getElementById('myLogs'); box.innerHTML = "";
            snap.forEach(l => {
                const data = l.data();
                box.innerHTML += data.type === 'service' 
                    ? `<div class="log-item" style="border-left-color:#48bb78; background:#f0fff4;"><span>${new Date(data.time).toLocaleString()}</span><b style="color:#2f855a;">å®Œæˆæ„›ç­ (-${data.points})</b></div>`
                    : `<div class="log-item"><span>${new Date(data.time).toLocaleString()}</span><b style="color:#c53030;">+1 ç¼ºå¤±</b></div>`;
            });
        });

        if(['admin', 'teacher', 'inner_manager', 'outer_manager'].includes(me.role)) {
            document.getElementById('managerSection').style.display = 'block';
            // æ³¨æ„ï¼šé€™è£¡åªæœƒæŠ“å–ç‹€æ…‹ç‚º active çš„å­¸ç”Ÿï¼Œéæ¿¾æ‰å¾…å¯©æ ¸çš„è¨»å†Šåå–®
            db.collection("students").where("status", "==", "active").onSnapshot(snap => {
                let list = []; snap.forEach(doc => list.push({id: doc.id, ...doc.data()}));
                list.sort((a,b) => parseInt(a.id) - parseInt(b.id));
                const grid = document.getElementById('stuGrid'); grid.innerHTML = "";
                list.forEach(s => {
                    let badge = s.role === 'inner_manager' ? '<span class="role-badge">å…§è¡›</span>' : (s.role === 'outer_manager' ? '<span class="role-badge">å¤–è¡›</span>' : '');
                    let warnStyle = s.score >= alertThreshold ? "border:2px solid var(--d);" : "";
                    grid.innerHTML += `<div class="stu-card" style="${warnStyle}" onclick="openModal('${s.id}', '${escapeHTML(s.name)}')">
                        <b>${s.id} ${escapeHTML(s.name)} ${badge}</b>
                        <div>${escapeHTML(s.duty_zone)} <span class="score-badge">${s.score||0}</span></div>
                    </div>`;
                });
            });
        }
    }

    window.openModal = function(id, name) {
        selectedId = id; document.getElementById('targetName').innerText = `${id} ${name}`;
        document.getElementById('modal').style.display = 'flex';
        if(unsubS) unsubS();
        unsubS = db.collection("students").doc(id).onSnapshot(doc => {
            const sc = doc.exists ? doc.data().score || 0 : 0;
            document.getElementById('modalScore').innerText = sc;
            document.getElementById('serviceBtn').style.display = sc >= alertThreshold ? 'inline-block' : 'none';
        });
    }
    window.closeModal = function() { document.getElementById('modal').style.display = 'none'; if(unsubS) unsubS(); }
    
    window.addPoint = async function() {
        await db.collection("point_logs").add({ studentId: selectedId, time: Date.now(), type: 'normal' });
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(1) });
    }
    window.doService = async function() {
        if(!confirm(`ç¢ºèª ${selectedId} è™Ÿå·²å®Œæˆæ„›ç­æœå‹™ï¼Ÿ\nå°‡æ‰£é™¤ ${alertThreshold} é»ç¼ºå¤±ã€‚`)) return;
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(-alertThreshold) });
        await db.collection("point_logs").add({ studentId: selectedId, time: Date.now(), type: 'service', points: alertThreshold });
        closeModal();
    }
</script>
</body>
</html>
