<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿå¸³è™Ÿè¨»å†Š</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #2ec4b6; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 400px; background: white; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); padding: 25px; box-sizing: border-box; }
        input, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .pw-box { position: relative; width: 100%; }
        .pw-toggle { position: absolute; right: 5px; top: 9px; width: 40px; height: 40px; background: none; border: none; color: #718096; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .captcha-row { display: flex; gap: 10px; align-items: center; }
        .captcha-display { flex: 1; background: #2d3748; color: #fff; letter-spacing: 5px; font-family: monospace; font-size: 1.5rem; text-align: center; padding: 10px; border-radius: 12px; font-weight: bold; text-decoration: line-through; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#2d3748;">ğŸ“ å­¸ç”Ÿå¸³è™Ÿè¨»å†Š</h2>
    <input type="number" id="regId" placeholder="åº§è™Ÿ (è«‹å¡«å¯«çœŸå¯¦åº§è™Ÿ)">
    <input type="text" id="regName" placeholder="å§“å (è«‹å¡«å¯«çœŸå¯¦å§“å)">
    <div class="pw-box"><input type="password" id="regPw" placeholder="è¨­å®šå¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('regPw')">ğŸ‘ï¸</button></div>
    <div class="pw-box"><input type="password" id="regPw2" placeholder="ç¢ºèªå¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('regPw2')">ğŸ‘ï¸</button></div>
    
    <div class="captcha-row">
        <div id="captchaDisplay" class="captcha-display">ABCD</div>
        <button type="button" onclick="refreshCaptcha()" style="width:auto; padding:10px 15px; background:#cbd5e0; color:#4a5568;">ğŸ”„</button>
    </div>
    <input type="text" id="captchaInput" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹ 4 ç¢¼é©—è­‰ç¢¼">
    
    <button onclick="doRegister()">é€å‡ºåŠ å…¥ç”³è«‹</button>
    <button onclick="location.href='index.html'" style="background:transparent; color:#718096; border:1px solid #cbd5e0;">è¿”å›ç™»å…¥</button>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0", authDomain: "vote-6668.firebaseapp.com", projectId: "vote-6668", storageBucket: "vote-6668.firebasestorage.app", messagingSenderId: "389284021944", appId: "1:389284021944:web:3c5311697cbfc7c010564d" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentCaptcha = "";

    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function togglePw(fid) { const x=document.getElementById(fid); x.type=(x.type==="password")?"text":"password"; }
    function refreshCaptcha() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        currentCaptcha = Array.from({length:4}).map(() => chars.charAt(Math.floor(Math.random()*chars.length))).join('');
        document.getElementById('captchaDisplay').innerText = currentCaptcha;
    }

    async function doRegister() {
        let rawId = document.getElementById('regId').value;
        let id = rawId.length === 1 ? "0" + rawId : rawId;
        const p1 = document.getElementById('regPw').value, p2 = document.getElementById('regPw2').value;
        const name = document.getElementById('regName').value.trim(), uC = document.getElementById('captchaInput').value.toUpperCase();

        if(!id || !name || !p1) return alert("è³‡è¨Šä¸å®Œæ•´");
        if(p1 !== p2) return alert("å¯†ç¢¼ä¸ä¸€è‡´");
        if(uC !== currentCaptcha) { refreshCaptcha(); return alert("é©—è­‰ç¢¼éŒ¯èª¤"); }

        const check = await db.collection("students").doc(id).get();
        if(check.exists) return alert("æ­¤åº§è™Ÿå·²è¨»å†Š");

        await db.collection("students").doc(id).set({ 
            name: name, password: await hashPassword(p1), role: "student", duty_zone: "æœªåˆ†é…", score: 0, warning: "", forceReset: false, status: "pending"
        });
        alert("ç”³è«‹å·²é€å‡ºï¼è«‹ç­‰å¾…å¯©æ ¸ã€‚"); location.href = 'index.html';
    }
    refreshCaptcha();
</script>
</body>
</html>
