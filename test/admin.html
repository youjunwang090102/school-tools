<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²éšç®¡ç†å“¡å¾Œå°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #edf2f7; margin: 0; padding: 20px; }
        .admin-container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 20px; }
        button { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #4361ee; color: white; }
        .danger-btn { background: #ef233c; }
        .warn-btn { background: #f6ad55; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #4a5568; }
        select, input[type="text"] { padding: 6px; border-radius: 6px; border: 1px solid #cbd5e0; width: 100%; }
        
        .pending-box { background: #ebf8ff; border: 1px solid #bee3f8; padding: 15px; border-radius: 10px; margin-bottom: 20px; display:none; }
        .pending-item { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #bee3f8; padding-bottom: 10px; }
    </style>
</head>
<body>

<div id="authCheck" style="text-align:center; padding:50px;"><h2>æ­£åœ¨é©—è­‰ç®¡ç†å“¡èº«åˆ†...</h2></div>

<div id="adminPanel" class="admin-container" style="display:none;">
    <div class="header">
        <h2 style="margin:0;">âš™ï¸ é€²éšç®¡ç†å¾Œå°</h2>
        <div>
            <button class="warn-btn" onclick="editThreshold()">è¨­å®šè­¦å‘Šé»æ•¸</button>
            <button onclick="location.href='index.html'" style="background:#718096;">è¿”å›ç³»çµ±</button>
        </div>
    </div>

    <div id="pendingBox" class="pending-box">
        <h3 style="margin-top:0; color:#2b6cb0;">â³ å¾…å¯©æ ¸ç”³è«‹</h3>
        <div id="pendingList"></div>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button onclick="saveAllChanges()" style="background:#48bb78;">ğŸ’¾ å„²å­˜æ‰€æœ‰èº«åˆ†èˆ‡å·¥ä½œè®Šæ›´</button>
        <button onclick="batchDelete()" class="danger-btn">ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤é¸å–å­¸ç”Ÿ</button>
    </div>

    <table id="studentTable">
        <thead>
            <tr>
                <th style="width: 50px;"><input type="checkbox" id="selectAll" onclick="toggleAll()"></th>
                <th style="width: 60px;">åº§è™Ÿ</th>
                <th style="width: 120px;">å§“å</th>
                <th style="width: 150px;">èº«åˆ†æ¬Šé™</th>
                <th>æ‰“æƒå·¥ä½œ (å¯æ‰‹å‹•è¼¸å…¥æ–°å·¥ä½œ)</th>
                <th style="width: 100px;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="studentBody"></tbody>
    </table>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0", authDomain: "vote-6668.firebaseapp.com", projectId: "vote-6668", storageBucket: "vote-6668.firebasestorage.app", messagingSenderId: "389284021944", appId: "1:389284021944:web:3c5311697cbfc7c010564d" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let allStudents = [];
    let jobOptions = [];

    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function escapeHTML(str) { return String(str||'').replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag)); }

    // æ¬Šé™é©—è­‰ (è®€å– localStorage)
    window.onload = async () => {
        const saved = localStorage.getItem('classAppMe');
        if(!saved) { alert("è«‹å…ˆå¾é¦–é ç™»å…¥"); location.href = 'index.html'; return; }
        const me = JSON.parse(saved);
        if(!['admin', 'teacher'].includes(me.role)) { alert("æ¬Šé™ä¸è¶³ï¼Œåƒ…é™å°å¸«/ç®¡ç†å“¡ä½¿ç”¨"); location.href = 'index.html'; return; }
        
        document.getElementById('authCheck').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadData();
    };

    async function loadData() {
        // è¼‰å…¥å·¥ä½œé¸é …
        const jobSnap = await db.collection("duty_options").get();
        jobOptions = []; jobSnap.forEach(doc => jobOptions.push(doc.id));
        
        // è¼‰å…¥å­¸ç”Ÿè³‡æ–™
        db.collection("students").onSnapshot(snap => {
            allStudents = [];
            const pendingList = [];
            snap.forEach(doc => {
                const data = doc.data();
                if(data.status === 'pending') pendingList.push({id: doc.id, ...data});
                else allStudents.push({id: doc.id, ...data});
            });
            renderPending(pendingList);
            renderTable();
        });
    }

    function getJobSelectHTML(currentJob) {
        let html = `<input type="text" list="jobs" class="job-input" value="${escapeHTML(currentJob)}" placeholder="è¼¸å…¥æˆ–é¸æ“‡å·¥ä½œ">`;
        html += `<datalist id="jobs">`;
        jobOptions.forEach(j => html += `<option value="${escapeHTML(j)}">`);
        html += `</datalist>`;
        return html;
    }

    function renderTable() {
        allStudents.sort((a,b) => parseInt(a.id) - parseInt(b.id));
        const tbody = document.getElementById('studentBody');
        tbody.innerHTML = "";
        allStudents.forEach(s => {
            const roleSelect = `
                <select class="role-select">
                    <option value="student" ${s.role==='student'?'selected':''}>ä¸€èˆ¬å­¸ç”Ÿ</option>
                    <option value="inner_manager" ${s.role==='inner_manager'?'selected':''}>å…§è¡›ç”Ÿ (å¹¹éƒ¨)</option>
                    <option value="outer_manager" ${s.role==='outer_manager'?'selected':''}>å¤–è¡›ç”Ÿ (å¹¹éƒ¨)</option>
                </select>`;
            
            tbody.innerHTML += `
                <tr data-id="${s.id}">
                    <td><input type="checkbox" class="stu-check" value="${s.id}"></td>
                    <td><b>${s.id}</b></td>
                    <td>${escapeHTML(s.name)}</td>
                    <td>${roleSelect}</td>
                    <td>${getJobSelectHTML(s.duty_zone)}</td>
                    <td><button onclick="resetPw('${s.id}')" class="warn-btn" style="padding:4px 8px; font-size:0.8rem;">â†º é‡è¨­å¯†ç¢¼</button></td>
                </tr>`;
        });
    }

    function renderPending(list) {
        const box = document.getElementById('pendingBox');
        const plist = document.getElementById('pendingList');
        if(list.length > 0) {
            box.style.display = 'block'; plist.innerHTML = "";
            list.forEach(s => {
                plist.innerHTML += `
                <div class="pending-item">
                    <span><b>${s.id}</b> ${escapeHTML(s.name)}</span>
                    <div>
                        <button onclick="approve('${s.id}')" style="background:#48bb78; padding:5px 10px;">âœ… æ‰¹å‡†</button>
                        <button onclick="reject('${s.id}')" class="danger-btn" style="padding:5px 10px;">âŒ æ‹’çµ•</button>
                    </div>
                </div>`;
            });
        } else { box.style.display = 'none'; }
    }

    // --- æ“ä½œåŠŸèƒ½ ---
    function toggleAll() {
        const checked = document.getElementById('selectAll').checked;
        document.querySelectorAll('.stu-check').forEach(cb => cb.checked = checked);
    }

    window.saveAllChanges = async function() {
        if(!confirm("ç¢ºå®šè¦å„²å­˜åˆ—è¡¨ä¸Šæ‰€æœ‰çš„èº«åˆ†èˆ‡å·¥ä½œè®Šæ›´å—ï¼Ÿ")) return;
        const rows = document.querySelectorAll('#studentBody tr');
        let newJobs = new Set();

        const batch = db.batch();
        rows.forEach(row => {
            const id = row.getAttribute('data-id');
            const newRole = row.querySelector('.role-select').value;
            const newJob = row.querySelector('.job-input').value.trim();
            
            if(newJob && !jobOptions.includes(newJob)) newJobs.add(newJob);
            
            const ref = db.collection('students').doc(id);
            batch.update(ref, { role: newRole, duty_zone: newJob || "æœªåˆ†é…" });
        });

        // å°‡æ‰‹å‹•è¼¸å…¥çš„æ–°å·¥ä½œåŠ å…¥è³‡æ–™åº«é¸é …ä¸­
        newJobs.forEach(job => { batch.set(db.collection('duty_options').doc(job), { active: true }); });

        await batch.commit();
        alert("âœ… æ‰€æœ‰è®Šæ›´å·²æˆåŠŸå„²å­˜ï¼");
    }

    window.batchDelete = async function() {
        const checked = Array.from(document.querySelectorAll('.stu-check:checked')).map(cb => cb.value);
        if(checked.length === 0) return alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„å­¸ç”Ÿ");
        if(!confirm(`âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é¸å–çš„ ${checked.length} ä½å­¸ç”Ÿå—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

        const batch = db.batch();
        checked.forEach(id => batch.delete(db.collection('students').doc(id)));
        await batch.commit();
        alert("âœ… æ‰¹æ¬¡åˆªé™¤å®Œæˆ");
    }

    window.resetPw = async function(id) {
        if(!confirm(`ç¢ºå®šè¦å°‡åº§è™Ÿ ${id} çš„å¯†ç¢¼é‚„åŸç‚ºé è¨­å—ï¼Ÿ(åº§è™Ÿé‡è¤‡3æ¬¡)`)) return;
        const defPw = id.repeat(3); 
        await db.collection("students").doc(id).update({ password: await hashPassword(defPw), forceReset: true });
        alert(`å·²é‚„åŸå¯†ç¢¼ç‚ºï¼š${defPw}`);
    }

    window.approve = async function(id) { await db.collection("students").doc(id).update({ status: 'active' }); }
    window.reject = async function(id) { if(confirm("ç¢ºå®šæ‹’çµ•ä¸¦åˆªé™¤æ­¤ç”³è«‹ï¼Ÿ")) await db.collection("students").doc(id).delete(); }
    
    window.editThreshold = async function() {
        const n = prompt("è«‹è¼¸å…¥ã€Œè¨˜é»é” N æ¬¡ã€æ™‚é¡¯ç¤ºè­¦å‘Šï¼š");
        if(n && !isNaN(n)) { await db.collection("settings").doc("config").set({ threshold: parseInt(n) }, {merge:true}); alert("è­¦å‘Šé»æ•¸è¨­å®šæˆåŠŸï¼"); }
    }
</script>
</body>
</html>
