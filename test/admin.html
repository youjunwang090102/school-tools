<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²éšç®¡ç†å“¡å¾Œå°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #edf2f7; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .login-container { width: 100%; max-width: 400px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 30px; box-sizing: border-box; margin-top: 50px; text-align: center; }
        .login-container input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 14px; background: #2b6cb0; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .login-btn:hover { background: #2c5282; }
        
        .admin-container { width: 100%; max-width: 1000px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 20px; }
        button { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #4361ee; color: white; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .danger-btn { background: #ef233c; }
        .warn-btn { background: #f6ad55; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #4a5568; }
        select, input[type="text"] { padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0; width: 100%; box-sizing: border-box; }
        
        .pending-box { background: #ebf8ff; border: 1px solid #bee3f8; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .pending-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #bee3f8; padding-bottom: 10px; }
        .pending-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    </style>
</head>
<body>

<div id="adminLoginView" class="login-container">
    <h2 style="color: #2b6cb0; margin-top: 0;">ğŸ›¡ï¸ å¾Œå°ç®¡ç†ç™»å…¥</h2>
    <p style="color: #718096; font-size: 0.9rem; margin-bottom: 20px;">åƒ…é™å°å¸«èˆ‡ç³»çµ±ç®¡ç†å“¡ä½¿ç”¨</p>
    <input type="text" id="adminId" placeholder="ç®¡ç†å“¡åº§è™Ÿ">
    <input type="password" id="adminPw" placeholder="å¯†ç¢¼">
    <button class="login-btn" onclick="doAdminLogin()">ç™»å…¥å¾Œå°</button>
    <button onclick="location.href='index.html'" style="background: transparent; color: #718096; border: 1px solid #cbd5e0; width: 100%; padding: 14px; border-radius: 12px; margin-top: 15px; font-weight: bold; cursor: pointer;">è¿”å›æ‰“æƒç®¡ç†ç³»çµ±</button>
</div>

<div id="adminPanel" class="admin-container" style="display:none;">
    <div class="header">
        <h2 style="margin:0; color:#2d3748;">âš™ï¸ ç­ç´šé€²éšç®¡ç†å¾Œå°</h2>
        <div>
            <span id="adminNameDisplay" style="margin-right: 15px; font-weight: bold; color: #4a5568;"></span>
            <button class="warn-btn" onclick="editThreshold()">è¨­å®šè­¦å‘Šé»æ•¸</button>
            <button onclick="doAdminLogout()" style="background:#718096;">ç™»å‡º</button>
        </div>
    </div>

    <div id="pendingBox" class="pending-box" style="display:none;">
        <h3 style="margin-top:0; color:#2b6cb0;">â³ å¾…å¯©æ ¸åŠ å…¥ç”³è«‹</h3>
        <div id="pendingList"></div>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 15px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
        <button onclick="saveAllChanges()" style="background:#48bb78; font-size: 1rem;">ğŸ’¾ å„²å­˜ä¸‹æ–¹æ‰€æœ‰ã€èº«åˆ†èˆ‡å·¥ä½œã€‘è®Šæ›´</button>
        <button onclick="batchDelete()" class="danger-btn" style="font-size: 1rem;">ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤å‹¾é¸å­¸ç”Ÿ</button>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 50px;"><input type="checkbox" id="selectAll" onclick="toggleAll()"></th>
                <th style="width: 60px;">åº§è™Ÿ</th>
                <th style="width: 120px;">å§“å</th>
                <th style="width: 160px;">èº«åˆ†æ¬Šé™</th>
                <th>æ‰“æƒå·¥ä½œ (å¯æ‰‹å‹•è¼¸å…¥æ–°å·¥ä½œ)</th>
                <th style="width: 100px;">å¯†ç¢¼ç®¡ç†</th>
            </tr>
        </thead>
        <tbody id="studentBody"></tbody>
    </table>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0", authDomain: "vote-6668.firebaseapp.com", projectId: "vote-6668", storageBucket: "vote-6668.firebasestorage.app", messagingSenderId: "389284021944", appId: "1:389284021944:web:3c5311697cbfc7c010564d" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let allStudents = [];
    let jobOptions = [];

    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function escapeHTML(str) { return String(str||'').replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag)); }

    window.onload = async () => {
        const saved = localStorage.getItem('classAppMe');
        if(saved) {
            const me = JSON.parse(saved);
            if(['admin', 'teacher'].includes(me.role)) {
                showAdminPanel(me.name);
                return;
            }
        }
        document.getElementById('adminLoginView').style.display = 'block';
    };

    // ç®¡ç†å“¡ç™»å…¥ (åŒ…å«æ–°èˆŠå¯†ç¢¼ç„¡ç¸«è½‰æ›)
    async function doAdminLogin() {
        let rawId = document.getElementById('adminId').value;
        if(!rawId) return alert("è«‹è¼¸å…¥å¸³è™Ÿ");
        let id = rawId.length === 1 ? "0" + rawId : rawId;
        const pw = document.getElementById('adminPw').value;
        if(!pw) return alert("è«‹è¼¸å…¥å¯†ç¢¼");
        
        const hashedInputPw = await hashPassword(pw);

        try {
            let doc = await db.collection("students").doc(id).get();
            if(!doc.exists && rawId.length > 2) { 
                doc = await db.collection("students").doc(rawId).get();
                if(doc.exists) id = rawId;
            }

            if(doc.exists) {
                const data = doc.data();
                if(!['admin', 'teacher'].includes(data.role)) return alert("âŒ ç™»å…¥å¤±æ•—ï¼šæ‚¨çš„èº«åˆ†ä¸æ˜¯ç®¡ç†å“¡ï¼Œç„¡æ³•é€²å…¥å¾Œå°ã€‚");
                
                let isMatch = false;
                
                // ğŸ” é›™é‡æ¯”å°æ©Ÿåˆ¶ï¼šç›¸å®¹æ–°èˆŠå¯†ç¢¼
                if(data.password === hashedInputPw) {
                    isMatch = true;
                } else if (data.password === pw) {
                    isMatch = true;
                    // ç™»å…¥æˆåŠŸçš„åŒæ™‚ï¼Œé †æ‰‹å¹«ç®¡ç†å“¡çš„å¯†ç¢¼åŠ å¯†
                    await db.collection("students").doc(id).update({ password: hashedInputPw });
                }

                if(isMatch) {
                    const me = { id, ...data };
                    localStorage.setItem('classAppMe', JSON.stringify(me));
                    showAdminPanel(me.name);
                } else alert("âŒ ç™»å…¥å¤±æ•—ï¼šå¯†ç¢¼éŒ¯èª¤");
            } else alert("âŒ ç™»å…¥å¤±æ•—ï¼šæ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ");
        } catch(e) { alert("ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message); }
    }

    function doAdminLogout() {
        localStorage.removeItem('classAppMe');
        location.reload(); 
    }

    function showAdminPanel(adminName) {
        document.getElementById('adminLoginView').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('adminNameDisplay').innerText = `ç®¡ç†å“¡ï¼š${escapeHTML(adminName)}`;
        loadData();
    }

    async function loadData() {
        const jobSnap = await db.collection("duty_options").get();
        jobOptions = []; jobSnap.forEach(doc => jobOptions.push(doc.id));
        
        db.collection("students").onSnapshot(snap => {
            allStudents = [];
            const pendingList = [];
            snap.forEach(doc => {
                const data = doc.data();
                if(data.status === 'pending') pendingList.push({id: doc.id, ...data});
                else allStudents.push({id: doc.id, ...data});
            });
            renderPending(pendingList);
            renderTable();
        });
    }

    function getJobSelectHTML(currentJob) {
        let html = `<input type="text" list="jobs" class="job-input" value="${escapeHTML(currentJob)}" placeholder="è¼¸å…¥æˆ–é¸æ“‡å·¥ä½œ">`;
        html += `<datalist id="jobs">`;
        jobOptions.forEach(j => html += `<option value="${escapeHTML(j)}">`);
        html += `</datalist>`;
        return html;
    }

    function renderTable() {
        allStudents.sort((a,b) => parseInt(a.id) - parseInt(b.id));
        const tbody = document.getElementById('studentBody');
        tbody.innerHTML = "";
        
        allStudents.forEach(s => {
            const roleSelect = `
                <select class="role-select">
                    <option value="student" ${s.role==='student'?'selected':''}>ä¸€èˆ¬å­¸ç”Ÿ</option>
                    <option value="inner_manager" ${s.role==='inner_manager'?'selected':''}>å…§è¡›ç”Ÿ (æ‰“æƒå¹¹éƒ¨)</option>
                    <option value="outer_manager" ${s.role==='outer_manager'?'selected':''}>å¤–è¡›ç”Ÿ (æ‰“æƒå¹¹éƒ¨)</option>
                    <option value="teacher" ${s.role==='teacher'?'selected':''}>å°å¸«/ç®¡ç†å“¡</option>
                </select>`;
            
            tbody.innerHTML += `
                <tr data-id="${s.id}">
                    <td><input type="checkbox" class="stu-check" value="${s.id}"></td>
                    <td><b>${s.id}</b></td>
                    <td>${escapeHTML(s.name)}</td>
                    <td>${roleSelect}</td>
                    <td>${getJobSelectHTML(s.duty_zone)}</td>
                    <td><button onclick="resetPw('${s.id}')" class="warn-btn" style="padding:6px; font-size:0.8rem;">â†º å¯†ç¢¼é‚„åŸ</button></td>
                </tr>`;
        });
    }

    function renderPending(list) {
        const box = document.getElementById('pendingBox');
        const plist = document.getElementById('pendingList');
        if(list.length > 0) {
            box.style.display = 'block'; 
            plist.innerHTML = "";
            list.forEach(s => {
                plist.innerHTML += `
                <div class="pending-item">
                    <span><b>${s.id}</b> è™Ÿ - ${escapeHTML(s.name)}</span>
                    <div>
                        <button onclick="approve('${s.id}')" style="background:#48bb78;">âœ… å…è¨±åŠ å…¥</button>
                        <button onclick="reject('${s.id}')" class="danger-btn">âŒ æ‹’çµ•ä¸¦åˆªé™¤</button>
                    </div>
                </div>`;
            });
        } else { box.style.display = 'none'; }
    }

    function toggleAll() {
        const checked = document.getElementById('selectAll').checked;
        document.querySelectorAll('.stu-check').forEach(cb => cb.checked = checked);
    }

    window.saveAllChanges = async function() {
        if(!confirm("ç¢ºå®šè¦å„²å­˜åˆ—è¡¨ä¸Šæ‰€æœ‰çš„ã€èº«åˆ†ã€‘èˆ‡ã€æ‰“æƒå·¥ä½œã€‘è®Šæ›´å—ï¼Ÿ")) return;
        const rows = document.querySelectorAll('#studentBody tr');
        let newJobs = new Set();
        const batch = db.batch();

        rows.forEach(row => {
            const id = row.getAttribute('data-id');
            const newRole = row.querySelector('.role-select').value;
            const newJob = row.querySelector('.job-input').value.trim();
            if(newJob && !jobOptions.includes(newJob)) newJobs.add(newJob);
            const ref = db.collection('students').doc(id);
            batch.update(ref, { role: newRole, duty_zone: newJob || "æœªåˆ†é…" });
        });

        newJobs.forEach(job => { batch.set(db.collection('duty_options').doc(job), { active: true }); });
        await batch.commit();
        alert("âœ… æ‰€æœ‰è®Šæ›´å·²æˆåŠŸå„²å­˜ä¸¦åŒæ­¥è‡³è³‡æ–™åº«ï¼");
    }

    window.batchDelete = async function() {
        const checked = Array.from(document.querySelectorAll('.stu-check:checked')).map(cb => cb.value);
        if(checked.length === 0) return alert("è«‹å…ˆåœ¨å·¦å´å‹¾é¸è¦åˆªé™¤çš„å­¸ç”Ÿ");
        if(!confirm(`âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é¸å–çš„ ${checked.length} ä½å­¸ç”Ÿå—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

        const batch = db.batch();
        checked.forEach(id => batch.delete(db.collection('students').doc(id)));
        await batch.commit();
        alert("âœ… æ‰¹æ¬¡åˆªé™¤å®Œæˆ");
        document.getElementById('selectAll').checked = false;
    }

    window.resetPw = async function(id) {
        if(!confirm(`ç¢ºå®šè¦å°‡åº§è™Ÿ ${id} çš„å¯†ç¢¼é‚„åŸç‚ºé è¨­å¯†ç¢¼å—ï¼Ÿ(é è¨­ç‚ºåº§è™Ÿé‡è¤‡3æ¬¡)`)) return;
        const defPw = id.repeat(3); 
        await db.collection("students").doc(id).update({ password: await hashPassword(defPw), forceReset: true });
        alert(`å·²é‚„åŸå¯†ç¢¼ç‚ºï¼š${defPw}\nå­¸ç”Ÿä¸‹æ¬¡ç™»å…¥æ™‚æœƒè¢«è¦æ±‚å¼·åˆ¶é‡è¨­å¯†ç¢¼ã€‚`);
    }

    window.approve = async function(id) { await db.collection("students").doc(id).update({ status: 'active' }); }
    window.reject = async function(id) { if(confirm("ç¢ºå®šæ‹’çµ•ä¸¦åˆªé™¤æ­¤è¨»å†Šç”³è«‹ï¼Ÿ")) await db.collection("students").doc(id).delete(); }
    
    window.editThreshold = async function() {
        const n = prompt("è«‹è¼¸å…¥ã€Œç¼ºå¤±é” N æ¬¡ã€æ™‚è¦åœ¨é¦–é é¡¯ç¤ºè­¦å‘Šï¼š");
        if(n && !isNaN(n)) { 
            await db.collection("settings").doc("config").set({ threshold: parseInt(n) }, {merge:true}); 
            alert("è­¦å‘Šé»æ•¸è¨­å®šæˆåŠŸï¼"); 
        }
    }
</script>
</body>
</html>
