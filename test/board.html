<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹•æ…‹ç‰† v7.0 (é«˜è³ªæ„Ÿæ——è‰¦ç‰ˆ)</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        /* --- ç¾ä»£åŒ–è‰²æ¿èˆ‡åŸºç¤è¨­å®š --- */
        :root { 
            --primary: #4f46e5; --primary-hover: #4338ca; 
            --secondary: #10b981; --danger: #ef4444; 
            --bg: #f8fafc; --surface: #ffffff; 
            --text-main: #0f172a; --text-muted: #64748b;
            --teacher: #8b5cf6;
        }
        body { font-family: -apple-system, "SF Pro TC", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; }
        * { box-sizing: border-box; }
        
        .container { width: 100%; max-width: 1050px; padding: 20px; }
        .card { background: var(--surface); border-radius: 24px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }
        
        /* --- ç¶²é ä½ˆå±€ --- */
        .main-layout { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media (min-width: 850px) { .main-layout { grid-template-columns: 1fr 380px; } }

        /* --- é ‚éƒ¨å°è¦½åˆ— --- */
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: var(--surface); padding: 15px 24px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .user-profile { display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 1.1rem; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; }
        .logout-btn { background: #f1f5f9; color: var(--text-muted); padding: 8px 16px; border-radius: 12px; border: none; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: 0.2s; }
        .logout-btn:hover { background: #e2e8f0; color: var(--text-main); }

        /* --- è¼¸å…¥å€å¡Š --- */
        .post-area { display: flex; flex-direction: column; gap: 12px; }
        .post-input-wrapper { display: flex; gap: 12px; align-items: flex-end; }
        textarea.post-input { flex: 1; border: 2px solid #e2e8f0; border-radius: 16px; padding: 16px; font-size: 1rem; resize: none; min-height: 80px; transition: 0.3s; font-family: inherit; }
        textarea.post-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .send-btn { background: var(--primary); color: white; border: none; padding: 0 24px; height: 50px; border-radius: 14px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .send-btn:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* --- ç•™è¨€åˆ—è¡¨ --- */
        .msg-list { display: flex; flex-direction: column; gap: 16px; max-height: 75vh; overflow-y: auto; padding-right: 5px; scroll-behavior: smooth; }
        .msg-list::-webkit-scrollbar { width: 6px; }
        .msg-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .msg-item { background: var(--surface); padding: 20px; border-radius: 20px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.02); display: flex; gap: 15px; animation: fadeIn 0.4s ease-out; position: relative; overflow: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-item.is-teacher { background: #faf5ff; border-color: #f3e8ff; }
        .msg-item.is-teacher::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--teacher); }
        
        .msg-content-wrapper { flex: 1; min-width: 0; }
        .msg-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .msg-author { font-weight: bold; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .msg-role-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 8px; background: #e0e7ff; color: var(--primary); font-weight: 600; }
        .msg-item.is-teacher .msg-role-tag { background: #f3e8ff; color: var(--teacher); }
        .msg-time { font-size: 0.8rem; color: var(--text-muted); }
        .msg-text { color: #334155; line-height: 1.6; word-break: break-word; white-space: pre-wrap; font-size: 0.95rem; }
        .msg-text a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .msg-text a:hover { text-decoration: underline; }
        .delete-btn { background: #fee2e2; color: var(--danger); border: none; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 0.8rem; }
        .delete-btn:hover { background: var(--danger); color: white; transform: scale(1.1); }

        /* --- ç®¡ç†é¢æ¿æ§åˆ¶ --- */
        .admin-toggle-btn { background: var(--teacher); color: white; border: none; padding: 16px; border-radius: 16px; width: 100%; font-weight: bold; font-size: 1rem; margin-bottom: 20px; cursor: pointer; display: none; transition: 0.2s; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        .admin-toggle-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4); }
        
        #adminPanel { display: none; background: #1e293b; color: white; border-radius: 24px; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        
        select.admin-select { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 0.95rem; }
        .admin-btn { width: 100%; padding: 14px; background: var(--danger); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .admin-btn:hover { filter: brightness(1.2); }
        
        .active-mute-item { background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        .unmute-btn { background: var(--secondary); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; font-weight: bold; }

        /* --- å…±ç”¨èˆ‡æç¤º --- */
        input.login-input { width: 100%; padding: 16px; margin: 10px 0; border-radius: 16px; border: 2px solid #e2e8f0; font-size: 1rem; transition: 0.3s; }
        input.login-input:focus { border-color: var(--primary); outline: none; }
        .mute-warning { color: #991b1b; font-weight: bold; background: #fef2f2; padding: 15px; border-radius: 12px; margin-top: 15px; font-size: 0.9rem; display: none; border: 1px solid #fecaca; display: flex; align-items: center; gap: 8px; }
        
        /* è‡ªè¨‚ Toast æç¤ºæ¡† */
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; background: white; color: var(--text-main); padding: 16px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 0.95rem; transform: translateX(120%); opacity: 0; transition: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); border-left: 5px solid var(--primary); }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.error { border-left-color: var(--danger); }
        .toast.success { border-left-color: var(--secondary); }
    </style>
</head>
<body>

<div id="toastContainer"></div>

<div class="container">
    <div id="loginCard" class="card" style="max-width: 400px; margin: 8vh auto; padding: 40px 30px;">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ’¬</div>
            <h2 style="margin: 0; color: var(--text-main);">ç­ç´šå‹•æ…‹ç‰†</h2>
            <p style="color: var(--text-muted); margin-top: 5px; font-size: 0.9rem;">æ­¡è¿å›ä¾†ï¼Œè«‹ç™»å…¥æ‚¨çš„å¸³è™Ÿ</p>
        </div>
        
        <input type="number" id="stuId" class="login-input" autocomplete="username" placeholder="è«‹è¼¸å…¥åº§è™Ÿ (ä¾‹: 05)">
        <input type="password" id="stuPw" class="login-input" autocomplete="current-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        <button class="send-btn" style="width: 100%; margin-top: 20px;" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
    </div>

    <div id="mainView" style="display: none;">
        <div class="top-nav">
            <div class="user-profile">
                <div id="navAvatar" class="avatar"></div>
                <div id="userName">è¼‰å…¥ä¸­...</div>
            </div>
            <button class="logout-btn" onclick="location.reload()">ç™»å‡ºç³»çµ±</button>
        </div>

        <div class="main-layout">
            <div class="left-col">
                <div class="card post-area">
                    <div class="post-input-wrapper">
                        <textarea id="msgInput" class="post-input" placeholder="æœ‰ä»€éº¼æ–°é®®äº‹æƒ³è·Ÿç­ä¸Šåˆ†äº«ï¼Ÿ..."></textarea>
                        <button class="send-btn" onclick="sendMsg()">ç™¼ä½ˆ</button>
                    </div>
                    <div id="selfMuteHint" class="mute-warning" style="display: none;"></div>
                </div>
                
                <div id="msgList" class="msg-list">
                    </div>
            </div>

            <div class="right-col">
                <button id="adminShowBtn" class="admin-toggle-btn" onclick="toggleAdminPanel(true)">
                    ğŸ›¡ï¸ é–‹å•Ÿç®¡ç†æ§åˆ¶å°
                </button>
                
                <div id="adminPanel">
                    <div class="admin-header">
                        <span style="font-size: 1.1rem; font-weight: bold;">ğŸ›¡ï¸ ç¦è¨€ç®¡ç†ç³»çµ±</span>
                        <button onclick="toggleAdminPanel(false)" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer;">é—œé–‰</button>
                    </div>
                    
                    <select id="targetSelect" class="admin-select"></select>
                    <select id="daysSelect" class="admin-select">
                        <option value="0.0416">ç¦è¨€ 1 å°æ™‚</option>
                        <option value="1">ç¦è¨€ 1 å¤©</option>
                        <option value="3">ç¦è¨€ 3 å¤©</option>
                        <option value="999">æ°¸ä¹…ç¦è¨€</option>
                    </select>
                    <button class="admin-btn" onclick="executeMute()">åŸ·è¡Œç¦è¨€</button>
                    
                    <div style="margin-top: 25px; border-top: 1px solid #334155; padding-top: 15px;">
                        <span style="color: #94a3b8; font-size: 0.85rem; font-weight: bold;">ç”Ÿæ•ˆä¸­çš„ç¦è¨€åå–®</span>
                        <div id="activeMuteList" style="max-height: 250px; overflow-y: auto; margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = { 
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null;
    let isMuted = false;

    // --- UI å„ªåŒ–æ–°åŠŸèƒ½ï¼šToast æç¤ºæ¡† ---
    function showToast(msg, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = 'ğŸ’¡';
        if(type === 'error') icon = 'âŒ';
        if(type === 'success') icon = 'âœ…';
        
        toast.innerHTML = `<span>${icon}</span> <span>${escapeHTML(msg)}</span>`;
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    // --- æ–°åŠŸèƒ½ï¼šè¨ˆç®—ç›¸å°æ™‚é–“ (Time Ago) ---
    function timeAgo(date) {
        if (!date) return "å‰›å‰›";
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return "å‰›å‰›";
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} åˆ†é˜å‰`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} å°æ™‚å‰`;
        const days = Math.floor(hours / 24);
        if (days < 7) return `${days} å¤©å‰`;
        return date.toLocaleDateString();
    }

    // --- æ–°åŠŸèƒ½ï¼šç¶²å€è‡ªå‹•è½‰æ›é€£çµ (Linkify) ---
    function linkify(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function(url) {
            return `<a href="${url}" target="_blank">${url}</a>`;
        });
    }

    // --- æ–°åŠŸèƒ½ï¼šç”¢ç”Ÿå°ˆå±¬é¡è‰²é ­åƒèƒŒæ™¯ ---
    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const hue = Math.abs(hash % 360);
        return `hsl(${hue}, 70%, 60%)`; // ä½¿ç”¨ HSL ç¢ºä¿é¡è‰²äº®éº—ä¸åˆºçœ¼
    }

    // --- å®‰å…¨é˜²è­·å·¥å…· ---
    async function hashPassword(password) {
        try {
            if (!crypto || !crypto.subtle) return password;
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (e) { return password; }
    }

    function escapeHTML(str) {
        return String(str||'').replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag));
    }

    // --- ç™»å…¥é‚è¼¯ ---
    async function doLogin() {
        const idInput = document.getElementById('stuId').value;
        const pwInput = document.getElementById('stuPw').value;
        if(!idInput || !pwInput) return showToast("è«‹å®Œæ•´è¼¸å…¥åº§è™Ÿèˆ‡å¯†ç¢¼", "error");

        const id = idInput.padStart(2, '0'); 
        const hashedInputPw = await hashPassword(pwInput); 

        try {
            const doc = await db.collection("students").doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                let isMatch = false;
                const isDbPasswordHashed = (data.password && data.password.length === 64);

                if (isDbPasswordHashed) {
                    if (data.password === hashedInputPw) isMatch = true;
                } else {
                    if (data.password === pwInput) {
                        isMatch = true;
                        await db.collection("students").doc(id).update({ password: hashedInputPw });
                    }
                }

                if (isMatch) {
                    if (data.status === "active") {
                        if (data.forceReset === true) {
                            showToast("æé†’ï¼šæ‚¨ç›®å‰ä½¿ç”¨çš„æ˜¯é è¨­å¯†ç¢¼ï¼Œè«‹ç›¡å¿«å‰å¾€é¦–é ä¿®æ”¹ï¼", "error");
                        } else {
                            showToast("ç™»å…¥æˆåŠŸï¼", "success");
                        }
                        me = { id, ...data };
                        startApp();
                    } else { 
                        showToast("å¸³è™Ÿå°šæœªå•Ÿç”¨ï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡æ ¸å‡†ã€‚", "error"); 
                    }
                } else { 
                    showToast("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥", "error"); 
                }
            } else { 
                showToast("æ‰¾ä¸åˆ°æ­¤åº§è™Ÿ", "error"); 
            }
        } catch (e) { showToast("é€£ç·šå¤±æ•—ï¼š" + e.message, "error"); }
    }

    function startApp() {
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('mainView').style.display = 'block';
        
        // è¨­å®šé ‚éƒ¨ä½¿ç”¨è€…è³‡è¨Šèˆ‡é ­åƒ
        const firstChar = me.name ? me.name.charAt(0) : me.id;
        const avatarEl = document.getElementById('navAvatar');
        avatarEl.innerText = firstChar;
        avatarEl.style.backgroundColor = stringToColor(me.name || me.id);
        document.getElementById('userName').innerText = `${escapeHTML(me.name)} (#${me.id})`;
        
        const isTeacher = (me.role === 'teacher' || me.role === 'admin');
        if (isTeacher) {
            document.getElementById('adminShowBtn').style.display = 'block';
            toggleAdminPanel(true);
            loadStudentSelector();
            listenMuteList();
        }
        
        listenMessages(isTeacher);
        checkMyMute();
    }

    // --- ç®¡ç†é¢æ¿æ§åˆ¶ ---
    function toggleAdminPanel(show) {
        document.getElementById('adminPanel').style.display = show ? 'block' : 'none';
        document.getElementById('adminShowBtn').style.display = show ? 'none' : 'block';
    }

    // --- ç¦è¨€é‚è¼¯ (åŸå°ä¸å‹•ä¿ç•™) ---
    async function loadStudentSelector() {
        const snap = await db.collection("students").get();
        const select = document.getElementById('targetSelect');
        const sorted = snap.docs.sort((a,b) => parseInt(a.id) - parseInt(b.id));
        select.innerHTML = '<option value="">è«‹é¸æ“‡è¦ç¦è¨€çš„å­¸ç”Ÿ...</option>';
        sorted.forEach(doc => {
            if(doc.data().role !== 'teacher') {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.innerText = `${parseInt(doc.id)}è™Ÿ ${escapeHTML(doc.data().name)}`;
                select.appendChild(opt);
            }
        });
    }

    function listenMuteList() {
        db.collection("mute_records").onSnapshot(async snap => {
            const listArea = document.getElementById('activeMuteList');
            listArea.innerHTML = '';
            
            const stuSnap = await db.collection("students").get();
            let names = {};
            stuSnap.forEach(d => names[d.id] = d.data().name);

            snap.forEach(doc => {
                const data = doc.data();
                if (data.until > Date.now()) {
                    const div = document.createElement('div');
                    div.className = 'active-mute-item';
                    div.innerHTML = `
                        <div>
                            <span style="font-weight:bold;">${parseInt(doc.id)}è™Ÿ ${escapeHTML(names[doc.id] || 'å­¸ç”Ÿ')}</span><br>
                            <small style="color:#94a3b8">è‡³ ${new Date(data.until).toLocaleString()}</small>
                        </div>
                        <button class="unmute-btn" onclick="unmute('${doc.id}')">è§£é™¤</button>
                    `;
                    listArea.appendChild(div);
                }
            });
        });
    }

    async function executeMute() {
        const sid = document.getElementById('targetSelect').value;
        const days = parseFloat(document.getElementById('daysSelect').value);
        if(!sid) return showToast("è«‹å…ˆé¸æ“‡è¦ç¦è¨€çš„å­¸ç”Ÿ", "error");
        
        const until = Date.now() + (days * 24 * 60 * 60 * 1000);
        await db.collection("mute_records").doc(sid).set({ until: until });
        showToast("å·²æˆåŠŸåŸ·è¡Œç¦è¨€", "success");
    }

    async function unmute(sid) { 
        if(confirm("ç¢ºå®šè§£é™¤æ­¤å­¸ç”Ÿçš„ç¦è¨€ï¼Ÿ")) {
            await db.collection("mute_records").doc(sid).delete(); 
            showToast("å·²è§£é™¤ç¦è¨€", "success");
        }
    }

    function checkMyMute() {
        db.collection("mute_records").doc(me.id).onSnapshot(doc => {
            const hint = document.getElementById('selfMuteHint');
            if (doc.exists && doc.data().until > Date.now()) {
                isMuted = true;
                hint.style.display = 'flex';
                hint.innerHTML = `âš ï¸ æ‚¨ç›®å‰è™•æ–¼ç¦è¨€ç‹€æ…‹ï¼Œé è¨ˆæ–¼ ${new Date(doc.data().until).toLocaleString()} è§£é™¤ã€‚`;
            } else {
                isMuted = false;
                hint.style.display = 'none';
            }
        });
    }

    // --- ç•™è¨€æ¿é‚è¼¯ ---
    async function sendMsg() {
        if (isMuted) return showToast("æ‚¨ç›®å‰è™•æ–¼ç¦è¨€ç‹€æ…‹ï¼Œç„¡æ³•ç™¼è¨€ï¼", "error");
        const inputEl = document.getElementById('msgInput');
        const content = inputEl.value.trim();
        if(!content) return;
        
        await db.collection("messages").add({
            author: me.name, authorId: me.id, content: content,
            role: me.role || 'student', createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        inputEl.value = "";
        showToast("ç•™è¨€ç™¼ä½ˆæˆåŠŸï¼", "success");
    }

    function listenMessages(isTeacher) {
        db.collection("messages").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
            const container = document.getElementById('msgList');
            container.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const rawDate = d.createdAt ? d.createdAt.toDate() : null;
                const displayTime = timeAgo(rawDate); // ä½¿ç”¨æ–°çš„ç›¸å°æ™‚é–“åŠŸèƒ½
                
                // å®‰å…¨è™•ç†ä¸¦è½‰æ›ç¶²å€
                const safeName = escapeHTML(d.author);
                let safeContent = escapeHTML(d.content);
                safeContent = linkify(safeContent); // å°‡ç¶²å€è®Šé€£çµ

                const avatarChar = safeName.charAt(0);
                const avatarColor = stringToColor(d.author || 'U');
                const isMsgTeacher = d.role === 'teacher' || d.role === 'admin';
                const roleTag = isMsgTeacher ? '<span class="msg-role-tag">ç®¡ç†å“¡</span>' : '';

                const div = document.createElement('div');
                div.className = `msg-item ${isMsgTeacher ? 'is-teacher' : ''}`;
                
                div.innerHTML = `
                    <div class="avatar" style="background-color: ${avatarColor}; flex-shrink: 0;">${avatarChar}</div>
                    <div class="msg-content-wrapper">
                        <div class="msg-header">
                            <div class="msg-author">
                                ${safeName} ${roleTag}
                                <span class="msg-time">${displayTime}</span>
                            </div>
                            ${isTeacher ? `<button class="delete-btn" title="åˆªé™¤ç•™è¨€" onclick="deleteMsg('${doc.id}')">âœ–</button>` : ''}
                        </div>
                        <div class="msg-text">${safeContent}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        });
    }

    async function deleteMsg(mid) { 
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ")) {
            await db.collection("messages").doc(mid).delete(); 
            showToast("ç•™è¨€å·²åˆªé™¤", "success");
        }
    }
</script>
</body>
</html>
