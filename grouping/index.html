<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éš¨æ©Ÿåˆ†çµ„å°å¹«æ‰‹</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #7209b7; /* ç´«è‰²ç³» */
            --secondary: #4361ee;
            --bg: #f8f9fa;
            --text: #333;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        h1 { color: var(--primary); text-align: center; margin-bottom: 25px; font-weight: 800; }
        
        /* è¨­å®šå€åŸŸæ¨£å¼ */
        .control-panel { background: #fdfdfd; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .grid-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.9rem; color: #555; }
        input[type="text"], input[type="number"], select { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 1rem; box-sizing: border-box; transition: border 0.2s;
        }
        input:focus, select:focus { border-color: var(--secondary); outline: none; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .action-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: transform 0.1s, opacity 0.2s; }
        button:active { transform: scale(0.98); }
        
        .btn-dl { background: #e9ecef; color: #495057; }
        .btn-up { background: var(--secondary); color: white; }
        .btn-absent { background: #ff9f1c; color: white; font-size: 0.85rem; padding: 6px 12px; margin-left: 10px; }
        .btn-go { background: var(--primary); color: white; width: 100%; font-size: 1.2rem; margin-top: 10px; padding: 15px; }
        button:disabled { background: #ddd; color: #999; cursor: not-allowed; }

        /* çµæœé¡¯ç¤ºå€ */
        .result-area { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        
        .group-card { 
            background: #fff; border: 1px solid #eee; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); overflow: hidden; 
            transition: transform 0.2s;
        }
        .group-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }

        .card-header { 
            background: var(--primary); color: white; padding: 12px 15px; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .card-title { font-weight: bold; font-size: 1.05rem; }
        
        .email-btn { 
            background: white; color: var(--primary); border: none; 
            padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: bold;
        }
        .email-btn:hover { background: #f0f0f0; }

        .card-body { padding: 15px; }
        .member-list { list-style: none; padding: 0; margin: 0; }
        .member-item { 
            padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; 
            display: flex; justify-content: space-between; 
        }
        .member-item:last-child { border-bottom: none; }
        
        .gender-tag { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; }
        .gender-m { background: #e3f2fd; color: #1565c0; } /* ç”·ç”Ÿè— */
        .gender-f { background: #fce4ec; color: #c2185b; } /* å¥³ç”Ÿç²‰ */

        /* çµ±è¨ˆè³‡è¨Š */
        .stats { font-size: 0.9rem; color: #666; margin-top: 5px; display: flex; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>ç­ç´šéš¨æ©Ÿåˆ†çµ„ç³»çµ±</h1>

    <div class="action-bar">
        <button class="btn-dl" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è¼‰ Excel ç¯„æœ¬</button>
        <button class="btn-up" onclick="document.getElementById('fileInput').click()">ğŸ“ åŒ¯å…¥å­¸ç”Ÿåå–®</button>
        <input type="file" id="fileInput" hidden accept=".xlsx, .xls" onchange="importExcel(this)">
    </div>

    <div class="control-panel">
        <div class="grid-box">
            <div>
                <label>ç­ç´šåç¨±</label>
                <input type="text" id="className" placeholder="ä¾‹å¦‚ï¼š204ç­">
            </div>
            <div>
                <label>èª²ç¨‹åç¨±</label>
                <input type="text" id="courseName" placeholder="ä¾‹å¦‚ï¼šæ•¸ä½ç§‘æŠ€æ¦‚è«–ç¡¬é«”å ±å‘Š">
            </div>
        </div>

        <hr style="border: 0; border-top: 1px dashed #ddd; margin: 15px 0;">

        <div class="grid-box">
            <div>
                <label>åˆ†çµ„æ¨¡å¼</label>
                <select id="mode" onchange="updateModeLabel()">
                    <option value="perGroup">å›ºå®šæ¯çµ„äººæ•¸ (æ¯çµ„å¹¾äºº)</option>
                    <option value="totalGroups">å›ºå®šç¸½çµ„æ•¸ (å…¨ç­åˆ†å¹¾çµ„)</option>
                </select>
            </div>
            <div>
                <label id="modeLabel">æ¯çµ„äººæ•¸</label>
                <input type="number" id="modeValue" value="4" min="1">
            </div>
            <div>
                <label>æ€§åˆ¥åˆ†é…</label>
                <select id="genderMode" disabled title="éœ€åŒ¯å…¥å«æœ‰ã€Œæ€§åˆ¥ã€æ¬„ä½çš„åå–®">
                    <option value="mixed">ç”·å¥³æ··åˆ (éš¨æ©Ÿ)</option>
                    <option value="separate">ç”·å¥³åˆ†é–‹ (ç”·ç”Ÿä¸€çµ„ã€å¥³ç”Ÿä¸€çµ„)</option>
                </select>
            </div>
        </div>

        <div class="stats">
            <span>ç›®å‰åå–®ï¼š<strong id="studentCount" style="color:var(--primary)">0</strong> äºº</span>
            <button class="btn-absent" onclick="setAbsent()">ğŸš« è¨­å®šç¼ºå¸­</button>
            <span id="absentDisplay" style="margin-left: 10px; font-size: 0.85rem; color: #d93025;"></span>
        </div>
    </div>

    <button class="btn-go" onclick="runGrouping()">ğŸš€ é–‹å§‹åˆ†çµ„</button>

    <div id="resultArea" class="result-area"></div>
</div>

<script>
    let allStudents = []; // åŸå§‹è³‡æ–™
    let absentIds = [];   // ç¼ºå¸­åº§è™Ÿåˆ—è¡¨

    // 1. ä¸‹è¼‰ç¯„æœ¬
    function downloadTemplate() {
        const data = [
            ["åº§è™Ÿ", "å§“å", "æ€§åˆ¥", "æ•™è‚²ä¿¡ç®±"],
            [1, "ç‹å¤§æ˜", "ç”·", "s110001@edu.tw"],
            [2, "é™³å°ç¾", "å¥³", "s110002@edu.tw"],
            [3, "æ—å°è±ª", "ç”·", "s110003@edu.tw"],
            [4, "å¼µé›…å©·", "å¥³", "s110004@edu.tw"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å­¸ç”Ÿåå–®");
        XLSX.writeFile(wb, "åˆ†çµ„åå–®ç¯„æœ¬.xlsx");
    }

    // 2. åŒ¯å…¥ Excel
    function importExcel(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            // å°‡ Excel è½‰ç‚º JSON
            const json = XLSX.utils.sheet_to_json(firstSheet);

            if(json.length === 0) {
                alert("æª”æ¡ˆå…§æ²’æœ‰è³‡æ–™ï¼");
                return;
            }

            allStudents = json;
            document.getElementById('studentCount').innerText = allStudents.length;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ã€Œæ€§åˆ¥ã€æ¬„ä½
            const hasGender = allStudents[0].hasOwnProperty('æ€§åˆ¥');
            const genderSelect = document.getElementById('genderMode');
            
            if (hasGender) {
                genderSelect.disabled = false;
                alert(`åŒ¯å…¥æˆåŠŸï¼å…± ${allStudents.length} äºº\nåµæ¸¬åˆ°æ€§åˆ¥æ¬„ä½ï¼Œå·²è§£é–ã€Œç”·å¥³åˆ†é–‹ã€åŠŸèƒ½ã€‚`);
            } else {
                genderSelect.disabled = true;
                genderSelect.value = "mixed";
                alert(`åŒ¯å…¥æˆåŠŸï¼å…± ${allStudents.length} äºº\nâš ï¸ è­¦å‘Šï¼šåå–®ç¼ºå°‘ã€Œæ€§åˆ¥ã€æ¬„ä½ï¼Œç„¡æ³•ä½¿ç”¨ç”·å¥³åˆ†é–‹åŠŸèƒ½ã€‚`);
            }
        };
        reader.readAsArrayBuffer(file);
        // æ¸…ç©º input è®“åŒå€‹æª”æ¡ˆå¯ä»¥å†é¸ä¸€æ¬¡
        input.value = ''; 
    }

    // 3. è¨­å®šç¼ºå¸­
    function setAbsent() {
        const current = absentIds.join(",");
        const input = prompt("è«‹è¼¸å…¥ç¼ºå¸­åº§è™Ÿ (ç”¨é€—è™Ÿéš”é–‹ï¼Œä¾‹å¦‚: 5,12,30)", current);
        if (input !== null) {
            // æ¸…ç†è¼¸å…¥è³‡æ–™ï¼Œè½‰æˆæ•¸å­—é™£åˆ—
            absentIds = input.split(/[,ï¼Œ]/)
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));
            
            const display = absentIds.length > 0 ? `(ç¼ºå¸­: ${absentIds.join(", ")})` : "";
            document.getElementById('absentDisplay').innerText = display;
        }
    }

    // 4. æ›´æ–°ä»‹é¢æ–‡å­—
    function updateModeLabel() {
        const mode = document.getElementById('mode').value;
        document.getElementById('modeLabel').innerText = (mode === 'perGroup') ? "æ¯çµ„äººæ•¸" : "ç¸½çµ„æ•¸";
    }

    // 5. æ ¸å¿ƒåˆ†çµ„é‚è¼¯
    function runGrouping() {
        if (allStudents.length === 0) return alert("è«‹å…ˆåŒ¯å…¥åå–®ï¼");

        // éæ¿¾ç¼ºå¸­è€…
        const activeStudents = allStudents.filter(s => !absentIds.includes(parseInt(s.åº§è™Ÿ)));
        
        if(activeStudents.length === 0) return alert("æ²’æœ‰å‡ºå¸­çš„å­¸ç”Ÿå¯åˆ†çµ„ï¼");

        const genderMode = document.getElementById('genderMode').value;
        const mode = document.getElementById('mode').value;
        const val = parseInt(document.getElementById('modeValue').value);

        if(isNaN(val) || val < 1) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—");

        let finalGroups = [];

        if (genderMode === 'separate') {
            // --- ç”·å¥³åˆ†é–‹é‚è¼¯ ---
            // 1. ç¯©é¸
            const boys = activeStudents.filter(s => s.æ€§åˆ¥ === 'ç”·');
            const girls = activeStudents.filter(s => s.æ€§åˆ¥ === 'å¥³');

            // 2. åˆ†åˆ¥åˆ†çµ„
            const boyGroups = performGrouping(boys, mode, val, "ç”·ç”Ÿç¬¬");
            const girlGroups = performGrouping(girls, mode, val, "å¥³ç”Ÿç¬¬");

            // 3. åˆä½µ
            finalGroups = [...boyGroups, ...girlGroups];

        } else {
            // --- ç”·å¥³æ··åˆé‚è¼¯ ---
            finalGroups = performGrouping(activeStudents, mode, val, "ç¬¬");
        }

        renderCards(finalGroups);
    }

    /**
     * é€šç”¨åˆ†çµ„é‹ç®—å‡½å¼
     * @param {Array} list å­¸ç”Ÿåå–®
     * @param {String} mode æ¨¡å¼ (perGroup / totalGroups)
     * @param {Number} val æ•¸å€¼
     * @param {String} prefix çµ„åˆ¥åç¨±å‰ç¶´ (å¦‚ "ç”·ç”Ÿç¬¬")
     */
    function performGrouping(list, mode, val, prefix) {
        if (list.length === 0) return [];

        // éš¨æ©Ÿæ´—ç‰Œ (Fisher-Yates Shuffle)
        let shuffled = [...list];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        // è¨ˆç®—è¦åˆ†å¹¾çµ„
        let groupCount;
        if (mode === 'perGroup') {
            groupCount = Math.ceil(shuffled.length / val);
        } else {
            groupCount = val;
        }

        // é¿å…çµ„æ•¸å¤§æ–¼äººæ•¸
        if (groupCount > shuffled.length) groupCount = shuffled.length;

        // åˆå§‹åŒ–ç©ºé™£åˆ—
        let groups = Array.from({ length: groupCount }, () => []);

        // åˆ†é… (Så½¢åˆ†é…æˆ–ä¾åºåˆ†é…ï¼Œé€™è£¡ç”¨é¤˜æ•¸åˆ†é…æœ€å¹³å‡)
        shuffled.forEach((student, index) => {
            groups[index % groupCount].push(student);
        });

        // æ•´ç†å›å‚³æ ¼å¼
        return groups.map((members, i) => ({
            title: `${prefix} ${i + 1} çµ„`,
            members: members
        }));
    }

    // 6. æ¸²æŸ“ç•«é¢
    function renderCards(groups) {
        const container = document.getElementById('resultArea');
        const className = document.getElementById('className').value || "ç­ç´š";
        const courseName = document.getElementById('courseName').value || "èª²ç¨‹";
        
        container.innerHTML = "";

        groups.forEach(group => {
            // æ”¶é›† Email
            const emails = group.members.map(s => s.æ•™è‚²ä¿¡ç®±).filter(e => e).join(",");
            // æ”¶é›†å§“å (çµ¦ Email å…§æ–‡ç”¨)
            const names = group.members.map(s => s.å§“å).join("ã€");

            // ç”¢ç”Ÿ HTML
            const card = document.createElement('div');
            card.className = 'group-card';
            
            let listHtml = group.members.map(s => {
                // åˆ¤æ–·æ€§åˆ¥æ¨£å¼
                let genderClass = 'gender-tag';
                if(s.æ€§åˆ¥ === 'ç”·') genderClass += ' gender-m';
                if(s.æ€§åˆ¥ === 'å¥³') genderClass += ' gender-f';
                
                return `
                <li class="member-item">
                    <span>${s.åº§è™Ÿ}. ${s.å§“å}</span>
                    ${s.æ€§åˆ¥ ? `<span class="${genderClass}">${s.æ€§åˆ¥}</span>` : ''}
                </li>`;
            }).join("");

            card.innerHTML = `
                <div class="card-header">
                    <span class="card-title">${group.title}</span>
                    <button class="email-btn" onclick="sendMail('${emails}', '${group.title}', '${className}', '${courseName}', '${names}')">
                        âœ‰ï¸ é€šçŸ¥å…¨çµ„
                    </button>
                </div>
                <div class="card-body">
                    <ul class="member-list">
                        ${listHtml}
                    </ul>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // 7. ç™¼é€éƒµä»¶
    function sendMail(emails, groupTitle, className, course, names) {
        if (!emails) return alert("é€™ä¸€çµ„çš„æˆå“¡éƒ½æ²’æœ‰å¡«å¯« Email å–”ï¼");
        
        const subject = encodeURIComponent(`[${className}] ${course} - åˆ†çµ„é€šçŸ¥`);
        const body = encodeURIComponent(
`åŒå­¸å¥½ï¼š

é€™æ˜¯ä¸€å°ä¾†è‡ªèª²ç¨‹åˆ†çµ„ç³»çµ±çš„è‡ªå‹•é€šçŸ¥ã€‚
åœ¨ã€Œ${course}ã€èª²ç¨‹ä¸­ï¼Œä½ è¢«åˆ†é…åˆ°äº†ã€${groupTitle}ã€‘ã€‚

åŒçµ„çµ„å“¡åå–®å¦‚ä¸‹ï¼š
${names}

è«‹ä¸»å‹•èˆ‡çµ„å“¡è¯ç¹«ä¸¦å±•é–‹è¨è«–ï¼Œå¦‚æœ‰å•é¡Œè«‹å„˜é€Ÿå‘ŠçŸ¥è€å¸«ï¼`
        );
        
        // ä½¿ç”¨ window.open é–‹å•Ÿæ¯”è¼ƒä¿éšªï¼Œæˆ–æ˜¯ location.href
        window.location.href = `mailto:${emails}?subject=${subject}&body=${body}`;
    }
</script>

</body>
</html>
