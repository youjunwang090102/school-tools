<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éš¨æ©Ÿåˆ†çµ„å°å¹«æ‰‹ - ç­ç´šæ•¸ä½å¹³å°</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #7209b7;
            --bg: #f8f9fa;
        }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; }
        
        .setup-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 10px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-download { background: #e9ecef; color: #495057; }
        .btn-import { background: #4361ee; color: white; }
        .btn-main { background: var(--primary); color: white; width: 100%; font-size: 1.1rem; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .result-group { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .group-card { border: 2px solid #f0f0f0; border-radius: 10px; padding: 15px; background: #fff; }
        .group-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 10px; padding-bottom: 5px; }
        .email-btn { background: #2ec4b6; color: white; font-size: 0.8rem; padding: 5px 10px; }
        
        .member-list { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; }
        .member-item { padding: 3px 0; border-bottom: 1px dashed #eee; }
        .absent { color: #ccc; text-decoration: line-through; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ² éš¨æ©Ÿåˆ†çµ„å°å¹«æ‰‹</h1>

    <div class="btn-group">
        <button class="btn-download" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è¼‰ Excel ç¯„æœ¬</button>
        <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“ åŒ¯å…¥å­¸ç”Ÿåå–®</button>
        <input type="file" id="fileInput" hidden accept=".xlsx, .xls" onchange="importExcel(this)">
    </div>

    <div class="setup-section">
        <div class="full-width">
            <label>ç­ç´šåç¨±</label>
            <input type="text" id="className" placeholder="ä¾‹å¦‚ï¼šè³‡ä¸‰ç”²">
        </div>
        <div class="full-width">
            <label>èª²ç¨‹åç¨±</label>
            <input type="text" id="courseName" placeholder="ä¾‹å¦‚ï¼šå°ˆé¡Œè£½ä½œ">
        </div>
        <div>
            <label>åˆ†çµ„æ–¹å¼</label>
            <select id="mode" onchange="toggleMode()">
                <option value="perGroup">å›ºå®šæ¯çµ„äººæ•¸</option>
                <option value="totalGroups">å›ºå®šç¸½çµ„æ•¸</option>
            </select>
        </div>
        <div>
            <label id="modeLabel">æ¯çµ„å¹¾äºº</label>
            <input type="number" id="modeValue" value="4" min="1">
        </div>
        <div>
            <label>æ€§åˆ¥è¨­å®š</label>
            <select id="genderMode" disabled title="éœ€åŒ¯å…¥å«æ€§åˆ¥ä¹‹åå–®">
                <option value="mixed">ç”·å¥³æ··åˆ</option>
                <option value="separate">ç”·å¥³åˆ†é–‹</option>
            </select>
        </div>
        <div>
            <label>ç›®å‰å­¸ç”Ÿï¼š<span id="studentCount">0</span> äºº</label>
            <button onclick="manageAbsent()" style="font-size: 0.8rem; padding: 5px;">è¨­å®šç¼ºå¸­</button>
        </div>
    </div>

    <button class="btn-main" onclick="startGrouping()">é–‹å§‹åˆ†çµ„</button>

    <div id="resultArea" class="result-group">
        </div>
</div>

<script>
    let students = []; // åŸå§‹åå–®
    let absentList = []; // ç¼ºå¸­åº§è™Ÿ

    // 1. ä¸‹è¼‰ç¯„æœ¬
    function downloadTemplate() {
        const data = [
            ["åº§è™Ÿ", "å§“å", "æ€§åˆ¥", "æ•™è‚²ä¿¡ç®±"],
            [1, "ç‹å°æ˜", "ç”·", "student1@edu.tw"],
            [2, "æå°è¯", "å¥³", "student2@edu.tw"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "åå–®");
        XLSX.writeFile(wb, "ç­ç´šåˆ†çµ„åå–®ç¯„æœ¬.xlsx");
    }

    // 2. åŒ¯å…¥ Excel
    function importExcel(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(firstSheet);
            
            students = json;
            document.getElementById('studentCount').innerText = students.length;

            // æª¢æŸ¥æ˜¯å¦æœ‰æ€§åˆ¥æ¬„ä½
            const hasGender = students.length > 0 && students[0].hasOwnProperty('æ€§åˆ¥');
            const genderSelect = document.getElementById('genderMode');
            genderSelect.disabled = !hasGender;
            if(!hasGender) genderSelect.value = "mixed";

            alert("åŒ¯å…¥æˆåŠŸï¼å…± " + students.length + " ä½å­¸ç”Ÿ");
        };
        reader.readAsArrayBuffer(file);
    }

    // 3. è¨­å®šç¼ºå¸­ (ç°¡å–® Prompt è™•ç†)
    function manageAbsent() {
        let input = prompt("è«‹è¼¸å…¥ç¼ºå¸­åº§è™Ÿ (ç”¨é€—è™Ÿéš”é–‹ï¼Œä¾‹å¦‚: 3,15,22)", absentList.join(","));
        if (input !== null) {
            absentList = input.split(",").map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            alert("å·²è¨˜éŒ„ç¼ºå¸­åº§è™Ÿï¼š" + absentList.join(", "));
        }
    }

    function toggleMode() {
        const mode = document.getElementById('mode').value;
        document.getElementById('modeLabel').innerText = (mode === 'perGroup') ? "æ¯çµ„å¹¾äºº" : "ç¸½å…±åˆ†å¹¾çµ„";
    }

    // 4. åˆ†çµ„é‚è¼¯
    function startGrouping() {
        if (students.length === 0) return alert("è«‹å…ˆåŒ¯å…¥åå–®");
        
        let activeStudents = students.filter(s => !absentList.includes(parseInt(s.åº§è™Ÿ)));
        let result = [];
        const genderMode = document.getElementById('genderMode').value;

        if (genderMode === 'separate') {
            let boys = shuffle(activeStudents.filter(s => s.æ€§åˆ¥ === 'ç”·'));
            let girls = shuffle(activeStudents.filter(s => s.æ€§åˆ¥ === 'å¥³'));
            // é€™è£¡å¯ä»¥æ ¹æ“šéœ€æ±‚å¯¦ä½œç”·å¥³å„è‡ªåˆ†çµ„æˆ–äº¤éŒ¯ï¼Œç°¡å–®ç‰ˆæˆ‘å€‘å…ˆåˆ†åˆ¥éš¨æ©Ÿæ‰“äº‚å†åˆä½µ
            activeStudents = [...boys, ...girls]; 
        } else {
            activeStudents = shuffle(activeStudents);
        }

        const mode = document.getElementById('mode').value;
        const val = parseInt(document.getElementById('modeValue').value);
        
        let groupCount;
        if (mode === 'perGroup') {
            groupCount = Math.ceil(activeStudents.length / val);
        } else {
            groupCount = val;
        }

        // åˆå§‹åŒ–çµ„åˆ¥
        for(let i=0; i<groupCount; i++) result[i] = [];

        // åˆ†é…äººå“¡
        activeStudents.forEach((st, index) => {
            result[index % groupCount].push(st);
        });

        renderResult(result);
    }

    // æ´—ç‰Œæ¼”ç®—æ³•
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // 5. æ¸²æŸ“çµæœèˆ‡ç™¼ä¿¡åŠŸèƒ½
    function renderResult(groups) {
        const container = document.getElementById('resultArea');
        const className = document.getElementById('className').value || "ç­ç´š";
        const courseName = document.getElementById('courseName').value || "èª²ç¨‹";
        container.innerHTML = "";

        groups.forEach((group, index) => {
            const emails = group.map(s => s.æ•™è‚²ä¿¡ç®±).filter(e => e).join(",");
            const names = group.map(s => s.å§“å).join("ã€");
            
            const card = document.createElement('div');
            card.className = 'group-card';
            card.innerHTML = `
                <div class="group-header">
                    <strong>ç¬¬ ${index + 1} çµ„</strong>
                    <button class="email-btn" onclick="sendMail('${emails}', ${index+1}, '${className}', '${courseName}', '${names}')">ğŸ“§ é€šçŸ¥å…¨çµ„</button>
                </div>
                <ul class="member-list">
                    ${group.map(s => `<li class="member-item">${s.åº§è™Ÿ}. ${s.å§“å} (${s.æ€§åˆ¥})</li>`).join("")}
                </ul>
            `;
            container.appendChild(card);
        });
    }

    function sendMail(emails, groupNum, className, course, names) {
        if(!emails) return alert("åå–®å…§ç„¡ä¿¡ç®±è³‡æ–™");
        const subject = encodeURIComponent(`[${className}] ${course} - åˆ†çµ„é€šçŸ¥`);
        const body = encodeURIComponent(`åŒå­¸å¥½ï¼š\n\nä½ åœ¨ã€Œ${course}ã€èª²ç¨‹ä¸­è¢«åˆ†é…åˆ°ç¬¬ ${groupNum} çµ„ã€‚\nåŒçµ„çµ„å“¡æœ‰ï¼š${names}\n\nè«‹ä¸»å‹•èˆ‡çµ„å“¡è¯ç¹«ä¸¦å±•é–‹è¨è«–ã€‚`);
        window.location.href = `mailto:${emails}?subject=${subject}&body=${body}`;
    }
</script>

</body>
</html>
