<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>班級匿名許願池</title>
    <style>
        :root {
            --ios-blue: #007AFF; --ios-gray: #8E8E93;
            --bg: #F2F2F7; --bubble-bg: #FFFFFF;
        }
        body { 
            font-family: -apple-system, sans-serif; background: var(--bg); 
            margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh;
        }

        /* 頂部標題 */
        .nav-bar {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
            padding: 40px 20px 15px; border-bottom: 0.5px solid #C6C6C8;
            position: sticky; top: 0; z-index: 10; text-align: center;
        }
        .nav-bar h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .back-link { position: absolute; left: 15px; bottom: 15px; color: var(--ios-blue); text-decoration: none; font-size: 16px; }

        /* 留言顯示區 */
        #messageContainer {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 12px;
        }

        /* iOS 氣泡樣式 */
        .msg-wrapper { 
            display: flex; flex-direction: column; align-items: flex-start;
            animation: bubbleUp 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .bubble { 
            background: var(--bubble-bg); padding: 12px 16px; border-radius: 18px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-width: 85%;
            font-size: 16px; line-height: 1.4; color: #000; position: relative;
        }
        .time-tag { font-size: 11px; color: var(--ios-gray); margin: 4px 0 0 5px; }
        
        /* 刪除按鈕 (僅限老師) */
        .del-btn { 
            color: #FF3B30; font-size: 11px; margin-left: 8px; cursor: pointer; 
            border: 1px solid #FF3B30; border-radius: 4px; padding: 1px 4px;
        }

        /* 底部輸入框 */
        .input-area {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            padding: 10px 15px calc(10px + env(safe-area-inset-bottom));
            border-top: 0.5px solid #C6C6C8; display: flex; gap: 10px;
        }
        .ios-input {
            flex: 1; border: 1px solid #C6C6C8; background: #FFF;
            padding: 8px 15px; border-radius: 20px; font-size: 16px; outline: none;
        }
        .send-btn {
            background: var(--ios-blue); color: #FFF; border: none;
            width: 32px; height: 32px; border-radius: 50%; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        @keyframes bubbleUp {
            from { opacity: 0; transform: translateY(15px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <a href="../index.html" class="back-link">ㄑ 返回</a>
        <h1>班級許願池</h1>
    </div>

    <div id="messageContainer">
        </div>

    <div class="input-area">
        <input type="text" id="msgInput" class="ios-input" placeholder="匿名留言...">
        <button class="send-btn" onclick="sendMessage()">↑</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

    <script>
        // 請確保這裡的 Config 與您行事曆的一致
        const firebaseConfig = {
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 偵測是否從主頁傳遞了管理權限
        const isAdmin = sessionStorage.getItem('isClassAdmin') === 'true';

        // 1. 發送留言
        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;

            try {
                await db.collection("anonymous_messages").add({
                    content: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = ""; // 清空輸入框
            } catch (e) {
                alert("發送失敗，請檢查網路連接");
            }
        }

        // 2. 監聽資料庫 (這就是「顯示結果」的關鍵)
        function loadMessages() {
            db.collection("anonymous_messages").orderBy("timestamp", "asc")
              .onSnapshot((snapshot) => {
                const container = document.getElementById('messageContainer');
                container.innerHTML = ""; // 重新渲染前清空

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "傳送中...";
                    
                    const msgHtml = `
                        <div class="msg-wrapper">
                            <div class="bubble">
                                ${data.content}
                                ${isAdmin ? `<span class="del-btn" onclick="deleteMsg('${doc.id}')">刪除</span>` : ''}
                            </div>
                            <span class="time-tag">${time}</span>
                        </div>
                    `;
                    container.innerHTML += msgHtml;
                });
                
                // 自動滾動到底部
                container.scrollTop = container.scrollHeight;
            });
        }

        // 3. 刪除功能
        async function deleteMsg(id) {
            if (confirm("老師，確定要移除這條學生留言嗎？")) {
                await db.collection("anonymous_messages").doc(id).delete();
            }
        }

        // 啟動監聽
        loadMessages();

        // 支援 Enter 鍵發送
        document.getElementById('msgInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
