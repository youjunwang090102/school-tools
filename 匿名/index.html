<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Áè≠Á¥öÂåøÂêçË®±È°òÊ±†</title>
    <style>
        :root {
            /* Ê∑∫Ëâ≤Ê®°Âºè */
            --bg-color: #F2F2F7;
            --nav-bg: rgba(255, 255, 255, 0.9);
            --bubble-bg: #FFFFFF;
            --bubble-text: #000000;
            --meta-text: #8E8E93;
            --input-bg: #FFFFFF;
            --border-color: #C6C6C8;
            --highlight: #007AFF;
            --pinned-bg: #FFF8E1;
            --pinned-border: #FFD54F;
            --reaction-bg: #F2F2F7;
        }

        /* Ê∑±Ëâ≤Ê®°Âºè */
        [data-theme="dark"] {
            --bg-color: #000000;
            --nav-bg: rgba(28, 28, 30, 0.9);
            --bubble-bg: #2C2C2E;
            --bubble-text: #FFFFFF;
            --meta-text: #98989D;
            --input-bg: #1C1C1E;
            --border-color: #38383A;
            --highlight: #0A84FF;
            --pinned-bg: #3E3008;
            --pinned-border: #FFB300;
            --reaction-bg: #3A3A3C;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-color); color: var(--bubble-text);
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        .nav-bar {
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 45px 15px 15px; border-bottom: 0.5px solid var(--border-color);
            position: sticky; top: 0; z-index: 100; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-center { flex: 1; text-align: center; }
        .nav-bar h1 { margin: 0; font-size: 17px; font-weight: 600; cursor: pointer; user-select: none; }
        .nav-btn { color: var(--highlight); text-decoration: none; font-size: 16px; background: none; border: none; cursor: pointer; padding: 5px; }

        #messageContainer, #pinnedContainer {
            padding: 15px; display: flex; flex-direction: column; gap: 15px;
        }
        #messageContainer { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #pinnedContainer { padding-bottom: 0; display: none; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 5px;}

        .msg-wrapper {
            display: flex; flex-direction: column; align-items: flex-start; 
            max-width: 88%; animation: popIn 0.3s ease-out; position: relative;
        }
        
        .bubble {
            background: var(--bubble-bg); padding: 12px 16px;
            border-radius: 20px; border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            color: var(--bubble-text); font-size: 16px; line-height: 1.5;
            word-break: break-word; position: relative;
            transition: background 0.3s, color 0.3s;
        }

        .pinned-bubble {
            border: 2px solid var(--pinned-border);
            background: var(--pinned-bg);
            width: 100%; box-sizing: border-box;
        }
        .pinned-badge {
            font-size: 11px; font-weight: 800; color: #FF9500;
            display: block; margin-bottom: 4px; letter-spacing: 0.5px;
        }

        .reaction-bar {
            display: flex; gap: 6px; margin-top: 6px; margin-left: 4px;
        }
        .react-btn {
            background: var(--reaction-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 4px 10px; font-size: 13px; color: var(--meta-text);
            cursor: pointer; display: flex; align-items: center; gap: 4px;
            transition: all 0.2s; user-select: none;
        }
        .react-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }

        .meta-row {
            margin-top: 4px; margin-left: 6px;
            display: flex; flex-direction: column; gap: 2px;
        }
        .time-tag { font-size: 11px; color: var(--meta-text); }
        
        .admin-info {
            font-size: 10px; color: var(--meta-text); font-family: monospace;
            background: rgba(128,128,128,0.1); padding: 2px 4px; border-radius: 4px;
            display: none; width: fit-content; margin-top: 2px;
        }
        .admin-actions {
            display: none; gap: 12px; margin-top: 6px;
        }
        .adm-link { font-size: 12px; cursor: pointer; text-decoration: underline; font-weight: bold;}
        .adm-del { color: #FF3B30; }
        .adm-pin { color: #FF9500; }

        .input-area {
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 10px 15px calc(10px + env(safe-area-inset-bottom));
            border-top: 0.5px solid var(--border-color);
            display: flex; align-items: center; gap: 10px;
        }
        .ios-input {
            flex: 1; border: 1px solid var(--border-color); background: var(--input-bg);
            color: var(--bubble-text); padding: 9px 15px; border-radius: 20px; 
            font-size: 16px; outline: none; transition: background 0.3s;
        }
        .send-btn {
            background: var(--highlight); color: #FFF; border: none;
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 18px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .send-btn:disabled { opacity: 0.5; }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <a href="../index.html" class="nav-btn">„Ñë ËøîÂõû</a>
        <div class="nav-center">
            <h1 id="secretTitle">Áè≠Á¥öË®±È°òÊ±†</h1>
        </div>
        <button class="nav-btn" onclick="toggleTheme()" id="themeBtn">üåë</button>
    </div>

    <div id="pinnedContainer"></div>

    <div id="messageContainer"></div>

    <div class="input-area">
        <input type="text" id="msgInput" class="ios-input" placeholder="ÂåøÂêçË™™Èªû‰ªÄÈ∫º..." autocomplete="off">
        <button id="sendBtn" class="send-btn" onclick="sendMessage()">‚Üë</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

    <script>
        // === 1. Firebase Ë®≠ÂÆö ===
        // Ë´ãÁ¢∫Ë™ç apiKey Ê≠£Á¢∫
        const firebaseConfig = {
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // === 2. ËÆäÊï∏ ===
        let isAdmin = sessionStorage.getItem('isClassAdmin') === 'true';
        let clickCount = 0;
        let clientIP = "Êú™Áü• IP";

        // === 3. ÂàùÂßãÂåñ ===
        function init() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
            }

            fetch('https://api.ipify.org?format=json')
                .then(r => r.json())
                .then(d => clientIP = d.ip)
                .catch(() => {});

            document.getElementById('msgInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            setupAdminTrigger();
            listenToMessages();
        }

        // === 4. ÂäüËÉΩ ===

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeBtn').innerText = 'üåë';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const btn = document.getElementById('sendBtn');
            const text = input.value.trim();

            if (!text) return;

            btn.disabled = true;

            try {
                let device = "PC/Desktop";
                if (navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/i)) {
                    device = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/i)[0];
                }

                await db.collection("anonymous_messages").add({
                    content: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isPinned: false,
                    ip: clientIP,
                    device: device,
                    reactions: { love: 0, haha: 0, sad: 0, wow: 0 }
                });
                input.value = "";
            } catch (e) {
                alert("ÁôºÈÄÅÂ§±ÊïóÔºÅÈåØË™§: " + e.message);
            } finally {
                btn.disabled = false;
                input.focus();
            }
        }

        function listenToMessages() {
            db.collection("anonymous_messages")
              .orderBy("timestamp", "asc")
              .onSnapshot(snap => {
                  const normalList = document.getElementById('messageContainer');
                  const pinnedList = document.getElementById('pinnedContainer');
                  
                  normalList.innerHTML = "";
                  pinnedList.innerHTML = "";
                  let hasPinned = false;

                  snap.forEach(doc => {
                      const data = doc.data();
                      const id = doc.id;
                      const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "ÂÇ≥ÈÄÅ‰∏≠...";
                      
                      const r = data.reactions || { love: 0, haha: 0, sad: 0, wow: 0 };
                      
                      const html = `
                          <div class="msg-wrapper" style="${data.isPinned ? 'max-width: 100%;' : ''}">
                              <div class="bubble ${data.isPinned ? 'pinned-bubble' : ''}">
                                  ${data.isPinned ? '<span class="pinned-badge">üìå ÁΩÆÈ†ÇÂÖ¨Âëä</span>' : ''}
                                  ${escapeHtml(data.content)}
                              </div>
                              
                              <div class="reaction-bar">
                                  <div class="react-btn" onclick="react('${id}', 'love')">‚ù§Ô∏è ${r.love || 0}</div>
                                  <div class="react-btn" onclick="react('${id}', 'haha')">üòÇ ${r.haha || 0}</div>
                                  <div class="react-btn" onclick="react('${id}', 'wow')">üòÆ ${r.wow || 0}</div>
                                  <div class="react-btn" onclick="react('${id}', 'sad')">üò¢ ${r.sad || 0}</div>
                              </div>

                              <div class="meta-row">
                                  <span class="time-tag">${time}</span>
                                  
                                  ${isAdmin ? `
                                      <div class="admin-info">IP: ${data.ip || 'Èö±Ëóè'} | ${data.device || 'Êú™Áü•'}</div>
                                      <div class="admin-actions" style="display:flex;">
                                          <span class="adm-link adm-pin" onclick="togglePin('${id}', ${data.isPinned})">${data.isPinned ? 'ÂèñÊ∂àÁΩÆÈ†Ç' : 'ÁΩÆÈ†Ç'}</span>
                                          <span class="adm-link adm-del" onclick="deleteMsg('${id}')">Âà™Èô§</span>
                                      </div>
                                  ` : ''}
                              </div>
                          </div>
                      `;

                      if (data.isPinned) {
                          pinnedList.innerHTML += html;
                          hasPinned = true;
                      } else {
                          normalList.innerHTML += html;
                      }
                  });

                  pinnedList.style.display = hasPinned ? 'flex' : 'none';
                  normalList.scrollTop = normalList.scrollHeight;
              });
        }

        // === ÈóúÈçµ‰øÆÊ≠£ÔºöÊåâÂøÉÊÉÖÂäüËÉΩ ===
        async function react(docId, type) {
            // Êú¨Âú∞Èò≤ÈáçË§áÈªûÊìä (Á∞°ÊòìÁâà)
            const key = `reacted_${docId}_${type}`;
            if (localStorage.getItem(key)) return; 

            const docRef = db.collection("anonymous_messages").doc(docId);
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (!doc.exists) return;

                    // Á¢∫‰øùÊ¨Ñ‰ΩçÂ≠òÂú®ÔºåÈÅøÂÖçËàäË≥áÊñôÂ†±ÈåØ
                    const newReactions = doc.data().reactions || { love: 0, haha: 0, sad: 0, wow: 0 };
                    newReactions[type] = (newReactions[type] || 0) + 1;
                    
                    transaction.update(docRef, { reactions: newReactions });
                });
                // ÊàêÂäüÂæåÊâçË®òÈåÑÂà∞Êú¨Âú∞
                localStorage.setItem(key, 'true');
            } catch (e) {
                console.error("Reaction failed:", e);
                // Â¶ÇÊûúË∑≥Âá∫ÈÄôÂÄãÔºå‰ª£Ë°® Rules Ê≤íÊîπÂ•Ω
                alert("ÈªûËÆöÂ§±ÊïóÔºöË´ãÊ™¢Êü• Firebase Rules ÊòØÂê¶ÂÖÅË®± updateÔºÅ");
            }
        }

        // === ÈóúÈçµ‰øÆÊ≠£ÔºöÁΩÆÈ†ÇÂäüËÉΩ ===
        async function togglePin(id, currentStatus) {
            if(!isAdmin) return;
            try {
                await db.collection("anonymous_messages").doc(id).update({
                    isPinned: !currentStatus
                });
            } catch(e) { 
                alert("ÁΩÆÈ†ÇÂ§±ÊïóÔºöË´ãÊ™¢Êü• Firebase Rules ÊòØÂê¶ÂÖÅË®± updateÔºÅ");
            }
        }

        async function deleteMsg(id) {
            if(!isAdmin) return;
            if(confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) {
                await db.collection("anonymous_messages").doc(id).delete();
            }
        }

        function setupAdminTrigger() {
            const title = document.getElementById('secretTitle');
            title.addEventListener('click', () => {
                clickCount++;
                if (clickCount === 5) {
                    const pwd = prompt("Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂØÜÁ¢ºÔºö");
                    if (pwd === "Admin88888") {
                        sessionStorage.setItem('isClassAdmin', 'true');
                        isAdmin = true;
                        alert("ÁÆ°ÁêÜÊ®°ÂºèÂ∑≤ÈñãÂïüÔºÅ");
                        location.reload(); 
                    }
                    clickCount = 0;
                }
                setTimeout(() => clickCount = 0, 3000);
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        init();
    </script>
</body>
</html>
