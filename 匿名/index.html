<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Whisper - 班級許願池</title>
    <style>
        :root {
            --ios-blue: #007AFF; --ios-gray: #8E8E93;
            --bg: #FFFFFF; --bubble-bg: #E9E9EB;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #000; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 100px; }

        /* 隱藏入口標題 */
        h1 { font-size: 34px; font-weight: 800; letter-spacing: -1px; margin-bottom: 30px; user-select: none; }

        /* 訊息氣泡流 */
        #messageList { display: flex; flex-direction: column; gap: 15px; }
        .msg-wrapper { display: flex; flex-direction: column; align-items: flex-start; animation: fadeInUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .bubble { 
            background: var(--bubble-bg); padding: 12px 16px; border-radius: 20px; 
            font-size: 16px; line-height: 1.4; max-width: 85%; position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .time-tag { font-size: 11px; color: var(--ios-gray); margin: 4px 0 0 8px; }

        /* 老師管理鈕 */
        .del-btn { color: #FF3B30; font-size: 12px; font-weight: 600; margin-left: 10px; cursor: pointer; text-decoration: underline; }

        /* 底部輸入列 */
        .input-bar {
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px env(safe-area-inset-bottom);
            border-top: 0.5px solid #D1D1D6; display: flex; gap: 10px; align-items: center;
        }
        .ios-input {
            flex: 1; border: 1px solid #D1D1D6; background: #F2F2F7;
            padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none;
        }
        .send-btn {
            background: var(--ios-blue); color: white; border: none;
            width: 32px; height: 32px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; font-size: 18px;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="secretTitle" onclick="triggerAdmin()">班級許願池</h1>
    
    <div id="messageList">
        </div>
</div>

<div class="input-bar">
    <input type="text" id="msgInput" class="ios-input" placeholder="匿名說點什麼...">
    <button class="send-btn" onclick="sendMessage()">↑</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    // 請使用與行事曆相同的 Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let isAdmin = false;
    let clickCount = 0;

    // 隱藏入口：連點標題 5 下
    function triggerAdmin() {
        clickCount++;
        if (clickCount === 5) {
            if(prompt("請輸入管理密碼") === "Admin88888") {
                isAdmin = true;
                alert("管理員模式：已開啟刪除功能");
                fetchMessages();
            }
            clickCount = 0;
        }
        setTimeout(() => clickCount = 0, 3000);
    }

    // 傳送留言
    async function sendMessage() {
        const text = document.getElementById('msgInput').value.trim();
        if (!text) return;

        await db.collection("anonymous_messages").add({
            content: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('msgInput').value = "";
        window.scrollTo(0, document.body.scrollHeight);
    }

    // 監聽並取得留言
    function fetchMessages() {
        db.collection("anonymous_messages").orderBy("timestamp", "asc")
          .onSnapshot(snap => {
            const list = document.getElementById('messageList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const data = doc.data();
                const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
                
                list.innerHTML += `
                    <div class="msg-wrapper">
                        <div class="bubble">
                            ${data.content}
                            ${isAdmin ? `<span class="del-btn" onclick="deleteMsg('${doc.id}')">刪除</span>` : ''}
                        </div>
                        <span class="time-tag">${time}</span>
                    </div>
                `;
            });
            // 自動滾動到底部
            window.scrollTo(0, document.body.scrollHeight);
        });
    }

    // 刪除留言
    async function deleteMsg(id) {
        if(confirm("確定要刪除這條留言嗎？")) {
            await db.collection("anonymous_messages").doc(id).delete();
        }
    }

    fetchMessages();
</script>
</body>
</html>
