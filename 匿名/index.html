<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­ç´šåŒ¿åè¨±é¡˜æ± </title>
    <style>
        :root {
            /* æ·ºè‰²æ¨¡å¼ (Light) */
            --bg-color: #F2F2F7;
            --nav-bg: rgba(255, 255, 255, 0.9);
            --bubble-bg: #FFFFFF;
            --bubble-text: #000000;
            --meta-text: #8E8E93;
            --input-bg: #FFFFFF;
            --border-color: #C6C6C8;
            --highlight: #007AFF;
            --pinned-bg: #FFF8E1;     /* ç½®é ‚èƒŒæ™¯-æ·º */
            --pinned-border: #FFD54F; /* ç½®é ‚é‚Šæ¡†-æ·º */
            --reaction-bg: #F2F2F7;
        }

        /* æ·±è‰²æ¨¡å¼ (Dark) */
        [data-theme="dark"] {
            --bg-color: #000000;
            --nav-bg: rgba(28, 28, 30, 0.9);
            --bubble-bg: #2C2C2E;
            --bubble-text: #FFFFFF;
            --meta-text: #98989D;
            --input-bg: #1C1C1E;
            --border-color: #38383A;
            --highlight: #0A84FF;
            --pinned-bg: #3E3008;     /* ç½®é ‚èƒŒæ™¯-æ·± */
            --pinned-border: #FFB300; /* ç½®é ‚é‚Šæ¡†-æ·± */
            --reaction-bg: #3A3A3C;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-color); color: var(--bubble-text);
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        /* å°è¦½åˆ— */
        .nav-bar {
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 45px 15px 15px; border-bottom: 0.5px solid var(--border-color);
            position: sticky; top: 0; z-index: 100; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-center { flex: 1; text-align: center; }
        .nav-bar h1 { margin: 0; font-size: 17px; font-weight: 600; cursor: pointer; user-select: none; }
        .nav-btn { color: var(--highlight); text-decoration: none; font-size: 16px; background: none; border: none; cursor: pointer; padding: 5px; }

        /* å®¹å™¨ */
        #messageContainer, #pinnedContainer {
            padding: 15px; display: flex; flex-direction: column; gap: 15px;
        }
        #messageContainer { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #pinnedContainer { padding-bottom: 0; display: none; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 5px;}

        /* è¨Šæ¯æ°£æ³¡ */
        .msg-wrapper {
            display: flex; flex-direction: column; align-items: flex-start; 
            max-width: 88%; animation: popIn 0.3s ease-out; position: relative;
        }
        
        .bubble {
            background: var(--bubble-bg); padding: 12px 16px;
            border-radius: 20px; border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            color: var(--bubble-text); font-size: 16px; line-height: 1.5;
            word-break: break-word; position: relative;
            transition: background 0.3s, color 0.3s;
        }

        /* ç½®é ‚æ¨£å¼ */
        .pinned-bubble {
            border: 2px solid var(--pinned-border);
            background: var(--pinned-bg);
            width: 100%; box-sizing: border-box; /* ç½®é ‚æ™‚æ»¿å¯¬ */
        }
        .pinned-badge {
            font-size: 11px; font-weight: 800; color: #FF9500;
            display: block; margin-bottom: 4px; letter-spacing: 0.5px;
        }

        /* åº•éƒ¨å¿ƒæƒ…å›æ‡‰å€ */
        .reaction-bar {
            display: flex; gap: 6px; margin-top: 6px; margin-left: 4px;
        }
        .react-btn {
            background: var(--reaction-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 2px 8px; font-size: 12px; color: var(--meta-text);
            cursor: pointer; display: flex; align-items: center; gap: 4px;
            transition: all 0.2s;
        }
        .react-btn:active { transform: scale(0.9); }
        .react-btn.active { border-color: var(--highlight); color: var(--highlight); background: rgba(0,122,255,0.1); }

        /* è³‡è¨Šåˆ— (æ™‚é–“/ç®¡ç†å“¡è³‡è¨Š) */
        .meta-row {
            margin-top: 4px; margin-left: 6px;
            display: flex; flex-direction: column; gap: 2px;
        }
        .time-tag { font-size: 11px; color: var(--meta-text); }
        
        /* ç®¡ç†å“¡å°ˆå±¬ */
        .admin-info {
            font-size: 10px; color: var(--meta-text); font-family: monospace;
            background: rgba(128,128,128,0.1); padding: 2px 4px; border-radius: 4px;
            display: none; width: fit-content; margin-top: 2px;
        }
        .admin-actions {
            display: none; gap: 8px; margin-top: 4px;
        }
        .adm-link { font-size: 11px; cursor: pointer; text-decoration: underline; }
        .adm-del { color: #FF3B30; }
        .adm-pin { color: #FF9500; }

        /* åº•éƒ¨è¼¸å…¥æ¡† */
        .input-area {
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 10px 15px calc(10px + env(safe-area-inset-bottom));
            border-top: 0.5px solid var(--border-color);
            display: flex; align-items: center; gap: 10px;
        }
        .ios-input {
            flex: 1; border: 1px solid var(--border-color); background: var(--input-bg);
            color: var(--bubble-text); padding: 9px 15px; border-radius: 20px; 
            font-size: 16px; outline: none; transition: background 0.3s;
        }
        .send-btn {
            background: var(--highlight); color: #FFF; border: none;
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 18px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .send-btn:disabled { opacity: 0.5; }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <a href="../index.html" class="nav-btn">ã„‘ è¿”å›</a>
        <div class="nav-center">
            <h1 id="secretTitle">ç­ç´šè¨±é¡˜æ± </h1>
        </div>
        <button class="nav-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ‘</button>
    </div>

    <div id="pinnedContainer"></div>

    <div id="messageContainer"></div>

    <div class="input-area">
        <input type="text" id="msgInput" class="ios-input" placeholder="åŒ¿åèªªé»ä»€éº¼..." autocomplete="off">
        <button id="sendBtn" class="send-btn" onclick="sendMessage()">â†‘</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

    <script>
        // === 1. Firebase è¨­å®š ===
        const firebaseConfig = {
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // === 2. ç‹€æ…‹è®Šæ•¸ ===
        let isAdmin = sessionStorage.getItem('isClassAdmin') === 'true';
        let clickCount = 0;
        let clientIP = "æœªçŸ¥ IP"; // é è¨­

        // === 3. åˆå§‹åŒ– ===
        function init() {
            // è®€å–ä¸»é¡Œè¨­å®š
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeBtn').innerText = 'â˜€ï¸';
            }

            // å–å¾—ä½¿ç”¨è€… IP (éå¼·åˆ¶ï¼Œåƒ…ä¾›åƒè€ƒ)
            fetch('https://api.ipify.org?format=json')
                .then(r => r.json())
                .then(d => clientIP = d.ip)
                .catch(e => console.log('IP fetch failed'));

            // ç›£è½ Enter éµ
            document.getElementById('msgInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // å•Ÿå‹•ç®¡ç†å“¡éš±è—å…¥å£
            setupAdminTrigger();
            
            // é–‹å§‹ç›£è½ç•™è¨€
            listenToMessages();
        }

        // === 4. åŠŸèƒ½é‚è¼¯ ===

        // åˆ‡æ›ä¸»é¡Œ
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeBtn').innerText = 'ğŸŒ‘';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeBtn').innerText = 'â˜€ï¸';
            }
        }

        // ç™¼é€è¨Šæ¯
        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const btn = document.getElementById('sendBtn');
            const text = input.value.trim();

            if (!text) return;

            btn.disabled = true;

            try {
                // å–å¾—ç°¡æ˜“è£ç½®è³‡è¨Š
                const device = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) 
                    ? (navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/i)[0]) 
                    : "PC/Desktop";

                await db.collection("anonymous_messages").add({
                    content: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isPinned: false,
                    ip: clientIP,        // å­˜ IP
                    device: device,      // å­˜è£ç½®
                    reactions: {         // é è¨­å¿ƒæƒ…æ¬„ä½
                        love: 0,
                        haha: 0,
                        sad: 0,
                        wow: 0
                    }
                });
                input.value = "";
            } catch (e) {
                alert("ç™¼é€å¤±æ•—ï¼è«‹ç¢ºèª Rules æ˜¯å¦å·²é–‹å•Ÿ write æ¬Šé™ã€‚");
                console.error(e);
            } finally {
                btn.disabled = false;
                input.focus();
            }
        }

        // ç›£è½ä¸¦æ¸²æŸ“ç•™è¨€
        function listenToMessages() {
            db.collection("anonymous_messages")
              .orderBy("timestamp", "asc")
              .onSnapshot(snap => {
                  const normalList = document.getElementById('messageContainer');
                  const pinnedList = document.getElementById('pinnedContainer');
                  
                  normalList.innerHTML = "";
                  pinnedList.innerHTML = "";
                  let hasPinned = false;

                  snap.forEach(doc => {
                      const data = doc.data();
                      const id = doc.id;
                      const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "å‚³é€ä¸­...";
                      
                      // è™•ç†å¿ƒæƒ…å›æ‡‰ (é¿å… undefined)
                      const r = data.reactions || { love: 0, haha: 0, sad: 0, wow: 0 };
                      
                      // å»ºç«‹ HTML
                      const html = `
                          <div class="msg-wrapper" style="${data.isPinned ? 'max-width: 100%;' : ''}">
                              <div class="bubble ${data.isPinned ? 'pinned-bubble' : ''}">
                                  ${data.isPinned ? '<span class="pinned-badge">ğŸ“Œ ç½®é ‚å…¬å‘Š</span>' : ''}
                                  ${escapeHtml(data.content)}
                              </div>
                              
                              <div class="reaction-bar">
                                  <div class="react-btn" onclick="react('${id}', 'love')">â¤ï¸ ${r.love || 0}</div>
                                  <div class="react-btn" onclick="react('${id}', 'haha')">ğŸ˜‚ ${r.haha || 0}</div>
                                  <div class="react-btn" onclick="react('${id}', 'wow')">ğŸ˜® ${r.wow || 0}</div>
                                  <div class="react-btn" onclick="react('${id}', 'sad')">ğŸ˜¢ ${r.sad || 0}</div>
                              </div>

                              <div class="meta-row">
                                  <span class="time-tag">${time}</span>
                                  
                                  ${isAdmin ? `
                                      <div class="admin-info">IP: ${data.ip || 'Hidden'} | ${data.device || 'Unknown'}</div>
                                      <div class="admin-actions" style="display:flex;">
                                          <span class="adm-link adm-pin" onclick="togglePin('${id}', ${data.isPinned})">${data.isPinned ? 'å–æ¶ˆç½®é ‚' : 'ç½®é ‚'}</span>
                                          <span class="adm-link adm-del" onclick="deleteMsg('${id}')">åˆªé™¤</span>
                                      </div>
                                  ` : ''}
                              </div>
                          </div>
                      `;

                      if (data.isPinned) {
                          pinnedList.innerHTML += html;
                          hasPinned = true;
                      } else {
                          normalList.innerHTML += html;
                      }
                  });

                  // æ§åˆ¶ç½®é ‚å€é¡¯ç¤º
                  pinnedList.style.display = hasPinned ? 'flex' : 'none';
                  
                  // åªæœ‰ä¸€èˆ¬ç•™è¨€å€éœ€è¦è‡ªå‹•æ²å‹•
                  normalList.scrollTop = normalList.scrollHeight;
              });
        }

        // === 5. äº’å‹•åŠŸèƒ½ ===

        // å¿ƒæƒ…é»è®š (ä½¿ç”¨ Transaction ç¢ºä¿è¨ˆæ•¸æ­£ç¢º)
        async function react(docId, type) {
            // ç°¡å–®é˜²åˆ·: å­˜åœ¨ localStorage (é‡æ•´æœƒé‡ç½®ï¼Œè‹¥è¦åš´æ ¼éœ€ç¶å®š user ID)
            const key = `reacted_${docId}_${type}`;
            if (localStorage.getItem(key)) return; // å·²ç¶“æŒ‰éè©²è¡¨æƒ…

            const docRef = db.collection("anonymous_messages").doc(docId);
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (!doc.exists) return;

                    const newReactions = doc.data().reactions || { love: 0, haha: 0, sad: 0, wow: 0 };
                    newReactions[type] = (newReactions[type] || 0) + 1;
                    
                    transaction.update(docRef, { reactions: newReactions });
                });
                localStorage.setItem(key, 'true'); // æ¨™è¨˜å·²æŒ‰
            } catch (e) {
                console.error("Reaction failed:", e);
            }
        }

        // ç®¡ç†å“¡ï¼šç½®é ‚åˆ‡æ›
        async function togglePin(id, currentStatus) {
            if(!isAdmin) return;
            try {
                await db.collection("anonymous_messages").doc(id).update({
                    isPinned: !currentStatus
                });
            } catch(e) { alert("æ›´æ–°å¤±æ•—"); }
        }

        // ç®¡ç†å“¡ï¼šåˆªé™¤
        async function deleteMsg(id) {
            if(!isAdmin) return;
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                await db.collection("anonymous_messages").doc(id).delete();
            }
        }

        // ç®¡ç†å“¡å…¥å£è¨­å®š (é»æ¨™é¡Œ5ä¸‹)
        function setupAdminTrigger() {
            const title = document.getElementById('secretTitle');
            title.addEventListener('click', () => {
                clickCount++;
                if (clickCount === 5) {
                    const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
                    if (pwd === "Admin88888") {
                        sessionStorage.setItem('isClassAdmin', 'true');
                        isAdmin = true;
                        alert("ç®¡ç†æ¨¡å¼å·²é–‹å•Ÿï¼\nç¾åœ¨æ‚¨å¯ä»¥çœ‹åˆ° IP èˆ‡æ“ä½œæŒ‰éˆ•ã€‚");
                        location.reload(); // é‡æ–°æ•´ç†ä»¥è¼‰å…¥ç®¡ç†ä»‹é¢
                    }
                    clickCount = 0;
                }
                setTimeout(() => clickCount = 0, 3000);
            });
        }

        // XSS é˜²è­·
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>
