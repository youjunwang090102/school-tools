<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ¿åä¿¡ç®± - ç­ç´šé€£ç¶²ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --t: #ef233c; --bg: #f8f9fa; --line: #06c755; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; }
        #loginSection { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        
        /* LINE ç¶å®šæé†’æ¢ */
        #lineBindingNotice { display:none; background:#fff3cd; padding:12px; text-align:center; font-size:0.85rem; border-bottom:1px solid #ffeeba; color: #856404; }
        .line-btn { background: var(--line); color: white; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 8px; }

        .nav { display: none; background: white; padding: 5px; justify-content: space-around; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .nav-btn { border: none; background: none; font-weight: bold; padding: 12px 5px; color: #888; cursor: pointer; font-size: 0.85rem; flex: 1; position: relative; }
        .nav-btn.active { color: var(--p); border-bottom: 3px solid var(--p); }
        .badge { position: absolute; top: 5px; right: 10px; background: var(--t); color: white; font-size: 10px; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        
        .container { padding: 20px; max-width: 500px; margin: auto; display: none; }
        .card { background: white; padding: 18px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 12px; border: 1px solid #eee; position: relative; }
        .card.unread { border-left: 5px solid var(--p); background: #f0f4ff; }
        
        .student-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-height: 180px; overflow-y: auto; background: #f0f0f0; padding: 10px; border-radius: 12px; margin: 10px 0; }
        .stu-chip { font-size: 0.75rem; background: white; padding: 6px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #ddd; }
        .stu-chip.selected { background: var(--p); color: white; border-color: var(--p); }
        
        textarea { width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 12px; padding: 12px; box-sizing: border-box; font-size: 16px; margin-top: 10px; resize: none; }
        button.main-btn { width: 100%; padding: 14px; background: var(--p); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .msg-info { font-size: 0.7rem; color: #aaa; margin-bottom: 5px; }
        .reply-area { margin-top: 10px; padding: 8px; background: #f0fffb; border-radius: 8px; color: #008f7a; font-size: 0.85rem; border-left: 3px solid var(--s); }
        .admin-tag { background: #fff0f0; color: var(--t); font-size: 0.7rem; padding: 4px 8px; border-radius: 5px; margin-bottom: 10px; display: inline-block; }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="login-card">
            <h2 style="color:var(--p)">åŒ¿åå¿ƒè²ç®±</h2>
            <input type="number" id="loginId" placeholder="åº§è™Ÿ (å¦‚ 05)">
            <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
            <button class="main-btn" onclick="doLogin()">ç™»å…¥</button>
        </div>
    </div>

    <div id="lineBindingNotice">
        ğŸ“¢ ç¶å®š LINEï¼Œå³æ™‚æ”¶åˆ°åŒ¿åä¿¡é€šçŸ¥ï¼
        <button class="line-btn" onclick="linkToLineBot()">ç«‹å³ç¶å®š</button>
    </div>

    <div id="navBar" class="nav">
        <button id="btn-send" class="nav-btn" onclick="showPage('send')">ç™¼é€</button>
        <button id="btn-sentBox" class="nav-btn" onclick="showPage('sentBox')">å·²ç™¼é€</button>
        <button id="btn-receive" class="nav-btn" onclick="showPage('receive')">
            æ”¶ä»¶åŒ£ <span id="unreadBadge" class="badge" style="display:none;">0</span>
        </button>
        <button id="btn-admin" class="nav-btn" style="display:none;" onclick="showPage('admin')">ç›£æ§</button>
        <button class="nav-btn" onclick="location.reload()" style="color:#ccc">ç™»å‡º</button>
    </div>

    <div id="sendPage" class="container">
        <h3>å‚³é€åŒ¿åå¿ƒè²</h3>
        <div id="stuGrid" class="student-grid"></div>
        <textarea id="msgBody" placeholder="æƒ³èªªçš„è©±..."></textarea>
        <button class="main-btn" onclick="sendToStudents()">ç¢ºèªç™¼é€</button>
    </div>

    <div id="sentBoxPage" class="container"><h3>æˆ‘å¯„å‡ºçš„ä¿¡ä»¶</h3><div id="sentList"></div></div>
    <div id="receivePage" class="container"><h3>æ”¶åˆ°çš„ä¿¡ä»¶</h3><div id="receiveList"></div></div>
    <div id="adminPage" class="container"><h3>ğŸ” å…¨ç­ä¿¡ä»¶ç´€éŒ„</h3><div id="adminList"></div></div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let me = null;
        let selectedIds = [];

        function escapeHTML(str) {
            return String(str||'').replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag));
        }

        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function doLogin() {
            const id = document.getElementById('loginId').value.padStart(2, '0');
            const pwInput = document.getElementById('loginPw').value;
            const hashedPw = await hashPassword(pwInput);

            const doc = await db.collection("students").doc(id).get();
            if (doc.exists && (doc.data().password === pwInput || doc.data().password === hashedPw)) {
                me = { id, ...doc.data() };
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('navBar').style.display = 'flex';
                if (me.role === 'teacher' || me.role === 'admin') document.getElementById('btn-admin').style.display = 'block';
                showPage('send');
                loadStudentList();
                startListenMessages();
                checkLineBinding();
            } else { alert("éŒ¯èª¤ï¼"); }
        }

        async function checkLineBinding() {
            const userDoc = await db.collection("users").doc(me.id).get();
            document.getElementById('lineBindingNotice').style.display = (userDoc.exists && userDoc.data().lineUserId) ? 'none' : 'block';
        }

        function linkToLineBot() {
            // âœ¨ æ›æˆä½ å‰›çµ¦æˆ‘çš„é€£çµ
            const lineBotUrl = "https://lin.ee/9fESlAY"; 
            alert("è«‹åœ¨åŠ å…¥å¥½å‹å¾Œï¼Œè¼¸å…¥ï¼š\n\nç¶å®š " + me.id);
            window.location.href = lineBotUrl;
        }

        async function loadStudentList() {
            const snap = await db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).get();
            const grid = document.getElementById('stuGrid');
            grid.innerHTML = "";
            snap.forEach(doc => {
                if(doc.id === me.id) return;
                const chip = document.createElement('div');
                chip.className = 'stu-chip';
                chip.innerText = `${doc.id} ${escapeHTML(doc.data().name)}`;
                chip.onclick = () => {
                    chip.classList.toggle('selected');
                    const sid = doc.id;
                    if(selectedIds.includes(sid)) selectedIds = selectedIds.filter(i => i !== sid);
                    else selectedIds.push(sid);
                };
                grid.appendChild(chip);
            });
        }

        async function sendToStudents() {
            const content = document.getElementById('msgBody').value;
            if (selectedIds.length === 0 || !content) return;
            const batch = db.batch();
            selectedIds.forEach(tId => {
                const ref = db.collection("secret_messages").doc();
                batch.set(ref, {
                    sender_id: me.id, receiver_id: tId, content: content, read: false, time: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            await batch.commit();
            alert("å·²é€å‡ºï¼");
            showPage('sentBox');
        }

        function showPage(p) {
            document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(p + 'Page').style.display = 'block';
            document.getElementById('btn-' + p).classList.add('active');
        }

        function startListenMessages() {
            db.collection("secret_messages").where("receiver_id", "==", me.id).onSnapshot(snap => {
                renderList(snap, 'receiveList', 'receive');
            });
        }

        function renderList(snap, elementId, type) {
            const box = document.getElementById(elementId);
            box.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="msg-info">åº§è™Ÿ: ${d.sender_id}</div><div>${escapeHTML(d.content)}</div>`;
                box.appendChild(card);
            });
        }
    </script>
</body>
</html>
