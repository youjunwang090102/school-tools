<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç­ç´šæ•¸ä½å¹³å° v4.1.0 (å¤šç­ç´šåˆ†æµç‰ˆ)</title>

    <meta name="theme-color" id="chrome-theme" content="#f8fafc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" id="safari-theme" content="default">

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>

    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            const layout = localStorage.getItem('layout') || 'list-mode';
            const lastPage = localStorage.getItem('lastPage') || '0';

            if (theme === 'dark') document.documentElement.classList.add('dark-mode');
            document.documentElement.setAttribute('data-layout', layout);
            document.documentElement.setAttribute('data-init-page', lastPage);
            
            const gateStyle = document.createElement('style');
            gateStyle.innerHTML = `
                body { opacity: 0; }
                [data-system-ready="true"] body { opacity: 1; transition: opacity 0.3s ease; }
            `;
            document.head.appendChild(gateStyle);
        })();

        const SYS_CONFIG = {
            banner: "ğŸ“¢ æ­¡è¿ä½¿ç”¨è·¨ç­ç´šæ•¸ä½å¹³å°ï¼Œè«‹ä½¿ç”¨ 6 ç¢¼å­¸è™Ÿç™»å…¥ã€‚",
            author: {
                name: "ç‹å®¥éˆ",
                role: "é–‹ç™¼è€… ï½œ Developer",
                ver: "v4.1.0 (Multi-Class)",
                updates: [
                    "âœ¨ [åŠŸèƒ½å‡ç´š] æ”¯æ´ 6 ç¢¼å­¸è™Ÿç™»å…¥èˆ‡è¨»å†Šã€‚",
                    "âœ¨ [æ¶æ§‹å„ªåŒ–] åŠ å…¥ç­ç´šåˆ†æµç³»çµ±ï¼Œæ”¯æ´å¤šç­ç´šç®¡ç†ã€‚",
                    "- è¨»å†Šä»‹é¢æ–°å¢ã€Œæ‰€å±¬ç­ç´šã€é¸å–®ã€‚",
                    "- å¼·åŒ– Auth èˆ‡ Firestore æ•¸æ“šåˆ†æµä¸€è‡´æ€§ã€‚"
                ]
            }
        };
    </script>

    <style>
        /* =============================================
           ğŸ¨ 1. è®Šæ•¸èˆ‡åŸºç¤æ ¸å¿ƒç³»çµ± (ä¿ç•™åŸå§‹ CSS)
           ============================================= */
        :root {
            --p: #4361ee; 
            --p-light: rgba(67, 97, 238, 0.1);
            --g: #7209b7; 
            --bg: #f8fafc; 
            --card: #ffffff;
            --text: #1e293b; 
            --sub: #64748b; 
            --border: rgba(0,0,0,0.08);
            --nav-bg: rgba(255, 255, 255, 0.85); 
            --banner-bg: #fff9db; 
            --banner-text: #856404;
            --accent: #4361ee;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --secondary: #10b981;
        }

        .dark-mode {
            --bg: #020617; 
            --card: #111827; 
            --text: #f8fafc;
            --sub: #94a3b8; 
            --border: rgba(255,255,255,0.1);
            --nav-bg: rgba(15, 23, 42, 0.85); 
            --banner-bg: #1e1b0a; 
            --banner-text: #ffe066;
            --accent: #fbbf24;
        }

        /* ğŸ’¡ é–€æ§ä»‹é¢å„ªåŒ– */
        #auth-portal {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            transition: transform 0.6s cubic-bezier(0.8, 0, 0.2, 1);
            overflow-y: auto;
        }
        #auth-portal.hide { transform: translateY(-100%); }

        .auth-card {
            background: var(--card); width: 100%; max-width: 420px;
            border-radius: 35px; padding: 35px 25px; border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        }
        .auth-card h2 { margin: 0; color: var(--p); font-size: 24px; font-weight: 900; }
        .auth-card p { color: var(--sub); margin: 6px 0 25px; font-size: 13px; font-weight: 500; }
        
        .auth-input-group { margin-bottom: 12px; text-align: left; }
        .auth-input-group label { display: block; font-size: 12px; font-weight: 800; margin-bottom: 5px; color: var(--sub); margin-left: 10px; }
        .auth-input, .auth-select {
            width: 100%; padding: 14px 18px; border-radius: 16px;
            border: 2px solid var(--border); background: var(--bg);
            color: var(--text); font-size: 15px; font-weight: 600; outline: none; transition: 0.3s;
            appearance: none;
        }
        .auth-input:focus, .auth-select:focus { border-color: var(--p); box-shadow: 0 0 0 4px var(--p-light); }
        
        .auth-btn {
            width: 100%; padding: 16px; background: var(--p); color: white;
            border: none; border-radius: 18px; font-weight: 900; font-size: 16px;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .auth-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3); }

        .auth-switch { margin-top: 20px; font-size: 13px; color: var(--sub); font-weight: 600; cursor: pointer; }
        .auth-switch b { color: var(--p); text-decoration: underline; }

        /* å…¶é¤˜åŸå§‹è¨­å®šä¿æŒä¸è®Š */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; width: 100vw; height: 100dvh; background-color: var(--bg); color: var(--text); font-family: system-ui, sans-serif; overflow: hidden; position: fixed; }
        header { height: 72px; padding: 0 20px; background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1000; }
        .brand h1 { margin: 0; font-size: 20px; font-weight: 900; color: var(--p); }
        .controls { display: flex; gap: 12px; align-items: center; }
        .icon-btn { border: none; background: transparent; cursor: pointer; width: 40px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--sub); transition: 0.3s; }
        .icon-btn.active { background: var(--p); color: #fff; }
        .viewport { width: 100%; height: calc(100dvh - 72px - 40px); display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .page-panel { flex: 0 0 100%; height: 100%; scroll-snap-align: start; overflow-y: auto; padding: 25px 20px 180px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; text-decoration: none; color: inherit; display: flex; padding: 22px; align-items: center; position: relative; transition: 0.2s; }
        .nav-dock { position: fixed; bottom: calc(25px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); width: 92%; max-width: 440px; z-index: 5000; }
        .nav-glass { background: var(--nav-bg); backdrop-filter: blur(25px); border-radius: 100px; display: flex; padding: 6px; border: 1px solid var(--border); box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .nav-item { flex: 1; text-align: center; padding: 14px 0; font-size: 14px; font-weight: 900; color: var(--sub); cursor: pointer; border-radius: 100px; }
        .nav-item.active { color: #fff; background: var(--p); }
        .top-notice { background: var(--banner-bg); color: var(--banner-text); padding: 9px 15px; font-size: 13px; text-align: center; font-weight: 700; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body data-layout="list-mode">

    <div id="auth-portal">
        <div class="auth-card" id="login-form">
            <h2>å¹³å°ç™»å…¥</h2>
            <p>è«‹è¼¸å…¥å­¸è™Ÿèˆ‡å¯†ç¢¼é€²å…¥æ‚¨çš„ç­ç´š</p>
            <div class="auth-input-group">
                <label>6 ç¢¼å­¸è™Ÿ</label>
                <input type="number" id="auth-id" class="auth-input" placeholder="å­¸è™Ÿ (ä¾‹: 112001)">
            </div>
            <div class="auth-input-group">
                <label>ç™»å…¥å¯†ç¢¼</label>
                <input type="password" id="auth-pw" class="auth-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="auth-btn" onclick="sysAuth.doLogin()">é€²å…¥æ•¸ä½å¹³å°</button>
            <div class="auth-switch" onclick="sysAuth.switchMode('reg')">æ–°åŒå­¸ï¼Ÿ<b>è¨»å†Šå¸³è™Ÿä¸¦é¸æ“‡ç­ç´š</b></div>
        </div>

        <div class="auth-card" id="reg-form" style="display:none;">
            <h2>åŠ å…¥ç­ç´š</h2>
            <p>å¡«å¯«å­¸è™Ÿèˆ‡ç­ç´šï¼Œå¾…å°å¸«å¯©æ ¸å¾Œç”Ÿæ•ˆ</p>
            <div class="auth-input-group">
                <label>6 ç¢¼å­¸è™Ÿ</label>
                <input type="number" id="reg-id" class="auth-input" placeholder="ä¾‹: 112001">
            </div>
            <div class="auth-input-group">
                <label>çœŸå¯¦å§“å</label>
                <input type="text" id="reg-name" class="auth-input" placeholder="ä¾‹: ç‹å¤§åŒ">
            </div>
            <div class="auth-input-group">
                <label>æ‰€å±¬ç­ç´š</label>
                <select id="reg-class" class="auth-select">
                    <option value="">è«‹é¸æ“‡æ‚¨çš„ç­ç´š...</option>
                    <option value="è³‡ä¸‰ç”²">è³‡ä¸‰ç”²</option>
                    <option value="è³‡ä¸‰ä¹™">è³‡ä¸‰ä¹™</option>
                    <option value="é›»ä¸‰ç”²">é›»ä¸‰ç”²</option>
                </select>
            </div>
            <div class="auth-input-group">
                <label>è¨­å®šå¯†ç¢¼</label>
                <input type="password" id="reg-pw" class="auth-input" placeholder="å»ºè­° 6 ä½æ•¸ä»¥ä¸Š">
            </div>
            <button class="auth-btn" style="background:var(--secondary)" onclick="sysAuth.doRegister()">é€å‡ºè¨»å†Šç”³è«‹</button>
            <div class="auth-switch" onclick="sysAuth.switchMode('login')">å·²æœ‰å¸³è™Ÿï¼Ÿ<b>è¿”å›ç™»å…¥ä»‹é¢</b></div>
        </div>
    </div>

    <div class="top-notice" id="ui-banner"></div>

    <header>
        <div class="brand">
            <h1>ç­ç´šæ•¸ä½å¹³å°</h1>
            <p id="auth-status-text">Digital Classroom System</p>
        </div>
        <div class="controls">
            <button class="icon-btn circle-tool" onclick="updateTheme()"><svg id="theme-icon" viewBox="0 0 24 24"></svg></button>
            <button class="icon-btn circle-tool" onclick="sysAuth.doLogout()" title="ç™»å‡ºç³»çµ±">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </button>
        </div>
    </header>

    <main class="viewport" id="scroll-engine">
        <section class="page-panel" id="panel-0"><div class="content-grid">
            <a href="è¡Œäº‹æ›†/index.html" class="card"><div class="card-icon">ğŸ“…</div><div class="card-info"><h2>ç­ç´šè¡Œäº‹æ›†</h2><p>æŒæ¡è€ƒç¨‹èˆ‡é‡è¦æ´»å‹•ä¸æ¼æ¥</p></div></a>
            <a href="homework/index.html" class="card"><div class="card-icon">ğŸ“’</div><div class="card-info"><h2>ä½œæ¥­å¾…è¾¦</h2><p>ç­ç´šå°ˆå±¬ä½œæ¥­å³æ™‚æŸ¥çœ‹</p></div></a>
        </div></section>
        </main>

    <nav class="nav-dock">
        <div class="nav-glass">
            <div class="nav-item" onclick="moveTo(0)">æé†’</div>
            <div class="nav-item" onclick="moveTo(1)">äº’å‹•</div>
            <div class="nav-item" onclick="moveTo(2)">ç­å‹™</div>
            <div class="nav-item" onclick="moveTo(3)">æˆç¸¾</div>
        </div>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let me = null;

        const sysAuth = {
            switchMode: (mode) => {
                document.getElementById('login-form').style.display = mode === 'login' ? 'block' : 'none';
                document.getElementById('reg-form').style.display = mode === 'reg' ? 'block' : 'none';
            },
            doLogin: async () => {
                const id = document.getElementById('auth-id').value;
                const pw = document.getElementById('auth-pw').value;
                if(id.length !== 6) return alert("è«‹è¼¸å…¥ 6 ç¢¼å­¸è™Ÿ");
                const email = `${id}@class.local`;
                try {
                    await auth.signInWithEmailAndPassword(email, pw);
                } catch (e) { alert("ç™»å…¥å¤±æ•—ï¼šå­¸è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
            },
            doRegister: async () => {
                const id = document.getElementById('reg-id').value;
                const name = document.getElementById('reg-name').value;
                const classId = document.getElementById('reg-class').value;
                const pw = document.getElementById('reg-pw').value;
                
                if(id.length !== 6) return alert("å­¸è™Ÿå¿…é ˆç‚º 6 ç¢¼");
                if(!name || !classId || !pw) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

                const email = `${id}@class.local`;
                try {
                    await auth.createUserWithEmailAndPassword(email, pw);
                    // ğŸ’¡ Firestore åŠ å…¥ classId å¯¦ç¾åˆ†æµ
                    await db.collection("students").doc(id).set({
                        name, classId, role: "student", score: 0, duty_zone: "æœªåˆ†é…", status: "pending"
                    });
                    alert(`è¨»å†ŠæˆåŠŸï¼æ‚¨å·²ç”³è«‹åŠ å…¥ã€Œ${classId}ã€ï¼Œè«‹ç­‰å¾…å¯©æ ¸ã€‚`);
                    await auth.signOut();
                    sysAuth.switchMode('login');
                } catch (e) { alert("è¨»å†Šå¤±æ•—ï¼š" + e.message); }
            },
            doLogout: async () => {
                if(confirm("ç¢ºå®šç™»å‡ºå¹³å°ï¼Ÿ")) {
                    localStorage.removeItem('classAppMe');
                    await auth.signOut();
                    location.reload();
                }
            }
        };

        auth.onAuthStateChanged(async (user) => {
            const portal = document.getElementById('auth-portal');
            if (user) {
                const id = user.email.split('@')[0];
                try {
                    const doc = await db.collection("students").doc(id).get();
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.status === 'pending') {
                            alert("å¸³è™Ÿå¯©æ ¸ä¸­ï¼Œè«‹ç¨å€™ã€‚");
                            await auth.signOut();
                            return;
                        }
                        me = { id, ...data };
                        localStorage.setItem('classAppMe', JSON.stringify(me));
                        document.getElementById('auth-status-text').innerText = `${me.classId} ï½œ ${me.name}`;
                        portal.classList.add('hide');
                    }
                } catch (e) { console.error(e); }
            } else {
                portal.classList.remove('hide');
            }
        });

        /* --- åŸºç¤ UI æ§åˆ¶é‚è¼¯ --- */
        const Hub = {
            dom: { scroller: document.getElementById('scroll-engine'), tabs: document.querySelectorAll('.nav-item'), themeIcon: document.getElementById('theme-icon') },
            state: { currentIdx: parseInt(localStorage.getItem('lastPage')) || 0, isDark: document.documentElement.classList.contains('dark-mode') }
        };
        function moveTo(idx) {
            const width = Hub.dom.scroller.offsetWidth;
            Hub.dom.scroller.scrollTo({ left: idx * width, behavior: 'smooth' });
            Hub.state.currentIdx = idx;
            localStorage.setItem('lastPage', idx);
            updateNavUI();
        }
        function updateNavUI() { Hub.dom.tabs.forEach((tab, i) => tab.classList.toggle('active', i === Hub.state.currentIdx)); }
        function updateTheme() {
            Hub.state.isDark = !Hub.state.isDark;
            document.documentElement.classList.toggle('dark-mode', Hub.state.isDark);
            localStorage.setItem('theme', Hub.state.isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').innerHTML = Hub.state.isDark ? 'â˜€ï¸' : 'ğŸŒ‘';
        }
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ui-banner').innerText = SYS_CONFIG.banner;
            document.getElementById('theme-icon').innerHTML = Hub.state.isDark ? 'â˜€ï¸' : 'ğŸŒ‘';
            setTimeout(() => {
                moveTo(Hub.state.currentIdx);
                document.documentElement.setAttribute('data-system-ready', 'true');
            }, 50);
        });
    </script>
</body>
</html>
