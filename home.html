<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç­ç´šæ•¸ä½å¹³å° v4.4.0 (æ——è‰¦æ——è‰¦ç‰ˆ)</title>

    <meta name="theme-color" id="chrome-theme" content="#f8fafc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" id="safari-theme" content="default">

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>

    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            const layout = localStorage.getItem('layout') || 'list-mode';
            const lastPage = localStorage.getItem('lastPage') || '0';
            if (theme === 'dark') document.documentElement.classList.add('dark-mode');
            document.documentElement.setAttribute('data-layout', layout);
            document.documentElement.setAttribute('data-init-page', lastPage);
            
            // é˜²æ­¢è¼‰å…¥é–ƒçˆ
            const gateStyle = document.createElement('style');
            gateStyle.innerHTML = `body { opacity: 0; } [data-system-ready="true"] body { opacity: 1; transition: opacity 0.4s ease; }`;
            document.head.appendChild(gateStyle);
        })();

        const SYS_CONFIG = {
            banner: "ğŸ“ æ•™è‚²é©—è­‰ç³»çµ±å·²ä¸Šç·šã€‚è‹¥å›ä¸Šé å‡ºç¾è¼‰å…¥ç•«é¢ç‚ºæ­£å¸¸æ ¡é©—ç¨‹åºã€‚",
            author: {
                name: "ç‹å®¥éˆ", role: "é–‹ç™¼è€… ï½œ Developer", ver: "v4.4.0 (Pro)",
                updates: [
                    "- è§£æ±º Firebase Auth è¼‰å…¥æ™‚çš„ UI é–ƒç¾å•é¡Œã€‚",
                    "- é‡æ–°è¦–è¦ºåŒ–ç²¾ç¾è¨»å†Šè¡¨å–®ï¼Œæå‡äº’å‹•æ„Ÿã€‚",
                    "- ä¿®æ­£ç®¡ç†å“¡ç‰¹æ®Šç™»å…¥ (admin) é‚è¼¯æ¼æ´ã€‚",
                    "- ç¶­æŒå®Œæ•´ 3D æ‡¸æµ®èˆ‡å¡ç‰‡è‡ªè¨‚æ’åºè¨˜æ†¶ã€‚"
                ]
            }
        };
    </script>

    <style>
        /* =============================================
           ğŸ¨ 1. æ ¸å¿ƒè¦–è¦ºç³»çµ± (å®Œå…¨é‚„åŸ)
           ============================================= */
        :root {
            --p: #4361ee; --p-light: rgba(67, 97, 238, 0.1); --g: #7209b7; 
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --sub: #64748b; 
            --border: rgba(0,0,0,0.08); --nav-bg: rgba(255, 255, 255, 0.85); 
            --banner-bg: #fff9db; --banner-text: #856404; --accent: #4361ee;
            --secondary: #10b981; --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        .dark-mode {
            --bg: #020617; --card: #111827; --text: #f8fafc; --sub: #94a3b8; 
            --border: rgba(255,255,255,0.1); --nav-bg: rgba(15, 23, 42, 0.85); 
            --banner-bg: #1e1b0a; --banner-text: #ffe066; --accent: #fbbf24;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; width: 100vw; height: 100dvh; background-color: var(--bg); color: var(--text); font-family: 'SF Pro TC', 'PingFang TC', system-ui; overflow: hidden; position: fixed; }

        /* =============================================
           ğŸ›¡ï¸ 2. å‡ç´šç‰ˆé–€æ§ä»‹é¢ (Auth Portal)
           ============================================= */
        #auth-portal {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px;
            transition: all 0.6s cubic-bezier(0.65, 0, 0.35, 1);
        }
        #auth-portal.hide { transform: translateY(-100%); opacity: 0; pointer-events: none; }
        
        /* è¼‰å…¥ä¸­å‹•ç•« */
        #auth-loading { position: absolute; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--p-light); border-top: 4px solid var(--p); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .auth-card {
            background: var(--card); width: 100%; max-width: 440px;
            border-radius: 40px; padding: 40px 30px; border: 1px solid var(--border);
            box-shadow: 0 40px 80px rgba(0,0,0,0.15); text-align: center;
            display: none; animation: modalIn 0.5s ease-out;
        }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .auth-card h2 { margin: 0; color: var(--p); font-size: 26px; font-weight: 900; letter-spacing: -0.5px; }
        .auth-card p { color: var(--sub); margin: 8px 0 25px; font-size: 14px; font-weight: 600; }
        
        .auth-input-group { margin-bottom: 15px; text-align: left; }
        .auth-input-group label { display: block; font-size: 12px; font-weight: 800; margin-bottom: 6px; color: var(--sub); margin-left: 10px; }
        .auth-input, .auth-select {
            width: 100%; padding: 15px 20px; border-radius: 18px; border: 2.5px solid var(--border);
            background: var(--bg); color: var(--text); font-size: 16px; font-weight: 600; outline: none; transition: 0.3s;
        }
        .auth-input:focus { border-color: var(--p); background: var(--card); }

        .captcha-box { display: flex; gap: 10px; margin-top: 5px; height: 50px; }
        .captcha-display { 
            flex: 1; background: linear-gradient(135deg, #e2e8f0, #cbd5e1); border-radius: 14px; 
            font-family: 'Courier New', monospace; font-size: 22px; font-weight: 900; 
            display: flex; align-items: center; justify-content: center; letter-spacing: 6px; 
            color: var(--p); user-select: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .auth-btn { width: 100%; padding: 18px; background: var(--p); color: white; border: none; border-radius: 20px; font-weight: 900; font-size: 16px; cursor: pointer; transition: 0.3s; margin-top: 15px; box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2); }
        .auth-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(67, 97, 238, 0.3); }

        /* =============================================
           ğŸ“± 3. æ——è‰¦ç‰ˆä»‹é¢é‚„åŸ (100% åŸå§‹ä½ˆå±€)
           ============================================= */
        header { height: 72px; padding: 0 20px; background: var(--nav-bg); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1000; }
        .brand h1 { margin: 0; font-size: 20px; font-weight: 900; color: var(--p); letter-spacing: -1px; }
        .brand p { margin: 0; font-size: 10px; color: var(--sub); font-weight: 800; letter-spacing: 1px; }

        .icon-btn { border: none; background: transparent; cursor: pointer; width: 40px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--sub); transition: 0.3s; }
        .icon-btn.active { background: var(--p); color: #fff; box-shadow: 0 4px 12px rgba(67, 97, 238, 0.4); }
        .circle-tool { width: 42px; height: 42px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .viewport { width: 100%; height: calc(100dvh - 72px - 40px); display: flex; overflow-x: auto; overflow-y: hidden; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .page-panel { flex: 0 0 100%; height: 100%; scroll-snap-align: start; overflow-y: auto; padding: 25px 20px 180px; box-sizing: border-box; }
        .content-grid { display: grid; gap: 18px; width: 100%; max-width: 1100px; margin: 0 auto; }

        .card {
            background: var(--card); border: 1px solid var(--border); border-radius: 26px; text-decoration: none; color: inherit;
            display: flex; position: relative; overflow: hidden; transform-style: preserve-3d;
            transform: perspective(1000px) rotateX(var(--rx, 0deg)) rotateY(var(--ry, 0deg)) scale3d(var(--scale, 1), var(--scale, 1), 1);
            transition: transform 0.15s ease-out, background 0.3s ease, box-shadow 0.3s ease; will-change: transform; cursor: grab;
        }
        .card::after { content: ""; position: absolute; inset: 0; background: radial-gradient(350px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(67, 97, 238, 0.08), transparent 40%); opacity: 0; transition: opacity 0.4s; }
        [data-layout="list-mode"] .card { padding: 22px; align-items: center; }
        [data-layout="grid-mode"] .card { flex-direction: column; padding: 20px 10px; text-align: center; aspect-ratio: 1 / 1.1; justify-content: center; }
        
        .card-icon { display: flex; align-items: center; justify-content: center; background: var(--p-light); color: var(--p); width: 56px; height: 56px; border-radius: 16px; margin-right: 20px; font-size: 24px; }
        [data-layout="grid-mode"] .card-icon { width: 48px; height: 48px; border-radius: 50%; margin: 0 auto 12px; }

        .card-info h2 { margin: 0; font-size: 16px; font-weight: 800; }
        .card-info p { margin: 4px 0 0; font-size: 12px; color: var(--sub); font-weight: 600; }

        .nav-dock { position: fixed; bottom: calc(25px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); width: 92%; max-width: 440px; z-index: 5000; }
        .nav-glass { background: var(--nav-bg); backdrop-filter: blur(25px); display: flex; padding: 6px; border-radius: 100px; border: 1px solid var(--border); box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .nav-item { flex: 1; text-align: center; padding: 14px 0; font-size: 14px; font-weight: 900; color: var(--sub); cursor: pointer; border-radius: 100px; transition: 0.3s; }
        .nav-item.active { color: #ffffff; background: var(--p); box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 25px; }
        .overlay.active { display: flex; }
    </style>
</head>
<body data-layout="list-mode">

    <div id="auth-portal">
        <div id="auth-loading"><div class="spinner"></div><p style="color:var(--sub); font-weight:bold;">é©—è­‰èº«åˆ†ä¸­...</p></div>

        <div class="auth-card" id="login-form">
            <h2>ç™»å…¥å¹³å°</h2>
            <p>è«‹è¼¸å…¥å­¸è™Ÿèˆ‡å¯†ç¢¼é€²å…¥æ‚¨çš„ç­ç´š</p>
            <div class="auth-input-group"><label>å­¸è™Ÿ / å¸³è™Ÿ</label><input type="text" id="auth-id" class="auth-input" placeholder="å­¸è™Ÿæˆ– admin"></div>
            <div class="auth-input-group"><label>ç™»å…¥å¯†ç¢¼</label><input type="password" id="auth-pw" class="auth-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
            <button class="auth-btn" onclick="sysAuth.doLogin()">ç¢ºèªç™»å…¥</button>
            <p onclick="sysAuth.switchMode('reg')" style="cursor:pointer; color:var(--p); font-weight:800; margin-top:20px; font-size:14px;">æ–°åŒå­¸ï¼Ÿç”³è«‹åŠ å…¥ç­ç´š</p>
        </div>

        <div class="auth-card" id="reg-form">
            <h2>åŠ å…¥ç”³è«‹</h2>
            <p>è«‹å¡«å¯«çœŸå¯¦è³‡æ–™ä»¥ä¾¿å°å¸«æ ¸å°</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div class="auth-input-group"><label>å­¸è™Ÿ (6ç¢¼)</label><input type="number" id="reg-id" class="auth-input" placeholder="112001"></div>
                <div class="auth-input-group"><label>åº§è™Ÿ</label><input type="number" id="reg-seat" class="auth-input" placeholder="05"></div>
            </div>
            <div class="auth-input-group"><label>çœŸå¯¦å§“å</label><input type="text" id="reg-name" class="auth-input" placeholder="ç‹å°æ˜"></div>
            <div class="auth-input-group">
                <label>æ‰€å±¬ç­ç´š</label>
                <select id="reg-class" class="auth-select"><option value="203">203 ç­</option><option value="204">204 ç­</option></select>
            </div>
            <div class="auth-input-group"><label>æ•™è‚²ä¿¡ç®± (@gm.tntcsh.tn.edu.tw)</label><input type="email" id="reg-email" class="auth-input" placeholder="å­¸è™Ÿ@gm.tntcsh.tn.edu.tw"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div class="auth-input-group"><label>è¨­å®šå¯†ç¢¼</label><input type="password" id="reg-pw1" class="auth-input"></div>
                <div class="auth-input-group"><label>å†æ¬¡ç¢ºèª</label><input type="password" id="reg-pw2" class="auth-input"></div>
            </div>
            <div class="auth-input-group">
                <label>è«‹è¼¸å…¥åœ–ä¸­é©—è­‰ç¢¼</label>
                <div class="captcha-box"><div id="captcha-display" class="captcha-display">LOADING</div><input type="text" id="reg-captcha" class="auth-input" style="width:110px" placeholder="4ç¢¼"></div>
            </div>
            <button class="auth-btn" style="background:var(--secondary); box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);" onclick="sysAuth.doRegister()">é€å‡ºå¯©æ ¸ç”³è«‹</button>
            <p onclick="sysAuth.switchMode('login')" style="cursor:pointer; color:var(--p); font-weight:800; margin-top:20px; font-size:14px;">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div class="top-notice" id="ui-banner"></div>
    <header>
        <div class="brand"><h1>ç­ç´šæ•¸ä½å¹³å°</h1><p id="auth-status-text">Classroom Hub</p></div>
        <div class="controls">
            <div class="toggle-group">
                <button class="icon-btn" id="listToggle" onclick="updateLayout('list-mode')"><svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><path d="M3 6h.01M3 12h.01M3 18h.01"/></svg></button>
                <button class="icon-btn" id="gridToggle" onclick="updateLayout('grid-mode')"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></button>
            </div>
            <button class="icon-btn circle-tool" onclick="updateTheme()"><svg id="theme-icon" viewBox="0 0 24 24"></svg></button>
            <button class="icon-btn circle-tool" onclick="sysAuth.doLogout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
        </div>
    </header>

    <main class="viewport" id="scroll-engine">
        <section class="page-panel" id="panel-0"><div class="content-grid" id="grid-0">
            <a href="è¡Œäº‹æ›†/index.html" class="card" draggable="true"><div class="card-icon">ğŸ“…</div><div class="card-info"><h2>ç­ç´šè¡Œäº‹æ›†</h2><p>æŒæ¡è€ƒç¨‹èˆ‡é‡è¦æ´»å‹•ä¸æ¼æ¥</p></div></a>
            <a href="countdown/index.html" class="card" draggable="true"><div class="card-icon">â³</div><div class="card-info"><h2>è€ƒç¨‹å€’æ•¸</h2><p>å€’æ•¸æ®µè€ƒèˆ‡çµ±æ¸¬</p></div></a>
            <a href="homework/index.html" class="card" draggable="true"><div class="card-icon">ğŸ“’</div><div class="card-info"><h2>ä½œæ¥­å¾…è¾¦</h2><p>å³æ™‚æŸ¥çœ‹ä½œæ¥­ä¸éºæ¼</p></div></a>
        </div></section>

        <section class="page-panel" id="panel-1"><div class="content-grid" id="grid-1">
            <a href="help/student.html" class="card" draggable="true"><div class="card-icon">ğŸŒ±</div><div class="card-info"><h2>åŒ¿åæ±‚åŠ©</h2><p>å®‰å…¨ä¸”ç§å¯†çš„æ±‚åŠ©ç®¡é“</p></div></a>
            <a href="unknownmail/index.html" class="card" draggable="true"><div class="card-icon">âœ‰ï¸</div><div class="card-info"><h2>åŒ¿åä¿¡ç®±</h2><p>æº«é¦¨æé†’åŒå­¸çš„å°å·¥å…·</p></div></a>
            <a href="åŒ¿å/index.html" class="card" draggable="true"><div class="card-icon">âœ¨</div><div class="card-info"><h2>åŒ¿åè¨±é¡˜æ± </h2><p>åˆ†äº«ä½ çš„ç¾å¥½é»å­</p></div></a>
            <a href="board/index.html" class="card" draggable="true"><div class="card-icon">ğŸ’¬</div><div class="card-info"><h2>å¯¦åç•™è¨€æ¿</h2><p>èˆ‡ç­ä¸ŠåŒå­¸äº’å‹•äº¤æµ</p></div></a>
        </div></section>

        <section class="page-panel" id="panel-2"><div class="content-grid" id="grid-2">
            <a href="cleaning/index.html" class="card" draggable="true"><div class="card-icon">ğŸ§¹</div><div class="card-info"><h2>æ‰“æƒå‹¤å‹™</h2><p>æŸ¥çœ‹æƒå€èˆ‡ç¼ºå¤±é»æ•¸</p></div></a>
            <a href="seating/index.html" class="card" draggable="true"><div class="card-icon">ğŸª‘</div><div class="card-info"><h2>é¸ä½ç³»çµ±</h2><p>åˆºæ¿€ä¸”å…¬å¹³çš„åº§ä½æ’å®š</p></div></a>
            <a href="vote/index.html" class="card" draggable="true"><div class="card-icon">ğŸ—³ï¸</div><div class="card-info"><h2>æ•¸ä½æŠ•ç¥¨</h2><p>æ±ºå®šç­ç´šçš„å¤§å°äº‹å‹™</p></div></a>
        </div></section>

        <section class="page-panel" id="panel-3"><div class="content-grid" id="grid-3">
            <a href="exam_calc/index.html" class="card" draggable="true"><div class="card-icon">ğŸ“</div><div class="card-info"><h2>æ®µè€ƒåŠ æ¬Š</h2><p>å¹³å‡åˆ†èˆ‡ç¸½åˆ†è¨ˆç®—</p></div></a>
            <a href="final_calc/index.html" class="card" draggable="true"><div class="card-icon">ğŸ“ˆ</div><div class="card-info"><h2>å­¸æœŸç¸½åˆ†</h2><p>å­¸åˆ†å–å¾—èˆ‡é è­¦åˆ¤æ–·</p></div></a>
        </div></section>
    </main>

    <nav class="nav-dock">
        <div class="nav-glass">
            <div class="nav-item active" onclick="moveTo(0)">æé†’</div>
            <div class="nav-item" onclick="moveTo(1)">äº’å‹•</div>
            <div class="nav-item" onclick="moveTo(2)">ç­å‹™</div>
            <div class="nav-item" onclick="moveTo(3)">æˆç¸¾</div>
        </div>
    </nav>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0", authDomain: "vote-6668.firebaseapp.com", projectId: "vote-6668", storageBucket: "vote-6668.firebasestorage.app", messagingSenderId: "389284021944", appId: "1:389284021944:web:3c5311697cbfc7c010564d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        let me = null, currentCaptcha = "";

        const sysAuth = {
            generateCaptcha: () => {
                const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
                let code = ""; for(let i=0; i<4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
                currentCaptcha = code;
                document.getElementById('captcha-display').innerText = code;
            },
            switchMode: (mode) => {
                document.getElementById('auth-loading').style.display = 'none';
                document.getElementById('login-form').style.display = mode === 'login' ? 'block' : 'none';
                document.getElementById('reg-form').style.display = mode === 'reg' ? 'block' : 'none';
                if(mode === 'reg') sysAuth.generateCaptcha();
            },
            doLogin: async () => {
                const id = document.getElementById('auth-id').value.trim();
                const pw = document.getElementById('auth-pw').value;
                if(!id || !pw) return alert("è«‹è¼¸å…¥å¸³å¯†");
                const email = (id.toLowerCase() === "admin") ? "admin@class.local" : `${id}@class.local`;
                try {
                    await auth.signInWithEmailAndPassword(email, pw);
                } catch (e) { alert("ç™»å…¥å¤±æ•—ï¼šèº«åˆ†é©—è­‰ä¸é€šéã€‚"); }
            },
            doRegister: async () => {
                const id = document.getElementById('reg-id').value.trim();
                const seat = document.getElementById('reg-seat').value.trim();
                const name = document.getElementById('reg-name').value.trim();
                const cls = document.getElementById('reg-class').value;
                const email = document.getElementById('reg-email').value.trim();
                const p1 = document.getElementById('reg-pw1').value;
                const p2 = document.getElementById('reg-pw2').value;
                const captcha = document.getElementById('reg-captcha').value.toUpperCase();

                if(id.length !== 6) return alert("å­¸è™Ÿé ˆç‚º 6 ç¢¼");
                if(!email.endsWith("@gm.tntcsh.tn.edu.tw")) return alert("ä¿¡ç®±å¾Œç¶´éŒ¯èª¤");
                if(!email.startsWith(id)) return alert("ä¿¡ç®±èˆ‡å­¸è™Ÿä¸ç¬¦");
                if(p1 !== p2 || p1.length < 6) return alert("å¯†ç¢¼ä¸ä¸€è‡´æˆ–å¤ªçŸ­");
                if(captcha !== currentCaptcha) { sysAuth.generateCaptcha(); return alert("é©—è­‰ç¢¼éŒ¯èª¤"); }

                try {
                    const userEmail = `${id}@class.local`;
                    await auth.createUserWithEmailAndPassword(userEmail, p1);
                    await db.collection("students").doc(id).set({
                        name, classId: cls, seat, eduMail: email, role: "student", status: "pending"
                    });
                    alert("è¨»å†ŠæˆåŠŸï¼è«‹å¾…å°å¸«å¯©æ ¸å•Ÿç”¨ã€‚");
                    await auth.signOut();
                    sysAuth.switchMode('login');
                } catch (e) { alert("è¨»å†Šå¤±æ•—ï¼š" + e.message); }
            },
            doLogout: async () => { if(confirm("ç¢ºå®šç™»å‡ºå¹³å°ï¼Ÿ")) { await auth.signOut(); location.reload(); } }
        };

        // ğŸ›¡ï¸ æ ¸å¿ƒï¼šè§£æ±ºé–ƒç¾èˆ‡ç‹€æ…‹ç›£è½
        auth.onAuthStateChanged(async (user) => {
            const portal = document.getElementById('auth-portal');
            if(user) {
                const id = user.email.split('@')[0];
                try {
                    const doc = await db.collection("students").doc(id).get();
                    if(doc.exists && doc.data().status === 'active') {
                        me = { id, ...doc.data() };
                        document.getElementById('auth-status-text').innerText = `${me.classId} ${me.seat} ï½œ ${me.name}`;
                        portal.classList.add('hide');
                    } else {
                        if(doc.exists && doc.data().status === 'pending') alert("å¸³è™Ÿå¯©æ ¸ä¸­");
                        await auth.signOut();
                        sysAuth.switchMode('login');
                    }
                } catch(e) { await auth.signOut(); sysAuth.switchMode('login'); }
            } else {
                portal.classList.remove('hide');
                sysAuth.switchMode('login');
            }
        });

        // ğŸ•¹ï¸ æ——è‰¦ç‰ˆæ§åˆ¶å™¨ (100% é‚„åŸç‰¹æ•ˆ)
        const Hub = {
            dom: { scroller: document.getElementById('scroll-engine'), tabs: document.querySelectorAll('.nav-item'), themeIcon: document.getElementById('theme-icon') },
            state: { currentIdx: parseInt(localStorage.getItem('lastPage')) || 0, isDark: document.documentElement.classList.contains('dark-mode'), layout: localStorage.getItem('layout') || 'list-mode' }
        };
        function sysHaptic(p = 15) { if(navigator.vibrate) navigator.vibrate(p); }
        function moveTo(idx, behavior = 'smooth') {
            sysHaptic(10);
            const width = Hub.dom.scroller.offsetWidth;
            Hub.dom.scroller.scrollTo({ left: idx * width, behavior });
            Hub.state.currentIdx = idx;
            localStorage.setItem('lastPage', idx);
            Hub.dom.tabs.forEach((tab, i) => tab.classList.toggle('active', i === idx));
        }
        function updateLayout(mode) {
            document.documentElement.setAttribute('data-layout', mode);
            Hub.state.layout = mode; localStorage.setItem('layout', mode);
            document.getElementById('listToggle').classList.toggle('active', mode === 'list-mode');
            document.getElementById('gridToggle').classList.toggle('active', mode === 'grid-mode');
            setTimeout(() => moveTo(Hub.state.currentIdx, 'auto'), 50);
        }
        function updateTheme() {
            sysHaptic(20); Hub.state.isDark = !Hub.state.isDark;
            document.documentElement.classList.toggle('dark-mode', Hub.state.isDark);
            localStorage.setItem('theme', Hub.state.isDark ? 'dark' : 'light');
            Hub.dom.themeIcon.innerHTML = Hub.state.isDark ? 'â˜€ï¸' : 'ğŸŒ‘';
        }
        function initCardFX() {
            const savedOrder = JSON.parse(localStorage.getItem('sysCardOrder')) || {};
            document.querySelectorAll('.content-grid').forEach((grid, idx) => {
                const order = savedOrder[`grid-${idx}`];
                if(order) order.forEach(h => {
                    const card = [...grid.querySelectorAll('.card')].find(c => c.getAttribute('href') === h);
                    if(card) grid.appendChild(card);
                });
            });
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('mousemove', e => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left, y = e.clientY - rect.top;
                    card.style.setProperty('--mouse-x', `${x}px`); card.style.setProperty('--mouse-y', `${y}px`);
                    const rx = (y - rect.height/2) / (rect.height/2) * -8;
                    const ry = (x - rect.width/2) / (rect.width/2) * 8;
                    card.style.setProperty('--rx', `${rx}deg`); card.style.setProperty('--ry', `${ry}deg`);
                    card.style.setProperty('--scale', `1.03`);
                });
                card.addEventListener('mouseleave', () => {
                    card.style.setProperty('--rx', `0deg`); card.style.setProperty('--ry', `0deg`); card.style.setProperty('--scale', `1`);
                });
                card.addEventListener('dragstart', function(e) { this.classList.add('dragging'); e.dataTransfer.setData('text/plain', this.getAttribute('href')); });
                card.addEventListener('dragend', function() { 
                    this.classList.remove('dragging'); 
                    const orderMap = {};
                    document.querySelectorAll('.content-grid').forEach((grid, i) => { orderMap[`grid-${i}`] = [...grid.querySelectorAll('.card')].map(c => c.getAttribute('href')); });
                    localStorage.setItem('sysCardOrder', JSON.stringify(orderMap));
                });
                card.addEventListener('dragover', e => e.preventDefault());
                card.addEventListener('dragenter', function() {
                    const dragging = document.querySelector('.dragging');
                    if(dragging && dragging !== this) {
                        const grid = this.parentNode;
                        if([...grid.children].indexOf(dragging) < [...grid.children].indexOf(this)) grid.insertBefore(dragging, this.nextSibling);
                        else grid.insertBefore(dragging, this);
                    }
                });
            });
        }
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ui-banner').innerText = SYS_CONFIG.banner;
            Hub.dom.themeIcon.innerHTML = Hub.state.isDark ? 'â˜€ï¸' : 'ğŸŒ‘';
            initCardFX(); updateLayout(Hub.state.layout);
            setTimeout(() => { moveTo(Hub.state.currentIdx, 'auto'); document.documentElement.setAttribute('data-system-ready', 'true'); }, 50);
            Hub.dom.scroller.addEventListener('scroll', () => {
                const newIdx = Math.round(Hub.dom.scroller.scrollLeft / Hub.dom.scroller.offsetWidth);
                if(newIdx !== Hub.state.currentIdx) { Hub.state.currentIdx = newIdx; Hub.dom.tabs.forEach((tab, i) => tab.classList.toggle('active', i === newIdx)); }
            }, { passive: true });
        });
    </script>
</body>
</html>
