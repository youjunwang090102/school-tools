<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ¿åå¿ƒè²ç®± - ç­ç´šå¹³å°</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --t: #ef233c; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .nav { display: flex; background: white; padding: 10px; justify-content: space-around; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-btn { border: none; background: none; font-weight: bold; padding: 10px; color: #666; cursor: pointer; }
        .nav-btn.active { color: var(--p); border-bottom: 2px solid var(--p); }
        
        .container { padding: 20px; max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; position: relative; }
        
        /* ç™¼ä¿¡é é¢æ¨£å¼ */
        textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; box-sizing: border-box; font-size: 16px; margin-top: 10px; }
        .student-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 10px; margin: 10px 0; }
        .stu-item { font-size: 0.8rem; background: #eee; padding: 5px; border-radius: 5px; text-align: center; cursor: pointer; }
        .stu-item.selected { background: var(--p); color: white; }
        
        /* ä¿¡ä»¶åˆ—è¡¨æ¨£å¼ */
        .msg-header { font-size: 0.8rem; color: #888; margin-bottom: 8px; }
        .msg-content { font-size: 1rem; line-height: 1.5; color: #333; }
        .reply-box { margin-top: 10px; border-top: 1px dashed #eee; padding-top: 10px; font-size: 0.9rem; color: var(--s); }
        .admin-info { font-size: 0.7rem; color: var(--t); background: #fff5f5; padding: 4px; border-radius: 4px; margin-bottom: 5px; }
        
        button.main-btn { width: 100%; padding: 12px; background: var(--p); color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="authCheck" class="container"><h3>è«‹ç¨å¾Œ...</h3></div>

    <div id="mainApp" class="hidden">
        <div class="nav">
            <button class="nav-btn active" onclick="tab('send')">ç™¼é€å¿ƒè²</button>
            <button class="nav-btn" onclick="tab('receive')">æ”¶ä»¶åŒ£</button>
            <button id="adminTab" class="nav-btn hidden" onclick="tab('admin')">ç®¡ç†ç›£æ§</button>
        </div>

        <div id="sendPage" class="container">
            <h3>å‘Šè¨´åŒå­¸ä½ çš„æƒ³æ³•</h3>
            <p style="font-size: 0.8rem; color: #888;">æ”¶ä»¶äºº (å¯è¤‡é¸)ï¼š</p>
            <div id="stuSelector" class="student-selector"></div>
            <textarea id="msgInput" placeholder="å¯«ä¸‹ä½ æƒ³èªªçš„è©±..."></textarea>
            <button class="main-btn" onclick="sendMsg()">åŒ¿åå‚³é€</button>
        </div>

        <div id="receivePage" class="container hidden">
            <h3>æˆ‘çš„æ”¶ä»¶åŒ£</h3>
            <div id="receiveList"></div>
        </div>

        <div id="adminPage" class="container hidden">
            <h3>ğŸ” å…¨ç­ä¿¡ä»¶ç›£æ§ (å°å¸«æ¬Šé™)</h3>
            <div id="adminList"></div>
        </div>
    </div>

    <script>
        // Firebase é…ç½® (è«‹æ›´æ›ç‚ºæ‚¨çš„)
        const firebaseConfig = { 
            apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
            authDomain: "vote-6668.firebaseapp.com",
            projectId: "vote-6668",
            storageBucket: "vote-6668.firebasestorage.app",
            messagingSenderId: "389284021944",
            appId: "1:389284021944:web:3c5311697cbfc7c010564d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = JSON.parse(sessionStorage.getItem('user'));
        let selectedStu = [];

        // åˆå§‹åŒ–æª¢æŸ¥
        window.onload = async () => {
            if (!currentUser) {
                alert("è«‹å…ˆå¾ä¸»é é¢ç™»å…¥ï¼");
                window.location.href = "index.html";
                return;
            }
            document.getElementById('authCheck').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            if (currentUser.role === 'teacher' || currentUser.role === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            }
            loadStudents();
            loadMessages();
        };

        // é ç±¤åˆ‡æ›
        function tab(type) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(type + 'Page').classList.remove('hidden');
            event.target.classList.add('active');
        }

        // è¼‰å…¥å­¸ç”Ÿåå–® (å¤šé¸ç”¨)
        async function loadStudents() {
            const snap = await db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).get();
            const box = document.getElementById('stuSelector');
            snap.forEach(doc => {
                if(doc.id === currentUser.id) return; // ä¸é¸è‡ªå·±
                const div = document.createElement('div');
                div.className = 'stu-item';
                div.innerText = `${doc.id} ${doc.data().name}`;
                div.onclick = () => {
                    div.classList.toggle('selected');
                    const id = doc.id;
                    if(selectedStu.includes(id)) selectedStu = selectedStu.filter(i => i !== id);
                    else selectedStu.push(id);
                };
                box.appendChild(div);
            });
        }

        // ç™¼é€ä¿¡ä»¶
        async function sendMsg() {
            const text = document.getElementById('msgInput').value;
            if (selectedStu.length === 0 || !text) return alert("è«‹é¸æ“‡æ”¶ä»¶äººä¸¦å¡«å¯«å…§å®¹");
            
            if(confirm(`ç¢ºå®šè¦åŒ¿åç™¼é€çµ¦é€™ ${selectedStu.length} ä½åŒå­¸å—ï¼Ÿ`)) {
                const batch = db.batch();
                selectedStu.forEach(targetId => {
                    const newRef = db.collection("secret_messages").doc();
                    batch.set(newRef, {
                        sender_id: currentUser.id,
                        sender_name: currentUser.name,
                        receiver_id: targetId,
                        content: text,
                        reply: "",
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                await batch.commit();
                alert("ç™¼é€æˆåŠŸï¼");
                location.reload();
            }
        }

        // è¼‰å…¥ä¿¡ä»¶
        function loadMessages() {
            // æ”¶ä»¶åŒ£ (æˆ‘æ”¶åˆ°çš„)
            db.collection("secret_messages")
                .where("receiver_id", "==", currentUser.id)
                .orderBy("timestamp", "desc")
                .onSnapshot(snap => {
                    const box = document.getElementById('receiveList');
                    box.innerHTML = snap.empty ? "ç›®å‰æ²’æœ‰ä¿¡ä»¶" : "";
                    snap.forEach(doc => renderMsg(doc, box, false));
                });

            // ç®¡ç†å“¡ç›£æ§
            if (currentUser.role === 'teacher' || currentUser.role === 'admin') {
                db.collection("secret_messages")
                    .orderBy("timestamp", "desc")
                    .onSnapshot(snap => {
                        const box = document.getElementById('adminList');
                        box.innerHTML = "";
                        snap.forEach(doc => renderMsg(doc, box, true));
                    });
            }
        }

        function renderMsg(doc, container, isAdmin) {
            const d = doc.data();
            const date = d.timestamp ? d.timestamp.toDate().toLocaleString() : "";
            const div = document.createElement('div');
            div.className = 'card';
            
            let adminHeader = isAdmin ? `<div class="admin-info">ä¾†è‡ªï¼š${d.sender_id} ${d.sender_name} â” å°è±¡ï¼š${d.receiver_id}</div>` : "";
            
            div.innerHTML = `
                ${adminHeader}
                <div class="msg-header">ğŸ“… ${date}</div>
                <div class="msg-content">${d.content}</div>
                <div id="reply-${doc.id}" class="reply-box ${d.reply?'':'hidden'}">
                    <b>å›è¦†ï¼š</b> ${d.reply}
                </div>
                ${!isAdmin && !d.reply ? `<button onclick="openReply('${doc.id}')" style="font-size:0.7rem; margin-top:5px;">å›è¦†æ­¤ä¿¡ä»¶</button>` : ""}
                ${isAdmin ? `<button onclick="openReply('${doc.id}')" style="font-size:0.7rem; margin-top:5px; color:red;">è€å¸«ä»£ç‚ºå›è¦†/æŒ‡å°</button>` : ""}
            `;
            container.appendChild(div);
        }

        async function openReply(docId) {
            const replyText = prompt("è«‹è¼¸å…¥å›è¦†å…§å®¹ï¼š");
            if (replyText) {
                await db.collection("secret_messages").doc(docId).update({ reply: replyText });
                alert("å›è¦†å·²å‚³é€");
            }
        }
    </script>
</body>
</html>
