<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒè²æ±‚åŠ©ç®±</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #7C98B3; --emergency: #FF3B30; --bg: #F8F9FA; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        /* å¯¦å/åŒ¿å åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .type-selector { display: flex; background: #E5E5EA; padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .type-btn { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; background: none; color: #8E8E93; }
        .type-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .form-group { margin-bottom: 15px; display: none; } /* é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶ */
        .form-group.show { display: block; }

        label { display: block; margin-bottom: 5px; font-weight: bold; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #E5E5EA; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        textarea { height: 150px; resize: none; }
        
        .checkbox-group { border: 1.5px solid #E5E5EA; padding: 10px; border-radius: 10px; }
        .checkbox-item { display: flex; align-items: center; margin: 5px 0; }
        
        button#sendBtn { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        .success { display: none; text-align: center; padding: 40px 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="inputUI">
        <h2 style="text-align:center; color:var(--primary);">ğŸŒ± è€å¸«çš„å¿ƒè²ç®±</h2>
        
        <div class="type-selector">
            <button class="type-btn active" onclick="setType('anonymous')">åŒ¿åæ±‚åŠ©</button>
            <button class="type-btn" id="realNameBtn" onclick="setType('realname')">å¯¦åæ±‚åŠ©</button>
        </div>

        <div id="realNameFields" class="form-group">
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>åº§è™Ÿ</label>
                    <input type="number" id="stuId" placeholder="ä¾‹ï¼š01">
                </div>
                <div style="flex: 2;">
                    <label>å§“å</label>
                    <input type="text" id="stuName" placeholder="è«‹è¼¸å…¥å§“å">
                </div>
            </div>
        </div>

        <div class="form-group show">
            <label>ç·Šæ€¥ç¨‹åº¦</label>
            <select id="level">
                <option value="ä¸€èˆ¬">ä¸€èˆ¬å¿ƒè²</option>
                <option value="ç¨æ€¥">ç¨æ€¥ï¼Œéœ€æ‰¾æ™‚é–“èŠèŠ</option>
                <option value="éå¸¸ç·Šæ€¥">éå¸¸ç·Šæ€¥ï¼</option>
            </select>
        </div>

        <div class="form-group show">
            <label>ä½ æƒ³èªªçš„è©±</label>
            <textarea id="helpMsg" placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ çš„å›°é›£..."></textarea>
        </div>

        <div class="form-group show">
            <label>å¸Œæœ›å›è¦†æ–¹å¼</label>
            <div class="checkbox-group" id="contactGroup">
                <div class="checkbox-item"><input type="checkbox" value="é¢è«‡"> ç§ä¸‹é¢è«‡</div>
                <div class="checkbox-item"><input type="checkbox" value="ç´™æ¢"> å¯«ç´™æ¢å›è¦†</div>
                <div class="checkbox-item"><input type="checkbox" value="ä¸éœ€å›è¦†"> è€å¸«çŸ¥é“å°±å¥½</div>
            </div>
        </div>

        <button id="sendBtn" onclick="sendHelp()">äº¤çµ¦è€å¸«</button>
    </div>

    <div id="successUI" class="success">
        <div style="font-size: 60px;">âœ‰ï¸</div>
        <h3>ä¿¡ä»¶å·²å¯„å‡º</h3>
        <p>è€å¸«å·²ç¶“æ”¶åˆ°è¨Šæ¯äº†ï¼Œè¾›è‹¦ä½ äº†ã€‚</p>
        <button style="background:#8E8E93" onclick="location.reload()">è¿”å›</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    let currentMode = 'anonymous'; // é è¨­åŒ¿å

    // åˆå§‹åŒ– Firebase (è«‹æ›æˆæ‚¨çš„ Config)
    firebase.initializeApp({ /* YOUR CONFIG */ });
    const db = firebase.firestore();
    emailjs.init("YOUR_PUBLIC_KEY");

    // åˆ‡æ›æ¨¡å¼çš„é‚è¼¯
    function setType(mode) {
        currentMode = mode;
        const btns = document.querySelectorAll('.type-btn');
        btns.forEach(b => b.classList.remove('active'));
        if(mode === 'realname') {
            document.getElementById('realNameFields').classList.add('show');
            btns[1].classList.add('active');
        } else {
            document.getElementById('realNameFields').classList.remove('show');
            btns[0].classList.add('active');
        }
    }

    async function sendHelp() {
        const msg = document.getElementById('helpMsg').value.trim();
        const level = document.getElementById('level').value;
        const sid = document.getElementById('stuId').value;
        const sname = document.getElementById('stuName').value;
        const contacts = Array.from(document.querySelectorAll('#contactGroup input:checked')).map(e => e.value);

        if (!msg || contacts.length === 0) { alert("å…§å®¹èˆ‡å›è¦†æ–¹å¼ä¸èƒ½ç©ºç™½å–”ï¼"); return; }
        if (currentMode === 'realname' && (!sid || !sname)) { alert("è«‹å¡«å¯«åº§è™Ÿèˆ‡å§“å"); return; }

        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.innerText = "å‚³é€ä¸­...";

        // ç³»çµ±è³‡è¨Š
        let ip = "unknown";
        try { const r = await fetch('https://api.ipify.org?format=json'); ip = (await r.json()).ip; } catch(e){}
        const device = navigator.userAgent.match(/\(([^)]+)\)/) ? navigator.userAgent.match(/\(([^)]+)\)/)[1] : "æœªçŸ¥è£ç½®";
        const time = new Date().toLocaleString('zh-TW');

        const identity = currentMode === 'realname' ? `å¯¦å(${sid} ${sname})` : "åŒ¿å";

        try {
            // å­˜å…¥ Firebase
            await db.collection("help_box").add({
                mode: currentMode,
                stuId: currentMode === 'realname' ? sid : null,
                stuName: currentMode === 'realname' ? sname : null,
                content: msg,
                level: level,
                contact: contacts.join(", "),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                ip: ip,
                device: device
            });

            // ç™¼é€ Email
            await emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
                mail_title: `ã€${identity} / ${level}ã€‘`,
                student_info: identity,
                content: msg,
                contact_method: contacts.join(", "),
                time: time,
                ip: ip,
                device: device
            });

            document.getElementById('inputUI').style.display = 'none';
            document.getElementById('successUI').style.display = 'block';
        } catch (e) {
            alert("å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
