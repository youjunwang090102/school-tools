<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒè²æ±‚åŠ©ç®±</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #7C98B3; --bg: #F2F2F7; --white: #FFFFFF; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: var(--white); padding: 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
        h2 { color: var(--primary); text-align: center; margin-top: 0; }
        .intro { font-size: 14px; color: #666; text-align: center; margin-bottom: 25px; }

        /* æ¨¡å¼åˆ‡æ›å™¨ */
        .type-selector { display: flex; background: #E5E5EA; padding: 4px; border-radius: 12px; margin-bottom: 25px; }
        .type-btn { flex: 1; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 15px; background: none; color: #8E8E93; transition: 0.3s; }
        .type-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* è¡¨å–®æ¬„ä½ */
        .form-group { margin-bottom: 20px; display: none; }
        .form-group.show { display: block; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #444; }
        input, select, textarea { width: 100%; padding: 14px; border: 1.5px solid #E5E5EA; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus, textarea:focus { border-color: var(--primary); }
        textarea { height: 160px; resize: none; }

        /* è¯çµ¡æ–¹å¼æ’ç‰ˆä¿®å¾© */
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; background: #FAFAFA; border: 1.5px solid #E5E5EA; padding: 14px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .checkbox-item:hover { background: #F0F4F8; border-color: var(--primary); }
        .checkbox-item input { width: 20px; height: 20px; margin-right: 12px; flex-shrink: 0; }
        .checkbox-item span { font-size: 16px; color: #333; }

        /* é€å‡ºæŒ‰éˆ• */
        #sendBtn { width: 100%; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        #sendBtn:disabled { background: #C7C7CC; cursor: not-allowed; }

        .success-ui { display: none; text-align: center; padding: 40px 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="inputUI">
        <h2>ğŸŒ± è€å¸«çš„å¿ƒè²ç®±</h2>
        <p class="intro">åªæœ‰è€å¸«æœƒçœ‹åˆ°é€™å°ä¿¡ã€‚è«‹é¸æ“‡ä½ æ„Ÿåˆ°å®‰å¿ƒçš„æ–¹å¼ã€‚</p>
        
        <div class="type-selector">
            <button class="type-btn active" id="btn-anon" onclick="setType('anonymous')">ğŸ¤« åŒ¿åæ±‚åŠ©</button>
            <button class="type-btn" id="btn-real" onclick="setType('realname')">âœï¸ å¯¦åæ±‚åŠ©</button>
        </div>

        <div id="realNameFields" class="form-group">
            <div style="display: flex; gap: 12px;">
                <div style="flex: 1;"><label>åº§è™Ÿ</label><input type="number" id="stuId" placeholder="ä¾‹ï¼š05"></div>
                <div style="flex: 2;"><label>å§“å</label><input type="text" id="stuName" placeholder="è¼¸å…¥å§“å"></div>
            </div>
        </div>

        <div class="form-group show">
            <label>é€™ä»¶äº‹æœ‰å¤šç·Šæ€¥ï¼Ÿ</label>
            <select id="level">
                <option value="ğŸŸ¢ ä¸€èˆ¬">ğŸŸ¢ ä¸€èˆ¬å¿ƒè²</option>
                <option value="ğŸŸ¡ ç¨æ€¥">ğŸŸ¡ ç¨æ€¥ï¼Œéœ€æ‰¾æ™‚é–“èŠèŠ</option>
                <option value="ğŸ”´ éå¸¸ç·Šæ€¥">ğŸ”´ éå¸¸ç·Šæ€¥ï¼</option>
            </select>
        </div>

        <div class="form-group show">
            <label>ä½ æƒ³èªªçš„è©±</label>
            <textarea id="helpMsg" placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ çš„å¿ƒæƒ…æˆ–å›°é›£..."></textarea>
        </div>

        <div class="form-group show">
            <label>ä½ å¸Œæœ›è€å¸«æ€éº¼å›è¦†ï¼Ÿ</label>
            <div class="checkbox-group" id="contactGroup">
                <label class="checkbox-item"><input type="checkbox" value="ç§ä¸‹é¢è«‡"><span>ğŸ¤ ç§ä¸‹é¢è«‡</span></label>
                <label class="checkbox-item"><input type="checkbox" value="å¯«ç´™æ¢å›è¦†"><span>ğŸ“ å¯«ç´™æ¢å›è¦†</span></label>
                <label class="checkbox-item"><input type="checkbox" value="ä¸éœ€å›è¦†"><span>ğŸ¤« è€å¸«çŸ¥é“å°±å¥½</span></label>
            </div>
        </div>

        <button id="sendBtn" onclick="sendHelp()">æäº¤çµ¦è€å¸«</button>
    </div>

    <div id="successUI" class="success-ui">
        <div style="font-size:64px">âœ‰ï¸</div>
        <h3>è¨Šæ¯å·²é€å‡º</h3>
        <p>è€å¸«å·²ç¶“æ”¶åˆ°ä¿¡ä»¶äº†ã€‚<br>çµ¦è¾›è‹¦çš„è‡ªå·±ä¸€å€‹æ·±å‘¼å¸ï¼Œæˆ‘å€‘ä¸€èµ·é¢å°ã€‚</p>
        <button style="background: #8E8E93; width: 120px; color:white; border:none; padding:12px; border-radius:12px; cursor:pointer;" onclick="location.reload()">è¿”å›</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    // 1. åˆå§‹åŒ– EmailJS (è«‹æ›´æ›æ‚¨çš„ Public Key)
    emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");

    // 2. Firebase é…ç½® (å·²å¥—ç”¨æ‚¨çš„å°ˆæ¡ˆ vote-6668)
    const firebaseConfig = {
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentMode = 'anonymous';

    // åˆ‡æ›å¯¦åèˆ‡åŒ¿å
    function setType(mode) {
        currentMode = mode;
        document.getElementById('btn-anon').classList.toggle('active', mode === 'anonymous');
        document.getElementById('btn-real').classList.toggle('active', mode === 'realname');
        document.getElementById('realNameFields').classList.toggle('show', mode === 'realname');
    }

    async function sendHelp() {
        const msg = document.getElementById('helpMsg').value.trim();
        const level = document.getElementById('level').value;
        const sid = document.getElementById('stuId').value;
        const sname = document.getElementById('stuName').value;
        const contacts = Array.from(document.querySelectorAll('#contactGroup input:checked')).map(e => e.value);

        if (!msg) { alert("è«‹å¡«å¯«æƒ³èªªçš„è©±"); return; }
        if (contacts.length === 0) { alert("è«‹é¸æ“‡ä¸€ç¨®å›è¦†æ–¹å¼"); return; }
        if (currentMode === 'realname' && (!sid || !sname)) { alert("è«‹å¡«å¯«åº§è™Ÿèˆ‡å§“å"); return; }

        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.innerText = "å¯„é€ä¸­...";

        try {
            // æŠ“å–ç’°å¢ƒè³‡è¨Š
            const ipRes = await fetch('https://api.ipify.org?format=json').catch(() => ({ json: () => ({ ip: "æœªçŸ¥" }) }));
            const ipData = await ipRes.json();
            const device = navigator.userAgent.match(/\(([^)]+)\)/) ? navigator.userAgent.match(/\(([^)]+)\)/)[1] : "æœªçŸ¥è£ç½®";
            const time = new Date().toLocaleString('zh-TW');
            const identity = currentMode === 'realname' ? `å¯¦å(${sid}è™Ÿ ${sname})` : "åŒ¿åç”¨æˆ¶";

            // A. å­˜å…¥ Firebase (Collection ç‚º help_box)
            await db.collection("help_box").add({
                identity, 
                level, 
                content: msg, 
                contact_method: contacts.join(", "),
                time, 
                ip: ipData.ip, 
                device, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // B. ç™¼é€ Email (è«‹æ›´æ›ç‚ºæ‚¨çš„ Service ID èˆ‡ Template ID)
            await emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
                mail_title: `ã€${identity} / ${level}ã€‘`,
                student_info: identity,
                level: level,
                content: msg,
                contact_method: contacts.join(", "),
                time: time,
                ip: ipData.ip,
                device: device
            });

            document.getElementById('inputUI').style.display = 'none';
            document.getElementById('successUI').style.display = 'block';
            window.scrollTo(0, 0);

        } catch (e) {
            console.error(e);
            alert("æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯ç¹«è€å¸«");
            btn.disabled = false;
            btn.innerText = "æäº¤çµ¦è€å¸«";
        }
    }
</script>
</body>
</html>
