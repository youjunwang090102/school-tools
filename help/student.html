<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒè²æ±‚åŠ©ç®±</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --primary-soft: #7C98B3; /* æŸ”å’Œè—ç°è‰² */
            --emergency-red: #FF3B30;
            --bg-color: #F8F9FA;
        }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg-color); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        h2 { color: var(--primary-soft); text-align: center; margin-bottom: 10px; }
        .intro { font-size: 14px; color: #666; line-height: 1.6; margin-bottom: 20px; text-align: center; }

        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #444; }
        
        textarea { width: 100%; height: 180px; padding: 15px; border: 1.5px solid #E5E5EA; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
        textarea:focus { border-color: var(--primary-soft); }

        select, .checkbox-group { width: 100%; padding: 12px; border: 1.5px solid #E5E5EA; border-radius: 12px; font-size: 16px; background: white; }
        
        .checkbox-item { display: flex; align-items: center; margin: 8px 0; font-size: 15px; }
        .checkbox-item input { margin-right: 10px; width: 18px; height: 18px; }

        button { width: 100%; background: var(--primary-soft); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 25px; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #D1D1D6; }

        .success { display: none; text-align: center; padding: 40px 0; }
    </style>
</head>
<body>

<div class="container" id="mainBox">
    <div id="inputUI">
        <h2>ğŸŒ± è€å¸«çš„å¿ƒè²ç®±</h2>
        <p class="intro">é€™è£¡åªæœ‰è€å¸«çœ‹å¾—åˆ°ã€‚ä¸ç®¡ç™¼ç”Ÿä»€éº¼äº‹ï¼Œå¯«ä¸‹ä¾†ï¼Œæˆ‘å€‘ä¸€èµ·é¢å°ã€‚é€™å°ä¿¡æœƒç›´æ¥å¯„åˆ°è€å¸«çš„é›»å­ä¿¡ç®±ã€‚</p>
        
        <label>ç·Šæ€¥ç¨‹åº¦</label>
        <select id="level">
            <option value="ä¸€èˆ¬å¿ƒè²">ä¸€èˆ¬å¿ƒè² (æœ‰ç©ºå†çœ‹å³å¯)</option>
            <option value="ç¨æ€¥ï¼Œéœ€æ‰¾æ™‚é–“èŠèŠ">ç¨æ€¥ï¼Œéœ€æ‰¾æ™‚é–“èŠèŠ</option>
            <option value="éå¸¸ç·Šæ€¥ï¼">éå¸¸ç·Šæ€¥ï¼(è«‹è€å¸«å„˜é€Ÿæ‰¾æˆ‘)</option>
        </select>

        <label>ä½ æƒ³èªªçš„è©±</label>
        <textarea id="helpMsg" placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ çš„å›°é›£æˆ–å¿ƒæƒ…..."></textarea>

        <label>å¸Œæœ›è€å¸«æ€éº¼è¯çµ¡æˆ‘ï¼Ÿ (å¯å¤šé¸)</label>
        <div class="checkbox-group">
            <div class="checkbox-item"><input type="checkbox" name="contact" value="ç§ä¸‹é¢è«‡"> ç§ä¸‹é¢è«‡</div>
            <div class="checkbox-item"><input type="checkbox" name="contact" value="å¯«ç´™æ¢å›è¦†"> å¯«ç´™æ¢å›è¦†</div>
            <div class="checkbox-item"><input type="checkbox" name="contact" value="è€å¸«çŸ¥é“å°±å¥½ï¼Œä¸éœ€å›è¦†"> è€å¸«çŸ¥é“å°±å¥½ï¼Œä¸éœ€å›è¦†</div>
        </div>

        <button id="sendBtn" onclick="sendHelp()">äº¤çµ¦è€å¸«</button>
    </div>

    <div id="successUI" class="success">
        <div style="font-size: 60px;">âœ‰ï¸</div>
        <h3>ä¿¡ä»¶å·²å¯„å‡º</h3>
        <p style="color:#666">è€å¸«å·²ç¶“æ”¶åˆ°ä½ çš„è¨Šæ¯äº†ã€‚<br>çµ¦è‡ªå·±ä¸€å€‹æ·±å‘¼å¸ï¼Œè¾›è‹¦äº†ã€‚</p>
        <button style="background:#8E8E93" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    // åˆå§‹åŒ– EmailJS èˆ‡ Firebase (æ­¤è™•ç¶­æŒåŸè¨­å®š)
    emailjs.init("YOUR_PUBLIC_KEY");
    firebase.initializeApp({ /* YOUR CONFIG */ });
    const db = firebase.firestore();

    async function sendHelp() {
        const msg = document.getElementById('helpMsg').value.trim();
        const level = document.getElementById('level').value;
        const btn = document.getElementById('sendBtn');
        
        // å–å¾—å‹¾é¸çš„è¯çµ¡æ–¹å¼
        const contacts = Array.from(document.querySelectorAll('input[name="contact"]:checked')).map(el => el.value);
        
        if (!msg) { alert("è«‹å¯«ä¸‹ä¸€é»å…§å®¹å–”ï¼"); return; }
        if (contacts.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®è€å¸«å›è¦†çš„æ–¹å¼ã€‚"); return; }

        btn.disabled = true;
        btn.innerText = "å¯„é€ä¸­...";

        // å–å¾—è£ç½®èˆ‡ IP è³‡è¨Š
        let ip = "unknown";
        try { const res = await fetch('https://api.ipify.org?format=json'); ip = (await res.json()).ip; } catch(e) {}
        const device = navigator.userAgent.match(/\(([^)]+)\)/)[1]; // ç°¡æ˜“æŠ“å–è£ç½®æè¿°
        const time = new Date().toLocaleString('zh-TW');

        try {
            // A. å­˜å…¥ Firebase
            await db.collection("help_box").add({
                content: msg,
                level: level,
                contact_method: contacts.join(", "),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                ip: ip,
                device: device
            });

            // B. ç™¼é€ Email (EmailJS çš„è®Šæ•¸åç¨±è¦å°æ‡‰)
            await emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
                level: level,
                content: msg,
                contact_method: contacts.join(", "),
                time: time,
                ip: ip,
                device: device
            });

            document.getElementById('inputUI').style.display = 'none';
            document.getElementById('successUI').style.display = 'block';

        } catch (error) {
            alert("ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
