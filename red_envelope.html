<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬å¹´ 3D ç™¼å¤§è²¡ - 168,000 (çµ‚æ¥µç‰ˆ)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a0505; font-family: 'Microsoft JhengHei', sans-serif; }
        
        /* === UI ä»‹é¢ === */
        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 20px; box-sizing: border-box; z-index: 10;
        }
        #title { color: #ffd700; font-size: 28px; text-shadow: 0 0 10px #ff0000; margin-top: 20px; font-weight: bold; }
        #counter-box {
            background: rgba(0, 0, 0, 0.7); padding: 15px 50px; border-radius: 50px;
            border: 2px solid #ffd700; margin-bottom: 50px; text-align: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        #money-label { color: #ccc; font-size: 14px; letter-spacing: 2px; }
        #total-amount { color: #00ff00; font-size: 56px; font-weight: bold; font-family: 'Courier New', monospace; }
        
        #instruction {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; background: rgba(0,0,0,0.6); padding: 12px 24px; border-radius: 30px;
            pointer-events: none; transition: opacity 0.5s; z-index: 5; font-size: 18px; border: 1px solid #fff;
        }

        /* === è¨­å®šå·¥å…·åˆ— (æ‰“åŒ…å¾Œæœƒè¢«ç§»é™¤) === */
        #toolbox {
            position: absolute; top: 20px; left: 20px; width: 280px;
            background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 10px;
            pointer-events: auto; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-size: 14px; color: #333;
        }
        #toolbox h3 { margin: 0 0 10px 0; color: #b30000; border-bottom: 2px solid #ffd700; padding-bottom: 5px; }
        .btn {
            display: block; width: 100%; padding: 10px; margin-top: 10px;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn-upload { background: #eee; color: #333; border: 1px solid #ccc; }
        .btn-upload:hover { background: #ddd; }
        .btn-save { background: #b30000; color: #ffd700; }
        .btn-save:hover { background: #d00000; transform: scale(1.02); }
        #file-input { display: none; }
        #status-msg { margin-top: 8px; font-size: 12px; color: green; min-height: 1.2em; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="toolbox">
        <h3>ğŸ› ï¸ è¨­å®šé¢æ¿</h3>
        <div>1. ä¸Šå‚³ä½ çš„ 2000 å…ƒåœ–ç‰‡ï¼š</div>
        <button class="btn btn-upload" onclick="document.getElementById('file-input').click()">ğŸ“ é¸æ“‡åœ–ç‰‡</button>
        <input type="file" id="file-input" accept="image/*">
        <div id="status-msg">ç›®å‰ä½¿ç”¨ï¼šé è¨­åœ–</div>
        
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ccc;">
        
        <div>2. æ»¿æ„å¾Œï¼Œä¸‹è¼‰ç¨ç«‹æª”æ¡ˆï¼š</div>
        <button class="btn btn-save" onclick="exportStandalone()">ğŸ’¾ ä¸‹è¼‰å–®ä¸€æª”æ¡ˆ (åŒ…å«åœ–ç‰‡)</button>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">* ä¸‹è¼‰å¾Œçš„æª”æ¡ˆå¯ç›´æ¥å‚³çµ¦åˆ¥äºº</div>
    </div>

    <div id="ui-container">
        <div id="title">é¦¬å¹´è¡Œå¤§é‹ ğŸ’° æ­å–œç™¼è²¡</div>
        <div id="counter-box">
            <div id="money-label">ç›®å‰é‡‘é¡ (NTD)</div>
            <div id="total-amount">0</div>
        </div>
    </div>
    
    <div id="instruction">é»æ“Šç´…åŒ…æ‰“é–‹ ğŸ‘‡</div>

    <script>
        // === æ ¸å¿ƒè®Šæ•¸ ===
        // å¦‚æœæ˜¯æ‰“åŒ…å¾Œçš„æª”æ¡ˆï¼Œé€™å€‹è®Šæ•¸æœƒè¢«è‡ªå‹•å¡«å…¥ Base64 å­—ä¸²
        const EMBEDDED_IMAGE = ""; 

        const TOTAL_AMOUNT = 168000;
        const BILL_VALUE = 2000;
        const TOTAL_BILLS = TOTAL_AMOUNT / BILL_VALUE;
        let currentMoney = 0;
        let isOpened = false;
        let billMaterial; // å…¨åŸŸæè³ªè®Šæ•¸
        let currentBase64 = ""; // æš«å­˜ä½¿ç”¨è€…ä¸Šå‚³çš„åœ–ç‰‡ç·¨ç¢¼

        // --- 1. åˆå§‹åŒ–å ´æ™¯ ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x1a0505, 0.02);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 10, 20);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffd700, 0.8);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- 2. æè³ªç”Ÿæˆ ---
        function createEnvelopeTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#cc0000'; ctx.fillRect(0, 0, 512, 512);
            for(let i=0; i<1000; i++) { ctx.fillStyle = 'rgba(255, 215, 0, 0.2)'; ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2); }
            ctx.font = 'bold 200px "Microsoft JhengHei"'; ctx.fillStyle = '#ffd700'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 10; ctx.fillText('é¦¬', 256, 256);
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 10; ctx.strokeRect(20, 20, 472, 472);
            return new THREE.CanvasTexture(canvas);
        }

        function createDefaultBillTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 512, 0);
            gradient.addColorStop(0, '#d8bfd8'); gradient.addColorStop(0.5, '#9370db'); gradient.addColorStop(1, '#d8bfd8');
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, 512, 256);
            ctx.fillStyle = '#4b0082'; ctx.font = 'bold 80px Arial'; ctx.textAlign = 'right'; ctx.fillText('2000', 480, 80);
            ctx.textAlign = 'left'; ctx.fillText('è²³ä»Ÿåœ“', 30, 220);
            ctx.beginPath(); ctx.arc(256, 128, 60, 0, 2 * Math.PI); ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 5; ctx.stroke();
            return new THREE.CanvasTexture(canvas);
        }

        // --- 3. å»ºç«‹ç‰©ä»¶ ---
        const envelopeGroup = new THREE.Group();
        scene.add(envelopeGroup);

        const envGeo = new THREE.BoxGeometry(4.2, 6, 0.25);
        const envMat = new THREE.MeshStandardMaterial({ map: createEnvelopeTexture() });
        const envelopeBody = new THREE.Mesh(envGeo, envMat);
        envelopeBody.castShadow = true;
        envelopeGroup.add(envelopeBody);

        const flapGroup = new THREE.Group();
        flapGroup.position.set(0, 3, 0.125);
        envelopeGroup.add(flapGroup);
        const flapGeo = new THREE.BoxGeometry(4.2, 1.5, 0.1);
        const flapMat = new THREE.MeshStandardMaterial({ color: 0xb30000 });
        const flap = new THREE.Mesh(flapGeo, flapMat);
        flap.position.set(0, -0.75, 0);
        flapGroup.add(flap);

        // éˆ”ç¥¨è¨­å®š
        const bills = [];
        const billGeo = new THREE.PlaneGeometry(3.8, 1.9);
        
        // æ±ºå®šåˆå§‹æè³ªï¼šå¦‚æœæœ‰å…§åµŒåœ–ç‰‡å°±ç”¨ï¼Œæ²’æœ‰å°±ç”¨é è¨­
        let initialMap;
        if (EMBEDDED_IMAGE && EMBEDDED_IMAGE.length > 100) {
            const img = new Image();
            img.src = EMBEDDED_IMAGE;
            initialMap = new THREE.Texture(img);
            img.onload = () => { initialMap.needsUpdate = true; };
            // å¦‚æœæ˜¯æ‰“åŒ…ç‰ˆï¼Œéš±è—å·¥å…·åˆ—
            const tb = document.getElementById('toolbox');
            if(tb) tb.style.display = 'none';
        } else {
            initialMap = createDefaultBillTexture();
        }

        billMaterial = new THREE.MeshStandardMaterial({ 
            map: initialMap, 
            side: THREE.DoubleSide,
            roughness: 0.4 
        });

        for (let i = 0; i < TOTAL_BILLS; i++) {
            const bill = new THREE.Mesh(billGeo, billMaterial);
            bill.position.set(0, 0, 0); 
            bill.visible = false;
            envelopeGroup.add(bill);
            bills.push(bill);
        }

        // --- 4. äº’å‹•é‚è¼¯ ---
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            // é˜²æ­¢é»åˆ°å·¥å…·åˆ—è§¸ç™¼
            if (event.target.closest('#toolbox') || event.target.closest('button')) return;
            
            if (isOpened) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (raycaster.intersectObjects(envelopeGroup.children, true).length > 0) startAnimation();
        }, false);

        function startAnimation() {
            isOpened = true;
            document.getElementById('instruction').style.opacity = 0;
            // éš±è—å·¥å…·åˆ— (å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼)
            const tb = document.getElementById('toolbox');
            if(tb) tb.style.opacity = 0.2; // è®Šæ·¡ä»¥å…å¹²æ“¾

            gsap.to(flapGroup.rotation, { x: -Math.PI + 0.5, duration: 1, ease: "back.out(1.7)" });
            
            bills.forEach((bill, index) => {
                bill.visible = true;
                const delay = 0.8 + (index * 0.08); 
                gsap.to(bill.position, { y: 4, z: 0.5, duration: 0.5, delay: delay, ease: "power1.out", onComplete: () => {
                    gsap.to(bill.position, { 
                        x: (Math.random() - 0.5) * 1.5, 
                        y: -6 + (index * 0.025), 
                        z: 8, 
                        duration: 0.8, 
                        ease: "bounce.out", 
                        onStart: updateCounter 
                    });
                    gsap.to(bill.rotation, { 
                        x: Math.PI / 2, 
                        z: Math.random() * 0.5 - 0.25, 
                        duration: 0.8, 
                        delay: delay 
                    });
                }});
            });
        }

        const totalAmountDiv = document.getElementById('total-amount');
        function updateCounter() {
            currentMoney += BILL_VALUE;
            totalAmountDiv.innerText = currentMoney.toLocaleString();
            gsap.fromTo(totalAmountDiv, {scale: 1.3}, {scale: 1, duration: 0.1});
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (!isOpened) { envelopeGroup.rotation.y += 0.005; envelopeGroup.position.y = Math.sin(Date.now() * 0.002) * 0.5; }
            renderer.render(scene, camera);
        }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();

        // --- 5. å·¥å…·åˆ—åŠŸèƒ½ (ä¸Šå‚³èˆ‡æ‰“åŒ…) ---
        
        // A. ä¸Šå‚³åœ–ç‰‡ä¸¦å³æ™‚é è¦½
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                currentBase64 = event.target.result;
                const img = new Image();
                img.src = currentBase64;
                img.onload = function() {
                    const texture = new THREE.Texture(img);
                    texture.needsUpdate = true;
                    billMaterial.map = texture; // å³æ™‚æ›´æ›å ´æ™¯ä¸­çš„è²¼åœ–
                    billMaterial.needsUpdate = true;
                    document.getElementById('status-msg').innerText = "âœ… åœ–ç‰‡å·²æ›´æ–°ï¼å¯é–‹å§‹éŠæˆ²æˆ–ä¸‹è¼‰";
                    document.getElementById('status-msg').style.color = "#00aa00";
                };
            };
            reader.readAsDataURL(file);
        });

        // B. æ‰“åŒ…ä¸¦ä¸‹è¼‰åŠŸèƒ½
        function exportStandalone() {
            if (!currentBase64) {
                if(!confirm("ä½ é‚„æ²’ä¸Šå‚³åœ–ç‰‡ï¼Œç¢ºå®šè¦ä¸‹è¼‰é è¨­ç‰ˆæœ¬å—ï¼Ÿ")) return;
            }

            // 1. å–å¾—ç•¶å‰ç¶²é çš„ HTML
            let htmlContent = document.documentElement.outerHTML;

            // 2. ç§»é™¤å·¥å…·åˆ— (Toolbox)
            // æˆ‘å€‘ä½¿ç”¨æ­£è¦è¡¨é”å¼æˆ– DOM æ“ä½œä¾†ç§»é™¤ <div id="toolbox">...</div>
            // ç°¡å–®ä½œæ³•ï¼šå°‡å…¶ style æ”¹ç‚º display:noneï¼Œæˆ–è€…ç›´æ¥åœ¨å­—ä¸²ä¸­å–ä»£
            const toolboxStart = htmlContent.indexOf('<div id="toolbox"');
            const toolboxEnd = htmlContent.indexOf('</div>', toolboxStart) + 6;
            // æ¯”è¼ƒä¿éšªçš„åšæ³•æ˜¯ç›´æ¥æ³¨å…¥ CSS éš±è—å®ƒï¼Œæˆ–è€…åœ¨è®Šæ•¸ä¸­è¨­å®šæ¨™è¨˜
            
            // 3. æ³¨å…¥ Base64 åœ–ç‰‡æ•¸æ“š (Hardcode)
            // æ‰¾åˆ° const EMBEDDED_IMAGE = ""; ä¸¦å¡«å…¥æ•¸æ“š
            const searchStr = 'const EMBEDDED_IMAGE = "";';
            const replaceStr = `const EMBEDDED_IMAGE = "${currentBase64 || ''}";`;
            
            if (htmlContent.includes(searchStr)) {
                htmlContent = htmlContent.replace(searchStr, replaceStr);
            } else {
                alert("ç¨‹å¼ç¢¼çµæ§‹ç•°å¸¸ï¼Œç„¡æ³•è‡ªå‹•æ³¨å…¥åœ–ç‰‡ã€‚");
                return;
            }

            // 4. ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'RedEnvelope_2000_Final.html'; // æª”å
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
