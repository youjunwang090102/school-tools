<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬å¹´ 3D ç™¼å¤§è²¡ - çµ‚æ¥µç”Ÿæˆå™¨</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a0505; font-family: 'Microsoft JhengHei', sans-serif; }
        
        /* UI ä»‹é¢ */
        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 20px; box-sizing: border-box; z-index: 10;
        }
        #title { color: #ffd700; font-size: 28px; text-shadow: 0 0 10px #ff0000; margin-top: 20px; font-weight: bold; }
        #counter-box {
            background: rgba(0, 0, 0, 0.7); padding: 15px 50px; border-radius: 50px;
            border: 2px solid #ffd700; margin-bottom: 50px; text-align: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        #money-label { color: #ccc; font-size: 14px; letter-spacing: 2px; }
        #total-amount { color: #00ff00; font-size: 56px; font-weight: bold; font-family: 'Courier New', monospace; }
        
        #instruction {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; background: rgba(0,0,0,0.6); padding: 12px 24px; border-radius: 30px;
            pointer-events: none; transition: opacity 0.5s; z-index: 5; font-size: 18px; border: 1px solid #fff;
        }

        /* ç·¨è¼¯å™¨å·¥å…·åˆ— (ä¸‹è¼‰å¾Œæœƒè‡ªå‹•éš±è—) */
        #editor-panel {
            position: absolute; top: 20px; left: 20px; width: 300px;
            background: #fff; padding: 20px; border-radius: 12px;
            pointer-events: auto; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .step { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        h3 { margin: 0 0 10px 0; color: #b30000; }
        button { width: 100%; padding: 12px; margin-top: 5px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px; border: none; transition: 0.2s; }
        .btn-upload { background: #f0f0f0; color: #333; border: 2px dashed #999; }
        .btn-upload:hover { background: #e0e0e0; border-color: #666; }
        .btn-save { background: #b30000; color: #ffd700; border: 2px solid #ffd700; }
        .btn-save:hover { background: #d00000; transform: scale(1.02); }
        #status { font-size: 12px; margin-top: 5px; color: #666; font-weight: bold; }

        /* å¦‚æœæ˜¯ä¸‹è¼‰å¾Œçš„æª”æ¡ˆï¼Œé€™å€‹ CSS æœƒè¢«æ³¨å…¥ display:none */
        .editor-only { display: block; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="editor-panel" class="editor-only">
        <h3>ğŸ§§ ç´…åŒ…è£½é€ æ©Ÿ</h3>
        <div class="step">
            <div>1. ä¸Šå‚³ 2000 å…ƒåœ–ç‰‡</div>
            <button class="btn-upload" onclick="document.getElementById('upload').click()">ğŸ“ é¸æ“‡åœ–ç‰‡</button>
            <input type="file" id="upload" accept="image/*" style="display:none">
            <div id="status">è«‹ä¸Šå‚³åœ–ç‰‡...</div>
        </div>
        <div>
            <div>2. ç¢ºèªç•«é¢ç„¡èª¤å¾Œ</div>
            <button class="btn-save" onclick="saveGame()">ğŸ’¾ ä¸‹è¼‰é€™å€‹ç¶²é  (åŒ…å«åœ–ç‰‡)</button>
        </div>
    </div>

    <div id="ui-container">
        <div id="title">é¦¬å¹´è¡Œå¤§é‹ ğŸ’° æ­å–œç™¼è²¡</div>
        <div id="counter-box">
            <div id="money-label">ç›®å‰é‡‘é¡ (NTD)</div>
            <div id="total-amount">0</div>
        </div>
    </div>
    <div id="instruction">é»æ“Šç´…åŒ…æ‰“é–‹ ğŸ‘‡</div>

    <script>
        // === æ ¸å¿ƒè³‡æ–™ (ä¸‹è¼‰å¾Œé€™è£¡æœƒè¢«å¡«å…¥åœ–ç‰‡ä»£ç¢¼) ===
        const SAVED_IMAGE_DATA = ""; 

        // === è®Šæ•¸ ===
        const TOTAL_AMOUNT = 168000;
        const BILL_VALUE = 2000;
        const TOTAL_BILLS = TOTAL_AMOUNT / BILL_VALUE;
        let currentMoney = 0;
        let isOpened = false;
        let billMaterial;
        let currentBase64 = SAVED_IMAGE_DATA; // é è¨­ä½¿ç”¨å„²å­˜çš„åœ–ç‰‡

        // === åˆå§‹åŒ– ===
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x1a0505, 0.02);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 10, 20);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // ç‡ˆå…‰
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // æè³ª
        function createEnvelopeTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#cc0000'; ctx.fillRect(0, 0, 512, 512);
            for(let i=0; i<1000; i++) { ctx.fillStyle = 'rgba(255, 215, 0, 0.2)'; ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2); }
            ctx.font = 'bold 200px "Microsoft JhengHei"'; ctx.fillStyle = '#ffd700'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('é¦¬', 256, 256);
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 10; ctx.strokeRect(20, 20, 472, 472);
            return new THREE.CanvasTexture(canvas);
        }

        // å»ºç«‹ç‰©ä»¶
        const envelopeGroup = new THREE.Group();
        scene.add(envelopeGroup);
        const envMat = new THREE.MeshStandardMaterial({ map: createEnvelopeTexture() });
        const envelopeBody = new THREE.Mesh(new THREE.BoxGeometry(4.2, 6, 0.25), envMat);
        envelopeGroup.add(envelopeBody);

        const flapGroup = new THREE.Group();
        flapGroup.position.set(0, 3, 0.125);
        envelopeGroup.add(flapGroup);
        const flap = new THREE.Mesh(new THREE.BoxGeometry(4.2, 1.5, 0.1), new THREE.MeshStandardMaterial({ color: 0xb30000 }));
        flap.position.set(0, -0.75, 0);
        flapGroup.add(flap);

        // éˆ”ç¥¨æè³ª - é—œéµä¿®æ”¹ï¼šä½¿ç”¨ MeshBasicMaterial (è‡ªç™¼å…‰ï¼Œä¸åå…‰)
        billMaterial = new THREE.MeshBasicMaterial({ 
            side: THREE.DoubleSide,
            color: 0xffffff // é è¨­ç™½
        });

        // å¦‚æœæœ‰å…§åµŒåœ–ç‰‡ (ä¸‹è¼‰ç‰ˆ)ï¼Œç«‹å³è¼‰å…¥
        if (SAVED_IMAGE_DATA.length > 100) {
            const img = new Image();
            img.src = SAVED_IMAGE_DATA;
            img.onload = function() {
                const tex = new THREE.Texture(img);
                tex.needsUpdate = true;
                billMaterial.map = tex;
                billMaterial.needsUpdate = true;
                // éš±è—ç·¨è¼¯å™¨
                const editor = document.getElementById('editor-panel');
                if(editor) editor.style.display = 'none';
            }
        } else {
            // é è¨­ç´«è‰²åœ–
             const canvas = document.createElement('canvas'); canvas.width=256; canvas.height=128;
             const ctx = canvas.getContext('2d'); ctx.fillStyle='#9370db'; ctx.fillRect(0,0,256,128);
             ctx.fillStyle='white'; ctx.font='30px Arial'; ctx.fillText('2000', 10, 50);
             billMaterial.map = new THREE.CanvasTexture(canvas);
        }

        const bills = [];
        const billGeo = new THREE.PlaneGeometry(3.8, 1.9);
        for (let i = 0; i < TOTAL_BILLS; i++) {
            const bill = new THREE.Mesh(billGeo, billMaterial);
            bill.visible = false;
            envelopeGroup.add(bill);
            bills.push(bill);
        }

        // === ä¸Šå‚³é‚è¼¯ (ç·¨è¼¯å™¨ç”¨) ===
        document.getElementById('upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const status = document.getElementById('status');
            status.innerText = "â³ è®€å–ä¸­...";
            
            const reader = new FileReader();
            reader.onload = function(event) {
                currentBase64 = event.target.result;
                const img = new Image();
                img.src = currentBase64;
                img.onload = function() {
                    const tex = new THREE.Texture(img);
                    tex.needsUpdate = true;
                    // æ›´æ–°æè³ª
                    billMaterial.map = tex;
                    billMaterial.color.setHex(0xffffff); // ç¢ºä¿æ˜¯ç™½è‰²åº•
                    billMaterial.needsUpdate = true;
                    status.innerText = "âœ… åœ–ç‰‡å·²æ›´æ–°ï¼è«‹çœ‹ç•«é¢";
                    status.style.color = "green";
                };
            };
            reader.readAsDataURL(file);
        });

        // === ä¸‹è¼‰é‚è¼¯ (å­˜æª”ç”¨) ===
        window.saveGame = function() {
            if (!currentBase64 || currentBase64.length < 100) {
                if(!confirm("é‚„æ²’ä¸Šå‚³åœ–ç‰‡ï¼Œè¦å­˜æˆé è¨­ç‰ˆå—ï¼Ÿ")) return;
            }

            // 1. å–å¾—ç•¶å‰åŸå§‹ç¢¼
            let html = document.documentElement.outerHTML;

            // 2. æ³¨å…¥åœ–ç‰‡æ•¸æ“š (æ›¿æ›æ‰ const SAVED_IMAGE_DATA = "";)
            // ä½¿ç”¨ split/join é¿å… replace å­—ä¸²é•·åº¦é™åˆ¶
            const parts = html.split('const SAVED_IMAGE_DATA = "";');
            if (parts.length < 2) {
                // å¦‚æœæ˜¯ç¬¬äºŒæ¬¡å­˜æª”ï¼Œæ ¼å¼å¯èƒ½è®Šäº†ï¼Œå˜—è©¦æ‰¾æœ‰å…§å®¹çš„
                alert("å­˜æª”çµæ§‹ç•°å¸¸ï¼Œè«‹é‡æ–°æ•´ç†é é¢å†è©¦ã€‚"); 
                return;
            }
            
            let newHtml = parts[0] + 'const SAVED_IMAGE_DATA = "' + currentBase64 + '";' + parts[1];

            // 3. æ³¨å…¥ CSS ä¾†éš±è—ç·¨è¼¯å™¨
            newHtml = newHtml.replace('.editor-only { display: block; }', '.editor-only { display: none !important; }');

            // 4. ä¸‹è¼‰
            const blob = new Blob([newHtml], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'My_Red_Envelope.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // === å‹•ç•«èˆ‡äº’å‹• ===
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            if (event.target.closest('#editor-panel')) return;
            if (isOpened) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (raycaster.intersectObjects(envelopeGroup.children, true).length > 0) startAnimation();
        });

        function startAnimation() {
            isOpened = true;
            document.getElementById('instruction').style.opacity = 0;
            const editor = document.getElementById('editor-panel');
            if(editor) editor.style.opacity = 0; // éš±è—ç·¨è¼¯å™¨

            gsap.to(flapGroup.rotation, { x: -Math.PI + 0.5, duration: 1, ease: "back.out(1.7)" });
            bills.forEach((bill, index) => {
                bill.visible = true;
                const delay = 0.8 + (index * 0.08); 
                gsap.to(bill.position, { y: 4, z: 0.5, duration: 0.5, delay: delay, ease: "power1.out", onComplete: () => {
                    gsap.to(bill.position, { x: (Math.random()-0.5)*1.5, y: -6+(index*0.025), z: 8, duration: 0.8, ease: "bounce.out", onStart: updateCounter });
                    gsap.to(bill.rotation, { x: Math.PI/2, z: (Math.random()-0.5)*0.5, duration: 0.8, delay: delay });
                }});
            });
        }
        function updateCounter() {
            currentMoney += BILL_VALUE;
            document.getElementById('total-amount').innerText = currentMoney.toLocaleString();
            gsap.fromTo(document.getElementById('total-amount'), {scale: 1.3}, {scale: 1, duration: 0.1});
        }
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (!isOpened) { envelopeGroup.rotation.y += 0.005; envelopeGroup.position.y = Math.sin(Date.now() * 0.002) * 0.5; }
            renderer.render(scene, camera);
        }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();
    </script>
</body>
</html>
