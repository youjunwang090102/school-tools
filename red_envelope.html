<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬å¹´ 3D ç™¼å¤§è²¡ - ç©©å¥ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a0505; font-family: 'Microsoft JhengHei', sans-serif; }
        
        /* UI ä»‹é¢ */
        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 20px; box-sizing: border-box; z-index: 10;
        }
        #title { color: #ffd700; font-size: 28px; text-shadow: 0 0 10px #ff0000; margin-top: 20px; font-weight: bold; }
        #counter-box {
            background: rgba(0, 0, 0, 0.7); padding: 15px 50px; border-radius: 50px;
            border: 2px solid #ffd700; margin-bottom: 50px; text-align: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        #money-label { color: #ccc; font-size: 14px; letter-spacing: 2px; }
        #total-amount { color: #00ff00; font-size: 56px; font-weight: bold; font-family: 'Courier New', monospace; }
        
        #instruction {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; background: rgba(0,0,0,0.6); padding: 12px 24px; border-radius: 30px;
            pointer-events: none; transition: opacity 0.5s; z-index: 5; font-size: 18px; border: 1px solid #fff;
        }

        /* è¨­å®šé¢æ¿ */
        #toolbox {
            position: absolute; top: 20px; left: 20px; width: 260px;
            background: #fff; padding: 15px; border-radius: 8px;
            pointer-events: auto; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-size: 14px; color: #333;
        }
        #toolbox h3 { margin: 0 0 10px 0; color: #b30000; border-bottom: 2px solid #ffd700; }
        .btn {
            display: block; width: 100%; padding: 10px; margin-top: 8px;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .btn-upload { background: #eee; border: 1px solid #ccc; }
        .btn-save { background: #b30000; color: #ffd700; }
        #file-input { display: none; }
        #status-msg { margin-top: 8px; font-size: 13px; font-weight: bold; color: #666; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="toolbox">
        <h3>ğŸ§§ è¨­å®šé¢æ¿</h3>
        <button class="btn btn-upload" onclick="document.getElementById('file-input').click()">ğŸ“ 1. ä¸Šå‚³éˆ”ç¥¨åœ–</button>
        <input type="file" id="file-input" accept="image/*">
        <div id="status-msg">ç­‰å¾…åœ–ç‰‡...</div>
        <hr style="margin: 10px 0;">
        <button class="btn btn-save" onclick="exportStandalone()">ğŸ’¾ 2. ä¸‹è¼‰å®Œæˆæª”</button>
    </div>

    <div id="ui-container">
        <div id="title">é¦¬å¹´è¡Œå¤§é‹ ğŸ’° æ­å–œç™¼è²¡</div>
        <div id="counter-box">
            <div id="money-label">ç›®å‰é‡‘é¡ (NTD)</div>
            <div id="total-amount">0</div>
        </div>
    </div>
    
    <div id="instruction">é»æ“Šç´…åŒ…æ‰“é–‹ ğŸ‘‡</div>

    <script>
        // === å…§åµŒåœ–ç‰‡å€ (ä¸‹è¼‰å¾Œæœƒè‡ªå‹•å¡«å…¥) ===
        const EMBEDDED_IMAGE = ""; 

        // === éŠæˆ²è®Šæ•¸ ===
        const TOTAL_AMOUNT = 168000;
        const BILL_VALUE = 2000;
        const TOTAL_BILLS = TOTAL_AMOUNT / BILL_VALUE;
        let currentMoney = 0;
        let isOpened = false;
        let billMaterial; 
        let currentBase64 = "";

        // === 1. åˆå§‹åŒ– ===
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x1a0505, 0.02);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 10, 20);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dirLight = new THREE.DirectionalLight(0xffd700, 0.8);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // === 2. æè³ª ===
        function createEnvelopeTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#cc0000'; ctx.fillRect(0, 0, 512, 512);
            for(let i=0; i<1000; i++) { ctx.fillStyle = 'rgba(255, 215, 0, 0.2)'; ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2); }
            ctx.font = 'bold 200px "Microsoft JhengHei"'; ctx.fillStyle = '#ffd700'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('é¦¬', 256, 256);
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 10; ctx.strokeRect(20, 20, 472, 472);
            return new THREE.CanvasTexture(canvas);
        }

        function createDefaultBillTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#9370db'; ctx.fillRect(0, 0, 512, 256);
            ctx.fillStyle = '#4b0082'; ctx.font = 'bold 80px Arial'; ctx.textAlign = 'right'; ctx.fillText('2000', 480, 80);
            ctx.textAlign = 'left'; ctx.fillText('é è¨­åœ–', 30, 220);
            return new THREE.CanvasTexture(canvas);
        }

        // === 3. ç‰©ä»¶ ===
        const envelopeGroup = new THREE.Group();
        scene.add(envelopeGroup);

        // ç´…åŒ…æœ¬é«”
        const envMat = new THREE.MeshStandardMaterial({ map: createEnvelopeTexture() });
        const envelopeBody = new THREE.Mesh(new THREE.BoxGeometry(4.2, 6, 0.25), envMat);
        envelopeBody.castShadow = true;
        envelopeGroup.add(envelopeBody);

        // ç´…åŒ…è“‹
        const flapGroup = new THREE.Group();
        flapGroup.position.set(0, 3, 0.125);
        envelopeGroup.add(flapGroup);
        const flap = new THREE.Mesh(new THREE.BoxGeometry(4.2, 1.5, 0.1), new THREE.MeshStandardMaterial({ color: 0xb30000 }));
        flap.position.set(0, -0.75, 0);
        flapGroup.add(flap);

        // éˆ”ç¥¨
        const bills = [];
        const billGeo = new THREE.PlaneGeometry(3.8, 1.9); // 2:1 æ¯”ä¾‹
        billMaterial = new THREE.MeshStandardMaterial({ side: THREE.DoubleSide });

        // åˆå§‹åŒ–æè³ª (æª¢æŸ¥æ˜¯å¦æœ‰å…§åµŒåœ–ç‰‡)
        if (EMBEDDED_IMAGE && EMBEDDED_IMAGE.length > 50) {
            const img = new Image();
            img.src = EMBEDDED_IMAGE;
            img.onload = function() {
                const tex = new THREE.Texture(img);
                tex.needsUpdate = true;
                billMaterial.map = tex;
                billMaterial.needsUpdate = true;
                // éš±è—å·¥å…·åˆ—
                const tb = document.getElementById('toolbox');
                if(tb) tb.style.display = 'none';
            };
        } else {
            billMaterial.map = createDefaultBillTexture();
        }

        for (let i = 0; i < TOTAL_BILLS; i++) {
            const bill = new THREE.Mesh(billGeo, billMaterial);
            bill.visible = false;
            envelopeGroup.add(bill);
            bills.push(bill);
        }

        // === 4. åœ–ç‰‡ä¸Šå‚³é‚è¼¯ (æœ€ç©©å®šçš„ Native DOM æ–¹å¼) ===
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const statusMsg = document.getElementById('status-msg');
            statusMsg.innerText = "â³ è®€å–ä¸­...";
            statusMsg.style.color = "blue";

            const reader = new FileReader();
            
            // è®€å–å®Œæˆçš„å›èª¿
            reader.onload = function(event) {
                const result = event.target.result; // Base64 å­—ä¸²
                
                // å‰µå»ºä¸€å€‹åŸç”Ÿ Image ç‰©ä»¶ä¾†é©—è­‰åœ–ç‰‡
                const imageElement = new Image();
                imageElement.src = result;

                imageElement.onload = function() {
                    // 1. åœ–ç‰‡è¼‰å…¥æˆåŠŸï¼Œå»ºç«‹ Texture
                    const newTexture = new THREE.Texture(imageElement);
                    newTexture.needsUpdate = true; // é‡è¦ï¼šå‘Šè¨´ GPU æ›´æ–°

                    // 2. æ›´æ–°æè³ª
                    billMaterial.map = newTexture;
                    billMaterial.needsUpdate = true;
                    
                    // 3. å„²å­˜ Base64 ä¾›ä¸‹è¼‰ç”¨
                    currentBase64 = result;

                    statusMsg.innerText = "âœ… æˆåŠŸæ›åœ–ï¼";
                    statusMsg.style.color = "green";
                };

                imageElement.onerror = function() {
                    alert("âŒ åœ–ç‰‡æ ¼å¼éŒ¯èª¤ï¼Œç€è¦½å™¨ç„¡æ³•è§£æã€‚è«‹è©¦è©¦çœ‹åˆ¥å¼µåœ–ç‰‡ (JPG/PNG)ã€‚");
                    statusMsg.innerText = "âŒ å¤±æ•—";
                    statusMsg.style.color = "red";
                };
            };

            reader.onerror = function() {
                alert("è®€å–æª”æ¡ˆå¤±æ•—ã€‚");
            };

            reader.readAsDataURL(file);
        });

        // === 5. ä¸‹è¼‰åŠŸèƒ½ ===
        function exportStandalone() {
            if (!currentBase64 && !confirm("æœªä¸Šå‚³åœ–ç‰‡ï¼Œè¦ä¸‹è¼‰é è¨­ç‰ˆå—ï¼Ÿ")) return;

            let html = document.documentElement.outerHTML;
            // æ›¿æ›è®Šæ•¸
            const search = 'const EMBEDDED_IMAGE = "";';
            const replace = `const EMBEDDED_IMAGE = "${currentBase64}";`;
            html = html.replace(search, replace);
            // éš±è—å·¥å…·åˆ—
            html = html.replace('</style>', '#toolbox { display: none !important; } </style>');

            const blob = new Blob([html], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'RedEnvelope_Ready.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // === 6. å‹•ç•«èˆ‡æ§åˆ¶ ===
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            if (event.target.closest('#toolbox') || event.target.closest('button')) return;
            if (isOpened) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (raycaster.intersectObjects(envelopeGroup.children, true).length > 0) startAnimation();
        });

        function startAnimation() {
            isOpened = true;
            document.getElementById('instruction').style.opacity = 0;
            const tb = document.getElementById('toolbox'); if(tb) tb.style.opacity = 0.2;

            gsap.to(flapGroup.rotation, { x: -Math.PI + 0.5, duration: 1, ease: "back.out(1.7)" });
            bills.forEach((bill, index) => {
                bill.visible = true;
                const delay = 0.8 + (index * 0.08); 
                gsap.to(bill.position, { y: 4, z: 0.5, duration: 0.5, delay: delay, ease: "power1.out", onComplete: () => {
                    gsap.to(bill.position, { x: (Math.random()-0.5)*1.5, y: -6+(index*0.025), z: 8, duration: 0.8, ease: "bounce.out", onStart: updateCounter });
                    gsap.to(bill.rotation, { x: Math.PI/2, z: (Math.random()-0.5)*0.5, duration: 0.8, delay: delay });
                }});
            });
        }

        function updateCounter() {
            currentMoney += BILL_VALUE;
            document.getElementById('total-amount').innerText = currentMoney.toLocaleString();
            gsap.fromTo(document.getElementById('total-amount'), {scale: 1.3}, {scale: 1, duration: 0.1});
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (!isOpened) { envelopeGroup.rotation.y += 0.005; envelopeGroup.position.y = Math.sin(Date.now() * 0.002) * 0.5; }
            renderer.render(scene, camera);
        }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();
    </script>
</body>
</html>
