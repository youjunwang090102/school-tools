<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ± v4.0 </title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --w: #f6ad55; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; background: white; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
        
        .tabs { display: flex; background: #edf2f7; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; color: #718096; border-bottom: 3px solid transparent; transition:0.3s; }
        .tab.active { background: white; color: var(--p); border-bottom: 3px solid var(--p); }
        
        .content { padding: 20px; }
        .view { display: none; opacity: 0; transition: opacity 0.3s; }
        .view.active { display: block; opacity: 1; }
        
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        
        .pw-box { position: relative; width: 100%; }
        .pw-box input { padding-right: 45px; width: 100%; }
        .pw-toggle { position: absolute; right: 5px; top: 9px; width: 40px; height: 40px; background: none; border: none; color: #718096; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        .captcha-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .captcha-display { flex: 1; background: #2d3748; color: #fff; letter-spacing: 5px; font-family: monospace; font-size: 1.5rem; text-align: center; padding: 10px; border-radius: 12px; font-weight: bold; text-decoration: line-through; }
        .captcha-btn { width: auto; padding: 10px 15px; background: #cbd5e0; color: #4a5568; }

        .history-section { margin-top: 15px; border-top: 1px dashed #cbd5e0; padding-top: 10px; }
        .log-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.85rem; border-left: 4px solid var(--d); }
        
        /* å­¸ç”Ÿå¡ç‰‡æ¨£å¼ */
        .stu-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition:0.2s; }
        .stu-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .score-badge { background: var(--d); color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; }
        
        /* è­¦å‘Šå€å¡Š */
        #alertSection { background: #fff5f5; border: 2px solid #fc8181; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; animation: pulse 2s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(252, 129, 129, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(252, 129, 129, 0);} 100% {box-shadow: 0 0 0 0 rgba(252, 129, 129, 0);} }
        .alert-item { color: #c53030; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }

        /* å¾…å¯©æ ¸å€å¡Š */
        #pendingSection { background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; }
        .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #bee3f8; }
        
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center; }
        .modal-body { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; max-height: 85vh; overflow-y: auto; }
        
        #superAdminControls, #roleAssignSection, #serviceSection { display: none; margin-top: 10px; padding: 10px; border-radius: 10px; }
        #roleAssignSection { background: #fffbe6; border: 1px solid #ffe58f; }
        #serviceSection { background: #f0fff4; border: 1px solid #9ae6b4; text-align: center; }
        
        .danger-btn { background: var(--d); margin-bottom: 5px; }
        .warn-btn { background: var(--w); color: white; margin-bottom: 5px; }
        .success-btn { background: #48bb78; color: white; margin-bottom: 5px; }
        .role-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #4a5568; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="authTabs" class="tabs">
        <div id="t-login" class="tab active" onclick="setTab('login')">ç™»å…¥</div>
        <div id="t-reg" class="tab" onclick="setTab('register')">è¨»å†Š</div>
    </div>
    
    <div class="content">
        <div id="loginView" class="view active">
            <input type="number" id="loginId" placeholder="åº§è™Ÿ (ä¾‹å¦‚: 1, 99, 100)">
            <div class="pw-box">
                <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('loginPw')">ğŸ‘ï¸</button>
            </div>
            <button onclick="doLogin()">é€²å…¥ç³»çµ±</button>
        </div>

        <div id="resetView" class="view" style="text-align: center;">
            <h2 style="color:var(--d)">âš ï¸ éœ€é‡è¨­å¯†ç¢¼</h2>
            <p style="color:#718096; font-size:0.9rem;">ç³»çµ±åµæ¸¬åˆ°æ‚¨ä½¿ç”¨é è¨­å¯†ç¢¼ï¼Œè«‹è¨­å®šæ–°å¯†ç¢¼ã€‚</p>
            <div class="pw-box"><input type="password" id="resetPw" placeholder="æ–°å¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('resetPw')">ğŸ‘ï¸</button></div>
            <div class="pw-box"><input type="password" id="resetPw2" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('resetPw2')">ğŸ‘ï¸</button></div>
            <button onclick="doForcePasswordChange()">ç¢ºèªä¿®æ”¹ä¸¦ç™»å…¥</button>
        </div>

        <div id="regView" class="view">
            <input type="number" id="regId" placeholder="åº§è™Ÿ (è«‹å¡«å¯«çœŸå¯¦åº§è™Ÿ)">
            <input type="text" id="regName" placeholder="å§“å (è«‹å¡«å¯«çœŸå¯¦å§“å)">
            <div class="pw-box"><input type="password" id="regPw" placeholder="è¨­å®šå¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('regPw')">ğŸ‘ï¸</button></div>
            <div class="pw-box"><input type="password" id="regPw2" placeholder="ç¢ºèªå¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('regPw2')">ğŸ‘ï¸</button></div>
            <div class="captcha-row">
                <div id="captchaDisplay" class="captcha-display">ABCD</div>
                <button type="button" class="captcha-btn" onclick="refreshCaptcha()">ğŸ”„</button>
            </div>
            <input type="text" id="captchaInput" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹ 4 ç¢¼é©—è­‰ç¢¼">
            <button onclick="doRegister()" style="background:var(--s)">é€å‡ºåŠ å…¥ç”³è«‹</button>
        </div>

        <div id="dashboardView" class="view">
            <div id="alertSection">
                <h3 style="margin:0 0 10px 0; color:#c53030;">ğŸš¨ éœ€æ„›ç­æœå‹™åå–®</h3>
                <div id="alertList"></div>
            </div>

            <div id="pendingSection">
                <h3 style="margin:0 0 10px 0; color:#2b6cb0;">â³ åŠ å…¥ç”³è«‹åˆ—è¡¨</h3>
                <div id="pendingList"></div>
            </div>

            <div id="stuWarning" style="background:#fff5f5; border:1px solid #feb2b2; color:#c53030; padding:15px; border-radius:15px; margin-bottom:15px; text-align:center; display:none;">âš ï¸ è­¦å‘Šï¼š<span id="warnText"></span></div>
            
            <div style="background: linear-gradient(135deg, #4361ee, #4cc9f0); color:white; padding:25px; border-radius:20px; text-align:center;">
                <h2 id="welcomeTitle"></h2>
                <div id="myJob" style="font-size:1.8rem; font-weight:900; margin:10px 0;"></div>
                <div id="myScore" style="font-size:1.1rem;">ç›®å‰é»æ•¸ï¼š0</div>
            </div>
            
            <div class="history-section"><h3>ğŸ“… è¨˜é»æ­·ç¨‹</h3><div id="myLogs"></div></div>
            
            <div id="adminSection" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                    <h3>ğŸš€ ç®¡ç†é¢æ¿</h3>
                    <button id="settingBtn" onclick="editThreshold()" style="width:auto; font-size:0.8rem; padding:5px 10px; background:#718096;">âš™ï¸ è¨­å®š</button>
                </div>
                <div id="stuGrid"></div>
            </div>
            
            <button onclick="location.reload()" style="background:#718096; margin-top:20px;">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <h3 id="targetName" style="margin:0;"></h3>
        <div id="modalScore" style="text-align:center; font-size:3rem; color:var(--d); font-weight:900; margin:10px 0;">0</div>
        
        <div id="serviceSection">
            <p style="margin:5px 0; font-weight:bold; color:#2f855a;">ğŸ‰ é»æ•¸å·²é”æ¨™ï¼</p>
            <button onclick="doService()" class="success-btn">ğŸ§¹ æ‰¹å‡†æ„›ç­æœå‹™ (éŠ·é»)</button>
        </div>

        <button onclick="addPoint()" style="background:var(--d); font-size:1.2rem; padding:15px;">â• è¨˜é» (+1)</button>
        <hr>
        
        <div id="roleAssignSection">
            <label style="font-size:0.8rem; color:#888; font-weight:bold;">ğŸ‘‘ èº«ä»½æ¬Šé™</label>
            <select id="rolePicker">
                <option value="student">ä¸€èˆ¬å­¸ç”Ÿ</option>
                <option value="inner_manager">å…§è¡›ç”Ÿ (ç®¡ç†)</option>
                <option value="outer_manager">å¤–è¡›ç”Ÿ (ç®¡ç†)</option>
            </select>
        </div>

        <select id="jobPicker"></select>
        <input type="text" id="newJob" placeholder="æ‰‹å‹•è¼¸å…¥æ–°å·¥ä½œ (è‡ªå‹•å„²å­˜)">
        <input type="text" id="warnInput" placeholder="çµ¦å­¸ç”Ÿçš„è©±">
        <button onclick="confirmAssign()" style="background:var(--p)">å„²å­˜æ›´æ–°</button>
        
        <div class="history-section"><h4>ğŸ” è©³ç´°æ­·ç¨‹</h4><div id="modalLogs"></div></div>
        
        <div id="superAdminControls">
            <button onclick="resetToDefaultPw()" class="warn-btn">â†º é‚„åŸé è¨­å¯†ç¢¼</button>
            <button onclick="deleteStudent()" class="danger-btn">ğŸ—‘ï¸ åˆªé™¤å¸³è™Ÿ</button>
        </div>

        <button onclick="closeModal()" style="background:#eee; color:#333; margin-top:10px;">é—œé–‰</button>
    </div>
</div>

<script>
    // 1. Firebase Config
    const firebaseConfig = { 
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null, selectedId = null, unsubS = null, unsubL = null;
    let tempResetId = null, currentCaptcha = "";
    let alertThreshold = 3; // é è¨­ 3 é»ï¼Œæœƒå¾ DB è®€å–

    // 2. åŸºç¤ UI å‡½å¼
    function setTab(m) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(m==='login') document.getElementById('t-login').classList.add('active');
        if(m==='register') { document.getElementById('t-reg').classList.add('active'); refreshCaptcha(); }
        document.getElementById('loginView').className = 'view '+(m==='login'?'active':'');
        document.getElementById('regView').className = 'view '+(m==='register'?'active':'');
        document.getElementById('resetView').classList.remove('active');
    }
    
    function togglePw(fid) { const x=document.getElementById(fid); x.type=(x.type==="password")?"text":"password"; }

    function refreshCaptcha() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let res = ""; for(let i=0;i<4;i++) res+=chars.charAt(Math.floor(Math.random()*chars.length));
        currentCaptcha = res;
        document.getElementById('captchaDisplay').innerText = res;
        document.getElementById('captchaInput').value = "";
    }

    // 3. ç³»çµ±è¨­å®š (é–¾å€¼) è®€å–
    async function loadConfig() {
        try {
            const doc = await db.collection("settings").doc("config").get();
            if(doc.exists && doc.data().threshold) {
                alertThreshold = doc.data().threshold;
            }
        } catch(e) { console.log("Config load error", e); }
    }

    // 4. ç™»å…¥
    async function doLogin() {
        // å»é™¤åº§è™Ÿå‰å°0ï¼Œçµ±ä¸€è½‰ç‚ºæ•¸å­—å†æ¯”å°ï¼Œæˆ–ç›´æ¥æ¯”å°å­—ä¸² (æ­¤è™•ç¶­æŒå­—ä¸²IDï¼Œä½†å…è¨±ä½¿ç”¨è€…è¼¸å…¥ä¸è£œ0)
        // ç‚ºäº†ç›¸å®¹ï¼Œå‡è¨­ DB å­˜çš„æ˜¯ "01", "100"ã€‚ä½¿ç”¨è€…è¼¸å…¥ "1" -> "01", "100" -> "100"
        let rawId = document.getElementById('loginId').value;
        if(!rawId) return;
        
        // ç°¡å–®æ ¼å¼åŒ–ï¼šå¦‚æœé•·åº¦æ˜¯1ä¸”æ˜¯æ•¸å­—ï¼Œè£œ0 (æ”¯æ´èˆŠè³‡æ–™)ï¼Œå¦‚æœæ˜¯2ä½æˆ–3ä½å‰‡ä¿ç•™
        // ä½†ç‚ºäº† 100 è™Ÿï¼Œå»ºè­° ID çµ±ä¸€è™•ç†ã€‚é€™è£¡å‡è¨­è¨»å†Šæ™‚æœƒè‡ªå‹•è™•ç† ID æ ¼å¼
        // ä¿®æ­£ï¼šè¨»å†Šæ™‚æˆ‘å€‘ä¸åš padStart(2) äº†ï¼Œç›´æ¥ç”¨ parseInt å¾Œçš„å­—ä¸²ç•¶ IDï¼Œæˆ–è€…çµ±ä¸€ä¸è£œ0ï¼Ÿ
        // ç‚ºäº†ç›¸å®¹èˆŠç‰ˆä»£ç¢¼ "01"ï¼Œæˆ‘å€‘å˜—è©¦å…©ç¨®å¯èƒ½
        
        // ç­–ç•¥ï¼šå˜—è©¦ç›´æ¥ IDï¼Œå¤±æ•—å‰‡è£œ 0
        let id = rawId; 
        if(rawId.length === 1) id = "0" + rawId;

        const pw = document.getElementById('loginPw').value;
        
        try {
            let doc = await db.collection("students").doc(id).get();
            // å¦‚æœè£œ0å¾Œæ²’æ‰¾åˆ°ï¼Œè©¦è©¦åŸå§‹è¼¸å…¥ (é‡å° 100 è™Ÿ)
            if(!doc.exists && rawId.length > 2) {
                doc = await db.collection("students").doc(rawId).get();
                if(doc.exists) id = rawId;
            }

            if(doc.exists && doc.data().password === pw) {
                const data = doc.data();
                
                // æª¢æŸ¥æ˜¯å¦å·²å¯©æ ¸
                if(data.status === 'pending') {
                    alert("â³ æ‚¨çš„å¸³è™Ÿæ­£åœ¨å¯©æ ¸ä¸­ï¼Œè«‹ç­‰å¾…å°å¸«æ‰¹å‡†ã€‚");
                    return;
                }

                if (data.forceReset === true) {
                    tempResetId = id;
                    document.getElementById('authTabs').style.display = 'none';
                    document.getElementById('loginView').classList.remove('active');
                    document.getElementById('resetView').classList.add('active');
                    return;
                }

                me = { id, ...data };
                document.getElementById('authTabs').style.display = 'none';
                document.getElementById('loginView').classList.remove('active');
                document.getElementById('dashboardView').classList.add('active');
                await loadConfig();
                startApp();
            } else {
                alert("ç™»å…¥å¤±æ•—ï¼šåº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
            }
        } catch(e) { alert("ç³»çµ±éŒ¯èª¤ï¼š" + e.message); }
    }

    async function doForcePasswordChange() {
        const p1=document.getElementById('resetPw').value, p2=document.getElementById('resetPw2').value;
        if(!p1 || p1!==p2) return alert("å¯†ç¢¼éŒ¯èª¤");
        await db.collection("students").doc(tempResetId).update({ password: p1, forceReset: false });
        alert("å¯†ç¢¼æ›´æ–°æˆåŠŸ"); location.reload();
    }

    // 5. è¨»å†Š (ç‹€æ…‹é è¨­ pending)
    async function doRegister() {
        let rawId = document.getElementById('regId').value;
        // è™•ç† IDï¼š1 -> 01, 99 -> 99, 100 -> 100
        let id = rawId;
        if(rawId.length === 1) id = "0" + rawId;
        
        const p1=document.getElementById('regPw').value, p2=document.getElementById('regPw2').value;
        const name=document.getElementById('regName').value;
        const uC=document.getElementById('captchaInput').value.toUpperCase();

        if(!id || !name || !p1) return alert("è³‡è¨Šä¸å®Œæ•´");
        if(p1!==p2) return alert("å¯†ç¢¼ä¸ä¸€è‡´");
        if(uC!==currentCaptcha) { refreshCaptcha(); return alert("é©—è­‰ç¢¼éŒ¯èª¤"); }

        const check = await db.collection("students").doc(id).get();
        if(check.exists) return alert("æ­¤åº§è™Ÿå·²è¨»å†Š");

        await db.collection("students").doc(id).set({ 
            name: name, password: p1, role: "student", 
            duty_zone: "æœªåˆ†é…", score: 0, warning: "",
            forceReset: false,
            status: "pending" // æ–°å¢ç‹€æ…‹
        });
        alert("ç”³è«‹å·²é€å‡ºï¼è«‹é€šçŸ¥å°å¸«æˆ–ç®¡ç†å“¡å¯©æ ¸æ‚¨çš„å¸³è™Ÿã€‚");
        setTab('login');
    }

    // 6. ä¸»ç¨‹å¼
    function startApp() {
        // ç›£è½è‡ªå·±
        db.collection("students").doc(me.id).onSnapshot(doc => {
            if(!doc.exists) { location.reload(); return; }
            const d = doc.data();
            if(d.status === 'pending') { alert("å¸³è™Ÿè¢«é‡è¨­ç‚ºå¯©æ ¸ä¸­"); location.reload(); }
            
            let rT = "";
            if(d.role==="admin") rT=" (ç®¡ç†å“¡)";
            else if(d.role==="teacher") rT=" (å°å¸«)";
            else if(d.role==="inner_manager") rT=" (å…§è¡›ç”Ÿ)";
            else if(d.role==="outer_manager") rT=" (å¤–è¡›ç”Ÿ)";

            document.getElementById('welcomeTitle').innerText = `${doc.id} ${d.name}${rT}`;
            document.getElementById('myJob').innerText = d.duty_zone;
            document.getElementById('myScore').innerText = d.score || 0;
            document.getElementById('stuWarning').style.display = d.warning ? 'block' : 'none';
            document.getElementById('warnText').innerText = d.warning || "";
        });

        // ç›£è½æ­·ç¨‹
        db.collection("point_logs").where("studentId", "==", me.id).onSnapshot(snap => {
            const box = document.getElementById('myLogs'); box.innerHTML = "";
            let list = []; snap.forEach(l => list.push(l.data()));
            list.sort((a,b) => b.time - a.time).forEach(l => {
                // å¦‚æœæ˜¯æ„›ç­æœå‹™ï¼Œé¡¯ç¤ºä¸åŒæ¨£å¼
                if(l.type === 'service') {
                    box.innerHTML += `<div class="log-item" style="border-left-color:#48bb78; background:#f0fff4;"><span>${new Date(l.time).toLocaleString()}</span><b>å®Œæˆæ„›ç­ (-${l.points})</b></div>`;
                } else {
                    box.innerHTML += `<div class="log-item"><span>${new Date(l.time).toLocaleString()}</span><b>+1</b></div>`;
                }
            });
        });

        // ç®¡ç†å“¡/å°å¸«/è¡›ç”Ÿ é‚è¼¯
        const isManager = ['admin', 'teacher', 'inner_manager', 'outer_manager'].includes(me.role);
        const canApprove = ['admin', 'teacher'].includes(me.role);

        if(isManager) {
            document.getElementById('adminSection').style.display = 'block';
            
            // ç›£è½æ‰€æœ‰å­¸ç”Ÿ (å« active èˆ‡ pending)
            db.collection("students").onSnapshot(snap => {
                const activeList = [];
                const pendingList = [];
                const alertList = []; // è¶…éé–¾å€¼åå–®
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const stu = { id: doc.id, ...d };
                    
                    if(d.status === 'pending') pendingList.push(stu);
                    else {
                        activeList.push(stu);
                        if(d.score >= alertThreshold) alertList.push(stu);
                    }
                });

                // æ’åºé‚è¼¯ä¿®æ­£ï¼šè½‰æ•¸å­—æ’åº (è§£æ±º 100 åœ¨ 99 å‰é¢çš„å•é¡Œ)
                activeList.sort((a,b) => parseInt(a.id) - parseInt(b.id));

                // æ¸²æŸ“ä¸»åˆ—è¡¨
                const grid = document.getElementById('stuGrid'); grid.innerHTML = "";
                activeList.forEach(s => {
                    let badge = "";
                    if(s.role === 'inner_manager') badge = '<span class="role-badge">å…§è¡›</span>';
                    if(s.role === 'outer_manager') badge = '<span class="role-badge">å¤–è¡›</span>';
                    
                    // å¦‚æœè¶…éé–¾å€¼ï¼Œå¡ç‰‡é‚Šæ¡†è®Šç´…
                    const warnStyle = s.score >= alertThreshold ? "border:2px solid var(--d);" : "";
                    
                    grid.innerHTML += `<div class="stu-card" style="${warnStyle}" onclick="openModal('${s.id}', '${s.name}')">
                        <b>${s.id} ${s.name} ${badge}</b>
                        <div>${s.duty_zone} <span class="score-badge">${s.score||0}</span></div>
                    </div>`;
                });

                // æ¸²æŸ“è­¦å‘Šå€ (æ‰€æœ‰äººåªè¦æœ‰æ¬Šé™éƒ½çœ‹å¾—åˆ°)
                const abox = document.getElementById('alertSection');
                const alist = document.getElementById('alertList');
                if(alertList.length > 0) {
                    abox.style.display = 'block';
                    alist.innerHTML = "";
                    alertList.forEach(s => {
                        alist.innerHTML += `<div class="alert-item">âš ï¸ ${s.id} ${s.name} (è¨˜é» ${s.score} æ¬¡)</div>`;
                    });
                } else {
                    abox.style.display = 'none';
                }

                // æ¸²æŸ“å¾…å¯©æ ¸å€ (åƒ…å°å¸«/ç®¡ç†å“¡)
                const pbox = document.getElementById('pendingSection');
                if(canApprove && pendingList.length > 0) {
                    pbox.style.display = 'block';
                    const plist = document.getElementById('pendingList');
                    plist.innerHTML = "";
                    pendingList.forEach(s => {
                        plist.innerHTML += `
                        <div class="pending-item">
                            <span>${s.id} ${s.name}</span>
                            <button onclick="approveStudent('${s.id}')" style="width:auto; padding:5px 15px; font-size:0.8rem;">âœ… æ‰¹å‡†</button>
                        </div>`;
                    });
                } else {
                    pbox.style.display = 'none';
                }
            });
            refreshJobs();
        }
        
        // éš±è—è¨­å®šæŒ‰éˆ• (è‹¥éå°å¸«/ç®¡ç†å“¡)
        if(!canApprove) document.getElementById('settingBtn').style.display = 'none';
    }

    // 7. Modal æ“ä½œ
    window.openModal = async function(id, name) {
        selectedId = id;
        document.getElementById('targetName').innerText = `${id} ${name}`;
        
        const isSuper = (me.role === 'teacher' || me.role === 'admin');
        document.getElementById('superAdminControls').style.display = isSuper ? 'block' : 'none';
        document.getElementById('roleAssignSection').style.display = isSuper ? 'block' : 'none';

        const docSnap = await db.collection("students").doc(id).get();
        const d = docSnap.data();
        
        await refreshJobs();
        document.getElementById('jobPicker').value = d.duty_zone || "";
        document.getElementById('newJob').value = "";
        document.getElementById('warnInput').value = d.warning || "";
        
        // è§’è‰²é¸å–®
        if(['student','inner_manager','outer_manager'].includes(d.role)) document.getElementById('rolePicker').value = d.role;
        else document.getElementById('rolePicker').value = 'student';

        // åˆ†æ•¸ç›£è½
        if(unsubS) unsubS();
        unsubS = db.collection("students").doc(id).onSnapshot(doc => {
            if(doc.exists) {
                const sc = doc.data().score || 0;
                document.getElementById('modalScore').innerText = sc;
                // æ„›ç­æœå‹™æŒ‰éˆ•åˆ¤æ–·
                const svcDiv = document.getElementById('serviceSection');
                if(isSuper && sc >= alertThreshold) svcDiv.style.display = 'block';
                else svcDiv.style.display = 'none';
            }
        });

        // æ­·ç¨‹
        if(unsubL) unsubL();
        unsubL = db.collection("point_logs").where("studentId", "==", id).onSnapshot(snap => {
            const box = document.getElementById('modalLogs'); box.innerHTML = "";
            let list = []; snap.forEach(l => list.push({lid: l.id, ...l.data()}));
            list.sort((a,b) => b.time - a.time).forEach(l => {
                if(l.type === 'service') {
                    box.innerHTML += `<div class="log-item" style="background:#f0fff4; border-left-color:#48bb78;"><span>${new Date(l.time).toLocaleString()}</span><span>æ„›ç­æœå‹™</span></div>`;
                } else {
                    box.innerHTML += `<div class="log-item"><span>${new Date(l.time).toLocaleString()}</span><button class="del-btn" onclick="deleteLog('${l.lid}')">ğŸ—‘ï¸ åˆªé™¤</button></div>`;
                }
            });
        });
        document.getElementById('modal').style.display = 'flex';
    }

    // æ‰¹å‡†å­¸ç”Ÿ
    window.approveStudent = async function(sid) {
        if(!confirm(`å…è¨± ${sid} è™Ÿå…¥ç­ï¼Ÿ`)) return;
        await db.collection("students").doc(sid).update({ status: 'active' });
    }

    // è¨­å®šé–¾å€¼
    window.editThreshold = async function() {
        const n = prompt("è«‹è¨­å®šã€Œè¨˜é»é” N æ¬¡ã€é¡¯ç¤ºè­¦å‘Šï¼š", alertThreshold);
        if(n && !isNaN(n)) {
            await db.collection("settings").doc("config").set({ threshold: parseInt(n) }, {merge:true});
            alertThreshold = parseInt(n);
            alert("è¨­å®šå·²æ›´æ–°");
        }
    }

    // æ„›ç­æœå‹™ (éŠ·é»)
    window.doService = async function() {
        if(!confirm(`ç¢ºèª ${selectedId} å·²å®Œæˆæ„›ç­æœå‹™ï¼Ÿ\né€™å°‡æœƒæ‰£é™¤ ${alertThreshold} é»ï¼Œä¸¦æ–°å¢ä¸€ç­†æœå‹™ç´€éŒ„ã€‚`)) return;
        
        try {
            // 1. æ‰£é»
            await db.collection("students").doc(selectedId).update({
                score: firebase.firestore.FieldValue.increment(-alertThreshold)
            });
            // 2. æ–°å¢æœå‹™ç´€éŒ„ (ä¿ç•™èˆŠç´€éŒ„ï¼ŒåªåŠ æ–°çš„ä¸€æ¢èªªæ˜)
            await db.collection("point_logs").add({
                studentId: selectedId,
                time: Date.now(),
                type: 'service',
                points: alertThreshold
            });
            alert("å·²å®ŒæˆéŠ·é»ï¼");
        } catch(e) { alert("æ“ä½œå¤±æ•—"); }
    }

    // ä»¥ä¸‹ç¶­æŒåŸæ¨£
    window.resetToDefaultPw = async function() {
        if(!confirm(`é‚„åŸå¯†ç¢¼ï¼Ÿ`)) return;
        const defPw = selectedId.repeat(3); 
        await db.collection("students").doc(selectedId).update({ password: defPw, forceReset: true });
        alert(`å¯†ç¢¼å·²é‚„åŸç‚ºï¼š${defPw}`);
        closeModal();
    }

    window.deleteStudent = async function() {
        const confirmName = prompt(`è¼¸å…¥åº§è™Ÿç¢ºèªåˆªé™¤ï¼š`);
        if(confirmName !== selectedId) return;
        await db.collection("students").doc(selectedId).delete();
        closeModal();
    }

    window.addPoint = async function() {
        await db.collection("point_logs").add({ studentId: selectedId, time: Date.now(), type: 'normal' });
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(1) });
    }

    window.deleteLog = async function(lid) {
        if(!confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) return;
        await db.collection("point_logs").doc(lid).delete();
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(-1) });
    }

    window.confirmAssign = async function() {
        const manualJob = document.getElementById('newJob').value.trim();
        const selectedJob = document.getElementById('jobPicker').value;
        const w = document.getElementById('warnInput').value;
        const finalJob = manualJob || selectedJob || "æœªåˆ†é…";
        
        let newRole = null;
        if(me.role === 'teacher' || me.role === 'admin') newRole = document.getElementById('rolePicker').value;

        const updateData = { duty_zone: finalJob, warning: w };
        if(newRole) {
            const check = await db.collection("students").doc(selectedId).get();
            const cRole = check.data().role;
            if(cRole !== 'admin' && cRole !== 'teacher') updateData.role = newRole;
        }

        await db.collection("students").doc(selectedId).update(updateData);
        if(manualJob) {
            await db.collection("duty_options").doc(manualJob).set({ active: true });
            await refreshJobs();
        }
        closeModal();
    }

    window.closeModal = function() { document.getElementById('modal').style.display = 'none'; if(unsubS) unsubS(); if(unsubL) unsubL(); }

    async function refreshJobs() {
        const p = document.getElementById('jobPicker');
        const oldVal = p.value;
        try {
            const s = await db.collection("duty_options").get();
            let options = [];
            s.forEach(doc => options.push(doc.id));
            options.sort();
            p.innerHTML = '<option value="">-- é¸æ“‡å·²å­˜å·¥ä½œ --</option>';
            options.forEach(opt => p.innerHTML += `<option value="${opt}">${opt}</option>`);
            if(oldVal) p.value = oldVal;
        } catch(e) {}
    }
    
    refreshCaptcha();
</script>
</body>
</html>
