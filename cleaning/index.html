<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ± v5.3</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; }
        .tab.active { background: white; color: var(--p); border-bottom: 3px solid var(--p); }
        .content { padding: 20px; }
        .view { display: none; }
        .view.active { display: block; }
        input, select, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; cursor: pointer; font-weight: bold; }
        .stu-card { background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .score-badge { background: var(--d); color: white; padding: 2px 10px; border-radius: 20px; font-weight: bold; }
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center; }
        .modal-body { background:white; padding:20px; border-radius:20px; width:90%; max-width:380px; max-height: 80vh; overflow-y: auto; }
        .history-item { font-size: 0.8rem; background: #f9f9f9; padding: 8px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; }
        .warning-banner { background: #ffe3e3; color: #d00; padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: center; font-weight: bold; border: 1px solid #ffbaba; }
    </style>
</head>
<body>

<div class="container">
    <div id="authTabs" class="tabs">
        <div id="t-login" class="tab active" onclick="setTab('login')">ç™»å…¥</div>
        <div id="t-reg" class="tab" onclick="setTab('register')">è¨»å†Š</div>
    </div>
    <div class="content">
        <div id="loginView" class="view active">
            <input type="number" id="loginId" placeholder="åº§è™Ÿ (ä¾‹å¦‚: 01)">
            <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
            <button onclick="doLogin()">ç™»å…¥</button>
        </div>
        <div id="regView" class="view">
            <input type="number" id="regId" placeholder="åº§è™Ÿ">
            <input type="text" id="regName" placeholder="å§“å">
            <input type="password" id="regPw" placeholder="è¨­å®šå¯†ç¢¼">
            <select id="regRole"><option value="student">å­¸ç”Ÿ</option><option value="teacher">è€å¸«</option><option value="admin">ç®¡ç†å“¡</option></select>
            <button onclick="doRegister()" style="background:var(--s)">è¨»å†Šå¸³è™Ÿ</button>
        </div>

        <div id="dashboardView" class="view">
            <div id="stuWarning" class="warning-banner" style="display:none;">âš ï¸ <span id="warnText"></span></div>
            <div style="background:var(--p); color:white; padding:20px; border-radius:15px; text-align:center; margin-bottom:15px;">
                <h3 id="welcomeTitle" style="margin:0;">è¼‰å…¥ä¸­...</h3>
                <h1 id="myJob" style="margin:10px 0;">--</h1>
                <div>ç›®å‰ç´¯ç©é»æ•¸ï¼š<b id="myScore">0</b></div>
            </div>
            <div id="adminSection" style="display:none;">
                <h4>ğŸ“‹ å­¸ç”Ÿåå–® (å³æ™‚)</h4>
                <div id="stuGrid"></div>
            </div>
            <h4>ğŸ“… è¨˜é»æ­·å²</h4>
            <div id="myLogs"></div>
            <button onclick="location.reload()" style="background:#888; margin-top:20px;">ç™»å‡º</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <h3 id="targetName" style="margin:0;">å­¸ç”Ÿç®¡ç†</h3>
        <h1 id="modalScore" style="text-align:center; color:var(--d); font-size:3rem; margin:10px 0;">0</h1>
        <button onclick="addPoint()" style="background:var(--d); font-size:1.2rem; padding:15px;">â• è¨˜é» (+1)</button>
        <hr>
        <p style="margin:5px 0; font-size:0.8rem;">åˆ†é…å·¥ä½œï¼š</p>
        <select id="jobPicker"></select>
        <input type="text" id="newJob" placeholder="æˆ–è¼¸å…¥æ–°å·¥ä½œåç¨±">
        <p style="margin:5px 0; font-size:0.8rem;">è­¦å‘Šè¨Šæ¯ï¼š</p>
        <input type="text" id="warnInput" placeholder="è¼¸å…¥è­¦å‘Šå…§å®¹">
        <button onclick="confirmUpdate()" style="background:var(--p)">å„²å­˜è¨­å®šä¸¦é—œé–‰</button>
        <div id="logList" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;"></div>
        <button onclick="closeModal()" style="background:#eee; color:#333; margin-top:10px;">å–æ¶ˆé—œé–‰</button>
    </div>
</div>

<script>
    // Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null, selectedId = null, unsub1 = null, unsub2 = null;

    function setTab(m) {
        document.getElementById('loginView').classList.toggle('active', m==='login');
        document.getElementById('regView').classList.toggle('active', m==='register');
        document.getElementById('t-login').classList.toggle('active', m==='login');
        document.getElementById('t-reg').classList.toggle('active', m==='register');
    }

    async function doRegister() {
        const id = document.getElementById('regId').value.padStart(2,'0');
        const data = {
            name: document.getElementById('regName').value,
            password: document.getElementById('regPw').value,
            role: document.getElementById('regRole').value,
            duty_zone: "æœªåˆ†é…",
            score: 0,
            warning: ""
        };
        await db.collection("students").doc(id).set(data);
        alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥"); setTab('login');
    }

    async function doLogin() {
        const id = document.getElementById('loginId').value.padStart(2,'0');
        const pw = document.getElementById('loginPw').value;
        const doc = await db.collection("students").doc(id).get();
        if(doc.exists && doc.data().password === pw) {
            me = { id, ...doc.data() };
            showDashboard();
        } else alert("å¯†ç¢¼éŒ¯èª¤æˆ–å¸³è™Ÿä¸å­˜åœ¨");
    }

    function showDashboard() {
        document.getElementById('authTabs').style.display = 'none';
        document.getElementById('loginView').classList.remove('active');
        document.getElementById('dashboardView').classList.add('active');

        // ç›£è½è‡ªå·±
        db.collection("students").doc(me.id).onSnapshot(doc => {
            const d = doc.data();
            document.getElementById('welcomeTitle').innerText = `${doc.id} ${d.name} (${d.role})`;
            document.getElementById('myJob').innerText = d.duty_zone || "å¾…åˆ†é…";
            document.getElementById('myScore').innerText = d.score || 0;
            document.getElementById('stuWarning').style.display = d.warning ? 'block' : 'none';
            document.getElementById('warnText').innerText = d.warning || "";
        });

        // ç›£è½è‡ªå·±çš„æ­·å²
        db.collection("point_logs").where("studentId", "==", me.id).onSnapshot(snap => {
            const box = document.getElementById('myLogs'); box.innerHTML = "";
            let arr = []; snap.forEach(doc => arr.push(doc.data()));
            arr.sort((a,b) => b.time - a.time).forEach(l => {
                box.innerHTML += `<div class="history-item"><span>${new Date(l.time).toLocaleString()}</span><b>+1</b></div>`;
            });
        });

        // å¦‚æœæ˜¯ç®¡ç†å“¡
        if(me.role !== 'student') {
            document.getElementById('adminSection').style.display = 'block';
            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
                const grid = document.getElementById('stuGrid'); grid.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    grid.innerHTML += `<div class="stu-card" onclick="openModal('${doc.id}')">
                        <span><b>${doc.id} ${d.name}</b><br><small>${d.duty_zone}</small></span>
                        <span class="score-badge">${d.score || 0}</span>
                    </div>`;
                });
            });
            updateJobOptions();
        }
    }

    async function openModal(id) {
        selectedId = id;
        const doc = await db.collection("students").doc(id).get();
        const d = doc.data();
        
        document.getElementById('targetName').innerText = `${id} ${d.name}`;
        document.getElementById('jobPicker').value = d.duty_zone || "";
        document.getElementById('warnInput').value = d.warning || "";
        
        if(unsub1) unsub1();
        unsub1 = db.collection("students").doc(id).onSnapshot(s => {
            document.getElementById('modalScore').innerText = s.data().score || 0;
        });

        if(unsub2) unsub2();
        unsub2 = db.collection("point_logs").where("studentId", "==", id).onSnapshot(snap => {
            const box = document.getElementById('logList'); box.innerHTML = "<b>æ­·å²ç´€éŒ„ï¼š</b><br>";
            let arr = []; snap.forEach(doc => arr.push({id: doc.id, ...doc.data()}));
            arr.sort((a,b) => b.time - a.time).forEach(l => {
                box.innerHTML += `<div class="history-item"><span>${new Date(l.time).toLocaleDateString()}</span><button style="width:auto; padding:2px 8px; background:none; color:red; border:1px solid red;" onclick="deleteLog('${l.id}')">åˆªé™¤</button></div>`;
            });
        });

        document.getElementById('modal').style.display = 'flex';
    }

    // ğŸš€ æ ¸å¿ƒï¼šä¿®æ”¹å¾Œçš„è¨˜é»å‡½æ•¸
    async function addPoint() {
        if(!selectedId) return;
        try {
            const now = Date.now();
            // åŒæ­¥åŸ·è¡Œå…©ä»¶äº‹
            await Promise.all([
                db.collection("point_logs").add({ studentId: selectedId, time: now }),
                db.collection("students").doc(selectedId).update({ 
                    score: firebase.firestore.FieldValue.increment(1) 
                })
            ]);
            console.log("è¨˜é»æˆåŠŸ");
        } catch (e) {
            alert("è¨˜é»å¤±æ•—: " + e.message);
        }
    }

    async function deleteLog(logId) {
        if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ä¸¦æ‰£åˆ†ï¼Ÿ")) return;
        await db.collection("point_logs").doc(logId).delete();
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(-1) });
    }

    async function confirmUpdate() {
        const job = document.getElementById('newJob').value || document.getElementById('jobPicker').value;
        const warn = document.getElementById('warnInput').value;
        await db.collection("students").doc(selectedId).update({ duty_zone: job, warning: warn });
        if(document.getElementById('newJob').value) {
            await db.collection("duty_options").doc(job).set({active: true});
            updateJobOptions();
        }
        closeModal();
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function updateJobOptions() {
        const picker = document.getElementById('jobPicker');
        picker.innerHTML = '<option value="æœªåˆ†é…">-- é¸æ“‡å·¥ä½œ --</option>';
        const snap = await db.collection("duty_options").get();
        snap.forEach(doc => { picker.innerHTML += `<option value="${doc.id}">${doc.id}</option>`; });
    }
</script>
</body>
</html>
