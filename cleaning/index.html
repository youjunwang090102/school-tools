<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ± v4.1 (Full Reset)</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --w: #f6ad55; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; background: white; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #edf2f7; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; color: #718096; border-bottom: 3px solid transparent; transition:0.3s; }
        .tab.active { background: white; color: var(--p); border-bottom: 3px solid var(--p); }
        .content { padding: 20px; }
        .view { display: none; opacity: 0; transition: opacity 0.3s; }
        .view.active { display: block; opacity: 1; }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .pw-box { position: relative; width: 100%; }
        .pw-box input { padding-right: 45px; }
        .pw-toggle { position: absolute; right: 5px; top: 9px; width: 40px; height: 40px; background: none; border: none; cursor: pointer; }
        .captcha-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .captcha-display { flex: 1; background: #2d3748; color: #fff; letter-spacing: 5px; font-size: 1.5rem; text-align: center; padding: 10px; border-radius: 12px; font-weight: bold; text-decoration: line-through; }
        .captcha-btn { width: auto; padding: 10px 15px; background: #cbd5e0; }
        .history-section { margin-top: 15px; border-top: 1px dashed #cbd5e0; padding-top: 10px; }
        .log-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.85rem; border-left: 4px solid var(--d); }
        .stu-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; transition:0.2s; }
        .score-badge { background: var(--d); color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; }
        #alertSection { background: #fff5f5; border: 2px solid #fc8181; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; }
        #pendingSection { background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; }
        .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #bee3f8; }
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center; }
        .modal-body { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; max-height: 85vh; overflow-y: auto; }
        #serviceSection { display: none; background: #f0fff4; border: 1px solid #9ae6b4; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 10px; }
        .danger-btn { background: var(--d); }
        .warn-btn { background: var(--w); }
        .role-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #4a5568; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="authTabs" class="tabs">
        <div id="t-login" class="tab active" onclick="setTab('login')">ç™»å…¥</div>
        <div id="t-reg" class="tab" onclick="setTab('register')">è¨»å†Š</div>
    </div>
    
    <div class="content">
        <div id="loginView" class="view active">
            <input type="number" id="loginId" placeholder="åº§è™Ÿ">
            <div class="pw-box">
                <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('loginPw')">ğŸ‘ï¸</button>
            </div>
            <button onclick="doLogin()">é€²å…¥ç³»çµ±</button>
        </div>

        <div id="regView" class="view">
            <input type="number" id="regId" placeholder="åº§è™Ÿ">
            <input type="text" id="regName" placeholder="å§“å">
            <div class="pw-box"><input type="password" id="regPw" placeholder="å¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('regPw')">ğŸ‘ï¸</button></div>
            <div class="pw-box"><input type="password" id="regPw2" placeholder="ç¢ºèªå¯†ç¢¼"><button type="button" class="pw-toggle" onclick="togglePw('regPw2')">ğŸ‘ï¸</button></div>
            <div class="captcha-row">
                <div id="captchaDisplay" class="captcha-display"></div>
                <button type="button" class="captcha-btn" onclick="refreshCaptcha()">ğŸ”„</button>
            </div>
            <input type="text" id="captchaInput" placeholder="è¼¸å…¥é©—è­‰ç¢¼">
            <button onclick="doRegister()" style="background:var(--s)">é€å‡ºåŠ å…¥ç”³è«‹</button>
        </div>

        <div id="resetView" class="view" style="text-align: center;">
            <h2 style="color:var(--d)">âš ï¸ éœ€é‡è¨­å¯†ç¢¼</h2>
            <div class="pw-box"><input type="password" id="resetPw" placeholder="æ–°å¯†ç¢¼"></div>
            <button onclick="doForcePasswordChange()">æ›´æ–°å¯†ç¢¼ä¸¦ç™»å…¥</button>
        </div>

        <div id="dashboardView" class="view">
            <div id="alertSection">
                <h3 style="margin:0 0 10px 0; color:#c53030;">ğŸš¨ éœ€æ„›ç­æœå‹™åå–®</h3>
                <div id="alertList"></div>
            </div>
            <div id="pendingSection">
                <h3 style="margin:0 0 10px 0; color:#2b6cb0;">â³ åŠ å…¥ç”³è«‹åˆ—è¡¨</h3>
                <div id="pendingList"></div>
            </div>
            <div id="stuWarning" style="background:#fff5f5; border:1px solid #feb2b2; color:#c53030; padding:15px; border-radius:15px; margin-bottom:15px; text-align:center; display:none;">âš ï¸ è­¦å‘Šï¼š<span id="warnText"></span></div>
            <div style="background: linear-gradient(135deg, #4361ee, #4cc9f0); color:white; padding:25px; border-radius:20px; text-align:center;">
                <h2 id="welcomeTitle"></h2>
                <div id="myJob" style="font-size:1.8rem; font-weight:900; margin:10px 0;"></div>
                <div id="myScore" style="font-size:1.1rem;">ç›®å‰é»æ•¸ï¼š0</div>
            </div>
            <div class="history-section"><h3>ğŸ“… è¨˜é»æ­·ç¨‹</h3><div id="myLogs"></div></div>
            <div id="adminSection" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                    <h3>ğŸš€ ç®¡ç†é¢æ¿</h3>
                    <button id="settingBtn" onclick="editThreshold()" style="width:auto; font-size:0.8rem; background:#718096;">âš™ï¸ è¨­å®š</button>
                </div>
                <div id="stuGrid"></div>
            </div>
            <button onclick="location.reload()" style="background:#718096; margin-top:20px;">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <h3 id="targetName"></h3>
        <div id="modalScore" style="text-align:center; font-size:3rem; color:var(--d); font-weight:900; margin:10px 0;">0</div>
        <div id="serviceSection">
            <p style="color:#2f855a; font-weight:bold;">ğŸ‰ å·²é”æ„›ç­æ¨™æº–</p>
            <button onclick="doService()" style="background:#48bb78;">ğŸ§¹ æ‰¹å‡†æ„›ç­æœå‹™ (éŠ·é»)</button>
        </div>
        <button onclick="addPoint()" style="background:var(--d); font-size:1.2rem; padding:15px;">â• è¨˜é» (+1)</button>
        <hr>
        <div id="roleAssignSection" style="background:#fffbe6; padding:10px; border-radius:10px; display:none;">
            <select id="rolePicker">
                <option value="student">ä¸€èˆ¬å­¸ç”Ÿ</option>
                <option value="inner_manager">å…§è¡›ç”Ÿ</option>
                <option value="outer_manager">å¤–è¡›ç”Ÿ</option>
            </select>
        </div>
        <select id="jobPicker"></select>
        <input type="text" id="newJob" placeholder="æ–°å·¥ä½œå…§å®¹">
        <input type="text" id="warnInput" placeholder="è­¦å‘Šè¨Šæ¯">
        <button onclick="confirmAssign()">å„²å­˜æ›´æ–°</button>
        <div class="history-section"><h4>ğŸ” è©³ç´°æ­·ç¨‹</h4><div id="modalLogs"></div></div>
        <div id="superAdminControls" style="display:none;">
            <button onclick="resetToDefaultPw()" class="warn-btn">â†º é‚„åŸé è¨­å¯†ç¢¼</button>
            <button onclick="deleteStudent()" class="danger-btn">ğŸ—‘ï¸ å¾¹åº•åˆªé™¤å¸³è™Ÿèˆ‡ç´€éŒ„</button>
        </div>
        <button onclick="closeModal()" style="background:#eee; color:#333; margin-top:10px;">é—œé–‰</button>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null, selectedId = null, unsubS = null, unsubL = null;
    let tempResetId = null, currentCaptcha = "", alertThreshold = 3;

    function setTab(m) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(m==='login') document.getElementById('t-login').classList.add('active');
        if(m==='register') { document.getElementById('t-reg').classList.add('active'); refreshCaptcha(); }
        document.getElementById('loginView').className = 'view '+(m==='login'?'active':'');
        document.getElementById('regView').className = 'view '+(m==='register'?'active':'');
    }
    
    function togglePw(fid) { const x=document.getElementById(fid); x.type=(x.type==="password")?"text":"password"; }

    function refreshCaptcha() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let res = ""; for(let i=0;i<4;i++) res+=chars.charAt(Math.floor(Math.random()*chars.length));
        currentCaptcha = res;
        document.getElementById('captchaDisplay').innerText = res;
        document.getElementById('captchaInput').value = "";
    }

    // æ ¼å¼åŒ– ID (1 -> 01, 100 -> 100)
    function formatId(raw) {
        let s = raw.toString();
        return s.length === 1 ? "0" + s : s;
    }

    async function doLogin() {
        const id = formatId(document.getElementById('loginId').value);
        const pw = document.getElementById('loginPw').value;
        if(!id || !pw) return;

        try {
            const doc = await db.collection("students").doc(id).get();
            if(doc.exists && doc.data().password === pw) {
                const data = doc.data();
                if(data.status === 'pending') return alert("â³ å¸³è™Ÿå¯©æ ¸ä¸­ï¼Œè«‹ç­‰å€™æ‰¹å‡†ã€‚");
                
                if (data.forceReset) {
                    tempResetId = id;
                    document.getElementById('authTabs').style.display = 'none';
                    document.getElementById('loginView').classList.remove('active');
                    document.getElementById('resetView').classList.add('active');
                    return;
                }
                me = { id, ...data };
                document.getElementById('authTabs').style.display = 'none';
                document.getElementById('loginView').classList.remove('active');
                document.getElementById('dashboardView').classList.add('active');
                await loadConfig();
                startApp();
            } else alert("ç™»å…¥å¤±æ•—");
        } catch(e) { alert("éŒ¯èª¤: " + e.message); }
    }

    async function doRegister() {
        const id = formatId(document.getElementById('regId').value);
        const p1=document.getElementById('regPw').value, name=document.getElementById('regName').value;
        const uC=document.getElementById('captchaInput').value.toUpperCase();

        if(!id || !name || !p1) return alert("è³‡è¨Šä¸å®Œæ•´");
        if(uC!==currentCaptcha) return alert("é©—è­‰ç¢¼éŒ¯èª¤");

        const check = await db.collection("students").doc(id).get();
        if(check.exists) return alert("æ­¤åº§è™Ÿå·²è¨»å†Š");

        // å¼·åˆ¶å¯«å…¥æ‰€æœ‰é è¨­å€¼ï¼Œç¢ºä¿è¦†è“‹èˆŠè³‡æ–™
        await db.collection("students").doc(id).set({ 
            name, password: p1, role: "student", 
            duty_zone: "æœªåˆ†é…", score: 0, warning: "",
            forceReset: false, status: "pending" 
        });
        alert("ç”³è«‹æˆåŠŸï¼Œè«‹ç­‰å€™æ‰¹å‡†");
        setTab('login');
    }

    async function loadConfig() {
        const doc = await db.collection("settings").doc("config").get();
        if(doc.exists) alertThreshold = doc.data().threshold || 3;
    }

    function startApp() {
        db.collection("students").doc(me.id).onSnapshot(doc => {
            if(!doc.exists) return;
            const d = doc.data();
            document.getElementById('welcomeTitle').innerText = `${doc.id} ${d.name}`;
            document.getElementById('myJob').innerText = d.duty_zone;
            document.getElementById('myScore').innerText = d.score;
            document.getElementById('stuWarning').style.display = d.warning ? 'block' : 'none';
            document.getElementById('warnText').innerText = d.warning;
        });

        db.collection("point_logs").where("studentId", "==", me.id).onSnapshot(snap => {
            const box = document.getElementById('myLogs'); box.innerHTML = "";
            let list = []; snap.forEach(l => list.push(l.data()));
            list.sort((a,b) => b.time - a.time).forEach(l => {
                const color = l.type==='service'?'#48bb78':'#ef233c';
                const text = l.type==='service'?`å®Œæˆæ„›ç­ (-${l.points})` : '+1';
                box.innerHTML += `<div class="log-item" style="border-left-color:${color}"><span>${new Date(l.time).toLocaleString()}</span><b>${text}</b></div>`;
            });
        });

        if(me.role !== 'student') {
            document.getElementById('adminSection').style.display = 'block';
            db.collection("students").onSnapshot(snap => {
                const active = [], pending = [], alerts = [];
                snap.forEach(doc => {
                    const d = { id: doc.id, ...doc.data() };
                    if(d.status==='pending') pending.push(d);
                    else {
                        active.push(d);
                        if(d.score >= alertThreshold) alerts.push(d);
                    }
                });
                active.sort((a,b) => parseInt(a.id) - parseInt(b.id));

                const grid = document.getElementById('stuGrid'); grid.innerHTML = "";
                active.forEach(s => {
                    grid.innerHTML += `<div class="stu-card" style="${s.score>=alertThreshold?'border:2px solid var(--d)':''}" onclick="openModal('${s.id}', '${s.name}')">
                        <b>${s.id} ${s.name}</b><div><span class="score-badge">${s.score}</span></div></div>`;
                });

                document.getElementById('alertSection').style.display = alerts.length?'block':'none';
                document.getElementById('alertList').innerHTML = alerts.map(s => `<div style="color:red">âš ï¸ ${s.id} ${s.name} (${s.score}é»)</div>`).join('');

                const canAudit = (me.role==='admin'||me.role==='teacher');
                document.getElementById('pendingSection').style.display = (canAudit && pending.length)?'block':'none';
                document.getElementById('pendingList').innerHTML = pending.map(s => `
                    <div class="pending-item"><span>${s.id} ${s.name}</span><button onclick="approveStudent('${s.id}')" style="width:auto">âœ… æ‰¹å‡†</button></div>`).join('');
            });
            refreshJobs();
        }
    }

    window.approveStudent = async (sid) => {
        if(confirm(`æ‰¹å‡† ${sid} å…¥ç­ï¼Ÿ`)) await db.collection("students").doc(sid).update({ status: 'active' });
    }

    // æ ¸å¿ƒä¿®å¾©ï¼šå¾¹åº•åˆªé™¤å­¸ç”Ÿèˆ‡æ‰€æœ‰æ­·ç¨‹
    window.deleteStudent = async function() {
        const confirmId = prompt(`âš ï¸ æ³¨æ„ï¼šæ­¤å‹•ä½œæœƒã€Œå®Œå…¨æ·¨ç©ºã€è©²åº§è™Ÿæ‰€æœ‰ç´€éŒ„ã€‚\nè«‹è¼¸å…¥åº§è™Ÿ ${selectedId} ç¢ºèªï¼š`);
        if(confirmId !== selectedId) return;

        try {
            // 1. åˆªé™¤æ‰€æœ‰ç›¸é—œçš„é»æ•¸/æ„›ç­ç´€éŒ„
            const logs = await db.collection("point_logs").where("studentId", "==", selectedId).get();
            const batch = db.batch();
            logs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            // 2. åˆªé™¤å­¸ç”Ÿæ–‡ä»¶
            await db.collection("students").doc(selectedId).delete();
            
            alert("è©²åº§è™Ÿè³‡æ–™èˆ‡æ­·ç¨‹å·²å®Œå…¨æ·¨ç©ºã€‚");
            closeModal();
        } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
    }

    window.openModal = async function(id, name) {
        selectedId = id;
        document.getElementById('targetName').innerText = `${id} ${name}`;
        const isSuper = (me.role==='teacher'||me.role==='admin');
        document.getElementById('superAdminControls').style.display = isSuper?'block':'none';
        document.getElementById('roleAssignSection').style.display = isSuper?'block':'none';

        if(unsubS) unsubS();
        unsubS = db.collection("students").doc(id).onSnapshot(doc => {
            if(!doc.exists) return;
            const sc = doc.data().score;
            document.getElementById('modalScore').innerText = sc;
            document.getElementById('serviceSection').style.display = (isSuper && sc>=alertThreshold)?'block':'none';
        });

        if(unsubL) unsubL();
        unsubL = db.collection("point_logs").where("studentId", "==", id).onSnapshot(snap => {
            const box = document.getElementById('modalLogs'); box.innerHTML = "";
            let list = []; snap.forEach(l => list.push({lid: l.id, ...l.data()}));
            list.sort((a,b) => b.time - a.time).forEach(l => {
                box.innerHTML += `<div class="log-item"><span>${new Date(l.time).toLocaleString()}</span>${l.type==='service'?'<b>æœå‹™</b>':`<button class="del-btn" onclick="deleteLog('${l.lid}')">ğŸ—‘ï¸</button>`}</div>`;
            });
        });
        document.getElementById('modal').style.display = 'flex';
    }

    window.doService = async () => {
        if(!confirm(`ç¢ºèªæ‰£æŠµ ${alertThreshold} é»ï¼Ÿ`)) return;
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(-alertThreshold) });
        await db.collection("point_logs").add({ studentId: selectedId, time: Date.now(), type: 'service', points: alertThreshold });
    }

    window.addPoint = async () => {
        await db.collection("point_logs").add({ studentId: selectedId, time: Date.now(), type: 'normal' });
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(1) });
    }

    window.deleteLog = async (lid) => {
        if(confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
            await db.collection("point_logs").doc(lid).delete();
            await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(-1) });
        }
    }

    window.confirmAssign = async () => {
        const manual = document.getElementById('newJob').value.trim();
        const job = manual || document.getElementById('jobPicker').value;
        const update = { duty_zone: job || "æœªåˆ†é…", warning: document.getElementById('warnInput').value };
        if(me.role==='admin'||me.role==='teacher') update.role = document.getElementById('rolePicker').value;
        await db.collection("students").doc(selectedId).update(update);
        if(manual) await db.collection("duty_options").doc(manual).set({active:true});
        closeModal();
    }

    window.closeModal = () => { document.getElementById('modal').style.display='none'; if(unsubS) unsubS(); if(unsubL) unsubL(); }
    
    async function refreshJobs() {
        const s = await db.collection("duty_options").get();
        const opts = []; s.forEach(d => opts.push(d.id));
        document.getElementById('jobPicker').innerHTML = '<option value="">-- é¸æ“‡å·¥ä½œ --</option>' + opts.sort().map(o => `<option value="${o}">${o}</option>`).join('');
    }
</script>
</body>
</html>
