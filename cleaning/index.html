<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šé›²ç«¯å‹¤å‹™ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; padding-top: 20px; }
        .container { width: 92%; max-width: 450px; background: var(--card); border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); overflow: hidden; height: fit-content; margin-bottom: 40px; }
        
        /* é ç±¤ */
        .tabs { display: flex; background: #edf2f7; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; color: #718096; transition: 0.3s; }
        .tab.active { background: white; color: var(--p); border-top: 4px solid var(--p); }

        .content { padding: 30px; }
        .view { display: none; }
        .view.active { display: block; }

        /* è¡¨å–®æ¨£å¼ */
        h2 { margin-top: 0; color: #2d3748; font-size: 1.4rem; }
        input, select, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--p); }
        button { background: var(--p); color: white; border: none; font-weight: 800; cursor: pointer; margin-top: 15px; transition: 0.2s; }
        button:active { transform: scale(0.98); }

        /* é©—è­‰ç¢¼ */
        .captcha-row { display: flex; gap: 10px; align-items: center; }
        #captchaCanvas { background: #f7fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0; }

        /* å­¸ç”Ÿ Dashboard */
        .welcome-text { font-size: 0.9rem; color: #718096; margin-bottom: 5px; }
        .user-name { font-size: 1.2rem; font-weight: bold; color: #2d3748; margin-bottom: 20px; }
        
        .main-card { background: linear-gradient(135deg, #4361ee, #4cc9f0); color: white; padding: 35px 20px; border-radius: 25px; text-align: center; box-shadow: 0 12px 24px rgba(67, 97, 238, 0.25); margin-bottom: 25px; }
        .main-card h3 { margin: 0; font-size: 1rem; opacity: 0.85; letter-spacing: 1px; }
        .main-card .duty-name { font-size: 2.2rem; font-weight: 900; margin: 15px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .nav-box { background: #fff; border: 1px solid #edf2f7; padding: 18px; border-radius: 18px; text-align: center; font-size: 0.9rem; font-weight: bold; color: #4a5568; transition: 0.2s; }
        .nav-box:active { background: #f7fafc; }
        .nav-box span { display: block; font-size: 24px; margin-bottom: 8px; }

        /* ç®¡ç†å“¡ä»‹é¢å€ (ç°¡æ˜“ç¤ºä¾‹) */
        .manager-panel { border-top: 2px dashed #e2e8f0; margin-top: 25px; padding-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="authTabs" class="tabs">
        <div id="loginTab" class="tab active" onclick="switchTab('login')">ç™»å…¥</div>
        <div id="regTab" class="tab" onclick="switchTab('register')">è¨»å†Š</div>
    </div>

    <div class="content">
        <div id="loginView" class="view active">
            <h2>æ­¡è¿å›ä¾†</h2>
            <input type="number" id="loginId" placeholder="è¼¸å…¥åº§è™Ÿ (ä¾‹: 01)">
            <input type="password" id="loginPw" placeholder="è¼¸å…¥å¯†ç¢¼">
            <div class="captcha-row">
                <input type="text" id="loginCaptcha" placeholder="é©—è­‰ç¢¼">
                <canvas id="captchaCanvas" width="100" height="48" onclick="drawCaptcha()"></canvas>
            </div>
            <button onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
        </div>

        <div id="regView" class="view">
            <h2>æ–°æˆå“¡è¨»å†Š</h2>
            <input type="number" id="regId" placeholder="è¼¸å…¥åº§è™Ÿ (ä¾‹: 01)">
            <input type="text" id="regName" placeholder="çœŸå¯¦å§“å">
            <input type="password" id="regPw" placeholder="è‡ªè¨‚å¯†ç¢¼">
            <select id="regRole" onchange="toggleKey()">
                <option value="student">æˆ‘æ˜¯å­¸ç”Ÿ</option>
                <option value="inner_manager">æˆ‘æ˜¯å…§è¡›ç”Ÿ</option>
                <option value="outer_manager">æˆ‘æ˜¯å¤–è¡›ç”Ÿ</option>
                <option value="teacher">æˆ‘æ˜¯å°å¸«</option>
                <option value="admin">æˆ‘æ˜¯ç®¡ç†å“¡</option>
            </select>
            <input type="password" id="mKey" placeholder="è¼¸å…¥ç®¡ç†é‡‘é‘°" style="display:none">
            <button onclick="handleRegister()" style="background: var(--s);">ç¢ºèªè¨»å†Š</button>
        </div>

        <div id="dashboardView" class="view">
            <div class="welcome-text">SHINMIN CLASS 305</div>
            <div id="userInfo" class="user-name">è¼‰å…¥ä¸­...</div>
            
            <div class="main-card">
                <h3>ğŸ“ ç›®å‰æƒåœ°å·¥ä½œ</h3>
                <div id="myDutyName" class="duty-name">æœªåˆ†é…</div>
                <div style="background:rgba(255,255,255,0.2); display:inline-block; padding:5px 15px; border-radius:20px; font-size:13px;">
                    ç‹€æ…‹ï¼š<span id="myStatus">é€²è¡Œä¸­</span>
                </div>
            </div>

            <div class="nav-grid">
                <div class="nav-box"><span>ğŸ“Š</span>æ­·å²è¨˜é»</div>
                <div class="nav-box"><span>ğŸ“œ</span>æ­·å²å·¥ä½œ</div>
                <div class="nav-box"><span>ğŸ‘¥</span>å…¨ç­åå–®</div>
                <div class="nav-box" onclick="location.reload()" style="color:var(--d)"><span>ğŸ”’</span>å®‰å…¨ç™»å‡º</div>
            </div>

            <div id="managerAccess" style="display:none" class="manager-panel">
                <button onclick="alert('é€²å…¥ç®¡ç†å¾Œå°...')" style="background:#2d3748">âš™ï¸ è¡›ç”Ÿç®¡ç†å¾Œå°</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase é…ç½® (è«‹ä¿æŒæ‚¨åŸæœ¬çš„è¨­å®š)
    const firebaseConfig = {
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentCaptcha = "";

    // åˆ‡æ› Tab
    function switchTab(mode) {
        document.getElementById('loginTab').classList.toggle('active', mode === 'login');
        document.getElementById('regTab').classList.toggle('active', mode === 'register');
        document.getElementById('loginView').classList.toggle('active', mode === 'login');
        document.getElementById('regView').classList.toggle('active', mode === 'register');
        if(mode === 'login') drawCaptcha();
    }

    // ç¹ªè£½é©—è­‰ç¢¼
    function drawCaptcha() {
        const canvas = document.getElementById('captchaCanvas');
        const ctx = canvas.getContext('2d');
        const chars = '23456789ABCDEFGHJKLMNPQRSTUVWXYZ';
        currentCaptcha = "";
        ctx.clearRect(0,0,100,48);
        ctx.font = 'bold 22px Arial';
        ctx.fillStyle = '#4361ee';
        for(let i=0; i<4; i++) {
            let c = chars.charAt(Math.floor(Math.random()*chars.length));
            currentCaptcha += c;
            ctx.fillText(c, 15 + i*20, 32);
        }
    }

    // é¡¯ç¤ºç®¡ç†é‡‘é‘°æ¬„ä½
    function toggleKey() {
        const role = document.getElementById('regRole').value;
        document.getElementById('mKey').style.display = (role === 'student') ? 'none' : 'block';
    }

    // è¨»å†Šé‚è¼¯
    async function handleRegister() {
        const id = document.getElementById('regId').value.padStart(2, '0');
        const name = document.getElementById('regName').value;
        const pw = document.getElementById('regPw').value;
        const role = document.getElementById('regRole').value;
        const key = document.getElementById('mKey').value;

        if(!id || !name || !pw) { alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½"); return; }
        if(role !== 'student' && key !== 'Admin888') { alert("é‡‘é‘°éŒ¯èª¤"); return; }

        const docRef = db.collection("students").doc(id);
        const doc = await docRef.get();
        if(doc.exists) { alert("æ­¤åº§è™Ÿå·²è¨»å†Šéï¼"); return; }

        await docRef.set({ name, password: pw, role, duty_zone: "æœªåˆ†é…", missing_count: 0 });
        alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼");
        switchTab('login');
    }

    // ç™»å…¥é‚è¼¯
    async function handleLogin() {
        const id = document.getElementById('loginId').value.padStart(2, '0');
        const pw = document.getElementById('loginPw').value;
        const cap = document.getElementById('loginCaptcha').value.toUpperCase();

        if(cap !== currentCaptcha) { alert("é©—è­‰ç¢¼éŒ¯èª¤"); drawCaptcha(); return; }

        const doc = await db.collection("students").doc(id).get();
        if(doc.exists && doc.data().password === pw) {
            const data = doc.data();
            renderDashboard(id, data);
        } else {
            alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
        }
    }

    // æ¸²æŸ“å„€è¡¨æ¿
    function renderDashboard(id, data) {
        document.getElementById('authTabs').style.display = 'none';
        document.getElementById('loginView').classList.remove('active');
        document.getElementById('dashboardView').classList.add('active');
        
        document.getElementById('userInfo').innerText = `${id} ${data.name}`;
        document.getElementById('myDutyName').innerText = data.duty_zone || "å°šæœªåˆ†é…";
        
        // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºç®¡ç†å…¥å£
        if(data.role !== 'student') {
            document.getElementById('managerAccess').style.display = 'block';
        }
    }

    window.onload = drawCaptcha;
</script>
</body>
</html>
