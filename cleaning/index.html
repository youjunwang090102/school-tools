<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ± v5.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 550px; background: white; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #edf2f7; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; color: #718096; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab.active { background: white; color: var(--p); border-bottom: 3px solid var(--p); }
        .content { padding: 20px; }
        .view { display: none; }
        .view.active { display: block; }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* è¨˜é»æ­·å²æ¨£å¼ */
        .history-section { margin-top: 20px; border-top: 1px dashed #cbd5e0; padding-top: 15px; }
        .log-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.85rem; border-left: 4px solid var(--d); }
        .del-log { color: var(--d); cursor: pointer; font-weight: bold; padding: 5px; }

        .admin-dashboard { background: #f8faff; border: 2px solid #e0e7ff; border-radius: 20px; padding: 15px; margin-top: 20px; }
        .stu-card { background: white; border: 1px solid #dee2e6; padding: 15px; border-radius: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .score-badge { background: var(--d); color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; }
        .warning-box { background: #fff5f5; border: 1px solid #feb2b2; color: #c53030; padding: 15px; border-radius: 15px; margin-bottom: 15px; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center; }
        .modal-body { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; max-height: 85vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color:var(--p); margin: 20px 0;">ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ±</h1>
    <div id="authTabs" class="tabs">
        <div id="t-login" class="tab active" onclick="setTab('login')">ç™»å…¥</div>
        <div id="t-reg" class="tab" onclick="setTab('register')">è¨»å†Š</div>
    </div>
    <div class="content">
        <div id="loginView" class="view active">
            <input type="number" id="loginId" placeholder="åº§è™Ÿ">
            <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
            <button onclick="doLogin()">é€²å…¥ç³»çµ±</button>
        </div>
        <div id="regView" class="view">
            <input type="number" id="regId" placeholder="åº§è™Ÿ"><input type="text" id="regName" placeholder="å§“å"><input type="password" id="regPw" placeholder="å¯†ç¢¼">
            <select id="regRole" onchange="checkKey()"><option value="student">å­¸ç”Ÿ</option><option value="inner_manager">å…§è¡›ç”Ÿ</option><option value="outer_manager">å¤–è¡›ç”Ÿ</option><option value="teacher">å°å¸«</option><option value="admin">ç®¡ç†å“¡</option></select>
            <input type="password" id="mKey" placeholder="ç®¡ç†æˆæ¬Šç¢¼" style="display:none"><button onclick="doRegister()" style="background:var(--s)">å»ºç«‹å¸³è™Ÿ</button>
        </div>

        <div id="dashboardView" class="view">
            <div id="stuWarning" class="warning-box" style="display:none;">âš ï¸ è­¦å‘Šï¼š<span id="warnText"></span></div>
            <div style="background: linear-gradient(135deg, #4361ee, #4cc9f0); color:white; padding:25px; border-radius:20px; text-align:center;">
                <h2 id="welcomeTitle" style="margin:0;"></h2>
                <div id="myJob" style="font-size:1.8rem; font-weight:900; margin:10px 0;"></div>
                <div id="myScore" style="font-size:1.1rem;">é»æ•¸ï¼š0</div>
            </div>
            
            <div id="historyView" class="history-section">
                <h3>ğŸ“… è¨˜é»æ­·ç¨‹</h3>
                <div id="myLogs"></div>
            </div>

            <div id="adminSection" style="display:none;">
                <div class="admin-dashboard"><h3>ğŸš€ ç®¡ç†é¢æ¿</h3><div id="stuGrid"></div></div>
            </div>
            <button onclick="location.reload()" style="background:#718096; margin-top:20px;">ç™»å‡º</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <h3 id="targetName" style="margin:0;"></h3>
        <div style="text-align:center; font-size:2.5rem; color:var(--d); font-weight:900;" id="modalScore">0</div>
        <button onclick="addPoint(1)" style="background:var(--d)">â• è¨˜é» (+1)</button>
        <hr>
        <select id="jobPicker"></select>
        <input type="text" id="newJob" placeholder="æ‰‹å‹•å·¥ä½œ">
        <input type="text" id="warnInput" placeholder="è­¦å‘Šè¨Šæ¯å…§å®¹">
        <button onclick="confirmAssign()" style="background:var(--p)">å„²å­˜å·¥ä½œèˆ‡è­¦å‘Š</button>
        
        <div id="adminLogsArea" class="history-section">
            <h4 style="margin:0 0 10px 0;">ğŸ” è©²ç”Ÿè©³ç´°é»æ•¸ç´€éŒ„</h4>
            <div id="modalLogs"></div>
        </div>

        <div id="advancedAdmin" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <button onclick="triggerReset()" style="background:#f39c12">é‡ç½®å¯†ç¢¼ (åº§è™Ÿx3)</button>
            <button onclick="deleteStudent()" style="background:#000; margin-top:5px;">åˆªé™¤å­¸ç”Ÿ</button>
        </div>
        <button onclick="closeModal()" style="background:#eee; color:#333; margin-top:10px;">é—œé–‰</button>
    </div>
</div>

<script>
    const firebaseConfig = { /* è€å¸«è«‹æ”¾å…¥åŸæœ¬çš„ Config */
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null, selectedId = null, modalUnsub = null;

    function setTab(m) {
        document.getElementById('loginView').style.display = (m==='login'?'block':'none');
        document.getElementById('regView').style.display = (m==='register'?'block':'none');
        document.getElementById('t-login').classList.toggle('active', m==='login');
        document.getElementById('t-reg').classList.toggle('active', m==='register');
    }

    function checkKey() { document.getElementById('mKey').style.display = (document.getElementById('regRole').value==='student'?'none':'block'); }

    async function doRegister() {
        const id = document.getElementById('regId').value.padStart(2,'0');
        const role = document.getElementById('regRole').value;
        if(role!=='student' && document.getElementById('mKey').value!=='Admin888') return alert("æˆæ¬Šç¢¼éŒ¯èª¤");
        await db.collection("students").doc(id).set({ name: document.getElementById('regName').value, password: document.getElementById('regPw').value, role, duty_zone: "æœªåˆ†é…", score: 0, warning: "" });
        alert("è¨»å†ŠæˆåŠŸ"); setTab('login');
    }

    async function doLogin() {
        const id = document.getElementById('loginId').value.padStart(2,'0');
        const doc = await db.collection("students").doc(id).get();
        if(doc.exists && doc.data().password === document.getElementById('loginPw').value) {
            me = { id, ...doc.data() };
            startSync();
        } else alert("éŒ¯èª¤");
    }

    function startSync() {
        document.getElementById('authTabs').style.display = 'none';
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('dashboardView').classList.add('active');

        // å­¸ç”Ÿç›£è½è‡ªå·±çš„ç‹€æ…‹èˆ‡æ­·å²
        db.collection("students").doc(me.id).onSnapshot(doc => {
            const d = doc.data();
            document.getElementById('welcomeTitle').innerText = `${doc.id} ${d.name}`;
            document.getElementById('myJob').innerText = d.duty_zone || "æœªåˆ†é…";
            document.getElementById('myScore').innerText = `ç›®å‰é»æ•¸ï¼š${d.score || 0}`;
            document.getElementById('stuWarning').style.display = d.warning ? 'block' : 'none';
            document.getElementById('warnText').innerText = d.warning || "";
        });

        db.collection("point_logs").where("studentId", "==", me.id).orderBy("time", "desc").onSnapshot(snap => {
            const box = document.getElementById('myLogs'); box.innerHTML = "";
            snap.forEach(l => {
                const date = new Date(l.data().time).toLocaleString();
                box.innerHTML += `<div class="log-item"><span>${date}</span><span>è¨˜é» +1</span></div>`;
            });
        });

        // ç®¡ç†å“¡æ¸…å–®
        if(['teacher','inner_manager','outer_manager','admin'].includes(me.role)) {
            document.getElementById('adminSection').style.display = 'block';
            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
                const grid = document.getElementById('stuGrid'); grid.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    grid.innerHTML += `<div class="stu-card" onclick="openModal('${doc.id}', '${d.name}')">
                        <b>${doc.id} ${d.name}</b><div>${d.duty_zone} <span class="score-badge">${d.score}</span></div></div>`;
                });
            });
            refreshJobs();
        }
    }

    window.openModal = function(id, name) {
        selectedId = id; document.getElementById('targetName').innerText = `${id} ${name}`;
        document.getElementById('advancedAdmin').style.display = (['teacher','admin'].includes(me.role)) ? 'block' : 'none';
        
        if(modalUnsub) modalUnsub();
        // å½ˆçª—å…§éƒ¨çš„å³æ™‚é»æ•¸èˆ‡ç´€éŒ„
        modalUnsub = db.collection("students").doc(id).onSnapshot(doc => {
            document.getElementById('modalScore').innerText = doc.data().score || 0;
            document.getElementById('warnInput').value = doc.data().warning || "";
        });

        db.collection("point_logs").where("studentId", "==", id).orderBy("time", "desc").onSnapshot(snap => {
            const box = document.getElementById('modalLogs'); box.innerHTML = "";
            snap.forEach(l => {
                const date = new Date(l.data().time).toLocaleString();
                box.innerHTML += `<div class="log-item"><span>${date}</span><span class="del-log" onclick="deleteLog('${l.id}')">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„ä¸¦æ‰£åˆ†</span></div>`;
            });
        });
        document.getElementById('modal').style.display = 'flex';
    }

    // ğŸ† æ–°å¢è¨˜é»ç´€éŒ„
    window.addPoint = async function(val) {
        const time = Date.now();
        await db.collection("point_logs").add({ studentId: selectedId, time: time, val: val });
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(val) });
    }

    // ğŸ† æŒ‰ç…§æ—¥æœŸåˆªé™¤é»æ•¸
    window.deleteLog = async function(logId) {
        if(!confirm("ç¢ºå®šè¦ç§»é™¤é€™ç­†è¨˜é»ç´€éŒ„å—ï¼Ÿå­¸ç”Ÿçš„é»æ•¸ä¹Ÿå°‡æ¸›å°‘ 1 é»ã€‚")) return;
        await db.collection("point_logs").doc(logId).delete();
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(-1) });
    }

    window.confirmAssign = async function() {
        const j = document.getElementById('newJob').value || document.getElementById('jobPicker').value;
        const w = document.getElementById('warnInput').value;
        await db.collection("students").doc(selectedId).update({ duty_zone: j || "æœªåˆ†é…", warning: w });
        if(document.getElementById('newJob').value) await db.collection("duty_options").doc(j).set({active:true});
        alert("å„²å­˜æˆåŠŸ");
    }

    window.closeModal = function() { document.getElementById('modal').style.display = 'none'; if(modalUnsub) modalUnsub(); }
    window.triggerReset = async function() {
        const p = selectedId+selectedId+selectedId;
        await db.collection("students").doc(selectedId).update({ password: p, needsReset: true });
        alert("å·²é‡è¨­ç‚º "+p);
    }
    window.deleteStudent = async function() { if(confirm("åˆªé™¤å¸³è™Ÿï¼Ÿ")) await db.collection("students").doc(selectedId).delete(); closeModal(); }
    async function refreshJobs() {
        const p = document.getElementById('jobPicker'); p.innerHTML='<option value="">é¸æ“‡å·¥ä½œ</option>';
        const s = await db.collection("duty_options").get();
        s.forEach(d => p.innerHTML+=`<option value="${d.id}">${d.id}</option>`);
    }
</script>
</body>
</html>
