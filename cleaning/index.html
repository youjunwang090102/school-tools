<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ± v3.0 (Pro)</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --w: #f6ad55; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 550px; background: white; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #edf2f7; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; color: #718096; border-bottom: 3px solid transparent; }
        .tab.active { background: white; color: var(--p); border-bottom: 3px solid var(--p); }
        .content { padding: 20px; }
        .view { display: none; }
        .view.active { display: block; }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        
        /* å¯†ç¢¼é¡¯ç¤ºåˆ‡æ›å®¹å™¨ */
        .pw-box { position: relative; width: 100%; }
        .pw-box input { padding-right: 45px; width: 100%; }
        .pw-toggle { position: absolute; right: 5px; top: 9px; width: 40px; height: 40px; background: none; border: none; color: #718096; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        .history-section { margin-top: 15px; border-top: 1px dashed #cbd5e0; padding-top: 10px; }
        .log-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.85rem; border-left: 4px solid var(--d); }
        .del-btn { color: white; background: var(--d); border: none; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; width: auto; margin: 0; }
        .stu-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .score-badge { background: var(--d); color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; }
        
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center; }
        .modal-body { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; max-height: 85vh; overflow-y: auto; }
        
        /* ç®¡ç†å“¡ç‰¹æ®ŠæŒ‰éˆ•å€åŸŸ */
        #superAdminControls { display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #edf2f7; }
        .danger-btn { background: var(--d); margin-bottom: 5px; }
        .warn-btn { background: var(--w); color: white; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="authTabs" class="tabs">
        <div id="t-login" class="tab active" onclick="setTab('login')">ç™»å…¥</div>
        <div id="t-reg" class="tab" onclick="setTab('register')">è¨»å†Š</div>
    </div>
    
    <div class="content">
        <div id="loginView" class="view active">
            <input type="number" id="loginId" placeholder="åº§è™Ÿ">
            <div class="pw-box">
                <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('loginPw')">ğŸ‘ï¸</button>
            </div>
            <button onclick="doLogin()">é€²å…¥ç³»çµ±</button>
        </div>

        <div id="resetView" class="view" style="text-align: center;">
            <h2 style="color:var(--d)">âš ï¸ éœ€é‡è¨­å¯†ç¢¼</h2>
            <p style="color:#718096; font-size:0.9rem;">ç³»çµ±åµæ¸¬åˆ°æ‚¨ä½¿ç”¨é è¨­å¯†ç¢¼ï¼Œè«‹è¨­å®šæ–°å¯†ç¢¼ã€‚</p>
            <div class="pw-box">
                <input type="password" id="resetPw" placeholder="æ–°å¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('resetPw')">ğŸ‘ï¸</button>
            </div>
            <div class="pw-box">
                <input type="password" id="resetPw2" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('resetPw2')">ğŸ‘ï¸</button>
            </div>
            <button onclick="doForcePasswordChange()">ç¢ºèªä¿®æ”¹ä¸¦ç™»å…¥</button>
        </div>

        <div id="regView" class="view">
            <input type="number" id="regId" placeholder="åº§è™Ÿ">
            <input type="text" id="regName" placeholder="å§“å">
            
            <div class="pw-box">
                <input type="password" id="regPw" placeholder="è¨­å®šå¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('regPw')">ğŸ‘ï¸</button>
            </div>
            <div class="pw-box">
                <input type="password" id="regPw2" placeholder="ç¢ºèªå¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('regPw2')">ğŸ‘ï¸</button>
            </div>

            <select id="regRole" onchange="checkKey()">
                <option value="student">å­¸ç”Ÿ</option>
                <option value="inner_manager">å…§è¡›ç”Ÿ</option>
                <option value="outer_manager">å¤–è¡›ç”Ÿ</option>
                <option value="teacher">å°å¸«</option>
                <option value="admin">ç®¡ç†å“¡</option>
            </select>
            <input type="password" id="mKey" placeholder="ç®¡ç†é‡‘é‘°" style="display:none">
            <button onclick="doRegister()" style="background:var(--s)">å»ºç«‹å¸³è™Ÿ</button>
        </div>

        <div id="dashboardView" class="view">
            <div id="stuWarning" style="background:#fff5f5; border:1px solid #feb2b2; color:#c53030; padding:15px; border-radius:15px; margin-bottom:15px; text-align:center; display:none;">âš ï¸ è­¦å‘Šï¼š<span id="warnText"></span></div>
            <div style="background: linear-gradient(135deg, #4361ee, #4cc9f0); color:white; padding:25px; border-radius:20px; text-align:center;">
                <h2 id="welcomeTitle"></h2>
                <div id="myJob" style="font-size:1.8rem; font-weight:900; margin:10px 0;"></div>
                <div id="myScore" style="font-size:1.1rem;">ç›®å‰é»æ•¸ï¼š0</div>
            </div>
            <div class="history-section"><h3>ğŸ“… è¨˜é»æ­·ç¨‹</h3><div id="myLogs"></div></div>
            <div id="adminSection" style="display:none;"><h3>ğŸš€ ç®¡ç†é¢æ¿</h3><div id="stuGrid"></div></div>
            <button onclick="location.reload()" style="background:#718096; margin-top:20px;">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <h3 id="targetName" style="margin:0;"></h3>
        <div id="modalScore" style="text-align:center; font-size:3rem; color:var(--d); font-weight:900; margin:10px 0;">0</div>
        <button onclick="addPoint()" style="background:var(--d); font-size:1.2rem; padding:15px;">â• è¨˜é» (+1)</button>
        <hr>
        <select id="jobPicker"></select>
        <input type="text" id="newJob" placeholder="æ‰‹å‹•è¼¸å…¥æ–°å·¥ä½œ (æœƒè‡ªå‹•å„²å­˜)">
        <input type="text" id="warnInput" placeholder="çµ¦å­¸ç”Ÿçš„è©±">
        <button onclick="confirmAssign()" style="background:var(--p)">å„²å­˜æ›´æ–°ä¸¦é—œé–‰</button>
        
        <div class="history-section"><h4>ğŸ” è©³ç´°æ­·ç¨‹</h4><div id="modalLogs"></div></div>
        
        <div id="superAdminControls">
            <button onclick="resetToDefaultPw()" class="warn-btn">â†º é‚„åŸé è¨­å¯†ç¢¼</button>
            <button onclick="deleteStudent()" class="danger-btn">ğŸ—‘ï¸ åˆªé™¤å­¸ç”Ÿå¸³è™Ÿ</button>
        </div>

        <button onclick="closeModal()" style="background:#eee; color:#333; margin-top:10px;">å–æ¶ˆè¿”å›</button>
    </div>
</div>

<script>
    // 1. Firebase åˆå§‹åŒ–
    const firebaseConfig = { 
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null, selectedId = null, unsubS = null, unsubL = null;
    let tempResetId = null; // ç”¨æ–¼å¼·åˆ¶é‡è¨­å¯†ç¢¼æ™‚æš«å­˜ID

    // 2. ä»‹é¢åˆ‡æ›èˆ‡å·¥å…·å‡½å¼
    function setTab(m) {
        document.getElementById('loginView').className = 'view '+(m==='login'?'active':'');
        document.getElementById('regView').className = 'view '+(m==='register'?'active':'');
        document.getElementById('resetView').classList.remove('active'); // ç¢ºä¿åˆ‡æ›æ™‚é—œé–‰é‡è¨­é é¢
    }
    
    function checkKey() { document.getElementById('mKey').style.display = (document.getElementById('regRole').value==='student'?'none':'block'); }

    // æ–°å¢ï¼šåˆ‡æ›å¯†ç¢¼é¡¯ç¤º/éš±è—
    function togglePw(fid) {
        const x = document.getElementById(fid);
        x.type = (x.type === "password") ? "text" : "password";
    }

    // 3. ç™»å…¥é‚è¼¯ (å«å¼·åˆ¶é‡è¨­æª¢æŸ¥)
    async function doLogin() {
        const id = document.getElementById('loginId').value.padStart(2,'0');
        const pw = document.getElementById('loginPw').value;
        
        try {
            const doc = await db.collection("students").doc(id).get();
            if(doc.exists && doc.data().password === pw) {
                const data = doc.data();
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦å¼·åˆ¶é‡è¨­å¯†ç¢¼
                if (data.forceReset === true) {
                    tempResetId = id;
                    document.getElementById('authTabs').style.display = 'none';
                    document.getElementById('loginView').classList.remove('active');
                    document.getElementById('resetView').classList.add('active');
                    return;
                }

                // æ­£å¸¸ç™»å…¥
                me = { id, ...data };
                document.getElementById('authTabs').style.display = 'none';
                document.getElementById('loginView').classList.remove('active');
                document.getElementById('dashboardView').classList.add('active');
                startApp();
            } else {
                alert("ç™»å…¥å¤±æ•—ï¼šåº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
            }
        } catch(e) {
            alert("ç³»çµ±éŒ¯èª¤ï¼š" + e.message);
        }
    }

    // æ–°å¢ï¼šè™•ç†å¼·åˆ¶é‡è¨­å¯†ç¢¼æäº¤
    async function doForcePasswordChange() {
        const p1 = document.getElementById('resetPw').value;
        const p2 = document.getElementById('resetPw2').value;

        if (!p1) { alert("è«‹è¼¸å…¥å¯†ç¢¼"); return; }
        if (p1 !== p2) { alert("å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´ï¼"); return; }

        await db.collection("students").doc(tempResetId).update({
            password: p1,
            forceReset: false // è§£é™¤å¼·åˆ¶é‡è¨­æ¨™è¨˜
        });

        alert("å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
        location.reload();
    }

    // 4. è¨»å†Šé‚è¼¯ (å«é›™é‡é©—è­‰)
    async function doRegister() {
        const id = document.getElementById('regId').value.padStart(2,'0');
        const p1 = document.getElementById('regPw').value;
        const p2 = document.getElementById('regPw2').value;
        const role = document.getElementById('regRole').value;
        const name = document.getElementById('regName').value;

        if(!id || !name || !p1) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }
        // æ–°å¢ï¼šæª¢æŸ¥å¯†ç¢¼ä¸€è‡´æ€§
        if (p1 !== p2) { alert("å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ï¼"); return; }

        await db.collection("students").doc(id).set({ 
            name: name, 
            password: p1, 
            role: role, 
            duty_zone: "æœªåˆ†é…", 
            score: 0, 
            warning: "",
            forceReset: false 
        });
        alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥");
        setTab('login');
    }

    // 5. ä¸»ç¨‹å¼é‚è¼¯
    function startApp() {
        // ç›£è½è‡ªå·±çš„è³‡æ–™
        db.collection("students").doc(me.id).onSnapshot(doc => {
            if(!doc.exists) { location.reload(); return; } // è‹¥è¢«åˆªé™¤å‰‡ç™»å‡º
            const d = doc.data();
            document.getElementById('welcomeTitle').innerText = `${doc.id} ${d.name}`;
            document.getElementById('myJob').innerText = d.duty_zone || "æœªåˆ†é…";
            document.getElementById('myScore').innerText = d.score || 0;
            document.getElementById('stuWarning').style.display = d.warning ? 'block' : 'none';
            document.getElementById('warnText').innerText = d.warning || "";
        });

        // ç›£è½é»æ•¸æ­·å²
        db.collection("point_logs").where("studentId", "==", me.id).onSnapshot(snap => {
            const box = document.getElementById('myLogs'); box.innerHTML = "";
            let list = []; snap.forEach(l => list.push(l.data()));
            list.sort((a,b) => b.time - a.time).forEach(l => {
                box.innerHTML += `<div class="log-item"><span>${new Date(l.time).toLocaleString()}</span><b>+1</b></div>`;
            });
        });

        // ç®¡ç†å“¡/è¡›ç”Ÿè‚¡é•·/å°å¸« è¦–è§’
        if(me.role !== 'student') {
            document.getElementById('adminSection').style.display = 'block';
            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
                const grid = document.getElementById('stuGrid'); grid.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    grid.innerHTML += `<div class="stu-card" onclick="openModal('${doc.id}', '${d.name}')"><b>${doc.id} ${d.name}</b><div>${d.duty_zone} <span class="score-badge">${d.score || 0}</span></div></div>`;
                });
            });
            refreshJobs();
        }
    }

    // 6. Modal æ“ä½œ
    window.openModal = async function(id, name) {
        selectedId = id; 
        document.getElementById('targetName').innerText = `${id} ${name}`;
        
        // åˆ¤æ–·æ¬Šé™ï¼šåªæœ‰ teacher å’Œ admin å¯ä»¥çœ‹åˆ°åˆªé™¤èˆ‡é‡è¨­å¯†ç¢¼æŒ‰éˆ•
        const isSuperAdmin = (me.role === 'teacher' || me.role === 'admin');
        document.getElementById('superAdminControls').style.display = isSuperAdmin ? 'block' : 'none';

        const docSnap = await db.collection("students").doc(id).get();
        const d = docSnap.data();
        
        // é–‹å•Ÿæ™‚å…ˆåˆ·ä¸€éæ¸…å–®
        await refreshJobs();
        document.getElementById('jobPicker').value = d.duty_zone || "";
        document.getElementById('newJob').value = ""; // æ¸…ç©ºæ‰‹å‹•æ¬„ä½
        document.getElementById('warnInput').value = d.warning || "";

        if(unsubS) unsubS();
        unsubS = db.collection("students").doc(id).onSnapshot(doc => {
            if(doc.exists) document.getElementById('modalScore').innerText = doc.data().score || 0;
        });

        if(unsubL) unsubL();
        unsubL = db.collection("point_logs").where("studentId", "==", id).onSnapshot(snap => {
            const box = document.getElementById('modalLogs'); box.innerHTML = "";
            let list = []; snap.forEach(l => list.push({lid: l.id, ...l.data()}));
            list.sort((a,b) => b.time - a.time).forEach(l => {
                box.innerHTML += `<div class="log-item"><span>${new Date(l.time).toLocaleString()}</span><button class="del-btn" onclick="deleteLog('${l.lid}')">ğŸ—‘ï¸ åˆªé™¤</button></div>`;
            });
        });
        document.getElementById('modal').style.display = 'flex';
    }

    // æ–°å¢ï¼šé‚„åŸé è¨­å¯†ç¢¼åŠŸèƒ½
    window.resetToDefaultPw = async function() {
        if(!confirm(`ç¢ºå®šè¦é‚„åŸ ${selectedId} è™Ÿçš„å¯†ç¢¼å—ï¼Ÿ\né è¨­å¯†ç¢¼è¦å‰‡ï¼šåº§è™Ÿé‡è¤‡ä¸‰æ¬¡ (ä¾‹: 050505)`)) return;
        
        const defPw = selectedId.repeat(3); 
        
        await db.collection("students").doc(selectedId).update({
            password: defPw,
            forceReset: true 
        });
        alert(`å·²é‚„åŸå¯†ç¢¼ç‚ºï¼š${defPw}\nå­¸ç”Ÿä¸‹æ¬¡ç™»å…¥æ™‚å°‡è¢«è¦æ±‚ä¿®æ”¹å¯†ç¢¼ã€‚`);
        closeModal();
    }

    // æ–°å¢ï¼šåˆªé™¤å­¸ç”ŸåŠŸèƒ½
    window.deleteStudent = async function() {
        const confirmName = prompt(`âš ï¸ å±éšªæ“ä½œï¼\nç¢ºå®šè¦åˆªé™¤åº§è™Ÿ ${selectedId} çš„è³‡æ–™å—ï¼Ÿ\nè«‹è¼¸å…¥å­¸ç”Ÿçš„ã€Œåº§è™Ÿã€ä»¥ç¢ºèªåˆªé™¤ï¼š`);
        if(confirmName !== selectedId) {
            alert("è¼¸å…¥éŒ¯èª¤ï¼Œå–æ¶ˆåˆªé™¤ã€‚");
            return;
        }

        await db.collection("students").doc(selectedId).delete();
        alert("å­¸ç”Ÿè³‡æ–™å·²åˆªé™¤");
        closeModal();
    }

    window.addPoint = async function() {
        const ts = Date.now();
        try {
            await db.collection("point_logs").add({ studentId: selectedId, time: ts });
            await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(1) });
        } catch (e) {
            alert("è¨˜é»å¤±æ•—ï¼è«‹æª¢æŸ¥æ¬Šé™ã€‚");
        }
    }

    window.deleteLog = async function(lid) {
        if(!confirm("ç¢ºå®šç§»é™¤é€™ç­†ç´€éŒ„ä¸¦æ‰£é™¤ 1 é»ï¼Ÿ")) return;
        await db.collection("point_logs").doc(lid).delete();
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(-1) });
    }

    // ä¿®æ”¹ï¼šç¢ºèªåˆ†é…åŠŸèƒ½ (å¼·åŒ–è¨˜æ†¶å·¥ä½œé¸å–®é‚è¼¯)
    window.confirmAssign = async function() {
        const manualJob = document.getElementById('newJob').value.trim();
        const selectedJob = document.getElementById('jobPicker').value;
        const w = document.getElementById('warnInput').value;
        
        // å„ªå…ˆé †åºï¼šæ‰‹å‹•è¼¸å…¥ > é¸å–®é¸æ“‡ > é è¨­
        const finalJob = manualJob || selectedJob || "æœªåˆ†é…";

        try {
            // 1. æ›´æ–°å­¸ç”Ÿå€‹äººè³‡æ–™
            await db.collection("students").doc(selectedId).update({ 
                duty_zone: finalJob, 
                warning: w 
            });

            // 2. å¦‚æœæ˜¯æ‰‹å‹•è¼¸å…¥çš„æ–°å·¥ä½œï¼ŒåŒæ­¥å¯«å…¥è³‡æ–™åº«é¸å–®ä¾›ä¸‹æ¬¡ä½¿ç”¨
            if(manualJob) {
                await db.collection("duty_options").doc(manualJob).set({ active: true });
                await refreshJobs(); // ç«‹å³æ›´æ–°æœ¬åœ°é¸å–®
            }

            closeModal();
        } catch (e) {
            alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ–æ¬Šé™ã€‚");
        }
    }

    window.closeModal = function() { document.getElementById('modal').style.display = 'none'; if(unsubS) unsubS(); if(unsubL) unsubL(); }

    // ä¿®æ”¹ï¼šåˆ·æ–°å·¥ä½œæ¸…å–® (åŠ å…¥å­—æ¯æ’åº)
    async function refreshJobs() {
        const p = document.getElementById('jobPicker');
        const oldVal = p.value;
        try {
            const s = await db.collection("duty_options").get();
            let options = [];
            s.forEach(doc => options.push(doc.id));
            options.sort(); // æ’åºè®“ä»‹é¢æ›´æ•´é½Š

            p.innerHTML = '<option value="">-- é¸æ“‡å·²å­˜å·¥ä½œ --</option>';
            options.forEach(opt => {
                p.innerHTML += `<option value="${opt}">${opt}</option>`;
            });
            if(oldVal) p.value = oldVal;
        } catch(e) {
            console.log("åˆå§‹åŒ–å·¥ä½œæ¸…å–®ä¸­...");
        }
    }
</script>
</body>
</html>
