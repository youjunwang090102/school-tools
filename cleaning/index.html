<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ± v4.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 550px; background: white; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #edf2f7; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; color: #718096; border-top: 4px solid transparent; }
        .tab.active { background: white; color: var(--p); border-top: 4px solid var(--p); }
        .content { padding: 20px; }
        .view { display: none; }
        .view.active { display: block; }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        .captcha-row { display: flex; gap: 10px; align-items: center; }
        canvas { background: #f7fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0; }
        
        /* ç®¡ç†é¢æ¿ */
        .admin-dashboard { background: #f8faff; border: 2px solid #e0e7ff; border-radius: 20px; padding: 15px; margin-top: 20px; }
        .stu-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
        .stu-card { background: white; border: 1px solid #dee2e6; padding: 15px; border-radius: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .stu-card b { color: #2d3748; flex: 1; }
        .stu-info { text-align: right; flex: 2; font-size: 0.9rem; }
        .score-badge { background: var(--d); color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; margin-left: 5px; }

        .main-card { background: linear-gradient(135deg, #4361ee, #4cc9f0); color: white; padding: 30px; border-radius: 25px; text-align: center; margin-bottom: 20px; }
        .warning-box { background: #fff5f5; border: 1px solid #feb2b2; color: #c53030; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 0.9rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center; }
        .modal-body { background:white; padding:25px; border-radius:20px; width:85%; max-width:380px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color:var(--p); margin: 20px 0 10px 0;">ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ±</h1>
    
    <div id="authTabs" class="tabs">
        <div id="t-login" class="tab active" onclick="setTab('login')">ç™»å…¥</div>
        <div id="t-reg" class="tab" onclick="setTab('register')">è¨»å†Š</div>
    </div>

    <div class="content">
        <div id="loginView" class="view active">
            <input type="number" id="loginId" placeholder="åº§è™Ÿ">
            <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
            <div id="captchaArea" class="captcha-row">
                <input type="text" id="loginCaptcha" placeholder="é©—è­‰ç¢¼">
                <canvas id="captchaCanvas" width="100" height="48" onclick="drawCaptcha()"></canvas>
            </div>
            <button onclick="doLogin()">é€²å…¥ç³»çµ±</button>
        </div>

        <div id="regView" class="view">
            <input type="number" id="regId" placeholder="åº§è™Ÿ">
            <input type="text" id="regName" placeholder="çœŸå¯¦å§“å">
            <input type="password" id="regPw" placeholder="è¨­å®šå¯†ç¢¼">
            <select id="regRole" onchange="checkKey()">
                <option value="student">ä¸€èˆ¬å­¸ç”Ÿ</option>
                <option value="inner_manager">å…§è¡›ç”Ÿ</option>
                <option value="outer_manager">å¤–è¡›ç”Ÿ</option>
                <option value="teacher">å°å¸«</option>
                <option value="admin">ç®¡ç†å“¡</option>
            </select>
            <input type="password" id="mKey" placeholder="ç®¡ç†æˆæ¬Šç¢¼" style="display:none">
            <button onclick="doRegister()" style="background:var(--s)">å»ºç«‹å¸³è™Ÿ</button>
        </div>

        <div id="dashboardView" class="view">
            <div id="welcomeTitle" style="font-weight:bold; margin-bottom:10px;"></div>
            <div id="studentWarning" class="warning-box" style="display:none;">âš ï¸ é‡è¦è­¦å‘Šï¼š<span id="warnText"></span></div>
            
            <div class="main-card">
                <div style="font-size:0.9rem; opacity:0.8;">ç›®å‰å·¥ä½œ</div>
                <div id="myJob" style="font-size:2rem; font-weight:900; margin:10px 0;">è®€å–ä¸­...</div>
                <div id="myScore" style="font-size:0.9rem;">æˆ‘çš„é»æ•¸ï¼š0</div>
            </div>

            <div id="adminSection" style="display:none;">
                <div class="admin-dashboard">
                    <h3 style="margin:0; color:var(--p); display:flex; justify-content:space-between;">ğŸš€ å³æ™‚å‹¤å‹™åå–® <span>é»æ•¸</span></h3>
                    <div id="stuGrid" class="stu-grid"></div>
                </div>
            </div>
            <button onclick="location.reload()" style="background:#718096; margin-top:20px;">ç™»å‡ºç³»çµ±</button>
        </div>

        <div id="resetPwView" class="view">
            <h2>ğŸ”’ å®‰å…¨é‡è¨­å¯†ç¢¼</h2>
            <p style="color:red">ç®¡ç†å“¡å·²é‡è¨­æ‚¨çš„å¸³è™Ÿï¼Œè«‹è¨­å®šæ–°å¯†ç¢¼å¾Œç™»å…¥ã€‚</p>
            <input type="password" id="newResetPw" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
            <button onclick="confirmResetPw()">å„²å­˜ä¸¦ç™»å…¥</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <h3 id="targetName" style="margin-top:0;"></h3>
        <select id="jobPicker"></select>
        <input type="text" id="newJob" placeholder="æ‰‹å‹•è¼¸å…¥å·¥ä½œ">
        <hr>
        <div style="display:flex; gap:5px;">
            <button onclick="changeScore(1)" style="background:var(--d)">+1 è¨˜é»</button>
            <button onclick="changeScore(-1)" style="background:#718096">-1 åˆªé™¤</button>
        </div>
        <input type="text" id="warnInput" placeholder="ç™¼é€è­¦å‘Šè¨Šæ¯...">
        <button onclick="confirmAssign()" style="background:var(--p)">å„²å­˜æ›´æ–°</button>
        
        <div id="advancedAdmin" style="display:none; border-top:1px solid #eee; margin-top:10px; padding-top:10px;">
            <button onclick="triggerReset()" style="background:#f39c12">å¼·åˆ¶è©²ç”Ÿé‡è¨­å¯†ç¢¼</button>
            <button onclick="deleteStudent()" style="background:#000; margin-top:5px;">åˆªé™¤å­¸ç”Ÿå¸³è™Ÿ</button>
        </div>
        <button onclick="closeModal()" style="background:#eee; color:#333; margin-top:10px;">é—œé–‰</button>
    </div>
</div>

<script>
    const firebaseConfig = { /* è€å¸«è«‹ä¿ç•™åŸæœ¬çš„ Config */
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null, selectedId = null, capText = "";
    let unsubUser = null, unsubGrid = null;

    function setTab(m) {
        document.getElementById('loginView').className = 'view ' + (m==='login'?'active':'');
        document.getElementById('regView').className = 'view ' + (m==='register'?'active':'');
        document.getElementById('t-login').className = 'tab ' + (m==='login'?'active':'');
        document.getElementById('t-reg').className = 'tab ' + (m==='register'?'active':'');
        if(m==='login') drawCaptcha();
    }

    function drawCaptcha() {
        const canvas = document.getElementById('captchaCanvas');
        const ctx = canvas.getContext('2d');
        const chars = '23456789ABCDEFGHJKLMNPQRSTUVWXYZ';
        capText = ""; ctx.clearRect(0,0,100,48); ctx.font = 'bold 22px Arial'; ctx.fillStyle = '#4361ee';
        for(let i=0; i<4; i++) {
            let c = chars.charAt(Math.floor(Math.random()*chars.length));
            capText += c; ctx.fillText(c, 15 + i*20, 32);
        }
    }

    function checkKey() { document.getElementById('mKey').style.display = (document.getElementById('regRole').value === 'student' ? 'none' : 'block'); }

    async function doRegister() {
        const id = document.getElementById('regId').value.padStart(2,'0');
        const name = document.getElementById('regName').value, pw = document.getElementById('regPw').value, role = document.getElementById('regRole').value;
        if(role !== 'student' && document.getElementById('mKey').value !== 'Admin888') { alert("é‡‘é‘°éŒ¯"); return; }
        await db.collection("students").doc(id).set({ name, password: pw, role, duty_zone: "æœªåˆ†é…", score: 0, warning: "", needsReset: false });
        alert("è¨»å†ŠæˆåŠŸ"); setTab('login');
    }

    async function doLogin() {
        const id = document.getElementById('loginId').value.padStart(2,'0');
        const pw = document.getElementById('loginPw').value;
        const cap = document.getElementById('loginCaptcha').value.toUpperCase();
        if(cap !== capText) { alert("é©—è­‰ç¢¼éŒ¯èª¤"); drawCaptcha(); return; }
        
        const doc = await db.collection("students").doc(id).get();
        if(doc.exists && doc.data().password === pw) {
            me = { id, ...doc.data() };
            if(me.needsReset) {
                document.getElementById('loginView').classList.remove('active');
                document.getElementById('resetPwView').classList.add('active');
            } else {
                startRealtimeSync();
            }
        } else { alert("åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
    }

    // æ ¸å¿ƒï¼šå³æ™‚åŒæ­¥åŠŸèƒ½
    function startRealtimeSync() {
        document.getElementById('authTabs').style.display = 'none';
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('dashboardView').className = 'view active';
        
        // 1. ç›£è½ã€Œè‡ªå·±ã€çš„è³‡æ–™è®Šå‹•
        unsubUser = db.collection("students").doc(me.id).onSnapshot(doc => {
            const data = doc.data();
            document.getElementById('welcomeTitle').innerText = `${doc.id} ${data.name} (${data.role})`;
            document.getElementById('myJob').innerText = data.duty_zone || "æœªåˆ†é…";
            document.getElementById('myScore').innerText = `æˆ‘çš„é»æ•¸ï¼š${data.score || 0}`;
            if(data.warning) {
                document.getElementById('studentWarning').style.display = 'block';
                document.getElementById('warnText').innerText = data.warning;
            } else {
                document.getElementById('studentWarning').style.display = 'none';
            }
        });

        // 2. å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œç›£è½ã€Œå…¨ç­ã€è³‡æ–™è®Šå‹•
        if(['teacher','inner_manager','outer_manager','admin'].includes(me.role)) {
            document.getElementById('adminSection').style.display = 'block';
            refreshJobs();
            unsubGrid = db.collection("students").orderBy(firebase.firestore.FieldPath.documentId())
                .onSnapshot(snap => {
                    const grid = document.getElementById('stuGrid');
                    grid.innerHTML = "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        grid.innerHTML += `
                            <div class="stu-card" onclick="openModal('${doc.id}', '${d.name}')">
                                <b>${doc.id} ${d.name}</b>
                                <div class="stu-info">
                                    <span style="color:#718096">${d.duty_zone || 'å¾…åˆ†é…'}</span>
                                    <span class="score-badge">${d.score || 0}</span>
                                </div>
                            </div>`;
                    });
                });
        }
    }

    async function confirmResetPw() {
        const newPw = document.getElementById('newResetPw').value;
        if(newPw.length < 3) { alert("æ–°å¯†ç¢¼å¤ªçŸ­"); return; }
        await db.collection("students").doc(me.id).update({ password: newPw, needsReset: false });
        alert("å¯†ç¢¼é‡è¨­æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
        location.reload();
    }

    window.openModal = function(id, name) {
        selectedId = id;
        document.getElementById('targetName').innerText = `${id} ${name} ç®¡ç†`;
        document.getElementById('advancedAdmin').style.display = (['teacher','admin'].includes(me.role)) ? 'block' : 'none';
        document.getElementById('modal').style.display = 'flex';
    }

    window.triggerReset = async function() {
        if(!confirm("ç¢ºå®šè¦å¼·åˆ¶æ­¤å­¸ç”Ÿä¸‹æ¬¡ç™»å…¥æ™‚é‡è¨­å¯†ç¢¼å—ï¼Ÿ")) return;
        await db.collection("students").doc(selectedId).update({ needsReset: true });
        alert("å·²é€å‡ºé‡è¨­å¯†ç¢¼è¦æ±‚ã€‚");
        closeModal();
    }

    // å¸¸ç”¨å‡½æ•¸ç¶­æŒ
    window.closeModal = function() { document.getElementById('modal').style.display = 'none'; }
    window.changeScore = async function(val) { await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(val) }); }
    window.deleteStudent = async function() {
        if(!confirm(`ç¢ºå®šè¦å¾¹åº•åˆªé™¤ ${selectedId} è™Ÿå­¸ç”Ÿå—ï¼Ÿ`)) return;
        await db.collection("students").doc(selectedId).delete();
        closeModal();
    }
    window.confirmAssign = async function() {
        const j1 = document.getElementById('jobPicker').value, j2 = document.getElementById('newJob').value.trim();
        const final = j2 || j1, warn = document.getElementById('warnInput').value;
        const upData = {};
        if(final) upData.duty_zone = final;
        upData.warning = warn;
        if(j2) await db.collection("duty_options").doc(j2).set({ active: true });
        await db.collection("students").doc(selectedId).update(upData);
        closeModal();
    }
    async function refreshJobs() {
        const picker = document.getElementById('jobPicker');
        picker.innerHTML = '<option value="">-- é¸æ“‡å·²æœ‰å·¥ä½œ --</option>';
        const snap = await db.collection("duty_options").get();
        snap.forEach(doc => { picker.innerHTML += `<option value="${doc.id}">${doc.id}</option>`; });
    }

    window.onload = drawCaptcha;
</script>
</body>
</html>
