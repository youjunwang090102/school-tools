<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹¤å‹™ç®¡ç†ç³»çµ± v3.1 (Secured)</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --w: #f6ad55; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 550px; background: white; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Tab å‹•ç•«ä¿®æ­£ */
        .tabs { display: flex; background: #edf2f7; position: relative; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; color: #718096; transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab.active { background: white; color: var(--p); border-bottom: 3px solid var(--p); }
        
        .content { padding: 20px; }
        .view { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .view.active { display: block; opacity: 1; }
        
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        
        /* å¯†ç¢¼é¡¯ç¤ºèˆ‡é©—è­‰ç¢¼å®¹å™¨ */
        .pw-box { position: relative; width: 100%; }
        .pw-box input { padding-right: 45px; width: 100%; }
        .pw-toggle { position: absolute; right: 5px; top: 9px; width: 40px; height: 40px; background: none; border: none; color: #718096; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        /* é©—è­‰ç¢¼æ¨£å¼ */
        .captcha-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .captcha-display { flex: 1; background: #2d3748; color: #fff; letter-spacing: 5px; font-family: monospace; font-size: 1.5rem; text-align: center; padding: 10px; border-radius: 12px; font-weight: bold; user-select: none; text-decoration: line-through; }
        .captcha-btn { width: auto; padding: 10px 15px; background: #cbd5e0; color: #4a5568; font-size: 1.2rem; }

        .history-section { margin-top: 15px; border-top: 1px dashed #cbd5e0; padding-top: 10px; }
        .log-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.85rem; border-left: 4px solid var(--d); }
        .del-btn { color: white; background: var(--d); border: none; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; width: auto; margin: 0; }
        .stu-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .score-badge { background: var(--d); color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; }
        
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center; }
        .modal-body { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; max-height: 85vh; overflow-y: auto; }
        
        /* ç®¡ç†å“¡ç‰¹æ®ŠæŒ‰éˆ•å€åŸŸ */
        #superAdminControls { display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #edf2f7; }
        #roleAssignSection { display: none; background: #fffbe6; padding: 10px; border-radius: 10px; border: 1px solid #ffe58f; margin-bottom: 10px; }
        .danger-btn { background: var(--d); margin-bottom: 5px; }
        .warn-btn { background: var(--w); color: white; margin-bottom: 5px; }
        .role-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #4a5568; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="authTabs" class="tabs">
        <div id="t-login" class="tab active" onclick="setTab('login')">ç™»å…¥</div>
        <div id="t-reg" class="tab" onclick="setTab('register')">è¨»å†Š</div>
    </div>
    
    <div class="content">
        <div id="loginView" class="view active">
            <input type="number" id="loginId" placeholder="åº§è™Ÿ (ä¾‹å¦‚: 01)">
            <div class="pw-box">
                <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('loginPw')">ğŸ‘ï¸</button>
            </div>
            <button onclick="doLogin()">é€²å…¥ç³»çµ±</button>
        </div>

        <div id="resetView" class="view" style="text-align: center;">
            <h2 style="color:var(--d)">âš ï¸ éœ€é‡è¨­å¯†ç¢¼</h2>
            <p style="color:#718096; font-size:0.9rem;">ç³»çµ±åµæ¸¬åˆ°æ‚¨ä½¿ç”¨é è¨­å¯†ç¢¼ï¼Œè«‹è¨­å®šæ–°å¯†ç¢¼ã€‚</p>
            <div class="pw-box">
                <input type="password" id="resetPw" placeholder="æ–°å¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('resetPw')">ğŸ‘ï¸</button>
            </div>
            <div class="pw-box">
                <input type="password" id="resetPw2" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('resetPw2')">ğŸ‘ï¸</button>
            </div>
            <button onclick="doForcePasswordChange()">ç¢ºèªä¿®æ”¹ä¸¦ç™»å…¥</button>
        </div>

        <div id="regView" class="view">
            <input type="number" id="regId" placeholder="åº§è™Ÿ (è«‹å¡«å¯«çœŸå¯¦åº§è™Ÿ)">
            <input type="text" id="regName" placeholder="å§“å (è«‹å¡«å¯«çœŸå¯¦å§“å)">
            
            <div class="pw-box">
                <input type="password" id="regPw" placeholder="è¨­å®šå¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('regPw')">ğŸ‘ï¸</button>
            </div>
            <div class="pw-box">
                <input type="password" id="regPw2" placeholder="ç¢ºèªå¯†ç¢¼">
                <button type="button" class="pw-toggle" onclick="togglePw('regPw2')">ğŸ‘ï¸</button>
            </div>

            <div class="captcha-row">
                <div id="captchaDisplay" class="captcha-display">ABCD</div>
                <button type="button" class="captcha-btn" onclick="refreshCaptcha()">ğŸ”„</button>
            </div>
            <input type="text" id="captchaInput" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹ 4 ç¢¼é©—è­‰ç¢¼">

            <button onclick="doRegister()" style="background:var(--s)">å»ºç«‹å­¸ç”Ÿå¸³è™Ÿ</button>
        </div>

        <div id="dashboardView" class="view">
            <div id="stuWarning" style="background:#fff5f5; border:1px solid #feb2b2; color:#c53030; padding:15px; border-radius:15px; margin-bottom:15px; text-align:center; display:none;">âš ï¸ è­¦å‘Šï¼š<span id="warnText"></span></div>
            <div style="background: linear-gradient(135deg, #4361ee, #4cc9f0); color:white; padding:25px; border-radius:20px; text-align:center;">
                <h2 id="welcomeTitle"></h2>
                <div id="myJob" style="font-size:1.8rem; font-weight:900; margin:10px 0;"></div>
                <div id="myScore" style="font-size:1.1rem;">ç›®å‰é»æ•¸ï¼š0</div>
            </div>
            <div class="history-section"><h3>ğŸ“… è¨˜é»æ­·ç¨‹</h3><div id="myLogs"></div></div>
            <div id="adminSection" style="display:none;"><h3>ğŸš€ ç®¡ç†é¢æ¿</h3><div id="stuGrid"></div></div>
            <button onclick="location.reload()" style="background:#718096; margin-top:20px;">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <h3 id="targetName" style="margin:0;"></h3>
        <div id="modalScore" style="text-align:center; font-size:3rem; color:var(--d); font-weight:900; margin:10px 0;">0</div>
        <button onclick="addPoint()" style="background:var(--d); font-size:1.2rem; padding:15px;">â• è¨˜é» (+1)</button>
        <hr>
        
        <div id="roleAssignSection">
            <label style="font-size:0.8rem; color:#888; font-weight:bold;">ğŸ‘‘ èº«ä»½æ¬Šé™è¨­å®š</label>
            <select id="rolePicker">
                <option value="student">ä¸€èˆ¬å­¸ç”Ÿ</option>
                <option value="inner_manager">å…§è¡›ç”Ÿ (ç®¡ç†)</option>
                <option value="outer_manager">å¤–è¡›ç”Ÿ (ç®¡ç†)</option>
                </select>
        </div>

        <select id="jobPicker"></select>
        <input type="text" id="newJob" placeholder="æ‰‹å‹•è¼¸å…¥æ–°å·¥ä½œ (æœƒè‡ªå‹•å„²å­˜)">
        <input type="text" id="warnInput" placeholder="çµ¦å­¸ç”Ÿçš„è©±">
        <button onclick="confirmAssign()" style="background:var(--p)">å„²å­˜æ›´æ–°ä¸¦é—œé–‰</button>
        
        <div class="history-section"><h4>ğŸ” è©³ç´°æ­·ç¨‹</h4><div id="modalLogs"></div></div>
        
        <div id="superAdminControls">
            <button onclick="resetToDefaultPw()" class="warn-btn">â†º é‚„åŸé è¨­å¯†ç¢¼</button>
            <button onclick="deleteStudent()" class="danger-btn">ğŸ—‘ï¸ åˆªé™¤å­¸ç”Ÿå¸³è™Ÿ</button>
        </div>

        <button onclick="closeModal()" style="background:#eee; color:#333; margin-top:10px;">å–æ¶ˆè¿”å›</button>
    </div>
</div>

<script>
    // 1. Firebase åˆå§‹åŒ–
    const firebaseConfig = { 
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null, selectedId = null, unsubS = null, unsubL = null;
    let tempResetId = null;
    let currentCaptcha = "";

    // 2. ä»‹é¢èˆ‡å·¥å…·
    function setTab(m) {
        // æ›´æ–°æ¨™ç±¤æ¨£å¼
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(m === 'login') document.getElementById('t-login').classList.add('active');
        if(m === 'register') {
            document.getElementById('t-reg').classList.add('active');
            refreshCaptcha(); // åˆ‡æ›åˆ°è¨»å†Šé æ™‚åˆ·æ–°é©—è­‰ç¢¼
        }

        // æ›´æ–°è¦–åœ–
        document.getElementById('loginView').className = 'view '+(m==='login'?'active':'');
        document.getElementById('regView').className = 'view '+(m==='register'?'active':'');
        document.getElementById('resetView').classList.remove('active');
    }
    
    function togglePw(fid) {
        const x = document.getElementById(fid);
        x.type = (x.type === "password") ? "text" : "password";
    }

    // æ–°å¢ï¼šç”¢ç”Ÿé©—è­‰ç¢¼
    function refreshCaptcha() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // æ’é™¤æ˜“æ··æ·†å­—å…ƒ I, 1, O, 0
        let result = "";
        for(let i=0; i<4; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        currentCaptcha = result;
        document.getElementById('captchaDisplay').innerText = result;
        document.getElementById('captchaInput').value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
    }

    // 3. ç™»å…¥é‚è¼¯
    async function doLogin() {
        const id = document.getElementById('loginId').value.padStart(2,'0');
        const pw = document.getElementById('loginPw').value;
        
        try {
            const doc = await db.collection("students").doc(id).get();
            if(doc.exists && doc.data().password === pw) {
                const data = doc.data();
                
                if (data.forceReset === true) {
                    tempResetId = id;
                    document.getElementById('authTabs').style.display = 'none';
                    document.getElementById('loginView').classList.remove('active');
                    document.getElementById('resetView').classList.add('active');
                    return;
                }

                me = { id, ...data };
                document.getElementById('authTabs').style.display = 'none';
                document.getElementById('loginView').classList.remove('active');
                document.getElementById('dashboardView').classList.add('active');
                startApp();
            } else {
                alert("ç™»å…¥å¤±æ•—ï¼šåº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
            }
        } catch(e) {
            alert("ç³»çµ±éŒ¯èª¤ï¼š" + e.message);
        }
    }

    async function doForcePasswordChange() {
        const p1 = document.getElementById('resetPw').value;
        const p2 = document.getElementById('resetPw2').value;
        if (!p1) return alert("è«‹è¼¸å…¥å¯†ç¢¼");
        if (p1 !== p2) return alert("å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´ï¼");

        await db.collection("students").doc(tempResetId).update({ password: p1, forceReset: false });
        alert("å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
        location.reload();
    }

    // 4. è¨»å†Šé‚è¼¯ (ä¿®æ”¹ï¼šå¼·åˆ¶ role ç‚º studentï¼ŒåŠ å…¥é©—è­‰ç¢¼æª¢æŸ¥)
    async function doRegister() {
        const id = document.getElementById('regId').value.padStart(2,'0');
        const p1 = document.getElementById('regPw').value;
        const p2 = document.getElementById('regPw2').value;
        const name = document.getElementById('regName').value;
        const userCaptcha = document.getElementById('captchaInput').value.toUpperCase();

        if(!id || !name || !p1) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
        if(p1 !== p2) return alert("å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´ï¼");
        if(userCaptcha !== currentCaptcha) {
            alert("é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
            refreshCaptcha();
            return;
        }

        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const check = await db.collection("students").doc(id).get();
        if(check.exists) {
            alert("æ­¤åº§è™Ÿå·²è¨»å†Šéï¼");
            return;
        }

        await db.collection("students").doc(id).set({ 
            name: name, 
            password: p1, 
            role: "student", // å¼·åˆ¶æŒ‡å®šç‚ºå­¸ç”Ÿ
            duty_zone: "æœªåˆ†é…", 
            score: 0, 
            warning: "",
            forceReset: false 
        });
        alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥");
        setTab('login');
    }

    // 5. ä¸»ç¨‹å¼
    function startApp() {
        db.collection("students").doc(me.id).onSnapshot(doc => {
            if(!doc.exists) { location.reload(); return; }
            const d = doc.data();
            
            // é¡¯ç¤ºèº«ä»½å¾½ç« 
            let roleText = "";
            if(d.role === "admin") roleText = " (ç®¡ç†å“¡)";
            else if(d.role === "teacher") roleText = " (å°å¸«)";
            else if(d.role === "inner_manager") roleText = " (å…§è¡›ç”Ÿ)";
            else if(d.role === "outer_manager") roleText = " (å¤–è¡›ç”Ÿ)";

            document.getElementById('welcomeTitle').innerText = `${doc.id} ${d.name}${roleText}`;
            document.getElementById('myJob').innerText = d.duty_zone || "æœªåˆ†é…";
            document.getElementById('myScore').innerText = d.score || 0;
            document.getElementById('stuWarning').style.display = d.warning ? 'block' : 'none';
            document.getElementById('warnText').innerText = d.warning || "";
        });

        db.collection("point_logs").where("studentId", "==", me.id).onSnapshot(snap => {
            const box = document.getElementById('myLogs'); box.innerHTML = "";
            let list = []; snap.forEach(l => list.push(l.data()));
            list.sort((a,b) => b.time - a.time).forEach(l => {
                box.innerHTML += `<div class="log-item"><span>${new Date(l.time).toLocaleString()}</span><b>+1</b></div>`;
            });
        });

        // æ¬Šé™æª¢æŸ¥ï¼šåªè¦ä¸æ˜¯æ™®é€šå­¸ç”Ÿï¼Œå°±æœ‰ç®¡ç†ä»‹é¢
        if(me.role !== 'student') {
            document.getElementById('adminSection').style.display = 'block';
            db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).onSnapshot(snap => {
                const grid = document.getElementById('stuGrid'); grid.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    let badge = "";
                    if(d.role === 'inner_manager') badge = '<span class="role-badge">å…§è¡›</span>';
                    if(d.role === 'outer_manager') badge = '<span class="role-badge">å¤–è¡›</span>';
                    
                    grid.innerHTML += `<div class="stu-card" onclick="openModal('${doc.id}', '${d.name}')"><b>${doc.id} ${d.name} ${badge}</b><div>${d.duty_zone} <span class="score-badge">${d.score || 0}</span></div></div>`;
                });
            });
            refreshJobs();
        }
    }

    // 6. Modal æ“ä½œ
    window.openModal = async function(id, name) {
        selectedId = id; 
        document.getElementById('targetName').innerText = `${id} ${name}`;
        
        // åˆ¤æ–·æŒ‰éˆ•é¡¯ç¤ºæ¬Šé™ (å°å¸«/ç®¡ç†å“¡)
        const isSuper = (me.role === 'teacher' || me.role === 'admin');
        document.getElementById('superAdminControls').style.display = isSuper ? 'block' : 'none';
        
        // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºèº«ä»½è¨­å®šå€å¡Š
        document.getElementById('roleAssignSection').style.display = isSuper ? 'block' : 'none';

        const docSnap = await db.collection("students").doc(id).get();
        const d = docSnap.data();
        
        await refreshJobs();
        document.getElementById('jobPicker').value = d.duty_zone || "";
        document.getElementById('newJob').value = "";
        document.getElementById('warnInput').value = d.warning || "";
        
        // è¨­å®šç›®å‰çš„ Role åˆ°ä¸‹æ‹‰é¸å–®
        if(d.role === 'student' || d.role === 'inner_manager' || d.role === 'outer_manager') {
             document.getElementById('rolePicker').value = d.role;
        } else {
             // è‹¥æ˜¯ admin/teacherï¼Œé¸å–®ä¿æŒé è¨­æˆ–é¡¯ç¤º studentï¼Œé¿å…èª¤æ”¹è‡ªå·±äºº
             document.getElementById('rolePicker').value = 'student'; 
        }

        if(unsubS) unsubS();
        unsubS = db.collection("students").doc(id).onSnapshot(doc => {
            if(doc.exists) document.getElementById('modalScore').innerText = doc.data().score || 0;
        });

        if(unsubL) unsubL();
        unsubL = db.collection("point_logs").where("studentId", "==", id).onSnapshot(snap => {
            const box = document.getElementById('modalLogs'); box.innerHTML = "";
            let list = []; snap.forEach(l => list.push({lid: l.id, ...l.data()}));
            list.sort((a,b) => b.time - a.time).forEach(l => {
                box.innerHTML += `<div class="log-item"><span>${new Date(l.time).toLocaleString()}</span><button class="del-btn" onclick="deleteLog('${l.lid}')">ğŸ—‘ï¸ åˆªé™¤</button></div>`;
            });
        });
        document.getElementById('modal').style.display = 'flex';
    }

    window.resetToDefaultPw = async function() {
        if(!confirm(`ç¢ºå®šè¦é‚„åŸ ${selectedId} è™Ÿçš„å¯†ç¢¼å—ï¼Ÿ`)) return;
        const defPw = selectedId.repeat(3); 
        await db.collection("students").doc(selectedId).update({ password: defPw, forceReset: true });
        alert(`å¯†ç¢¼å·²é‚„åŸç‚ºï¼š${defPw}`);
        closeModal();
    }

    window.deleteStudent = async function() {
        const confirmName = prompt(`âš ï¸ å±éšªæ“ä½œï¼\nè«‹è¼¸å…¥å­¸ç”Ÿçš„ã€Œåº§è™Ÿã€ä»¥ç¢ºèªåˆªé™¤ï¼š`);
        if(confirmName !== selectedId) return alert("è¼¸å…¥éŒ¯èª¤ï¼Œå–æ¶ˆåˆªé™¤ã€‚");
        await db.collection("students").doc(selectedId).delete();
        alert("è³‡æ–™å·²åˆªé™¤");
        closeModal();
    }

    window.addPoint = async function() {
        try {
            await db.collection("point_logs").add({ studentId: selectedId, time: Date.now() });
            await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(1) });
        } catch (e) { alert("è¨˜é»å¤±æ•—ï¼è«‹æª¢æŸ¥æ¬Šé™ã€‚"); }
    }

    window.deleteLog = async function(lid) {
        if(!confirm("ç¢ºå®šç§»é™¤é€™ç­†ç´€éŒ„ä¸¦æ‰£é™¤ 1 é»ï¼Ÿ")) return;
        await db.collection("point_logs").doc(lid).delete();
        await db.collection("students").doc(selectedId).update({ score: firebase.firestore.FieldValue.increment(-1) });
    }

    window.confirmAssign = async function() {
        const manualJob = document.getElementById('newJob').value.trim();
        const selectedJob = document.getElementById('jobPicker').value;
        const w = document.getElementById('warnInput').value;
        const finalJob = manualJob || selectedJob || "æœªåˆ†é…";
        
        // å–å¾—èº«ä»½è¨­å®š (åƒ…å°å¸«/ç®¡ç†å“¡æœ‰æ•ˆ)
        let newRole = null;
        if(me.role === 'teacher' || me.role === 'admin') {
            newRole = document.getElementById('rolePicker').value;
        }

        try {
            const updateData = { duty_zone: finalJob, warning: w };
            
            // å¦‚æœæœ‰è®Šæ›´èº«ä»½ï¼Œä¸”ç›®æ¨™ä¸æ˜¯å°å¸«/ç®¡ç†å“¡(é¿å…èª¤é™ç´š)ï¼Œå‰‡æ›´æ–°èº«ä»½
            if(newRole) {
                // å®‰å…¨æª¢æŸ¥ï¼šå¾ DB å†ç¢ºèªä¸€æ¬¡ç›®æ¨™ä¸æ˜¯ admin
                const check = await db.collection("students").doc(selectedId).get();
                const currentRole = check.data().role;
                if(currentRole !== 'admin' && currentRole !== 'teacher') {
                    updateData.role = newRole;
                }
            }

            await db.collection("students").doc(selectedId).update(updateData);

            if(manualJob) {
                await db.collection("duty_options").doc(manualJob).set({ active: true });
                await refreshJobs();
            }
            closeModal();
        } catch (e) { alert("å„²å­˜å¤±æ•—ï¼š" + e.message); }
    }

    window.closeModal = function() { document.getElementById('modal').style.display = 'none'; if(unsubS) unsubS(); if(unsubL) unsubL(); }

    async function refreshJobs() {
        const p = document.getElementById('jobPicker');
        const oldVal = p.value;
        try {
            const s = await db.collection("duty_options").get();
            let options = [];
            s.forEach(doc => options.push(doc.id));
            options.sort();
            p.innerHTML = '<option value="">-- é¸æ“‡å·²å­˜å·¥ä½œ --</option>';
            options.forEach(opt => {
                p.innerHTML += `<option value="${opt}">${opt}</option>`;
            });
            if(oldVal) p.value = oldVal;
        } catch(e) {}
    }
    
    // åˆå§‹åŒ–æ™‚ç”¢ç”Ÿä¸€æ¬¡é©—è­‰ç¢¼
    refreshCaptcha();
</script>
</body>
</html>
