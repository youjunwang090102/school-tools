<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šé›²ç«¯å‹¤å‹™ç³»çµ± v3.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 480px; background: white; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); overflow: hidden; }
        .tabs { display: flex; background: #edf2f7; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; color: #718096; }
        .tab.active { background: white; color: var(--p); border-top: 4px solid var(--p); }
        .view { display: none; padding: 25px; }
        .view.active { display: block; }
        input, select, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: 800; cursor: pointer; }
        
        /* å­¸ç”Ÿå¡ç‰‡æ¸…å–® */
        .student-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stu-item { background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; text-align: center; }
        .stu-item:hover { border-color: var(--p); background: #f0f3ff; }
        .stu-item .job-label { font-size: 12px; color: #999; margin-top: 5px; display: block; }

        /* å„€è¡¨æ¿å¡ç‰‡ */
        .main-card { background: linear-gradient(135deg, #4361ee, #4cc9f0); color: white; padding: 30px 20px; border-radius: 25px; text-align: center; margin-bottom: 20px; }
        .duty-name { font-size: 2rem; font-weight: 900; margin: 10px 0; }
        
        /* å½ˆçª—æ¨£å¼ */
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:20px; width:85%; max-width:350px; }
    </style>
</head>
<body>

<div class="container">
    <div id="authTabs" class="tabs">
        <div id="t-login" class="tab active" onclick="switchTab('login')">ç™»å…¥</div>
        <div id="t-reg" class="tab" onclick="switchTab('register')">è¨»å†Š</div>
    </div>

    <div class="content">
        <div id="loginView" class="view active">
            <h2>å¸³è™Ÿç™»å…¥</h2>
            <input type="number" id="loginId" placeholder="åº§è™Ÿ">
            <input type="password" id="loginPw" placeholder="å¯†ç¢¼">
            <button onclick="handleLogin()">é€²å…¥ç³»çµ±</button>
        </div>

        <div id="regView" class="view">
            <h2>æ–°æˆå“¡è¨»å†Š</h2>
            <input type="number" id="regId" placeholder="åº§è™Ÿ">
            <input type="text" id="regName" placeholder="å§“å">
            <input type="password" id="regPw" placeholder="å¯†ç¢¼">
            <select id="regRole" onchange="toggleKey()">
                <option value="student">å­¸ç”Ÿ</option>
                <option value="inner_manager">å…§è¡›ç”Ÿ</option>
                <option value="outer_manager">å¤–è¡›ç”Ÿ</option>
                <option value="teacher">å°å¸«</option>
            </select>
            <input type="password" id="mKey" placeholder="ç®¡ç†é‡‘é‘°" style="display:none">
            <button onclick="handleRegister()">å®Œæˆè¨»å†Š</button>
        </div>

        <div id="dashboardView" class="view">
            <div id="userHeader" style="margin-bottom:15px; font-weight:bold;"></div>
            <div class="main-card">
                <h3 style="margin:0; font-size:14px; opacity:0.9;">ğŸ“ ç›®å‰å·¥ä½œ</h3>
                <div id="dispDuty" class="duty-name">æœªåˆ†é…</div>
            </div>

            <div id="adminPanel" style="display:none; border-top: 2px dashed #eee; padding-top:20px;">
                <h3 style="color:#4a5568;">ğŸ‘¥ å…¨ç­åå–® (é»æ“Šåˆ†é…)</h3>
                <div id="stuListArea" class="student-list"></div>
            </div>
            
            <button onclick="location.reload()" style="background:#718096; margin-top:20px;">å®‰å…¨ç™»å‡º</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <h3 id="modalTitle">åˆ†é…å·¥ä½œ</h3>
        <label>é¸æ“‡å·²æœ‰å·¥ä½œï¼š</label>
        <select id="jobSelect"></select>
        <label>æˆ–æ‰‹å‹•è¼¸å…¥æ–°å·¥ä½œï¼š</label>
        <input type="text" id="customJob" placeholder="ä¾‹å¦‚ï¼šæƒå¾Œé™½å°">
        <button onclick="submitDuty()">ç¢ºèªé€å‡º</button>
        <button onclick="closeModal()" style="background:#eee; color:#666;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const firebaseConfig = { /* è«‹è²¼ä¸Šæ‚¨çš„ Config */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;
    let selectedStuId = null;

    function switchTab(mode) {
        document.getElementById('loginView').className = 'view ' + (mode==='login'?'active':'');
        document.getElementById('regView').className = 'view ' + (mode==='register'?'active':'');
    }

    function toggleKey() {
        const role = document.getElementById('regRole').value;
        document.getElementById('mKey').style.display = (role==='student')?'none':'block';
    }

    async function handleRegister() {
        const id = document.getElementById('regId').value.padStart(2, '0');
        const name = document.getElementById('regName').value;
        const pw = document.getElementById('regPw').value;
        const role = document.getElementById('regRole').value;
        const key = document.getElementById('mKey').value;
        if(role !== 'student' && key !== 'Admin888') { alert("é‡‘é‘°éŒ¯èª¤"); return; }
        
        await db.collection("students").doc(id).set({ name, password: pw, role, duty_zone: "æœªåˆ†é…" });
        alert("è¨»å†ŠæˆåŠŸ"); switchTab('login');
    }

    async function handleLogin() {
        const id = document.getElementById('loginId').value.padStart(2, '0');
        const pw = document.getElementById('loginPw').value;
        const doc = await db.collection("students").doc(id).get();
        if(doc.exists && doc.data().password === pw) {
            currentUser = { id, ...doc.data() };
            renderDashboard();
        } else { alert("éŒ¯èª¤"); }
    }

    async function renderDashboard() {
        document.getElementById('authTabs').style.display = 'none';
        document.getElementById('loginView').classList.remove('active');
        document.getElementById('dashboardView').classList.add('active');
        document.getElementById('userHeader').innerText = `${currentUser.id} ${currentUser.name} (${currentUser.role})`;
        document.getElementById('dispDuty').innerText = currentUser.duty_zone || "æœªåˆ†é…";

        const admins = ['admin', 'teacher', 'inner_manager', 'outer_manager'];
        if(admins.includes(currentUser.role)) {
            document.getElementById('adminPanel').style.display = 'block';
            loadStudentList();
            loadJobOptions();
        }
    }

    // ğŸ† è®€å–å·²è¨»å†Šå­¸ç”Ÿåå–® (æŒ‰åº§è™Ÿæ’åº)
    async function loadStudentList() {
        const area = document.getElementById('stuListArea');
        const snap = await db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).get();
        area.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            area.innerHTML += `
                <div class="stu-item" onclick="openAssignModal('${doc.id}', '${d.name}')">
                    <strong>${doc.id} ${d.name}</strong>
                    <span class="job-label">${d.duty_zone || 'æœªåˆ†é…'}</span>
                </div>`;
        });
    }

    // ğŸ† è®€å–å·¥ä½œé¸é …
    async function loadJobOptions() {
        const sel = document.getElementById('jobSelect');
        sel.innerHTML = '<option value="">-- é¸æ“‡å¸¸ç”¨å·¥ä½œ --</option>';
        const snap = await db.collection("duty_options").get();
        snap.forEach(doc => {
            sel.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
        });
    }

    function openAssignModal(sid, sname) {
        selectedStuId = sid;
        document.getElementById('modalTitle').innerText = `åˆ†é…çµ¦ï¼š${sid} ${sname}`;
        document.getElementById('modal').style.display = 'flex';
    }

    async function submitDuty() {
        const selectJob = document.getElementById('jobSelect').value;
        const customJob = document.getElementById('customJob').value.trim();
        const finalJob = customJob || selectJob;

        if(!finalJob) return;

        // å¦‚æœæ˜¯æ‰‹å‹•è¼¸å…¥ï¼Œå­˜å…¥è³‡æ–™åº«ä¸‹æ¬¡ä½¿ç”¨
        if(customJob) {
            await db.collection("duty_options").doc(customJob).set({ created: true });
        }

        await db.collection("students").doc(selectedStuId).update({ duty_zone: finalJob });
        alert("åˆ†é…æˆåŠŸï¼");
        closeModal();
        loadStudentList(); // åˆ·æ–°åå–®
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
</script>
</body>
</html>
