<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹•æ…‹ç‰†</title>
    <style>
        :root { --primary: #4361ee; --bg: #f8f9fa; --card: #ffffff; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; padding-bottom: 100px; }
        
        h1 { color: #333; text-align: center; cursor: pointer; user-select: none; }
        .input-box { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 80px; gap: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button { background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        #messageList { display: flex; flex-direction: column; gap: 12px; }
        .msg-card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-left: 5px solid #ddd; }
        .msg-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .msg-author { font-weight: bold; color: var(--primary); }
        .admin-id { color: #aaa; font-weight: normal; font-size: 0.7rem; }
        .btn-delete { display: none; color: #ff4d4f; cursor: pointer; border: 1px solid #ff4d4f; padding: 2px 5px; border-radius: 4px; margin-left: 10px; }
        
        /* ğŸ›¡ï¸ ç®¡ç†é¢æ¿æ¨£å¼ */
        #adminPanel { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; text-align: center; z-index: 999; box-sizing: border-box; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); }
        #adminPanel button { background: #444; margin: 5px; font-size: 0.8rem; padding: 8px 12px; border: 1px solid #666; }
        #secretZone { position: fixed; bottom: 0; right: 0; width: 50px; height: 50px; background: transparent; z-index: 998; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="titleSwitch">ğŸ’¬ ç­ç´šç•™è¨€æ¿</h1>

    <div class="input-box">
        <div class="grid">
            <input type="text" id="msgContent" placeholder="åœ¨æ­¤è¼¸å…¥è¨Šæ¯...">
            <button onclick="sendComment()">ç™¼ä½ˆ</button>
        </div>
        <div id="whoAmI" style="font-size: 0.75rem; color: #999; margin-top: 10px;">èº«åˆ†è­˜åˆ¥ä¸­...</div>
    </div>

    <div id="messageList"></div>
</div>

<div id="adminPanel">
    <div style="margin-bottom:10px; color:#ffd700; font-size: 0.9rem; font-weight: bold;">ğŸ›¡ï¸ è€å¸«ç®¡ç†æ¨¡å¼</div>
    <button onclick="remoteRename()" style="background:#8e44ad;">å¼·åˆ¶é ç«¯æ”¹å</button>
    <button onclick="clearAllMessages()" style="background:#d9534f;">ä¸€éµæ¸…ç©ºå…¨ç­</button>
    <button onclick="exitAdmin()">ç™»å‡ºç®¡ç†</button>
    <div style="font-size:10px; color:#777; margin-top:5px;">å¯†ä»¤æç¤ºï¼šæ–¼å­¸ç”Ÿæ‰‹æ©Ÿè¼¸å…¥ reset:name</div>
</div>

<div id="secretZone" onclick="triggerStep2()"></div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    // --- 1. è¨­å®šå€ ---
    const firebaseConfig = {
        apiKey: "AIzaSyAS2CLfgTw9RQgVmZroj0O__N7h3M7XoP0",
        authDomain: "school-tools-6668.firebaseapp.com",
        projectId: "school-tools-6668",
        storageBucket: "school-tools-6668.firebasestorage.app",
        messagingSenderId: "436587749038",
        appId: "1:436587749038:web:7153f0699078966530d73f"
    };
    const ADMIN_PASSWORD = "6668"; 

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. èº«åˆ†è­˜åˆ¥é‚è¼¯ ---
    let myId = localStorage.getItem('chat_device_id');
    if (!myId) {
        myId = Math.random().toString(36).substr(2, 4).toUpperCase();
        localStorage.setItem('chat_device_id', myId);
    }

    let myName = localStorage.getItem('chat_name');
    function initUser() {
        if (!myName) {
            let n = prompt("è«‹è¼¸å…¥æ‚¨çš„å§“åï¼ˆè¨­å®šå¾Œç„¡æ³•è‡ªè¡Œæ›´æ”¹ï¼‰ï¼š");
            if (n && n.trim()) {
                myName = n.trim();
                localStorage.setItem('chat_name', myName);
                location.reload();
            } else { initUser(); }
        }
        document.getElementById('whoAmI').innerText = `æˆ‘çš„èº«åˆ†ï¼š${myName} (#${myId})`;
    }
    initUser();

    // --- 3. è€å¸«æ¬Šé™æ§åˆ¶ ---
    let clickCount = 0;
    let step1Cleared = false;
    let isAdminMode = false;

    document.getElementById('titleSwitch').onclick = () => {
        clickCount++;
        if (clickCount >= 5) { 
            step1Cleared = true; 
            clickCount = 0; 
            console.log("Stage 1 OK");
        }
    };

    function triggerStep2() {
        if (step1Cleared) {
            const pw = prompt("è«‹è¼¸å…¥è€å¸«ç®¡ç†å¯†ç¢¼ï¼š");
            if (pw === ADMIN_PASSWORD) {
                isAdminMode = true;
                document.getElementById('adminPanel').style.display = 'block';
                renderAdminUI();
                step1Cleared = false;
            }
        }
    }

    function renderAdminUI() {
        document.querySelectorAll('.btn-delete').forEach(b => b.style.display = 'inline');
        document.querySelectorAll('.admin-id').forEach(s => s.style.display = 'inline');
    }

    function exitAdmin() { isAdminMode = false; location.reload(); }

    // --- 4. é ç«¯æŒ‡ä»¤ç›£è½ (é˜²æ­¢ç„¡é™é‡è¤‡ä¿®æ­£ç‰ˆ) ---
    let lastResetTime = localStorage.getItem('last_reset_time') || 0;

    db.collection("system_cmds").doc("rename_tasks").onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            const cmdTime = data.ts ? data.ts.seconds : 0;
            
            // åªæœ‰ç•¶ ID ç›¸ç¬¦ï¼Œä¸”è©²æŒ‡ä»¤æ˜¯ã€Œæ–°çš„ã€(æ™‚é–“æ™šæ–¼ä¸Šæ¬¡é‡è¨­) æ‰æœƒåŸ·è¡Œ
            if (data.targetId === myId && cmdTime > lastResetTime) {
                localStorage.setItem('last_reset_time', cmdTime);
                alert("è€å¸«å·²é‡è¨­æ‚¨çš„å§“åæ¬Šé™ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚");
                localStorage.removeItem('chat_name');
                location.reload();
            }
        }
    });

    async function remoteRename() {
        const tid = prompt("è«‹è¼¸å…¥è©²å­¸ç”Ÿçš„ ID (å¦‚: A7B2):");
        if (tid) {
            await db.collection("system_cmds").doc("rename_tasks").set({
                targetId: tid.toUpperCase(),
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("æ”¹åæŒ‡ä»¤å·²ç™¼é€ï¼");
        }
    }

    // --- 5. è¨Šæ¯æ”¶ç™¼åŠŸèƒ½ ---
    function sendComment() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content) return;

        // å¯†ä»¤ï¼šè€å¸«è¦ªè‡ªæ“ä½œæ™‚å¯ç”¨
        if (content === "reset:name") {
            localStorage.removeItem('chat_name');
            location.reload();
            return;
        }

        db.collection("messages").add({
            author: myName,
            content: content,
            deviceId: myId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { document.getElementById('msgContent').value = ""; });
    }

    function deleteMsg(id) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç•™è¨€ï¼Ÿ")) db.collection("messages").doc(id).delete();
    }

    async function clearAllMessages() {
        if(confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºå…¨ç­ç•™è¨€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚")) {
            const snap = await db.collection("messages").get();
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert("å·²æ¸…ç©ºæ‰€æœ‰ç•™è¨€ã€‚");
        }
    }

    // --- 6. ç›£è½å‹•æ…‹ç‰† ---
    db.collection("messages").orderBy("createdAt", "desc").onSnapshot(snap => {
        const list = document.getElementById('messageList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "...";
            const div = document.createElement('div');
            div.className = 'msg-card';
            div.innerHTML = `
                <div class="msg-header">
                    <span>
                        <span class="msg-author">${d.author}</span> 
                        <span class="admin-id" style="display:${isAdminMode?'inline':'none'}">(#${d.deviceId})</span>
                    </span>
                    <span>${time} <span class="btn-delete" onclick="deleteMsg('${doc.id}')" style="display:${isAdminMode?'inline':'none'}">ğŸ—‘ï¸</span></span>
                </div>
                <div class="msg-content">${d.content}</div>
            `;
            list.appendChild(div);
        });
    });
</script>
</body>
</html>
