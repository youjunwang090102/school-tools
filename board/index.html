<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹•æ…‹ç‰†-çµ‚æ¥µç®¡ç†ç‰ˆ</title>
    <style>
        :root { --primary: #4361ee; --bg: #f4f7fe; --card: #ffffff; --teacher: #8e44ad; --danger: #ef233c; --success: #2ec4b6; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; padding-bottom: 150px; }
        .auth-box { background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; margin-top: 50px; }
        #mainContent { display: none; }
        h1 { color: #333; text-align: center; }
        .input-box { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 80px; gap: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        #messageList { display: flex; flex-direction: column; gap: 12px; }
        .msg-card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-left: 5px solid #ddd; }
        .is-teacher { border-left-color: var(--teacher); }
        .msg-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        #adminTools { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; z-index: 999; box-sizing: border-box; max-height: 80vh; overflow-y: auto; }
        .mute-panel { display: flex; flex-wrap: wrap; gap: 10px; background: #333; padding: 15px; border-radius: 12px; margin-bottom: 10px; align-items: center; justify-content: center; }
        .mute-list-card { background: #444; padding: 10px; border-radius: 8px; margin: 5px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; margin-left: 5px; }
        .status-tag { font-size: 0.75rem; color: var(--danger); font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="authBox" class="auth-box">
        <h2>ğŸ”‘ ç­ç´šæˆå“¡ç™»å…¥</h2>
        <input type="number" id="loginId" placeholder="åº§è™Ÿ (ä¾‹å¦‚ 05)" style="margin-bottom: 10px;">
        <input type="password" id="loginPw" placeholder="å¯†ç¢¼" style="margin-bottom: 20px;">
        <button onclick="doLogin()" style="width: 100%; padding: 15px;">ç™»å…¥ç³»çµ±</button>
    </div>

    <div id="mainContent">
        <h1>ğŸ’¬ ç­ç´šå‹•æ…‹ç‰†</h1>
        <div class="input-box">
            <div class="grid">
                <input type="text" id="msgContent" placeholder="åœ¨æ­¤è¼¸å…¥è¨Šæ¯...">
                <button onclick="sendComment()">ç™¼ä½ˆ</button>
            </div>
            <div id="muteStatus" class="status-tag" style="display:none;"></div>
            <div style="font-size: 0.8rem; color: #666; margin-top: 10px; display: flex; justify-content: space-between;">
                <span id="whoAmI">è¼‰å…¥ä¸­...</span>
                <span onclick="location.reload()" style="cursor:pointer; color:var(--primary)">ç™»å‡º</span>
            </div>
        </div>
        <div id="messageList"></div>
    </div>
</div>

<div id="adminTools">
    <div style="text-align:center; color:#ffd700; font-weight:bold; margin-bottom:10px;">ğŸ›¡ï¸ è¦–è¦ºåŒ–ç¦è¨€ç®¡ç†</div>
    <div class="mute-panel">
        <select id="muteTargetSelect" style="width:auto;"><option value="">é¸æ“‡å­¸ç”Ÿ...</option></select>
        <select id="muteDaysSelect" style="width:auto;">
            <option value="0.0416">1 å°æ™‚</option>
            <option value="1" selected>1 å¤©</option>
            <option value="3">3 å¤©</option>
            <option value="999">æ°¸ä¹…</option>
        </select>
        <button onclick="setMute()" style="background:var(--danger); width:auto; padding:10px 20px;">ç¦è¨€</button>
    </div>
    <div id="activeMuteList"></div>
    <div style="text-align:center; margin-top:15px; border-top: 1px solid #444; padding-top:10px;">
        <button onclick="clearAllMessages()" style="background:var(--danger); width:auto;">æ¸…ç©ºç•™è¨€</button>
        <button onclick="location.reload()" style="background:#555; width:auto;">é€€å‡ºç®¡ç†</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAS2CLfgTw9RQgVmZroj0O__N7h3M7XoP0",
        authDomain: "school-tools-6668.firebaseapp.com",
        projectId: "school-tools-6668",
        storageBucket: "school-tools-6668.firebasestorage.app",
        messagingSenderId: "436587749038",
        appId: "1:436587749038:web:7153f0699078966530d73f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;
    let currentDocId = ""; // å„²å­˜è³‡æ–™åº«ä¸­çœŸæ­£çš„ Document ID

    // --- æ ¸å¿ƒï¼šä¿®æ­£å¾Œçš„ç™»å…¥é‚è¼¯ ---
    async function doLogin() {
        const inputId = document.getElementById('loginId').value.padStart(2, '0');
        const inputPw = document.getElementById('loginPw').value;

        try {
            // ç¬¬ä¸€ç¨®å˜—è©¦ï¼šDocument ID å°±æ˜¯åº§è™Ÿ
            let doc = await db.collection("students").doc(inputId).get();
            let data;

            if (doc.exists) {
                data = doc.data();
                currentDocId = inputId;
            } else {
                // ç¬¬äºŒç¨®å˜—è©¦ï¼šæœå°‹æ¬„ä½å« id çš„æ–‡ä»¶
                const q = await db.collection("students").where("id", "==", inputId).get();
                if (!q.empty) {
                    doc = q.docs[0];
                    data = doc.data();
                    currentDocId = doc.id;
                }
            }

            if (data && String(data.password) === String(inputPw)) {
                if (data.role !== 'teacher' && data.role !== 'admin' && data.status !== 'active') {
                    return alert("å¸³è™Ÿå¯©æ ¸ä¸­ (status éœ€ç‚º active)");
                }
                currentUser = { ...data, id: inputId }; 
                initApp();
            } else {
                alert("åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
            }
        } catch (e) {
            alert("ç³»çµ±éŒ¯èª¤ï¼š" + e.message);
        }
    }

    function initApp() {
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        const isStaff = (currentUser.role === 'teacher' || currentUser.role === 'admin');
        document.getElementById('whoAmI').innerText = `${currentUser.name} (#${currentUser.id})`;
        
        if (isStaff) {
            document.getElementById('adminTools').style.display = 'block';
            loadMuteManager();
        }
        checkMuteStatus();
        listenMessages(isStaff);
    }

    // --- ç¦è¨€ç®¡ç†åŠŸèƒ½ ---
    async function loadMuteManager() {
        const snap = await db.collection("students").get();
        const select = document.getElementById('muteTargetSelect');
        const list = document.getElementById('activeMuteList');
        
        select.innerHTML = '<option value="">é¸æ“‡å­¸ç”Ÿ...</option>';
        list.innerHTML = '<p style="font-size:0.8rem; color:#888; text-align:center;">ç•¶å‰ç¦è¨€åå–®</p>';

        snap.forEach(doc => {
            const s = doc.data();
            if (s.role === 'teacher') return;

            // ä¸‹æ‹‰é¸å–®ç”¨ id æˆ–åº§è™Ÿ
            const opt = document.createElement('option');
            opt.value = doc.id;
            opt.innerText = `${s.id || doc.id} ${s.name}`;
            select.appendChild(opt);

            // é¡¯ç¤ºç¦è¨€ä¸­åå–®
            if (s.muteUntil > Date.now()) {
                const div = document.createElement('div');
                div.className = 'mute-list-card';
                div.innerHTML = `
                    <span>${s.name} <br><small>${new Date(s.muteUntil).toLocaleString()}</small></span>
                    <button class="btn-sm" style="background:var(--success)" onclick="unmute('${doc.id}')">è§£ç¦</button>
                `;
                list.appendChild(div);
            }
        });
    }

    async function setMute() {
        const docId = document.getElementById('muteTargetSelect').value;
        const days = parseFloat(document.getElementById('muteDaysSelect').value);
        if (!docId) return alert("è«‹é¸æ“‡å­¸ç”Ÿ");
        const until = Date.now() + (days * 24 * 60 * 60 * 1000);
        await db.collection("students").doc(docId).update({ muteUntil: until });
        loadMuteManager();
    }

    async function unmute(docId) {
        await db.collection("students").doc(docId).update({ muteUntil: 0 });
        loadMuteManager();
    }

    async function checkMuteStatus() {
        setInterval(async () => {
            const doc = await db.collection("students").doc(currentDocId).get();
            const until = doc.data().muteUntil || 0;
            const el = document.getElementById('muteStatus');
            if (Date.now() < until) {
                el.style.display = 'block';
                el.innerText = `âš ï¸ ç¦è¨€ä¸­ï¼Œé è¨ˆè§£ç¦ï¼š${new Date(until).toLocaleString()}`;
            } else { el.style.display = 'none'; }
        }, 5000);
    }

    // --- è¨Šæ¯åŠŸèƒ½ ---
    async function sendComment() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content) return;

        const doc = await db.collection("students").doc(currentDocId).get();
        if (Date.now() < (doc.data().muteUntil || 0)) return alert("ç¦è¨€ä¸­ç„¡æ³•ç™¼æ–‡");

        db.collection("messages").add({
            author: currentUser.name,
            authorId: currentUser.id,
            content: content,
            role: currentUser.role || 'student',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { document.getElementById('msgContent').value = ""; });
    }

    function listenMessages(isStaff) {
        db.collection("messages").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
            const list = document.getElementById('messageList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "...";
                const div = document.createElement('div');
                div.className = `msg-card ${d.role === 'teacher' ? 'is-teacher' : ''}`;
                div.innerHTML = `
                    <div class="msg-header">
                        <span><b>${d.author}</b> <small>(#${d.authorId})</small></span>
                        <span>${time} ${isStaff ? `<span style="color:var(--danger); cursor:pointer;" onclick="deleteMsg('${doc.id}')">ğŸ—‘ï¸</span>` : ''}</span>
                    </div>
                    <div>${d.content}</div>
                `;
                list.appendChild(div);
            });
        });
    }

    function deleteMsg(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.collection("messages").doc(id).delete(); }

    async function clearAllMessages() {
        if(confirm("è­¦å‘Šï¼šå°‡åˆªé™¤æ‰€æœ‰ç•™è¨€ï¼")) {
            const snap = await db.collection("messages").get();
            const batch = db.batch();
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        }
    }
</script>
</body>
</html>
