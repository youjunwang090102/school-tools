<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šç•™è¨€æ¿</title>
    <style>
        :root { --primary: #4361ee; --bg: #f8f9fa; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:1000; }
        .login-btn { padding: 15px 30px; background: #4285F4; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
        
        /* å°šæœªç¶å®šæç¤º */
        #unboundOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:900; text-align:center; }

        .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: 150px; }
        .header { background: var(--primary); color:white; padding: 15px; border-radius: 0 0 15px 15px; margin-bottom: 20px; display:flex; justify-content:space-between; }
        
        .input-box { background: var(--card); padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 80px; gap: 10px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        
        .msg-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .msg-header { font-size: 0.8rem; color: #888; display:flex; justify-content:space-between; }

        /* ğŸ›¡ï¸ è€å¸«å°ˆå±¬å¾Œå°æ¨£å¼ */
        #adminConsole { display:none; background: #333; color: white; padding: 20px; border-radius: 15px; margin-top: 20px; }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #444; font-size: 0.9rem; }
        .admin-btn { padding: 5px 10px; margin-left: 5px; cursor:pointer; border:none; border-radius:4px; font-size: 0.75rem; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <h2>ğŸ’¬ ç­ç´šå‹•æ…‹ç‰†</h2>
    <button class="login-btn" onclick="signIn()">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<div id="unboundOverlay">
    <h2 style="color: #e63946;">âš ï¸ å°šæœªé€²è¡Œç­ç´šç¶å®š</h2>
    <p>æ‚¨çš„å¸³è™Ÿ (${currentUser?.email}) å·²ç™»éŒ„ç³»çµ±ï¼Œ<br>è«‹å‘ŠçŸ¥è€å¸«ç‚ºæ‚¨è¨­å®šç­ç´šã€‚</p>
    <button onclick="signOut()">ç™»å‡º</button>
</div>

<div class="container" id="mainApp" style="display:none;">
    <div class="header">
        <span id="displayClassName">è¼‰å…¥ä¸­...</span>
        <button onclick="signOut()" style="background:none; border:1px solid white; color:white; border-radius:4px; font-size:0.7rem;">ç™»å‡º</button>
    </div>

    <div id="teacherTabs" style="display:none; margin-bottom:15px; text-align:center;">
        <button onclick="switchView('ClassA')">çœ‹ç”²ç­</button>
        <button onclick="switchView('ClassB')">çœ‹ä¹™ç­</button>
        <button onclick="document.getElementById('adminConsole').style.display='block'" style="background:#ffd700;">ç®¡ç†å­¸ç”Ÿåå–®</button>
    </div>

    <div id="adminConsole">
        <h3>ğŸ‘¥ å­¸ç”Ÿæ¬Šé™æŒ‡æ´¾</h3>
        <div id="userList">è¼‰å…¥åå–®ä¸­...</div>
        <button onclick="this.parentElement.style.display='none'" style="margin-top:10px; width:100%;">é—œé–‰é¢æ¿</button>
    </div>

    <div class="input-box">
        <div class="grid">
            <input type="text" id="msgContent" placeholder="åœ¨æ­¤è¼¸å…¥è¨Šæ¯...">
            <button onclick="sendComment()" style="background:var(--primary); color:white; border:none; border-radius:8px;">é€å‡º</button>
        </div>
    </div>

    <div id="messageList"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAS2CLfgTw9RQgVmZroj0O__N7h3M7XoP0",
        authDomain: "school-tools-6668.firebaseapp.com",
        projectId: "school-tools-6668",
        storageBucket: "school-tools-6668.firebasestorage.app",
        messagingSenderId: "436587749038",
        appId: "1:436587749038:web:7153f0699078966530d73f"
    };
    const TEACHER_EMAIL = "ä½ çš„Email@gmail.com"; 

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    let currentUser = null;
    let userClass = null; // å­¸ç”Ÿçš„ç­ç´š
    let viewClass = null; // è€å¸«æ­£åœ¨çœ‹çš„ç­ç´š
    let unsubMsg = null;

    function signIn() { auth.signInWithPopup(provider); }
    function signOut() { auth.signOut(); location.reload(); }

    // ç›£è½ç™»å…¥ç‹€æ…‹
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginOverlay').style.display = 'none';
            
            // 1. åœ¨ users é›†åˆè¨˜éŒ„æ­¤äººï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            await db.collection("users").doc(user.email).set({
                name: user.displayName,
                email: user.email,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            checkUserClass();
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    });

    // æª¢æŸ¥ç­ç´šæ¬Šé™
    function checkUserClass() {
        db.collection("users").doc(currentUser.email).onSnapshot(doc => {
            const data = doc.data();
            if (currentUser.email === TEACHER_EMAIL) {
                // æ˜¯è€å¸«
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('teacherTabs').style.display = 'block';
                loadUserList();
                if(!viewClass) switchView('ClassA');
            } else if (data && data.class) {
                // æ˜¯ä¸€èˆ¬å­¸ç”Ÿï¼Œä¸”å·²æœ‰ç­ç´š
                userClass = data.class;
                viewClass = data.class;
                document.getElementById('unboundOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('displayClassName').innerText = (userClass === 'ClassA' ? "ğŸ† ç”²ç­" : "ğŸš€ ä¹™ç­");
                loadMessages();
            } else {
                // å°šæœªç¶å®šçš„å­¸ç”Ÿ
                document.getElementById('unboundOverlay').style.display = 'flex';
            }
        });
    }

    // è€å¸«åˆ‡æ›è¦–è§’
    function switchView(c) {
        viewClass = c;
        document.getElementById('displayClassName').innerText = `è€å¸«æ­£åœ¨æŸ¥çœ‹ï¼š${c==='ClassA'?'ç”²ç­':'ä¹™ç­'}`;
        loadMessages();
    }

    // è€å¸«ç®¡ç†ï¼šè®€å–æ‰€æœ‰ç™»å…¥éçš„å­¸ç”Ÿ
    function loadUserList() {
        db.collection("users").onSnapshot(snap => {
            const list = document.getElementById('userList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if(u.email === TEACHER_EMAIL) return;
                const div = document.createElement('div');
                div.className = 'user-row';
                div.innerHTML = `
                    <span>${u.name} <br><small>${u.email}</small> [${u.class || 'æœªåˆ†é…'}]</span>
                    <div>
                        <button class="admin-btn" style="background:#4caf50;color:white;" onclick="assignClass('${u.email}','ClassA')">ç”²ç­</button>
                        <button class="admin-btn" style="background:#2196f3;color:white;" onclick="assignClass('${u.email}','ClassB')">ä¹™ç­</button>
                        <button class="admin-btn" style="background:#f44336;color:white;" onclick="assignClass('${u.email}',null)">ç§»é™¤</button>
                    </div>
                `;
                list.appendChild(div);
            });
        });
    }

    function assignClass(email, className) {
        db.collection("users").doc(email).update({ class: className });
    }

    // è¨Šæ¯ç³»çµ±
    function loadMessages() {
        if(unsubMsg) unsubMsg();
        unsubMsg = db.collection("classes").doc(viewClass).collection("messages")
            .orderBy("createdAt", "desc")
            .onSnapshot(snap => {
                const list = document.getElementById('messageList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = 'msg-card';
                    div.innerHTML = `
                        <div class="msg-header"><span>${d.author}</span> <span>${d.createdAt?new Date(d.createdAt.seconds*1000).toLocaleTimeString():''}</span></div>
                        <div>${d.content}</div>
                    `;
                    list.appendChild(div);
                });
            });
    }

    function sendComment() {
        const content = document.getElementById('msgContent').value.trim();
        if(!content || !viewClass) return;
        db.collection("classes").doc(viewClass).collection("messages").add({
            author: currentUser.displayName,
            email: currentUser.email,
            content: content,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { document.getElementById('msgContent').value = ""; });
    }
</script>
</body>
</html>
