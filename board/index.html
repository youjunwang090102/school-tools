<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹•æ…‹ç‰† v5.0 - ç©©å®šç®¡ç†ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; --card: #ffffff; --teacher: #8e44ad; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; padding-bottom: 150px; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .msg-item { background: white; padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 5px solid #cbd5e1; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .is-teacher { border-left-color: var(--teacher); }
        .msg-info { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .mute-warning { color: var(--d); font-weight: bold; font-size: 0.85rem; margin-top: 5px; display: none; background: #fff1f2; padding: 10px; border-radius: 8px; }

        /* ğŸ›¡ï¸ è€å¸«ç®¡ç†é¢æ¿ */
        #adminPanel { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #1e293b; color: white; padding: 15px; box-sizing: border-box; z-index: 100; border-radius: 20px 20px 0 0; }
        .mute-ctrl { display: flex; gap: 8px; align-items: center; }
        .mute-list { max-height: 120px; overflow-y: auto; margin-top: 10px; font-size: 0.85rem; }
        .mute-list-item { display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px; margin-bottom: 5px; }
        .btn-sm { width: auto; padding: 5px 10px; margin: 0; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginCard" class="card">
        <h2 style="text-align: center;">ğŸ’¬ ç­ç´šå‹•æ…‹ç‰†</h2>
        <input type="number" id="stuId" placeholder="åº§è™Ÿ (ä¾‹å¦‚: 5)">
        <input type="password" id="stuPw" placeholder="å¯†ç¢¼">
        <button onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
    </div>

    <div id="mainView" style="display: none;">
        <div class="card">
            <h3 id="userName" style="margin-top:0;">è¼‰å…¥ä¸­...</h3>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="msgInput" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." style="margin:0;">
                <button onclick="sendMsg()" style="width: 80px; margin:0;">ç™¼ä½ˆ</button>
            </div>
            <div id="selfMuteHint" class="mute-warning"></div>
        </div>
        <div id="msgList"></div>
    </div>
</div>

<div id="adminPanel">
    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 8px; display: flex; justify-content: space-between;">
        <span>ğŸ›¡ï¸ ç¦è¨€ç®¡ç†æ§åˆ¶å°</span>
        <span onclick="this.parentElement.parentElement.style.display='none'" style="cursor:pointer">é—œé–‰</span>
    </div>
    <div class="mute-ctrl">
        <select id="targetSelect" style="flex:2; margin:0;"></select>
        <select id="daysSelect" style="flex:1; margin:0;">
            <option value="0.0416">1å°æ™‚</option>
            <option value="1">1å¤©</option>
            <option value="3">3å¤©</option>
            <option value="999">æ°¸ä¹…</option>
        </select>
        <button onclick="executeMute()" style="flex:1; margin:0; background:var(--d);">ç¦è¨€</button>
    </div>
    <div id="activeMuteList" class="mute-list"></div>
</div>

<script>
    // Firebase é…ç½® (æ²¿ç”¨æ‚¨çš„è¨­å®š)
    const firebaseConfig = { 
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null;
    let isMuted = false;

    // --- ç™»å…¥é‚è¼¯ ---
    async function doLogin() {
        const idInput = document.getElementById('stuId').value;
        const pwInput = document.getElementById('stuPw').value;
        if(!idInput || !pwInput) return alert("è«‹è¼¸å…¥åº§è™Ÿèˆ‡å¯†ç¢¼");

        const id = idInput.padStart(2, '0'); 
        try {
            const doc = await db.collection("students").doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                if (data.password === pwInput) {
                    if (data.status === "active") {
                        me = { id, ...data };
                        startApp();
                    } else { alert("å¸³è™Ÿå°šæœªå•Ÿç”¨"); }
                } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
            } else { alert("åº§è™Ÿä¸å­˜åœ¨"); }
        } catch (e) { alert("é€£ç·šå¤±æ•—ï¼š" + e.message); }
    }

    function startApp() {
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('userName').innerText = `ğŸ‘‹ æ‚¨å¥½ï¼Œ${me.name}`;
        
        const isTeacher = (me.role === 'teacher' || me.role === 'admin');
        if (isTeacher) {
            document.getElementById('adminPanel').style.display = 'block';
            loadStudentSelector();
            listenMuteList();
        }
        
        listenMessages(isTeacher);
        checkMyMute();
    }

    // --- ç¦è¨€ç®¡ç† (ä½¿ç”¨ç¨ç«‹é›†åˆ mute_records) ---
    async function loadStudentSelector() {
        const snap = await db.collection("students").get();
        const select = document.getElementById('targetSelect');
        const sorted = snap.docs.sort((a,b) => parseInt(a.id) - parseInt(b.id));
        select.innerHTML = '<option value="">é¸æ“‡å­¸ç”Ÿ...</option>';
        sorted.forEach(doc => {
            if(doc.data().role !== 'teacher') {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.innerText = `${parseInt(doc.id)}è™Ÿ ${doc.data().name}`;
                select.appendChild(opt);
            }
        });
    }

    function listenMuteList() {
        db.collection("mute_records").onSnapshot(async snap => {
            const listArea = document.getElementById('activeMuteList');
            listArea.innerHTML = '';
            
            // ç‚ºäº†é¡¯ç¤ºåå­—ï¼Œæˆ‘å€‘éœ€è¦å°ç…§è¡¨
            const stuSnap = await db.collection("students").get();
            let names = {};
            stuSnap.forEach(d => names[d.id] = d.data().name);

            snap.forEach(doc => {
                const data = doc.data();
                if (data.until > Date.now()) {
                    const div = document.createElement('div');
                    div.className = 'mute-list-item';
                    div.innerHTML = `
                        <span>${parseInt(doc.id)}è™Ÿ ${names[doc.id] || 'å­¸ç”Ÿ'} (è‡³ ${new Date(data.until).toLocaleString()})</span>
                        <button class="btn-sm" style="background:var(--s)" onclick="unmute('${doc.id}')">è§£é™¤</button>
                    `;
                    listArea.appendChild(div);
                }
            });
        });
    }

    async function executeMute() {
        const sid = document.getElementById('targetSelect').value;
        const days = parseFloat(document.getElementById('daysSelect').value);
        if(!sid) return alert("è«‹é¸æ“‡å­¸ç”Ÿ");
        const until = Date.now() + (days * 24 * 60 * 60 * 1000);
        
        // å¯«å…¥ç¨ç«‹é›†åˆï¼Œä¸æœƒé–ƒé€€
        await db.collection("mute_records").doc(sid).set({ until: until });
        alert("ç¦è¨€è¨­å®šæˆåŠŸ");
    }

    async function unmute(sid) {
        await db.collection("mute_records").doc(sid).delete();
    }

    // --- å­¸ç”Ÿç«¯æª¢æŸ¥ ---
    function checkMyMute() {
        db.collection("mute_records").doc(me.id).onSnapshot(doc => {
            const hint = document.getElementById('selfMuteHint');
            if (doc.exists && doc.data().until > Date.now()) {
                isMuted = true;
                hint.style.display = 'block';
                hint.innerText = `âš ï¸ ç¦è¨€ä¸­ï¼Œé è¨ˆè§£ç¦ï¼š${new Date(doc.data().until).toLocaleString()}`;
            } else {
                isMuted = false;
                hint.style.display = 'none';
            }
        });
    }

    // --- ç•™è¨€æ¿é‚è¼¯ ---
    async function sendMsg() {
        if (isMuted) return alert("æ‚¨ç›®å‰è™•æ–¼ç¦è¨€ç‹€æ…‹ï¼");
        const content = document.getElementById('msgInput').value.trim();
        if(!content) return;

        await db.collection("messages").add({
            author: me.name,
            authorId: me.id,
            content: content,
            role: me.role || 'student',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msgInput').value = "";
    }

    function listenMessages(isTeacher) {
        db.collection("messages").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
            const container = document.getElementById('msgList');
            container.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "...";
                const div = document.createElement('div');
                div.className = `msg-item ${d.role === 'teacher' ? 'is-teacher' : ''}`;
                div.innerHTML = `
                    <div class="msg-info">
                        <span><b>${d.author}</b> (#${d.authorId})</span>
                        <span>${time} ${isTeacher ? `<span style="color:var(--d); cursor:pointer; margin-left:10px;" onclick="deleteMsg('${doc.id}')">ğŸ—‘ï¸</span>` : ''}</span>
                    </div>
                    <div>${d.content}</div>
                `;
                container.appendChild(div);
            });
        });
    }

    async function deleteMsg(mid) { if(confirm("åˆªé™¤ç•™è¨€ï¼Ÿ")) await db.collection("messages").doc(mid).delete(); }
</script>
</body>
</html>
