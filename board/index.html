<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹•æ…‹ç‰†-ä¿®æ­£</title>
    <style>
        :root { --primary: #4361ee; --bg: #f4f7fe; --card: #ffffff; --teacher: #8e44ad; --danger: #ef233c; --success: #2ec4b6; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; padding-bottom: 150px; }
        .auth-box { background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; margin-top: 50px; }
        #mainContent { display: none; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; padding: 15px; transition: 0.3s; }
        .msg-card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-left: 5px solid #ddd; margin-bottom: 12px; }
        .is-teacher { border-left-color: var(--teacher); }
        #adminTools { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; z-index: 999; box-sizing: border-box; }
        .mute-panel { display: flex; gap: 10px; margin-bottom: 10px; }
        .mute-item { background: #444; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="authBox" class="auth-box">
        <h2>ğŸ”‘ ç­ç´šæˆå“¡ç™»å…¥</h2>
        <input type="number" id="loginId" placeholder="è¼¸å…¥åº§è™Ÿ (ä¾‹å¦‚ 5)">
        <input type="password" id="loginPw" placeholder="è¼¸å…¥å¯†ç¢¼">
        <button onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
    </div>

    <div id="mainContent">
        <h1 style="text-align:center;">ğŸ’¬ ç­ç´šå‹•æ…‹ç‰†</h1>
        <div style="background:white; padding:20px; border-radius:15px; margin-bottom:20px;">
            <div style="display:grid; grid-template-columns: 1fr 80px; gap:10px;">
                <input type="text" id="msgContent" placeholder="æƒ³èªªä»€éº¼ï¼Ÿ" style="margin:0;">
                <button onclick="sendComment()" style="padding:0;">ç™¼ä½ˆ</button>
            </div>
            <div id="muteStatus" style="color:red; font-size:0.8rem; margin-top:5px; display:none;"></div>
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-top:10px; color:#666;">
                <span id="whoAmI"></span>
                <span onclick="location.reload()" style="color:var(--primary); cursor:pointer;">ç™»å‡º</span>
            </div>
        </div>
        <div id="messageList"></div>
    </div>
</div>

<div id="adminTools">
    <div style="text-align:center; color:#ffd700; margin-bottom:10px; font-weight:bold;">ğŸ›¡ï¸ è€å¸«ç¦è¨€ç®¡ç†</div>
    <div class="mute-panel">
        <select id="muteTargetSelect" style="flex:2;"></select>
        <select id="muteDaysSelect" style="flex:1;">
            <option value="1">1å¤©</option>
            <option value="3">3å¤©</option>
            <option value="999">æ°¸ä¹…</option>
        </select>
        <button onclick="setMute()" style="flex:1; padding:0; background:var(--danger);">ç¦è¨€</button>
    </div>
    <div id="muteListArea"></div>
    <button onclick="clearAllMessages()" style="background:#555; margin-top:10px;">ä¸€éµæ¸…ç©ºç•™è¨€</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAS2CLfgTw9RQgVmZroj0O__N7h3M7XoP0",
        authDomain: "school-tools-6668.firebaseapp.com",
        projectId: "school-tools-6668",
        storageBucket: "school-tools-6668.firebasestorage.app",
        messagingSenderId: "436587749038",
        appId: "1:436587749038:web:7153f0699078966530d73f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null;
    let myDocId = "";

    async function doLogin() {
        const rawId = document.getElementById('loginId').value;
        const inputPw = document.getElementById('loginPw').value;
        
        // å˜—è©¦ä¸‰ç¨®æ ¼å¼ï¼šåŸæ•¸å­— (5)ã€è£œé›¶å­—ä¸² ("05")ã€ç´”æ•¸å­—å­—ä¸² ("5")
        const tryIds = [rawId.padStart(2, '0'), rawId.toString(), parseInt(rawId).toString()];
        
        let foundDoc = null;

        for (let id of tryIds) {
            const doc = await db.collection("students").doc(id).get();
            if (doc.exists) {
                foundDoc = doc;
                myDocId = id;
                break;
            }
        }

        if (foundDoc) {
            const data = foundDoc.data();
            // é—œéµï¼šå°‡è³‡æ–™åº«å¯†ç¢¼èˆ‡è¼¸å…¥å¯†ç¢¼éƒ½è½‰æˆå­—ä¸²æ¯”å°ï¼Œé¿å…æ•¸å­—å‹æ…‹é€ æˆå¤±æ•—
            if (String(data.password) === String(inputPw)) {
                if (data.role !== 'teacher' && data.status !== 'active') {
                    return alert("å¸³è™Ÿå°šæœªæ‰¹å‡† (éœ€ç‚º active)");
                }
                me = data;
                initApp();
            } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
        } else { alert("æ‰¾ä¸åˆ°æ­¤åº§è™Ÿï¼Œè«‹ç¢ºèªè³‡æ–™åº« Document ID æ˜¯å¦æ­£ç¢º"); }
    }

    function initApp() {
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('whoAmI').innerText = `${me.name} (#${myDocId})`;
        
        const isTeacher = (me.role === 'teacher');
        if (isTeacher) {
            document.getElementById('adminTools').style.display = 'block';
            loadAdminFunc();
        }
        
        listenMessages(isTeacher);
        // æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡ç¦è¨€ç‹€æ…‹
        setInterval(checkMute, 10000); 
    }

    async function checkMute() {
        const doc = await db.collection("students").doc(myDocId).get();
        const until = doc.data().muteUntil || 0;
        const el = document.getElementById('muteStatus');
        if (Date.now() < until) {
            el.style.display = 'block';
            el.innerText = `âš ï¸ ç¦è¨€ä¸­ï¼Œè§£ç¦æ™‚é–“ï¼š${new Date(until).toLocaleString()}`;
        } else { el.style.display = 'none'; }
    }

    async function loadAdminFunc() {
        const snap = await db.collection("students").get();
        const select = document.getElementById('muteTargetSelect');
        const area = document.getElementById('muteListArea');
        select.innerHTML = "";
        area.innerHTML = "";

        snap.forEach(doc => {
            const s = doc.data();
            if (s.role === 'teacher') return;
            
            // ä¸‹æ‹‰é¸å–®
            const opt = document.createElement('option');
            opt.value = doc.id;
            opt.innerText = `${doc.id}è™Ÿ ${s.name}`;
            select.appendChild(opt);

            // ç¦è¨€åå–®
            if (s.muteUntil > Date.now()) {
                const div = document.createElement('div');
                div.className = 'mute-item';
                div.innerHTML = `
                    <span>${s.name} (${new Date(s.muteUntil).toLocaleDateString()})</span>
                    <button onclick="unmute('${doc.id}')" style="width:auto; padding:5px 10px; background:var(--success)">è§£é™¤</button>
                `;
                area.appendChild(div);
            }
        });
    }

    async function setMute() {
        const id = document.getElementById('muteTargetSelect').value;
        const days = parseFloat(document.getElementById('muteDaysSelect').value);
        const until = Date.now() + (days * 24 * 60 * 60 * 1000);
        await db.collection("students").doc(id).update({ muteUntil: until });
        loadAdminFunc();
    }

    async function unmute(id) {
        await db.collection("students").doc(id).update({ muteUntil: 0 });
        loadAdminFunc();
    }

    async function sendComment() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content) return;

        const doc = await db.collection("students").doc(myDocId).get();
        if (Date.now() < (doc.data().muteUntil || 0)) return alert("ç¦è¨€ä¸­ç„¡æ³•ç™¼ä½ˆ");

        await db.collection("messages").add({
            author: me.name,
            authorId: myDocId,
            content: content,
            role: me.role || 'student',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msgContent').value = "";
    }

    function listenMessages(isTeacher) {
        db.collection("messages").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
            const list = document.getElementById('messageList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "...";
                const div = document.createElement('div');
                div.className = `msg-card ${d.role === 'teacher' ? 'is-teacher' : ''}`;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                        <span><b>${d.author}</b> (#${d.authorId})</span>
                        <span>${time} ${isTeacher ? `<span onclick="deleteMsg('${doc.id}')" style="color:red; cursor:pointer;">ğŸ—‘ï¸</span>` : ''}</span>
                    </div>
                    <div style="margin-top:5px;">${d.content}</div>
                `;
                list.appendChild(div);
            });
        });
    }

    function deleteMsg(id) { if(confirm("åˆªé™¤ç•™è¨€ï¼Ÿ")) db.collection("messages").doc(id).delete(); }
    async function clearAllMessages() {
        if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) {
            const s = await db.collection("messages").get();
            const b = db.batch();
            s.forEach(d => b.delete(d.ref));
            await b.commit();
        }
    }
</script>
</body>
</html>
