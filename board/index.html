<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹•æ…‹ç‰† v6.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #4361ee; --s: #2ec4b6; --d: #ef233c; --bg: #f4f7fe; --card: #ffffff; --teacher: #8e44ad; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        .container { width: 100%; max-width: 1000px; padding: 20px; box-sizing: border-box; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* éŸ¿æ‡‰å¼ä½ˆå±€ï¼šé›»è…¦ç‰ˆé›™æ¬„ */
        .main-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .main-layout { grid-template-columns: 1fr 350px; } }

        /* é ‚éƒ¨å°è¦½åˆ— */
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { font-weight: bold; color: #1e293b; }
        .logout-btn { background: #64748b; color: white; padding: 8px 15px; border-radius: 10px; border: none; cursor: pointer; font-size: 0.9rem; }

        /* ç•™è¨€æ¨£å¼ */
        .msg-list { max-height: 70vh; overflow-y: auto; padding-right: 5px; }
        .msg-item { background: white; padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 5px solid #cbd5e1; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .is-teacher { border-left-color: var(--teacher); background: #fdfaff; }
        .msg-info { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; display: flex; justify-content: space-between; }
        
        /* ç®¡ç†é¢æ¿æ§åˆ¶ */
        #adminPanel { display: none; background: #1e293b; color: white; border-radius: 20px; padding: 20px; }
        .mute-ctrl select, .mute-ctrl button { margin-bottom: 10px; width: 100%; }
        .admin-toggle-btn { background: var(--teacher); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; margin-bottom: 15px; cursor: pointer; display: none; }

        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { filter: brightness(1.1); }
        .mute-warning { color: var(--d); font-weight: bold; background: #fff1f2; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginCard" class="card" style="max-width: 450px; margin: 50px auto;">
        <h2 style="text-align: center;">ğŸ’¬ ç­ç´šå‹•æ…‹ç‰†</h2>
        <input type="number" id="stuId" placeholder="åº§è™Ÿ">
        <input type="password" id="stuPw" placeholder="å¯†ç¢¼">
        <button onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
    </div>

    <div id="mainView" style="display: none;">
        <div class="top-nav">
            <div class="user-info" id="userName">è¼‰å…¥ä¸­...</div>
            <button class="logout-btn" onclick="location.reload()">ç™»å‡ºç³»çµ±</button>
        </div>

        <div class="main-layout">
            <div class="left-col">
                <div class="card">
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="msgInput" placeholder="æƒ³èªªä»€éº¼ï¼Ÿ" style="margin:0;">
                        <button onclick="sendMsg()" style="width: 80px; margin:0;">ç™¼ä½ˆ</button>
                    </div>
                    <div id="selfMuteHint" class="mute-warning"></div>
                </div>
                <div id="msgList" class="msg-list"></div>
            </div>

            <div class="right-col">
                <button id="adminShowBtn" class="admin-toggle-btn" onclick="toggleAdminPanel(true)">ğŸ›¡ï¸ é–‹å•Ÿç®¡ç†æ§åˆ¶å°</button>
                
                <div id="adminPanel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span style="color: #94a3b8; font-weight: bold;">ğŸ›¡ï¸ ç¦è¨€ç®¡ç†</span>
                        <button onclick="toggleAdminPanel(false)" style="width: auto; padding: 5px 10px; background: #475569; margin: 0; font-size: 0.8rem;">é—œé–‰</button>
                    </div>
                    <select id="targetSelect"></select>
                    <select id="daysSelect">
                        <option value="0.0416">1å°æ™‚</option>
                        <option value="1">1å¤©</option>
                        <option value="3">3å¤©</option>
                        <option value="999">æ°¸ä¹…</option>
                    </select>
                    <button onclick="executeMute()" style="background:var(--d);">åŸ·è¡Œç¦è¨€</button>
                    <div id="activeMuteList" style="max-height: 200px; overflow-y: auto; margin-top: 15px; font-size: 0.85rem;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase é…ç½® (æ²¿ç”¨)
    const firebaseConfig = { 
        apiKey: "AIzaSyCJavnjgSkyTzhoT5g9Retmyg005-gbld0",
        authDomain: "vote-6668.firebaseapp.com",
        projectId: "vote-6668",
        storageBucket: "vote-6668.firebasestorage.app",
        messagingSenderId: "389284021944",
        appId: "1:389284021944:web:3c5311697cbfc7c010564d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = null;
    let isMuted = false;

    async function doLogin() {
        const idInput = document.getElementById('stuId').value;
        const pwInput = document.getElementById('stuPw').value;
        if(!idInput || !pwInput) return alert("è«‹è¼¸å…¥åº§è™Ÿèˆ‡å¯†ç¢¼");

        const id = idInput.padStart(2, '0'); 
        try {
            const doc = await db.collection("students").doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                if (data.password === pwInput) {
                    if (data.status === "active") {
                        me = { id, ...data };
                        startApp();
                    } else { alert("å¸³è™Ÿå°šæœªå•Ÿç”¨"); }
                } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
            } else { alert("åº§è™Ÿä¸å­˜åœ¨"); }
        } catch (e) { alert("é€£ç·šå¤±æ•—"); }
    }

    function startApp() {
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('userName').innerText = `ğŸ‘‹ ${me.name} (#${me.id})`;
        
        const isTeacher = (me.role === 'teacher' || me.role === 'admin');
        if (isTeacher) {
            document.getElementById('adminShowBtn').style.display = 'block';
            toggleAdminPanel(true); // é è¨­é–‹å•Ÿ
            loadStudentSelector();
            listenMuteList();
        }
        
        listenMessages(isTeacher);
        checkMyMute();
    }

    // æ§åˆ¶é¢æ¿åˆ‡æ›åŠŸèƒ½
    function toggleAdminPanel(show) {
        document.getElementById('adminPanel').style.display = show ? 'block' : 'none';
        document.getElementById('adminShowBtn').style.display = show ? 'none' : 'block';
    }

    // --- ç¦è¨€é‚è¼¯ ---
    async function loadStudentSelector() {
        const snap = await db.collection("students").get();
        const select = document.getElementById('targetSelect');
        const sorted = snap.docs.sort((a,b) => parseInt(a.id) - parseInt(b.id));
        select.innerHTML = '<option value="">é¸æ“‡ç¦è¨€å°è±¡...</option>';
        sorted.forEach(doc => {
            if(doc.data().role !== 'teacher') {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.innerText = `${parseInt(doc.id)}è™Ÿ ${doc.data().name}`;
                select.appendChild(opt);
            }
        });
    }

    function listenMuteList() {
        db.collection("mute_records").onSnapshot(async snap => {
            const listArea = document.getElementById('activeMuteList');
            listArea.innerHTML = '';
            const stuSnap = await db.collection("students").get();
            let names = {};
            stuSnap.forEach(d => names[d.id] = d.data().name);

            snap.forEach(doc => {
                const data = doc.data();
                if (data.until > Date.now()) {
                    const div = document.createElement('div');
                    div.style = "background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;";
                    div.innerHTML = `
                        <span>${parseInt(doc.id)}è™Ÿ ${names[doc.id] || 'å­¸ç”Ÿ'}<br><small style="color:#94a3b8">${new Date(data.until).toLocaleString()}</small></span>
                        <button onclick="unmute('${doc.id}')" style="width:auto; padding:5px 8px; margin:0; background:var(--s); font-size:0.7rem;">è§£é™¤</button>
                    `;
                    listArea.appendChild(div);
                }
            });
        });
    }

    async function executeMute() {
        const sid = document.getElementById('targetSelect').value;
        const days = parseFloat(document.getElementById('daysSelect').value);
        if(!sid) return alert("è«‹é¸æ“‡å­¸ç”Ÿ");
        const until = Date.now() + (days * 24 * 60 * 60 * 1000);
        await db.collection("mute_records").doc(sid).set({ until: until });
    }

    async function unmute(sid) { await db.collection("mute_records").doc(sid).delete(); }

    function checkMyMute() {
        db.collection("mute_records").doc(me.id).onSnapshot(doc => {
            const hint = document.getElementById('selfMuteHint');
            if (doc.exists && doc.data().until > Date.now()) {
                isMuted = true;
                hint.style.display = 'block';
                hint.innerText = `âš ï¸ ç¦è¨€ä¸­ï¼šé è¨ˆ ${new Date(doc.data().until).toLocaleString()} è§£é™¤`;
            } else {
                isMuted = false;
                hint.style.display = 'none';
            }
        });
    }

    async function sendMsg() {
        if (isMuted) return alert("æ‚¨ç›®å‰è™•æ–¼ç¦è¨€ç‹€æ…‹ï¼");
        const content = document.getElementById('msgInput').value.trim();
        if(!content) return;
        await db.collection("messages").add({
            author: me.name, authorId: me.id, content: content,
            role: me.role || 'student', createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msgInput').value = "";
    }

    function listenMessages(isTeacher) {
        db.collection("messages").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
            const container = document.getElementById('msgList');
            container.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "...";
                const div = document.createElement('div');
                div.className = `msg-item ${d.role === 'teacher' ? 'is-teacher' : ''}`;
                div.innerHTML = `
                    <div class="msg-info">
                        <span><b>${d.author}</b> (#${d.authorId})</span>
                        <span>${time} ${isTeacher ? `<span style="color:var(--d); cursor:pointer; margin-left:10px;" onclick="deleteMsg('${doc.id}')">ğŸ—‘ï¸</span>` : ''}</span>
                    </div>
                    <div style="word-break: break-all;">${d.content}</div>
                `;
                container.appendChild(div);
            });
        });
    }

    async function deleteMsg(mid) { if(confirm("åˆªé™¤ç•™è¨€ï¼Ÿ")) await db.collection("messages").doc(mid).delete(); }
</script>
</body>
</html>
