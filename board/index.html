<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šäº¤æµå¹³å°</title>
    <style>
        :root { --primary: #4361ee; --bg: #f8f9fa; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; position: relative; }
        
        /* æ¨™é¡Œèˆ‡è¼¸å…¥ */
        h1 { color: #333; text-align: center; cursor: default; user-select: none; }
        .input-box { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 120px; gap: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button { background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* ç•™è¨€å¡ç‰‡ */
        #messageList { display: flex; flex-direction: column; gap: 15px; }
        .msg-card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); animation: fadeIn 0.3s ease; }
        .msg-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        .msg-author { font-weight: bold; color: var(--primary); }
        .msg-content { font-size: 1rem; color: #333; line-height: 1.5; word-break: break-all; }
        
        /* ç®¡ç†å“¡æ¨£å¼ */
        .btn-delete { display: none; color: #ff4d4f; cursor: pointer; margin-left: 10px; font-weight: bold; }
        #adminPanel { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; text-align: center; z-index: 9999; }
        
        /* éš±è—é» */
        #secretDot { position: fixed; bottom: 5px; right: 5px; width: 5px; height: 5px; background: transparent; cursor: default; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1 id="titleSwitch">ğŸ’¬ ç­ç´šç•™è¨€æ¿</h1>

    <div class="input-box">
        <div class="grid">
            <input type="text" id="msgContent" placeholder="è¼¸å…¥ç•™è¨€å…§å®¹...">
            <button onclick="sendComment()">ç™¼ä½ˆç•™è¨€</button>
        </div>
        <input type="text" id="msgAuthor" style="margin-top:10px; width: 100px; font-size: 0.8rem;" readonly>
    </div>

    <div id="messageList">
        <div style="text-align: center; color: #999;">é€£ç·šä¸­...</div>
    </div>
</div>

<div id="adminPanel">
    <span>ğŸ›¡ï¸ ç®¡ç†å“¡æ¨¡å¼</span>
    <button onclick="clearAllMessages()" style="background:red; color:white; margin-left:20px;">æ¸…ç©ºæ‰€æœ‰</button>
    <button onclick="exitAdmin()" style="margin-left:10px;">é—œé–‰</button>
</div>

<div id="secretDot" onclick="triggerStep2()">.</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    // --- 1. ä½ çš„è¨­å®šå€ ---
    const firebaseConfig = {
        apiKey: "AIzaSyAS2CLfgTw9RQgVmZroj0O__N7h3M7XoP0",
        authDomain: "school-tools-6668.firebaseapp.com",
        projectId: "school-tools-6668",
        storageBucket: "school-tools-6668.firebasestorage.app",
        messagingSenderId: "436587749038",
        appId: "1:436587749038:web:7153f0699078966530d73f"
    };
    const ADMIN_PASSWORD = "6668"; // ä½ å¯ä»¥æ”¹æˆè‡ªè¨‚å¯†ç¢¼

    // --- 2. åˆå§‹åŒ– ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let deviceId = localStorage.getItem('chat_device_id') || Math.random().toString(36).substring(2, 6).toUpperCase();
    localStorage.setItem('chat_device_id', deviceId);

    // --- 3. å§“åé–å®šé‚è¼¯ ---
    let myName = localStorage.getItem('chat_name');
    window.onload = () => {
        if (!myName) {
            let n = prompt("è«‹è¼¸å…¥å§“å (è¨­å®šå¾Œä¸å¯æ›´æ”¹)ï¼š");
            if (n && n.trim()) {
                myName = n.trim();
                localStorage.setItem('chat_name', myName);
            } else { location.reload(); }
        }
        document.getElementById('msgAuthor').value = "ç™¼è¨€äºº: " + myName;
    };

    // --- 4. éš±è—å…¥å£é‚è¼¯ ---
    let clickCount = 0;
    let step1Cleared = false;

    // é»æ“Šæ¨™é¡Œ 5 æ¬¡è§¸ç™¼ç¬¬ä¸€å±¤
    document.getElementById('titleSwitch').onclick = () => {
        clickCount++;
        if (clickCount >= 5) {
            step1Cleared = true;
            console.log("Step 1 cleared"); // é€™è£¡å¯ä»¥éœé»˜ä¸é¡¯ç¤ºä»»ä½•æ±è¥¿
            clickCount = 0;
        }
    };

    // é»æ“Šå³ä¸‹è§’å¾®å°é»è§¸ç™¼ç¬¬äºŒå±¤
    function triggerStep2() {
        if (step1Cleared) {
            const pw = prompt("è«‹è¼¸å…¥æœ€çµ‚æˆæ¬Šç¢¼ï¼š");
            if (pw === ADMIN_PASSWORD) {
                document.getElementById('adminPanel').style.display = 'block';
                document.querySelectorAll('.btn-delete').forEach(b => b.style.display = 'inline');
                step1Cleared = false; // é‡ç½®é–‹é—œ
            }
        }
    }

    function exitAdmin() { location.reload(); }

    // --- 5. Firebase åŠŸèƒ½ ---
    function sendComment() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content) return;
        db.collection("messages").add({
            author: myName,
            content: content,
            deviceId: deviceId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { document.getElementById('msgContent').value = ""; });
    }

    function deleteMsg(id) {
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.collection("messages").doc(id).delete();
    }

    async function clearAllMessages() {
        if(confirm("ç¢ºå®šæ¸…ç©ºå…¨ç­ç•™è¨€ï¼Ÿ")) {
            const snap = await db.collection("messages").get();
            snap.forEach(doc => doc.ref.delete());
        }
    }

    db.collection("messages").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
        const list = document.getElementById('messageList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString() : "...";
            const div = document.createElement('div');
            div.className = 'msg-card';
            div.innerHTML = `
                <div class="msg-header">
                    <span><span class="msg-author">ğŸ‘¤ ${d.author}</span> <small>#${d.deviceId}</small></span>
                    <span>${time} <span class="btn-delete" onclick="deleteMsg('${doc.id}')">ğŸ—‘ï¸</span></span>
                </div>
                <div class="msg-content">${d.content}</div>
            `;
            list.appendChild(div);
        });
    });
</script>

</body>
</html>
