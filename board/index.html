<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šåˆ†æµç³»çµ± - å¼·åˆ¶é©—è­‰ç‰ˆ</title>
    <style>
        :root { --primary: #4361ee; --bg: #f8f9fa; --card: #ffffff; --text: #333; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); }
        
        /* 1. ç™»å…¥é®ç½© (æœ€ä¸Šå±¤) */
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:2000; }
        .login-btn { padding: 15px 30px; background: #4285F4; color:white; border:none; border-radius:5px; font-size:1.1rem; cursor:pointer; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* 2. å°šæœªç¶å®šé®ç½© (æ¬¡ä¸Šå±¤) */
        #unboundOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#f8d7da; display:none; flex-direction:column; justify-content:center; align-items:center; z-index:1500; text-align:center; padding: 20px; color: #721c24; }
        
        /* 3. ä¸»æ‡‰ç”¨ç¨‹å¼ (æœ€åº•å±¤) */
        .container { width: 100%; max-width: 600px; margin: 0 auto; padding-bottom: 120px; display: none; } /* é è¨­éš±è— */

        .header { background: var(--primary); color:white; padding: 20px; border-radius: 0 0 20px 20px; display:flex; justify-content:space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* è€å¸«æ§åˆ¶å° */
        .teacher-nav { display: flex; gap: 10px; padding: 0 15px; margin-bottom: 15px; }
        .nav-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; background: #e0e0e0; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; transform: scale(1.05); }

        .input-box { background: var(--card); margin: 0 15px 20px 15px; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .grid { display: grid; grid-template-columns: 1fr 80px; gap: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        
        #messageList { padding: 0 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-left: 5px solid var(--primary); }
        .msg-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        
        /* è€å¸«ç®¡ç†é¢æ¿ (å›ºå®šåº•éƒ¨) */
        #adminConsole { display:none; background: #2c3e50; color: white; padding: 20px; position: fixed; bottom: 0; left: 0; width: 100%; max-height: 50vh; overflow-y: auto; z-index: 1001; box-sizing: border-box; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.2); }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #444; }
        .admin-action-btn { padding: 6px 12px; margin-left: 5px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <h2 style="margin-bottom:20px; color:#333;">ğŸ« ç­ç´šè¨è«–å€</h2>
    <p style="color:#666; margin-bottom:30px;">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
    <button class="login-btn" onclick="signIn()">Google ç™»å…¥</button>
</div>

<div id="unboundOverlay">
    <h1>âš ï¸ å°šæœªåˆ†ç­</h1>
    <p id="userInfoDisplay" style="font-weight:bold; margin: 10px 0;"></p>
    <p>æ‚¨çš„å¸³è™Ÿå·²ç™»éŒ„ï¼Œä½†å°šæœªè¢«åˆ†é…ç­ç´šã€‚<br>è«‹èˆ‰æ‰‹å‘ŠçŸ¥è€å¸«ï¼Œå®Œæˆåˆ†é…å¾Œæ­¤ç•«é¢æœƒè‡ªå‹•æ¶ˆå¤±ã€‚</p>
    <button onclick="signOut()" style="margin-top:20px; padding:10px 20px; background:white; border:1px solid #721c24; color:#721c24; border-radius:5px; cursor:pointer;">ç™»å‡º</button>
</div>

<div class="container" id="mainApp">
    <div class="header">
        <div>
            <h3 id="displayClassName" style="margin:0;">è¼‰å…¥ä¸­...</h3>
            <span id="currentUserTag" style="font-size:0.8rem; opacity:0.8;"></span>
        </div>
        <button onclick="signOut()" style="background:rgba(255,255,255,0.2); border:1px solid white; color:white; border-radius:4px; padding:5px 10px; cursor:pointer;">ç™»å‡º</button>
    </div>

    <div id="teacherTabs" class="teacher-nav" style="display:none;">
        <button id="btnClassA" class="nav-btn" onclick="switchView('ClassA')">ç”²ç­</button>
        <button id="btnClassB" class="nav-btn" onclick="switchView('ClassB')">ä¹™ç­</button>
        <button class="nav-btn" style="background:#f1c40f; color:#333;" onclick="toggleAdmin()">ğŸ‘¥ ç®¡ç†åå–®</button>
    </div>

    <div class="input-box">
        <div class="grid">
            <input type="text" id="msgContent" placeholder="è¼¸å…¥è¨Šæ¯...">
            <button onclick="sendComment()" style="background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ç™¼é€</button>
        </div>
    </div>

    <div id="messageList"></div>
</div>

<div id="adminConsole">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">ğŸ‘¥ å­¸ç”Ÿæ¬Šé™ç®¡ç†</h3>
        <button onclick="toggleAdmin()" style="background:transparent; border:1px solid white; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">é—œé–‰</button>
    </div>
    <div id="userList" style="font-size:0.9rem;">è¼‰å…¥ä¸­...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>

<script>
    // --- âš ï¸ è«‹æ›¿æ›æ‚¨çš„ Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyAS2CLfgTw9RQgVmZroj0O__N7h3M7XoP0",
        authDomain: "school-tools-6668.firebaseapp.com",
        projectId: "school-tools-6668",
        storageBucket: "school-tools-6668.firebasestorage.app",
        messagingSenderId: "436587749038",
        appId: "1:436587749038:web:7153f0699078966530d73f"
    };

    const TEACHER_EMAIL = "automail@gmail.com"; // è€å¸«çš„ Email

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    let currentUser = null;
    let currentViewClass = null; 
    let unsubMsg = null;

    // --- 1. ç™»å…¥æµç¨‹ ---
    function signIn() { auth.signInWithRedirect(provider); }
    function signOut() { auth.signOut().then(() => location.reload()); }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            // å·²ç™»å…¥ï¼šéš±è—ç™»å…¥é 
            document.getElementById('loginOverlay').style.display = 'none';
            currentUser = user;
            document.getElementById('currentUserTag').innerText = `${user.displayName}`;
            document.getElementById('userInfoDisplay').innerText = `${user.displayName} (${user.email})`;

            // æ›´æ–°ä½¿ç”¨è€…æœ€å¾Œä¸Šç·šæ™‚é–“
            await db.collection("users").doc(user.email).set({
                name: user.displayName,
                email: user.email,
                photo: user.photoURL,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            // é–‹å§‹æª¢æŸ¥æ¬Šé™ (æ±ºå®šè¦å»å“ªä¸€é )
            checkAccess();
        } else {
            // æœªç™»å…¥ï¼šåªé¡¯ç¤ºç™»å…¥é 
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    });

    // --- 2. æ ¸å¿ƒæ¬Šé™åˆ¤æ–· (State Machine) ---
    function checkAccess() {
        // ç›£è½è©²ä½¿ç”¨è€…çš„è³‡æ–™è®ŠåŒ– (å³æ™‚åæ‡‰è€å¸«çš„æŒ‡æ´¾)
        db.collection("users").doc(currentUser.email).onSnapshot(doc => {
            const data = doc.data();

            // æƒ…æ³ Aï¼šæˆ‘æ˜¯è€å¸«
            if (currentUser.email === TEACHER_EMAIL) {
                showMainApp();
                document.getElementById('teacherTabs').style.display = 'flex';
                // é è¨­å…ˆçœ‹ç”²ç­ï¼Œä¸¦é–‹å•Ÿç®¡ç†åå–®ç›£è½
                if (!currentViewClass) switchView('ClassA');
                loadAllStudents(); 
            } 
            // æƒ…æ³ Bï¼šæˆ‘æ˜¯å­¸ç”Ÿï¼Œä¸”å·²ç¶“æœ‰ç­ç´š (data.class å­˜åœ¨)
            else if (data && data.class) {
                showMainApp();
                document.getElementById('unboundOverlay').style.display = 'none'; // éš±è—è­¦å‘Š
                
                // è‡ªå‹•é€²å…¥è¢«æŒ‡æ´¾çš„ç­ç´š
                if (currentViewClass !== data.class) {
                    switchView(data.class);
                }
                // å­¸ç”Ÿä¸èƒ½åˆ‡æ›ç­ç´šï¼Œéš±è—è€å¸«æ§åˆ¶åˆ—
                document.getElementById('teacherTabs').style.display = 'none';
            } 
            // æƒ…æ³ Cï¼šæˆ‘æ˜¯å­¸ç”Ÿï¼Œä½†æ²’æœ‰ç­ç´š (data.class ä¸å­˜åœ¨æˆ–ç‚ºç©º)
            else {
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('unboundOverlay').style.display = 'flex'; // é¡¯ç¤ºè­¦å‘Š
            }
        });
    }

    function showMainApp() {
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('loginOverlay').style.display = 'none';
    }

    // --- 3. è€å¸«åŠŸèƒ½ï¼šç®¡ç†å­¸ç”Ÿ ---
    function loadAllStudents() {
        db.collection("users").onSnapshot(snap => {
            const list = document.getElementById('userList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if(u.email === TEACHER_EMAIL) return; // ä¸é¡¯ç¤ºè€å¸«è‡ªå·±

                const div = document.createElement('div');
                div.className = 'user-row';
                
                // åˆ¤æ–·ç›®å‰ç­ç´šé¡è‰²
                let statusColor = u.class ? '#2ecc71' : '#e74c3c'; 
                let statusText = u.class ? (u.class==='ClassA'?'ç”²ç­':'ä¹™ç­') : 'æœªåˆ†ç­';

                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${u.name}</div>
                        <div style="font-size:0.8rem; color:#aaa;">${u.email}</div>
                        <div style="font-size:0.8rem; color:${statusColor};">ç›®å‰ï¼š${statusText}</div>
                    </div>
                    <div>
                        <button class="admin-action-btn" style="background:#3498db;" onclick="assignClass('${u.email}','ClassA')">ç”²</button>
                        <button class="admin-action-btn" style="background:#9b59b6;" onclick="assignClass('${u.email}','ClassB')">ä¹™</button>
                        <button class="admin-action-btn" style="background:#555;" onclick="assignClass('${u.email}', null)">é‡ç½®</button>
                    </div>
                `;
                list.appendChild(div);
            });
        });
    }

    function assignClass(email, className) {
        // æ›´æ–°è©²å­¸ç”Ÿçš„ class æ¬„ä½
        // å¦‚æœ className æ˜¯ nullï¼Œä»£è¡¨é‡ç½® (delete field)
        if (className) {
            db.collection("users").doc(email).update({ class: className });
        } else {
            db.collection("users").doc(email).update({ class: firebase.firestore.FieldValue.delete() });
        }
    }

    function toggleAdmin() {
        const p = document.getElementById('adminConsole');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    // --- 4. è¦–åœ–åˆ‡æ›èˆ‡è¨Šæ¯è®€å– ---
    function switchView(className) {
        currentViewClass = className;
        
        // æ›´æ–°æ¨™é¡Œ
        const titles = { 'ClassA': 'ğŸ† ç”²ç­è¨è«–å€', 'ClassB': 'ğŸš€ ä¹™ç­è¨è«–å€' };
        document.getElementById('displayClassName').innerText = titles[className];

        // è€å¸«æŒ‰éˆ•è®Šè‰²
        if(currentUser.email === TEACHER_EMAIL) {
            document.getElementById('btnClassA').classList.toggle('active', className === 'ClassA');
            document.getElementById('btnClassB').classList.toggle('active', className === 'ClassB');
        }

        loadMessages();
    }

    function loadMessages() {
        if (unsubMsg) unsubMsg();
        unsubMsg = db.collection("classes").doc(currentViewClass).collection("messages")
            .orderBy("createdAt", "desc")
            .limit(50)
            .onSnapshot(snap => {
                const list = document.getElementById('messageList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
                    
                    const div = document.createElement('div');
                    div.className = 'msg-card';
                    
                    // è€å¸«æ‰æœ‰åˆªé™¤æŒ‰éˆ•
                    let delBtn = "";
                    if (currentUser.email === TEACHER_EMAIL) {
                        delBtn = `<span style="cursor:pointer; color:#e74c3c; margin-left:10px;" onclick="deleteMsg('${doc.id}')">ğŸ—‘ï¸</span>`;
                    }

                    div.innerHTML = `
                        <div class="msg-header">
                            <span style="font-weight:bold; color:#333;">${d.author}</span>
                            <span>${time} ${delBtn}</span>
                        </div>
                        <div style="margin-top:5px; color:#555;">${d.content}</div>
                    `;
                    list.appendChild(div);
                });
            });
    }

    // --- 5. ç™¼é€èˆ‡åˆªé™¤ ---
    function sendComment() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content || !currentViewClass) return;

        db.collection("classes").doc(currentViewClass).collection("messages").add({
            author: currentUser.displayName,
            email: currentUser.email,
            content: content,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { document.getElementById('msgContent').value = ""; });
    }

    function deleteMsg(id) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç•™è¨€ï¼Ÿ")) {
            db.collection("classes").doc(currentViewClass).collection("messages").doc(id).delete();
        }
    }
</script>
</body>
</html>
