<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹•æ…‹ç‰†</title>
    <style>
        :root { --primary: #4361ee; --bg: #f8f9fa; --card: #ffffff; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; }
        
        /* æ¨™é¡Œèˆ‡è¼¸å…¥ */
        h1 { color: #333; text-align: center; cursor: default; user-select: none; margin-bottom: 25px; }
        .input-box { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 100px; gap: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button { background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* ç•™è¨€å…§å®¹ */
        #messageList { display: flex; flex-direction: column; gap: 12px; }
        .msg-card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-left: 5px solid #ddd; }
        .msg-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .msg-author { font-weight: bold; color: var(--primary); }
        .msg-content { font-size: 1.05rem; color: #333; word-break: break-all; }
        
        /* ğŸ›¡ï¸ ç®¡ç†å“¡å°ˆå±¬æ¨£å¼ */
        #adminPanel { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; text-align: center; z-index: 100; }
        .btn-delete { display: none; color: #ff4d4f; cursor: pointer; font-size: 0.8rem; border: 1px solid #ff4d4f; padding: 2px 5px; border-radius: 4px; margin-left: 10px; }
        
        /* ğŸ•µï¸ ç‰¹å‹™å…¥å£ï¼šå³ä¸‹è§’éš±å½¢å€å¡Š */
        #secretZone {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 50px;
            height: 50px;
            /* æ¸¬è©¦éšæ®µï¼šæ·¡æ·¡ç²‰ç´…è‰²æ–¹ä¾¿ä½ æ‰¾ã€‚æ­£å¼ä¸Šç·šè«‹æ”¹ç‚º transparent */
            background: rgba(255, 0, 0, 0.05); 
            z-index: 99;
            cursor: default;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="titleSwitch">ğŸ’¬ ç­ç´šç•™è¨€æ¿</h1>

    <div class="input-box">
        <div class="grid">
            <input type="text" id="msgContent" placeholder="æƒ³èªªä»€éº¼ï¼Ÿ">
            <button onclick="sendComment()">ç™¼ä½ˆ</button>
        </div>
        <input type="text" id="msgAuthor" style="margin-top:10px; width: 120px; font-size: 0.75rem; color:#888; border:none; background:none;" readonly>
    </div>

    <div id="messageList">
        <div style="text-align: center; padding: 20px; color: #999;">é€£ç·šä¸­...</div>
    </div>
</div>

<div id="adminPanel">
    <span>ğŸ›¡ï¸ ç®¡ç†å“¡æ¨¡å¼ï¼šæ‚¨ç¾åœ¨å¯ä»¥åˆªé™¤å–®å‰‡ç•™è¨€</span>
    <button onclick="clearAllMessages()" style="background:#ff4d4f; color:white; border:none; padding:5px; border-radius:4px; margin-left:15px; cursor:pointer;">æ¸…ç©ºæ‰€æœ‰ç•™è¨€</button>
    <button onclick="location.reload()" style="margin-left:10px; cursor:pointer;">çµæŸç®¡ç†</button>
</div>

<div id="secretZone" onclick="triggerStep2()"></div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    // 1. Firebase é€£ç·šè¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyAS2CLfgTw9RQgVmZroj0O__N7h3M7XoP0",
        authDomain: "school-tools-6668.firebaseapp.com",
        projectId: "school-tools-6668",
        storageBucket: "school-tools-6668.firebasestorage.app",
        messagingSenderId: "436587749038",
        appId: "1:436587749038:web:7153f0699078966530d73f"
    };
    const ADMIN_PASSWORD = "6668"; // ç¬¬ä¸‰å±¤ï¼šå¯†ç¢¼

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. å§“åèˆ‡è£ç½®è­˜åˆ¥
    let deviceId = localStorage.getItem('chat_device_id') || Math.random().toString(36).substring(2, 6).toUpperCase();
    localStorage.setItem('chat_device_id', deviceId);
    let myName = localStorage.getItem('chat_name');

    window.onload = () => {
        if (!myName) {
            let n = prompt("æ­¡è¿ï¼è«‹è¼¸å…¥å§“åä»¥ä¾¿è€å¸«è¾¨è­˜ï¼š");
            if (n && n.trim()) {
                myName = n.trim();
                localStorage.setItem('chat_name', myName);
            } else { location.reload(); }
        }
        document.getElementById('msgAuthor').value = "æˆ‘çš„ä»£ç¢¼: " + myName + " #" + deviceId;
    };

    // 3. ğŸ›¡ï¸ è€å¸«éš±è—é‚è¼¯ ğŸ›¡ï¸
    let clickCount = 0;
    let step1Cleared = false;

    // ç¬¬ä¸€æ­¥ï¼šé»æ¨™é¡Œ 5 ä¸‹
    document.getElementById('titleSwitch').onclick = () => {
        clickCount++;
        if (clickCount >= 5) {
            step1Cleared = true;
            clickCount = 0;
            console.log("Stage 1 OK"); // æ¸¬è©¦ç”¨
        }
    };

    // ç¬¬äºŒæ­¥ï¼šé»å³ä¸‹è§’éš±å½¢å€ (åœ¨ç¬¬ä¸€æ­¥å®Œæˆå¾Œæ‰æœ‰æ•ˆ)
    function triggerStep2() {
        if (step1Cleared) {
            // ç¬¬ä¸‰æ­¥ï¼šå¯†ç¢¼
            const pw = prompt("è«‹è¼¸å…¥è€å¸«ç®¡ç†æˆæ¬Šç¢¼ï¼š");
            if (pw === ADMIN_PASSWORD) {
                document.getElementById('adminPanel').style.display = 'block';
                document.querySelectorAll('.btn-delete').forEach(btn => btn.style.display = 'inline-block');
                step1Cleared = false; // é‡ç½®
            }
        }
    }

    // 4. ç™¼ä½ˆèˆ‡é¡¯ç¤ºç•™è¨€
    function sendComment() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content) return;
        db.collection("messages").add({
            author: myName,
            content: content,
            deviceId: deviceId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { document.getElementById('msgContent').value = ""; });
    }

    function deleteMsg(id) {
        if(confirm("ç¢ºå®šåˆªé™¤é€™å‰‡ç•™è¨€ï¼Ÿ")) db.collection("messages").doc(id).delete();
    }

    async function clearAllMessages() {
        if(confirm("âš ï¸ ç¢ºå®šè¦ä¸€éµæ¸…ç©ºã€Œå…¨ç­ã€ç•™è¨€ï¼Ÿç„¡æ³•å¾©åŸï¼")) {
            const snap = await db.collection("messages").get();
            snap.forEach(doc => doc.ref.delete());
        }
    }

    // å³æ™‚æ¸²æŸ“
    db.collection("messages").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
        const list = document.getElementById('messageList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "...";
            const div = document.createElement('div');
            div.className = 'msg-card';
            div.innerHTML = `
                <div class="msg-header">
                    <span><span class="msg-author">${d.author}</span> <small>#${d.deviceId}</small></span>
                    <span>${time} <span class="btn-delete" onclick="deleteMsg('${doc.id}')">åˆªé™¤</span></span>
                </div>
                <div class="msg-content">${d.content}</div>
            `;
            list.appendChild(div);
        });
        if (snap.empty) list.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:20px;">ç›®å‰æ²’æœ‰ç•™è¨€</div>';
    });
</script>

</body>
</html>
