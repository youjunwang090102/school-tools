<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå‹•æ…‹ç‰†-è¦–è¦ºåŒ–ç®¡ç†ç‰ˆ</title>
    <style>
        :root { --primary: #4361ee; --bg: #f4f7fe; --card: #ffffff; --teacher: #8e44ad; --danger: #ef233c; --success: #2ec4b6; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; padding-bottom: 150px; }
        
        /* ç™»å…¥å€å¡Š */
        .auth-box { background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; margin-top: 50px; }
        
        /* ä¸»ä»‹é¢å€å¡Š */
        #mainContent { display: none; }
        h1 { color: #333; text-align: center; }
        .input-box { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 80px; gap: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button { background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { filter: brightness(1.1); }
        
        #messageList { display: flex; flex-direction: column; gap: 12px; }
        .msg-card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-left: 5px solid #ddd; }
        .msg-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .msg-author { font-weight: bold; color: var(--primary); }
        .is-teacher { border-left-color: var(--teacher); }
        .is-teacher .msg-author { color: var(--teacher); }
        
        /* ğŸ›¡ï¸ è€å¸«ç®¡ç†é¢æ¿ */
        #adminTools { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; z-index: 999; box-sizing: border-box; max-height: 80vh; overflow-y: auto; }
        .mute-panel { display: flex; flex-wrap: wrap; gap: 10px; background: #333; padding: 15px; border-radius: 12px; margin-bottom: 10px; align-items: center; justify-content: center; }
        .mute-list-card { background: #444; padding: 10px; border-radius: 8px; margin: 5px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 300px; }
        
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; margin-left: 5px; }
        .status-tag { font-size: 0.75rem; color: var(--danger); font-weight: bold; margin-top: 5px; display: block; }
        .user-info { font-size: 0.8rem; color: #666; margin-top: 10px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <div id="authBox" class="auth-box">
        <h2>ğŸ”‘ ç­ç´šæˆå“¡ç™»å…¥</h2>
        <input type="number" id="loginId" placeholder="åº§è™Ÿ (ä¾‹å¦‚ 05)" style="margin-bottom: 10px; width: 80%;">
        <input type="password" id="loginPw" placeholder="å¯†ç¢¼" style="margin-bottom: 20px; width: 80%;">
        <button onclick="doLogin()" style="width: 80%; padding: 15px;">ç™»å…¥ç³»çµ±</button>
    </div>

    <div id="mainContent">
        <h1>ğŸ’¬ ç­ç´šå‹•æ…‹ç‰†</h1>
        <div class="input-box">
            <div class="grid">
                <input type="text" id="msgContent" placeholder="åœ¨æ­¤è¼¸å…¥è¨Šæ¯...">
                <button onclick="sendComment()">ç™¼ä½ˆ</button>
            </div>
            <div id="muteStatus" class="status-tag" style="display:none;">âš ï¸ æ‚¨ç›®å‰è¢«ç¦è¨€ä¸­ï¼Œæš«æ™‚ç„¡æ³•ç™¼æ–‡</div>
            <div class="user-info">
                <span id="whoAmI">è¼‰å…¥ä¸­...</span>
                <span onclick="location.reload()" style="cursor:pointer; color:var(--primary)">ç™»å‡º</span>
            </div>
        </div>
        <div id="messageList"></div>
    </div>
</div>

<div id="adminTools">
    <div style="text-align:center; color:#ffd700; font-weight:bold; margin-bottom:10px;">ğŸ›¡ï¸ è¦–è¦ºåŒ–ç¦è¨€ç®¡ç†ç³»çµ±</div>
    
    <div class="mute-panel">
        <select id="muteTargetSelect"><option value="">é¸æ“‡å­¸ç”Ÿ...</option></select>
        <select id="muteDaysSelect">
            <option value="0.0416">ç¦è¨€ 1 å°æ™‚</option>
            <option value="0.5">ç¦è¨€ 12 å°æ™‚</option>
            <option value="1" selected>ç¦è¨€ 1 å¤©</option>
            <option value="3">ç¦è¨€ 3 å¤©</option>
            <option value="7">ç¦è¨€ 7 å¤©</option>
            <option value="999">æ°¸ä¹…ç¦è¨€</option>
        </select>
        <button onclick="setMute()" style="background:var(--danger);">åŸ·è¡Œç¦è¨€</button>
    </div>

    <div id="activeMuteList" style="display:flex; flex-direction:column; align-items:center;">
        <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">ğŸ“‹ ç•¶å‰ç¦è¨€ä¸­åå–®</div>
        </div>
    
    <div style="text-align:center; margin-top:15px; border-top: 1px solid #444; padding-top:10px;">
        <button onclick="clearAllMessages()" style="background:var(--danger);">æ¸…ç©ºæ‰€æœ‰ç•™è¨€</button>
        <button onclick="location.reload()" style="background:#555;">é—œé–‰ç®¡ç†é¢æ¿</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAS2CLfgTw9RQgVmZroj0O__N7h3M7XoP0",
        authDomain: "school-tools-6668.firebaseapp.com",
        projectId: "school-tools-6668",
        storageBucket: "school-tools-6668.firebasestorage.app",
        messagingSenderId: "436587749038",
        appId: "1:436587749038:web:7153f0699078966530d73f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;
    let allStudents = [];

    async function doLogin() {
        const id = document.getElementById('loginId').value.padStart(2, '0');
        const pw = document.getElementById('loginPw').value;
        const doc = await db.collection("students").doc(id).get();
        if (doc.exists && doc.data().password === pw) {
            const data = doc.data();
            if (data.role !== 'teacher' && data.role !== 'admin' && data.status !== 'active') {
                return alert("å¸³è™Ÿå¯©æ ¸ä¸­ï¼Œè«‹è¯ç¹«è€å¸«ã€‚");
            }
            currentUser = { id, ...data };
            initApp();
        } else { alert("é©—è­‰å¤±æ•—"); }
    }

    function initApp() {
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        const isStaff = (currentUser.role === 'teacher' || currentUser.role === 'admin');
        document.getElementById('whoAmI').innerText = `ä½¿ç”¨è€…ï¼š${currentUser.name} (#${currentUser.id})`;
        
        if (isStaff) {
            document.getElementById('adminTools').style.display = 'block';
            loadStudentList();
        }
        
        // å­¸ç”Ÿç«¯æª¢æŸ¥ç¦è¨€ç‹€æ…‹é¡¯ç¤º
        checkSelfMute();
        listenMessages(isStaff);
    }

    function checkSelfMute() {
        // å®šæ™‚æª¢æŸ¥è‡ªå·±çš„ç¦è¨€ç‹€æ…‹
        setInterval(async () => {
            const doc = await db.collection("students").doc(currentUser.id).get();
            const muteUntil = doc.data().muteUntil || 0;
            const statusEl = document.getElementById('muteStatus');
            if (Date.now() < muteUntil) {
                statusEl.style.display = 'block';
                statusEl.innerText = `âš ï¸ ç¦è¨€ä¸­ï¼Œé è¨ˆè§£ç¦ï¼š${new Date(muteUntil).toLocaleString()}`;
            } else { statusEl.style.display = 'none'; }
        }, 5000);
    }

    async function loadStudentList() {
        const snap = await db.collection("students").orderBy(firebase.firestore.FieldPath.documentId()).get();
        const select = document.getElementById('muteTargetSelect');
        const muteListArea = document.getElementById('activeMuteList');
        
        select.innerHTML = '<option value="">é¸æ“‡å­¸ç”Ÿ...</option>';
        muteListArea.innerHTML = '<div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">ğŸ“‹ ç•¶å‰ç¦è¨€ä¸­åå–®</div>';
        
        snap.forEach(doc => {
            const s = doc.data();
            const sid = doc.id;
            // å¡«å……ä¸‹æ‹‰é¸å–®
            if (s.role !== 'teacher') {
                const opt = document.createElement('option');
                opt.value = sid;
                opt.innerText = `${sid} ${s.name}`;
                select.appendChild(opt);
            }
            
            // å¡«å……ç¦è¨€åå–®
            if (s.muteUntil && s.muteUntil > Date.now()) {
                const card = document.createElement('div');
                card.className = 'mute-list-card';
                card.innerHTML = `
                    <span>${sid} ${s.name} <br><small>${new Date(s.muteUntil).toLocaleString()}</small></span>
                    <div>
                        <button class="btn-sm" style="background:var(--danger)" onclick="adjustMute('${sid}', 1)">+1å¤©</button>
                        <button class="btn-sm" style="background:var(--success)" onclick="adminActionUnmute('${sid}')">è§£ç¦</button>
                    </div>
                `;
                muteListArea.appendChild(card);
            }
        });
    }

    async function setMute() {
        const id = document.getElementById('muteTargetSelect').value;
        const days = parseFloat(document.getElementById('muteDaysSelect').value);
        if (!id) return alert("è«‹å…ˆé¸æ“‡å­¸ç”Ÿ");
        const time = Date.now() + (days * 24 * 60 * 60 * 1000);
        await db.collection("students").doc(id).update({ muteUntil: time });
        alert("ç¦è¨€è¨­å®šæˆåŠŸ");
        loadStudentList();
    }

    async function adjustMute(id, extraDays) {
        const doc = await db.collection("students").doc(id).get();
        const currentMute = doc.data().muteUntil || Date.now();
        const newMute = currentMute + (extraDays * 24 * 60 * 60 * 1000);
        await db.collection("students").doc(id).update({ muteUntil: newMute });
        loadStudentList();
    }

    async function adminActionUnmute(id) {
        await db.collection("students").doc(id).update({ muteUntil: 0 });
        loadStudentList();
    }

    async function sendComment() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content) return;
        const userDoc = await db.collection("students").doc(currentUser.id).get();
        if (Date.now() < (userDoc.data().muteUntil || 0)) {
            return alert("æ‚¨ç›®å‰è™•æ–¼ç¦è¨€ç‹€æ…‹ï¼Œç„¡æ³•ç™¼æ–‡ã€‚");
        }
        db.collection("messages").add({
            author: currentUser.name,
            authorId: currentUser.id,
            content: content,
            role: currentUser.role || 'student',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { document.getElementById('msgContent').value = ""; });
    }

    function deleteMsg(id) {
        if(confirm("åˆªé™¤é€™æ¢ç•™è¨€ï¼Ÿ")) db.collection("messages").doc(id).delete();
    }

    async function clearAllMessages() {
        if(confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç•™è¨€ï¼Ÿ")) {
            const snap = await db.collection("messages").get();
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        }
    }

    function listenMessages(isStaff) {
        db.collection("messages").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('messageList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "...";
                const isTeacher = (d.role === 'teacher' || d.role === 'admin');
                const div = document.createElement('div');
                div.className = `msg-card ${isTeacher ? 'is-teacher' : ''}`;
                div.innerHTML = `
                    <div class="msg-header">
                        <span><span class="msg-author">${d.author}</span> <small>(#${d.authorId})</small></span>
                        <span>${time} ${isStaff ? `<button class="btn-sm" style="background:none; color:var(--danger); border:1px solid var(--danger);" onclick="deleteMsg('${doc.id}')">ğŸ—‘ï¸</button>` : ''}</span>
                    </div>
                    <div class="msg-content">${d.content}</div>
                `;
                list.appendChild(div);
            });
        });
    }
</script>
</body>
</html>
